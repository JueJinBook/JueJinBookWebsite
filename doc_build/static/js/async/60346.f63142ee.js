"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["60346"],{412719:function(e,n,t){t.r(n),t.d(n,{default:()=>D});var s=t(552676),c=t(740453);let a=t.p+"static/image/13547f4d0e63d3275a7e74fedee3ddcf.df4f0c77.webp",r=t.p+"static/image/e5ec1699d2644a11a6f3f5e4ce4f1504.3ca093c5.webp",i=t.p+"static/image/c2a1915df3ff8a847bacfffa1ca1cc74.d54306e7.webp",l=t.p+"static/image/866961b92d021a79f38baa2dd36c2906.b7f9c635.webp",d=t.p+"static/image/ab02251ae24cade9c17b0e66b8a39b2f.7ac1f3c2.webp",p=t.p+"static/image/854b3a0ce565caa717ecbb2d809fa732.07aed5ee.webp",x=t.p+"static/image/06860f22db50a40ef87edde7220bfab9.11579224.webp",o=t.p+"static/image/3b96a36e5a4da94c555223d3119b1cba.bb7feefd.webp",h=t.p+"static/image/48af41703659a7c0acad7febe3eacfd2.2a245821.webp",j=t.p+"static/image/48aa9fa63d358242996fb7e37dd9035e.5c5c7f4b.webp",b=t.p+"static/image/d310168165e13e15714894cc28b73c6d.acd969ce.webp",f=t.p+"static/image/414e5ff5a1798da8a53e05f414a1fdb5.bf4cdf08.webp",g=t.p+"static/image/5441ca00ac3426c2b8210ee9578a8bd6.f372eae2.webp",m=t.p+"static/image/3d094189c4be1508a60045b44890d12b.288dcab9.webp",u=t.p+"static/image/95cc2e6a3e760629ab84bf0ffcaa4f99.367bb263.webp",A=t.p+"static/image/385c559115d8d5b62770cdbefd434da0.37bcfe01.webp",E=t.p+"static/image/9de0d611fce15e526479ea5d34409b07.dc71ce8c.webp",w=t.p+"static/image/1a449a67847188c3a50209e876d79bad.ea9ce086.webp",H=t.p+"static/image/7cae13caf3032ea1adf27305f8f5a273.ed7a1472.webp",T=t.p+"static/image/fe6cda9bc643db07a8d9428bdb1d178c.3a5a91f7.webp",R=t.p+"static/image/e75821b4f0650b4af3683d733d32d682.7a830d1e.webp",v=t.p+"static/image/6e00c07e69aa48e3be4d68d00e5fce8f.3fdcc2d3.webp",G=t.p+"static/image/bdf84bfdd2fc8a6374b9596a87677aa7.79a2ddea.webp",C=t.p+"static/image/95f7a194c689b6b2d5d2474cca567339.7ecc0abe.webp",S=t.p+"static/image/37234adb1bb68b300ece454ab31b5975.68ae207d.webp",F=t.p+"static/image/8e70885eb860c099e0e009611d034184.4b9ef2fc.webp",q=t.p+"static/image/8e111954a9c1bfb68672784dd817afb6.000a47cf.webp",P=t.p+"static/image/175654fa5995f1e366d9ad17359c978b.35950fd2.webp",k=t.p+"static/image/238514f6a1fb5f468f9aa44722d5d8cd.d693d65b.webp",J=t.p+"static/image/70be07e43ace409c7789f80d8cb8bd32.ad93ff9e.webp",N=t.p+"static/image/e285785ff35a4d8b3c628fff15764b34.0f401368.webp";function O(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",strong:"strong",h2:"h2"},(0,c.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"14-executioncontext切换不同上下文",children:["14. ExecutionContext：切换不同上下文",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#14-executioncontext切换不同上下文",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"Nest 支持创建多种类型的服务："}),"\n",(0,s.jsx)(n.p,{children:"包括 HTTP 服务、WebSocket 服务，还有基于 TCP 通信的微服务。"}),"\n",(0,s.jsx)(n.p,{children:"这三种服务都会支持 Guard、Interceptor、Exception Filter 功能。"}),"\n",(0,s.jsx)(n.p,{children:"那么问题来了："}),"\n",(0,s.jsx)(n.p,{children:"不同类型的服务它能拿到的参数是不同的，比如 http 服务可以拿到 request、response 对象，而 websocket 服务就没有。"}),"\n",(0,s.jsx)(n.p,{children:"也就是说你不能在 Guard、Interceptor、Exception Filter 里直接操作 request、response，不然就没法复用了，因为 websocket 没有这些。"}),"\n",(0,s.jsx)(n.p,{children:"那如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用呢？"}),"\n",(0,s.jsx)(n.p,{children:"Nest 的解决方法是 ArgumentHost 这个类。"}),"\n",(0,s.jsx)(n.p,{children:"我们来看一下："}),"\n",(0,s.jsx)(n.p,{children:"创建个项目："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"nest new argument-host\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后创建一个 filter："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"nest g filter aaa --flat --no-spec\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:J,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"Nest 会 catch 所有未捕获异常，如果是 Exception Filter 声明的异常，那就会调用 filter 来处理。"}),"\n",(0,s.jsx)(n.p,{children:"那 filter 怎么声明捕获什么异常的呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们创建一个自定义的异常类："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"export class AaaException {\n    constructor(public aaa: string, public bbb: string) {\n        \n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"在 @Catch 装饰器里声明这个 filter 处理该异常："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:q,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后需要启用它："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:F,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"路由级别启用 AaaFilter，并且在 handler 里抛了一个 AaaException 类型的异常。"}),"\n",(0,s.jsx)(n.p,{children:"也可以全局启用："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"app.useGlobalFilters(new AaaFilter());\n"})}),"\n",(0,s.jsxs)(n.p,{children:["访问 ",(0,s.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 就可以看到 filter 被调用了。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:C,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"filter 的第一个参数就是异常对象，那第二个参数呢？"}),"\n",(0,s.jsx)(n.p,{children:"可以看到，它有这些方法："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:G,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们用调试的方式跑一下："}),"\n",(0,s.jsx)(n.p,{children:"点击 create launch.json file 创建一个调试配置文件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在 .vscode/launch.json 添加这样的调试配置："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "type": "pwa-node",\n    "request": "launch",\n    "name": "debug nest",\n    "runtimeExecutable": "npm",\n    "args": [\n        "run",\n        "start:dev",\n    ],\n    "skipFiles": [\n        "<node_internals>/**"\n    ],\n    "console": "integratedTerminal",\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"点击调试启动："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"打个断点："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:T,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["浏览器访问 ",(0,s.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 就可以看到它断住了："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:H,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们分别调用下这些方法试试："}),"\n",(0,s.jsx)(n.p,{children:"在 debug console 输入 host，可以看到它有这些属性方法："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"host.getArgs 方法就是取出当前上下文的 reqeust、response、next 参数。"}),"\n",(0,s.jsx)(n.p,{children:"因为当前上下文是 http 服务，如果是 WebSocket 服务，这里拿到的就是别的东西了。"}),"\n",(0,s.jsx)(n.p,{children:"host.getArgByIndex 方法是根据下标取参数："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"当然，一般不会根据 index 来取，而且这样用："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"调用 switchToHttp 切换到 http 上下文，然后再调用 getRequest、getResponse 方法。"}),"\n",(0,s.jsx)(n.p,{children:"如果是 websocket、基于 tcp 的微服务等上下文，就分别调用 host.swtichToWs、host.switchToRpc 方法。"}),"\n",(0,s.jsx)(n.p,{children:"这样，就可以在 filter 里处理多个上下文的逻辑，跨上下文复用 filter了。"}),"\n",(0,s.jsx)(n.p,{children:"加个 if else 判断即可："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, Catch, ExceptionFilter } from '@nestjs/common';\nimport { Response } from 'express';\nimport { AaaException } from './AaaException';\n\n@Catch(AaaException)\nexport class AaaFilter implements ExceptionFilter {\n  catch(exception: AaaException, host: ArgumentsHost) {\n    if(host.getType() === 'http') {\n      const ctx = host.switchToHttp();\n      const response = ctx.getResponse<Response>();\n      const request = ctx.getRequest<Request>();\n\n      response\n        .status(500)\n        .json({\n          aaa: exception.aaa,\n          bbb: exception.bbb\n        });\n    } else if(host.getType() === 'ws') {\n\n    } else if(host.getType() === 'rpc') {\n\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"刷新页面，就可以看到 filter 返回的响应："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["所以说，",(0,s.jsx)(n.strong,{children:"ArgumentHost 是用于切换 http、websocket、rpc 等上下文类型的，可以根据上下文类型取到对应的 argument，让 Exception Filter 等在不同的上下文中复用"}),"。"]}),"\n",(0,s.jsx)(n.p,{children:"那 guard 和 interceptor 里呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们创建个 guard 试一下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"nest g guard aaa --no-spec --flat\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到它传入的是 ExecutionContext："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"有这些方法："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"是不是很眼熟？"}),"\n",(0,s.jsx)(n.p,{children:"没错，ExecutionContext 是 ArgumentHost 的子类，扩展了 getClass、getHandler 方法。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"多加这两个方法是干啥的呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们调试下看看："}),"\n",(0,s.jsx)(n.p,{children:"路由级别启用 Guard："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在 Guard 里打个断点："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"调用下 context.getClass 和 getHandler："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"会发现这俩分别是要调用的 controller 的 class 以及要调用的方法。"}),"\n",(0,s.jsx)(n.p,{children:"为什么 ExecutionContext 里需要拿到目标 class 和 handler 呢？"}),"\n",(0,s.jsx)(n.p,{children:"因为 Guard、Interceptor 的逻辑可能要根据目标 class、handler 有没有某些装饰而决定怎么处理。"}),"\n",(0,s.jsx)(n.p,{children:"比如权限验证的时候，我们会先定义几个角色："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后定义这样一个装饰器："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"它的作用是往修饰的目标上添加 roles 的 metadata。"}),"\n",(0,s.jsx)(n.p,{children:"然后在 handler 上添加这个装饰器，参数为 admin，也就是给这个 handler 添加了一个 roles 为 admin 的metadata。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样在 Guard 里就可以根据这个 metadata 决定是否放行了："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Observable } from 'rxjs';\nimport { Role } from './role';\n\n@Injectable()\nexport class AaaGuard implements CanActivate {\n  constructor(private reflector: Reflector) {}\n\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n\n    const requiredRoles = this.reflector.get<Role[]>('roles', context.getHandler());\n\n    if (!requiredRoles) {\n      return true;\n    }\n\n    const { user } = context.switchToHttp().getRequest();\n    return requiredRoles.some((role) => user && user.roles?.includes(role));\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"我们在 Guard 里通过 ExecutionContext 的 getHandler 方法拿到了目标 handler 方法。"}),"\n",(0,s.jsx)(n.p,{children:"然后通过 reflector 的 api 拿到它的 metadata。"}),"\n",(0,s.jsx)(n.p,{children:"判断如果没有 roles 的 metadata 就是需要权限，那就直接放行。"}),"\n",(0,s.jsx)(n.p,{children:"如果有，就是需要权限，从 user 的 roles中判断下又没有当前 roles，有的话就放行。"}),"\n",(0,s.jsx)(n.p,{children:"刷新页面，可以看到返回的是 403："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这说明 Guard 生效了。"}),"\n",(0,s.jsx)(n.p,{children:"这就是 Guard 里的 ExecutionContext 参数的用法。"}),"\n",(0,s.jsx)(n.p,{children:"同样，在 interceptor 里也有这个："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"nest g interceptor aaa --no-spec --flat\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:a,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"同样可以通过 reflector 取出 class 或者 handler 上的 metdadata。"}),"\n",(0,s.jsxs)(n.p,{children:["案例代码在",(0,s.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/argument-host",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"为了让 Filter、Guard、Exception Filter 支持 http、ws、rpc 等场景下复用，Nest 设计了 ArgumentHost 和 ExecutionContext 类。"}),"\n",(0,s.jsx)(n.p,{children:"ArgumentHost 可以通过 getArgs 或者 getArgByIndex 拿到上下文参数，比如 request、response、next 等。"}),"\n",(0,s.jsx)(n.p,{children:"更推荐的方式是根据 getType 的结果分别 switchToHttp、switchToWs、swtichToRpc，然后再取对应的 argument。"}),"\n",(0,s.jsx)(n.p,{children:"而 ExecutionContext 还提供 getClass、getHandler 方法，可以结合 reflector 来取出其中的 metadata。"}),"\n",(0,s.jsx)(n.p,{children:"在写 Filter、Guard、Exception Filter 的时候，是需要用到这些 api 的。"})]})}function Q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(O,{...e})}):O(e)}let D=Q;Q.__RSPRESS_PAGE_META={},Q.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F14.%20ExecutionContext%EF%BC%9A%E5%88%87%E6%8D%A2%E4%B8%8D%E5%90%8C%E4%B8%8A%E4%B8%8B%E6%96%87.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"14. ExecutionContext：切换不同上下文",headingTitle:"14. ExecutionContext：切换不同上下文",frontmatter:{}}}}]);