"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["84898"],{245285:function(e,n,s){s.r(n),s.d(n,{default:()=>V});var a=s(552676),r=s(740453);let c=s.p+"static/image/f7f3f51b2ea2c469ebe9b1a3222ab264.dae897fe.webp",i=s.p+"static/image/916e4c1418aac0f7f37645022543dfb4.51f0ad69.webp",t=s.p+"static/image/ebe001b99dddf34179a907e9b17843b6.e5ceadb4.webp",l=s.p+"static/image/e25cb6d37290aa8b87fda3a9bc1fc716.d90b57db.webp",p=s.p+"static/image/a416bc4594a4b3a829b78b442db00638.662dcbf1.webp",d=s.p+"static/image/37d42fe74842cb75ce2a1a66f2728366.5a2a2ed0.webp",o=s.p+"static/image/a3ad792e33d6ee293ae91641295937e0.65ddb3f5.webp",j=s.p+"static/image/01c426c740cd0372711b2e87d3cfd9c1.2638aca3.webp",h=s.p+"static/image/43ab03b8692d0e817356e6f3c507c153.d2c2d817.webp",x=s.p+"static/image/02ef36a9dbeebbf5e6f16137fbdad1a0.65ddb3f5.webp",m=s.p+"static/image/7325de04084c293f5e80ddf3c359f0c4.037cf357.webp",g=s.p+"static/image/89d9715972c29cad66a80c52347b5da3.2160a890.webp",b=s.p+"static/image/d538aedbaa4ce4cc4391b3f27c9650a8.19741356.webp",f=s.p+"static/image/b47d38364e825a39c3c54caaa4665c5f.34feb92e.webp",u=s.p+"static/image/b07b54334e63a44dc4d6148ea27b8e63.205e71d5.webp",v=s.p+"static/image/eb5974961f3dfedef9790ecfe2614e9e.6add5cb7.webp",w=s.p+"static/image/51c1075e46e1251d97522f646b5dbcf0.4a9054ac.webp",I=s.p+"static/image/786d1b759345c93057ded97d208d02c5.faeba600.webp",N=s.p+"static/image/708098ffac6b183ebde54d7712fcf727.58cda7a9.webp",E=s.p+"static/image/617cab47ee141d6138ce1dd207ff92d7.6ccbf401.webp",A=s.p+"static/image/c2ea66f7ec9fb608825e73ebf2337b70.56abff92.webp",y=s.p+"static/image/b0c4faeb4bc4fee331f791bf512eddd7.6eb5e457.webp",M=s.p+"static/image/f959c67600a953606c7417872e5764d0.17af89e2.webp",S=s.p+"static/image/ef74610bbd8e0e15ae39bb4a725773d4.3d1dacb3.webp",k=s.p+"static/image/6d29d12f6f62c70a33bf5c9f46cada0b.eece8e35.webp",C=s.p+"static/image/e4e9af3ee9827c0b8e8710d806d9284a.d9cdf071.webp",_=s.p+"static/image/0fae45c9526333f83a2adb0a649d32a5.eb14a287.webp",P=s.p+"static/image/3cbfdb66c49e2718d68b5cd3882fb7ba.cff567c4.webp";function R(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.h1,{id:"108-nest-如何实现国际化",children:["108. Nest 如何实现国际化？",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#108-nest-如何实现国际化",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"如果你的网站要支持多种语言访问，那就要做国际化。"}),"\n",(0,a.jsx)(n.p,{children:"也就是中文用户访问返回中文界面，英文用户访问返回英文界面。"}),"\n",(0,a.jsx)(n.p,{children:"如果你在外企，那可能经常要做这些，比如我在韩企的时候，要支持韩文、英文，在日企的时候，要支持日文、英文。"}),"\n",(0,a.jsx)(n.p,{children:"不只是前端要做国际化，后端也要做，不然英文用户用着英文的界面登录的时候，突然返回一个“用户不存在”的错误，是不是一脸懵逼？"}),"\n",(0,a.jsx)(n.p,{children:"今天我们就来学一下 Nest 如何实现国际化。"}),"\n",(0,a.jsxs)(n.p,{children:["Nest 里做国际化用 ",(0,a.jsx)(n.a,{href:"https://www.npmjs.com/package/nestjs-i18n",target:"_blank",rel:"noopener noreferrer",children:"nestjs-i18n"})," 这个包："]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:P,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"我们来试一下："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"nest new i18n-test\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:_,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"安装 nestjs-i18n："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm install --save nestjs-i18n\n"})}),"\n",(0,a.jsx)(n.p,{children:"在 AppModule 引入 I18nModule："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { I18nModule, QueryResolver } from 'nestjs-i18n';\nimport * as path from 'path';\n\n@Module({\n  imports: [\n    I18nModule.forRoot({\n      fallbackLanguage: 'en',\n      loaderOptions: {\n        path: path.join(__dirname, '/i18n/'),\n        watch: true,\n      },\n      resolvers: [\n        new QueryResolver([\"lang\", \"l\"]),\n      ]\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,a.jsx)(n.p,{children:"默认语言是 en，然后资源包在 i18n 目录下。"}),"\n",(0,a.jsx)(n.p,{children:"resolver 也就是从哪里读取当前语言信息，这里是从 query 中读取，比如 ?lang=en、?l=zh"}),"\n",(0,a.jsx)(n.p,{children:"我们添加一下资源包："}),"\n",(0,a.jsx)(n.p,{children:"i18n/en/test.json"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "hello": "Hello World"\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"i18n/zh/test.json"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "hello": "你好世界"\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"这里的国际化资源包要在 nest-cli.json 里配置下自动复制："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:C,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'"assets": [\n  { "include": "i18n/**/*", "watchAssets": true }\n]\n'})}),"\n",(0,a.jsx)(n.p,{children:"然后改下 AppService："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { I18nContext, I18nService } from 'nestjs-i18n';\n\n@Injectable()\nexport class AppService {\n\n  @Inject()\n  i18n: I18nService;\n\n  getHello(): string {\n    return this.i18n.t('test.hello', { lang: I18nContext.current().lang })\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"注入 I18nService，从资源包中取 test.hello 的值，也就是对应 test.json 里的 hello 的值，用当前的语言。"}),"\n",(0,a.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:k,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:S,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:M,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"可以看到，文案根据语言环境做了国际化。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:y,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"还有其他 resolver，比如根据自定义 header、cookie、accepet-language 的 header 等。"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { AcceptLanguageResolver, CookieResolver, HeaderResolver, I18nModule, QueryResolver } from 'nestjs-i18n';\nimport * as path from 'path';\n\n@Module({\n  imports: [\n    I18nModule.forRoot({\n      fallbackLanguage: 'en',\n      loaderOptions: {\n        path: path.join(__dirname, '/i18n/'),\n        watch: true,\n      },\n      resolvers: [\n        new QueryResolver([\"lang\", \"l\"]),\n        new HeaderResolver([\"x-custom-lang\"]),\n        new CookieResolver(['lang']),\n        AcceptLanguageResolver,\n      ]\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,a.jsx)(n.p,{children:"我们试一下 cookie："}),"\n",(0,a.jsx)(n.p,{children:"在 postman 里访问，添加一个 cookie："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:A,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:E,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:N,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"再访问就变成了中文的："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:I,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"有的同学可能问了，现在是用 I18nService 做的翻译，那不在 IoC 容器里的类，怎么翻译呢？"}),"\n",(0,a.jsx)(n.p,{children:"比如 dto："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:w,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"它并不在 IoC 容器里，没法注入 I18nService，怎么翻译这些文案呢？"}),"\n",(0,a.jsx)(n.p,{children:"这时候可以用专门的 Pipe。"}),"\n",(0,a.jsx)(n.p,{children:"我们加一个模块："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"nest g resource user\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:v,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"安装 dto 验证用的包："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm install --save class-validator class-transformer\n"})}),"\n",(0,a.jsx)(n.p,{children:"改一下 CreateUserDto："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { IsNotEmpty, MinLength } from \"class-validator\";\n\nexport class CreateUserDto {\n    @IsNotEmpty({\n        message: \"用户名不能为空\"\n    })\n    username: string;\n    \n    @IsNotEmpty({\n        message: '密码不能为空'\n    })\n    @MinLength(6, {\n        message: '密码不能少于 6 位'\n    })\n    password: string;\n                    \n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"校验 body 的错误需要全局启用 ValidationPipe："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:u,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"app.useGlobalPipes(new ValidationPipe());\n"})}),"\n",(0,a.jsx)(n.p,{children:"访问下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:f,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"如果是英文网站，需要返回英文的错误信息，但是 dto 不在 IoC 容器里，不能注入 I18nService，怎么办呢？"}),"\n",(0,a.jsx)(n.p,{children:"这时候可以用 nestjs-i18n 提供的 I18nValidationPipe 来替换 ValidationPipe。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:b,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { I18nValidationExceptionFilter, I18nValidationPipe } from 'nestjs-i18n';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n\n  app.useGlobalPipes(new I18nValidationPipe());\n\n  app.useGlobalFilters(new I18nValidationExceptionFilter({\n    detailedErrors: false\n  }));\n\n  await app.listen(3000);\n}\nbootstrap();\n"})}),"\n",(0,a.jsx)(n.p,{children:"然后把 message 改为资源的 key："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:g,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"访问下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:m,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"可以看到，key 被替换成了具体的文案。"}),"\n",(0,a.jsx)(n.p,{children:"把 cookie 里的 lang 改为 en："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:x,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"文案也换成了英文。"}),"\n",(0,a.jsx)(n.p,{children:"那接下来我们只要添加对应的资源包就可以了。"}),"\n",(0,a.jsx)(n.p,{children:"添加 i18n/zh/validate.json"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "usernameNotEmpty": "用户名不能为空",\n    "passwordNotEmpty": "密码不能为空",\n    "passwordNotLessThan6": "密码不能少于 6 位"\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"i18n/en/validate.json"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "usernameNotEmpty": "The username cannot be empty",\n    "passwordNotEmpty": "Password cannot be empty",\n    "passwordNotLessThan6": "The password cannot be less than 6 characters"\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"然后改下 dto 里的 message，换成资源的 key："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { IsNotEmpty, MinLength } from \"class-validator\";\n\nexport class CreateUserDto {\n    @IsNotEmpty({\n        message: \"validate.usernameNotEmpty\"\n    })\n    username: string;\n    \n    @IsNotEmpty({\n        message: 'validate.passwordNotEmpty'\n    })\n    @MinLength(6, {\n        message: 'validate.passwordNotLessThan6'\n    })\n    password: string;                    \n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"再次访问下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:j,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:o,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:d,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"中文环境返回中文文案、英文环境返回英文文案，这样就实现了国际化。"}),"\n",(0,a.jsx)(n.p,{children:"那如果这个密码位数不一定是 6 位呢？"}),"\n",(0,a.jsx)(n.p,{children:"文案里可以填占位符："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:p,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后用的时候传入参数："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:'@MinLength(6, {\n    message: i18nValidationMessage("validate.passwordNotLessThan6", {\n        num: 88\n    })\n})\n'})}),"\n",(0,a.jsx)(n.p,{children:"试一下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:t,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"I18nService 的 api 同样支持这个："}),"\n",(0,a.jsx)(n.p,{children:"加一下占位符："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:i,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后用的时候传入 args："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { I18nContext, I18nService } from 'nestjs-i18n';\n\n@Injectable()\nexport class AppService {\n\n  @Inject()\n  i18n: I18nService;\n\n  getHello(): string {\n    return this.i18n.t('test.hello', {\n      lang: I18nContext.current().lang,\n      args: {\n        name: 'guang'\n      }\n    })\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsxs)(n.p,{children:["案例代码上传了",(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/i18n-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,a.jsxs)(n.h2,{id:"总结",children:["总结",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"当你的应用需要支持多种语言环境的用户访问时，就要做国际化。"}),"\n",(0,a.jsx)(n.p,{children:"前端要做界面的国际化，后端也同样要做返回的信息的国际化。"}),"\n",(0,a.jsx)(n.p,{children:"nest 里我们用 nestjs-i18n 这个包，在 AppModule 里引入 I18nModule，指定资源包的路径，resolver（取 lang 配置的方式）。"}),"\n",(0,a.jsx)(n.p,{children:"然后就可以注入 I18nSerive，用它的 t 方法来取资源包中的文案了。"}),"\n",(0,a.jsx)(n.p,{children:"dto 的国际化需要全局启用 I18nValidationPipe 和 I18nValidationExceptionFilter，然后把 message 换成资源包的 key 就好了。"}),"\n",(0,a.jsx)(n.p,{children:"文案支持占位符，可以在资源包里写 {xxx} 然后用的时候传入 xxx 的值。"}),"\n",(0,a.jsx)(n.p,{children:"如果你做一个面向多种语言用户的网站，那么国际化功能是必不可少的。"})]})}function L(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(R,{...e})}):R(e)}let V=L;L.__RSPRESS_PAGE_META={},L.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F108.%20Nest%20%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%9B%BD%E9%99%85%E5%8C%96%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"108. Nest 如何实现国际化？",headingTitle:"108. Nest 如何实现国际化？",frontmatter:{}}}}]);