"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["77037"],{514192:function(e,n,s){e.exports=s.p+"static/image/ac074c7277d122dce78523c5e013eba5.8a08d3f8.gif"},7118:function(e,n,s){e.exports=s.p+"static/image/cb945ff047f86829c5a9989e94537fee.2a7efcac.gif"},808488:function(e,n,s){s.r(n),s.d(n,{default:()=>V});var t=s(552676),r=s(740453);let i=s.p+"static/image/8bc48d2ae136d5ab63b6541d9970ee97.51b72ba3.webp";var a=s(7118);let o=s.p+"static/image/e5d728a91ffe60797392ebe84f798b68.519236af.webp",c=s.p+"static/image/3774198986efb970d03311e814326bcc.4da0067f.gif",d=s.p+"static/image/62e01e8f7c336d0e7b73e70fe368c21b.3c2fbc54.webp",p=s.p+"static/image/62a0e5fa86c949acf03ad758563e4c1f.921e3660.webp",g=s.p+"static/image/b7c9d74f99f89de9c08799fbe1d502a4.6d4e5572.gif",m=s.p+"static/image/c9e9f96f341d3839e2f403a40e0e5bff.8273d665.gif",l=s.p+"static/image/f7cae802e31b8935c697b3a2020b8250.514b4365.webp",x=s.p+"static/image/29325d94b9eaf220f43073c51e2ac39b.1e0d63f1.webp",u=s.p+"static/image/80d017dbeb8fcb09f72ea4790635b60b.b9a24743.gif",f=s.p+"static/image/221fd7f275e2fbd9c797ba7b108ad31b.e2c26728.webp",j=s.p+"static/image/d560f820f0a3ef426fdb8165a42b586c.074f47a6.gif",h=s.p+"static/image/12a8027881304e9f7497f9ff9ef8ce60.39ed5e26.webp",A=s.p+"static/image/0cf31fe6e978f3e495021b8615bf2bac.ee2cf68b.webp",b=s.p+"static/image/2c745b63a0ada645a5b5bf2e14ba7c68.16244c41.webp",C=s.p+"static/image/f97e8cd6997728153ba30d78a3847e51.ebd21213.gif",v=s.p+"static/image/b4cc3a33d0c697a514e1957983d08845.c35da463.webp",E=s.p+"static/image/155bbe33956997f3fc874de20e2eb4f1.c0c1f979.gif",P=s.p+"static/image/ed9d1c4bbd8a4de483fc874f35877164.d2b23e0f.webp",M=s.p+"static/image/e6e61970416cfd4b1f4081e292a6c1be.95b88c33.webp",I=s.p+"static/image/282d2ec6c9b13d98dc6b1bdb5c263448.922ab584.gif",B=s.p+"static/image/5831f0daeee29f9e32351f999fae43f1.505ba411.webp",S=s.p+"static/image/a9313d3374cd974bc2a6671e482468a5.854ece43.webp",Q=s.p+"static/image/1178ad047b6229af6d40c248c8552922.a55a5881.gif",R=s.p+"static/image/ada0259dbf898ec1a32e4559b3e70dc9.07de5d41.webp",T=s.p+"static/image/077f59d724cd235bec747c97467b46cd.5823c724.webp",w=s.p+"static/image/70c81b0171707e03d936cf87239d35db.ad813cec.webp",N=s.p+"static/image/1522460ce2aa2598e21fd68ec65a2036.c600b212.webp",L=s.p+"static/image/1d05f8319477d15ca09a421e6951a679.e550b7c2.webp",y=s.p+"static/image/e98b70cebc42adc9cec9686947b16409.960d8a38.webp",k=s.p+"static/image/9ce264bdcb8b4574365dc6f0018598ce.9120e887.webp",G=s.p+"static/image/926d5ed2c0bf32de023e4c7427c2e7e9.23256132.webp",X=s.p+"static/image/a30b3149da2d461cfc9ec52ae2f39ef3.7f5f14fe.gif",F=s.p+"static/image/eeca335b5ab1d804bdbcd1f29842d2a9.e1211f87.webp",z=s.p+"static/image/4bb586262f96958b5062ecd70f7ce355.dbef754a.gif",K=s.p+"static/image/604e4a00ddd0457cfd71b96a5058f4cb.1bb1c8d2.webp",W=s.p+"static/image/06cda0bb3424b313e48e61ed43dfe060.331eb06a.webp";var O=s(514192);let U=s.p+"static/image/98774daeb91ac1e947294c9384838e40.74ee32fc.webp",H=s.p+"static/image/c132127fb3a211f262d0501ec6cdc45a.0fd3f8a9.webp",J=s.p+"static/image/7d90067aa24269fce52a158cdefb1eef.12d47ec0.webp";function Z(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2",strong:"strong"},(0,r.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.h1,{id:"第30章组件实战message全局提示组件",children:["第30章—组件实战：Message全局提示组件",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#第30章组件实战message全局提示组件",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"\uFEFF我们经常会用 Message 组件来展示一些成功、失败的提示："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:z,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"和一般组件写在 JSX 里不同："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:J,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"它是通过 api 的方式用的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:H,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"那它是怎么实现的呢？"}),"\n",(0,t.jsx)(n.p,{children:"我们来分析下思路："}),"\n",(0,t.jsx)(n.p,{children:"其实单纯就这个列表来说，很简单："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:U,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们学习过渡动画的时候，写过这种列表："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:O,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"用 react-transition-group 或者 react-spring 都可以做。"}),"\n",(0,t.jsx)(n.p,{children:"但是怎么通过 api 的方式渲染这个列表组件呢？"}),"\n",(0,t.jsx)(n.p,{children:"先看看其他组件库是怎么做的，比如 arco design："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:W,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"它是在组件渲染的过程中再重新渲染一个 root。"}),"\n",(0,t.jsx)(n.p,{children:"也就是你调用 message.info 的时候，它会创建一个新的 dom，然后通过 ReactDOM.render（或者 createRoot）在这个 dom 下新渲染一个组件树。"}),"\n",(0,t.jsx)(n.p,{children:"但是，这种方式会报 warning。"}),"\n",(0,t.jsx)(n.p,{children:"acro design 是这么解决的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:K,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"通过修改了内部的一个 waring 的开关来去掉了这个警告。"}),"\n",(0,t.jsx)(n.p,{children:"人家不让你这么用，你非得这么用，很显然，这样的实现方式不大好。"}),"\n",(0,t.jsx)(n.p,{children:"那怎么实现呢？"}),"\n",(0,t.jsx)(n.p,{children:"其实 message.info 只是需要调用列表元素的 add、remove 等方法。"}),"\n",(0,t.jsx)(n.p,{children:"那我们通过 forwardRef 的方式把 ref 转发出去，然后保存在 context 里。"}),"\n",(0,t.jsx)(n.p,{children:"这样 useMessage 里用 useContext 拿到这个 ref，是不是就可以调用 add、remove 等方法来添加删除 Message 了呢？"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"回过头来看下这个 Message 组件："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:z,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们只需要维护一个数组 state，把它的 add、remove 方法通过 ref 暴露出去，保存在 context 里，使用的时候通过 useMesage 里的 useContext 拿到 add、remove 方法调用就好了。"}),"\n",(0,t.jsx)(n.p,{children:"渲染这个数组的时候要用 createPortal 在 body 下渲染，并且还要加上过渡动画。"}),"\n",(0,t.jsx)(n.p,{children:"思路理清了，我们来写下代码。"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npx create-react-app --template=typescript message-component\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:F,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"用 cra 创建个 react 项目。"}),"\n",(0,t.jsx)(n.p,{children:"改下 index.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import ReactDOM from 'react-dom/client';\nimport App from './App';\n\nconst root = ReactDOM.createRoot(\n  document.getElementById('root') as HTMLElement\n);\nroot.render(<App />);\n"})}),"\n",(0,t.jsx)(n.p,{children:"创建 Mesage/index.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CSSProperties, FC, ReactNode } from \"react\";\n\nexport type Position = 'top' | 'bottom';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode;\n    duration?: number;\n    id?: number;\n    position?: Position;\n}\n\nexport const MessageProvider: FC<{}> = (props) => {\n    return <div></div>\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"这里的 MessageProps 就是每个 message 可以设置的参数，比如 content、duration。"}),"\n",(0,t.jsx)(n.p,{children:"而 MessageProviderProps 是整体的默认设置。"}),"\n",(0,t.jsx)(n.p,{children:"我们先实现管理 Message 列表的 hook："}),"\n",(0,t.jsx)(n.p,{children:"Message/useStore.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { useState } from 'react';\nimport { MessageProps, Position } from '.';\n\ntype MessageList = {\n    top: MessageProps[],\n    bottom: MessageProps[]\n}\n\nconst initialState = {\n  top: [],\n  bottom: []\n};\n\nfunction useStore(defaultPosition: Position) {\n  const [messageList, setMessageList] = useState<MessageList>({ ...initialState });\n\n  return {\n    messageList,\n    add: (messageProps: MessageProps) => {\n  \n    },\n\n    update: (id: number, messageProps: MessageProps) => {\n\n    },\n\n    remove: (id: number) => {\n\n    },\n    \n    clearAll: () => {\n\n    },\n  };\n}\n\nexport default useStore;\n"})}),"\n",(0,t.jsx)(n.p,{children:"就是通过 useState 创建一个列表，然后返回这个 state 和 add、remove、update、clearAll 方法。"}),"\n",(0,t.jsx)(n.p,{children:"列表有 top 和 bottom 两个，是因为可以在上面也可以出现在下面："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:X,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"然后具体实现下 add、remove、update 方法。"}),"\n",(0,t.jsx)(n.p,{children:"先放全部代码再慢慢解释："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { useState } from 'react';\nimport { MessageProps, Position } from '.';\n\ntype MessageList = {\n    top: MessageProps[],\n    bottom: MessageProps[]\n}\n\nconst initialState = {\n  top: [],\n  bottom: []\n};\n\nfunction useStore(defaultPosition: Position) {\n  const [messageList, setMessageList] = useState<MessageList>({ ...initialState });\n\n  return {\n    messageList,\n    add: (messageProps: MessageProps) => {\n      const id = getId(messageProps);\n      setMessageList((preState) => {\n        if (messageProps?.id) {\n          const position = getMessagePosition(preState, messageProps.id);\n          if (position) return preState;\n        }\n\n        const position = messageProps.position || defaultPosition;\n        const isTop = position.includes('top');\n        const messages = isTop\n          ? [{ ...messageProps, id }, ...(preState[position] ?? [])]\n          : [...(preState[position] ?? []), { ...messageProps, id }];\n\n        return {\n          ...preState,\n          [position]: messages,\n        };\n      });\n      return id;\n    },\n\n    update: (id: number, messageProps: MessageProps) => {\n      if (!id) return;\n\n      setMessageList((preState) => {\n        const nextState = { ...preState };\n        const { position, index } = findMessage(nextState, id);\n\n        if (position && index !== -1) {\n          nextState[position][index] = {\n            ...nextState[position][index],\n            ...messageProps,\n          };\n        }\n\n        return nextState;\n      });\n    },\n\n    remove: (id: number) => {\n        setMessageList((prevState) => {\n            const position = getMessagePosition(prevState, id);\n\n            if (!position) return prevState;\n            return {\n                ...prevState,\n                [position]: prevState[position].filter((notice) => notice.id !== id),\n            };\n        });\n    },\n\n    clearAll: () => {\n      setMessageList({ ...initialState });\n    },\n  };\n}\n\nlet count = 1;\nexport function getId(messageProps: MessageProps) {\n  if (messageProps.id) {\n    return messageProps.id;\n  }\n  count += 1;\n  return count;\n}\n\nexport function getMessagePosition(messageList: MessageList, id: number) {\n    for (const [position, list] of Object.entries(messageList)) {\n        if (list.find((item) => item.id === id)) {\n            return position as Position;\n        }\n    }\n}\n\nexport function findMessage(messageList: MessageList, id: number) {\n    const position = getMessagePosition(messageList, id);\n  \n    const index = position ? messageList[position].findIndex((message) => message.id === id) : -1;\n  \n    return {\n      position,\n      index,\n    };\n}\n\nexport default useStore;\n"})}),"\n",(0,t.jsx)(n.p,{children:"首先是 add："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:G,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"add 核心就是 setMessageList 添加一个元素。"}),"\n",(0,t.jsx)(n.p,{children:"用 getId 方法生成一个新的 id："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:k,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"如果传入了 id 就直接用传入的，否则返回递增的 id。"}),"\n",(0,t.jsx)(n.p,{children:"然后先根据 id 查找有没有已有的 message，如果有就不添加，直接返回之前的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:y,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"否则，top 的在前面插入一个元素，bottom 的在后面插入一个元素："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:L,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这个 getMessagePosition 方法就是遍历 top 和 bottom 数组，查找下有没有对应的 Message："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:N,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"update 就是找到对应的 message 修改信息："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:w,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"查找的方式就是先找到它在哪个数组里，然后返回对应数组中的下标："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:T,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"remove 是找到对应的数组，从中删除这个元素，clear 是重置数组："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:R,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"实现了列表的增删改查之后，加上过渡动画就能实现这种效果："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:Q,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们在 MessageProvider 里用 useStore 创建 message 列表，然后把它渲染出来："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:S,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CSSProperties, FC, ReactNode } from \"react\";\nimport useStore from \"./useStore\";\n\nexport type Position = 'top' | 'bottom';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode | string;\n    duration?: number;\n    id?: number;\n    position?: Position;\n}\n\nexport const MessageProvider: FC<{}> = (props) => {\n\n    const { messageList, add, update, remove, clearAll } = useStore('top');\n\n    return <div>{\n        messageList.top.map(item => {\n            return  <div style={{width: 100, lineHeight: '30px', border: '1px solid #000', margin: '20px'}}>\n                {item.content}\n            </div>\n        })\n    }</div>\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 App.tsx 里调用下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { MessageProvider } from "./Message";\n\nfunction App() {\n  return (\n    <div>\n      <MessageProvider></MessageProvider>      \n    </div>\n  );\n}\n\nexport default App;\n'})}),"\n",(0,t.jsx)(n.p,{children:"把开发服务跑起来："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm run start\n"})}),"\n",(0,t.jsx)(n.p,{children:"因为我们还没调用 add、remove 等方法添加 message，所以啥也没有："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们调用下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:B,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"useEffect(() => {\n    setInterval(() => {\n        add({\n            content: Math.random().toString().slice(2, 8)\n        })\n    }, 2000);\n}, []);\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:I,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"调用 add 添加 message 之后，页面就会渲染这个 message。"}),"\n",(0,t.jsx)(n.p,{children:"然后加上过渡动画，用 react-transition-group。"}),"\n",(0,t.jsx)(n.p,{children:"安装下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm install --save react-transition-group\n\nnpm install --save-dev @types/react-transition-group\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:M,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"return <div>\n    <TransitionGroup>\n        {\n            messageList[position].map(item => {\n                return  <CSSTransition key={item.id} timeout={1000} classNames='message'>\n                    <div style={{width: 100, lineHeight: '30px', border: '1px solid #000', margin: '20px'}}>\n                        {item.content}\n                    </div>\n                </CSSTransition>\n            })\n        }\n    </TransitionGroup>\n</div>\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 css 里写一下对应的 enter、enter-active 的具体样式："}),"\n",(0,t.jsx)(n.p,{children:"Message/index.scss"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-scss",children:".message-enter {\n  opacity: 0;\n  transform: scale(1.1);\n}\n\n.message-enter-active {\n  opacity: 1;\n  transform: scale(1);\n  transition: opacity,transform 1s ease;\n}\n\n.message-exit {\n  opacity: 1;\n}\n\n.message-exit-active {\n  opacity: 0;\n  transition: opacity 1s ease;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"安装 sass 包:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm install --save sass\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 Message/index.tsx 引入下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:P,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:E,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"当然，现在的 message 比较丑，我们写一下样式："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:v,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"首先分为 .message-wrapper、.message-wrapper-top、.message-item 这三层。"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CSSProperties, FC, ReactNode, useEffect } from \"react\";\nimport useStore, { MessageList } from \"./useStore\";\nimport { CSSTransition, TransitionGroup } from \"react-transition-group\";\n\nimport './index.scss';\n\nexport type Position = 'top' | 'bottom';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode | string;\n    duration?: number;\n    onClose?: (...args: any) => void;\n    id?: number;\n    position?: Position;\n}\n\nexport const MessageProvider: FC<{}> = (props) => {\n\n    const { messageList, add, update, remove, clearAll } = useStore('top');\n\n    useEffect(() => {\n        setInterval(() => {\n            add({\n                content: Math.random().toString().slice(2, 8)\n            })\n        }, 2000);\n    }, []);\n\n    const positions = Object.keys(messageList) as Position[];\n\n    return <div className=\"message-wrapper\">\n        {\n            positions.map(direction => {\n                return <TransitionGroup className={`message-wrapper-${direction}`} key={direction}>\n                        {\n                            messageList[direction].map(item => {\n                                return  <CSSTransition key={item.id} timeout={1000} classNames='message'>\n                                    <div className=\"message-item\">\n                                        {item.content}\n                                    </div>\n                                </CSSTransition>\n                            })\n                        }\n                </TransitionGroup>\n            })\n        }\n    </div>\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"然后写下样式："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-scss",children:".message-wrapper {\n  position: fixed;\n  width: 100%;\n  height: 100%;\n\n  pointer-events: none;\n\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-start;\n  align-items: center;\n\n  &-top {\n    position: absolute;\n    top: 20px;\n  }\n\n  &-bottom {\n    position: absolute;\n    bottom: 20px;\n  }\n}\n\n.message-item {\n  margin-bottom: 12px;\n\n  padding: 10px 16px;\n  line-height: 14px;\n  font-size: 14px;\n\n  border: 1px solid #ccc;\n  box-shadow: 0 0 3px #ccc;\n  \n  pointer-events: all;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"最外层要设置 fixed，然后宽高 100%，然后加上 pointer-events:none 不响应鼠标事件。"}),"\n",(0,t.jsx)(n.p,{children:"wrapper 不响应鼠标事件，但是 message 还是要响应的，所以加上 pointer-event:all"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:C,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"好看多了。"}),"\n",(0,t.jsx)(n.p,{children:"只是现在的 message 都是在 root 下渲染的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们通过 createPortal 把它渲染到 body 下。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:A,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"在 useMemo 里创建 div，因为依赖数组为空，所以只会创建一次。"}),"\n",(0,t.jsx)(n.p,{children:"然后用 createPortal 把 messageWrapper 渲染到它下面。"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CSSProperties, FC, ReactNode, useEffect, useMemo, useRef } from \"react\";\nimport useStore, { MessageList } from \"./useStore\";\nimport { CSSTransition, TransitionGroup } from \"react-transition-group\";\n\nimport './index.scss';\nimport { createPortal } from \"react-dom\";\n\nexport type Position = 'top' | 'bottom';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode | string;\n    duration?: number;\n    onClose?: (...args: any) => void;\n    id?: number;\n    position?: Position;\n}\n\nexport const MessageProvider: FC<{}> = (props) => {\n\n    const { messageList, add, update, remove, clearAll } = useStore('top');\n\n    useEffect(() => {\n        setInterval(() => {\n            add({\n                content: Math.random().toString().slice(2, 8)\n            })\n        }, 2000);\n    }, []);\n\n    const positions = Object.keys(messageList) as Position[];\n\n    const messageWrapper = <div className=\"message-wrapper\">\n        {\n            positions.map(direction => {\n                return <TransitionGroup className={`message-wrapper-${direction}`} key={direction}>\n                        {\n                            messageList[direction].map(item => {\n                                return  <CSSTransition key={item.id} timeout={1000} classNames='message'>\n                                    <div className=\"message-item\">\n                                        {item.content}\n                                    </div>\n                                </CSSTransition>\n                            })\n                        }\n                </TransitionGroup>\n            })\n        }\n    </div>\n\n    const el = useMemo(() => {\n        const el = document.createElement('div');\n        el.className = `wrapper`;\n\n        document.body.appendChild(el);\n        return el;\n    }, []);\n\n    return createPortal(messageWrapper, el);\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"可以看到，现在就是直接渲染在 body 下的 .wrapper 里了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:h,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"此外，我们还要处理下 hover 的事件，当 hover 的时候，这个提示会一直存在不会消失，直到鼠标移开才消失。"}),"\n",(0,t.jsx)(n.p,{children:"否则，到了 duration 的时间就会消失。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:j,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们把逻辑放到一个自定义 hook 中写："}),"\n",(0,t.jsx)(n.p,{children:"Message/useTimer.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { useEffect, useRef } from 'react';\n\nexport interface UseTimerProps {\n    id: number;\n    duration?: number;\n    remove: (id: number) => void;\n}\n\nexport function useTimer(props: UseTimerProps) {\n  const { remove, id, duration = 2000 } = props;\n\n  const timer = useRef<number | null>(null);\n\n  const startTimer = () => {\n    timer.current = window.setTimeout(() => {\n      remove(id);\n      removeTimer();\n    }, duration);\n  };\n\n  const removeTimer = () => {\n    if (timer.current) {\n      clearTimeout(timer.current);\n      timer.current = null;\n    }\n  };\n\n  useEffect(() => {\n    startTimer();\n    return () => removeTimer();\n  }, []);\n\n  const onMouseEnter = () => {\n    removeTimer();\n  };\n\n  const onMouseLeave = () => {\n    startTimer();\n  };\n\n  return {\n    onMouseEnter,\n    onMouseLeave,\n  };\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"传入 message 的 id、duration，还有 remove 方法。"}),"\n",(0,t.jsx)(n.p,{children:"用 useEffect 执行 startTimer，到 duration 的时候删掉 message、停止定时器。"}),"\n",(0,t.jsx)(n.p,{children:"然后如果 mouseEnter 的时候删掉定时器，mouseLeave 重新开启。"}),"\n",(0,t.jsx)(n.p,{children:"调用下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:f,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { CSSProperties, FC, ReactNode, useEffect, useMemo, useRef } from "react";\nimport useStore, { MessageList } from "./useStore";\nimport { CSSTransition, TransitionGroup } from "react-transition-group";\n\nimport \'./index.scss\';\nimport { createPortal } from "react-dom";\nimport { useTimer } from "./useTimer";\n\nexport type Position = \'top\' | \'bottom\';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode | string;\n    duration?: number;\n    onClose?: (...args: any) => void;\n    id?: number;\n    position?: Position;\n}\nconst MessageItem:FC<MessageProps> = (item) => {\n    const {onMouseEnter, onMouseLeave} = useTimer({\n        id: item.id!,\n        duration: item.duration,\n        remove: item.onClose!,\n    });\n\n    return <div className="message-item" onMouseEnter={onMouseEnter} onMouseLeave={onMouseLeave}>\n        {item.content}\n    </div>\n}\n\nexport const MessageProvider: FC<{}> = (props) => {\n\n    const { messageList, add, update, remove, clearAll } = useStore(\'top\');\n\n    useEffect(() => {\n        setInterval(() => {\n            add({\n                content: Math.random().toString().slice(2, 8)\n            })\n        }, 2000);\n    }, []);\n\n    const positions = Object.keys(messageList) as Position[];\n\n    const messageWrapper = <div className="message-wrapper">\n        {\n            positions.map(direction => {\n                return <div className={`message-wrapper-${direction}`} key={direction}>\n                    <TransitionGroup>\n                        {\n                            messageList[direction].map(item => {\n                                return  <CSSTransition key={item.id} timeout={1000} classNames=\'message\'>\n                                    <MessageItem onClose={remove} {...item}></MessageItem>\n                                </CSSTransition>\n                            })\n                        }\n                    </TransitionGroup>\n                </div>\n            })\n        }\n    </div>\n\n    const el = useMemo(() => {\n        const el = document.createElement(\'div\');\n        el.className = `wrapper`;\n\n        document.body.appendChild(el);\n        return el;\n    }, []);\n\n    return createPortal(messageWrapper, el);\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"可以看到过 2s message 就会消息，如果鼠标 hover 上去会直到移开鼠标再过 2s 消失。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:u,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"样式写完了，我们再来处理下调用方式的问题。"}),"\n",(0,t.jsx)(n.p,{children:"用的时候我们是通过 message.info 的方式用，前面分析过，需要通过 forwardRef 把 api 转发出去。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"使用 forwardRef + useImperative 转发 ref。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:l,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { CSSProperties, FC, ReactNode, forwardRef, useEffect, useImperativeHandle, useMemo, useRef } from "react";\nimport useStore, { MessageList } from "./useStore";\nimport { CSSTransition, TransitionGroup } from "react-transition-group";\n\nimport \'./index.scss\';\nimport { createPortal } from "react-dom";\nimport { useTimer } from "./useTimer";\n\nexport type Position = \'top\' | \'bottom\';\n\nexport interface MessageProps {\n    style?: CSSProperties;\n    className?: string | string[];\n    content: ReactNode | string;\n    duration?: number;\n    onClose?: (...args: any) => void;\n    id?: number;\n    position?: Position;\n}\n\nconst MessageItem:FC<MessageProps> = (item) => {\n    const {onMouseEnter, onMouseLeave} = useTimer({\n        id: item.id!,\n        duration: item.duration,\n        remove: item.onClose!,\n    });\n\n    return <div className="message-item" onMouseEnter={onMouseEnter} onMouseLeave={onMouseLeave}>\n        {item.content}\n    </div>\n}\n\nexport interface MessageRef {\n    add: (messageProps: MessageProps) => number;\n    remove: (id: number) => void;\n    update: (id: number, messageProps: MessageProps) => void;\n    clearAll: () => void;\n}\n\nexport const MessageProvider = forwardRef<MessageRef, {}>((props, ref) => {\n\n    const { messageList, add, update, remove, clearAll } = useStore(\'top\');\n\n    // useEffect(() => {\n    //     setInterval(() => {\n    //         add({\n    //             content: Math.random().toString().slice(2, 8)\n    //         })\n    //     }, 2000);\n    // }, []);\n\n    useImperativeHandle(ref, () => {\n        return {\n            add,\n            update,\n            remove,\n            clearAll\n        }\n    }, []);\n\n    const positions = Object.keys(messageList) as Position[];\n\n    const messageWrapper = <div className="message-wrapper">\n        {\n            positions.map(direction => {\n                return <div className={`message-wrapper-${direction}`} key={direction}>\n                    <TransitionGroup>\n                        {\n                            messageList[direction].map(item => {\n                                return  <CSSTransition key={item.id} timeout={1000} classNames=\'message\'>\n                                    <MessageItem onClose={remove} {...item}></MessageItem>\n                                </CSSTransition>\n                            })\n                        }\n                    </TransitionGroup>\n                </div>\n            })\n        }\n    </div>\n\n    const el = useMemo(() => {\n        const el = document.createElement(\'div\');\n        el.className = `wrapper`;\n\n        document.body.appendChild(el);\n        return el;\n    }, []);\n\n    return createPortal(messageWrapper, el);\n})\n'})}),"\n",(0,t.jsx)(n.p,{children:"在 App.tsx 里引入下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { useRef } from "react";\nimport { MessageProvider, MessageRef } from "./Message";\n\nfunction App() {\n  const messageRef = useRef<MessageRef>(null);\n\n  return (\n    <div>\n      <MessageProvider ref={messageRef}></MessageProvider>     \n      <button onClick={() =>{\n        messageRef.current?.add({\n          content:\'请求成功\'\n        })\n      }}>成功</button>\n    </div>\n  );\n}\n\nexport default App;\n\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:m,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"是不是感觉很像了？"}),"\n",(0,t.jsx)(n.p,{children:"还差一点，我们要把它放到 Context 里。"}),"\n",(0,t.jsx)(n.p,{children:"创建 Message/ConfigProvider.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { PropsWithChildren, RefObject, createContext, useRef } from "react";\nimport { MessageProvider, MessageRef } from ".";\n\ninterface ConfigProviderProps {\n    messageRef?: RefObject<MessageRef>\n}\n\nexport const ConfigContext = createContext<ConfigProviderProps>({});\n\nexport function ConfigProvider(props: PropsWithChildren) {\n\n    const { children } = props;\n    \n    const messageRef = useRef<MessageRef>(null);\n\n    return (\n      <ConfigContext.Provider value={{ messageRef }}>\n          <MessageProvider ref={messageRef}></MessageProvider>\n          {children}    \n      </ConfigContext.Provider>\n    );\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"这里用 createContext 创建 context，然后在其中放了 messageRef，这个 messageRef 的值是在 MessageProvider 设置的。"}),"\n",(0,t.jsx)(n.p,{children:"再添加一个 useMessage 的 hook："}),"\n",(0,t.jsx)(n.p,{children:"Message/useMessage.tsx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { useContext } from 'react';\nimport { ConfigContext } from './ConfigProvider';\nimport { MessageRef } from '.';\n\nexport function useMessage(): MessageRef {\n  const { messageRef } = useContext(ConfigContext);\n\n  if(!messageRef) {\n    throw new Error('请在最外层添加 ConfigProvider 组件');\n  }\n\n  return messageRef.current!;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"从 context 中拿到 messageRef，返回其中的 api。"}),"\n",(0,t.jsx)(n.p,{children:"这样在 App.tsx 里就可以这么用："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { ConfigProvider } from "./Message/ConfigProvider";\nimport { useMessage } from "./Message/useMessage";\n\nfunction Aaa() {\n  const message = useMessage();\n\n  return <button onClick={() =>{\n    message.add({\n      content:\'请求成功\'\n    })\n  }}>成功</button>\n}\n\nfunction App() {\n\n  return (\n    <ConfigProvider>\n      <div>\n        <Aaa></Aaa>\n      </div>\n    </ConfigProvider>\n  );\n}\n\nexport default App;\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"在最外层包裹 ConfigProvider 来设置 context，然后在 Aaa 组件里用 useMessage 拿到 message api，调用 add 方法。"}),"\n",(0,t.jsx)(n.p,{children:"但是跑起来你会发现报错了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:g,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"说 messageRef.current 是 null。"}),"\n",(0,t.jsx)(n.p,{children:"为什么呢，我们不是转发 ref 了么？"}),"\n",(0,t.jsx)(n.p,{children:"这个是时机的问题，我们在 useImperativeHandle 的回调函数，还有 useMessage 方法里加个 debugger："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:p,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:d,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"你会发现先执行的 useMessage 取了 messageRef.current 的值，然后我们才设置了 messageRef.current。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:c,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这与我们预期是不符的。"}),"\n",(0,t.jsx)(n.p,{children:"这是用 useImperative 的一个问题，它并不是立刻修改 ref，而是会在之后的某个时间来修改。"}),"\n",(0,t.jsx)(n.p,{children:"所以这里我们要改成直接修改 ref.current 的方式。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:o,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"if('current' in ref!) {\n    ref.current = {\n        add,\n        update,\n        remove,\n        clearAll\n    }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"这样我们的 message 组件就完成了！"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:a,alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["案例代码上传了",(0,t.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/react-course-code/tree/main/message-component",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,t.jsxs)(n.h2,{id:"总结",children:["总结",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"这节我们实现了 Message 组件。"}),"\n",(0,t.jsx)(n.p,{children:"它的核心就是一个列表元素的增删改，然后用 react-transition-group 加上过渡动画。"}),"\n",(0,t.jsx)(n.p,{children:"这个列表可以通过 createPortal 渲染到 body 下。"}),"\n",(0,t.jsx)(n.p,{children:"但是难点在于如何在 api 的方式来动态添加这个组件。"}),"\n",(0,t.jsx)(n.p,{children:"acro desigin 等都是用重新渲染一个 root 的方式来做的，但是这种会报警告，不建议用。"}),"\n",(0,t.jsx)(n.p,{children:"我们是通过 forwardRef + context 转发来实现的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:i,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"唯一要注意的问题就是需要直接修改 ref.current，而不是用 useImperativeHandle 来修改。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"useImperative 的好处是可以在依赖数组改变的时候重新执行回调函数来修改 ref，但坏处是它不是同步修改 ref 的，有的时候不太合适。"})}),"\n",(0,t.jsx)(n.p,{children:"这样，Message 组件就完成了。"}),"\n",(0,t.jsx)(n.p,{children:"这个组件还是比较复杂的，涉及到 ref 转发，context ，过渡动画，portal 等，还封装了两个自定义 hook，大家可以自己写一遍。"})]})}function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(Z,{...e})}):Z(e)}let V=q;q.__RSPRESS_PAGE_META={},q.__RSPRESS_PAGE_META["React%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%2F%E7%AC%AC30%E7%AB%A0%E2%80%94%E7%BB%84%E4%BB%B6%E5%AE%9E%E6%88%98%EF%BC%9AMessage%E5%85%A8%E5%B1%80%E6%8F%90%E7%A4%BA%E7%BB%84%E4%BB%B6.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"第30章—组件实战：Message全局提示组件",headingTitle:"第30章—组件实战：Message全局提示组件",frontmatter:{}}}}]);