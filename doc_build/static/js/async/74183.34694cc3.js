"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["74183"],{935196:function(e,n,r){r.r(n),r.d(n,{default:()=>X});var i=r(552676),s=r(740453);let d=r.p+"static/image/85708843ea7c0acc1a2ce367a10b4f33.cdab81af.webp",c=r.p+"static/image/658fdf95845a14bd6dd4c033467c5549.ccb71845.webp",a=r.p+"static/image/3556df5351c91d3f583b7193d8e1c362.35c03965.webp",t=r.p+"static/image/fd287945b1fef404bc8800d3fcea931f.8386793c.webp",p=r.p+"static/image/6a220b4295369ceb16f8b04c75953e63.60f2d095.webp",l=r.p+"static/image/d74266045ae4113c237407303a2cfb01.89757e98.webp",h=r.p+"static/image/593bed32a2bac6fb5039202ad58cf3ea.377c6634.webp",f=r.p+"static/image/a615653f76267b91e6735365352d122a.170a913c.webp",o=r.p+"static/image/f40c082d33649d72b6cc0e945ea3a361.7190fc45.webp",j=r.p+"static/image/6f8b0d83b85aca2bc514ca7ff045e895.e8811c95.webp",m=r.p+"static/image/adb244ad42dae7dd8e0e39fef5fe9b35.139d2cf9.webp",u=r.p+"static/image/4f5586ac11b281a40213b575a93c4718.c1769f07.webp",x=r.p+"static/image/51f910ebd1d6eaf737bbec15a0c381ec.52ff9938.webp",g=r.p+"static/image/c46d9b91f958c1328e6c0dd5c7640f6e.184ea0ad.webp",b=r.p+"static/image/77d131320f947469925ed1b3506db303.51341f4a.webp",I=r.p+"static/image/310cebc36bde5ba3528a2a078e2833ff.2f1daf6f.webp",w=r.p+"static/image/476ca733474e4d397b7833e8f5ce152c.38f23672.webp",v=r.p+"static/image/c9ed35f482c1440744e4a6c0faf8ac16.e87914e8.webp",A=r.p+"static/image/993540dd333bb5135fb21e02db652e22.6d63d1c6.webp",P=r.p+"static/image/a8d7acbfad546aac58dc912213c1ea1a.257706df.webp",S=r.p+"static/image/e5e025c5447eb870e4fb49db9f0132fc.2766de16.webp",y=r.p+"static/image/a34c5ab2a56823710112512d0bec1a2c.ad2b77a7.webp",G=r.p+"static/image/fd78084baca721889b5509903ff3a129.f714d8e5.webp",F=r.p+"static/image/7283ef6f99a595d2eba1bbce947a8257.7ed48fb3.webp",q=r.p+"static/image/194ce7a7cf161ceb5fb3e55cffe8ae31.9f0f11a1.webp",N=r.p+"static/image/b3ee91e2c978dcc9bbdda75494bc792f.036e5b48.webp",U=r.p+"static/image/4d7dc8c495c81d32bf108de3b56e3a47.5cc85b6c.webp",E=r.p+"static/image/a71c4533782264f29cd64bedb73cd217.3165b383.webp";function R(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,s.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"180-聊天室好友列表发送好友申请",children:["180. 聊天室：好友列表、发送好友申请",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#180-聊天室好友列表发送好友申请",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"用户模块的功能写完了，这节我们来实现添加好友、加入群聊的功能。"}),"\n",(0,i.jsx)(n.p,{children:"好友关系就是用户和用户的多对多关联，保存在好友关系表里。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"聊天室有专门的表，加入群聊就是往用户-聊天室的中间表插入一条记录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们先来实现好友关系的保存："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'model User {\n  id  Int @id @default(autoincrement())\n  username String @db.VarChar(50) @unique\n  password String @db.VarChar(50)\n  nickName String @db.VarChar(50)\n  email String @db.VarChar(50) @unique\n  headPic String @db.VarChar(100) @default("")\n  createTime DateTime @default(now())\n  updateTime DateTime @updatedAt\n\n  friends Friendship[] @relation("userToFriend")\n  inverseFriends Friendship[] @relation("friendToUser")\n}\n\nmodel Friendship {\n  user      User      @relation("userToFriend", fields: [userId], references: [id])\n  userId    Int\n\n  friend    User      @relation("friendToUser", fields: [friendId], references: [id])\n  friendId  Int\n\n  @@id([userId, friendId])\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"在 schema 里添加一个中间表 Friendship"}),"\n",(0,i.jsx)(n.p,{children:"它是 user 和 user 的多对多。"}),"\n",(0,i.jsx)(n.p,{children:"这种自身的多对多，需要在 User 的 model 里添加两个属性 friends、inverseFriends 来保存。"}),"\n",(0,i.jsx)(n.p,{children:"friends 是 user 的好友有哪些。"}),"\n",(0,i.jsx)(n.p,{children:"inverseFriends 是 user 是哪些人的好友。"}),"\n",(0,i.jsx)(n.p,{children:"执行 migrate dev 生成这个表："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npx prisma migrate dev --name friendship\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，生成的 sql 是对的："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"一个中间表，两个字段 userId、friendId 都是外键，引用 user 表的 id。"}),"\n",(0,i.jsx)(n.p,{children:"现在好友关系表里还没有数据："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们先注册几个用户："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"自己注册的时候可以先把验证码这段注释掉："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后手动在 friendship 表里加入几条好友关系："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"在 UserController 添加一个路由"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('friendship')\n@RequireLogin()\nasync friendship(@UserInfo('userId') userId: number) {\n    return this.userService.getFriendship(userId);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 UserService 实现下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async getFriendship(userId: number) {\n    const friends = await this.prismaService.friendship.findMany({\n        where: {\n            OR: [\n                {\n                    userId: userId\n                },\n                {\n                    friendId: userId\n                }\n            ] \n        }\n    });\n\n    const set = new Set<number>();\n    for(let i =0; i< friends.length; i++) {\n        set.add(friends[i].userId)\n        set.add(friends[i].friendId)\n    }\n\n    const friendIds = [...set].filter(item => item !== userId);\n\n    const res = [];\n\n    for(let i = 0; i< friendIds.length; i++) {\n        const user = await this.prismaService.user.findUnique({\n            where: {\n              id: friendIds[i],\n            },\n            select: {\n              id: true,\n              username: true,\n              nickName: true,\n              email: true\n            }\n        })\n        res.push(user)\n    }\n\n    return res\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们要查询 userId 或者 friendId 为当前用户的记录，把 id 去重并去掉籽身后，查询对应的用户信息。"}),"\n",(0,i.jsx)(n.p,{children:"也就是对方是我的好友、我是对方的好友，都算作互相是好友。"}),"\n",(0,i.jsx)(n.p,{children:"试一下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这就是好友列表的功能："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"而添加和删除好友就是在这个好友关系表里新增、删除数据。"}),"\n",(0,i.jsx)(n.p,{children:"但是并不是直接添加好友，而是需要先发一个申请，对方通过后才添加这条好友关系："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"创建下这个好友申请表："}),"\n",(0,i.jsx)(n.p,{children:"好友申请表 friend_request："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"生成这个表："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npx prisma migrate dev --name friend_request\n"})}),"\n",(0,i.jsx)(n.p,{children:"看下生成的 sql："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,i.jsx)(n.p,{children:"添加一个新的模块："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g resource friendship --no-spec\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"添加一个 /friendship/add 路由："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Body, Controller, Get, Post } from '@nestjs/common';\nimport { FriendshipService } from './friendship.service';\nimport { FriendAddDto } from './dto/friend-add.dto';\nimport { RequireLogin, UserInfo } from 'src/custom.decorator';\n\n@Controller('friendship')\nexport class FriendshipController {\n  constructor(private readonly friendshipService: FriendshipService) {}\n\n  @Post('add')\n  @RequireLogin()\n  async add(@Body() friendAddDto: FriendAddDto, @UserInfo(\"userId\") userId: number) {\n    return this.friendshipService.add(friendAddDto, userId);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"这个接口需要登录，然后 @UserInfo 取出 userId 传入。"}),"\n",(0,i.jsx)(n.p,{children:"创建 dto"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'import { IsNotEmpty } from "class-validator";\n\nexport class FriendAddDto {\n\n    @IsNotEmpty({\n        message: "添加的好友 id 不能为空"\n    })\n    friendId: number;\n\n    reason: string;    \n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"好友请求的理由可以不填。"}),"\n",(0,i.jsx)(n.p,{children:"然后写下 FriendshipService："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { FriendAddDto } from './dto/friend-add.dto';\nimport { Inject, Injectable } from '@nestjs/common';\nimport { PrismaService } from 'src/prisma/prisma.service';\n\n@Injectable()\nexport class FriendshipService {\n\n    @Inject(PrismaService)\n    private prismaService: PrismaService;\n\n    async add(friendAddDto: FriendAddDto, userId: number) {\n        return await this.prismaService.friendRequest.create({\n            data: {\n                fromUserId: userId,\n                toUserId: friendAddDto.friendId,\n                reason: friendAddDto.reason,\n                status: 0\n            }\n        })\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:"我们先注册一个新的用户："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后让 guang 向 xiaoqiang 发送好友申请："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"好友请求创建成功。"}),"\n",(0,i.jsx)(n.p,{children:"我们加一个好友请求列表接口："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Body, Controller, Get, Post } from '@nestjs/common';\nimport { FriendshipService } from './friendship.service';\nimport { FriendAddDto } from './dto/friend-add.dto';\nimport { RequireLogin, UserInfo } from 'src/custom.decorator';\n\n@Controller('friendship')\n@RequireLogin()\nexport class FriendshipController {\n  constructor(private readonly friendshipService: FriendshipService) {}\n\n  @Post('add')\n  async add(@Body() friendAddDto: FriendAddDto, @UserInfo(\"userId\") userId: number) {\n    return this.friendshipService.add(friendAddDto, userId);\n  }\n\n  @Get('request_list')\n  async list(@UserInfo(\"userId\") userId: number) {\n    return this.friendshipService.list(userId);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"这个接口也需要登录，我们把 @RequireLogin 加到 controller 上。"}),"\n",(0,i.jsx)(n.p,{children:"在 FriendshipService 实现这个方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async list(userId: number) {\n    return this.prismaService.friendRequest.findMany({\n        where: {\n            fromUserId: userId\n        }\n    })\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样就查询出了当前登录用户的所有好友申请。"}),"\n",(0,i.jsx)(n.p,{children:"然后加一下同意申请、拒绝申请的接口："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('agree/:id')\nasync agree(@Param('id') friendId: number, @UserInfo(\"userId\") userId: number) {\n    if(!friendId) {\n      throw new BadRequestException('添加的好友 id 不能为空');\n    }\n    return this.friendshipService.agree(friendId, userId);\n}\n\n@Get('reject/:id')\nasync reject(@Param('id') friendId: number, @UserInfo(\"userId\") userId: number) {\n    if(!friendId) {\n      throw new BadRequestException('添加的好友 id 不能为空');\n    }\n    return this.friendshipService.reject(friendId, userId);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 FriendshipService 里实现下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async agree(friendId: number, userId: number) {\n    await this.prismaService.friendRequest.updateMany({\n        where: {\n            fromUserId: friendId,\n            toUserId: userId,\n            status: 0\n        },\n        data: {\n            status: 1\n        }\n    })\n\n    const res = await this.prismaService.friendship.findMany({\n        where: {\n            userId,\n            friendId\n        }\n    })\n\n    if(!res.length) {\n            await this.prismaService.friendship.create({\n                data: {\n                    userId,\n                    friendId\n                }\n            })\n        }\n    return '添加成功'\n}\n\nasync reject(friendId: number, userId: number) {\n    await this.prismaService.friendRequest.updateMany({\n        where: {\n            fromUserId: friendId,\n            toUserId: userId,\n            status: 0\n        },\n        data: {\n            status: 2\n        }\n    })\n    return '已拒绝'\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"同意好友申请之后在 frinedship 好友关系表添加一条记录。"}),"\n",(0,i.jsx)(n.p,{children:"添加之前先查询下，如果已经有好友了，就不用添加了。"}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"再查询下好友请求列表："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，好友状态修改了。"}),"\n",(0,i.jsx)(n.p,{children:"然后查询下好友列表："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"guang 的好友列表多了一个叫小强的好友。"}),"\n",(0,i.jsx)(n.p,{children:"这样，添加好友功能就完成了。"}),"\n",(0,i.jsx)(n.p,{children:"不过这个好友列表接口不应该放在 user 模块，我们把它转移到 friendship 模块："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('list')\nasync friendship(@UserInfo('userId') userId: number) {\n    return this.friendshipService.getFriendship(userId);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"把之前 userService 的方法移到这里来："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"最后再来实现删除好友的功能："}),"\n",(0,i.jsx)(n.p,{children:"在 FriendshipController 添加一个路由："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('remove/:id')\nasync remove(@Param('id') friendId: number, @UserInfo('userId') userId: number) {\n    return this.friendshipService.remove(friendId, userId);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 service 实现下具体逻辑："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async remove(friendId: number, userId: number) {\n    await this.prismaService.friendship.deleteMany({\n        where: {\n            userId,\n            friendId,\n        }\n    })\n    return '删除成功';\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:c,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["代码在",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-backend",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"这节我们实现了好友列表和添加好友的功能。"}),"\n",(0,i.jsx)(n.p,{children:"好友关系就是用户和用户的多对多关系，需要一个中间表来保存。"}),"\n",(0,i.jsx)(n.p,{children:"好友列表就是根据当前用户 id 查询它的好友关系。"}),"\n",(0,i.jsx)(n.p,{children:"添加好友需要创建一个好友请求，状态为申请中，同意之后改为已同意，然后添加一条好友关系的记录。"}),"\n",(0,i.jsx)(n.p,{children:"删除好友的话就是删除好友关系表中对应的记录。"}),"\n",(0,i.jsx)(n.p,{children:"这样，好友功能就完成了。"})]})}function B(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(R,{...e})}):R(e)}let X=B;B.__RSPRESS_PAGE_META={},B.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F180.%20%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%9A%E5%A5%BD%E5%8F%8B%E5%88%97%E8%A1%A8%E3%80%81%E5%8F%91%E9%80%81%E5%A5%BD%E5%8F%8B%E7%94%B3%E8%AF%B7.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"180. 聊天室：好友列表、发送好友申请",headingTitle:"180. 聊天室：好友列表、发送好友申请",frontmatter:{}}}}]);