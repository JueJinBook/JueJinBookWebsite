"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["16919"],{681402:function(e,r,n){n.r(r),n.d(r,{default:()=>d});var s=n(552676),o=n(740453);function l(e){let r=Object.assign({h1:"h1",a:"a",p:"p",img:"img",code:"code",pre:"pre",h2:"h2",br:"br"},(0,o.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.h1,{id:"6第一次数据请求-2为用户处理模块增加-log-管理",children:["6第一次数据请求 2：为用户处理模块增加 log 管理",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#6第一次数据请求-2为用户处理模块增加-log-管理",children:"#"})]}),"\n",(0,s.jsx)(r.p,{children:"作为一个程序员，log 管理几乎是必备技能，本小节将在原来代码的基础上，增加 log 管理，以方便调试。进入 log 目录，并创建 users 目录。"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e7188017afcc?w=853&h=186&f=png&s=18537",alt:""}),"\r\n进入 ",(0,s.jsx)(r.code,{children:"users_views.py"}),"，导入 ",(0,s.jsx)(r.code,{children:"logging"})," 模块，并指定 log 目录文件（",(0,s.jsx)(r.code,{children:"log/users/users.log"}),"），指定 log 级别（",(0,s.jsx)(r.code,{children:"DEBUG"}),"）和 log 保留方式（这里设定按天保存，保留 30 天的 log 记录），并在处理方法中加入对应的 log 信息。"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e71ad3457ad9?w=534&h=588&f=png&s=38020",alt:""})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e71c8fccad36?w=475&h=394&f=png&s=24933",alt:""}),"\r\n",(0,s.jsx)(r.code,{children:"users_views.py"})," 的完整代码如下："]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-python",children:'#! /usr/bin/python3\r\n# -*- coding:utf-8 -*-\r\n\r\nimport tornado.web\r\nfrom tornado.escape import json_decode\r\nimport logging\r\nfrom logging.handlers import TimedRotatingFileHandler\r\n\r\n#从commons中导入http_response方法\r\nfrom common.commons import (\r\n    http_response,\r\n)\r\n\r\n#从配置文件中导入错误码\r\nfrom conf.base import (\r\n    ERROR_CODE,\r\n)\r\n \r\n\r\n########## Configure logging #############\r\nlogFilePath = "log/users/users.log"\r\nlogger = logging.getLogger("Users")  \r\nlogger.setLevel(logging.DEBUG)  \r\nhandler = TimedRotatingFileHandler(logFilePath,  \r\n                                   when="D",  \r\n                                   interval=1,  \r\n                                   backupCount=30)  \r\nformatter = logging.Formatter(\'%(asctime)s \\\r\n%(filename)s[line:%(lineno)d] %(levelname)s %(message)s\',)  \r\nhandler.suffix = "%Y%m%d"\r\nhandler.setFormatter(formatter)\r\nlogger.addHandler(handler)\r\n \r\n \r\nclass RegistHandle(tornado.web.RequestHandler):\r\n    """handle /user/regist request\r\n    :param phone: users sign up phone\r\n    :param password: users sign up password\r\n    :param code: users sign up code, must six digital code\r\n    """\r\n        \r\n    def post(self):\r\n        try:\r\n            #获取入参\r\n            args = json_decode(self.request.body)\r\n            phone = args[\'phone\']\r\n            password = args[\'password\']\r\n            verify_code = args[\'code\']\r\n        except:\r\n            #获取入参失败时，抛出错误码及错误信息\r\n            logger.info("RegistHandle: request argument incorrect")\r\n            http_response(self, ERROR_CODE[\'1001\'], 1001)\r\n            return \r\n            \r\n        #处理成功后，返回成功码“0”及成功信息“ok”\r\n        logger.debug("RegistHandle: regist successfully")\r\n        http_response(self, ERROR_CODE[\'0\'], 0)\n'})}),"\n",(0,s.jsxs)(r.p,{children:["再次执行 ",(0,s.jsx)(r.code,{children:"main.py"})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e7200615e2a4?w=998&h=169&f=png&s=25114",alt:""})}),"\n",(0,s.jsx)(r.p,{children:"HTTP 客户端发起正确的注册请求"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e721e89630dc?w=760&h=577&f=png&s=25499",alt:""})}),"\n",(0,s.jsxs)(r.p,{children:["查看 ",(0,s.jsx)(r.code,{children:"log/users/users.log"})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e723ba998464?w=1135&h=191&f=png&s=27275",alt:""})}),"\n",(0,s.jsxs)(r.p,{children:["在日志文件中，日志的格式包含时间、文件名、打印代码行数、log 级别和自定义 log 信息。这些信息足以满足问题定位及排错。在前面的配置信息中，我们定义的 log 级别是 ",(0,s.jsx)(r.code,{children:"DEBUG"}),"，下面看看入参出错时，报的 ",(0,s.jsx)(r.code,{children:"INFO"})," 日志。"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e72638e45fe7?w=745&h=568&f=png&s=25457",alt:""})}),"\n",(0,s.jsxs)(r.p,{children:["查看 ",(0,s.jsx)(r.code,{children:"log/users/users.log"})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e7283ad03005?w=1221&h=291&f=png&s=46000",alt:""})}),"\n",(0,s.jsxs)(r.p,{children:["这里看到日志文件中多出了一行日志，级别为 INFO。前面我们也提到，我们定义了日志文件的记录保留，本小册由于是新建讲解项目，还无法直接查看日志保留记录。这里贴出之前项目的记录，可以看到历史保留文件是以天为后缀的，当天的文件还是在 ",(0,s.jsx)(r.code,{children:"users.log"})," 中。"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:"https://user-gold-cdn.xitu.io/2018/4/7/1629e72a64423a2c?w=742&h=450&f=png&s=28047",alt:""})}),"\n",(0,s.jsxs)(r.h2,{id:"代码下载",children:["代码下载",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#代码下载",children:"#"})]}),"\n",(0,s.jsxs)(r.p,{children:["到目前为止，服务器端代码如下：",(0,s.jsx)(r.br,{}),"\n",(0,s.jsx)(r.a,{href:"https://github.com/Jawish185/demo7.git",target:"_blank",rel:"noopener noreferrer",children:"demo7"})]}),"\n",(0,s.jsxs)(r.h2,{id:"小结",children:["小结",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#小结",children:"#"})]}),"\n",(0,s.jsx)(r.p,{children:"本小节简单介绍了日志服务在服务器端开发中的应用，开发者可以自定义 log 级别及其历史保留记录。开发者可以根据自己的喜好及习惯，去定义具体的级别和信息。下一小节，我们将讲解如何利用 ORM 的方式和数据库打交道，并将用户注册信息写入数据库中。"})]})}function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,o.ah)(),e.components);return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}let d=i;i.__RSPRESS_PAGE_META={},i.__RSPRESS_PAGE_META["%E5%9F%BA%E4%BA%8E%20Python%20%E8%BD%BB%E6%9D%BE%E8%87%AA%E5%BB%BA%20App%20%E6%9C%8D%E5%8A%A1%E5%99%A8%2F6%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82%202%EF%BC%9A%E4%B8%BA%E7%94%A8%E6%88%B7%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97%E5%A2%9E%E5%8A%A0%20log%20%E7%AE%A1%E7%90%86.md"]={toc:[{text:"代码下载",id:"代码下载",depth:2},{text:"小结",id:"小结",depth:2}],title:"6第一次数据请求 2：为用户处理模块增加 log 管理",headingTitle:"6第一次数据请求 2：为用户处理模块增加 log 管理",frontmatter:{}}}}]);