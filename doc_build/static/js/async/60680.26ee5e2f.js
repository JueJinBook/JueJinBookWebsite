"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["60680"],{526654:function(n,e,s){s.r(e),s.d(e,{default:()=>T});var r=s(552676),c=s(740453);let i=s.p+"static/image/8dffb9e4e50ad9b27af8d9457822fc3f.1bdd298c.webp",l=s.p+"static/image/d981f3b125291352663b9a8985560fb0.d1ebbb68.webp",a=s.p+"static/image/9287d6b1716d0f0c4c3735d794fd8c0e.3690f833.webp",d=s.p+"static/image/c0eb00615e260916ca010acf747c03de.b2654fe9.webp",o=s.p+"static/image/0e1d7bb950e1f598e42f9f0946fdcb11.a52e06e7.webp",p=s.p+"static/image/b28c1ec2cd26796b55752b6d06923c21.913675be.webp",t=s.p+"static/image/24471620c6bf51abec372b81338ba784.eb57ac40.webp",j=s.p+"static/image/2799195fcae88cd829264cd2fada9c57.d0b7c504.webp",h=s.p+"static/image/84e6d522174cac20e9ff3a8bc535e779.dfb5a294.webp",x=s.p+"static/image/dfb3726dcf1e3b04f3deda9117c3f01e.c9b60950.webp",g=s.p+"static/image/d17032c3b8e412143728f51974a3c6d7.8ea544b0.webp",b=s.p+"static/image/1ee70ab934b56daaadf603d135cbba75.4f746fef.webp",f=s.p+"static/image/1432e4e4238d2d03f6ddc5b035f77fed.281cf0ad.webp",m=s.p+"static/image/699cbdce128c8843da23c0263d18e40a.20180b2d.webp",v=s.p+"static/image/b6bcff53923349de3737fcd23c8aa252.0d6ed246.webp",A=s.p+"static/image/1f4c1ad1a5402fcf6b50adbf093f8399.3cdfc573.webp",u=s.p+"static/image/b59aeaa85b62b84566de09e292eac2c0.a154d845.webp",N=s.p+"static/image/c6bf1d901d33cbb4fe899c54f28af0ee.ac116030.webp",w=s.p+"static/image/ebcbe019e8fc8748f8422b57a442b6dd.e3c9fa41.webp",P=s.p+"static/image/6b1465e6afdb2fab3f6c58a4fc3081e7.222dd3e1.webp",S=s.p+"static/image/e2a08eaf1b21d889006366d2412a1cb5.0cac8284.webp",G=s.p+"static/image/7b1fdd248f05f1ed32227a5a9272032f.9a4464c6.webp",E=s.p+"static/image/c14f0ba26f6f6c1dd97a516581504e78.92947bbc.webp";function C(n){let e=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",strong:"strong",h2:"h2"},(0,c.ah)(),n.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(e.h1,{id:"62-如何动态读取不同环境的配置",children:["62. 如何动态读取不同环境的配置？",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#62-如何动态读取不同环境的配置",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"连接数据库的时候，我们指定了用户名、密码："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"应用启动的时候，我们指定了端口："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"而这些其实都是可以变的，在代码里写死显然不太好。"}),"\n",(0,r.jsx)(e.p,{children:"能不能抽取出来放到配置文件里呢？"}),"\n",(0,r.jsx)(e.p,{children:"自然是可以的。"}),"\n",(0,r.jsx)(e.p,{children:"node 里最常用的是 .env 格式的配置文件，它有一个专门的 npm 包 dotenv。"}),"\n",(0,r.jsx)(e.p,{children:"我们创建个项目来试一下："}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)("img",{src:S,alt:""}),"\n进入这个目录，安装 dotenv："]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install dotenv\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后添加一个 .env 配置文件："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"aaa=1\nbbb=2\n"})}),"\n",(0,r.jsx)(e.p,{children:"在 index.js 里通过 dotenv 来加载："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"require('dotenv').config({\n    path: './.env',\n})\n\nconsole.log(process.env) \n"})}),"\n",(0,r.jsx)(e.p,{children:"node 执行下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"node index.js\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"他打印的环境变量里就包含了配置文件里的。"}),"\n",(0,r.jsx)(e.p,{children:"那如果我还有个生产环境的配置文件呢？"}),"\n",(0,r.jsx)(e.p,{children:"比如 .production.env"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"aaa=111\nbbb=222\n"})}),"\n",(0,r.jsx)(e.p,{children:"我们可以通过 NODE_ENVIRONMENT 环境变量来切换："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"require('dotenv').config({\n    path: process.env.NODE_ENVIRONMENT === 'production' ? '.production.env' : '.env',\n})\n\nconsole.log('aaa', process.env.aaa);\nconsole.log('bbb', process.env.bbb)\n"})}),"\n",(0,r.jsx)(e.p,{children:"生产环境设置 NODE_ENVIRONMENT 为 production，就可以切换到对应的配置了："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"如果你手动置顶了环境变量，那以手动指定的优先："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:N,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"此外，如果你想用 yaml 格式的配置文件也可以。"}),"\n",(0,r.jsx)(e.p,{children:"安装 js-yaml 包："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install js-yaml\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后添加一个 hello.yaml 配置文件："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"application:\n  host: 'localhost'\n  port: 8080\n\ndb:\n   mysql:\n    url: 'localhost'\n    port: 3306\n    database: 'aaa'\n    password: 'guang'\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后在 index2.js 里用一下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"const yaml = require('js-yaml');\nconst fs = require('fs');\n\nconst config = fs.readFileSync('./hello.yaml');\n\nconsole.log(yaml.load(config));\n"})}),"\n",(0,r.jsx)(e.p,{children:"跑一下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"可以看到，用对象的方式把 yaml 的配置给返回了。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"yaml 的格式更适合有层次关系的配置，而 .env 更适合简单的配置。"})}),"\n",(0,r.jsx)(e.p,{children:"同样，也可以通过 NODE_ENVIRMENT 环境变量来切换生产、开发的配置文件。"}),"\n",(0,r.jsx)(e.p,{children:"node 里的配置一般就用这两种方式。"}),"\n",(0,r.jsx)(e.p,{children:"那在 Nest 里怎么用呢？"}),"\n",(0,r.jsx)(e.p,{children:"其实上面的这两种配置方式，自己封装也不麻烦，封装个动态模块就好。"}),"\n",(0,r.jsx)(e.p,{children:"不过 Nest 提供了现成的封装：@nestjs/config"}),"\n",(0,r.jsx)(e.p,{children:"我们创建个 nest 项目来试下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"nest new nest-config-test -p npm\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"安装 @nestjs/config 包："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install --save @nestjs/config\n"})}),"\n",(0,r.jsx)(e.p,{children:"这个包同样是动态模块的方式，他有 forRoot 和 forFeature 两个方法。"}),"\n",(0,r.jsx)(e.p,{children:"我们在根目录加一个配置文件 .env："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"aaa=1\nbbb=2\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后在 AppModule 里面引入："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"然后在 AppController 里注入 ConfigService 来读取配置："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { Controller, Get, Inject } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Inject(ConfigService)\n  private configService: ConfigService;\n\n  @Get()\n  getHello() {\n    return {\n      aaa: this.configService.get('aaa'),\n      bbb: this.configService.get('bbb')\n    }\n  }\n}\n\n"})}),"\n",(0,r.jsx)(e.p,{children:"把 Nest 服务跑起来："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(e.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"可以看到，nest 读取到了 .env 里的配置。"}),"\n",(0,r.jsx)(e.p,{children:"如果有多个配置文件，比如还有个 .aaa.env："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"aaa=3\n"})}),"\n",(0,r.jsx)(e.p,{children:"在 AppModule 里面这样指定："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { ConfigModule } from '@nestjs/config';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport * as path from 'path';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      envFilePath: [path.join(process.cwd(), '.aaa.env'), path.join(process.cwd(), '.env')]\n    })\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(e.p,{children:"前面的配置会覆盖后面的配置。"}),"\n",(0,r.jsx)(e.p,{children:"重新跑一下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(e.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(e.p,{children:"可以看到 aaa 是 .aaa.env 里的，bbb 是 .env 里的。"}),"\n",(0,r.jsx)(e.p,{children:"那如果我嫌 .env 里配置不够灵活，想在 ts 文件里配置呢？"}),"\n",(0,r.jsx)(e.p,{children:"@nestjs/config 也是支持的。"}),"\n",(0,r.jsx)(e.p,{children:"我们写一个 config.ts："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"export default async () => {\n    const dbPort = await 3306;\n\n    return {\n        port: parseInt(process.env.PORT, 10) || 3000,\n        db: {\n          host: 'localhost',\n          port: dbPort\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"这里可以写异步逻辑。"}),"\n",(0,r.jsx)(e.p,{children:"然后引入下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"在 Controller 里取出来："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这样，你可以动态加载配置。"}),"\n",(0,r.jsx)(e.p,{children:"后面将讲微服务的时候，会讲到配置中心，比如 nacos、etcd 这种中间件，到时候配置就是动态获取的。"}),"\n",(0,r.jsx)(e.p,{children:"而且这个配置文件里，你完全可以自己实现 yaml 文件的加载。"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install js-yaml\n"})}),"\n",(0,r.jsx)(e.p,{children:"添加一个配置文件 aaa.yaml"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"application:\n  host: 'localhost'\n  port: 8080\n\naaa:\n   bbb:\n    ccc: 'ccc'\n    port: 3306\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后在 config2.ts 里加载下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { readFile } from 'fs/promises';\nimport * as yaml from 'js-yaml';\nimport { join } from 'path';\n\n\nexport default async () => {\n    const configFilePath = join(process.cwd(), 'aaa.yaml');\n\n    const config = await readFile(configFilePath, {\n        encoding: 'utf-8'\n    });\n\n    return yaml.load(config);\n};\n"})}),"\n",(0,r.jsx)(e.p,{children:"在 AppModule 引入："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"同样，前面覆盖后面的。"}),"\n",(0,r.jsx)(e.p,{children:"改下 Controller："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这样就正确读取了 yaml 配置。"}),"\n",(0,r.jsx)(e.p,{children:"同理，其他格式的配置也可以这样来自己解析。"}),"\n",(0,r.jsx)(e.p,{children:"此外，@nestjs/config 还提供了 forFeature 方法来返回动态模块。"}),"\n",(0,r.jsx)(e.p,{children:"如果别的模块也需要用到 config 咋办呢？"}),"\n",(0,r.jsx)(e.p,{children:"我们新建一个模块："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"nest g resource bbb --no-spec\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"在 BbbModule 里注入下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"跑起来你会发现报错了："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这个模块找不到 ConfigModule。"}),"\n",(0,r.jsx)(e.p,{children:"这时候把 ConfigModule.forRoot 注册为全局模块就好了："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这样就可以在 BbbModule 读取到配置了："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(e.p,{children:"此外，你还可以通过 ConfigModule.forFeautrue 来注册局部配置："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { BbbService } from './bbb.service';\nimport { BbbController } from './bbb.controller';\nimport { ConfigModule } from '@nestjs/config';\n\n@Module({\n  imports: [\n    ConfigModule.forFeature(() => {\n      return {\n        ddd: 222\n      }\n    })\n  ],\n  controllers: [BbbController],\n  providers: [BbbService]\n})\nexport class BbbModule {}\n"})}),"\n",(0,r.jsx)(e.p,{children:"BbbController 里读取下："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"@Get()\nfindAll() {\n    return {\n      ccc: this.configService.get('aaa.bbb.ccc'),\n      ddd: this.configService.get('ddd')\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"可以看到，Nest 读取到了这个局部注册的配置。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsxs)(e.p,{children:["这里是再次验证了",(0,r.jsx)(e.strong,{children:"动态模块的 forRoot 用于在 AppModule 里注册，一般指定为全局模块，forFeature 用于局部配置，在不同模块里 imports，而 register 用于一次性的配置。"})]}),"\n",(0,r.jsx)(e.p,{children:"比如 JwtModule.register、TypeOrmModule.ForRoot、TypeOrmModule.forFeature。"}),"\n",(0,r.jsx)(e.p,{children:"对动态模块不太理解的同学建议回过头去看看第 15 节。"}),"\n",(0,r.jsx)(e.p,{children:"最后我们简单看一下 @nestjs/config 的源码："}),"\n",(0,r.jsx)(e.p,{children:"先是 forFeature："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"动态返回模块定义，也就是 providers、exports 这些。"}),"\n",(0,r.jsx)(e.p,{children:"用 useFactory 动态创建了 provider，merge 了局部配置和全局配置。"}),"\n",(0,r.jsx)(e.p,{children:"然后是 forRoot："}),"\n",(0,r.jsx)(e.p,{children:"它就是根据 options 读取 env 配置，然后用 useFactory 创建 ConfigService 的 provider："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"之后动态返回模块定义："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"还是动态模块那些知识。"}),"\n",(0,r.jsx)(e.p,{children:"案例代码："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/config-test",target:"_blank",rel:"noopener noreferrer",children:"Node 读取 env、yaml 配置文件"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-config-test",target:"_blank",rel:"noopener noreferrer",children:"Nest 通过 Config 模块读取配置文件"})}),"\n",(0,r.jsxs)(e.h2,{id:"总结",children:["总结",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"这节我们学习了配置文件的使用方式，基于 dotenv、js-yaml 可以读取 .env 和 yaml 的配置文件。"}),"\n",(0,r.jsx)(e.p,{children:"我们可以通过 NODE_ENVIRONMENT 来切换不同路径的配置文件，实现开发、生产环境的配置切换。"}),"\n",(0,r.jsx)(e.p,{children:"Nest 提供了 @nestjs/config 包来封装，使用 ConfigModule.forRoot 可以读取 .env 配置文件，然后注入 ConfigService 来取配置。"}),"\n",(0,r.jsx)(e.p,{children:"还可以通过 ConfigModule.forFeature 来注册局部配置。"}),"\n",(0,r.jsx)(e.p,{children:"它的原理也很简单，就是通过 useFactory 动态产生 provider，然后在 forRoot、forFeature 里动态返回模块定义。"}),"\n",(0,r.jsx)(e.p,{children:"学习了 ConfigModule 之后，我们就可以把数据库连接信息、应用启动端口等抽离到配置文件了。"})]})}function k(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,c.ah)(),n.components);return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(C,{...n})}):C(n)}let T=k;k.__RSPRESS_PAGE_META={},k.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F62.%20%E5%A6%82%E4%BD%95%E5%8A%A8%E6%80%81%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"62. 如何动态读取不同环境的配置？",headingTitle:"62. 如何动态读取不同环境的配置？",frontmatter:{}}}}]);