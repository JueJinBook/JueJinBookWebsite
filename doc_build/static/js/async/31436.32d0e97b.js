"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["31436"],{564550:function(e,n,a){e.exports=a.p+"static/image/22864a4054f61b584911fa5aba34c8da.4477d1fb.webp"},553357:function(e,n,a){e.exports=a.p+"static/image/277ec33a456e2f0495db4db3f5bcbaa5.757ab994.webp"},86132:function(e,n,a){e.exports=a.p+"static/image/27cb39b89b01cdbd1184062d08e404cb.0b8691f6.webp"},209779:function(e,n,a){e.exports=a.p+"static/image/5397d219229d7cc6efc4511d843d628a.744bc76b.webp"},822507:function(e,n,a){e.exports=a.p+"static/image/6ec4ee7e450a6d04f7549ab2be619fea.ea51fcdf.webp"},751016:function(e,n,a){a.r(n),a.d(n,{default:()=>L});var s=a(552676),r=a(740453);let c=a.p+"static/image/a3ca58af9362511ee81497f4f791bee0.baef3c26.webp",d=a.p+"static/image/1674201d2d23e5997efd18c983b7f126.a3ecb434.webp",i=a.p+"static/image/d8a4515906192a9be9f1005aafc12276.ac5fa3fb.webp",t=a.p+"static/image/03b39035e53c5e8356bd4f4338b07132.27caae37.webp",l=a.p+"static/image/f0dd1d2950195bfb6e0dd63b91ad25b3.c85a31e5.webp",p=a.p+"static/image/6e7b2a8f3552b61e27bf297e6116ce0d.66fd1802.webp";var h=a(822507);let o=a.p+"static/image/a5bedd989f9f1552de178cabd5945339.93d9b29d.gif";var j=a(564550);let x=a.p+"static/image/4b40886750d83cd5ac0b88d223f17017.d6edf007.webp";var f=a(209779),b=a(553357);let g=a.p+"static/image/a7f2ebbd7a44076a068e7972eac15985.c5ebcc17.webp",m=a.p+"static/image/643d49885e2dec52ed13c86008a47177.075fb6bd.webp",u=a.p+"static/image/afaec19d7bf19979257567c7e19ece69.6412b7af.webp",w=a.p+"static/image/756d4aaae2ff1281b46b810b886f4d8c.44b76611.webp",E=a.p+"static/image/e4e66cb70661ea8517d41d64de45b5af.a9cb13ca.webp",k=a.p+"static/image/744d4c91758ab89b04cf16a0a428c8c1.c5ad3b0a.gif",S=a.p+"static/image/85abbdf2adebdb312e0efb671cf99eec.eb01734d.webp",A=a.p+"static/image/b69036b063d93a0ccf5cc0fd63c2adff.3aee98c6.gif",D=a.p+"static/image/869a077da27a4ca8b8ea49d4b29e2a59.f4ef5b4b.webp",N=a.p+"static/image/35cd13210c6fc775616112ae99463319.79b90646.gif",R=a.p+"static/image/7fafb5c3be4729fc62dbbb5f09bff69e.cd379312.webp";var B=a(86132);function v(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"101-大文件如何实现流式下载",children:["101. 大文件如何实现流式下载？",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#101-大文件如何实现流式下载",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"文件上传、文件下载都是常见的需求。"}),"\n",(0,s.jsx)(n.p,{children:"大文件上传我们会通过分片上传来优化。"}),"\n",(0,s.jsxs)(n.p,{children:["比如",(0,s.jsx)(n.a,{href:"https://help.aliyun.com/zh/oss/user-guide/multipart-upload",target:"_blank",rel:"noopener noreferrer",children:"阿里云 OSS 的大文件分片上传"}),"："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"那大文件下载如何优化呢？"}),"\n",(0,s.jsx)(n.p,{children:"答案也是分片下载，或者叫流式传输。"}),"\n",(0,s.jsx)(n.p,{children:"我们试一下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"nest new download-test\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"创建个 Nest 项目。"}),"\n",(0,s.jsx)(n.p,{children:"在 AppController 里添加个 download 的路由："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"import { Controller, Get, Res } from '@nestjs/common';\nimport { AppService } from './app.service';\nimport { Response } from 'express';\nimport * as fs from 'fs';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Get()\n  getHello(): string {\n    return this.appService.getHello();\n  }\n\n  @Get('download')\n  download(@Res() res: Response) {\n    const content = fs.readFileSync('package.json');\n\n    res.set('Content-Disposition', `attachment; filename=\"guang.json\"`);\n\n    res.end(content);\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,s.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到，触发了下载。"}),"\n",(0,s.jsx)(n.p,{children:"在 devtools 里可以看到正确设置了 header："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"header 通过 @Header 装饰器加也可以："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@Get('download')\n@Header('Content-Disposition', `attachment; filename=\"guang.json\"`)\ndownload(@Res() res: Response) {\n    const content = fs.readFileSync('package.json');\n\n    res.end(content);\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"效果一样。"}),"\n",(0,s.jsx)(n.p,{children:"但是，这样文件是全部读取出来返回，如果文件大了，比如好几个 G，会占用很大的内存。"}),"\n",(0,s.jsx)(n.p,{children:"当大文件下载的时候，能不能读出一部分返回一部分，也就是流式的下载呢？"}),"\n",(0,s.jsx)(n.p,{children:"可以的，http 有这个功能。"}),"\n",(0,s.jsx)(n.p,{children:"就是 transfer-encoding:chunked"}),"\n",(0,s.jsx)(n.p,{children:"这个是面试常考题。"}),"\n",(0,s.jsx)(n.p,{children:"从服务器下载一个文件的时候，如何知道文件下载完了呢？"}),"\n",(0,s.jsx)(n.p,{children:"有两种方式："}),"\n",(0,s.jsx)(n.p,{children:"一种是 header 里带上 Content-Length，浏览器下载到这个长度就结束。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"另一种是设置 transfer-encoding:chunked，它是不固定长度的，服务器不断返回内容，直到返回一个空的内容代表结束。"}),"\n",(0,s.jsx)(n.p,{children:"比如这样："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"5\nHello\n1\n,\n5\nWorld\n1\n!\n0\n"})}),"\n",(0,s.jsx)(n.p,{children:"这里分了 “Hello”  “,” “World”“!” 这 4 个块，长度分别为 5、1、5、1"}),"\n",(0,s.jsx)(n.p,{children:"最后以一个长度为 0 的块代表传输结束。"}),"\n",(0,s.jsx)(n.p,{children:"这样，不管内容多少都可以分块返回，就不用指定 Content-Length 了。"}),"\n",(0,s.jsx)(n.p,{children:"这就是大文件的流式传输的原理，就是 transfer-encoding:chunked。"}),"\n",(0,s.jsx)(n.p,{children:"然后我们在代码里实现下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@Get('download2')\n@Header('Content-Disposition', `attachment; filename=\"guang.json\"`)\ndownload2(@Res() res: Response) {\n    const stream = fs.createReadStream('package.json');\n\n    stream.pipe(res);\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"node 的 stream 本来就是分块读取内容的，这里配合流式返回数据很合适。"}),"\n",(0,s.jsx)(n.p,{children:"现在就不再返回 Content-Length 了，而是返回了 Transfer-Encoding:chunked："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这就是流式传输。"}),"\n",(0,s.jsx)(n.p,{children:"不过在 nest 里最好不要直接用 node 的 stream api。"}),"\n",(0,s.jsx)(n.p,{children:"因为它有很多事件，比如 data、error、end 等，自己处理还是挺麻烦的。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以直接用 Nest 封装的一个类 StreamableFile："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@Get('download3')\ndownload3() {\n    const stream = fs.createReadStream('package.json');\n\n    return new StreamableFile(stream, {\n      disposition: `attachment; filename=\"guang.json\"`\n    });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"试一下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"效果一样。"}),"\n",(0,s.jsx)(n.p,{children:"只是这里的 Content-Type 默认是 application/octet-stream 二进制流："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"你也可以改一下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@Get('download3')\ndownload3() {\n    const stream = fs.createReadStream('package.json');\n\n    return new StreamableFile(stream, {\n      type: 'text/plain',\n      disposition: `attachment; filename=\"guang.json\"`\n    });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样就实现了流式传输了。"}),"\n",(0,s.jsx)(n.p,{children:"相比大文件上传需要自己实现分片，大文件下载这个，浏览器和 http 内置了支持，直接指定对应 header 就行，自己不用做很多事情。"}),"\n",(0,s.jsx)(n.p,{children:"然后具体的 http 响应体是什么样的呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们用 wireshark 抓包看一下："}),"\n",(0,s.jsxs)(n.p,{children:["在 ",(0,s.jsx)(n.a,{href:"https://www.wireshark.org/",target:"_blank",rel:"noopener noreferrer",children:"wireshark 官网"}),"下载安装包："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"安装后把它跑起来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"选择 loopback 这个网卡，本地回环地址，可以抓到 localhost 的包："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"输入过滤器 port 3000，也就是过滤 3000 端口的数据包。"}),"\n",(0,s.jsx)(n.p,{children:"然后回车就会进入抓包界面："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["这时候再访问下 ",(0,s.jsx)(n.a,{href:"http://localhost:3000/download3",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/download3"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到抓到了几个 tcp 的包："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这两个分别是请求和响应："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["如果多了找不到，点一下 protocal 会排序：\n",(0,s.jsx)("img",{src:l,alt:""})]}),"\n",(0,s.jsx)(n.p,{children:"可以看到，确实是分块传输的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这里有一个数据块，然后一个空块结尾。"}),"\n",(0,s.jsxs)(n.p,{children:["再访问下 ",(0,s.jsx)(n.a,{href:"http://localhost:3000/download",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/download"})," 接口对比下："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"和上面的对比下，这就是没有分块的响应。"}),"\n",(0,s.jsx)(n.p,{children:"当然，现在的文件比较小，可以找一个大一点的文件试一下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到，现在分片就多了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"大概是 65536 一个分块，也就是 64k。"}),"\n",(0,s.jsx)(n.p,{children:"每个分块都有 chunk size 和 chunk data："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:c,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"确实是分块了。"}),"\n",(0,s.jsxs)(n.p,{children:["案例代码上传了 ",(0,s.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/download-test",target:"_blank",rel:"noopener noreferrer",children:"Nest 小册仓库"}),"。"]}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"大文件上传的优化是分片上传，大文件下载的优化是分片下载。"}),"\n",(0,s.jsx)(n.p,{children:"只不过这个分片下载 http 帮你做了，你只要指定 transfer-encoding:chunked 就行，也叫流式传输。"}),"\n",(0,s.jsx)(n.p,{children:"在 Nest 里可以用 fs.createReadStream 获取文件流，然后返回 StreamableFile 的对象就可以了。"}),"\n",(0,s.jsx)(n.p,{children:"返回的响应就是流式的，我们通过 wireshark 抓包证实了这点。"}),"\n",(0,s.jsx)(n.p,{children:"每个分块都有 chunk size、chunk data 的信息。"}),"\n",(0,s.jsx)(n.p,{children:"以后面试官再问你大文件下载优化或者问 transfer-encoding:chunked，你就可以大胆的说你用 wireshark 抓包验证过了。"})]})}function F(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(v,{...e})}):v(e)}let L=F;F.__RSPRESS_PAGE_META={},F.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F101.%20%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E4%B8%8B%E8%BD%BD%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"101. 大文件如何实现流式下载？",headingTitle:"101. 大文件如何实现流式下载？",frontmatter:{}}}}]);