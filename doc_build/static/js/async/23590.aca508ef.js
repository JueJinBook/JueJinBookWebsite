"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["23590"],{564550:function(e,n,s){e.exports=s.p+"static/image/22864a4054f61b584911fa5aba34c8da.4477d1fb.webp"},553357:function(e,n,s){e.exports=s.p+"static/image/277ec33a456e2f0495db4db3f5bcbaa5.757ab994.webp"},209779:function(e,n,s){e.exports=s.p+"static/image/5397d219229d7cc6efc4511d843d628a.744bc76b.webp"},822507:function(e,n,s){e.exports=s.p+"static/image/6ec4ee7e450a6d04f7549ab2be619fea.ea51fcdf.webp"},67210:function(e,n,s){s.r(n),s.d(n,{default:()=>O});var r=s(552676),c=s(740453);let t=s.p+"static/image/2bfa9571d786ad2306dbc30e4109dd46.2fd8274d.webp",i=s.p+"static/image/9b4dc698cd9ef3bdfb008cf9d6c15190.7e65bab0.webp",a=s.p+"static/image/4c7f87e8b6a3f65e5f98af2dbf59330c.007e91c7.webp";var p=s(822507),l=s(564550);let d=s.p+"static/image/a1732dc679c3bfcab9edcc5b7ad7b09a.ca08e91f.webp";var h=s(209779),j=s(553357);let x=s.p+"static/image/4f8319a2fd2c647726b953aa60d1f3e9.bc2d612f.webp",o=s.p+"static/image/d878915fb1297027206f74cf951b3bf3.6078cb78.webp",m=s.p+"static/image/195ff772456a15e929f626319bc5e621.1d935dee.webp",A=s.p+"static/image/6045cdae29f91f4739934bac3f86c08d.6e7bf300.webp",f=s.p+"static/image/5a92f65ad235adf0e7c2d548b4c02c88.dadd1411.webp",b=s.p+"static/image/65db06d97c5f228ea075a39996d2df2a.eabcb49d.webp",u=s.p+"static/image/e868c496144bcd0c156ca8890507cdc9.aec7b07a.webp",g=s.p+"static/image/cf33122225bfc89a286baeb285b8e9fe.6d8336b7.webp",w=s.p+"static/image/98dcd895a3faa12720060fc6d67bb7e8.3cc61117.webp",v=s.p+"static/image/3a3ae98d40c89dfb37c9ca92f950f7fc.64652796.webp",S=s.p+"static/image/d0ef98b90dfab3cefb8e0f88a83ce643.0292c0cf.webp",k=s.p+"static/image/4b3ad9c1e04f8a85b48742f2becf332e.a51b070f.webp",C=s.p+"static/image/99c9a1e7ab58c49e8443119a10906c41.b00f0c4c.webp",G=s.p+"static/image/7d329bc16d63996b0e371ed80c4c292c.204254f3.webp",L=s.p+"static/image/d42ece52763ea623b006efc8c15484c7.e93f414b.webp",M=s.p+"static/image/f6cc80c3d8c6fb47439080eed68b95fc.3e5372eb.webp",W=s.p+"static/image/8550629bde83ac7fe5ea5c2f846d73d9.e4481659.webp",P=s.p+"static/image/8739364ba278366b6677bc5045a8adf9.4aec9033.webp",B=s.p+"static/image/b57727d3980911510ee3bdee1602f716.b9208f88.webp",F=s.p+"static/image/6e7c40b8b2d2cdab9df8a4a6ff643277.88481944.webp";function T(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",ul:"ul",li:"li",h2:"h2"},(0,c.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"140-nest-如何创建微服务",children:["140. Nest 如何创建微服务？",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#140-nest-如何创建微服务",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"前面我们写了很多 Http 服务了，这些服务都是单体架构的。"}),"\n",(0,r.jsx)(n.p,{children:"单体架构就是所有业务逻辑都在一个服务里实现。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样有个问题："}),"\n",(0,r.jsx)(n.p,{children:"项目越来越大之后，模块越来越多，代码会越来越难以维护。"}),"\n",(0,r.jsx)(n.p,{children:"并且因为代码都在一个项目里，不好扩展。比如有的业务模块想多部署几个节点就做不到，只能整体扩展。"}),"\n",(0,r.jsx)(n.p,{children:"所以就有了拆分的需求，把业务模块拆成单独的微服务："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"拆分也很简单，就是把之前放在不同目录的业务模块放到不同的服务里，再加上通信就好了。"}),"\n",(0,r.jsx)(n.p,{children:"不过微服务和微服务之间一般不是用 http 来通信的。"}),"\n",(0,r.jsx)(n.p,{children:"为什么呢？"}),"\n",(0,r.jsx)(n.p,{children:"因为 http 的请求响应会携带大量的 header："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这些增大了通信的开销。"}),"\n",(0,r.jsx)(n.p,{children:"所以服务和服务之间没必要用 http，直接用 tcp 就好了。"}),"\n",(0,r.jsx)(n.p,{children:"nest 里实现微服务以及之间的 tcp 通信也很简单，下面我们来写一下。"}),"\n",(0,r.jsx)(n.p,{children:"创建个 nest 项目:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new microservice-test-main\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:W,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再创建一个："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new microservice-test-user\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"前面那个作为 http 服务向外提供接口，后面这个是微服务，提供 tcp 的微服务通信端口。"}),"\n",(0,r.jsx)(n.p,{children:"进入 microservice-test-user"}),"\n",(0,r.jsx)(n.p,{children:"安装微服务的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install @nestjs/microservices --save\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后修改下应用启动方式："}),"\n",(0,r.jsx)(n.p,{children:"之前这个是启动 http 服务的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"微服务不需要暴露 http 接口，只需要支持微服务的通信就行。"}),"\n",(0,r.jsx)(n.p,{children:"改成这样："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { Transport, MicroserviceOptions } from '@nestjs/microservices';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.createMicroservice<MicroserviceOptions>(\n    AppModule,\n    {\n      transport: Transport.TCP,\n      options: {\n        port: 8888,\n      },\n    },\n  );\n  app.listen();\n}\nbootstrap();\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这就是启动一个微服务，通信端口在 8888，用 TCP 方式通信。"}),"\n",(0,r.jsx)(n.p,{children:"然后暴露个方法出去。"}),"\n",(0,r.jsx)(n.p,{children:"这里暴露接口不再是 http 时的 @Get、@Post 了，而是这样："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@MessagePattern('sum')\nsum(numArr: Array<number>): number {\n    return numArr.reduce((total, item) => total + item, 0);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"很容易理解，就是消息匹配什么模式，然后调用这个方法，处理参数，返回结果。"}),"\n",(0,r.jsx)(n.p,{children:"我们接收一个数字数组，返回所有数字的和。"}),"\n",(0,r.jsx)(n.p,{children:"这样，我们就创建了一个微服务："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 microservice-test-main 这个服务里连上它。"}),"\n",(0,r.jsx)(n.p,{children:"进入 microservice-test-main"}),"\n",(0,r.jsx)(n.p,{children:"安装微服务相关的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install @nestjs/microservices --save\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后做什么呢？"}),"\n",(0,r.jsx)(n.p,{children:"很明显，要引入连接微服务的客户端。"}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 引入 ClientsModule 动态模块："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"ClientsModule 的动态模块有 register、registerAsync 方法。"}),"\n",(0,r.jsx)(n.p,{children:"我们之前用过的 JwtModule 也是 register、registerAsync，这是动态模块的方法名规范。（忘记的同学回过头看下动态模块那一节）"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { ClientsModule, Transport } from '@nestjs/microservices';\n\n@Module({\n  imports: [\n    ClientsModule.register([\n      {\n        name: 'USER_SERVICE',\n        transport: Transport.TCP,\n        options: {\n          port: 8888,\n        },\n      },\n    ])\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里的 register 参数是一个数组，也就是说你有多个微服务的时候，都依次写在这里就行。"}),"\n",(0,r.jsx)(n.p,{children:"引入了 ClientsModule 模块，就可以注入其中的 provider 来用了。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject('USER_SERVICE')\nprivate userClient: ClientProxy;\n\n@Get('sum')\ncalc(@Query('num') str) {\n    const numArr = str.split(',').map((item) => parseInt(item));\n\n    return this.userClient.send('sum', numArr);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"注入的时候指定 token 为前面我们声明的微服务名字："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"注入的对象就是连接这个微服务的客户端代理："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"调用它的 send 方法，第一个是消息的名字，第二个是参数。"}),"\n",(0,r.jsx)(n.p,{children:"这里的 sum 就是微服务那边声明的这个消息，而参数就是那边声明的参数:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"把两个服务都跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:"微服务那边跑起来的提示是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"http 服务跑起来的提示是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["然后浏览器访问下 ",(0,r.jsx)(n.a,{href:"http://localhost:3000/sum?num=3,5,6%EF%BC%9A",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/sum?num=3,5,6："})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"返回了 14，是 3 + 5 + 6 的结果。"}),"\n",(0,r.jsx)(n.p,{children:"浏览器把 3、5、6 的参数传递给 http 服务，然后它给微服务发送消息，把参数带过去，微服务计算后返回了 14 给 http 服务，它再返回给浏览器："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"前面在微服务里是用 @MessagePattern 声明的要处理的消息。"}),"\n",(0,r.jsx)(n.p,{children:"如果并不需要返回消息的话，可以用 @EventPattern 声明："}),"\n",(0,r.jsx)(n.p,{children:"比如我们在 microservice-test-user 的 AppController 再添加一个方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@EventPattern('log')\nlog(str: string) {\n    console.log(str);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 microservice-test-main 里调用下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"this.userClient.emit('log', '求和')\n"})}),"\n",(0,r.jsx)(n.p,{children:"注意，如果那边是 @MessagePattern 声明的方法，这边要用 send 方法调用。而 @EventPattern 声明的方法，这边要用 emit 方法调用。"}),"\n",(0,r.jsx)(n.p,{children:"测试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，微服务收到了这边发送的消息，并打印了日志。"}),"\n",(0,r.jsx)(n.p,{children:"那微服务之间具体传输了什么消息呢？我们抓包看一下。"}),"\n",(0,r.jsx)(n.p,{children:"想抓 tcp 层的包需要用到 wireshark。"}),"\n",(0,r.jsxs)(n.p,{children:["在 ",(0,r.jsx)(n.a,{href:"https://www.wireshark.org/",target:"_blank",rel:"noopener noreferrer",children:"wireshark 官网"}),"下载安装包："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"安装后把它跑起来："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"选择 loopback 这个网卡，本地回环地址，可以抓到 localhost 的包："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"输入过滤器 port 8888，也就是过滤 8888 端口的数据包。"}),"\n",(0,r.jsx)(n.p,{children:"然后回车就会进入抓包界面："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["这时候再访问下 ",(0,r.jsx)(n.a,{href:"http://localhost:3000/sum?num=1,2,3",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/sum?num=1,2,3"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到抓到了几个 tcp 的包："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"点开这几个 PSH 的包看一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"内容如下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{"pattern": "log", "data": "求和"}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{"pattern": "sum", data: [1, 2, 3], "id": "3b4a92305a76109bf0e79"}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{"response": 6, "isDisposed": true, "id": "3b4a92305a76109bf0e79"}\n'})}),"\n",(0,r.jsx)(n.p,{children:"前两个是主服务发送给微服务的，后面那个是微服务返回的。"}),"\n",(0,r.jsx)(n.p,{children:"从抓包我们可以得出结论："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"微服务之间的 tcp 通信的消息格式是 json"}),"\n",(0,r.jsx)(n.li,{children:"如果是 message 的方式，需要两边各发送一个 tcp 包，也就是一问一答的方式"}),"\n",(0,r.jsx)(n.li,{children:"如果是 event 的方式，只需要客户端发送一个 tcp 的包"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"案例代码在小册仓库："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/microservice-test-main",target:"_blank",rel:"noopener noreferrer",children:"microservice-test-main"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/microservice-test-user",target:"_blank",rel:"noopener noreferrer",children:"microservice-test-user"})}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"之前我们一直写的都是单体的 http 服务，这样项目大了以后会难以维护和扩展。"}),"\n",(0,r.jsx)(n.p,{children:"这时候可以通过微服务的方式把业务逻辑拆分到不同的微服务里。"}),"\n",(0,r.jsx)(n.p,{children:"微服务之间通过 tcp 方式通信，在 nest 里需要用到 @nestjs/microservices 这个包。"}),"\n",(0,r.jsx)(n.p,{children:"微服务启动的时候不再调用 NestFactory.create 而是调用 NestFactory.createMicroservice 方法，指定 tcp 的端口。"}),"\n",(0,r.jsx)(n.p,{children:"然后另一个服务里通过 ClientsModule 来注入连接这个微服务的代理对象。"}),"\n",(0,r.jsx)(n.p,{children:"之后分别用 send、emit 方法来调用微服务的 @MessagePattern、@EventPattern 声明的方法。"}),"\n",(0,r.jsx)(n.p,{children:"这就是微服务的创建和通信方式。"}),"\n",(0,r.jsx)(n.p,{children:"我们还通过 wireshark 抓包分析了 tcp 通信的内容，发现微服务之间的通信是基于 json 的。"}),"\n",(0,r.jsx)(n.p,{children:"项目大了之后，为了维护和扩展方便，拆分微服务是很自然的事情。"})]})}function D(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(T,{...e})}):T(e)}let O=D;D.__RSPRESS_PAGE_META={},D.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F140.%20Nest%20%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"140. Nest 如何创建微服务？",headingTitle:"140. Nest 如何创建微服务？",frontmatter:{}}}}]);