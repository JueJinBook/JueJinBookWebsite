"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["38344"],{855318:function(e,n,r){r.r(n),r.d(n,{default:()=>C});var t=r(552676),c=r(740453);let s=r.p+"static/image/c60022d52732afa9c68be2ab9131ba80.6f6ed23a.webp",a=r.p+"static/image/e3d875bbec3bb01df9236fd186ed5080.92fadf77.webp",i=r.p+"static/image/8a7cfe771eaa23cc9666b0720334058c.33895ec7.webp",p=r.p+"static/image/f517616919627367b77266198cd0e191.6efd0df5.webp",l=r.p+"static/image/a892ddb056a832b0fc8e1dd237d3c379.4f85fe4a.webp",o=r.p+"static/image/47733bc5920c08464566b8aaec15d041.5be2b694.webp",d=r.p+"static/image/b8c37f93d85f17d679553ce23ec52003.ae6aaf1b.webp",x=r.p+"static/image/2b21261810ff3ebf4a951fca823bb94a.2913490f.webp",j=r.p+"static/image/00fd0f25cf37e630357711d42c39f034.d2565a7c.webp",h=r.p+"static/image/87b398b25f5732065c3218beda91acf1.9969829e.webp",m=r.p+"static/image/ac9ebdc60d9faef6270d57b7a9417284.24d3bcc3.webp",b=r.p+"static/image/77455e7496658c890d4ed3a3a1977480.2235593c.webp",g=r.p+"static/image/f5a4142d24843661f516cb62aab546aa.90f6021a.webp",f=r.p+"static/image/690295930ebc51ebdc800c622a685a6c.6bf8a7a4.webp",u=r.p+"static/image/0d71837284f782ed367a95dcc0e7042e.2ecc5e63.webp",A=r.p+"static/image/cef2cc07293f4c58a001e340b228515e.9611fb4b.webp",N=r.p+"static/image/23398b6263eccdb9ae468bbddad5533c.a323dab3.webp",E=r.p+"static/image/6766eecb1a0be04931ee910bbdd86be0.f8833a8b.webp",S=r.p+"static/image/661c0c1bf62be1e261ec6cb0576b3505.f78920ff.webp",w=r.p+"static/image/4b02a15496f05550da5eff8b49cbe3f6.7a1be827.webp",v=r.p+"static/image/ad5e8e7959912aa05c865fed5fe7257e.43fe7792.webp",M=r.p+"static/image/4cf39a9f8a22122bd9a41a26f2c8ae73.46d2a216.webp",I=r.p+"static/image/2953e790d96ae54c3b4c365d952a8d90.d5746c78.webp",P=r.p+"static/image/bc735ea986d76de17ecd9473100ef953.027e4692.webp",B=r.p+"static/image/0cb35563e094d2ddbf0d4effaeb021c8.0c93711a.webp";function J(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2",ul:"ul",li:"li"},(0,c.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.h1,{id:"19-rxjs-和-interceptor",children:["19. RxJS 和 Interceptor",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#19-rxjs-和-interceptor",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"RxJS 是一个组织异步逻辑的库，它有很多 operator，可以极大的简化异步逻辑的编写。"}),"\n",(0,t.jsx)(n.p,{children:"它是由数据源产生数据，经过一系列 operator 的处理，最后传给接收者。"}),"\n",(0,t.jsx)(n.p,{children:"这个数据源叫做 observable。"}),"\n",(0,t.jsx)(n.p,{children:"比如这样："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { of, filter, map } from 'rxjs';\n\nof(1, 2, 3)\n.pipe(map((x) => x * x))\n.pipe(filter((x) => x % 2 !== 0))\n.subscribe((v) => console.log(`value: ${v}`));\n"})}),"\n",(0,t.jsx)(n.p,{children:"用 node 跑一下，结果如下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:B,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这里 node 能直接解析 esm 需要在 package.json 里设置 type 为 module："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:P,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这就是 map、filter 的 operator 的作用。"}),"\n",(0,t.jsx)(n.p,{children:"还是很容易理解的。"}),"\n",(0,t.jsx)(n.p,{children:"有同学说，这样的逻辑自己写也行呀。"}),"\n",(0,t.jsx)(n.p,{children:"那这种呢："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { of, scan, map } from 'rxjs';\n\nconst numbers$ = of(1, 2, 3);\n\nnumbers$\n  .pipe(\n    scan((total, n) => total + n),\n    map((sum, index) => sum / (index + 1))\n  )\n  .subscribe(console.log);\n"})}),"\n",(0,t.jsx)(n.p,{children:"scan 是计数，map 是转换，结果如下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"或者是节流、防抖："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { fromEvent, throttleTime } from 'rxjs';\n\nconst clicks = fromEvent(document, 'click');\nconst result = clicks.pipe(throttleTime(1000));\n\nresult.subscribe(x => console.log(x));\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { fromEvent, debounceTime } from 'rxjs';\n\nconst clicks = fromEvent(document, 'click');\nconst result = clicks.pipe(debounceTime(1000));\nresult.subscribe(x => console.log(x));\n"})}),"\n",(0,t.jsx)(n.p,{children:"有同学说，这些逻辑都很简单呀，完全可以自己写。"}),"\n",(0,t.jsx)(n.p,{children:"没错，一般异步逻辑自己写也行。"}),"\n",(0,t.jsx)(n.p,{children:"但是架不住 RxJS 的 operator 多呀，组合起来可以实现非常复杂的异步逻辑处理。"}),"\n",(0,t.jsxs)(n.p,{children:["可以在官网文档看到",(0,t.jsx)(n.a,{href:"https://rxjs.dev/guide/operators#creation-operators-1",target:"_blank",rel:"noopener noreferrer",children:"所有的 operator"}),"。"]}),"\n",(0,t.jsx)(n.p,{children:"所以说，如果异步逻辑复杂度高了，那上 RxJS 收益还是很高的，异步逻辑的编写就变成了 operator 的组合，少写很多代码。"}),"\n",(0,t.jsx)(n.p,{children:"感受到为啥要用 RxJS 了么？"}),"\n",(0,t.jsx)(n.p,{children:"也是因为这个原因，Nest 的 interceptor 集成了 RxJS，可以用它来处理响应。"}),"\n",(0,t.jsx)(n.p,{children:"当然，也有人觉得这里没必要用 RxJS。"}),"\n",(0,t.jsx)(n.p,{children:"但既然 Nest 支持了，我们就用用看，基于那一堆 operator 确实是能简化异步逻辑的。"}),"\n",(0,t.jsx)(n.p,{children:"创建一个测试项目："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest new interceptor-test -p npm\n"})}),"\n",(0,t.jsx)(n.p,{children:"进入目录执行 nest g interceptor："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g interceptor aaa --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"我们可以这样实现接口耗时统计："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common';\nimport { Observable, tap } from 'rxjs';\n\n@Injectable()\nexport class AaaInterceptor implements NestInterceptor {\n\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    const now = Date.now();\n    return next\n      .handle()\n      .pipe(\n        tap(() => console.log(`After... ${Date.now() - now}ms`)),\n      );\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"tap operator 不会改变数据，只是额外执行一段逻辑。"}),"\n",(0,t.jsx)(n.p,{children:"在 handler 上启用 interceptor："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:I,alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["然后浏览器访问 ",(0,t.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"就会看到打印的耗时数据："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:M,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"或者全局启用这个 interceptor："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:v,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"路由级别和全局级别的 interceptor 还是有区别的，路由级别的可以注入依赖，而全局的不行："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:w,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:S,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们再来使用下别的 RxJS operator："}),"\n",(0,t.jsx)(n.p,{children:"其实适合在 Nest 的 interceptor 里用的 operator 还真不多，也就这么几个："}),"\n",(0,t.jsxs)(n.h2,{id:"map",children:["map",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#map",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"再生成一个 interceptor："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g interceptor map-test --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"使用 map operator 来对 controller 返回的数据做一些修改："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common';\nimport { map, Observable } from 'rxjs';\n\n@Injectable()\nexport class MapTestInterceptor implements NestInterceptor {\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    return next.handle().pipe(map(data => {\n      return {\n        code: 200,\n        message: 'success',\n        data\n      }\n    }))\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 controller 里引入下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:E,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"跑下试试："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:N,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"现在返回的数据就变成了这样。"}),"\n",(0,t.jsx)(n.p,{children:"map 算是在 nest interceptor 里必用的 rxjs operator 了"}),"\n",(0,t.jsxs)(n.h2,{id:"tap",children:["tap",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#tap",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"再生成个 interceptor"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g interceptor tap-test --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"使用 tap operator 来添加一些日志、缓存等逻辑："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { AppService } from './app.service';\nimport { CallHandler, ExecutionContext, Injectable, Logger, NestInterceptor } from '@nestjs/common';\nimport { Observable, tap } from 'rxjs';\n\n@Injectable()\nexport class TapTestInterceptor implements NestInterceptor {\n  constructor(private appService: AppService) {}\n\n  private readonly logger = new Logger(TapTestInterceptor.name);\n\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    return next.handle().pipe(tap((data) => {\n      \n      // 这里是更新缓存的操作，这里模拟下\n      this.appService.getHello();\n\n      this.logger.log(`log something`, data);\n    }))\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"因为还没讲到缓存那块，这里就调用 service 方法模拟了下。"}),"\n",(0,t.jsx)(n.p,{children:"日志记录我们用的 nest 内置的 Logger，在 controller 返回响应的时候记录一些东西。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:A,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"浏览器访问这个接口，会打印日志："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:u,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这里我们用的是 Nest 内置的 Logger，所以打印格式是这样的。"}),"\n",(0,t.jsxs)(n.h2,{id:"catcherror",children:["catchError",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#catcherror",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"controller 里很可能会抛出错误，这些错误会被 exception filter 处理，返回不同的响应，但在那之前，我们可以在 interceptor 里先处理下。"}),"\n",(0,t.jsx)(n.p,{children:"生成 interceptor："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g interceptor catch-error-test --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"使用 catchError 处理抛出的异常："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CallHandler, ExecutionContext, Injectable, Logger, NestInterceptor } from '@nestjs/common';\nimport { catchError, Observable, throwError } from 'rxjs';\n\n@Injectable()\nexport class CatchErrorTestInterceptor implements NestInterceptor {\n  private readonly logger = new Logger(CatchErrorTestInterceptor.name)\n\n  intercept (context: ExecutionContext, next: CallHandler): Observable<any> {\n    return next.handle().pipe(catchError(err => {\n      this.logger.error(err.message, err.stack)\n      return throwError(() => err)\n    }))\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"这里我们就是日志记录了一下，当然你也可以改成另一种错误，重新 throwError。"}),"\n",(0,t.jsx)(n.p,{children:"在 controller 里用一下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:f,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"浏览器访问下，可以看到返回 500 的错误："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"打印了两次错误："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:g,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"一次是我们在 interceptor 里打印的，一次是 exception filter 打印的。"}),"\n",(0,t.jsx)(n.p,{children:"其实我们能看到这个 500 错误，就是内置的 exception filter 处理的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"对应的 Nest 源码如下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:m,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:h,alt:""})}),"\n",(0,t.jsxs)(n.h2,{id:"timeout",children:["timeout",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#timeout",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"接口如果长时间没返回，要给用户一个接口超时的响应，这时候就可以用 timeout operator。"}),"\n",(0,t.jsx)(n.p,{children:"我们再创建个 nest interceptor"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g interceptor timeout --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"添加如下逻辑："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CallHandler, ExecutionContext, Injectable, NestInterceptor, RequestTimeoutException } from '@nestjs/common';\nimport { catchError, Observable, throwError, timeout, TimeoutError } from 'rxjs';\n\n@Injectable()\nexport class TimeoutInterceptor implements NestInterceptor {\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    return next.handle().pipe(\n      timeout(3000),\n      catchError(err => {\n        if(err instanceof TimeoutError) {\n          console.log(err);\n          return throwError(() => new RequestTimeoutException());\n        }\n        return throwError(() => err);\n      })\n    )\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"timeout 操作符会在 3s 没收到消息的时候抛一个 TimeoutError。"}),"\n",(0,t.jsx)(n.p,{children:"然后用 catchError 操作符处理下，如果是 TimeoutError，就返回 RequestTimeoutException，这个有内置的 exception filter 会处理成对应的响应格式。"}),"\n",(0,t.jsx)(n.p,{children:"其余错误就直接 throwError 抛出去。"}),"\n",(0,t.jsx)(n.p,{children:"在 controller 里用一下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:j,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"浏览器访问，3s 后返回 408 响应："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"就是在这里处理的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:d,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"不信可以抛一个其他的 exception 试一下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:o,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:l,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"最后，再来看下全局的 interceptor："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:p,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"因为这种是手动 new 的，没法注入依赖。"}),"\n",(0,t.jsx)(n.p,{children:"但很多情况下我们是需要全局 interceptor 的，而且还用到一些 provider，怎么办呢？"}),"\n",(0,t.jsx)(n.p,{children:"nest 提供了一个 token，用这个 token 在 AppModule 里声明的 interceptor，Nest 会把它作为全局 interceptor："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:i,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"在这个 interceptor 里我们注入了 appService："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:a,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"添加一个路由："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"访问下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"可以看到全局 interceptor 生效了，而且这个 hello world 就是注入的 appService 返回的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:s,alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["案例代码在",(0,t.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/interceptor-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,t.jsxs)(n.h2,{id:"总结",children:["总结",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"rxjs 是一个处理异步逻辑的库，它的特点就是 operator 多，你可以通过组合 operator 来完成逻辑，不需要自己写。"}),"\n",(0,t.jsx)(n.p,{children:"nest 的 interceptor 就用了 rxjs 来处理响应，但常用的 operator 也就这么几个："}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"tap: 不修改响应数据，执行一些额外逻辑，比如记录日志、更新缓存等"}),"\n",(0,t.jsx)(n.li,{children:"map：对响应数据做修改，一般都是改成 {code, data, message} 的格式"}),"\n",(0,t.jsx)(n.li,{children:"catchError：在 exception filter 之前处理抛出的异常，可以记录或者抛出别的异常"}),"\n",(0,t.jsx)(n.li,{children:"timeout：处理响应超时的情况，抛出一个 TimeoutError，配合 catchErrror 可以返回超时的响应"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"总之，rxjs 的 operator 多，但是适合在 nest interceptor 里用的也不多。"}),"\n",(0,t.jsx)(n.p,{children:"此外，interceptor 也是可以注入依赖的，你可以通过注入模块内的各种 provider。"}),"\n",(0,t.jsx)(n.p,{children:"全局 interceptor 可以通过 APP_INTERCEPTOR 的 token 声明，这种能注入依赖，比 app.useGlobalInterceptors 更好。"}),"\n",(0,t.jsx)(n.p,{children:"interceptor 是 nest 必用功能，还是要好好掌握的。"})]})}function X(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(J,{...e})}):J(e)}let C=X;X.__RSPRESS_PAGE_META={},X.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F19.%20RxJS%20%E5%92%8C%20Interceptor.md"]={toc:[{text:"map",id:"map",depth:2},{text:"tap",id:"tap",depth:2},{text:"catchError",id:"catcherror",depth:2},{text:"timeout",id:"timeout",depth:2},{text:"总结",id:"总结",depth:2}],title:"19. RxJS 和 Interceptor",headingTitle:"19. RxJS 和 Interceptor",frontmatter:{}}}}]);