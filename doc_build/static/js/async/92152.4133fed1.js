"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["92152"],{232559:function(e,n,s){e.exports=s.p+"static/image/04d26edc3de1a499815ae0d566daee4d.32f2071d.webp"},165842:function(e,n,s){e.exports=s.p+"static/image/483bd211eccb5f86fde31d74740c3195.27ef5419.webp"},313838:function(e,n,s){e.exports=s.p+"static/image/63bdeb6d935e319d93b0ec1c48831ca3.ec26d549.webp"},818646:function(e,n,s){e.exports=s.p+"static/image/b56f2819274930479332a71bb32cac20.920225f8.webp"},187054:function(e,n,s){e.exports=s.p+"static/image/e9f301302a6abc4210c37ad7d02bd3c3.5a88a616.webp"},809861:function(e,n,s){e.exports=s.p+"static/image/fdc230dd73faf06fd6dc50e23cb87f36.bfd02db3.webp"},168392:function(e,n,s){s.r(n),s.d(n,{default:()=>eu});var i=s(552676),r=s(740453);let a=s.p+"static/image/20b0ab14f6e239ab4a3efcada3dbf0b3.7bd76e30.webp",c=s.p+"static/image/75ec2e00a9086ce00c784bbd0d104de1.1ccf9b5c.webp",t=s.p+"static/image/dc282f342e887b8eb4d0ccf0116ec1d2.b10ede58.webp",p=s.p+"static/image/9b4be767cf04aa4f49f41327fe8d8956.0e9e735f.webp",d=s.p+"static/image/149b29d22b1578094089ec1371b7ea66.5375938e.webp",l=s.p+"static/image/67fd1ce6bd08b96b2bd37c65dad5af89.fa619800.webp",o=s.p+"static/image/b36f36ba39a1d21d257a231ac8a35aa3.c7cd4a02.webp",m=s.p+"static/image/21b71f07cef38fc3b8522b1060e8dadf.4b44ba3e.webp",j=s.p+"static/image/e94232518d7270e406e6c8896f25e3ab.7b846362.webp",x=s.p+"static/image/5615ea22565323c3132914263e257590.a56180f3.webp",h=s.p+"static/image/a00afd77f195707a090785d667210e9c.b4afff2f.webp",g=s.p+"static/image/0678941456a8ab11461b4dc101645e8f.65c89270.webp",b=s.p+"static/image/a166f4a4d81e269cd6175c4712636e19.8544e321.webp",u=s.p+"static/image/5863487cf5589895c023e4be3cc8e7dd.ca2808d6.webp",f=s.p+"static/image/8be6a5f6d6f49e842956dc10fb8fb33f.42d79d25.webp",v=s.p+"static/image/74752f44a4d782bf4c6caf5003f09358.6a884b4b.webp",w=s.p+"static/image/15bbfeb63fa7c9305d8d17339224c6ce.3e57d3f1.webp",C=s.p+"static/image/912bf6d0710c80f8c7bbf144b9cd8f33.accccfd5.webp",A=s.p+"static/image/bbdb7faf673aca2b72e19be51afefcec.5b480d95.webp",y=s.p+"static/image/b0ea34384936a473ba851b5693a5a8fb.9fc494bb.webp",E=s.p+"static/image/44e97eb18cf1b17e4c6070c5a06221ad.cb939de4.webp",U=s.p+"static/image/5c51cc170ef78e1fa5d9a4046c6a3a3e.8c37300a.webp",S=s.p+"static/image/bd1c3dc99d0d4bb35d920eecc64700fd.adc7d3c4.webp",I=s.p+"static/image/7195bf7498dc603d69d80124bee2f4c5.74f557ba.webp",R=s.p+"static/image/83c009da84c738c70b21cf2b1510d239.4e442bd3.webp",q=s.p+"static/image/01be99c140ba9ec442d382f89da36363.0055c919.webp",P=s.p+"static/image/d6cb3206d98a637076caa4f90bdf3449.82c39e7d.webp",D=s.p+"static/image/b6e03a12946aa9a5263795cefd41cd29.3621d162.webp",G=s.p+"static/image/a659ec471db07ff8ae33322c86e7ae0e.9734c838.webp",T=s.p+"static/image/96a6cb3ddba23b22901d107903c3dee8.1c6a6a27.webp",O=s.p+"static/image/ebfaa64a1e6fa5cee1766c7ff7b8fd45.074b6863.webp",k=s.p+"static/image/8fb9a7d1c88e3ed1337d67b8588da05a.18e9cfee.webp",N=s.p+"static/image/e5ad451c8abd7a3eef7bd230601b5fc9.1847783c.webp";var L=s(165842);let M=s.p+"static/image/2d691c88954dbc7c4381f4a89d2e2919.19e36edb.webp";var Q=s(187054),H=s(818646),B=s(313838);let z=s.p+"static/image/d7cfbfecee05de9080a5002f0d95e012.b2f556ac.webp",F=s.p+"static/image/9885f5fb2a70e5b49d36ac9b9b1fe838.0879cff8.webp",X=s.p+"static/image/9ff0d3a62c26c0f0a33311aee4f5e307.9d6696b2.webp",J=s.p+"static/image/031f6de7b60a66d25359fa3e7af2e441.a1fdadb6.webp",K=s.p+"static/image/fc727c525b0997e9751324f91bea892a.bc243afa.webp",Y=s.p+"static/image/a6c1a4055a0f4e040d5a631fd4e24a4c.bed19829.webp",W=s.p+"static/image/aa71e9e94d5121870b99f5dfc736d6d0.5b532547.webp",V=s.p+"static/image/84d404f7646790cf53f5e5ee32cd8874.56a1600b.webp",Z=s.p+"static/image/4c1f7ed18d313341766d616e03d8149f.14e4d9e9.webp",_=s.p+"static/image/44a897b0cee0ae274ee474e9e746d79f.57ea89e6.webp",$=s.p+"static/image/e875f7e7ffc8bcf96b692bb056e8fa2d.e2088c94.webp",ee=s.p+"static/image/31a94b5fdec701e51a6841929cbc3f03.f6873777.webp",en=s.p+"static/image/1c79cdbd9aedc1307bff683fba36264e.057ada7f.webp",es=s.p+"static/image/acae3cf656435ed69e06772d4c7e78c2.0bf56bcc.webp",ei=s.p+"static/image/92b0673580702ba715bc64c42f8f4d0e.530e8745.webp",er=s.p+"static/image/4fc97c6c700ce267642f484413bdd25c.0c2e8c42.webp",ea=s.p+"static/image/4f6ef5ca1dfc9e5eba72882a4a760adc.7450b167.webp",ec=s.p+"static/image/5133e5ac7db3cda1b8cc7bf3cd288023.d552312e.webp",et=s.p+"static/image/71ff586caff1b99e2f46c66efb48da81.2cfbca35.webp",ep=s.p+"static/image/592132ad843ec3d7a3203bb89c953bee.4315c83a.webp";var ed=s(232559);let el=s.p+"static/image/cba33ca743331c88537ae14c770d903d.6a2d908d.webp",eo=s.p+"static/image/61b2243625eaf8a23a8df456c9a0656f.19fab210.webp",em=s.p+"static/image/0d2a516845e8bdf901f24035df12e5c6.f0fdc53e.webp",ej=s.p+"static/image/5fe41082d05610d12f5934a70b89ad39.9dfe0fcb.webp";var ex=s(809861);let eh=s.p+"static/image/8a61526dbf91b4618f08a164165a89f3.0e272bc2.webp";function eg(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"69-基于-acl-实现权限控制",children:["69. 基于 ACL 实现权限控制",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#69-基于-acl-实现权限控制",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"上节我们实现了注册和登录，有的接口只有登录可以访问，会在 Guard 里做身份验证（Authentication）。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:eh,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"但有的接口，不只需要登录，可能还需要一定的权限，这时就需要鉴权（Authorization）。"}),"\n",(0,i.jsx)(n.p,{children:"比如管理员登录后，可以调用用户管理的接口，但普通用户登录后就不可以。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ex,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"也就是说，身份验证通过之后还需要再做一步权限的校验，也就是鉴权。"}),"\n",(0,i.jsx)(n.p,{children:"这俩单词也比较相似：身份验证（Authentication）、鉴权（Authorization）。"}),"\n",(0,i.jsx)(n.p,{children:"那怎么给不同用户分配权限呢？"}),"\n",(0,i.jsx)(n.p,{children:"最简单的方式自然是直接给用户分配权限："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ej,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"比如用户 1 有权限 A、B、C，用户 2 有权限 A，用户 3 有权限 A、B。"}),"\n",(0,i.jsx)(n.p,{children:"这种记录每个用户有什么权限的方式，叫做访问控制表（Access Control List）"}),"\n",(0,i.jsx)(n.p,{children:"用户和权限是多对多关系，存储这种关系需要用户表、角色表、用户-角色的中间表。"}),"\n",(0,i.jsx)(n.p,{children:"这节我们就来实现下 ACL 的权限控制。"}),"\n",(0,i.jsx)(n.p,{children:"在数据库中创建 acl_test 的 database。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE DATABASE acl_test DEFAULT CHARACTER SET utf8mb4;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:em,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"刷新可以看到这个 database："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:eo,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"创建个 nest 项目："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest new acl-test -p npm\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:el,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"安装 typeorm 的依赖："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 AppModule 引入 TypeOrmModule："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\n\n@Module({\n  imports: [ \n    TypeOrmModule.forRoot({\n      type: \"mysql\",\n      host: \"localhost\",\n      port: 3306,\n      username: \"root\",\n      password: \"guang\",\n      database: \"acl_test\",\n      synchronize: true,\n      logging: true,\n      entities: [],\n      poolSize: 10,\n      connectorPackage: 'mysql2',\n      extra: {\n          authPlugin: 'sha256_password',\n      }\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后添加创建 user 模块："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g resource user\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ed,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"添加 User 和 Permission 的 Entity："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from "typeorm";\n\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 50\n    })\n    username: string;\n\n    @Column({\n        length: 50\n    })\n    password: string;\n\n    @CreateDateColumn()\n    createTime: Date;\n\n    @UpdateDateColumn()\n    updateTime: Date;\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"User 有 id、username、password、createTime、updateTime 5 个字段。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from "typeorm";\n\n@Entity()\nexport class Permission {\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 50\n    })\n    name: string;\n    \n    @Column({\n        length: 100,\n        nullable: true\n    })\n    desc: string;\n\n    @CreateDateColumn()\n    createTime: Date;\n\n    @UpdateDateColumn()\n    updateTime: Date;\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"permission 有 id、name、desc、createTime、updateTime 5 个字段，desc 字段可以为空。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 User 里加入和 Permission 的关系，也就是多对多："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ep,alt:"image.png"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@ManyToMany(() => Permission)\n@JoinTable({\n    name: 'user_permission_relation'\n})\npermissions: Permission[] \n"})}),"\n",(0,i.jsx)(n.p,{children:"通过 @ManyToMany 声明和 Permisssion 的多对多关系。"}),"\n",(0,i.jsx)(n.p,{children:"多对多是需要中间表的，通过 @JoinTable 声明，指定中间表的名字。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 TypeOrm.forRoot 的 entities 数组加入这俩 entity："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:et,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"把 Nest 服务跑起来试试："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ec,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到生成了 user、permission、user_permission_relation 这 3 个表。"}),"\n",(0,i.jsx)(n.p,{children:"并且中间表 user_permission_relation 还有 userId、permissionId 两个外键。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ea,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:er,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ei,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:es,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，3个表生成的都是对的，并且中间表的两个外键也都是主表删除或者更新时，从表级联删除或者更新。"}),"\n",(0,i.jsx)(n.p,{children:"然后我们插入一些数据，不用 sql 插入，而是用 TypeORM 的 api 来插入："}),"\n",(0,i.jsx)(n.p,{children:"修改下 UserService，添加这部分代码："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\nentityManager: EntityManager;\n\nasync initData() {\n    const permission1 = new Permission();\n    permission1.name = 'create_aaa';\n    permission1.desc = '新增 aaa';\n\n    const permission2 = new Permission();\n    permission2.name = 'update_aaa';\n    permission2.desc = '修改 aaa';\n\n    const permission3 = new Permission();\n    permission3.name = 'remove_aaa';\n    permission3.desc = '删除 aaa';\n\n    const permission4 = new Permission();\n    permission4.name = 'query_aaa';\n    permission4.desc = '查询 aaa';\n\n    const permission5 = new Permission();\n    permission5.name = 'create_bbb';\n    permission5.desc = '新增 bbb';\n\n    const permission6 = new Permission();\n    permission6.name = 'update_bbb';\n    permission6.desc = '修改 bbb';\n\n    const permission7 = new Permission();\n    permission7.name = 'remove_bbb';\n    permission7.desc = '删除 bbb';\n\n    const permission8 = new Permission();\n    permission8.name = 'query_bbb';\n    permission8.desc = '查询 bbb';\n\n    const user1 = new User();\n    user1.username = '东东';\n    user1.password = 'aaaaaa';\n    user1.permissions  = [\n      permission1, permission2, permission3, permission4\n    ]\n\n    const user2 = new User();\n    user2.username = '光光';\n    user2.password = 'bbbbbb';\n    user2.permissions  = [\n      permission5, permission6, permission7, permission8\n    ]\n\n    await this.entityManager.save([\n      permission1, \n      permission2,\n      permission3,\n      permission4,\n      permission5,\n      permission6,\n      permission7,\n      permission8\n    ])\n    await this.entityManager.save([\n      user1, \n      user2\n    ]);\n}\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"注入 EntityManager，实现权限和用户的保存。"}),"\n",(0,i.jsx)(n.p,{children:"aaa 增删改查、bbb增删改查，一个 8 个权限。"}),"\n",(0,i.jsx)(n.p,{children:"user1 有 aaa 的 4 个权限，user2 有 bbbb 的 4 个权限。"}),"\n",(0,i.jsx)(n.p,{children:"调用 entityManager.save 来保存。"}),"\n",(0,i.jsx)(n.p,{children:"然后改下 UserController："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('init')\nasync initData() {\n    await this.userService.initData();\n    return 'done'\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"添加 init 的路由。"}),"\n",(0,i.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"服务端打印了一堆 sql，包了一层事务："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:en,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"分别向 user、permission、user_permission_relation 中插入了数据。"}),"\n",(0,i.jsx)(n.p,{children:"我们在 mysql workbench 里刷新下："}),"\n",(0,i.jsx)(n.p,{children:"permission 表插入了 8 条权限记录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ee,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"user 表插入了 2 条用户记录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:$,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"中间表插入了 8 条记录，两个用户各拥有 4 个权限："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:_,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后我们再实现登录的接口，这次通过 session + cookie 的方式。"}),"\n",(0,i.jsx)(n.p,{children:"安装 session 相关的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install express-session @types/express-session\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 main.ts 里使用这个中间件："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport * as session from 'express-session';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n\n  app.use(session({\n    secret: 'guang',\n    resave: false,\n    saveUninitialized: false\n  }));\n  await app.listen(3000);\n}\nbootstrap();\n"})}),"\n",(0,i.jsx)(n.p,{children:"secret 是加密 cookie 的密钥。"}),"\n",(0,i.jsx)(n.p,{children:"resave 是 session 没变的时候要不要重新生成 cookie。"}),"\n",(0,i.jsx)(n.p,{children:"saveUninitialized 是没登录要不要也创建一个 session。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 UserController 添加一个 /user/login 的路由："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nlogin(@Body() loginUser: LoginUserDto, @Session() session){\n    console.log(loginUser)\n    return 'success'\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后先去创建 dto 对象："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"export class LoginUserDto {\n    username: string;\n\n    password: string;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"安装 ValidationPipe 用到的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save class-validator class-transformer\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后给 dto 对象添加 class-validator 的装饰器："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'import { IsNotEmpty, Length } from "class-validator";\n\nexport class LoginUserDto {\n    @IsNotEmpty()\n    @Length(1, 50)\n    username: string;\n\n    @IsNotEmpty()\n    @Length(1, 50)\n    password: string;\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"全局启用 ValidationPipe："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Z,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在 postman 里测试下："}),"\n",(0,i.jsx)(n.p,{children:"ValidationPipe 不通过的时候，会返回错误信息："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:V,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"ValidationPipe 通过之后，就会执行 handler 里的方法："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"接下来实现查询数据库的逻辑，在 UserService 添加 login 方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async login(loginUserDto: LoginUserDto) {\n    const user = await this.entityManager.findOneBy(User, {\n      username: loginUserDto.username\n    });\n\n    if(!user) {\n      throw new HttpException('用户不存在', HttpStatus.ACCEPTED);\n    }\n\n    if(user.password !== loginUserDto.password) {\n      throw new HttpException('密码错误', HttpStatus.ACCEPTED);\n    }\n\n    return user;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后改下 UserController 的 login 方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync login(@Body() loginUser: LoginUserDto, @Session() session){\n    const user = await this.userService.login(loginUser);\n\n    session.user = {\n      username: user.username\n    }\n\n    return 'success';\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"调用 userService，并且把 user 信息放入 session。"}),"\n",(0,i.jsx)(n.p,{children:"再用 postman 登录下："}),"\n",(0,i.jsxs)(n.p,{children:["用户不存在：\n",(0,i.jsx)("img",{src:K,alt:"image.png"})]}),"\n",(0,i.jsx)(n.p,{children:"密码错误："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:J,alt:"image.png"})}),"\n",(0,i.jsxs)(n.p,{children:["登录成功：\n",(0,i.jsx)("img",{src:X,alt:"image.png"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:F,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"登录成功之后会返回 cookie，之后只要带上这个 cookie 就可以查询到服务端的对应的 session，从而取出 user 信息。"}),"\n",(0,i.jsx)(n.p,{children:"然后添加 aaa、bbb 两个模块，分别生成 CRUD 方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g resource aaa \nnest g resource bbb \n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:z,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:B,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"现在这些接口可以直接访问："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:H,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Q,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"而实际上这些接口是要控制权限的。"}),"\n",(0,i.jsx)(n.p,{children:"用户东东有 aaa 的增删改查权限，而用户光光拥有 bbb 的增删改查权限。"}),"\n",(0,i.jsx)(n.p,{children:"所以要对接口的调用做限制。"}),"\n",(0,i.jsx)(n.p,{children:"先添加一个 LoginGuard，限制只有登录状态才可以访问这些接口："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g guard login --no-spec --flat\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后增加登录状态的检查："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\n\ndeclare module 'express-session' {\n  interface Session {\n    user: {\n      username: string\n    }\n  }\n}\n\n@Injectable()\nexport class LoginGuard implements CanActivate {\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n    \n    if(!request.session?.user){\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    return true;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"因为默认的 session 里没有 user 的类型，所以需要扩展下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:M,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"利用同名 interface 会自动合并的特点来扩展 Session。"}),"\n",(0,i.jsx)(n.p,{children:"然后给接口都加上这个 Guard："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:L,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"再访问下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:k,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:O,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"在 postman 里带上 cookie 访问："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:T,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"你访问登录接口之后，服务端返回 set-cookie 的 header，postman 会自动带上 cookie，不需要手动带："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:G,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"行为和浏览器里一致。"}),"\n",(0,i.jsx)(n.p,{children:"这时候再访问 aaa、bbb 的接口，就可以访问了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:D,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:P,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"但是这样还不够，我们还需要再做登录用户的权限控制，所以再写个 PermissionGuard:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g guard permission --no-spec --flat\n"})}),"\n",(0,i.jsx)(n.p,{children:"因为 PermissionGuard 里需要用到 UserService 来查询数据库，所以把它移动到 UserModule 里："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"注入 UserService："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable } from '@nestjs/common';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\nimport { UserService } from './user.service';\n\n@Injectable()\nexport class PermissionGuard implements CanActivate {\n\n  @Inject(UserService) \n  private userService: UserService;\n\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n\n    console.log(this.userService);\n\n    return true;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 UserModule 的 providers、exports 里添加 UserService"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Module, UseGuards } from '@nestjs/common';\nimport { UserService } from './user.service';\nimport { UserController } from './user.controller';\nimport { PermissionGuard } from './permission.guard';\n\n@Module({\n  controllers: [UserController],\n  providers: [UserService],\n  exports: [UserService]\n})\nexport class UserModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们在 AaaModule 里引入这个 UserModule："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在 /aaa 的 handler 里添加 PermissionGuard："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"postman 访问下："}),"\n",(0,i.jsx)(n.p,{children:"首先重新登录，post 方式请求 /user/login："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后 get 访问 /aaa，postman 会自动带上 cookie。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:U,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"服务端打印了 UserService："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"说明在 PermissionGuard 里成功注入了 UserService。"}),"\n",(0,i.jsx)(n.p,{children:"然后来实现权限检查的逻辑。"}),"\n",(0,i.jsx)(n.p,{children:"在 UserService 里添加一个方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async findByUsername(username: string) {\n  const user = await this.entityManager.findOne(User, {\n    where: {\n      username,\n    },\n    relations: {\n      permissions: true\n    }\n  });\n  return user;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"根据用户名查找用户，并且查询出关联的权限来。"}),"\n",(0,i.jsx)(n.p,{children:"在 PermissionGuard 里调用下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\nimport { UserService } from './user.service';\n\n@Injectable()\nexport class PermissionGuard implements CanActivate {\n\n  @Inject(UserService) \n  private userService: UserService;\n\n  async canActivate(\n    context: ExecutionContext,\n  ): Promise<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n\n    const user = request.session.user;\n    if(!user) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    const foundUser = await this.userService.findByUsername(user.username);\n\n    console.log(foundUser);\n\n    return true;\n  }\n}\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"打印了下查找到的登录用户的信息。"}),"\n",(0,i.jsx)(n.p,{children:"我们试试看："}),"\n",(0,i.jsx)(n.p,{children:"先登录，拿到 cookie："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后请求 /aaa 接口："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"服务端打印了当前用户的权限信息："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后我们就根据当前 handler 需要的权限来判断是否返回 true 就可以了。"}),"\n",(0,i.jsx)(n.p,{children:"那怎么给当前 handler 标记需要什么权限呢？"}),"\n",(0,i.jsx)(n.p,{children:"很明显是通过 metadata。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"给 /aaa 接口声明需要 query_aaa 的 permission。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 PermissionGuard 里通过 reflector 取出来："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"取出 handler 声明的 metadata，如果用户权限里包含需要的权限，就返回 true，否则抛出没有权限的异常。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\nimport { UserService } from './user.service';\n\n@Injectable()\nexport class PermissionGuard implements CanActivate {\n\n  @Inject(UserService) \n  private userService: UserService;\n\n  @Inject(Reflector)\n  private reflector: Reflector;\n\n  async canActivate(\n    context: ExecutionContext,\n  ): Promise<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n\n    const user = request.session.user;\n    if(!user) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    const foundUser = await this.userService.findByUsername(user.username);\n\n    const permission = this.reflector.get('permission', context.getHandler());\n\n    if(foundUser.permissions.some(item => item.name === permission)) {\n       return true;\n    } else {\n      throw new UnauthorizedException('没有权限访问该接口');\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们试一下："}),"\n",(0,i.jsx)(n.p,{children:"这次用光光的账号登录："}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)("img",{src:f,alt:""}),"\n访问 /aaa，会提示没有权限："]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后登录东东的账号："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后访问 /aaa："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"东东是有 query_aaa 的权限的，就可以正常访问了。"}),"\n",(0,i.jsx)(n.p,{children:"这样我们就通过 ACL 的方式完成了接口权限的控制。"}),"\n",(0,i.jsx)(n.p,{children:"但是不知道同学们有没有发现一个问题："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:h,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"每次访问接口，都会触发这样 3 个表的关联查询。"}),"\n",(0,i.jsx)(n.p,{children:"效率太低了。"}),"\n",(0,i.jsx)(n.p,{children:"怎么优化一下呢？"}),"\n",(0,i.jsx)(n.p,{children:"有的同学说，登录的时候把权限也查出来放到 session 里不就行了么？"}),"\n",(0,i.jsx)(n.p,{children:"确实，可以在登录的时候做这件事情，把权限放到 session 里，之后就直接从 session 取就好了。"}),"\n",(0,i.jsx)(n.p,{children:"那还是延续现在的访问时查询权限的方案，怎么优化呢？"}),"\n",(0,i.jsx)(n.p,{children:"这时就需要 redis 了，redis 的缓存就是用来做这种优化的。"}),"\n",(0,i.jsx)(n.p,{children:"我们引入下 redis："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install redis \n"})}),"\n",(0,i.jsx)(n.p,{children:"然后新建一个模块来封装 redis 操作："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g module redis\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后新建一个 service："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g service redis --no-spec\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后在 RedisModule 里添加 redis 的 provider："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Global, Module } from '@nestjs/common';\nimport { createClient } from 'redis';\nimport { RedisService } from './redis.service';\n\n@Global()\n@Module({\n  providers: [RedisService, \n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"并使用 @Global 把这个模块声明为全局的。"}),"\n",(0,i.jsx)(n.p,{children:"这样，各个模块就都可以注入这个 RedisService 了。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 RedisService 里添加一些 redis 操作方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType\n\n    async listGet(key: string) {\n        return await this.redisClient.lRange(key, 0, -1);\n    }\n\n    async listSet(key: string, list: Array<string>, ttl?: number) {\n        for(let i = 0; i < list.length;i++) {\n            await this.redisClient.lPush(key, list[i]);\n        }\n        if(ttl) {\n            await this.redisClient.expire(key, ttl);\n        }\n    }\n}\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"注入 redisClient，封装 listGet 和 listSet 方法，listSet 方法支持传入过期时间。"}),"\n",(0,i.jsx)(n.p,{children:"底层用的命令是 lrange 和 lpush、exprire。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 PermissionGuard 里注入来用下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"先查询 redis、没有再查数据库并存到 redis，有的话就直接用 redis 的缓存结果。"}),"\n",(0,i.jsx)(n.p,{children:"key 为 user_${username}_permissions，这里的 username 是唯一的。"}),"\n",(0,i.jsx)(n.p,{children:"缓存过期时间为 30 分钟。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { RedisService } from './../redis/redis.service';\nimport { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\nimport { UserService } from './user.service';\n\n@Injectable()\nexport class PermissionGuard implements CanActivate {\n\n  @Inject(UserService) \n  private userService: UserService;\n\n  @Inject(Reflector)\n  private reflector: Reflector;\n\n  @Inject(RedisService)\n  private redisService: RedisService;\n\n  async canActivate(\n    context: ExecutionContext,\n  ): Promise<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n\n    const user = request.session.user;\n    if(!user) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    let permissions = await this.redisService.listGet(`user_${user.username}_permissions`); \n\n    if(permissions.length === 0) {\n      const foundUser = await this.userService.findByUsername(user.username);\n      permissions = foundUser.permissions.map(item => item.name);\n\n      this.redisService.listSet(`user_${user.username}_permissions`, permissions, 60 * 30)\n    }\n\n    const permission = this.reflector.get('permission', context.getHandler());\n\n    if(permissions.some(item => item === permission)) {\n      return true;\n    } else {\n      throw new UnauthorizedException('没有权限访问该接口');\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们试一下："}),"\n",(0,i.jsx)(n.p,{children:"这里如果你没跑 redis server，需要先通过 docker 把它跑起来。具体怎么跑可以翻一下 redis 入门那节"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后先登录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"服务端打印了查询用户数据的 sql："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"然后再访问 /aaa"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"又打印了 2 条关联查询的 sql："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"我们去 RedisInsight 里看下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:c,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"可以看到这条缓存。"}),"\n",(0,i.jsx)(n.p,{children:"这时候你刷新多少次，都不会再产生 sql 了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:a,alt:"2023-06-22 17.16.43.gif"})}),"\n",(0,i.jsx)(n.p,{children:"这时候查的就是 redis 缓存。"}),"\n",(0,i.jsx)(n.p,{children:"redis 是基于内存的，访问速度会比 mysql 快很多。这就是为什么要用 redis。"}),"\n",(0,i.jsxs)(n.p,{children:["案例代码在",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/acl-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"有的接口除了需要登录外，还需要权限。"}),"\n",(0,i.jsx)(n.p,{children:"只有登录用户有调用该接口的权限才能正常访问。"}),"\n",(0,i.jsx)(n.p,{children:"这节我们通过 ACL （Access Control List）的方式实现了权限控制，它的特点是用户直接和权限关联。"}),"\n",(0,i.jsx)(n.p,{children:"用户和权限是多对多关系，在数据库中会存在用户表、权限表、用户权限中间表。"}),"\n",(0,i.jsx)(n.p,{children:"登录的时候，把用户信息查出来，放到 session 或者 jwt 返回。"}),"\n",(0,i.jsx)(n.p,{children:"然后访问接口的时候，在 Guard 里判断是否登录，是否有权限，没有就返回 401，有的话才会继续处理请求。"}),"\n",(0,i.jsx)(n.p,{children:"我们采用的是访问接口的时候查询权限的方案，通过 handler 上用 SetMetadata 声明的所需权限的信息，和从数据库中查出来的当前用户的权限做对比，有相应权限才会放行。"}),"\n",(0,i.jsx)(n.p,{children:"但是这种方案查询数据库太频繁，需要用 redis 来做缓存。"}),"\n",(0,i.jsx)(n.p,{children:"当然，你选择登录的时候把权限一并查出来放到 session 或者 jwt 里也是可以的。"}),"\n",(0,i.jsx)(n.p,{children:"这就是通过 ACL 实现的权限控制。"})]})}function eb(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(eg,{...e})}):eg(e)}let eu=eb;eb.__RSPRESS_PAGE_META={},eb.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F69.%20%E5%9F%BA%E4%BA%8E%20ACL%20%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"69. 基于 ACL 实现权限控制",headingTitle:"69. 基于 ACL 实现权限控制",frontmatter:{}}}}]);