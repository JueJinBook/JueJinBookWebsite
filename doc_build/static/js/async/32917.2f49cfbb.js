"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["32917"],{840385:function(e,n,s){s.r(n),s.d(n,{default:()=>T});var c=s(552676),i=s(740453);let r=s.p+"static/image/516ce57c4d302d56b7db06c3c3f474ed.2310798e.webp",a=s.p+"static/image/9c8a7dc5c29b40e5a597f585413ea50a.da2afb04.webp",l=s.p+"static/image/1982221953285e11cada1fdc534a6826.c9575b98.webp",t=s.p+"static/image/21a975c3566d302f3bd7736c7bc74111.dfa28756.webp",d=s.p+"static/image/2514a12ffd6aee1daebaa47506d46e45.3c5aaca6.webp",p=s.p+"static/image/d251976a98e5a16505cf99006e8952ca.6037840b.webp",o=s.p+"static/image/9af21b85c694b33fbd61d4fe1a9b940a.ce29571f.webp",j=s.p+"static/image/87fce31dc4646ae6e70ecfdb910fa941.f9ba4a4f.webp",h=s.p+"static/image/7d113ff77ea7d80ee9c30d4c7eeed1d1.74ac71a2.webp",x=s.p+"static/image/0e2abee6c9d3b23487b51ba0e5933e9e.27268d84.webp",m=s.p+"static/image/cce502f25583cea193431e08abb95b8c.5c866bb0.webp",g=s.p+"static/image/ff889f801ae3632b3b048c345f6232ac.4070498d.webp",b=s.p+"static/image/52c23eb962f30d77a81e4c78ae71c6c4.4c70e42c.webp",q=s.p+"static/image/a8b023c5e5af1b62645baa7c8c966c0e.41c183cc.webp",u=s.p+"static/image/93ad6f282e055b9abcba914f538834a3.e7f53cac.webp",f=s.p+"static/image/5c183bd4567a1ee7d04270c08019dd18.de3d1882.webp",y=s.p+"static/image/59896b9b165a4529dc0270f6a7777481.b73aae94.webp",E=s.p+"static/image/32c3551eaccf8975f06693db511c9951.bd0fd20b.webp",w=s.p+"static/image/58edfc19d543618f97cdfa6b76d94841.405873fe.webp",A=s.p+"static/image/f3e362223d37426cd82abbc7379851c7.3e656bce.webp",N=s.p+"static/image/09f696341ba69d4cd761eae8d0418022.53aea337.webp",R=s.p+"static/image/029cc6c9cc90cb17f1205a8df71328f9.caa52e6d.webp",M=s.p+"static/image/3871a691f3294180427cc8bbe56e45f2.b0c01229.webp",v=s.p+"static/image/a0043ba09f649bc44aaa009c4f9f60e1.ed2f96ae.webp",O=s.p+"static/image/e4b6d03a9d03ff2296b462e5b3b90132.3a6d11b3.webp",L=s.p+"static/image/f97f753a3811d0bd2a6d0153ca7c3f00.3069c5b9.webp";function F(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",strong:"strong",h2:"h2"},(0,i.ah)(),e.components);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.h1,{id:"53-使用-node-操作-mysql-的两种方式",children:["53. 使用 Node 操作 MySQL 的两种方式",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#53-使用-node-操作-mysql-的两种方式",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"前面我们学习了 MySQL 的数据库、表、增删改查等，目的还是在 Node 应用里操作它。"}),"\n",(0,c.jsx)(n.p,{children:"这节我们就来学习下用 mysql2 和 typeorm 两种方式来操作 MysSQL 数据库。"}),"\n",(0,c.jsx)(n.p,{children:"先来看下 mysql2:"}),"\n",(0,c.jsx)(n.p,{children:"它是用的最多的连接 mysql 的 npm 包，是 mysql 包的升级版，有更多特性。"}),"\n",(0,c.jsx)(n.p,{children:"我们创建个目录，然后进入这个目录执行 npm init -y 创建 package.json。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:L,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后安装 mysql2"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install --save mysql2 \n"})}),"\n",(0,c.jsx)(n.p,{children:"添加这样一个 index.js："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const mysql = require('mysql2');\n\nconst connection = mysql.createConnection({\n  host: 'localhost',\n  port: 3306,\n  user: 'root',\n  password: 'guang',\n  database: 'practice'\n});\n\nconnection.query(\n  'SELECT * FROM customers',\n  function(err, results, fields) {\n    console.log(results);\n    console.log(fields.map(item => item.name)); \n  }\n);\n"})}),"\n",(0,c.jsx)(n.p,{children:"连接 mysql server，指定用户名、密码、要操作的数据库（这里要改成你自己的 mysql 连接密码）。"}),"\n",(0,c.jsx)(n.p,{children:"然后通过 query 方法跑一个查询 sql。"}),"\n",(0,c.jsx)(n.p,{children:"results 是结果，fields 是一些元信息，比如字段名这些。"}),"\n",(0,c.jsx)(n.p,{children:"node 执行下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:O,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"和我们在 mysql workbench 里执行效果一样。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:v,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"查询也可以指定占位符："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"connection.query(\n    'SELECT * FROM customers WHERE name LIKE ?',\n    ['李%'],\n    function(err, results, fields) {\n        console.log(results);\n        console.log(fields.map(item => item.name)); \n    }\n);\n"})}),"\n",(0,c.jsx)(n.p,{children:"我们查询了姓李的顾客有哪些："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:M,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"当然，增删改也是可以的。"}),"\n",(0,c.jsx)(n.p,{children:"比如我们插入一条数据："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-sql",children:"connection.execute('INSERT INTO customers (name) VALUES (?)',\n    ['光'], (err, results, fields) => {\n    console.log(err);\n});\n"})}),"\n",(0,c.jsx)(n.p,{children:"在 mysql workbench 里可以看到，确实插入了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:R,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"再来试下修改。"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:'connection.execute(\'UPDATE customers SET name="guang" where name="光"\',\n(err) => {\n    console.log(err);\n});\n'})}),"\n",(0,c.jsx)(n.p,{children:"把刚才插入的记录改个名字。"}),"\n",(0,c.jsx)(n.p,{children:"node 跑一下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,c.jsx)(n.p,{children:"点下刷新，可以看到确实修改了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:N,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"再试试删除："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"connection.execute('DELETE  FROM customers where name=?',\n    ['guang'],\n    (err) => {\n        console.log(err);\n    });\n"})}),"\n",(0,c.jsx)(n.p,{children:"执行后数据库中这条记录也删除了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:A,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这就是用 mysql2 做增删改查的方式。"}),"\n",(0,c.jsx)(n.p,{children:"是不是还挺简单的，就和我们在 mysql workbench 里写 sql 差不多。"}),"\n",(0,c.jsx)(n.p,{children:"当然，这些 api 也都有 promise 版本。"}),"\n",(0,c.jsx)(n.p,{children:"这样写："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-sql",children:"const mysql = require('mysql2/promise');\n\n(async function() {\n\n    const connection = await mysql.createConnection({\n        host: 'localhost',\n        port: 3306,\n        user: 'root',\n        password: 'guang',\n        database: 'practice'\n    });\n\n    const [results, fields] = await connection.query('SELECT * FROM customers');\n\n    console.log(results);\n    console.log(fields.map(item => item.name)); \n\n})();\n"})}),"\n",(0,c.jsx)(n.p,{children:"结果一样："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:w,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这是最基本的使用：需要操作数据库的时候，建立连接，用完之后释放连接。"}),"\n",(0,c.jsx)(n.p,{children:"但这样性能并不高。"}),"\n",(0,c.jsx)(n.p,{children:"因为数据库的连接建立还是很耗时的，而且一个连接也不够用。"}),"\n",(0,c.jsx)(n.p,{children:"我们一般都是用连接池来管理："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:E,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"连接池中放着好几个 mysql 的连接对象，用的时候取出来执行 sql，用完之后放回去，不需要断开连接。"}),"\n",(0,c.jsx)(n.p,{children:"mysql2 自然也封装了连接池的功能。"}),"\n",(0,c.jsx)(n.p,{children:"这样用："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const mysql = require('mysql2/promise');\n\n(async function() {\n    const pool = mysql.createPool({\n        host: 'localhost',\n        user: 'root',\n        password: 'guang',\n        database: 'practice',\n        waitForConnections: true,\n        connectionLimit: 10,\n        maxIdle: 10, \n        idleTimeout: 60000,\n        queueLimit: 0,\n        enableKeepAlive: true,\n        keepAliveInitialDelay: 0\n      });\n\n    const [results] = await pool.query('select * from customers');\n    console.log(results);\n})();\n"})}),"\n",(0,c.jsx)(n.p,{children:"只要把 createConnection 换成 createPool 就好了。query 或者 execute 的时候会自动从 pool 中取 connection 来用，用完会放回去。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:y,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"或者你也可以手动取："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const connection = await pool.getConnection();\n\nconst [results] = await connection.query('select * from orders');\nconsole.log(results);\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:f,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"回过头来再看看这些 option："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:u,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"connectionLimit 是指定最多有多少个连接，比如 10 个，那就是只能同时用 10个，再多需要排队等。"}),"\n",(0,c.jsx)(n.p,{children:"maxIdle 是指定最多有多少个空闲的，超过这个数量的空闲连接会被释放。"}),"\n",(0,c.jsx)(n.p,{children:"waitForConnections 是指如果现在没有可用连接了，那就等待，设置为 false 就是直接返回报错。"}),"\n",(0,c.jsx)(n.p,{children:"idleTimeout 是指空闲的连接多久会断开。"}),"\n",(0,c.jsx)(n.p,{children:"queueLimit 是可以排队的请求数量，超过这个数量就直接返回报错说没有连接了。设置为 0 就是排队没有上限。"}),"\n",(0,c.jsx)(n.p,{children:"enableKeepAlive、keepAliveInitialDelay 是保持心跳用的，用默认的就好。"}),"\n",(0,c.jsx)(n.p,{children:"这就是 mysql2 的用法，是不是还会挺简单的？"}),"\n",(0,c.jsx)(n.p,{children:"只要建立个连接或者连接池，就可以在 node 里执行 sql 了。"}),"\n",(0,c.jsx)(n.p,{children:"但是我们一般不会直接这样执行 sql，而是会用 ORM 框架。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"ORM 是 Object Relational Mapping，对象关系映射。也就是说把关系型数据库的表映射成面向对象的 class，表的字段映射成对象的属性映射，表与表的关联映射成属性的关联。"})}),"\n",(0,c.jsx)(n.p,{children:"其实这个想法也很自然，比如我们前面执行的这些 sql："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:q,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:b,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"返回的不就是 js 对象么。"}),"\n",(0,c.jsx)(n.p,{children:"那不如直接操作这个对象，让 ORM 框架自动执行 sql 去同步数据库。"}),"\n",(0,c.jsx)(n.p,{children:"TypeORM 就是一个流行的 ORM 框架。"}),"\n",(0,c.jsx)(n.p,{children:"我们来试一下："}),"\n",(0,c.jsx)(n.p,{children:"新建一个项目："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npx typeorm@latest init --name typeorm-mysql-test --database mysql\n"})}),"\n",(0,c.jsx)(n.p,{children:"通过 typeorm 的 init 命令创建一个项目， --name 指定项目名，--database 指定连接的数据库。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:g,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"修改下 data-source.ts"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:'import "reflect-metadata"\nimport { DataSource } from "typeorm"\nimport { User } from "./entity/User"\n\nexport const AppDataSource = new DataSource({\n    type: "mysql",\n    host: "localhost",\n    port: 3306,\n    username: "root",\n    password: "guang",\n    database: "practice",\n    synchronize: true,\n    entities: [User],\n    migrations: [],\n    subscribers: [],\n    connectorPackage: \'mysql2\',\n    extra: {\n        authPlugin: \'sha256_password\',\n    }\n})\n'})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:m,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"用户名密码，要操作的数据库，这些很容易理解。"}),"\n",(0,c.jsx)(n.p,{children:"指定用 mysql2 包来连接，就是我们前面测试的那个。"}),"\n",(0,c.jsx)(n.p,{children:"然后添加一个验证的插件，sha256_password，这个是切换密码的加密方式的，新版本 mysql 改成这种密码加密方式了。"}),"\n",(0,c.jsx)(n.p,{children:"还要手动安装下 mysql2 这个驱动包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install --save mysql2\n"})}),"\n",(0,c.jsx)(n.p,{children:"然后执行 npm run start。"}),"\n",(0,c.jsx)(n.p,{children:"这时候你会发现 practice 数据库多了个表："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:x,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"打开看一下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:h,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"它还有一条数据。"}),"\n",(0,c.jsx)(n.p,{children:"而且控制台也打印了查询出来的这条数据："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:j,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"怎么做到的呢？"}),"\n",(0,c.jsx)(n.p,{children:"我们看下代码，有这样一个 entity，通过装饰器声明了主键列和其他的列："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:o,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"在 index.ts 里创建了一个 User 的对象，调用 save 方法保存这个对象，通过 find 方法查询这个对象："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:p,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后数据库里就创建好了表、插入了数据，并且还把它查了出来。"}),"\n",(0,c.jsx)(n.p,{children:"这就是 ORM。"}),"\n",(0,c.jsx)(n.p,{children:"有没有感觉很神奇，它是怎么实现的呢？"}),"\n",(0,c.jsx)(n.p,{children:"我们看下它打印的 sql 就懂了。"}),"\n",(0,c.jsx)(n.p,{children:"加一个 logging 为 true 的选项："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:d,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后去数据库把那个 user 表删掉。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:t,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"再重新 npm run start："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:l,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"看到它打印的 CREATE TABLE、INSERT INTO、SELECT 的 sql 语句了么？"}),"\n",(0,c.jsx)(n.p,{children:"这就是 ORM 的实现原理。"}),"\n",(0,c.jsx)(n.p,{children:"它会根据你在 class 的属性上加的装饰器来生成建表 sql。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:a,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后 save 这个 class 的对象，就会执行 insert into 来插入数据。"}),"\n",(0,c.jsx)(n.p,{children:"find 方法会执行 select 来查询数据。"}),"\n",(0,c.jsx)(n.p,{children:"这样，对表的增删改查就变成了对对象的操作。"}),"\n",(0,c.jsx)(n.p,{children:"此外，可以看到每个涉及到修改的 sql 都包了一层事务，这样出了错可以回滚："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:r,alt:""})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/typeorm-mysql-test",target:"_blank",rel:"noopener noreferrer",children:"typeorm 案例代码"})," 和 ",(0,c.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/mysql2-test",target:"_blank",rel:"noopener noreferrer",children:"mysql2 案例代码"})," 都在小册仓库。"]}),"\n",(0,c.jsxs)(n.h2,{id:"总结",children:["总结",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"我们学习了 Node 里操作数据库的两种方式："}),"\n",(0,c.jsx)(n.p,{children:"一种是直接用 mysql2 连接数据库，发送 sql 来执行。"}),"\n",(0,c.jsx)(n.p,{children:"一种是用 ORM 库，比如 typeorm，它是基于 class 和 class 上的装饰器来声明和表的映射关系的，然后对表的增删改查就变成了对象的操作以及 save、find 等方法的调用。它会自动生成对应的 sql。"}),"\n",(0,c.jsx)(n.p,{children:"主流的方案还是 ORM 的方案，下节我们继续深入学习 typeorm。"})]})}function S(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(F,{...e})}):F(e)}let T=S;S.__RSPRESS_PAGE_META={},S.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F53.%20%E4%BD%BF%E7%94%A8%20Node%20%E6%93%8D%E4%BD%9C%20MySQL%20%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"53. 使用 Node 操作 MySQL 的两种方式",headingTitle:"53. 使用 Node 操作 MySQL 的两种方式",frontmatter:{}}}}]);