"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["16523"],{377066:function(e,n,c){c.r(n),c.d(n,{default:()=>K});var r=c(552676),s=c(740453);let i=c.p+"static/image/57b84ca7efcbdd2ce6efc97db184671b.9b98bb8c.webp",a=c.p+"static/image/cb56f602ff5d3419ed8a14a76607f66e.39b2b6c7.webp",d=c.p+"static/image/2b21e729d0d6649f65acdeb76241932c.23e57de9.webp",l=c.p+"static/image/bbe8c4f3a5940b045bd538e7218fa614.9df7d3ba.webp",t=c.p+"static/image/bac25f5241119fafbf4036b997ace796.b91d2750.webp",p=c.p+"static/image/8669b7fab346a3645f89206f2372cf63.188a19db.webp",x=c.p+"static/image/ec7ec3a4863a34b39700cd7e7f605cf8.39c07770.webp",o=c.p+"static/image/e40b5603618b7a4c6401ae605b1b2cdf.237c3ae8.webp",j=c.p+"static/image/7611e4df7afc1c51e2b691e785488092.f6176dd6.webp",h=c.p+"static/image/8228c894c9990ceba44c901314c59ca1.dc59f445.webp",f=c.p+"static/image/e9a77b4a0dc4be2706122f4946c40575.ae25750c.webp",b=c.p+"static/image/af6dae6d6052cb5065d6c5c9356b1404.a523054f.webp",m=c.p+"static/image/6d5b44c2fc005c6e6b083fe53db6a1b2.fbcafecc.webp",u=c.p+"static/image/4f637eaf17ed655cac9295a3969d061e.9b6e6116.webp",g=c.p+"static/image/44fe901cf86059af63142e2b5dfeb318.df73a61b.webp",k=c.p+"static/image/d24e180afb4aa79cd90d860a3a9cfba1.b2957a84.webp",w=c.p+"static/image/cfb9ee48c56aefd4b85f29a951cf025e.8b170544.webp",A=c.p+"static/image/9e0eabe0ea720958136bc5fb1cee69f7.dde7fa53.webp",v=c.p+"static/image/decff244a77a38200699aacda4ed54a5.3c896bea.webp",D=c.p+"static/image/06a1341427e7c992a9db2ea800577ce1.ef6c9f19.webp",M=c.p+"static/image/ad0953920a4b3b78730b5003b7505f68.0570feb6.webp",F=c.p+"static/image/22e96b973a2df02e269ec015af361bc7.5e607ef7.webp",E=c.p+"static/image/92372909746bc379d50f70123f5e2770.ba8b77f5.webp";function P(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2",ul:"ul",li:"li"},(0,s.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"78-docker-支持重启策略是否还需要-pm2",children:["78. Docker 支持重启策略，是否还需要 PM2",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#78-docker-支持重启策略是否还需要-pm2",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"前面我们学习了 Docker、Docker Compose，并在 Docker 容器里通过 pm2-runtime 来跑的 node 服务。"}),"\n",(0,r.jsx)(n.p,{children:"主要是用 pm2 可以在进程崩溃的时候重启进程的功能。"}),"\n",(0,r.jsx)(n.p,{children:"而其实这个功能 Docker 也是有的。"}),"\n",(0,r.jsx)(n.p,{children:"我们来试一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"setTimeout(() => {\n    throw new Error('xxx');\n}, 1000);\n"})}),"\n",(0,r.jsx)(n.p,{children:"1s 以后抛一个错误，进程会终止。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们把它放到 Docker 容器里跑。"}),"\n",(0,r.jsx)(n.p,{children:"写个 dockerfile："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-docker",children:'FROM node:18-alpine3.14\n\nWORKDIR /app\n\nCOPY ./index.js .\n\nCMD ["node", "/app/index.js"]\n'})}),"\n",(0,r.jsx)(n.p,{children:"然后构建成镜像："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker build -t restart-test:first .\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 docker desktop 里可以看到："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后把它跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker run --name=restart-test-container restart-test:first\n"})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，容器 1s 后就停掉了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"当进程退出的时候，容器也会停止。"}),"\n",(0,r.jsx)(n.p,{children:"docker run 的时候也可以指定重启策略："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker run -d --restart=always --name=restart-test-container2 restart-test:first\n"})}),"\n",(0,r.jsx)(n.p,{children:"这次加上 -d 把它放到后台跑。"}),"\n",(0,r.jsx)(n.p,{children:"--restart 指定总是重启。"}),"\n",(0,r.jsx)(n.p,{children:"然后你在 docker desktop 里就可以看到它一直在 restart："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"打印了很多次错误日志："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"你可以点击停止，就不会再重启了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这就是 docker 的自动重启功能。"}),"\n",(0,r.jsx)(n.p,{children:"前面说过，pm2 也可以自动重启。"}),"\n",(0,r.jsx)(n.p,{children:"我们试试："}),"\n",(0,r.jsx)(n.p,{children:"新建个 222.Dockerfile:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-docker",children:'FROM node:18-alpine3.14\n\nWORKDIR /app\n\nCOPY ./index.js .\n\nRUN npm install -g pm2\n\nCMD ["pm2-runtime", "/app/index.js"]\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"然后 build 一下，生成镜像："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker build -t restart-test:second -f 222.Dockerfile .\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后跑一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker run -d --name=restart-test-container3 restart-test:second\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时候你会发现容器一直是运行状态，但是内部的进程一直在重启："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"也就是说，Docker 的自动重启功能和 PM2 的自动重启功能是重合的。"}),"\n",(0,r.jsx)(n.p,{children:"那还有必要用 PM2 么？"}),"\n",(0,r.jsx)(n.p,{children:"其实 PM2 诞生的时候是没有 Docker 这种容器技术的，那时候都是直接部署在机器上，这时候自然需要一个进程管理工具来做进程的重启、负载均衡等功能。这是 PM2 当年很流行的原因。"}),"\n",(0,r.jsx)(n.p,{children:"但后来有了 Docker，里面跑的进程崩溃之后，Docker 容器支持自动重启。"}),"\n",(0,r.jsx)(n.p,{children:"所以，大多数情况下，没必要再用 PM2 了。"}),"\n",(0,r.jsx)(n.p,{children:"而且如果你用了 K8S 这种容器编排工具，那更没必要用 PM2 了，直接让 K8S 去调度、重启容器就可以。"}),"\n",(0,r.jsx)(n.p,{children:"但也有另一种说法，Docker 重新跑容器的成本，是比容器内 PM2 重新跑进程的成本高的，所以用 PM2 来管理进程更好一点。"}),"\n",(0,r.jsx)(n.p,{children:"综上，有了 Docker 基本没大有必要用 PM2 了。但如果单独跑 Docker 容器，还是可以结合 pm2-runtime 来提高重启速度的。"}),"\n",(0,r.jsx)(n.p,{children:"然后我们继续来看 Docker 的重启策略："}),"\n",(0,r.jsx)(n.p,{children:"默认是 no，也就是不自动重启。"}),"\n",(0,r.jsx)(n.p,{children:"我们测试了 always，是容器退出时总是重启。"}),"\n",(0,r.jsx)(n.p,{children:"其实还有 on-failure 和 unless-stopped 这两种："}),"\n",(0,r.jsx)(n.p,{children:"on-failure 是只有在非正常退出的时候才重启，相比之下，always 不管是不是非正常退出都重启。"}),"\n",(0,r.jsx)(n.p,{children:"而且 on-failure 还可以指定最多重启几次，比如 on-failure:3 是最多重启三次。"}),"\n",(0,r.jsx)(n.p,{children:"我们试一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker run -d --restart=on-failure:2 --name=restart-test-container4 restart-test:first\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到容器重启了 2 次，一共打印了 3 次错误就不再重启了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再来试试 unless-stopped："}),"\n",(0,r.jsx)(n.p,{children:"unless-stopped 是除非手动停止，否则总是会重启。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker run -d --restart=unless-stopped --name=restart-test-container5 restart-test:first\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到容器一直在重启："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"除非点击停止按钮，也就是执行 docker stop 才会停止："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker stop restart-test-container5\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"那看起来和 always 也没啥区别呀，都是只有手动 stop 才能停止，否则一直重启。"}),"\n",(0,r.jsx)(n.p,{children:"还是有区别的，就是在 Docker Deamon 重启的时候。"}),"\n",(0,r.jsx)(n.p,{children:"现在 docker-test-container2 是用的 always 的重启策略，docker-test-container5 是用的 unless-stopped 的重启策略:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这俩容器都停掉了。"}),"\n",(0,r.jsx)(n.p,{children:"现在我们重启 Docker："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,UklGRgwPAABXRUJQVlA4IAAPAADQVACdASq4AFIBPp1KnkwlpCmlIhPMMTATiWVu3sYUTGHwEhc0ZFGE2zP7XeoDzV/TDvLn7Pexh5cXs/5Ch6R/uncJ/hej39Ee339gz0n3F/M+YH+j8UfUZ6hH5B/PP8dvkOd/6n0AvZX6z/wf1l8rvVc75ewB/Jv5l/vvKk8WTzD2Bv5p/kPQJ/3f876KvqP9m/8Z8hn69f9IovTQY9FfUAKonTje5HW0yHm6pQW83T24EchbC/HSmwqjKpYzhiT2WLBpuC+PymHEP7E1f2s++Qp2x3Glpwlvvvg9JeThDyvGdpEaXLQY9SwS4sPj66l7qNM9wfAblbJl2hRwwpUFcuIPuuUjuiUrQXDTwaPzScvUHOWCdYJ99mCe22x3Vfcru1AbGaVKetobOr0LfjhDT8Xi5+fmvYB+fyIiVLaq3FhXD6ttgB/hZADGrpwplm9UeWgNlSBpCQGcjYSiMHGfg/27J+vGdN2z7cDo1hxP0QKOkAXKif1ZYHT8M0saI3QuS6sJk/YUHzbsAKZbTUqUT+jBzMeyzKuRjeBJdyMHaWFsPc/mgXQNo+I6xaw6BtxssNxGJrM1bDpgtGNTFe8VG6iScauQLOOiF01tP/84Z+qZizzii4Qz2yIRLgK2IZz30alsRU9yDSkRk+Cw1I2oXBu93Z/D4uB8KBD3wdk8bFmR7RbbQs5jZLWSl+QM/FvFBYOm6utg+wKYXswfCCIF+RW44FwjDH/MPybf4EZnAvTsnx7gY/aYKpnYFAfsxuT5xKKi+dWYLLo18Bi46DOCtzCQDtwlD6b6GkIlapoUHrtuYblsTyxurqzb+c2FTFUWkljnFZaBe0BZsg7aZGc8nmb4OXpWJ8+ZV86Lrvu6Or8gAA4gXrf4q8jXjagrC6HI2ZE4e/xPiiTVEYjDKaAA/vpfEWaN//Kyv/w1+e4umED3/9sQdv372TWtSpuOjGeOSU81qvzVUxzHTX2X4A7MuU1V/Aud9XwmE3K0aEUZiiGBl2KJxYMQMrhf9cv642D5IoaK/uVvTy1oE0rhKZraZwI/4JTzmb78tP0a6AhOHmQzO/uFXJN/Mf5gd9FjCbyflKhtnMVRUnHmamRPDc41YtcFcvoYqpyMwPlX17kT9NZHopiuUHKRSjgrRVZYHtkpukOvl/tY85AuTPTxThuKyLVG3Ir1FjkuzZPWKKtqj7JkMFb1a4s/njiE9AnsYTLvV5Noq3Ny44Ywo5/cH2rZ5q7FaAdfj2cplLSQkmHWJW5r4EyuA1Ij9ABl1norMoU7nnhMIs+dxwEqZwUS669YATqMlRRU7P42rTSPaumxJrGCyYTQVSpMOvDbjzcaf79IhXWeMyaSB9nBnke+84SSOpFV5OvwvNEg/ySKUcA8US5GzvwFK7mVh4kfEvFRopX3GYA62zpR6aSMf/wRqClctWVi8Z73T0lSlbH/9PBHNdVV/V7mxlTrza4GiWJ1tBdol9m46031c2LvZA/mrF640dmxeVGKbf8q0WKoxs7c+kBCioTvxFSFdkQrC1bZavFh5rzjzXBG0o7cMpnmDroQMJ+aR+iXQjbVm8D6wf2tIwYMDDobdcA4mgS2Cy58vXJW5Sjr+2QZ6Eps8v4J9c5S/nBaPojUclQWgIBdC6Yun51Z0LNCEvi/QWwvIzgBo7uMZN0O19WXr4ncW/+p7+ByoC5ns8XjwovS4k8lrWYgeQk1UtP7xTCRQhztbCtLlWoHvetDMia67kt6tf+wH5JqFxs9ZBFT4suv/o329KQ4qglh1w+t3gf4kZY9leq2th0qcKWoDG99trRCu1Ewy4uH1yRmZe5zrKq9UPO82D4d6ZAKB4xZvBRUR+a5gkfUuILH1iGT70/yQnZKLDahX3UsS6ER0WOWr0vqlpK6bXOAUUKpGsbsXtPyoE2OiQjCyAP77RRtvdB16QfcLOzvK/CVw6eGjzMpDc60NAs9aQFUdgDpybTcFagnikQcMRVGBNK29ybzFcRsDB9trzXjrv6NtVvbSk2CZPoBYQoz3RGhbUib/8EpnR/UIUYgfrhssK87H183EXUDBW+2RUd8qlfWU8L7nE4VvEhH7kxHDQ3/fxpZ5AAPcUOafWuH8hf1dcPLQzgZP1ZE1X69UyTKI/YTAe4A5W9ERH58F+BFZ8i/mrlvtNSI2Rwg5qY0vLn4Yw/KQqepy2LetX0gsGZWRr4GX+baiyzfXkuq4PcVYdl07id2YyrS1Dfh5pCf1xaVAQcq/+uYbcxRTm0yzbXt63lbm9fLKnY5PloSLxO8BZ0afR79k3s/G5T7pEjEP2ldfUQsRKfRfsniYXZdhutjk/UFlQU/+4mP4DS6vWiA+a4zx1VABq9v+8rGE5a0t4pmZKArTG0Fe1WhM6JQxyD5phQJl/eMvQCwetgNT9D5zDl/VOC+RVAn0nJiNUdX3xgaOOI9E+RmVrVckh/ehV69L4FBBgZwiutNQBHJcEP+RnLArBqJbJPmpEyyBGpWP44QlQ+7xst0Gwqok7auj8XjKNvlvomAZshXUZmKWxxwPhEeWK1PUF9prFAtEBovU5AT6ZVIT0jIjFph7fn/fddOYgeL1yzYnpGHP6mvt+8QD+Fl7X7pkDPkVB561zimv00iC0ePNccMILdKXKOne4l1fXk+6UHlGtSFXxbH+pUY3/xq2QqvE92R6o3MTKmsALOZFrqHSvhleq2efRQz0bxe8u2mTX1Il+EJRDFjCzRHMlCr0mc4f/Y5Yq/b1/SGW12Z5nE8lRfl+2CM7fjsWRqcryc4zyrdCcCHft15LEM1MFxN4zpoLNpSCKZ2lK29K18cBTRA8M1jzar4dtjx41OfibTOxZZZDPy40TCzZNOSjE3u6K0E/9clbBZbv78VfWkJghffPI56UqoM9PonPE/fwU0TI80vYfp8NnV4dAAemTVGkJnzRZ1LhK1DfSWj8/MuHT4cmNpmMFLWclhZ4QasFMmeOxRCE2jboXuNBMHxOk7DnOOLhVRTRVpz7YL3G2vUsRBx/simvIHfomoEfie0mJm3L6ohZ2rcZXit1XOIzqcRMFei4OAqL/NndUkWMleG7SfZtYxOfFiN+DHSnK6xLIcxP9a3bUioW9jr/295WXywHSQGVXeWVnhJq6r1FIiDnBQiJrIfJkx7fvEOlr6aNP4AueUdKi96V5k19OtA5l0Mn8AwH4dKNkZq73sOmJB8z67dZ9qgBrmNNFaKxdbsvY2NaoF7MJpyN5qaA4R1CDqluFwondXcdUAJE0ciG/Fl/OlRb5Fus+5pmeH21mu0gi6lgtKCvThIAbnqsTjhOOOPSSmcPYxNMdFG93IOnY564npilGzL7gaAXJoUuRXu7GcMg3g1vEI3WWXZ7xiorwsBAwMCxVrSRZzXc30xvX6PXNWJLYVz+mES0fKkDk5Q2aBT6Wd5kPUG+F3qtXKw+QGP7oMAqMMYFLc9AaPmuZAJws87cVKoN3kXOp3yF4FfHlBYcCOZ4g8ybtLI4HX6d0qVyDPBps7460q7iFNg+/AVRLimeImo1dhQS1dc0g/09Rf/ug8vEbQVbnUc+pmAbRm4TR0l3NX1Oe1aiBDErucEpNcv2um+nqTz0Auf1L2yXhVy3l5uddJFgC86cdVsZ7Frg6a/qezqOapq/cQlnT253vrs6VW65Pz4qv1RFqp0LU3oQrGOKJNrzfBaUM6YiLxzQlsfvA5a+CZDd5QH2eCeIj0FZugzWqQ16vcW8iZisjxAZj3uMuNjPKH8KN+JkvPIxX1TVbkBrtNpO0aFfe2ahJulursOCniyy8nA2vyYv+n06Ug487xO3jiOBMjSnHLtpD+1N4Yo0KV8Q8d49tZIvJUvMy5FyEkJ0GYkhjb12ixiIEDMhjuEn6dvU08hOcRio+2pfa3qt+VVTca/LzirFIUrpHGpNQ/kxSFReFhorilyI36+O4iSVdQLsYreARRx9we3M7jzzoi6IuHvDwUbzv5bvudMWIJ8ljA8l56kQAlOoD/84t/R9PIoEgz0JpZZWX5CvtKGp9vUPVgJjhYYTAFZvSJX1dcYBGH2Lm4VDciJ2yYToKxNXnb17RtfCOOmOiz15nhSzM58UnBwLvOvYOGkYzAptXHAiA71YtLAtZUulP0F2Lov5Yiv/7x0VnslWccvinMMWFo2WdF0ZjSqw5uTF4dT9ivdfjA0HSxFqYBgkP0MOQ8dI7b0lvLZM575ftKBxF+kgwL7Im9inMEso4b5UHnzrwspOyfez+0iW847u1aIZq0YIIuE5t+NLx3nMz7oKX/Knrd1TSSnlV1NqfyPtZYaPTJ6qk4Tpfw+vOd1/VLd3KwgQcoyVzlzNkwW24uDulDv0uJ2rDJ6+RYyO6rMaztQDXw2bf2NrzQONkzQ6DwUgI/pfmM9ltgxRqzXbPhoUJL4QYdRMgXLNznHjVfAhoVCRV5Iw7xAnGoaiPnOO1zFlKThkeu2LTEC4FRjuqr3c9KoGUKcckQklZF5RmoLDviawTgBm67Dy49U3/2+ZX0PhJ6P2AxYgv/Q9bvRQgz6AZYHxyFfrTd7/tB5lX8K+JmI/jmmu2v73X2ok7p1mXKNtCSWNQiCKX8vxxKcWmHbuZeVC1XUbqhr6EQcEGJ2v5HKwwCuHOAJ6py8NfhIfoNGwzX7ToYqqbVIo8OvUIOKMNyvZnIIxcOuZEnCX1i4OsVh7rpZKMtTbdaobKCH5/dRw91Pkl6b/4vYy3H5AGu8IWn3ZSuCZ/UG9W+zJJwsqg1HRfwrEM/Qb83a7hqFEgGQWefI/n+R2ZkgN5XTp7K3uIw2KUoYsdAT7QUGVZR5sax+bUr3xSuXlx/KTY/ovxmlJkXtG7q54QOXNp3SjFFHEwqhwmMD/6j0YaqFSQT+eBo4yWnwDMB9WFBiiTRg8gh+io1W/EKnYRpkWnW7g9bTox2kD+LpgVbv31Rbp+5HMcrhmMist4uD9uT85uL2lcGtjxyMdSboGCKo1lbw+0z7bhj+aOzawyfENALQ8azAaO9fQ0gaKDQ2tfyUUBHmdTaXdZt01HNuy5cCmpA1WSsdEGnluXwIbwLEBUOqMmgIaj6h/9R/z8dgf1QauS4Q4ot3pTtPefhy8CL1WDXdaCqeeOpU7YSFHzYflYAAAAA=",alt:"image.png"})}),"\n",(0,r.jsx)(n.p,{children:"他会重启跑 Docker Engine ，也就是 Docker Deamon 的后台进程。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:"image.png"})}),"\n",(0,r.jsx)(n.p,{children:"这时候你会发现，always 重启策略的容器又跑起来了，而 unless-stopped 的容器没有重启。这就是这俩的区别："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:"image.png"})}),"\n",(0,r.jsx)(n.p,{children:"Docker Compose 是用于同时跑多个 Docker 容器的，它自然也支持 restart 的配置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["案例代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/docker-restart-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Docker 是支持自动重启的，可以在 docker run 的时候通过 --restart 指定重启策略，或者 Docker Compose 配置文件里配置 restart。"}),"\n",(0,r.jsx)(n.p,{children:"有 4 种重启策略："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"no: 容器退出不自动重启（默认值）"}),"\n",(0,r.jsx)(n.li,{children:"always：容器退出总是自动重启，除非 docker stop。"}),"\n",(0,r.jsx)(n.li,{children:"on-failure：容器非正常退出才自动重启，还可以指定重启次数，如 on-failure:5"}),"\n",(0,r.jsx)(n.li,{children:"unless-stopped：容器退出总是自动重启，除非 docker stop"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"重启策略为 always 的容器在 Docker Deamon 重启的时候容器也会重启，而 unless-stopped 的不会。"}),"\n",(0,r.jsx)(n.p,{children:"其实我们用 PM2 也是主要用它进程崩溃的时候重启的功能，而在有了 Docker 之后，用它的必要性就不大了。"}),"\n",(0,r.jsx)(n.p,{children:"当然，进程重启的速度肯定是比容器重启的速度快一些的，如果只是 Docker 部署，可以结合 pm2-runtime 来做进程的重启。"}),"\n",(0,r.jsx)(n.p,{children:"绝大多数情况下，直接用 Docker 跑 node 脚本就行，不需要 PM2。"})]})}function R(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(P,{...e})}):P(e)}let K=R;R.__RSPRESS_PAGE_META={},R.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F78.%20Docker%20%E6%94%AF%E6%8C%81%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5%EF%BC%8C%E6%98%AF%E5%90%A6%E8%BF%98%E9%9C%80%E8%A6%81%20PM2.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"78. Docker 支持重启策略，是否还需要 PM2",headingTitle:"78. Docker 支持重启策略，是否还需要 PM2",frontmatter:{}}}}]);