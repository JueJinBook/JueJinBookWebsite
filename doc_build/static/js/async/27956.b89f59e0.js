"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["27956"],{362401:function(e,n,c){c.r(n),c.d(n,{default:()=>X});var s=c(552676),p=c(740453);let i=c.p+"static/image/e87c87dcdbcfc95ccf363744a8b35b4e.5a64367b.webp",d=c.p+"static/image/492c2dbd18f08c4412e760cad7614624.719625a2.webp",r=c.p+"static/image/1e102f182befd78f7837206c47ce6d1b.eeb51d82.webp",l=c.p+"static/image/0fbb79400a5857de71f118c010e6ebbe.4160e9c7.webp",a=c.p+"static/image/764a64b865555ed5e4e4c94dbbbc3cb1.c0638513.webp",x=c.p+"static/image/507c29c9b684b014789407d5957fa4c3.298bcffc.webp",t=c.p+"static/image/af77597ae61952320177254089c19418.06ae380f.webp",j=c.p+"static/image/ba8736f441597d53f2cd890eee9aebf7.575e6467.webp",h=c.p+"static/image/36974911333d312ae2e31b7861891bb8.b4e7efd2.webp",m=c.p+"static/image/72a05d9803eff35e93476344f9ce8941.df60c086.webp",b=c.p+"static/image/28196b866f5b4929548174966fb1cafa.a1e3a64b.webp",o=c.p+"static/image/4e584b67d06652229e57e3fbceaedd11.ded624fa.webp",g=c.p+"static/image/01b36467825e92ede38a3d3324b76672.f7765688.webp",f=c.p+"static/image/59b3e3c3e7ed6c6c03bf678648b45b1c.03c2e294.webp",E=c.p+"static/image/f08da1abb10861c294c466d23a04327c.23f239ff.webp",u=c.p+"static/image/ea3431f4d9485bdd337d6f0ebb9ba5af.7b675695.webp",k=c.p+"static/image/3c7e639726fa588d382965c657ecfde5.7c123231.webp",w=c.p+"static/image/6ad8a0540fb3c6d415cbf84db5c24719.abf64c00.webp",A=c.p+"static/image/c930dda18b63a08350790cfd772e3638.53dd146e.webp",R=c.p+"static/image/43585c9bbe049915611ba01d1273dd4f.efebd7b4.webp",v=c.p+"static/image/cf61350b2a741b973cf28fd7f18a9c68.8f0b316a.webp",y=c.p+"static/image/c160fefb0145589ab8f156d3aa2d703e.a9373b5b.webp",B=c.p+"static/image/bbb1adf54de8903675907e3c39922e85.73d86fde.webp",Y=c.p+"static/image/95936c68abd186e59cab225ead2b9734.e0c149cd.webp",D=c.p+"static/image/ffc8901579783e9225a8c6dcca23b215.bd24aa0f.webp",P=c.p+"static/image/6019187db1d52c53e5d3686ef7a6b5c3.8a1e60a7.webp",T=c.p+"static/image/ae3bf8132518fdb0d85e4b4fd970bc55.08d142f6.webp",Z=c.p+"static/image/2ee8d1bb1c79e1589a147ae12c623c76.2bc3ebce.webp",M=c.p+"static/image/79027487fe54a43373adf177bd842413.7c46ffaa.webp",J=c.p+"static/image/81fb693a2e3cc7262d02bcfdf5a22f05.0ca7d061.webp",Q=c.p+"static/image/c2a50b4929c175292258b83346942b12.4495e919.webp",V=c.p+"static/image/ca17451013ebc9547420b32e65db61b9.97d1ca63.webp",N=c.p+"static/image/1c66c45dcfdb2df72caff4ec68a39604.8db29c8f.webp";function S(e){let n=Object.assign({p:"p",strong:"strong",pre:"pre",code:"code",img:"img",a:"a",h2:"h2"},(0,p.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"前面我们都是 node 直接跑的 Nest 应用，但生产环境我们不会直接跑 node，而会用 pm2 来跑。"}),"\n",(0,s.jsx)(n.p,{children:"为什么要用 pm2 呢？它解决了啥问题？"}),"\n",(0,s.jsx)(n.p,{children:"想一下："}),"\n",(0,s.jsx)(n.p,{children:"如果你的 node 应用跑的时候突然抛了个错，崩溃了，是不是需要重新跑起来？"}),"\n",(0,s.jsx)(n.p,{children:"这时候是不是就需要另一个进程来自动做重启这件事情？"}),"\n",(0,s.jsx)(n.p,{children:"node 应用的日志默认输出在控制台，如果想输出到不同的日志文件，是不是可以让另一个进程获取 node 应用的输出，然后写文件来实现？"}),"\n",(0,s.jsx)(n.p,{children:"node 是单线程的，而机器是多个 cpu 的，为了充分利用 cpu 的能力，我们会用多个进程来跑 node 应用，这种通用逻辑是不是也可以放到一个单独进程里来实现？"}),"\n",(0,s.jsx)(n.p,{children:"node 运行时的 cpu、内存等资源的占用，是不是需要监控？这时候是不是可以让另一个进程来做？"}),"\n",(0,s.jsx)(n.p,{children:"线上的 node 应用不只是跑起来就行了，还要做自动重启、日志、多进程、监控这些事情。"}),"\n",(0,s.jsx)(n.p,{children:"而这些事情，都可以用 pm2 来做。"}),"\n",(0,s.jsx)(n.p,{children:"pm2 是 process manager，进程管理，它是第二个大版本，和前一个版本差异很大，所以叫 pm2."}),"\n",(0,s.jsxs)(n.p,{children:["pm2 的主要功能就是",(0,s.jsx)(n.strong,{children:"进程管理、日志管理、负载均衡、性能监控"}),"这些。"]}),"\n",(0,s.jsx)(n.p,{children:"我们分别来看一下："}),"\n",(0,s.jsx)(n.p,{children:"首先安装 pm2:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm install -g pm2\n"})}),"\n",(0,s.jsx)(n.p,{children:"然后跑一个 node 应用，我这里跑一个 Nest 的应用："}),"\n",(0,s.jsx)(n.p,{children:"直接 node 跑是这样的，日志打印在控制台："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"而用 pm2 的话，就可以这样跑："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start ./dist/main.js\n"})}),"\n",(0,s.jsx)(n.p,{children:"它会把这个 node 进程跑起来，然后管理起来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:V,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"管理起来之后，就有我们上面说的那些功能了，比如自动重启、日志管理、性能监控等。"}),"\n",(0,s.jsx)(n.p,{children:"首先看下日志，执行"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 logs\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Q,alt:"i"})}),"\n",(0,s.jsx)(n.p,{children:"可以看到 pm2 会把所有进程的日志打印出来，通过前面的“进程id|进程名字”来区分，比如 0|main。"}),"\n",(0,s.jsx)(n.p,{children:"而且，它会把它写到日志文件里，在 ~/.pm2/logs 下，以“进程名-out.log”和“进程名-error.log”分别保存不同进程的日志："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:J,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"比如 main-out.log 里保存了 main 进程的正常日志，而 main-error.log 里保存了它的报错日志："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:M,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们再跑一个进程试试："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Z,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"现在有两个进程了，pm2 logs 可以看到这两个进程的日志："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:T,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"也可以"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 logs 进程名\npm2 logs 进程id\n"})}),"\n",(0,s.jsx)(n.p,{children:"这样查看单个进程的日志："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这就是 pm2 的日志管理的功能。"}),"\n",(0,s.jsx)(n.p,{children:"进程管理的话就是可以手动启动、重启、停止某个进程，而且崩溃了会自动重启，也可以定时自动重启。"}),"\n",(0,s.jsx)(n.p,{children:"只需要 pm2 start 的时候带上几个选项就好了："}),"\n",(0,s.jsx)(n.p,{children:"超过 200M 内存自动重启："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start xxx --max-memory-restart 200M\n"})}),"\n",(0,s.jsx)(n.p,{children:"从 2s 开始每 3s 重启一次："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'pm2 start xxx --cron-restart "2/3 * * * * *"\n'})}),"\n",(0,s.jsx)(n.p,{children:"当文件内容改变自动重启："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start xxx --watch\n"})}),"\n",(0,s.jsx)(n.p,{children:"不自动重启："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start xxx --no-autorestart\n"})}),"\n",(0,s.jsx)(n.p,{children:"我们分别试一下："}),"\n",(0,s.jsx)(n.p,{children:"把之前的进程删掉："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 delete 0\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们指定 1k 内存就重启："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start xxx --max-memory-restart 1K\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后在 nest 代码里用超过 1k 的内存："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"先把之前的日志清空，使用 pm2 flush 或者 pm2 flush 进程名|id"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"确实清空了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"访问下这个 controller："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"查看 main 进程的前 100 行日志："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 logs main --lines 100 \n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"明显看到重启了。"}),"\n",(0,s.jsx)(n.p,{children:"这是超过内存的自动重启。"}),"\n",(0,s.jsx)(n.p,{children:"崩溃的自动重启、定时自动重启、文件变动自动重启等也是类似 。"}),"\n",(0,s.jsx)(n.p,{children:"我们前面用到的 pm2 start、pm2 stop、pm2 restart、pm2 delete 等就是进程管理的功能。"}),"\n",(0,s.jsx)(n.p,{children:"再就是负载均衡，node 应用是单进程的，而为了充分利用多核 cpu，我们会使用多进程来提高性能。"}),"\n",(0,s.jsx)(n.p,{children:"node 提供的 cluster 模块就是做这个的，pm2 就是基于这个实现了负载均衡。"}),"\n",(0,s.jsx)(n.p,{children:"我们只要启动进程的时候加上 -i num 就是启动 num 个进程做负载均衡的意思。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 start app.js -i max \npm2 start app.js -i 0\n"})}),"\n",(0,s.jsx)(n.p,{children:"这俩是启动 cpu 数量的进程。"}),"\n",(0,s.jsx)(n.p,{children:"用多进程的方式跑 nest 应用："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到启动了 8 个进程，因为我是 8 核 cpu。"}),"\n",(0,s.jsx)(n.p,{children:"跑起来之后，还可以动态调整进程数，通过 pm2 scale："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 scale main 3\n"})}),"\n",(0,s.jsx)(n.p,{children:"我把 main 的集群调整为 3 个进程："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到 pm2 删除了 5 个，留下了 3 个。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 scale main +3\n"})}),"\n",(0,s.jsx)(n.p,{children:"我又加了 3 个，现在变成了 6 个："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以动态伸缩进程的数量，pm2 会把请求分配到不同进程上去。"}),"\n",(0,s.jsx)(n.p,{children:"这就是负载均衡功能。"}),"\n",(0,s.jsx)(n.p,{children:"此外，还有个性能监控功能，执行 pm2 monit:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pm2 monit\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到不同进程的 cpu 和内存占用情况。"}),"\n",(0,s.jsx)(n.p,{children:"大概就是这些功能，但是当进程多了之后，难道都要手动通过命令行来启动么？"}),"\n",(0,s.jsx)(n.p,{children:"肯定不会每次都敲一遍。"}),"\n",(0,s.jsx)(n.p,{children:"pm2 支持配置文件的方式启动多个应用。"}),"\n",(0,s.jsx)(n.p,{children:"执行 pm2 ecosystem，会创建一个配置文件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"apps 部分就是配置应用的，scripts 就是应用的启动路径："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"它可以指定的配置非常多，基本就是命令行有啥选项，这里就有啥属性："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后 pm2 start ecosystem.config.js 就可以批量跑一批应用。"}),"\n",(0,s.jsx)(n.p,{children:"就相当于 pm2 根据配置文件自动执行这些命令，不用我们手动敲了。"}),"\n",(0,s.jsx)(n.p,{children:"这样，我们就可以把启动的选项保存在配置文件里。"}),"\n",(0,s.jsx)(n.p,{children:"最后，还有个 pm2 plus，这个是收费功能，看看就行："}),"\n",(0,s.jsx)(n.p,{children:"访问 pm2 的网站，登录，创建 bucket："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后在本地执行 pm2 link xxx xxx，把本地的 pm2 和那个网站关联起来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再执行 pm2 plus 就会打开 bucket 对应的网页："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以在线监控你的应用："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"下面这些 plus 的功能都是收费的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"一般也不需要用，用免费的本地功能就好了。"}),"\n",(0,s.jsx)(n.p,{children:"有同学说，不都是 docker 部署了么？还需要 pm2 么？"}),"\n",(0,s.jsx)(n.p,{children:"当然需要了，万一 docker 容器内 node 服务崩溃了，是不是需要重启？"}),"\n",(0,s.jsx)(n.p,{children:"docker 容器内的进程同样有日志管理、进程管理和监控的需求。"}),"\n",(0,s.jsxs)(n.p,{children:["一般都是 ",(0,s.jsx)(n.a,{href:"https://github.com/Unitech/pm2/blob/master/examples/docker-pm2/Dockerfile",target:"_blank",rel:"noopener noreferrer",children:"docker 镜像"}),"内安装 pm2 来跑 node："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"之前我们写的 Nest 的 dockerfile 是这样的："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-docker",children:'# 44. 为什么 Node 应用要用 PM2 来跑？\nFROM node:18 as build-stage\n\nWORKDIR /app\n\nCOPY package.json .\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install\n\nCOPY . .\n\nRUN npm run build\n\n# production stage\nFROM node:18 as production-stage\n\nCOPY --from=build-stage /app/dist /app\nCOPY --from=build-stage /app/package.json /app/package.json\n\nWORKDIR /app\n\nRUN npm install --production\n\nEXPOSE 3000\n\nCMD ["node", "/app/main.js"]\n'})}),"\n",(0,s.jsx)(n.p,{children:"现在要改成这样："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"就是多装一个 pm2，然后用 pm2 代替 node 来跑。"}),"\n",(0,s.jsx)(n.p,{children:"我们 docker build 一下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"docker build -t nest:ccc .\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:a,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"把它跑起来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这个就是 pm2 打印的日志。"}),"\n",(0,s.jsx)(n.p,{children:"你可以在 terminal 使用 pm2 的命令："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"现在这个容器内的 node 进程在崩溃时就会自动重启。"}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"服务器上的 node 应用需要用 pm2 的日志管理、进程管理、负载均衡、性能监控等功能。"}),"\n",(0,s.jsx)(n.p,{children:"分别对应 pm2 logs、pm2 start/restart/stop/delete、pm2 start -i、pm2 monit 等命令。"}),"\n",(0,s.jsx)(n.p,{children:"多个应用或者想把启动选项保存下来的时候，可以通过 ecosystem 配置文件，批量启动一系列应用。"}),"\n",(0,s.jsx)(n.p,{children:"我们会把 docker 和 pm2 结合起来，在进程崩溃的时候让 pm2 来自动重启。"}),"\n",(0,s.jsx)(n.p,{children:"只要写 dockerfile 的时候多安装一个 pm2 的依赖，然后把 node 换成 pm2-runtime 就好了。"}),"\n",(0,s.jsx)(n.p,{children:"不管是出于稳定性、性能还是可观测性等目的，pm2 都是必不可少的。"})]})}function G(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,p.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(S,{...e})}):S(e)}let X=G;G.__RSPRESS_PAGE_META={},G.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F44.%20%E4%B8%BA%E4%BB%80%E4%B9%88%20Node%20%E5%BA%94%E7%94%A8%E8%A6%81%E7%94%A8%20PM2%20%E6%9D%A5%E8%B7%91%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);