"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["22595"],{858123:function(e,n,a){a.r(n),a.d(n,{default:()=>G});var r=a(552676),c=a(740453);let t=a.p+"static/image/1dff74e882b34dd0e014844311836125.4a18fac3.webp",s=a.p+"static/image/5a70672a95b11342b353a4f6c620ca69.03005c24.webp",i=a.p+"static/image/25bcc8c0b7b135674745ed5d348d358e.306643af.webp",d=a.p+"static/image/91cc1d675e6bb11b3759908a050a3aff.54ea6e32.webp",p=a.p+"static/image/7cde08d63682085f4c9587b7485269d7.0234d136.webp",l=a.p+"static/image/d7466a90a386ac92dfdaab384babef3c.f467a67f.webp",x=a.p+"static/image/003c1666eabaefd8d3541ae75c877bbf.98e5b123.webp",j=a.p+"static/image/e1e147afdfff326f0aab34bc173174d4.ee68e530.webp",o=a.p+"static/image/18952b55badebb2724bde5a48c1ede28.dd0e948e.webp",m=a.p+"static/image/ccaa8f6e813594b49a7017ce3f194a73.25fbc31e.webp",h=a.p+"static/image/e5b1236b918a32c7221404e01d999013.ffd7bd80.webp",b=a.p+"static/image/b4ca1174f15943f6e8835643e649a22f.3ce7240b.webp",g=a.p+"static/image/9dbd08535dd67996edb017b53bd07ff2.42dec47d.webp",f=a.p+"static/image/6f3cb19ff79d6652de4128433df74b9f.9183d6ae.webp",u=a.p+"static/image/99b1b8d44af2c6ab8d234d4f77f39bd9.c7c1d3ce.webp",w=a.p+"static/image/682df33f63d1948c2f5decaec9649891.c1610abe.webp",A=a.p+"static/image/ea8760676a61185bbcf5129a0124f099.c1d89297.webp",v=a.p+"static/image/80c04fb7eae15214ad79671f5a97ab41.79c9969e.webp",E=a.p+"static/image/f567d99f3d2e824f99857b0a47ba2841.fba9cb47.webp",X=a.p+"static/image/15aa753af642e50c564872df2b05d486.47c45883.webp",P=a.p+"static/image/0d123bc2521da322b7613e3e994e4965.530efd79.webp",Q=a.p+"static/image/777b762f273cebbbc2a6327113980888.c1801079.webp";function R(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,c.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"12-nest-如何自定义装饰器",children:["12. Nest 如何自定义装饰器",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#12-nest-如何自定义装饰器",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Nest 内置了很多装饰器，大多数功能都是通过装饰器来使用的。"}),"\n",(0,r.jsx)(n.p,{children:"但当这些装饰器都不满足需求的时候，能不能自己开发呢？"}),"\n",(0,r.jsx)(n.p,{children:"装饰器比较多的时候，能不能把多个装饰器合并成一个呢？"}),"\n",(0,r.jsx)(n.p,{children:"自然是可以的。"}),"\n",(0,r.jsx)(n.p,{children:"很多内置装饰器我们都可以自己实现。"}),"\n",(0,r.jsx)(n.p,{children:"我们来试试看："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new custom-decorator -p npm\n"})}),"\n",(0,r.jsx)(n.p,{children:"创建个 nest 项目。"}),"\n",(0,r.jsx)(n.p,{children:"执行"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g decorator aaa --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:"创建个 decorator。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这个装饰器就是自定义的装饰器。"}),"\n",(0,r.jsx)(n.p,{children:"之前我们是这样用的 @SetMetadata"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后加个 Guard 取出来做一些判断："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g guard aaa --flat --no-spec\n"})}),"\n",(0,r.jsx)(n.p,{children:"guard 里使用 reflector 来取 metadata："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Observable } from 'rxjs';\n\n@Injectable()\nexport class AaaGuard implements CanActivate {\n  @Inject(Reflector)\n  private reflector: Reflector;\n\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n\n    console.log(this.reflector.get('aaa', context.getHandler()));\n\n    return true;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"加到路由上："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:X,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsxs)(n.p,{children:["然后访问 ",(0,r.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 可以看到打印的 metadata"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"但是不同 metadata 有不同的业务场景，有的是用于权限的，有的是用于其他场景的。"}),"\n",(0,r.jsx)(n.p,{children:"但现在都用 @SetMetadata 来设置太原始了。"}),"\n",(0,r.jsx)(n.p,{children:"这时候就可以这样封装一层："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"装饰器就可以简化成这样："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"还有，有没有觉得现在装饰器太多了，能不能合并成一个呢？"}),"\n",(0,r.jsx)(n.p,{children:"当然也是可以的。"}),"\n",(0,r.jsx)(n.p,{children:"这样写："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { applyDecorators, Get, UseGuards } from '@nestjs/common';\nimport { Aaa } from './aaa.decorator';\nimport { AaaGuard } from './aaa.guard';\n\nexport function Bbb(path, role) {\n  return applyDecorators(\n    Get(path),\n    Aaa(role),\n    UseGuards(AaaGuard)\n  )\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"在自定义装饰器里通过 applyDecorators 调用其他装饰器。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这三个 handler 的装饰器都是一样的效果。"}),"\n",(0,r.jsx)(n.p,{children:"这就是自定义方法装饰器。"}),"\n",(0,r.jsx)(n.p,{children:"此外，也可以自定义参数装饰器："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { createParamDecorator, ExecutionContext } from '@nestjs/common';\n\nexport const Ccc = createParamDecorator(\n  (data: string, ctx: ExecutionContext) => {\n    return 'ccc';\n  },\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"先用用看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"大家猜这个 c 参数的值是啥？"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"没错，就是 ccc，也就是说参数装饰器的返回值就是参数的值。"}),"\n",(0,r.jsx)(n.p,{children:"回过头来看看这个装饰器："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"data 很明显就是传入的参数，而 ExecutionContext 前面用过，可以取出 request、response 对象。"}),"\n",(0,r.jsx)(n.p,{children:"这样那些内置的 @Param、@Query、@Ip、@Headers 等装饰器，我们是不是能自己实现了呢？"}),"\n",(0,r.jsx)(n.p,{children:"我们来试试看："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { createParamDecorator, ExecutionContext } from '@nestjs/common';\nimport { Request } from 'express';\n\nexport const MyHeaders = createParamDecorator(\n  (key: string, ctx: ExecutionContext) => {\n    const request: Request = ctx.switchToHttp().getRequest();\n    return key ? request.headers[key.toLowerCase()] : request.headers;\n  },\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"通过 ExecutionContext 取出 request 对象，然后调用 getHeader 方法取到 key 对应的请求头返回。"}),"\n",(0,r.jsx)(n.p,{children:"效果如下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"分别通过内置的 @Headers 装饰器和我们自己实现的 @MyHeaders 装饰器来取请求头，结果是一样的。"}),"\n",(0,r.jsx)(n.p,{children:"再来实现下 @Query 装饰器："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"export const MyQuery = createParamDecorator(\n    (key: string, ctx: ExecutionContext) => {\n        const request: Request = ctx.switchToHttp().getRequest();\n        return request.query[key];\n    },\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"用一下试试看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"和内置的 Query 用起来一毛一样！"}),"\n",(0,r.jsx)(n.p,{children:"同理，其他内置参数装饰器我们也能自己实现。"}),"\n",(0,r.jsx)(n.p,{children:"而且这些装饰器和内置装饰器一样，可以使用 Pipe 做参数验证和转换："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"知道了如何自定义方法和参数的装饰器，那 class 的装饰器呢？"}),"\n",(0,r.jsx)(n.p,{children:"其实这个和方法装饰器的定义方式一样："}),"\n",(0,r.jsx)(n.p,{children:"比如单个装饰器："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到自定义装饰器生效了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"也可以通过 applyDecorators 组合多个装饰器："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 guard 里加一条打印："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:s,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到 metadata 也设置成功了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["案例代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/custom-decorator",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"内置装饰器不够用的时候，或者想把多个装饰器合并成一个的时候，都可以自定义装饰器。"}),"\n",(0,r.jsx)(n.p,{children:"方法的装饰器就是传入参数，调用下别的装饰器就好了，比如对 @SetMetadata 的封装。"}),"\n",(0,r.jsx)(n.p,{children:"如果组合多个方法装饰器，可以使用 applyDecorators api。"}),"\n",(0,r.jsx)(n.p,{children:"class 装饰器和方法装饰器一样。"}),"\n",(0,r.jsx)(n.p,{children:"还可以通过 createParamDecorator 来创建参数装饰器，它能拿到 ExecutionContext，进而拿到 reqeust、response，可以实现很多内置装饰器的功能，比如 @Query、@Headers 等装饰器。"}),"\n",(0,r.jsx)(n.p,{children:"通过自定义方法和参数的装饰器，可以让 Nest 代码更加的灵活。"})]})}function y(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(R,{...e})}):R(e)}let G=y;y.__RSPRESS_PAGE_META={},y.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F12.%20Nest%20%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A3%85%E9%A5%B0%E5%99%A8.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"12. Nest 如何自定义装饰器",headingTitle:"12. Nest 如何自定义装饰器",frontmatter:{}}}}]);