"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["43350"],{865031:function(e,n,r){r.r(n),r.d(n,{default:()=>P});var i=r(552676),a=r(740453);let s=r.p+"static/image/1d7138037d2652510af0a5be4d95f3e5.0f6ea10e.webp",c=r.p+"static/image/53c961276a2c59ae8fdc394ace7c8e58.aad1e62e.webp",t=r.p+"static/image/8bbe8331a40c607a2db710b1b12857a1.4f2f3278.webp",d=r.p+"static/image/02eb4e1b2f0f050e456284b27f6c57b3.dcb7522f.webp",o=r.p+"static/image/60ce5e04bf257460ff13c68645d31760.179c847c.webp",p=r.p+"static/image/e50b6b3cd81596c6c8894c684ef05e1e.3d71f998.webp",l=r.p+"static/image/7e5e21bb2c674f3440975a404eda37be.d7985123.webp",m=r.p+"static/image/224ca0cf66c505bff1720250f0e97ef1.6229523c.webp",x=r.p+"static/image/b50f87d8e4b77b4df546d82fc43ecfac.772fb03e.webp",g=r.p+"static/image/495b875d301b9cd7fe13f77d2673bcca.ceff9b85.webp",h=r.p+"static/image/076346e7c2b11c64ae97486dfc5872ff.42fbdcad.webp",j=r.p+"static/image/9b44ca0d510d965c06f8fa2f0685b899.844e66ed.webp",b=r.p+"static/image/2b7958ebc5612be0f8814ca63a5caa81.980a71a8.webp",u=r.p+"static/image/5776a66543987d52ca31fd5eabc582f2.f23838e9.webp",f=r.p+"static/image/da0d0138de7555e343e374b05a66b225.629ba7a7.webp",y=r.p+"static/image/0c9ffe83da1a99383bb075767e37ff5c.d9536438.webp",q=r.p+"static/image/dc27e4fa73ee7b61dc56be5bbe410061.02941339.webp",E=r.p+"static/image/adcd8a3e613f1b0a70c49a7eb5cc8866.d88817a3.webp",L=r.p+"static/image/c46936c9fa5507012e62847f56768946.bbc99e12.webp",N=r.p+"static/image/fc5e6e2ec5a1987a17ac9a8e24de7459.c7e080f9.webp",w=r.p+"static/image/7c43609f4852386fd29d0bcd5103d5e4.2a7cf072.webp",R=r.p+"static/image/aa4a2ad89630cf60b7714a5468c2d573.3158f69a.webp",_=r.p+"static/image/c71e0ca94511acbb8a285ff35096fe2a.1b91a4af.webp",T=r.p+"static/image/35e33feb401b89145c756d31bc0e9e29.cb5db52a.webp",U=r.p+"static/image/4c02c53ecca7ea36b45a999594ef2137.4a9f5eab.webp",A=r.p+"static/image/42a62748543f6017a9dc67a9f10d6219.6fdf4c6c.webp",I=r.p+"static/image/9eea8579e60c70e5492f47ca31f0c959.a1a040ac.webp",S=r.p+"static/image/915de686ee5b8fc55b30f55916514293.2392fcc7.webp",v=r.p+"static/image/b5330e6d42c329ca972db7915cbbdefc.a599a07d.webp",k=r.p+"static/image/dfd737c4b0ba90b5d0a6a0bc9762303d.66d1a3d5.webp",B=r.p+"static/image/2e87df20dc5fa82619ebc460efa10c28.b5a017de.webp";function O(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,a.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"131-会议室预定系统用-migration-初始化表和数据",children:["131. 会议室预定系统：用 migration 初始化表和数据",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#131-会议室预定系统用-migration-初始化表和数据",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"前几节我们把项目部署到了阿里云，能够在全球各地通过 ip 来访问了。"}),"\n",(0,i.jsx)(n.p,{children:"方式是在服务器上通过 git 下载代码，然后用 docker compose 来跑。"}),"\n",(0,i.jsx)(n.p,{children:"但我们并没有把 typeorm 的 synchronize 关掉，也就是现在还是根据 entity 自动创建表的方式。"}),"\n",(0,i.jsx)(n.p,{children:"这种方式并不安全，entity 一改表结构就自动跟着改，容易丢数据。"}),"\n",(0,i.jsx)(n.p,{children:"在生产环境应该把 synchronize 关掉，然后用 migration 来管理创建表、数据初始化、表结构修改等操作。"}),"\n",(0,i.jsx)(n.p,{children:"这节我们来做一下："}),"\n",(0,i.jsx)(n.p,{children:"首先，我们在 mysql workbench 里把现有的数据导出。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样每个表一个 sql 文件："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们选择第二个选项，重新导出下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样就都集中到一个 sql 文件里了。"}),"\n",(0,i.jsx)(n.p,{children:"打开这个生成的 sql 文件看下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"包含了所有的表的 create table 和 insert into 语句。"}),"\n",(0,i.jsx)(n.p,{children:"然后我们在项目的 package.json 里加一下 migration 的 npm scripts："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'"typeorm": "ts-node ./node_modules/typeorm/cli",\n"migration:create": "npm run typeorm -- migration:create",\n"migration:generate": "npm run typeorm -- migration:generate -d ./src/data-source.ts",\n"migration:run": "npm run typeorm -- migration:run -d ./src/data-source.ts",\n"migration:revert": "npm run typeorm -- migration:revert -d ./src/data-source.ts"\n'})}),"\n",(0,i.jsx)(n.p,{children:"migration 需要单独一个 data-source.ts 文件。"}),"\n",(0,i.jsx)(n.p,{children:"创建下 src/data-source.ts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { DataSource } from \"typeorm\";\nimport { config } from 'dotenv';\n\nimport { Permission } from './user/entities/permission.entity';\nimport { Role } from './user/entities/role.entity';\nimport { User } from './user/entities/user.entity';\nimport { MeetingRoom } from \"./meeting-room/entities/meeting-room.entity\";\nimport { Booking } from \"./booking/entities/booking.entity\";\n\nconfig({ path: 'src/.env-migration' });\n\nconsole.log(process.env);\n\nexport default new DataSource({\n    type: \"mysql\",\n    host: `${process.env.mysql_server_host}`,\n    port: +`${process.env.mysql_server_port}`,\n    username: `${process.env.mysql_server_username}`,\n    password: `${process.env.mysql_server_password}`,\n    database: `${process.env.mysql_server_database}`,\n    synchronize: false,\n    logging: true,\n    entities: [\n      User, Role, Permission, MeetingRoom, Booking\n    ],\n    poolSize: 10,\n    migrations: ['src/migrations/**.ts'],\n    connectorPackage: 'mysql2',\n    extra: {\n        authPlugin: 'sha256_password',\n    }\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"synchronize 指定为 false，顺便把 AppModule 里的 synchronize 也改为 false。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们创建个单独的 .env-migration 文件："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"mysql_server_host=localhost\nmysql_server_port=3306\nmysql_server_username=root\nmysql_server_password=guang\nmysql_server_database=meeting_room_booking_system\n"})}),"\n",(0,i.jsx)(n.p,{children:"因为 .env 里配置的 host 是容器名，那个只对 docker compose 内部生效："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:_,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"而 migration 的时候我们是需要真实的 host 的地址的，所以单独搞一个 .env 文件来配置。"}),"\n",(0,i.jsx)(n.p,{children:"跑下 migration:generate 试试："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:generate src/migrations/init\n"})}),"\n",(0,i.jsx)(n.p,{children:"如果遇到找不到 entity 的错误，把绝对路径改为相对路径就好了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这时候没什么更改："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"因为 entity 和数据库表是同步的。"}),"\n",(0,i.jsx)(n.p,{children:"我们把数据表给删掉："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:L,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"再跑下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:generate src/migrations/init\n"})}),"\n",(0,i.jsx)(n.p,{children:"这时候就成功生成了迁移代码："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"里面包含的自然就是所有表的 create table 语句："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"跑下这个迁移："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:run\n"})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，所有 create table 语句都执行了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"数据库里也有了这些表："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"并且在 migrations 表里记录了这个 migration 的执行记录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"表创建好了，还要做初始化数据。"}),"\n",(0,i.jsx)(n.p,{children:"我们同样通过 migration 来做，但是这个是没法 generate 的，generate 只会对比表结构，然后生成迁移 sql。"}),"\n",(0,i.jsx)(n.p,{children:"执行 create 生成 migration 类："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:create src/migrations/data\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这次我们自己来填 sql："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"之前导出的 sql 文件现在就有用了。"}),"\n",(0,i.jsx)(n.p,{children:"把里面的 insert into 语句复制出来："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class Data1718869390167 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n       await queryRunner.query(\"INSERT INTO `booking` VALUES (1,'2023-09-29 10:54:01','2023-09-29 11:54:01','审批通过','',1,3,'2023-09-29 03:06:54.088220','2023-11-17 01:58:53.000000'),(2,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批驳回','',2,6,'2023-09-29 03:06:54.088220','2023-10-21 03:42:53.000000'),(3,'2023-09-29 11:54:02','2023-09-29 12:54:02','已解除','',2,3,'2023-09-29 03:06:54.088220','2023-11-19 01:10:49.741279'),(4,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',1,6,'2023-09-29 03:06:54.088220','2023-11-19 02:30:58.000000'),(5,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',8,11,'2023-09-29 03:06:54.088220','2023-11-19 02:30:58.000000'),(6,'2023-09-29 10:54:02','2023-09-29 11:54:02','已解除','',9,11,'2023-09-29 03:06:54.088220','2024-01-01 01:23:53.000000'),(7,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',9,3,'2023-09-29 03:06:54.088220','2024-01-01 01:10:14.279639'),(8,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',9,6,'2023-09-29 03:06:54.088220','2024-01-01 01:19:23.388907'),(13,'2023-12-31 09:40:59','2023-12-31 09:57:39','申请中','',1,11,'2023-12-31 04:34:38.917720','2024-01-01 01:08:53.884596'),(14,'2023-12-31 09:42:39','2023-12-31 10:14:19','申请中','',1,6,'2023-12-31 04:35:06.508185','2024-01-01 01:08:04.023433'),(15,'2024-01-01 11:00:00','2024-01-01 12:00:00','申请中','',1,3,'2024-01-01 02:43:26.920016','2024-01-01 02:43:26.920016'),(16,'2024-01-01 13:00:00','2024-01-01 14:00:00','申请中','',1,3,'2024-01-01 02:45:47.758012','2024-01-01 02:45:47.758012'),(17,'2024-01-01 15:00:00','2024-01-01 16:00:00','申请中','',1,3,'2024-01-01 02:46:39.654219','2024-01-01 02:46:39.654219');\")\n       await queryRunner.query(\"INSERT INTO `meeting_room` VALUES (3,'天王星33',30,'三层东','白板，电视','',0,'2023-09-16 08:10:25.319000','2023-09-16 08:10:25.319000'),(6,'aa',10,'bb','','',0,'2023-09-16 16:11:31.532151','2023-09-16 16:11:31.532151'),(11,'xxx',0,'xxx','xxx','xxx',0,'2023-09-28 00:27:28.529606','2023-09-28 00:27:28.529606'),(12,'aaa',0,'xxx','xxx','xxx',0,'2023-09-28 00:28:09.291785','2023-09-28 00:28:09.291785');\")\n       await queryRunner.query(\"INSERT INTO `permissions` VALUES (7,'ccc','访问 ccc 接口'),(8,'ddd','访问 ddd 接口');\")\n       await queryRunner.query(\"INSERT INTO `role_permissions` VALUES (7,7),(7,8),(8,7);\")\n       await queryRunner.query(\"INSERT INTO `roles` VALUES (7,'管理员'),(8,'普通用户');\")\n       await queryRunner.query(\"INSERT INTO `user_roles` VALUES (8,7),(9,8);\")\n       await queryRunner.query(\"INSERT INTO `users` VALUES (1,'guang','e10adc3949ba59abbe56e057f20f883e','神说要有光','xxxx@xx.com',NULL,NULL,1,0,'2023-07-25 02:25:03.379725','2023-09-12 03:40:40.000000'),(2,'guang2','e10adc3949ba59abbe56e057f20f883e','神说要有光2','1024195375@qq.com',NULL,NULL,1,0,'2023-07-26 01:39:33.456072','2023-09-12 03:57:06.000000'),(8,'zhangsan','e3ceb5881a0a1fdaad01296d7554868d','张三','1024195375@qq.com','uploads/1694845395657-974488092-headpic1.png','13233323333',1,1,'2023-07-26 03:19:06.523236','2023-09-16 06:59:32.000000'),(9,'lisi','1a100d2c0dab19c4430e7d73762b3423','里斯','yy@yy.com','xxx.png',NULL,1,0,'2023-07-26 03:19:06.553169','2023-08-02 13:05:53.000000'),(10,'dongdong','1a100d2c0dab19c4430e7d73762b3423','东东555','1024195375@qq.com','uploads/1692775078275-227950493-headpic2.png',NULL,1,0,'2023-08-12 15:41:10.537642','2023-09-12 04:01:41.000000'),(11,'gang','96e79218965eb72c92a549dd5a330112','小刚','1024195375@qq.com',NULL,NULL,1,0,'2023-08-12 23:54:38.856096','2023-09-12 03:50:45.000000'),(12,'xiaohong','96e79218965eb72c92a549dd5a330112','小红','1024195375@qq.com',NULL,NULL,0,0,'2023-08-13 00:00:53.802850','2023-09-12 03:54:32.846920'),(13,'xiaodong','96e79218965eb72c92a549dd5a330112','东东','1024195375@qq.com',NULL,NULL,1,0,'2023-08-13 00:01:52.641836','2023-09-12 03:53:09.000000');\")\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        await queryRunner.query(\"TRUNCATE TABLE booking\");\n    }\n\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"这里要用你自己的 sql。"}),"\n",(0,i.jsx)(n.p,{children:"然后 down 部分如果你想 revert 的话也可以写一下，就是 insert into 的反义词 delete from，或者直接 truncate table 清空数据。"}),"\n",(0,i.jsx)(n.p,{children:"跑一下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:run\n"})}),"\n",(0,i.jsx)(n.p,{children:"这一步有可能报错："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"也就是列的顺序对不上。"}),"\n",(0,i.jsx)(n.p,{children:"因为 sql 文件里的顺序是这样的："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"第 6、7 列是 userId、roomId，和 insert into 语句对应。"}),"\n",(0,i.jsx)(n.p,{children:"而现在第 6 列是 createTime："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"所以就报了上面的错误。"}),"\n",(0,i.jsx)(n.p,{children:"这个问题的解决也简单，insert into 的时候指定列名就好了。"}),"\n",(0,i.jsx)(n.p,{children:"右键表，选择复制 insert into 语句："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"在输入框粘贴下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"把列名这部分复制出来，调整成正确的顺序然后放到 insert into 的 sql 里："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"只有这一个有问题的 insert 语句指定下列名就行，别的 insert 语句不用改。"}),"\n",(0,i.jsx)(n.p,{children:"然后你还可能遇到外键约束的问题："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"就是你插入了一条 booking 记录，里面的 userId 在 user 表里没关联的 user。"}),"\n",(0,i.jsx)(n.p,{children:"这种调整下插入顺序就好了，先插入 user 表，再插入 booking 表。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { MigrationInterface, QueryRunner } from \"typeorm\";\n\nexport class Data1718869390167 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        await queryRunner.query(\"INSERT INTO `booking`(`id`,`startTime`,`endTime`,`status`,`note`,`userId`,`roomId`,`createTime`,`updateTime`) VALUES (1,'2023-09-29 10:54:01','2023-09-29 11:54:01','审批通过','',1,3,'2023-09-29 03:06:54.088220','2023-11-17 01:58:53.000000'),(2,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批驳回','',2,6,'2023-09-29 03:06:54.088220','2023-10-21 03:42:53.000000'),(3,'2023-09-29 11:54:02','2023-09-29 12:54:02','已解除','',2,3,'2023-09-29 03:06:54.088220','2023-11-19 01:10:49.741279'),(4,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',1,6,'2023-09-29 03:06:54.088220','2023-11-19 02:30:58.000000'),(5,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',8,11,'2023-09-29 03:06:54.088220','2023-11-19 02:30:58.000000'),(6,'2023-09-29 10:54:02','2023-09-29 11:54:02','已解除','',9,11,'2023-09-29 03:06:54.088220','2024-01-01 01:23:53.000000'),(7,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',9,3,'2023-09-29 03:06:54.088220','2024-01-01 01:10:14.279639'),(8,'2023-09-29 10:54:02','2023-09-29 11:54:02','审批通过','',9,6,'2023-09-29 03:06:54.088220','2024-01-01 01:19:23.388907'),(13,'2023-12-31 09:40:59','2023-12-31 09:57:39','申请中','',1,11,'2023-12-31 04:34:38.917720','2024-01-01 01:08:53.884596'),(14,'2023-12-31 09:42:39','2023-12-31 10:14:19','申请中','',1,6,'2023-12-31 04:35:06.508185','2024-01-01 01:08:04.023433'),(15,'2024-01-01 11:00:00','2024-01-01 12:00:00','申请中','',1,3,'2024-01-01 02:43:26.920016','2024-01-01 02:43:26.920016'),(16,'2024-01-01 13:00:00','2024-01-01 14:00:00','申请中','',1,3,'2024-01-01 02:45:47.758012','2024-01-01 02:45:47.758012'),(17,'2024-01-01 15:00:00','2024-01-01 16:00:00','申请中','',1,3,'2024-01-01 02:46:39.654219','2024-01-01 02:46:39.654219');\")\n        await queryRunner.query(\"INSERT INTO `users` VALUES (1,'guang','e10adc3949ba59abbe56e057f20f883e','神说要有光','xxxx@xx.com',NULL,NULL,1,0,'2023-07-25 02:25:03.379725','2023-09-12 03:40:40.000000'),(2,'guang2','e10adc3949ba59abbe56e057f20f883e','神说要有光2','1024195375@qq.com',NULL,NULL,1,0,'2023-07-26 01:39:33.456072','2023-09-12 03:57:06.000000'),(8,'zhangsan','e3ceb5881a0a1fdaad01296d7554868d','张三','1024195375@qq.com','uploads/1694845395657-974488092-headpic1.png','13233323333',1,1,'2023-07-26 03:19:06.523236','2023-09-16 06:59:32.000000'),(9,'lisi','1a100d2c0dab19c4430e7d73762b3423','里斯','yy@yy.com','xxx.png',NULL,1,0,'2023-07-26 03:19:06.553169','2023-08-02 13:05:53.000000'),(10,'dongdong','1a100d2c0dab19c4430e7d73762b3423','东东555','1024195375@qq.com','uploads/1692775078275-227950493-headpic2.png',NULL,1,0,'2023-08-12 15:41:10.537642','2023-09-12 04:01:41.000000'),(11,'gang','96e79218965eb72c92a549dd5a330112','小刚','1024195375@qq.com',NULL,NULL,1,0,'2023-08-12 23:54:38.856096','2023-09-12 03:50:45.000000'),(12,'xiaohong','96e79218965eb72c92a549dd5a330112','小红','1024195375@qq.com',NULL,NULL,0,0,'2023-08-13 00:00:53.802850','2023-09-12 03:54:32.846920'),(13,'xiaodong','96e79218965eb72c92a549dd5a330112','东东','1024195375@qq.com',NULL,NULL,1,0,'2023-08-13 00:01:52.641836','2023-09-12 03:53:09.000000');\")\n        await queryRunner.query(\"INSERT INTO `meeting_room` VALUES (3,'天王星33',30,'三层东','白板，电视','',0,'2023-09-16 08:10:25.319000','2023-09-16 08:10:25.319000'),(6,'aa',10,'bb','','',0,'2023-09-16 16:11:31.532151','2023-09-16 16:11:31.532151'),(11,'xxx',0,'xxx','xxx','xxx',0,'2023-09-28 00:27:28.529606','2023-09-28 00:27:28.529606'),(12,'aaa',0,'xxx','xxx','xxx',0,'2023-09-28 00:28:09.291785','2023-09-28 00:28:09.291785');\")\n        await queryRunner.query(\"INSERT INTO `permissions` VALUES (7,'ccc','访问 ccc 接口'),(8,'ddd','访问 ddd 接口');\")\n        await queryRunner.query(\"INSERT INTO `roles` VALUES (7,'管理员'),(8,'普通用户');\")\n        await queryRunner.query(\"INSERT INTO `role_permissions` VALUES (7,7),(7,8),(8,7);\")\n        await queryRunner.query(\"INSERT INTO `user_roles` VALUES (8,7),(9,8);\")\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        await queryRunner.query(\"TRUNCATE TABLE booking\");\n    }\n\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"调整完再跑："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run migration:run\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"执行成功了！"}),"\n",(0,i.jsx)(n.p,{children:"在数据库看下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:c,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"数据都插入成功了，并且 migrations 表也记录了这次的执行记录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:s,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样之后，生产环境就有表、也有数据了，之后就可以正常跑 Nest 应用了。"}),"\n",(0,i.jsxs)(n.p,{children:["代码在",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/meeting_room_booking_system_backend",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"这节我们实现了 migration 数据迁移，也就是创建表、初始化数据。"}),"\n",(0,i.jsx)(n.p,{children:"在生产环境会把 synchronize 关掉，然后跑 migration。"}),"\n",(0,i.jsx)(n.p,{children:"我们用 migration:generate 生成了 create table 的 migration。"}),"\n",(0,i.jsx)(n.p,{children:"然后用 migration:create 生成了空的 migration，填入了导出的 inert 语句。"}),"\n",(0,i.jsx)(n.p,{children:"执行完这两个 migration 之后，表和数据就都有了，就可以跑 Nest 项目了。"}),"\n",(0,i.jsx)(n.p,{children:"线上项目，都是这样用手动跑 migration 的方式来修改表的。"})]})}function V(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(O,{...e})}):O(e)}let P=V;V.__RSPRESS_PAGE_META={},V.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F131.%20%E4%BC%9A%E8%AE%AE%E5%AE%A4%E9%A2%84%E5%AE%9A%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%94%A8%20migration%20%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A1%A8%E5%92%8C%E6%95%B0%E6%8D%AE.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"131. 会议室预定系统：用 migration 初始化表和数据",headingTitle:"131. 会议室预定系统：用 migration 初始化表和数据",frontmatter:{}}}}]);