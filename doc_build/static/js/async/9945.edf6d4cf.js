"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["9945"],{253245:function(n,e,s){s.r(e),s.d(e,{default:()=>c});var o=s(552676),i=s(740453);let r=s.p+"static/image/3c0ad6bac38e8f022b45239a24965f32.bf9f6ea9.webp";function a(n){let e=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",code:"code",pre:"pre",ol:"ol",li:"li",img:"img"},(0,i.ah)(),n.components);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(e.h1,{id:"21-实战11引入vuex保持登录状态",children:["21 实战11：引入Vuex保持登录状态",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#21-实战11引入vuex保持登录状态",children:"#"})]}),"\n",(0,o.jsx)(e.p,{children:"本节主要讲解如何使用 Vuex 以及 Uniapp 的 storage 储存功能来做用户状态保存。"}),"\n",(0,o.jsx)(e.p,{children:"下面先来了解下 storage 的基本概念。"}),"\n",(0,o.jsxs)(e.h2,{id:"利用-storage-存储信息",children:["利用 storage 存储信息",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#利用-storage-存储信息",children:"#"})]}),"\n",(0,o.jsx)(e.p,{children:"传统的网页 h5 端数据存储方式（cookie、localStorage、sessionStorage，IndexedDB...），而 App 端无大小限制，不是缓存，是持久化存储。小程序端是自有的 storage 方式，在于用户主动删除或超过一定时间被自动清理，否则数据都一直存在。"}),"\n",(0,o.jsxs)(e.p,{children:["Uniapp 集成了小程序，app，h5 的数据缓存，统一了 ",(0,o.jsx)(e.code,{children:"uni.setStorage()"}),"，",(0,o.jsx)(e.code,{children:"uni.setStorage()"})," 系列 API ，完成对缓存数据的操作。"]}),"\n",(0,o.jsx)(e.p,{children:"在登录这一块功能，传统做法是使用 cookie 的存储机制来判定用户。"}),"\n",(0,o.jsx)(e.p,{children:"使用 cookie：用户登录后由后端生成一个 sessionid 放在 cookie 中返回给客户端，并且服务端一直记录着这个 sessionid ，客户端以后每次请求都会带上这个 sessionid，服务端通过这个 sessionid 来验证身份之类的操作。（存在危险：攻击者拿到了cookie（sessionid）后，就可以完全替代你，客户端以为攻击者是实际用户）。"}),"\n",(0,o.jsx)(e.p,{children:"使用 token：用户登录后由后端返回一个 token 给客户端，客户端将这个 token 存储起来，然后每次客户端请求都需要开发者手动将 token 放在请求 header 中带过去，服务端每次只需要对这个 token 进行验证就能使用 token 中的信息来进行下一步操作了。"}),"\n",(0,o.jsxs)(e.p,{children:["Cookie 是 JavaScript 中的浏览器对象，在小程序，App 中并没有 document.cookie 对象，因此不支持读写 cookie，所以使用 Uniapp 开发不能用传统的应用那样通过读取 cookie 来判断是否是登录状态。Uniapp 中有 ",(0,o.jsx)(e.code,{children:"uni.setStorage()"})," 系列 API 进行数据缓存，而且整个框架的语法糖跟 Vue 类似，那我们可以 ",(0,o.jsx)(e.code,{children:"uni.setStorage()"})," 以及 Vuex 对登录状态进行管理。"]}),"\n",(0,o.jsx)(e.p,{children:"注：Uniapp 设置存储有同步与异步之分，以 Sync 结尾的都是同步缓存操作:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"// 异步\nuni.setStorage({\n    key: 'storage_key',\n    data: 'hello',\n    success: function () {\n        console.log('success');\n    }\n});\n\n// 同步\ntry {\n    uni.setStorageSync('storage_key', 'hello');\n} catch (e) {\n    // error\n}\n"})}),"\n",(0,o.jsxs)(e.p,{children:["有设置缓存 API ，当然还有 API 指定 key 去除缓存 ",(0,o.jsx)(e.code,{children:"uni.removeStorage()"}),"，以及 API 清理本地数据缓存 ",(0,o.jsx)(e.code,{children:"uni.clearStorage()"}),"。"]}),"\n",(0,o.jsx)(e.p,{children:"注意 Uniapp 的 Storage 在不同端的实现不同："}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"所有 storage 的 API 操作对应有同步异步之分，容易使用混淆。"}),"\n",(0,o.jsx)(e.li,{children:"H5端为 localStorage，浏览器限制5M大小，是缓存概念，可能会被清理"}),"\n",(0,o.jsx)(e.li,{children:"App 端为原生的 plus.storage，无大小限制，不是缓存，持久化"}),"\n",(0,o.jsx)(e.li,{children:"各个小程序端为其自带的 storage api ，数据存储生命周期跟小程序本身一致，即除用户主动删除或超过一定时间被自动清理，否则数据都一直可用。"}),"\n",(0,o.jsx)(e.li,{children:"微信小程序单个 key 允许存储的最大数据长度为 1MB，所有数据存储上限为 10MB。"}),"\n",(0,o.jsx)(e.li,{children:"支付宝小程序单条数据转换成字符串后，字符串长度最大200*1024。同一个支付宝用户，同一个小程序缓存总上限为10MB。"}),"\n",(0,o.jsx)(e.li,{children:"百度、头条小程序文档未说明大小限制。"}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:"根据上面的 storage 的 API 与 Vuex，我们可以先捋一下登录功能逻辑："}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)("img",{src:r,alt:""})}),"\n",(0,o.jsxs)(e.h2,{id:"引入-vuex定义登录状态及用户信息",children:["引入 Vuex，定义登录状态及用户信息",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#引入-vuex定义登录状态及用户信息",children:"#"})]}),"\n",(0,o.jsx)(e.p,{children:"在 store/index.js 文件夹目录引入 Vuex，添加状态和分发方法："}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"// store/index.js\nimport Vue from 'vue'\nimport Vuex from 'vuex'\n\nVue.use(Vuex)\n\nconst store = new Vuex.Store({\n    state: {\n        uerInfo: {  // 用户信息\n            hasLogin: false,\n            token: '',\n            profile: ''  // 简介\n        },  \n    },\n    mutations: {\n        storeLogin(state, payload) { // 改变登录状态\n            const temp = {\n                hasLogin: true,\n                token: payload.token,\n                profile: payload.profile\n            }\n            \n            state.uerInfo = Object.assign({}, state.uerInfo, temp)\n            \n            // 将用户信息保存在本地\n            uni.setStorageSync('uerInfo', JSON.stringify(state.uerInfo))\n\n        },\n        storeLogout(state) { // 退出登录\n            const temp = {\n                hasLogin: false,\n                token: '',\n                profile: {}\n            }\n            state.uerInfo = Object.assign({}, state.uerInfo, temp)\n            \n            uni.removeStorageSync('uerInfo')\n        }\n    }\n})\n\nexport default store\n"})}),"\n",(0,o.jsxs)(e.p,{children:["Uniapp 中可以直接引入 Vuex 而不需命令行安装依赖，只需要注入到 Vuex 插件 ",(0,o.jsx)(e.code,{children:"Vue.use(Vuex)"}),"。"]}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"new Vuex.Store()"})," 对象参数 ",(0,o.jsx)(e.code,{children:"state"})," 保存用户信息，项目全局共享这些信息。",(0,o.jsx)(e.code,{children:"mutations"})," 对象定义方法 ",(0,o.jsx)(e.code,{children:"storeLogin"}),"，",(0,o.jsx)(e.code,{children:"storeLogout"})," 暴露出去给项目中的页面组件修改 ",(0,o.jsx)(e.code,{children:"state"})," 的唯一通道，修改 ",(0,o.jsx)(e.code,{children:"uerInfo"})," 状态信息只能通过这两个方法。"]}),"\n",(0,o.jsxs)(e.h2,{id:"挂载-store-全局共享状态信息",children:["挂载 store ，全局共享状态信息",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#挂载-store-全局共享状态信息",children:"#"})]}),"\n",(0,o.jsx)(e.p,{children:"要想项目全局共享这些信息，需要在入口文件 main.js 文件中导入这个 js，并把 store 挂载到 Vue 中。"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"import Vue from 'vue'\nimport App from './App'\nimport store from './store'\n\nVue.prototype.$store = store\n\nApp.mpType = 'app'\n\nconst app = new Vue({\n    ...App\n})\napp.$mount()\n"})}),"\n",(0,o.jsx)(e.p,{children:"挂载到 Vue 后，就可以在页面上使用了。"}),"\n",(0,o.jsx)(e.p,{children:"首先是用户的登录："}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"import { mapMutations } from 'vuex';  \nimport { apiLogin } from '@/apis/account.js'\nexport default {\n	methods: {\n		...mapMutations(['storeLogin']),\n		bindLogin() {\n			const params = {\n				phone: this.account,\n				password: this.password\n			};\n			apiLogin(params).then(res => {\n				// 不成功信息提示\n				if (res.data.code !== 200) {\n					uni.showToast({ \n					    icon: 'none',\n					    title: res.data.msg,\n					});\n					return false\n				}\n				\n				// 登录成功后改变store登录状态，并进入首页\n				// 在store存储token,profile\n				const temp = {\n					token: res.access_token,\n					profile: res.data.profile\n				}\n				this.storeLogin(temp)\n				\n				uni.switchTab({\n					url: '/pages/index/index'\n				});\n			})\n		},\n	}\n}\n"})}),"\n",(0,o.jsx)(e.p,{children:"用户经过登录页登录后就可以在账号页面共享登录状态了。"}),"\n",(0,o.jsxs)(e.h2,{id:"账号页面共享登录状态与用户信息",children:["账号页面共享登录状态与用户信息",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#账号页面共享登录状态与用户信息",children:"#"})]}),"\n",(0,o.jsx)(e.p,{children:"登录前与登录后的页面状态："}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,o.jsx)(e.p,{children:"通过 Vuex 中保存的用户信息判断是否已经登录，从而显示不同的内容。关键代码："}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-html",children:'\x3c!-- pages/account/index.vue --\x3e\n\x3c!-- 未登录状态 --\x3e\n<view v-if="!userInfo.hasLogin" class="empty-user">\n    <view>登录Uniapp Music</view>\n    <view>手机电脑多端同步，尽享海量高品质音乐</view>\n    <navigator class="btn" url="/pages/subpages/account/login">\n        立即登录\n    </navigator>\n</view>\n\x3c!-- 登录状态 --\x3e\n<template v-if="userInfo.hasLogin">\n    <view class="userinfo-box flex-box">\n        <view class="avator">\n            <image v-if="userInfo.profile.avatarUrl" class="img" :src="userInfo.profile.avatarUrl"></image>\n            <view v-else class="no-img">\n                上传头像\n            </view>\n        </view>\n        <view class="flex-item">\n            <view class="fl">\n                <view class="name">{{userInfo.profile.nickname}}</view>\n                <view class="level">lv1</view>\n            </view>\n            <image class="sign fr" src="/static/image/account/a_03.png"></image>\n        </view>\n    </view>\n<template>\n\x3c!-- 退出登录 --\x3e\n<view v-if="userInfo.hasLogin" class="logout" @click="confirmOut">\n    退出登录\n</view>\n'})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"import { mapState, mapMutations } from 'vuex';\nimport { apiLogout } from '@/apis/account.js';\nexport default {\n		data() {\n				return {};\n		},\n		computed:{\n				...mapState(['userInfo'])\n		},\n		methods: {\n				// 退出登录\n				...mapMutations(['storeLogout']),\n				// 退出登录 清空缓存\n	confirmOut() {\n		uni.showModal({\n			title: 'Uniapp Music',\n			content: '确定退出当前账号吗？',\n			cancelColor: '#007aff',\n			success: res => {\n				if (res.confirm) {\n					this.confirmLogout()\n				} else if (res.cancel) {\n					console.log('用户点击取消');\n				}\n			}\n		});\n	},\n	// 确定退出\n	confirmLogout() {\n		apiLogout().then(res => {\n			this.storeLogout()\n			// 到登录页\n			uni.navigateTo({\n				url: '/pages/subpages/account/login'\n			})\n		})\n	},\n		}\n}\n"})}),"\n",(0,o.jsxs)(e.h2,{id:"关键点再次进入应用",children:["关键点：再次进入应用",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#关键点再次进入应用",children:"#"})]}),"\n",(0,o.jsxs)(e.p,{children:["刷新页面或者退出后页面再次进入应用后的判断。这里我们根据进入应用触发应用生命周期 onLaunch 来做判定。当进入应用时在 App.vue 中判断本地缓存中是否有 ",(0,o.jsx)(e.code,{children:"uerInfo"}),"，根据 uerInfo 里面的 token 判断登录状态。"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"import { mapMutations } from 'vuex';\nexport default {\n	onLaunch() {\n		console.log('App Launch')\n		uni.getStorage({\n			key: 'userInfo',\n			success: res => {\n				console.log(res.data)\n				// 此处仅做演示\n				// 跟后台校验token的有效性，判定是否在登录状态。如果token失效，需重新登录。app端不强制用户登录，可以游客身份登录，可以进一步优化流程\n				// uni.request({\n				//  url: '',    // 验证token有效性的api\n				//  header: {  \n				//     \"Token\":res.data.token  \n				//  },  \n				// 	method: \"POST\",\n				// 	success: response => {\n				// 		if (response.data.code === 200) {\n				// 			this.storeLogin(e.data);\n				// 		} else {  // 验证无效清除用户原有缓存数据\n				// 			this.storeLogout()\n				// 		}\n				// 	}\n				// })\n				this.storeLogin(JSON.parse(res.data))\n			}\n		});\n	},\n	methods: {  \n		...mapMutations(['storeLogin', 'storeLogout'])  \n	}\n}\n"})}),"\n",(0,o.jsx)(e.p,{children:"验证 token 有效性后拿到用户信息，如同再次登录一样，存储用户信息在状态管理，使所有页面都能共享登录状态与用户信息。"}),"\n",(0,o.jsx)(e.p,{children:"可以将 token 放在请求 header 中带过去，服务端每次只需要对这个 token 进行验证就能验证用户了。"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-js",children:"// utils/request/index.js\nimport store from '@/store/index.js'\n\nconst reqInterceptor = async (options) => {\n  options.header = {  // 头部塞入token 进行验证\n    ...options.header,\n    token: store.state.userInfo.token\n  }\n}\n"})}),"\n",(0,o.jsxs)(e.h2,{id:"小结",children:["小结",(0,o.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#小结",children:"#"})]}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"关键在于如何存储验证 token 信息，如何与后台交换用户信息；"}),"\n",(0,o.jsx)(e.li,{children:"将 token 放在请求 header 中，服务端每次只需要对这个 token 进行验证就能验证当前用户。"}),"\n",(0,o.jsxs)(e.li,{children:["本章代码 ",(0,o.jsx)(e.a,{href:"https://github.com/front-end-class/uniapp-music-code/blob/master/uni-course-%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81.zip",target:"_blank",rel:"noopener noreferrer",children:"uni-course-实战开发登录状态"}),"。"]}),"\n"]})]})}function t(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,i.ah)(),n.components);return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(a,{...n})}):a(n)}let c=t;t.__RSPRESS_PAGE_META={},t.__RSPRESS_PAGE_META["Uniapp%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6%2F21%20%E5%AE%9E%E6%88%9811%EF%BC%9A%E5%BC%95%E5%85%A5Vuex%E4%BF%9D%E6%8C%81%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81.md"]={toc:[{text:"利用 storage 存储信息",id:"利用-storage-存储信息",depth:2},{text:"引入 Vuex，定义登录状态及用户信息",id:"引入-vuex定义登录状态及用户信息",depth:2},{text:"挂载 store ，全局共享状态信息",id:"挂载-store-全局共享状态信息",depth:2},{text:"账号页面共享登录状态与用户信息",id:"账号页面共享登录状态与用户信息",depth:2},{text:"关键点：再次进入应用",id:"关键点再次进入应用",depth:2},{text:"小结",id:"小结",depth:2}],title:"21 实战11：引入Vuex保持登录状态",headingTitle:"21 实战11：引入Vuex保持登录状态",frontmatter:{}}}}]);