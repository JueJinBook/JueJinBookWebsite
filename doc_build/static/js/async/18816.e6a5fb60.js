"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["18816"],{126540:function(e,n,c){c.r(n),c.d(n,{default:()=>O});var s=c(552676),r=c(740453);let i=c.p+"static/image/c8b978c92ca40b5d4fd5757e19fb97d2.a63be380.webp",p=c.p+"static/image/59021209601b7f3b9a21790c4d889462.776f95f1.webp",d=c.p+"static/image/e5022e3a6079f26c2163e8ad633e8856.3cc45b2b.webp",a=c.p+"static/image/032bdace6fa21134db1e8bb54be70fd0.73c24e65.webp",l=c.p+"static/image/15c79bd054b7446462c797ec49bdb4bd.48ef11bc.webp",x=c.p+"static/image/fd440cf6c948b43f819908c22029ef12.b0facb68.webp",t=c.p+"static/image/43e250876f5bfd8504991b6d664df846.e15b3c93.webp",h=c.p+"static/image/27b354c9061b9908013b96d99141cd47.0dcfb7c1.webp",j=c.p+"static/image/159ac316672403485771faf32d1c58da.acf2e4c5.webp",f=c.p+"static/image/2269b7fde9841abacf9b211649a54b52.fde9559d.webp",b=c.p+"static/image/0981fd898122504064fab51eeb1963dd.6558d400.webp",g=c.p+"static/image/02bc1605b52ff1dce3df1d3cc1d4bc3a.64f8e04f.webp",o=c.p+"static/image/58ce2fff5e6f2a83e5c5b25f72d7f2ce.cb0150b6.webp",m=c.p+"static/image/b976c258d340bbcfe257bc0c98db494c.222b4a18.webp",v=c.p+"static/image/7316f5de272da0c0388e270948ce98dc.3d9f3e79.webp",A=c.p+"static/image/e4ee6e26bad54c9f703404c5fa2df7c6.d44097b9.webp",w=c.p+"static/image/66b97813f62567712c2c06f7f10cd065.70a29c22.webp",k=c.p+"static/image/602c6253ff3c8a6272de3767add35e89.95e2b2a0.webp",y=c.p+"static/image/94e7f883a0beef9fdd3897079fc14029.3d78d573.webp",B=c.p+"static/image/300039264401080abcf975adc644fecb.467bc2d7.webp",G=c.p+"static/image/463f00c88e7894d2f8ad77257fb49889.0af94cb7.webp",u=c.p+"static/image/fafd650fd51c68fa4297e4767abcec29.0a179d45.webp",E=c.p+"static/image/e1075eb6b0a10cc60db0691ff4b1a6c9.5d5f6e4a.webp",D=c.p+"static/image/f84f54e113e9080aa81d15ba3cf5bef9.9900a57e.webp";function F(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"80-基于-nginx-实现灰度系统",children:["80. 基于 Nginx 实现灰度系统",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#80-基于-nginx-实现灰度系统",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"软件开发一般不会上来就是最终版本，而是会一个版本一个版本的迭代。"}),"\n",(0,s.jsx)(n.p,{children:"新版本上线前都会经过测试，但就算这样，也不能保证上线了不出问题。"}),"\n",(0,s.jsx)(n.p,{children:"所以，在公司里上线新版本代码一般都是通过灰度系统。"}),"\n",(0,s.jsx)(n.p,{children:"灰度系统可以把流量划分成多份，一份走新版本代码，一份走老版本代码。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"而且灰度系统支持设置流量的比例，比如可以把走新版本代码的流程设置为 5%，没啥问题再放到 10%，50%，最后放到 100% 全量。"}),"\n",(0,s.jsx)(n.p,{children:"这样可以把出现问题的影响降到最低。"}),"\n",(0,s.jsx)(n.p,{children:"不然一上来就全量，万一出了线上问题，那就是大事故。"}),"\n",(0,s.jsx)(n.p,{children:"而且灰度系统不止这一个用途，比如产品不确定某些改动是不是有效的，就要做 AB 实验，也就是要把流量分成两份，一份走 A 版本代码，一份走 B 版本代码。"}),"\n",(0,s.jsx)(n.p,{children:"那这样的灰度系统是怎么实现的呢？"}),"\n",(0,s.jsx)(n.p,{children:"其实很多都是用 nginx 实现的。"}),"\n",(0,s.jsx)(n.p,{children:"nginx 是一个反向代理的服务，用户请求发给它，由它转发给具体的应用服务器。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这一层也叫做网关层。"}),"\n",(0,s.jsx)(n.p,{children:"由它负责转发请求给应用服务器，那自然就可以在这里控制流量的分配，哪些流量走版本 A，哪些流量走版本 B。"}),"\n",(0,s.jsx)(n.p,{children:"下面我们实现一下："}),"\n",(0,s.jsx)(n.p,{children:"首先，我们准备两个版本的代码。"}),"\n",(0,s.jsx)(n.p,{children:"这里创建个 nest 项目："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npx nest new gray_test -p npm\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"把 nest 服务跑起来："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm run start\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:G,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"看到 hello world 代表 nest 服务跑起来了。"}),"\n",(0,s.jsx)(n.p,{children:"然后改下 AppService："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"修改下端口："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后再 npm run start："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"现在我们就有了两个版本的 nest 代码。"}),"\n",(0,s.jsx)(n.p,{children:"接下来的问题是，如何用 nginx 实现灰度，让一部分请求走一个版本的代码，一部分请求走另一个版本呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们先跑一个 nginx 服务。"}),"\n",(0,s.jsx)(n.p,{children:"docker desktop 搜索 nginx 镜像（这步需要科学上网），点击 run："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"设置容器名为 gray1，端口映射宿主机的 82 到容器内的 80"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["现在访问 ",(0,s.jsx)(n.a,{href:"http://localhost:82",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:82"})," 就可以看到 nginx 页面了："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们要修改下配置文件，把它复制出来："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"docker cp gray1:/etc/nginx/conf.d ~/nginx-config\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后编辑下这个 default.conf"}),"\n",(0,s.jsx)(n.p,{children:"添加这么一行配置："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location ^~ /api {\n    rewrite ^/api/(.*)$ /$1 break;\n    proxy_pass http://192.168.1.6:3001;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["这行就是加了一个路由，把 /api/ 开头的请求转发给 ",(0,s.jsx)(n.a,{href:"http://%E5%AE%BF%E4%B8%BB%E6%9C%BAIP:3001",target:"_blank",rel:"noopener noreferrer",children:"http://宿主机IP:3001"})," 这个服务。"]}),"\n",(0,s.jsx)(n.p,{children:"用 rewrite 把 url 重写了，比如 /api/xxx 变成了 /xxx。"}),"\n",(0,s.jsx)(n.p,{children:"然后我们重新跑个 nginx 容器："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"容器名为 gray2，端口映射 83 到容器内的 80。"}),"\n",(0,s.jsx)(n.p,{children:"指定数据卷，挂载本地的 ～/nginx-config 目录到容器内的 /etc/nginx/conf.d 目录。"}),"\n",(0,s.jsx)(n.p,{children:"点击 run。"}),"\n",(0,s.jsx)(n.p,{children:"然后看下 files 部分："}),"\n",(0,s.jsx)(n.p,{children:"可以看到容器内的 /etc/nginx/conf.d 目录标识为了 mounted。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"点开看看："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这就是本地的那个文件。"}),"\n",(0,s.jsx)(n.p,{children:"我们在本地改一下试试："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"容器内也同样修改了。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在容器内修改这个文件，本地同样也会修改。"}),"\n",(0,s.jsx)(n.p,{children:"也就是说挂载数据卷之后，容器内的这个目录就是本地目录，是同一份。"}),"\n",(0,s.jsxs)(n.p,{children:["然后我们访问下 ",(0,s.jsx)(n.a,{href:"http://localhost:83/api/",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:83/api/"})," 看看："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"nest 服务访问成功了。"}),"\n",(0,s.jsx)(n.p,{children:"现在我们不是直接访问 nest 服务了，而是经历了一层 nginx 反向代理或者说网关层。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"自然，我们可以在这一层实现流量控制的功能。"}),"\n",(0,s.jsx)(n.p,{children:"前面我们讲负载均衡的时候，是这么配的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"默认会轮询把请求发给 upstream 下的 server。"}),"\n",(0,s.jsx)(n.p,{children:"现在需要有多组 upstream："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"upstream version1.0_server {\n    server 192.168.1.6:3000;\n}\n \nupstream version2.0_server {\n    server 192.168.1.6:3001;\n}\n\nupstream default {\n    server 192.168.1.6:3000;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"有版本 1.0 的、版本 2.0 的，默认的 server 列表。"}),"\n",(0,s.jsx)(n.p,{children:"然后需要根据某个条件来区分转发给哪个服务。"}),"\n",(0,s.jsx)(n.p,{children:"我们这里根据 cookie 来区分："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:'set $group "default";\nif ($http_cookie ~* "version=1.0"){\n    set $group version1.0_server;\n}\n\nif ($http_cookie ~* "version=2.0"){\n    set $group version2.0_server;\n}\n\nlocation ^~ /api {\n    rewrite ^/api/(.*)$ /$1 break;\n    proxy_pass http://$group;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"如果包含 version=1.0 的 cookie，那就走 version1.0_server 的服务，有 version=2.0 的 cookie 就走 version2.0_server 的服务，否则，走默认的。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样就实现了流量的划分，也就是灰度的功能。"}),"\n",(0,s.jsx)(n.p,{children:"然后我们重新跑下容器："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:a,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["这时候，你访问 ",(0,s.jsx)(n.a,{href:"http://localhost:83/api/",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:83/api/"})," 走到的就是默认的版本。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后带上 version=2.0 的 cookie，走到的就是另一个版本的代码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样，我们就实现了灰度的功能。"}),"\n",(0,s.jsx)(n.p,{children:"但现在还有一个问题："}),"\n",(0,s.jsx)(n.p,{children:"什么时候设置的这个 cookie 呢？"}),"\n",(0,s.jsx)(n.p,{children:"比如我想实现 80% 的流量走版本 1.0，20% 的流量走版本 2.0"}),"\n",(0,s.jsx)(n.p,{children:"其实公司内部一般都有灰度配置系统，可以配置不同的版本的比例，然后流量经过这个系统之后，就会返回 Set-Cookie 的 header，里面按照比例来分别设置不同的 cookie。"}),"\n",(0,s.jsx)(n.p,{children:"比如随机数载 0 到 0.2 之间，就设置 version=2.0 的 cookie，否则，设置 version=1.0 的 cookie。"}),"\n",(0,s.jsx)(n.p,{children:"这也叫做流量染色。"}),"\n",(0,s.jsx)(n.p,{children:"完整的灰度流程是这样的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"第一次请求的时候，会按照设定的比例随机对流量染色，也就是设置不同 cookie。"}),"\n",(0,s.jsx)(n.p,{children:"再次访问的时候会根据 cookie 来走到不同版本的代码。"}),"\n",(0,s.jsx)(n.p,{children:"其中，后端代码会根据 cookie 标识来请求不同的服务（或者同一个服务走不同的 if else），前端代码可以根据 cookie 判断走哪段逻辑。"}),"\n",(0,s.jsx)(n.p,{children:"这就实现了灰度功能，可以用来做 5% 10% 50% 100% 这样逐步上线的灰度上线机制。"}),"\n",(0,s.jsx)(n.p,{children:"也可以用来做产品的 AB 实验。"}),"\n",(0,s.jsx)(n.p,{children:"公司里都会用这样的灰度系统。"}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"新版本代码的上线基本都会用灰度系统，可以逐步放量的方式来保证上线过程不会出大问题，也可以用来做产品 AB 实验。"}),"\n",(0,s.jsx)(n.p,{children:"我们可以用 nginx 实现这样的功能。"}),"\n",(0,s.jsx)(n.p,{children:"nginx 有反向代理的功能，可以转发请求到应用服务器，也叫做网关层。"}),"\n",(0,s.jsx)(n.p,{children:"我们可以在这一层根据 cookie 里的 version 字段来决定转发请求到哪个服务。"}),"\n",(0,s.jsx)(n.p,{children:"在这之前，还需要按照比例来给流量染色，也就是返回不同的 cookie。"}),"\n",(0,s.jsx)(n.p,{children:"不管灰度系统做的有多复杂，底层也就是流量染色、根据标记转发流量这两部分，我们完全可以自己实现一个。"})]})}function R(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(F,{...e})}):F(e)}let O=R;R.__RSPRESS_PAGE_META={},R.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F80.%20%E5%9F%BA%E4%BA%8E%20Nginx%20%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6%E7%B3%BB%E7%BB%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"80. 基于 Nginx 实现灰度系统",headingTitle:"80. 基于 Nginx 实现灰度系统",frontmatter:{}}}}]);