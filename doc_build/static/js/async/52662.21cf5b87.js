"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["52662"],{181619:function(e,c,a){a.r(c),a.d(c,{default:()=>eX});var s=a(552676),t=a(740453);let i=a.p+"static/image/099efdd35b207a44b66f73f5680aa46d.6aad5da8.webp",n=a.p+"static/image/750bb4065369c455f979111ba91aa6e5.cda9e50d.webp",r=a.p+"static/image/c3ec610c9943fabdefdcba514bf7ec32.68b6db31.webp",d=a.p+"static/image/ffda540f2a129c1b011c9f4ed7cfcfa3.895afcb0.webp",p=a.p+"static/image/151d659890e343ee190132ecfb199b10.0ab129f7.webp",l=a.p+"static/image/577b99a3986fef179e123881f4dcfd0b.170d196a.webp",h=a.p+"static/image/9ef536a8249fc4e6583d238dda0eca16.a1422d2a.webp",o=a.p+"static/image/4a573676f7fec5ad2bd5beaadf646d01.77fa178d.webp",b=a.p+"static/image/af7d6c0b5d792711d50728a7c53e2802.6e2388e1.webp",j=a.p+"static/image/5a382fde75c5c0279532b15b18cd874d.7f8625a4.webp",x=a.p+"static/image/9acbe329bf747e7ff2382cded6bf6f6b.d8d80b7a.webp",f=a.p+"static/image/4812fbb0b176992df6b19e8c70972eb7.d31d920d.webp",m=a.p+"static/image/9cc9d2a06232f5ac43337f9389489ce7.4811de09.webp",g=a.p+"static/image/bf82ae6e1f7c19713183eb3cff5abf2e.7d13866e.webp",u=a.p+"static/image/e30744c13ed371bff77a4aac2d9b6eee.df91467a.webp",w=a.p+"static/image/1a194dee6aab20dbf27fb6934ed2f9e2.0d5a2e67.webp",y=a.p+"static/image/2eac56952d7f738d8a51f14571a53370.32dcc87f.webp",R=a.p+"static/image/5eeb0a3a47473de9ec2e96649c5990c3.98781015.webp",A=a.p+"static/image/ea3a8d999c5d8cac07a0dcaa6502ba38.43c07c0a.webp",k=a.p+"static/image/b84fb09c368a69f57e8ec63381ad5606.08d873ae.webp",S=a.p+"static/image/e09970133b733758e0f55571aff56a69.248f9499.webp",X=a.p+"static/image/c50c2b57c8feb6cdf98efd7c5fa89b3f.851d9948.webp",Z=a.p+"static/image/48fcfb6a7f4fea4110787a6311719316.2536f9e0.webp",D=a.p+"static/image/f8f3393b72c092acf3a4ffbdb8046004.dad8bc0f.webp",L=a.p+"static/image/c2a896df75467f508fe54dfcfa7c9ab0.123e07d9.webp",z=a.p+"static/image/d858992df07bf37c20bed2c9fa5b10b4.d0dbaed5.webp",E=a.p+"static/image/e03d90b1a7068d243162c5daf0a7a14a.18af0e0a.webp",H=a.p+"static/image/9f88f095a7462ffa7a9a636632bf0c0f.832f600d.webp",P=a.p+"static/image/4348c2057695e71215de072909089732.a9fba094.webp",F=a.p+"static/image/7597f9c8c22ed8fa3537929c60de0b9d.19074077.webp",U=a.p+"static/image/1c2d7fbb77568da641f8c16350084e90.70bf4fb2.webp",N=a.p+"static/image/337f74afa4197bcfcb28853f32eddc5f.c42fb73b.webp",v=a.p+"static/image/9b03e76426ba2ba57fecbdaeb7d62b11.09f0ebca.webp",I=a.p+"static/image/4d17f5422d22e899ebd3fdcdaccdf7d3.6d54dedb.webp",K=a.p+"static/image/e2c917137f3dffce375f80843122202b.19002655.webp",W=a.p+"static/image/2137c119285d7b8dc472f82e4c0b7d40.e62f0b6c.webp",Q=a.p+"static/image/a13cdad35d246dd177394976fefe777b.c37cff9b.webp",B=a.p+"static/image/943244b08102b318d113e3bcb2fabd17.e1505c86.webp",M=a.p+"static/image/def905dd36e544e67670caee16be02c7.310d1f7a.webp",O=a.p+"static/image/8b6c4c609f1e12ed850ba47f9940c199.d63ec87a.webp",C=a.p+"static/image/cd39469e167b895d2b0cd85c02cc8746.a4c9a813.webp",G=a.p+"static/image/f319452e894a02d47a15899c2560ad86.98429edd.webp",T=a.p+"static/image/25fe969a06ad631b338397bb29f9a1f9.12e3f937.webp",J=a.p+"static/image/9b9a5f9cf44d16768b146ac4f5ae47dd.323bc43b.webp",V=a.p+"static/image/3e85033d8896616e6591bd5a647f3e6c.d3c4be83.webp",q=a.p+"static/image/150ca592d95fec7a76816ce29e8a043c.0542df07.webp",Y=a.p+"static/image/f7e1b58eedbd58c4263e624c8167bf45.7cce4bff.webp",_=a.p+"static/image/150c4762d5776d100a3a8560381ac364.1cddd832.webp",$=a.p+"static/image/14823437e5457ba4b7e4189f80b91082.50aa1e13.webp",ee=a.p+"static/image/ae71967759b247001859c6df318df548.15cc7cdb.webp",ec=a.p+"static/image/080c7be06360d154469df610005600f8.70264272.webp",ea=a.p+"static/image/ba92ef7bd71b5a54283f8d27555e31cc.21af333d.webp",es=a.p+"static/image/1e1dc995733212c991c271ff07b3896b.fe9be5a6.webp",et=a.p+"static/image/3a2a22376b10919ccadc9df75616e097.862339f9.webp",ei=a.p+"static/image/14c39ae1cdc83612e66535f0c4eff850.2d3cc795.webp",en=a.p+"static/image/534c55527cd331131b8ec775cb37752e.16fcf010.webp",er=a.p+"static/image/c71c05f65ba91fd2641c78733549da09.85cb7eee.webp",ed=a.p+"static/image/7fc62d8a7e068dc4519b6897409619e5.5350eebd.webp",ep=a.p+"static/image/1bfa120ca9cc65f220ccb15fd5ab7392.691f4b83.webp",el=a.p+"static/image/cc3f027cc7617b4db6cad51691df9e5c.1bc2cfda.webp",eh=a.p+"static/image/7808262405841b84b6361e5e4a00a9d5.64c10460.webp",eo=a.p+"static/image/948c769be83ef1b2ff94f4ab731198f3.14f8d42d.webp",eb=a.p+"static/image/46bde5dafd98ca46f938d7d7460a3afb.dbf91b52.webp",ej=a.p+"static/image/92d31343cf98975ff832e3de1448a34d.8961abc2.webp",ex=a.p+"static/image/d6ec2840b8331737a25c0805fe194743.00440c18.webp",ef=a.p+"static/image/4b3b4f850b9cade92f43b1b6764d6172.56c9c0ca.webp",em=a.p+"static/image/419042c9872125fab44b1cdd76fdc108.43b28bad.webp",eg=a.p+"static/image/23e0b2624eb22d044add4152f6cdcbaf.19038b13.webp",eu=a.p+"static/image/5736a5969ca6ca02e704f91f5ab5d599.c476d75c.webp",ew=a.p+"static/image/4ccd64e8a59cc53d0fc94ebd07c2e897.2475a78d.webp",ey=a.p+"static/image/5b2c33fd2a7cbcdfd43006640f35bcfb.b5e998a0.webp",eR=a.p+"static/image/62fa9c1d175de2cb68d1f04547a70cdd.273e800f.webp",eA=a.p+"static/image/4fee4e6f088b97f5bfcec2db58010bea.dc07ed69.webp";function ek(e){let c=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",strong:"strong",h2:"h2",ul:"ul",li:"li"},(0,t.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(c.h1,{id:"第44章historyapi和reactrouter实现原理",children:["第44章—Historyapi和ReactRouter实现原理",(0,s.jsx)(c.a,{className:"header-anchor","aria-hidden":"true",href:"#第44章historyapi和reactrouter实现原理",children:"#"})]}),"\n",(0,s.jsx)(c.p,{children:"\uFEFFRouter 是开发 React 应用的必备功能，那 React Router 是怎么实现的呢？"}),"\n",(0,s.jsx)(c.p,{children:"今天我们就来读一下 React Router 的源码吧！"}),"\n",(0,s.jsx)(c.p,{children:"首先，我们来学一下 History API，这是基础。"}),"\n",(0,s.jsx)(c.p,{children:"什么是 history 呢？"}),"\n",(0,s.jsx)(c.p,{children:"就是这个东西："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eA,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"我打开了一个新的标签页、然后访问 baidu.com、sougou.com、taobao.com。"}),"\n",(0,s.jsx)(c.p,{children:"长按后退按钮，就会列出历史记录，这就是 history。"}),"\n",(0,s.jsx)(c.p,{children:"现在在这里："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eR,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"history.length 是 5"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ey,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"点击两次后退按钮，或者执行两次 history.back()"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ew,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"就会回到这里："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eu,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这时候 history.length 依然是 5"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eg,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"因为前后的 history 都还保留着："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:em,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ef,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"除了用 history.back、history.forward 在 history 之间切换外，还可以用 history.go"}),"\n",(0,s.jsx)(c.p,{children:"参数值是 delta："}),"\n",(0,s.jsx)(c.p,{children:"history.go(0) 是刷新当前页面。"}),"\n",(0,s.jsx)(c.p,{children:"history.go(1) 是前进一个，相当于 history.forward()"}),"\n",(0,s.jsx)(c.p,{children:"history.go(-1) 是后退一个，相当于 history.back()"}),"\n",(0,s.jsx)(c.p,{children:"当然，你还可以 history.go(-2)、histroy.go(3) 这种。"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ex,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"比如当我执行 history.go(-2) 的时候，能直接从 taobao.com 跳到 sogou.com"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ej,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"你还可以通过 history.replaceState 来替换当前 history："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eb,alt:""})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-javascript",children:"history.replaceState({aaa:1}, '', 'https://www.baidu.com?wd=光')\n"})}),"\n",(0,s.jsx)(c.p,{children:"第一个参数是 state、第二个参数是 title，第三个是替换的 url。"}),"\n",(0,s.jsx)(c.p,{children:"不过第二个参数基本都不支持，state 倒是能拿到。"}),"\n",(0,s.jsxs)(c.p,{children:["比如我在 ",(0,s.jsx)(c.a,{href:"https://www.baidu.com",target:"_blank",rel:"noopener noreferrer",children:"https://www.baidu.com"})," 那页 replaceState 为一个新的 url："]}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eo,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"前后 history 都没变，只有当前的变了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:eh,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"也就是这样："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:el,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"当然，你还可以用 history.pushState 来添加一个新的 history："}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-javascript",children:"history.pushState({bbb:1}, '', 'https://www.baidu.com?wd=东');\n"})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ep,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"但有个现象，就是之后的 history 都没了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ed,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:er,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"也就是变成了这样："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:en,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"为什么呢？"}),"\n",(0,s.jsx)(c.p,{children:"因为你是 history.pushState 的时候，和后面的 history 冲突了，也就是分叉了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ei,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这时候自然只能保留一个分支，也就是最新的那个。"}),"\n",(0,s.jsx)(c.p,{children:"这时候 history.length 就是 3 了。"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:et,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"至此，history 的 length、go、back、forward、pushState、replaceState、state 这些 api 我们就用了一遍了。"}),"\n",(0,s.jsx)(c.p,{children:"还有个 history.scrollRestoration 是用来保留滚动位置的："}),"\n",(0,s.jsx)(c.p,{children:"有两个值 auto、manual，默认是 auto，也就是会自动定位到上次滚动位置，设置为 manual 就不会了。"}),"\n",(0,s.jsx)(c.p,{children:"比如我访问百度到了这个位置："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:es,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"打开个新页面，再退回来："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ea,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"依然是在上次滚动到的位置。"}),"\n",(0,s.jsx)(c.p,{children:"这是因为它的 history.scrollRestoration 是 auto"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ec,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"我们把它设置为 manual 试试看："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:ee,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:$,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这时候就算滚动到了底部，再切回来也会回到最上面。"}),"\n",(0,s.jsx)(c.p,{children:"此外，与 history 相关的还有个事件：popstate"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)(c.strong,{children:"当你在 history 中导航时，popstate 就会触发，比如 history.forwad、histroy.back、history.go。"})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)(c.strong,{children:"但是 history.pushState、history.replaceState 这种并不会触发 popstate。"})}),"\n",(0,s.jsx)(c.p,{children:"我们测试下："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:_,alt:""})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-javascript",children:"history.pushState({aaa:1}, '', 'https://www.baidu.com?#/aaa');\n\nhistory.pushState({bbb:2}, '', 'https://www.baidu.com?#/bbb');\n"})}),"\n",(0,s.jsxs)(c.p,{children:["我在 ",(0,s.jsx)(c.a,{href:"http://www.baidu.com",target:"_blank",rel:"noopener noreferrer",children:"www.baidu.com"})," 这个页面 pushState 添加了两个 history。"]}),"\n",(0,s.jsx)(c.p,{children:"加上导航页一共 4 个："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:Y,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"然后我监听 popstate 事件："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:q,alt:""})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-javascript",children:"window.addEventListener('popstate', event => {console.log(event)});\n"})}),"\n",(0,s.jsx)(c.p,{children:"执行 history.back 和 history.forward 都会触发 popstate 事件："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:V,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"事件包含 state，也可以从 target.location 拿到当前 url"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:J,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"但是当你 history.pushState、history.replaceState 并不会触发它："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:T,alt:""})}),"\n",(0,s.jsxs)(c.p,{children:["也就是说",(0,s.jsx)(c.strong,{children:"添加、修改 history 不会触发 popstate，只有在 history 之间导航才会触发。"})]}),"\n",(0,s.jsx)(c.p,{children:"综上，history api 和 popstate 事件我们都过了一遍。"}),"\n",(0,s.jsx)(c.p,{children:"基于这些就可以实现 React Router。"}),"\n",(0,s.jsx)(c.p,{children:"有的同学说，不是还有个 hashchange 事件么？"}),"\n",(0,s.jsx)(c.p,{children:"确实，那个就是监听 hash 变化的。"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:G,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:C,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"基于它也可以实现 router，但很明显，hashchange 只能监听 hash 的变化，而 popstate 不只是 hash 变化，功能更多。"}),"\n",(0,s.jsx)(c.p,{children:"所以用 popstate 事件就足够了。"}),"\n",(0,s.jsx)(c.p,{children:"其实在 react router 里，就只用到了 popstate 事件，没用到 hashchange 事件："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:O,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:M,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"接下来我们就具体来看下 React Router 是怎么实现的吧。"}),"\n",(0,s.jsx)(c.p,{children:"创建个 react 项目："}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{children:"npx create-react-app react-router-test\n"})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"安装 react-router 的包："}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{children:"npm install react-router-dom\n"})}),"\n",(0,s.jsx)(c.p,{children:"然后在 index.js 写如下代码："}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-javascript",children:"import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport {\n  createBrowserRouter,\n  Link,\n  Outlet,\n  RouterProvider,\n} from \"react-router-dom\";\n\nfunction Aaa() {\n  return <div>\n    <p>aaa</p>\n    <Link to={'/bbb/111'}>to bbb</Link>\n    <br/>\n    <Link to={'/ccc'}>to ccc</Link>\n    <br/>\n    <Outlet/>\n  </div>;\n}\n\nfunction Bbb() {\n  return 'bbb';\n}\n\nfunction Ccc() {\n  return 'ccc';\n}\n\nfunction ErrorPage() {\n  return 'error';\n}\n\nconst routes = [\n  {\n    path: \"/\",\n    element: <Aaa/>,\n    errorElement: <ErrorPage/>,\n    children: [\n      {\n        path: \"bbb/:id\",\n        element: <Bbb />,\n      },\n      {\n        path: \"ccc\",\n        element: <Ccc />,\n      }    \n    ],\n  }\n];\nconst router = createBrowserRouter(routes);\n\nconst root = ReactDOM.createRoot(document.getElementById('root'));\nroot.render(<RouterProvider router={router} />);\n"})}),"\n",(0,s.jsx)(c.p,{children:"通过 react-router-dom 包的 createBrowserRouter 创建 router，传入 routes 配置。"}),"\n",(0,s.jsx)(c.p,{children:"然后把 router 传入 RouterProvider。"}),"\n",(0,s.jsx)(c.p,{children:"有一个根路由 /、两个子路由 /bbb/:id 和 /ccc"}),"\n",(0,s.jsx)(c.p,{children:"把开发服务跑起来："}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{children:"npm run start\n"})}),"\n",(0,s.jsx)(c.p,{children:"测试下："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:Q,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"子路由对应的组件在 <Outlet/> 处渲染。"}),"\n",(0,s.jsx)(c.p,{children:"当没有对应路由的时候，会返回错误页面："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,UklGRloNAABXRUJQVlA4IE4NAAAwXwCdASqIAv4APp1Oo02lpCMiIXI4wLATiWlu4XXl7mLIst4x/wHbl/qPD3yiems/fJv5H/QeK378fv/NvvR+UGoF+Tf03/Vb1ns344+wF7kfav+H4lWpf4O9gDgKaAX6R9FHPM9g+wZ02PSRDHJFyygZsiD/jKff1rqGgVK7FcS1+iuJa/RXEtZJ95/UmK299GwvRUg5VlBQmF5p8ICmFpUvsP/gZ1JPU86Han73QzTgcDq2dqfFzfBavxZgIRnrNLmw9lXRA9fBDC/XsKuwXhLLJNNLi6m9XSnK5rM/2K5km4+QMpuLir0k2VB77xccfquIJUF3OSBKTOwRXnQ4VpCAdL8ieFUlqid6E3G1pEOX6P/xzpwA9hK3ykEx9Z5jaEPmLxdZC7lO21H9mLXBPCR3UjdY+NYtKHNjJ2XIyRcJjkVSr47Gb5cGbE9TodcGadWgBoplUXM0w9t5p21OLSqBFtiEQefcDfEw6Gq/t0q4tVX3tbFu2Ogz4ZkJQowpxG0F9CHlpzdaAhPQDwOQBsG6Pf83BsnZEDTRIZmwYjivi1oVYkq/J6y5zoxjvfygZskXLKBmyRZdGzV9p8xrmaCrvmHKuPXzD9UoIkXJWFXBxnHOoc3xRIbdeiw/LUcCHrvikmoRyz0lJl+Vljy4M2SLllAzZIuWUDNki5ZQMgkpq4L2gqRzfSwgEsQuKaHotvH5Ycmcpa6liAuyRcsoGbJFyygZskXLKBmxJ/yQiXJqi3jk54dbIZT20Qf2lsBh5ZoD+QesCygZskXLKBmyRcsoHFzSgWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIuWUDNki5ZQM2SLllAzZIgkz6DBD9o3tsDB+Zp1eLWKDuGQWu8u4cYFn0Fv+5UxLesCygZskXLKBmyRcsoGRA3FG4JgIITIyID5gVnfOBwzS4gAD+/3UClulYXHGceJFsEi8GmMbWPykXg0xjax+Ui8GmMbWPykXg0xjaTOmD7/aHPHaCKyt1Md5s2lDesuehMs9VscBp0xLzNkbvSecccQWmWqIq0mlbXd2KgZhFd0+cEte/3NY0U1oWlt2oKRa+wNpgU1WIGs/rWcPnDaLGxzkMHlXR83pIUXGlFVLgz16bGQ4QZsaWDDBD4DUD4AnA2cRBwbmFHzYO6ZsbVwpl0kDyaautKD85L/BkggqyaAU31jWKCiTdXIFAxzC2Vs13P1gg9w2kNVg9yLabID7vxO+T7ahg5UEQeX5VbMDenB1+Q0C+4YxmtVol+Rq05uzCF2PpvFU2XCUKES1I5kDTS36OQlsikbA5Ec+RHppDEgJWfdz4+zayzksYq7DxgwNPlvB37aJfzGkPPsjRMWQkt5taNibo9RVn8R44JI19h4ns96kQaOwqyHVE3YhIa2iL9yx/nU1V8xzzbHLY+TwnTtcAMoHVIX2skJolnooeHPraftquJVV94Fhl8Heyc+gVGJVeBaAsWHZDhb/vLyz/TJswxiJ4o/pNCN4Ot8cOSrBU6j8mC+d4t4XKcbVbXsaf0+PoePjvane81H6jP0F5AQya5H6USm1wT+zv3bL6RvXTSd00S/mYe12TLiw+OKyTar/sns+zHu5mg2dSTRoja3YzE6r8XzM5Glv01XqHChVuqISuDkb/fAPZXhqV6zZ54KC49QeYmraGHyWtwcHWvX44as+5A1Gq5/BXiTHeA8moId0Plc9RIWjuXxH86PVwxzfA9yHQupDyC2EMKm3ZhVdLyLlCz2LFnShf6Kf/k6L6F6PL6g+0i6XhJNxPm066p88mjkqn66OMlkd5P9u4eKHtNtgWSMDr4oR4Uc3+tTvXo55Mx3YCjB0AoL4d9ZLd+QMXk6HnhFtbV3bxekwDZU1/bVw92ciQQwT+I+J4tsDRuo+URy9UOwXPKF2jzYwHDeA222h9dzcsmaKvA6/3DHotMPyUGIay4lSzXs1lXrniWde6+o4t4dTc3LNmngMFioTpeRQaPdarXiTimv7jNjBxZI+8tKv0VspAHzsvYAbONd9YwRTf62S85qbbXhfdVtleUI1BtOhVM0yxSE+jK8zJp0FcHAXk0Z9iFGE45Qok9R7yD8C7nuJoMyTMMTPXQyZOyE5UK7T/lm8KS/+wbaA/CcrM6YPW4N/LfrnAFRKiaeZi4WNfo3RyY3dMgfo/u7cca5wtfEC3R7HtP2A3xmE70QCo5WPrE+Kxb9zMJWWyuQ4x/t2WZlmvoVOzjMLcF4jqXdppabKe7IsG+GQH8ZWFZrvdWCFIXaWSjg+CYpWHHA5a2UFSFLS3v/53QX/ETlDqKf+ZrJKYiaMjOh3XDuobyXpKFjT2ftxSeoOfFzatdp2r78hii91DaHp6fpOCuIRxQaoFjJcJYyTtHiBWH69i1t5eb/z3jCtTwZhwrGP6BN46FiaXVOKroWzNIpklvaxvuOgm/DbdogCdi1npOA88OU+SPjHUZAjcSRrZRUWYgTobkoX97DVbvay6wGE9539D08hV5dCbWe/zW6qUkhZeyqbDjwtddvHDyNJRHdSdItCK8K4awZ6TUhJD8mrCVntf7AnTgGAmF9+GNzpQXjhpCKtf/x+YF8kpI3ZwAVno8KcFbonjb2RiZF5CALxd42U2LS6JDN9mL3rKspvPGNkeFYVaDlE+dar1y/qh4iE3v8WUtJZwQuEUHkEtQAzbq58TBAIBbHGqSpN3qJgWvZYYRcBp8l5mN0k74g5Nt3vo+wP0NRiQVgXr3g8d9J7Q1mI0iKnBVltVtimnK5N3ROaPa3loLIMin12yPOfzfJeG3zfWS4UsjIFQUmh81phcEilU2Q66woIE4WWpX7XH/HSpzzSs09uykIhql/WznyfrOePsaPD+wP5ftlNpIyzq6y2fXVDXAhtyH200fjLwcVwLV1GVa8G3H+Zynlb9N8mnzzbmSd3gJqs6e1WxFpjdCk73wWTjHoxe8XXU76hAn6v97g/zebrRK9FTRwbe0dEX/G+xRF9/DeMhgNgPE4iBiB2JsPSfZh48cg8lePl8jrDSCMZIRoi37AqLJz6LJU2WzIYvnNEnQVUMswMnoXDyoss8MWR7yMaMj3aICF4B4+YOtKClNWs9exRZR2y8kJvxQGT+OHbeuxOpk0v06eoNPOnc3xR1Fsaq9NizuIFqTB32LRL74A7GQmkTwF+8OUFm/RN+uRnZDraqsrQ0v0IdVmYOoBPGrQplZcnn5jBtuKhM1vS0R5dJLfrlmlq43T9WjlAPumpVe08KyNwDeI317xTYyvwoAPwoEWtYoUecmLLIS4tn5owZcouJmoZ2kM7hLlPRbJ5qxDTfG6oxW32yZzw9UP4ZgDLzGOO8+/jni/DcU1K7NtQEu2DbJ4mDapXCRZAvamXiRY/8bXpRutAvDvLY/Qr7J7s8TH9zHqI/6graEtMe+NIC6wgfndDEG+HkBPKybAIZ0/X+GXm7tZVMhriqSfTfUR2q2YrmF3ILUV7e2O5qwulbSzX9bybEcpiHfEcikdK9CO1MDiUn56sR7sgtmjbGA3f5BEfob4Hw51aoNvISX3skBscBmcRDBzqcTqSNqI0mxiD74KiI7SN4JJZzgONzMcsfLYbJgLcOWPkm+sWf2bKho9aBi6fLb9wJgBEoUTmyTnJEqe6DGdDPf2p9szFOwAfsYx9r9X/40iOIO/mXjjfJz1HzlzfZ0g1uZcEjZIfYOTbU9r/Zklm1E5R4CF/tKfPuLCGnPfKlhG5UXCk4562LjEZbaI0RLg7NAUGjPMmBZNmcu3KWN8libgMDCldmjjWchwsmR7UthiXtDWMiokiwYLpiGf1knsPcF5Y3pG+EpO5hQH7NFQAAAAAAAAAAAAfAh6CLPmHa3BBXXeoeSpTMgHLWW/vStG+IUyJIAgqYupYwjo/D03/HlQkSZ4Vqt76rMAiMHugl7uNwvMacoCzBcrL42Csh0KFjMHwXHOqzEtH6lYk7tbZcFmm3oEV7eaiOrOXbNfohpZoaVdAZfoZs6d40ytW8wyKoW7r8b+2d9ubed2LvXld/Guaw9Zpo/i0lhi4DdoekQF/eQKbaxa32lV/zJrXLMQdTEYyAG31jel1t8ZKzw/3Pl2r+/KNvxqmP3bSKFe0A9iFKnaPxsCZXHMgLUQBBP2Tx2n2Lx4TVgRQMdgcUlY08P16ytTzYr6jExNuvVAmHNlovqS/cZa66o3YDuW/n3zsqLjPhNJxEuQMkS8z7SCPUL2lkng9g9usJBaxDWowU9HuU25xtx7pLDXSRcnuXsuQtKsl6hhWlcx30gDNQWjdSgyKSQLnUO7gbkhOlducBVYXFbUUrB1Wy0SqJcFo6Z4hE3TK0OxXxcaBqcUPs2x9F9+fZyh+RKGTik8AQMzs1qGjow54XXK5Ip7RXny6aONR6uz+gGFXNTH3amKNEKLCRlSQder8k0T2tlmy6ckpZ7S0lxsercvjwydAAAAAA",alt:""})}),"\n",(0,s.jsx)(c.p,{children:"那它是怎么实现的呢？"}),"\n",(0,s.jsx)(c.p,{children:"我们断点调试下："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:W,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"创建调试配置文件 launch.json，然后创建 chrome 类型的调试配置："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:K,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"在 createBrowserRouter 的地方打个断点："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:I,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"点击 debug："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"代码会在这里断住："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"点击 step into 进入函数内部："}),"\n",(0,s.jsx)(c.p,{children:"它调用了 createRouter："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:U,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这里传入了 history。"}),"\n",(0,s.jsx)(c.p,{children:"这个不是原生的 history api，而是包装了一层之后的："}),"\n",(0,s.jsx)(c.p,{children:"关注 listen、push、replace、go 这 4 个方法就好了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:F,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"listen 就是监听 popstate 事件。"}),"\n",(0,s.jsx)(c.p,{children:"而 push、replace、go 都是对 history 的 api 的封装："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:H,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"此外，history 还封装了 location 属性，不用自己从 window 取了。"}),"\n",(0,s.jsx)(c.p,{children:"然后 createRouter 里会对 routes 配置和当前的 location 做一次 match："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:z,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:L,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"matchRoutes 会把嵌套路由拍平，然后和 location 匹配："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"然后就匹配到了要渲染的组件以及它包含的子路由："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:Z,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这样当组件树渲染的时候，就知道渲染什么组件了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:X,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"就是把 match 的这个结果渲染出来。"}),"\n",(0,s.jsx)(c.p,{children:"这样就完成了路由对应的组件渲染："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"也就是这样的流程："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"当点击 link 切换路由的时候："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"会执行 navigate 方法："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"然后又到了 matchRoutes 的流程："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"match 完会 pushState 或者 replaceState 修改 history，然后更新 state："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"然后触发了 setState，组件树会重新渲染："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"也就是这样的流程："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"router.navigate 会传入新的 location，然后和 routes 做 match，找到匹配的路由。"}),"\n",(0,s.jsx)(c.p,{children:"之后会 pushState 修改 history，并且触发 react 的 setState 来重新渲染，重新渲染的时候通过 renderMatches 把当前 match 的组件渲染出来。"}),"\n",(0,s.jsx)(c.p,{children:"而渲染到 Outlet 的时候，会从 context 中取出当前需要渲染的组件来渲染："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"这就是 router 初次渲染和点击 link 时的渲染流程。"}),"\n",(0,s.jsx)(c.p,{children:"那点击前进后退按钮的时候呢？"}),"\n",(0,s.jsx)(c.p,{children:"这个就是监听 popstate，然后也做一次 navigate 就好了："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"后续流程一样。"}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"回过头来，其实 react router 的 routes 其实支持这两种配置方式："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"效果一样。"}),"\n",(0,s.jsx)(c.p,{children:"看下源码就知道为什么了："}),"\n",(0,s.jsx)(c.p,{children:"首先，这个 Route 组件就是个空组件，啥也没："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"而 Routes 组件里会从把所有子组件的参数取出来，变成一个个 route 配置："}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:n,alt:""})}),"\n",(0,s.jsx)(c.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(c.p,{children:"结果不就是和对象的配置方式一样么？"}),"\n",(0,s.jsxs)(c.h2,{id:"总结",children:["总结",(0,s.jsx)(c.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(c.p,{children:"我们学习了 history api 和 React Router 的实现原理。"}),"\n",(0,s.jsx)(c.p,{children:"history api 有这些："}),"\n",(0,s.jsxs)(c.ul,{children:["\n",(0,s.jsx)(c.li,{children:"length：history 的条数"}),"\n",(0,s.jsx)(c.li,{children:"forward：前进一个"}),"\n",(0,s.jsx)(c.li,{children:"back：后退一个"}),"\n",(0,s.jsx)(c.li,{children:"go：前进或者后退 n 个"}),"\n",(0,s.jsx)(c.li,{children:"pushState：添加一个 history"}),"\n",(0,s.jsx)(c.li,{children:"replaceState：替换当前 history"}),"\n",(0,s.jsx)(c.li,{children:"scrollRestoration：保存 scroll 位置，取值为 auto 或者 manual，manual 的话就要自己设置 scroll 位置了"}),"\n"]}),"\n",(0,s.jsx)(c.p,{children:"而且还有 popstate 事件可以监听到 history.go、history.back、history.forward 的导航，拿到最新的 location。"}),"\n",(0,s.jsx)(c.p,{children:"这里要注意 pushState、replaceState 并不能触发 popstate 事件。也就是 history 之间导航（go、back、forward）可以触发 popstate，而修改 history （push、replace）不能触发。"}),"\n",(0,s.jsx)(c.p,{children:"React Router 就是基于这些 history api 实现的。"}),"\n",(0,s.jsx)(c.p,{children:"首次渲染的时候，会根据 location 和配置的 routes 做匹配，渲染匹配的组件。"}),"\n",(0,s.jsx)(c.p,{children:"之后点击 link 链接也会进行 location 和 routes 的匹配，然后 history.pushState 修改 history，之后通过 react 的 setState 触发重新渲染。"}),"\n",(0,s.jsx)(c.p,{children:"前进后退的时候，也就是执行 history.go、history.back、history.forward 的时候，会触发 popstate，这时候也是同样的处理，location 和 routes 的匹配，之后通过 react 的 setState 触发重新渲染。"}),"\n",(0,s.jsx)(c.p,{children:"渲染时会用到 Outlet组件 渲染子路由，用到 useXxx 来取一些匹配信息，这些都是通过 context 来传递的。"}),"\n",(0,s.jsx)(c.p,{children:"这就是 React Router 的实现原理，它和 history api 是密不可分的。"})]})}function eS(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:c}=Object.assign({},(0,t.ah)(),e.components);return c?(0,s.jsx)(c,{...e,children:(0,s.jsx)(ek,{...e})}):ek(e)}let eX=eS;eS.__RSPRESS_PAGE_META={},eS.__RSPRESS_PAGE_META["React%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%2F%E7%AC%AC44%E7%AB%A0%E2%80%94Historyapi%E5%92%8CReactRouter%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"第44章—Historyapi和ReactRouter实现原理",headingTitle:"第44章—Historyapi和ReactRouter实现原理",frontmatter:{}}}}]);