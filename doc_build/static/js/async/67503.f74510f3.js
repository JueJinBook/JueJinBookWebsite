"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["67503"],{939456:function(n,e,c){c.r(e),c.d(e,{default:()=>nG});var i=c(552676),s=c(740453);let a=c.p+"static/image/55f85618764a2e2d48e7fe32390c3d2e.60d2f136.webp",t=c.p+"static/image/2e78207e03562daa6a937f7688d00029.85c28999.webp",d=c.p+"static/image/8db4b54310905f1391a7efc2d8d7a031.de59a670.webp",r=c.p+"static/image/65de663e130c3487115ceaab286886cf.b2ea79a5.webp",l=c.p+"static/image/b6afd27602fa8fb09cc7468c8010f9e9.c20dde82.webp",p=c.p+"static/image/e1e36714c9a30dd8903e7d8b9cd258d9.02c71853.webp",h=c.p+"static/image/8d4b1b9e051f511ac990c2c83eba27b8.ae99f564.webp",o=c.p+"static/image/35102538cb15fd52b5f294e2a2603ea1.e3d9fa4f.gif",x=c.p+"static/image/0df2343118fc64124a559826b9755e1e.a1e0ac30.webp",j=c.p+"static/image/a958df1e70e84947ef3e24836f561193.3a16134c.webp",m=c.p+"static/image/aaf602d6dbd62ccf237a59ccc92e62aa.7ba343e8.webp",f=c.p+"static/image/25e6ffdf0b09f1c9f964efcc34a7f4fa.0a5a5b54.webp",b=c.p+"static/image/a096b403b5a12371cc3a9148d04facfd.f95b77d2.webp",g=c.p+"static/image/35daf731ff11b43955d966760fd1fe9e.a49f17dc.webp",u=c.p+"static/image/1d9f92edd3cadf7ed4f256497576c243.d4ee4933.webp",w=c.p+"static/image/e2d76c9770fbdb40d9a472e3ee7dcec8.deeea048.webp",k=c.p+"static/image/c7a4e1a3e52a70642ce5df1461fa81f7.c68ff0f2.webp",y=c.p+"static/image/1ac5e875c12ffe2c4354f63d4dc41c99.7ebef913.webp",E=c.p+"static/image/8a889ec0f9ff8231936937086c80228a.d8867da7.webp",A=c.p+"static/image/d258dc633720d18e899870f9bc17f845.04e2a23a.webp",q=c.p+"static/image/9e9270bb58d63b9e8464eb98203b3a0d.7096e793.webp",v=c.p+"static/image/68e022183f63dde578dfc7eb0715ed93.515a2146.webp",P=c.p+"static/image/c59b6c92ea6e166c7184fcf0d559ccbc.b84b4bd7.webp",N=c.p+"static/image/314fc35cc53ef04a7a1e0e75b4421f15.8c27cfba.webp",T=c.p+"static/image/1cf6aef1397dc2b7d92a7a7a93411c8f.30aaf7ad.gif",Q=c.p+"static/image/bc26cadb95215ab7abd6ed3d22a52371.509c7ff2.webp",D=c.p+"static/image/d7a9f0cf5f7658b7d148d5aa2ddbc2ed.5d645258.webp",S=c.p+"static/image/4ae6e049d76d522e6726c6e7e1d06e6a.209620cb.webp",B=c.p+"static/image/f32f7885f852632c4ef95089eb2303d6.5d6da86a.webp",z=c.p+"static/image/a2f45f816974ce4ed755db70d0be93c8.9235432f.webp",I=c.p+"static/image/0f5ef0ff0fcabd67a8a475ff91530477.e08d63eb.webp",G=c.p+"static/image/e7a896d6938e888b07d8ff701b49b913.3763a9f3.webp",C=c.p+"static/image/e5336f5e77f2d4234d6c38eb1f024d92.8733beb0.webp",F=c.p+"static/image/123e697a9cd80102e809c8869e25a3d4.b246b565.webp",O=c.p+"static/image/928c5dbcf843c6283a724fc246947ea8.dae2c4bf.webp",Z=c.p+"static/image/a123de6f0a73e21822c8b911c2c3f453.79ead76e.webp",L=c.p+"static/image/0af4f06e07f9d7a53edf94c6316fe0b6.f29753fe.webp",Y=c.p+"static/image/ce520529673818dc393388eadf66a78b.a52c0568.webp",U=c.p+"static/image/3305d45796458aa3c695d99401678515.bd7e51cf.webp",X=c.p+"static/image/ec15c20ddf69c38389c8338a11ee2668.e645f87b.webp",H=c.p+"static/image/85fd1f2bdab97d87fdcbea26d366495f.a6952d1e.webp",K=c.p+"static/image/9d798665c109d417c900cf2eda402606.63f4004a.gif",R=c.p+"static/image/afa2cf37a3d28a900fb6f65f686d3a4c.011523c8.gif",W=c.p+"static/image/ca92523545f7a53b2f496c566583a361.04fd695e.webp",M=c.p+"static/image/e4f9b8771068889f80af3a9a274ad632.c6569c69.webp",J=c.p+"static/image/ac5967f2eca175d5a108a98c38b5f1d6.4d9414f0.webp",V=c.p+"static/image/f058771eb4fef0c24f791ccd374b92b9.84c2c705.webp",_=c.p+"static/image/ac8a4b6ce0aff9368e50e3b754dba49e.751d5446.webp",$=c.p+"static/image/60d029f8a3051b7f270ce745aec1d8ea.ceb65c43.webp",nn=c.p+"static/image/9b5b05a6414a04d5c6d10fd144ba4ad4.2c7c6783.webp",ne=c.p+"static/image/5e12e9f4e7a80fbf30ee96c1a9df2a9f.f0c58f39.webp",nc=c.p+"static/image/50aa49d0f1f9dbd0d023f5497604b2cc.691b121e.webp",ni=c.p+"static/image/c6c6d01fe0b31b5a2d352fe52f499f23.1f405073.webp",ns=c.p+"static/image/5baad5ed7d84a1cdbe63ed2915b69623.ee6402c0.webp",na=c.p+"static/image/3e5bf7c95a103bce0753b82fbc9d46ed.b8cc83e6.webp",nt=c.p+"static/image/772c14644e95721d7d384550b4ecee98.b656c0d7.webp",nd=c.p+"static/image/66644824a212b8eac4057f1d48a7b5c1.7f59aee2.webp",nr=c.p+"static/image/7f5fcb12e6727f4b4acbf5bc6674700f.f5e86933.webp",nl=c.p+"static/image/8358eac5f6a177b65345eb256ee194c6.52fb9a58.webp",np=c.p+"static/image/efa3699a1dcac2ab0a1e254ffe22bf5d.e829d18f.webp",nh=c.p+"static/image/62a38c5fd1c5020c74e673a2d04c6536.bd7d93b6.webp",no=c.p+"static/image/7ad9154e351d2cd79f45865630a32f1b.86001246.webp",nx=c.p+"static/image/494f87ea52f83f8fd9d748c517acc16d.e2aeac41.webp",nj=c.p+"static/image/08eb7080167d7b9e20eb9c17e81a7429.efa5f24a.webp",nm=c.p+"static/image/abb51b6d2e8f91db6853fb5533681002.44bfcb1b.webp",nf=c.p+"static/image/8788685a2758d3c41b0f82d731f6d256.a6c48631.webp",nb=c.p+"static/image/f58cdb8d3453bb0399c076a0ab734b28.e9ff2c36.webp",ng=c.p+"static/image/a221e6b7405b92465f6582282112a3cf.1dea9261.webp",nu=c.p+"static/image/bbc5837785c739c53c365caf3f97411d.b5352922.webp",nw=c.p+"static/image/c9f2447ebb9e0197838879babfaf4462.31ec7d02.webp",nk=c.p+"static/image/308dc6e237dd6bd61b7561364daccb0f.7b95a6c5.webp",ny=c.p+"static/image/b2f071c9207d92a84d82985355a4d948.1fa5791f.webp",nE=c.p+"static/image/a7fab46f473f09ae718d6804f99b90d9.4e0c69a9.webp",nA=c.p+"static/image/4bd3028105d03f97c9fab01cb2114f0a.b6ee35ab.webp",nq=c.p+"static/image/ad27b1f0dbfa6a125e7162905b84b958.7caa8ec1.webp",nv=c.p+"static/image/97d576558d4342fd584a7be2a7dfc03b.b5e57d85.webp",nP=c.p+"static/image/a363224635a751fd3f72ba6e093dcaa7.a5ae334a.webp",nN=c.p+"static/image/072ba98f1b3e46b3c32d6688b3153a19.682894ab.webp",nT=c.p+"static/image/1718ca6f3aa56004b5ee22be6c605306.782a41bf.webp",nQ=c.p+"static/image/35c9ddb5e3ab320aec4ecc6e1073cca5.a5250488.webp",nD=c.p+"static/image/e9c8370959a475e7a32b9ee9db021646.47ca2cb9.gif",nS=c.p+"static/image/080df855a2d399e0647c0d30a3d258ae.cccf2275.gif",nB=c.p+"static/image/2a155868251bea3086343c9fe81c03ab.f1782703.webp";function nz(n){let e=Object.assign({h1:"h1",a:"a",p:"p",img:"img",ul:"ul",li:"li",pre:"pre",code:"code",h2:"h2"},(0,s.ah)(),n.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.h1,{id:"103-实现扫二维码登录",children:["103. 实现扫二维码登录",(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#103-实现扫二维码登录",children:"#"})]}),"\n",(0,i.jsx)(e.p,{children:"扫码登录是常见的功能，基本各种网站都支持。"}),"\n",(0,i.jsx)(e.p,{children:"比如掘金的登录就支持 APP 扫码的方式："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nB,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"如果你 APP 没登录，扫码后会跳到登录页面："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nS,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"登录之后，会进入确认界面，你可以选择授权登录或者取消："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nD,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这边确认之后，pc 网站就登录了。"}),"\n",(0,i.jsx)(e.p,{children:"知乎，b 站等也是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nQ,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nT,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"有没有感觉很神奇，为什么一扫二维码，然后确认下，那边就自动登录了呢？"}),"\n",(0,i.jsx)(e.p,{children:"其实原理也很简单。"}),"\n",(0,i.jsx)(e.p,{children:"我们先用解析工具解码下二维码的内容："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nN,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nq,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"可以看到，二维码的内容是一个 url，如果在手机浏览器打开，是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nP,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"会让你下载 APP。"}),"\n",(0,i.jsx)(e.p,{children:"而在 APP 里打开，就是登录确认界面了："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nv,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"那确认的是哪个二维码呢？"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nq,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"二维码这里是有个唯一 id 的，通过这个 id 就知道是哪个二维码。"}),"\n",(0,i.jsx)(e.p,{children:"这个二维码有 5 个状态："}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"未扫描"}),"\n",(0,i.jsx)(e.li,{children:"已扫描，等待用户确认"}),"\n",(0,i.jsx)(e.li,{children:"已扫描，用户同意授权"}),"\n",(0,i.jsx)(e.li,{children:"已扫描，用户取消授权"}),"\n",(0,i.jsx)(e.li,{children:"已过期"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"最开始是未扫描状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ny,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"扫码后会进入等待用户确认状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nA,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"确认后会进入同意授权状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nE,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"取消的话会进入取消授权状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ny,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"长时间不操作会进入过期状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nk,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"也就是说，扫码后进行不同的操作就是修改这个 id 对应的二维码的状态。"}),"\n",(0,i.jsx)(e.p,{children:"另一边修改了状态，这边是怎么知道二维码状态变了呢？"}),"\n",(0,i.jsx)(e.p,{children:"websocket 么？"}),"\n",(0,i.jsx)(e.p,{children:"不用，一般都是轮询来做。"}),"\n",(0,i.jsx)(e.p,{children:"比如掘金："}),"\n",(0,i.jsx)(e.p,{children:"二维码出现后，会有一个每秒一次的轮询请求来查询二维码状态："}),"\n",(0,i.jsx)(e.p,{children:"最开始是 new："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nw,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"扫码后会变成 scanned："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nu,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"知乎也是一样："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ng,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nb,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这时候，手机会进入登录确认页面："}),"\n",(0,i.jsx)(e.p,{children:"bilibili 的登录确认页面："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nf,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"知乎的登录确认页面："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nm,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这边点击确认登录或者取消之后，会发请求修改 id 对应的二维码的状态。"}),"\n",(0,i.jsx)(e.p,{children:"那边一直在轮询，自然就知道了二维码状态的变更。"}),"\n",(0,i.jsx)(e.p,{children:"也就是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nj,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"服务端有个 qrcode/generate 接口，会生成一个随机的二维码 id，存到 redis 里，并返回二维码。"}),"\n",(0,i.jsx)(e.p,{children:"还有个 qrcode/check 接口，会返回 redis 里的二维码状态，浏览器里可以轮询这个接口拿到二维码状态。"}),"\n",(0,i.jsx)(e.p,{children:"然后手机 APP 扫码之后，如果没登录，会先跳转到登录页面，登录之后会进入登录确认页面。"}),"\n",(0,i.jsx)(e.p,{children:"这个时候就从二维码中拿到了 id，然后调用 qrcode/scan、qrcode/cancel、qrcode/confirm 就是修改二维码为不同的状态。"}),"\n",(0,i.jsx)(e.p,{children:"这时候用户是登录了的，jwt 的登录认证方式会携带 token，服务端只要从 token 中取出用户信息，存入 redis 即可。"}),"\n",(0,i.jsx)(e.p,{children:"然后另一边的轮询接口发现是确认状态，会根据用户信息生成 jwt 返回。"}),"\n",(0,i.jsx)(e.p,{children:"这样，手机 APP 里确认之后，pc 的浏览器就自动登录了该用户账号。"}),"\n",(0,i.jsx)(e.p,{children:"这里的 jwt 是保存登录状态的一种方案，会把用户信息放在 token 里返回，然后每次访问接口带上 authorization 的 header，携带 token。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nx,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"思路理清了，我们来实现一下吧！"}),"\n",(0,i.jsx)(e.p,{children:"创建个 nest 项目："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm install -g @nestjs/cli\n\nnest new qrcode-login\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:no,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"把它跑起来："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm run start:dev\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nh,alt:""})}),"\n",(0,i.jsxs)(e.p,{children:["浏览器访问 ",(0,i.jsx)(e.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 就可以可以看到 hello world，就代表服务跑起来了："]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后我们实现下生成二维码的接口："}),"\n",(0,i.jsx)(e.p,{children:"安装下用到的包："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm install qrcode @types/qrcode\n"})}),"\n",(0,i.jsx)(e.p,{children:"添加一个路由："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:np,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { randomUUID } from 'crypto';\nimport * as qrcode from 'qrcode';\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('qrcode/generate')\nasync generate() {\n    const uuid = randomUUID();\n    const dataUrl = await qrcode.toDataURL(uuid);\n    return {\n      qrcode_id: uuid,\n      img: dataUrl\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"这里用 node 的 crypto 模块生成一个随机的 uuid。"}),"\n",(0,i.jsx)(e.p,{children:"然后用 qrcode 生成二维码，只不过转成 base64 返回。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nl,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"我们在 html 里把它渲染出来看一下："}),"\n",(0,i.jsx)(e.p,{children:"新建 static/index.html"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>扫码登录</title>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n    <img src="data:image/png;base64,这里填入你生成的 url" alt=""/>\n</body>\n</html>\n\n'})}),"\n",(0,i.jsx)(e.p,{children:"然后在 main.ts 里支持这个目录下静态资源的访问，用 pages 作为前缀："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nr,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { NestExpressApplication } from '@nestjs/platform-express';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestExpressApplication>(AppModule);\n\n  app.useStaticAssets('static', { prefix: '/pages'});\n\n  await app.listen(3000);\n}\nbootstrap();\n"})}),"\n",(0,i.jsxs)(e.p,{children:["这样你访问 ",(0,i.jsx)(e.a,{href:"http://localhost:3000/pages/index.html",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/pages/index.html"})," 就可以看到二维码了："]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nd,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"我们用在线解码工具解码下看看："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nt,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"确实，内容就是生成的 uuid。"}),"\n",(0,i.jsx)(e.p,{children:"然后，其实这个二维码扫出的应该是个网址。"}),"\n",(0,i.jsx)(e.p,{children:"比如掘金的二维码解析出的内容："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:na,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"如果用手机浏览器扫这个码的话，打开的就是下载 APP 的页面："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ns,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"而如果用掘金 APP 扫码，扫出的就是登录确认页面了："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ni,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这个很正常，因为如果随便一个浏览器都能扫码打开登录确认页面，那谁还下载掘金 APP 呢？"}),"\n",(0,i.jsx)(e.p,{children:"所以掘金的二维码只能掘金 APP 扫，微信的二维码只能用微信 APP 扫。"}),"\n",(0,i.jsx)(e.p,{children:"这个页面做了检查，判断是 APP 打开的还是其他方式打开的，分别会显示不同的内容。"}),"\n",(0,i.jsx)(e.p,{children:"这里我们也改成一个 url："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nc,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"扫码就会打开这个页面，而这个页面就是登录确认页面。"}),"\n",(0,i.jsx)(e.p,{children:"我们写一下这个页面："}),"\n",(0,i.jsx)(e.p,{children:"新建 static/confirm.html"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>扫码登录确认</title>\n</head>\n<body>\n    <button>确认登录</button>\n    <button>取消</button>\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(e.p,{children:"但这里有个问题，开发服务是在电脑上的，手机怎么访问呢？"}),"\n",(0,i.jsx)(e.p,{children:"这里需要用 charles 来做代理："}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.a,{href:"https://www.charlesproxy.com/download/",target:"_blank",rel:"noopener noreferrer",children:"下载 charles"}),"，打开"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:ne,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"让电脑和手机连接同一个 wifi，然后在手机的 wifi 设置那里设置代理："}),"\n",(0,i.jsx)(e.p,{children:"代理的 ip 是电脑 ip，端口号就是 charles 代理服务的默认端口 8888"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:nn,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这时候电脑上会收到连接提醒，同意下就好了："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:$,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后手机就可以访问电脑上的 nest 服务："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:_,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"看到这个 hello world 了没？"}),"\n",(0,i.jsx)(e.p,{children:"这就是电脑上的这个 nest 服务返回的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:V,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"那个登录确认页面在电脑访问是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:J,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后我把二维码的内容改为这个："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:M,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"修改下展示二维码的页面："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>扫码登录</title>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <script src="https://unpkg.com/axios@1.5.0/dist/axios.min.js"><\/script>\n</head>\n<body>\n    <img id="img" src="" alt=""/>\n\n    <script>\n        axios.get(\'http://localhost:3000/qrcode/generate\').then(res => {\n            document.getElementById(\'img\').src = res.data.img;\n        })\n    <\/script>\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(e.p,{children:"用 axios 请求生成二维码的接口，然后修改图片 src。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"用手机扫码下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"用微信扫码，可以看到，打开了登录确认页面。"}),"\n",(0,i.jsx)(e.p,{children:"按钮有点小，我们设置下样式。"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>扫码登录确认</title>\n    <style>\n        #info {\n            height: 400px;\n            line-height: 400px;\n            font-size: 20px;\n            padding: 20px;\n        }\n        #confirm, #cancel{\n            display: block;\n            width: 80%;\n            line-height: 40px;\n            font-size: 20px;\n            margin-bottom: 20px;\n        }\n        #confirm {\n            background: skyblue;\n        }\n    </style>\n</head>\n<body>\n    <div id="info">\n        是否确认登录 xxx 网站？\n    </div>\n    <button id="confirm">确认登录</button>\n    <button id="cancel">取消</button>\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:K,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"好看多了。"}),"\n",(0,i.jsx)(e.p,{children:"二维码的内容解码后是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:H,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后我们来实现剩下的接口："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:X,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"生成二维码之后，要在 redis 里保存一份，这里我们简化一下，直接用个 map 保存吧。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"const map = new Map<string, QrCodeInfo>();\n\ninterface QrCodeInfo{\n  status: 'noscan' | 'scan-wait-confirm' | 'scan-confirm' | 'scan-cancel' | 'expired',\n  userInfo?: {\n    userId: number;\n  }\n}\n// noscan 未扫描\n// scan-wait-confirm -已扫描，等待用户确认\n// scan-confirm 已扫描，用户同意授权\n// scan-cancel 已扫描，用户取消授权\n// expired 已过期\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"map.set(`qrcode_${uuid}`, {\n  status: 'noscan'\n});\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后加一个 qrcode/check 接口，用来查询二维码状态："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('qrcode/check')\nasync check(@Query('id') id: string) {\n    return map.get(`qrcode_${id}`);\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"测试下："}),"\n",(0,i.jsx)(e.p,{children:"访问 /qrcode/generate 生成二维码和 id"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Y,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后访问 /qrcode/check 拿到这个 id 的状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:L,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后再实现 /qrcode/confirm、/qrcode/cancel、/qrcode/scan 这三个接口："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('qrcode/scan')\nasync scan(@Query('id') id: string) {\n    const info = map.get(`qrcode_${id}`);\n    if(!info) {\n      throw new BadRequestException('二维码已过期');\n    }\n    info.status = 'scan-wait-confirm';\n    return 'success';\n}\n\n@Get('qrcode/confirm')\nasync confirm(@Query('id') id: string) {\n    const info = map.get(`qrcode_${id}`);\n    if(!info) {\n      throw new BadRequestException('二维码已过期');\n    }\n    info.status = 'scan-confirm';\n    return 'success';\n}\n\n@Get('qrcode/cancel')\nasync cancel(@Query('id') id: string) {\n    const info = map.get(`qrcode_${id}`);\n    if(!info) {\n      throw new BadRequestException('二维码已过期');\n    }\n    info.status = 'scan-cancel';\n    return 'success';\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"测试下："}),"\n",(0,i.jsx)(e.p,{children:"先 qrcode/generate 生成二维码，拿到 id："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Z,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后调用 qrcode/scan 修改状态，之后调用 qrcode/check 查询下状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:O,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"同样的方式测试 qrcode/cancel 和 qrcode/confirm 接口："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:z,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"如果 id 不存在，会返回 400 的状态码："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后就可以在 static/index.html 里加上 qrcode/check 接口来轮询二维码状态了。"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>扫码登录</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <script src=\"https://unpkg.com/axios@1.5.0/dist/axios.min.js\"><\/script>\n</head>\n<body>\n    <img id=\"img\" src=\"\" alt=\"\"/>\n    <div id=\"info\"></div>\n    <script>\n        axios.get('http://localhost:3000/qrcode/generate').then(res => {\n            document.getElementById('img').src = res.data.img;\n\n            queryStatus(res.data.qrcode_id);\n        })\n\n        function queryStatus(id) {\n            axios.get('http://localhost:3000/qrcode/check?id=' + id).then(res => {\n                const status = res.data.status;\n\n                let content = '';\n                switch(status) {\n                    case 'noscan': content = '未扫码'; break;\n                    case 'scan-wait-confirm': content = '已扫码，等待确认'; break;\n                    case 'scan-confirm': content = '已确认'; break;\n                    case 'scan-cancel': content = '已取消'; break;\n                }\n                document.getElementById('info').textContent = content;\n\n                if(status === 'noscan' || status === 'scan-wait-confirm') {\n                    setTimeout(() => queryStatus(id), 1000);\n                }\n            })\n        }\n    <\/script>\n</body>\n</html>\n"})}),"\n",(0,i.jsx)(e.p,{children:"生成二维码之后，就开始轮询状态了。"}),"\n",(0,i.jsx)(e.p,{children:"根据状态分别显示不同的文字，如果不是已确认或者已取消就在一秒后继续下次轮询。"}),"\n",(0,i.jsx)(e.p,{children:"然后，在登录确认页面也加上接口调用："}),"\n",(0,i.jsx)(e.p,{children:"改下 static/confirm.html"}),"\n",(0,i.jsx)(e.p,{children:"使用 URLSearchParams 的 api 拿到 url 中的 id："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:D,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后修改这个 id 对应的二维码的状态。"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>扫码登录确认</title>\n    <script src=\"https://unpkg.com/axios@1.5.0/dist/axios.min.js\"><\/script>\n    <style>\n        #info {\n            height: 400px;\n            line-height: 400px;\n            font-size: 20px;\n            padding: 20px;\n        }\n        #confirm, #cancel{\n            display: block;\n            width: 80%;\n            line-height: 40px;\n            font-size: 20px;\n            margin-bottom: 20px;\n        }\n        #confirm {\n            background: skyblue;\n        }\n    </style>\n</head>\n<body>\n    <div id=\"info\">\n        是否确认登录 xxx 网站？\n    </div>\n    <button id=\"confirm\">确认登录</button>\n    <button id=\"cancel\">取消</button>\n\n    <script>\n        const params = new URLSearchParams(window.location.search.slice(1));\n\n        const id = params.get('id');\n\n        axios.get('http://192.168.31.56:3000/qrcode/scan?id=' + id).catch(e => {\n            alert('二维码已过期');\n        });\n        \n        document.getElementById('confirm').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/qrcode/confirm?id=' + id).catch(e => {\n                alert('二维码已过期');\n            });\n        });\n\n        document.getElementById('cancel').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/qrcode/cancel?id=' + id).catch(e => {\n                alert('二维码已过期');\n            });\n        });\n    <\/script>\n</body>\n</html>\n"})}),"\n",(0,i.jsx)(e.p,{children:"进入这个页面，就访问 qrcode/scan 接口，来把 id 对应的二维码改为已扫描状态。"}),"\n",(0,i.jsx)(e.p,{children:"点击确认或者取消按钮也分别修改状态为确认和取消。"}),"\n",(0,i.jsx)(e.p,{children:"注意，这个页面是在手机打开的，需要通过 ip 的方式访问接口。"}),"\n",(0,i.jsx)(e.p,{children:"测试下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Q,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"打开页面后，生成二维码，这时候就开始轮询二维码状态。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"手机扫码，进入登录确认页面。"}),"\n",(0,i.jsx)(e.p,{children:"这时候二维码页面的状态变为了等待确认："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后确认登录，这时候 pc 页面变为了已确认状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"如果点击取消，那就会变为已取消状态："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这就是扫码之后，pc 上的二维码同步改变状态的原理。"}),"\n",(0,i.jsx)(e.p,{children:"当然，最终我们是要做登录的。"}),"\n",(0,i.jsx)(e.p,{children:"确认之后，就要拿到这边的登录状态，从中取出用户信息。"}),"\n",(0,i.jsx)(e.p,{children:"当然，现在我们还没做登录。"}),"\n",(0,i.jsx)(e.p,{children:"我们通过 jwt 搞一下："}),"\n",(0,i.jsx)(e.p,{children:"引入 jwt 的 包："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm install @nestjs/jwt\n"})}),"\n",(0,i.jsx)(e.p,{children:"在 AppModule 里引入它："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后实现登录接口："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这里我们没有用数据库，只有 2 个用户，如果信息匹配，就返回 jwt 的 token："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Inject(JwtService)\nprivate jwtService: JwtService;\n\nprivate users = [\n    {id: 1, username: 'dong', password: '111'},\n    {id: 2, username: 'guang', password: '222'},\n];\n\n@Get('login')\nasync login(@Query('username') username: string, @Query('password') password: string) {\n\n    const user = this.users.find(item => item.username === username);\n\n    if(!user) {\n      throw new UnauthorizedException('用户不存在');\n    }\n    if(user.password !== password) {\n      throw new UnauthorizedException('密码错误');\n    }\n\n    return {\n      token: await this.jwtService.sign({\n      userId: user.id\n    })\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"postman 里测试下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"登录成功后，会返回 token。"}),"\n",(0,i.jsx)(e.p,{children:"这个 token 一般都是在访问接口的时候放在 authorization 的 header 里，通过 Bearer xxx 的方式。"}),"\n",(0,i.jsx)(e.p,{children:"我们添加一个 userInfo 的接口来拿到用户信息："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('userInfo')\nasync userInfo(@Headers('Authorization') auth: string) {\n    try{\n      const [, token] = auth.split(' ');\n      const info = await this.jwtService.verify(token);\n\n      const user = this.users.find(item => item.id == info.userId);\n      return user;\n    } catch(e) {\n      throw new UnauthorizedException('token 过期，请重新登录');\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"它会从 header 中取出 token，解析出其中的信息，从而拿到 userId，然后查询 id 对应的用户信息返回。"}),"\n",(0,i.jsx)(e.p,{children:"我们加上 authorization 的 header，访问下 userInfo 接口："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"可以看到，拿到了用户的信息。"}),"\n",(0,i.jsx)(e.p,{children:"然后我们在登录确认页面加上登录："}),"\n",(0,i.jsx)(e.p,{children:"添加两个按钮："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"这俩按钮分别是登录不同的账号，拿到 token："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"访问 confirm 接口时带上这个 token："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-html",children:"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>扫码登录确认</title>\n    <script src=\"https://unpkg.com/axios@1.5.0/dist/axios.min.js\"><\/script>\n    <style>\n        #info {\n            height: 400px;\n            line-height: 400px;\n            font-size: 20px;\n            padding: 20px;\n        }\n        #confirm, #cancel{\n            display: block;\n            width: 80%;\n            line-height: 40px;\n            font-size: 20px;\n            margin-bottom: 20px;\n        }\n        #confirm {\n            background: skyblue;\n        }\n    </style>\n</head>\n<body>\n    <button id=\"guang\">登录光光账号</button>\n    <button id=\"dong\">登录东东账号</button>\n\n    <div id=\"info\">\n        是否确认登录 xxx 网站？\n    </div>\n    <button id=\"confirm\">确认登录</button>\n    <button id=\"cancel\">取消</button>\n\n    <script>\n        const params = new URLSearchParams(window.location.search.slice(1));\n\n        const id = params.get('id');\n\n        let token = '';\n        document.getElementById('dong').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/login', {\n                params: {\n                    username: 'dong',\n                    password: '111'\n                }\n            }).then(res => {\n                token = res.data.token;\n            });\n        });\n\n        document.getElementById('guang').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/login', {\n                params: {\n                    username: 'guang',\n                    password: '222'\n                }\n            }).then(res => {\n                token = res.data.token;\n            });\n        });\n\n        axios.get('http://192.168.31.56:3000/qrcode/scan?id=' + id).catch(e => {\n            alert('二维码已过期');\n        });\n        \n        document.getElementById('confirm').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/qrcode/confirm?id=' + id, {\n                headers: {\n                    authorization: 'Bearer ' + token\n                }\n            }).catch(e => {\n                alert('二维码已过期');\n            });\n        });\n\n        document.getElementById('cancel').addEventListener('click', () => {\n            axios.get('http://192.168.31.56:3000/qrcode/cancel?id=' + id).catch(e => {\n                alert('二维码已过期');\n            });\n        });\n    <\/script>\n</body>\n</html>\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后我们在 qrcode/confirm 接口里把 token 取出来，拿到其中的用户信息，保存到 map 里："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('qrcode/confirm')\nasync confirm(@Query('id') id: string, @Headers('Authorization') auth: string) {\n    let user;\n    try{\n      const [, token] = auth.split(' ');\n      const info = await this.jwtService.verify(token);\n\n      user = this.users.find(item => item.id == info.userId);\n    } catch(e) {\n      throw new UnauthorizedException('token 过期，请重新登录');\n    }\n\n    const info = map.get(`qrcode_${id}`);\n    if(!info) {\n      throw new BadRequestException('二维码已过期');\n    }\n    info.status = 'scan-confirm';\n    info.userInfo = user;\n    return 'success';\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"这样，当扫码确认后，那边就能拿到用户信息："}),"\n",(0,i.jsx)(e.p,{children:"我们改下 static/index.html"}),"\n",(0,i.jsx)(e.p,{children:"确认的时候展示下登录用户的信息："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"加上登录之后，我们再测试下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"手机扫码，点击登录光的账号，然后确认登录："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"刷新页面，重新扫码，然后登录东东账号。"}),"\n",(0,i.jsx)(e.p,{children:"这时候 pc 网站就显示了当前登录用户是 dong"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"当然，登录状态需要一个 jwt，我们返回下就好了。"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"@Get('qrcode/check')\nasync check(@Query('id') id: string) {\n    const info = map.get(`qrcode_${id}`);\n    if(info.status === 'scan-confirm') {\n        return {\n          token: await this.jwtService.sign({\n            userId: info.userInfo.userId\n          }),\n          ...info\n        }\n    }\n    return info;\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"这样，当那边确认登录之后，这边就拿到了 jwt 的 token，也就是完成了登录了："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"对比下掘金的扫码登录流程："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:r,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"是不是一摸一样？"}),"\n",(0,i.jsx)(e.p,{children:"扫码登录就是这样实现的。"}),"\n",(0,i.jsxs)(e.p,{children:["案例代码上传了",(0,i.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/qrcode-login",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,i.jsxs)(e.h2,{id:"总结",children:["总结",(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(e.p,{children:"扫码登录是常用的功能，掘金、知乎、b 站等各大网站都有。"}),"\n",(0,i.jsx)(e.p,{children:"流程是在 pc 选择扫码登录的方式，用 APP 扫码，在 app 上登录之后进入登录确认页面。"}),"\n",(0,i.jsx)(e.p,{children:"可以点击确认登录或者取消，如果确认登录，那 pc 网站就会自动登录该账号。"}),"\n",(0,i.jsx)(e.p,{children:"它的实现原理是这样的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"pc 端生成二维码，然后不断轮询二维码状态。"}),"\n",(0,i.jsx)(e.p,{children:"APP 里扫码拿到 qrcode_id，然后分别调用 scan、confirm、cancel 来修改二维码状态。"}),"\n",(0,i.jsx)(e.p,{children:"并且登录之后会把 token 带过去。"}),"\n",(0,i.jsx)(e.p,{children:"在 redis 里保存着二维码的状态和用户信息，然后这边确认之后，另一边就可以用 userInfo 生成 jwt 的 token，从而实现登录。"}),"\n",(0,i.jsx)(e.p,{children:"这就是扫码登录的实现原理。"})]})}function nI(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,s.ah)(),n.components);return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(nz,{...n})}):nz(n)}let nG=nI;nI.__RSPRESS_PAGE_META={},nI.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F103.%20%E5%AE%9E%E7%8E%B0%E6%89%AB%E4%BA%8C%E7%BB%B4%E7%A0%81%E7%99%BB%E5%BD%95.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"103. 实现扫二维码登录",headingTitle:"103. 实现扫二维码登录",frontmatter:{}}}}]);