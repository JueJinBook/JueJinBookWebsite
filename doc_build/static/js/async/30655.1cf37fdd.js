"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["30655"],{996117:function(e,n,c){e.exports=c.p+"static/image/618d4dfb2603433fe2ec5001558d6a94.57b3a1b8.webp"},751552:function(e,n,c){e.exports=c.p+"static/image/83631cebcbdd5e016ffb4d6b991e863f.90763bed.webp"},574662:function(e,n,c){e.exports=c.p+"static/image/ead27d2632f00186c107126b849f6b41.e77f25f2.webp"},750483:function(e,n,c){c.r(n),c.d(n,{default:()=>eE});var r=c(552676),i=c(740453),s=c(574662);let a=c.p+"static/image/9799a057efb516e14fc650ec18d047b5.cefd0828.webp",d=c.p+"static/image/2e7452c56d9a228d357f24d2cdbe0ce7.a6fd4c54.webp",l=c.p+"static/image/de1bc1f6777331ead505175be551ced5.7f639370.webp",t=c.p+"static/image/8c15aa9dbdbcd50987fe415e8353a16d.284aa467.webp",p=c.p+"static/image/1cf26a73320db7a448fbf4d3276bb76a.803754cc.webp",x=c.p+"static/image/cfd89c86c522d1741f02e2f09dcef225.751e7e1a.webp",j=c.p+"static/image/5c15269c3aa9472ddb2c822888046d11.aa1055b3.webp",o=c.p+"static/image/1a658771a9441ed39d1d72af74a2b3cd.c7566543.webp",h=c.p+"static/image/3c83b00d0634aee384aaa2ee67d9d542.518f67ff.webp",b=c.p+"static/image/c76e43d6480d0eb4c4f0dd723afd160b.7f25ffef.webp",f=c.p+"static/image/4f3f0b8b1edb0203336f19e32eec1ef0.07e292b1.webp",m=c.p+"static/image/8927f8568f139358219cb16455cfbb46.21d009f0.webp",A=c.p+"static/image/3a4fff17036f2969ff47574fa9c3fc90.15313166.webp",g=c.p+"static/image/3ec58ce422aecc92b510e525ed745d1f.e221e124.webp",u=c.p+"static/image/9e32de6810209252134e6832afbd9eca.ed5bb471.webp",P=c.p+"static/image/c256808d72370876e5914d7e5af5b7f9.ae56b354.webp",w=c.p+"static/image/631c1b3631817650a8fd0f40aac3de65.d83c214e.webp",E=c.p+"static/image/a6f1d033f64fa2535e06065ca97d249b.17c77272.webp",F=c.p+"static/image/fb108a6fd291eb0f9117e2e2ca5d79f8.d56922b5.webp",C=c.p+"static/image/29675032c3cccd1f99b2141e738253fd.d68d4876.webp",O=c.p+"static/image/63d437d1b1b4f4b1fee9c09c914e8844.f0d35ef1.webp",v=c.p+"static/image/2bea70455ab8815911d5537b75088b08.36fee8e2.webp",I=c.p+"static/image/62db3316e6bb847a4ea70e0b07f3f3d9.bcbaf0bc.webp",y=c.p+"static/image/dc399f07c3c3dcca61930dd3b7afbe76.f99be618.webp",H=c.p+"static/image/1f98e60adae8403bbc14ed3843f4c80c.2cf05520.webp",X=c.p+"static/image/5dcb9e78f1f046bec106c4e71c0e5c88.ec536094.webp",K=c.p+"static/image/f0a9a6aa63157edba32d0eb1629768fc.2165452b.webp",M=c.p+"static/image/da9a87b4d9666498eeb82985cc163366.46bfc2a7.webp",L=c.p+"static/image/ca62b213c69cddd5b7a8e03cf0725381.00594c30.webp",G=c.p+"static/image/5dce3138a827a1d75c288b67c70ceac6.659d72e4.webp",z=c.p+"static/image/cb3a0bd70778177556686376613fa678.ca5971a9.webp",N=c.p+"static/image/54edb24975550cf91610d99224879f70.4e6c1ed1.webp",Q=c.p+"static/image/8579a53436a78d79911837e89fab1876.bfd56b0b.webp",U=c.p+"static/image/78e702488bd8eb3b43c49d4958af27cd.0ac87c7f.webp",k=c.p+"static/image/a6dd920be1e563c162a4211cd3ea8adc.7814ccd1.webp",Z=c.p+"static/image/80c9149324769bcbcac6dd00613ffa4e.8ec58423.webp",B=c.p+"static/image/ce99948d3478239010d51ac0ac9aa8b1.d818e90e.webp",T=c.p+"static/image/cb992ad442b64944b06d4c83af8af3bd.dcac6d76.webp",S=c.p+"static/image/de4b7ec5efac5282b3ba49e222e061ee.bdd5e5cb.webp",V=c.p+"static/image/2be7b21513b7d9f2a1ddb8f50159bf5d.68b2e191.webp",W=c.p+"static/image/f309d02e01a5829c802e1c93f8945d35.78eee7ab.webp",D=c.p+"static/image/425afb494da7bdf7659a867901df138a.859b84df.webp",J=c.p+"static/image/d1c5114069edee8ae2a0ec61a92a7e82.26d1cf7f.webp",R=c.p+"static/image/3c5faacc43541edb67b11b1f586402b5.acab9c76.webp",q=c.p+"static/image/42e462c661068384f278216863ff7da0.5a6f0c36.webp",Y=c.p+"static/image/289dd431ebd4f9b5e8ebb9061e34a241.0fe0819f.webp",_=c.p+"static/image/353518289758737dea8965bb7e678fa8.8dbe201d.webp",$=c.p+"static/image/20d75bbb6ed751abe457dfd760976743.f954d619.webp",ee=c.p+"static/image/c9837e4310d7f3384c67d5f7d11db3f8.c89549b0.webp",en=c.p+"static/image/78f100b40548620ed69205418c7dea19.2ebe011c.webp",ec=c.p+"static/image/dea15f7e19dce7ce650d963208b59700.48ea5a0a.webp",er=c.p+"static/image/4744d22527a3bcd86c8651702a8bce17.57f3820c.webp",ei=c.p+"static/image/53cecd0306b40c0aa3a5bfdcd6b45166.7bd4ac63.webp",es=c.p+"static/image/01473540874aff66e2f2b8cc0fcbae39.edde37da.webp",ea=c.p+"static/image/47374f6d941414aaa1273f83cc12ceca.b6d4efdd.webp",ed=c.p+"static/image/d76f7488bdfc42a0f7b84cb563accfff.d425bd6c.webp",el=c.p+"static/image/963d5b007bb9f2556bf994f313de88dd.3862bfff.webp",et=c.p+"static/image/90ea8049fbb0366127920d5d95600a5b.77b81c40.webp",ep=c.p+"static/image/27f59d3ae2baea11053a713ff9b299bb.ddebf8e6.webp",ex=c.p+"static/image/dc90439451c4c0cc3a896e635f81e670.3e3615c5.webp",ej=c.p+"static/image/87cd0479b750378acec2593375f82976.99dbf54f.webp",eo=c.p+"static/image/4ecb207e6e8abea5c43329a4f616ad83.d6a23242.webp",eh=c.p+"static/image/6aa2061e70e6d858228eecf78f787af0.80b509bc.webp",eb=c.p+"static/image/83bdbe474248def201fa77b21994c0f9.26bf2a4e.webp",ef=c.p+"static/image/47aeba20ece092c12fe099fef4fb3c8a.4b88cc18.webp",em=c.p+"static/image/f8f7b368b924bc096733c3f5c693efc4.87c0d8f0.webp";var eA=c(996117);let eg=c.p+"static/image/f01ce5337e1416bd0fc4ee4df404bc5c.2e44e4fb.webp";var eu=c(751552);function eP(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",strong:"strong",pre:"pre",code:"code",h3:"h3",ul:"ul",li:"li",h2:"h2"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"10-aop-架构有什么好处",children:["10. AOP 架构有什么好处？",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#10-aop-架构有什么好处",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"后端框架基本都是 MVC 的架构。"}),"\n",(0,r.jsx)(n.p,{children:"MVC 是 Model View Controller 的简写。MVC 架构下，请求会先发送给 Controller，由它调度 Model 层的 Service 来完成业务逻辑，然后返回对应的 View。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eu,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在这个流程中，Nest 还提供了 AOP （Aspect Oriented Programming）的能力，也就是面向切面编程的能力。"}),"\n",(0,r.jsx)(n.p,{children:"AOP 是什么意思呢？什么是面向切面编程呢？"}),"\n",(0,r.jsx)(n.p,{children:"一个请求过来，可能会经过 Controller（控制器）、Service（服务）、Repository（数据库访问） 的逻辑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eg,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"如果想在这个调用链路里加入一些通用逻辑该怎么加呢？比如日志记录、权限控制、异常处理等。"}),"\n",(0,r.jsx)(n.p,{children:"容易想到的是直接改造 Controller 层代码，加入这段逻辑。"}),"\n",(0,r.jsx)(n.p,{children:"这样可以，但是不优雅，因为这些通用的逻辑侵入到了业务逻辑里面。能不能透明的给这些业务逻辑加上日志、权限等处理呢？"}),"\n",(0,r.jsx)(n.p,{children:"那是不是可以在调用 Controller 之前和之后加入一个执行通用逻辑的阶段呢？"}),"\n",(0,r.jsx)(n.p,{children:"比如这样："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eA,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"是不是就和切了一刀一样？"}),"\n",(0,r.jsx)(n.p,{children:"这样的横向扩展点就叫做切面，这种透明的加入一些切面逻辑的编程方式就叫做 AOP （面向切面编程）。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"AOP 的好处是可以把一些通用逻辑分离到切面中，保持业务逻辑的纯粹性，这样切面逻辑可以复用，还可以动态的增删。"})}),"\n",(0,r.jsx)(n.p,{children:"其实 Express 的中间件的洋葱模型也是一种 AOP 的实现，因为你可以透明的在外面包一层，加入一些逻辑，内层感知不到。"}),"\n",(0,r.jsx)(n.p,{children:"而 Nest 实现 AOP 的方式更多，一共有五种，包括 Middleware、Guard、Pipe、Interceptor、ExceptionFilter。"}),"\n",(0,r.jsx)(n.p,{children:"新建个 nest 项目，我们挨个试一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new aop-test\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:em,alt:""})}),"\n",(0,r.jsxs)(n.h3,{id:"中间件-middleware",children:["中间件 Middleware",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#中间件-middleware",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"中间件是 Express 里的概念，Nest 的底层是 Express，所以自然也可以使用中间件，但是做了进一步的细分，分为了全局中间件和路由中间件。"}),"\n",(0,r.jsx)(n.p,{children:"全局中间件就是这样："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ef,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 main.ts 里通过 app.use 使用："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"app.use(function(req: Request, res: Response, next: NextFunction) {\n    console.log('before', req.url);\n    next();\n    console.log('after');\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppController 里也加个打印："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eb,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eh,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eo,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ej,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，在调用 handler 前后，执行了中间件的逻辑。"}),"\n",(0,r.jsx)(n.p,{children:"我们再添加几个路由："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ex,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\naaa(): string {\n    console.log('aaa...');\n    return 'aaa';\n}\n\n@Get('bbb')\nbbb(): string {\n    console.log('bbb...');\n    return 'bbb';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，中间件逻辑都执行了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ep,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"也就是说，可以在多个 handler 之间复用中间件的逻辑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:et,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这种可以给在 handler 前后动态增加一些可复用的逻辑，就是 AOP 的切面编程的思想。"}),"\n",(0,r.jsx)(n.p,{children:"除了全局中间件，Nest 还支持路由中间件。"}),"\n",(0,r.jsx)(n.p,{children:"用 nest cli 创建一个路由中间件："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g middleware log --no-spec --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:el,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"--no-spec 是不生成测试文件，--flat 是平铺，不生成目录。"}),"\n",(0,r.jsx)(n.p,{children:"生成的代码是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ed,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在前后打印下日志："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response } from 'express';\n\n@Injectable()\nexport class LogMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: () => void) {\n    console.log('before2', req.url);\n\n    next();\n\n    console.log('after2');\n  }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 AppModule 里启用："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ea,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { MiddlewareConsumer, Module, NestModule } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { LogMiddleware } from './log.middleware';\n\n@Module({\n  imports: [],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule implements NestModule{\n\n  configure(consumer: MiddlewareConsumer) {\n    consumer.apply(LogMiddleware).forRoutes('aaa*');\n  }\n\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 configure 方法里配置 LogMiddleware 在哪些路由生效。"}),"\n",(0,r.jsx)(n.p,{children:"然后测试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,UklGRnYOAABXRUJQVlA4IGoOAABQVQCdASpOArgAPp1OoE0lpCMiIZVZWLATiWlu4XaxDbOZ8v/4Dtv/yvhr+M/Pv5z8suUzEs+Tfbz9L5Qf8vwX+TuoL+Pfzj/K72iAH87/rnET9kPYD/lvnr3lPpHsAfnL1Zv7/x3fWvsGfz/+/9ZERf8Duoo3NoH/LU1kZ32277bd9tu+23fbUP51Y7mpthTNdtaHUNrNUtebChpv/gT/GQ0X+Vw90vS78xJTxLmGuAEATEFFDypswWdpLfdDC+B188oHw99OPflP3TJrFiDnt8Lz1nfv7A58eV1QlYThItra8LDZVb+cZUK3TKe2Hp2kpPzOraB+EHBtUZ3V8P7HQav3RwcX38PLasJjbC/I4hM4WepKHWs0Nic2WHnAtLyBPmlpZ3rWL32g8skq12ye5scbLuR6fuhuQ4/9PezRRrVoDt8oMt6+ZMtH02PlJv/EbLXnOJxfwQVFqK1s3QUSrFPgcUkwvQK6CAmpEPrusJ+k3gPuBydc0tZbNEtSIw4EG0Sx8zNe2k1C3IasORDVzSbmMgaaE6ELkfQF54SQqGsxsUxhNDcNuq5PxpivzBoZLn+RYJEKXhOiKaEYZqNk0bkiJZol595qkxo3NtzGNT5OqlQwxmUnQUHZhhccol+fjyAX3AOlrLQhUvkOXyHL5DlieQUvCRdFrxEnprMVN8czGVIJtRRubZgDuoo3NswB3UUbmlxmWUPwgZ4XW/JNFVl0CbptmAO6ijc2zAHdRRubZf6e/BFvWK8AK4LUCBsqxeJdcfgGl9C4jc2zAHdRRubZgDuoo3NswS9qKNzbMAd1FG5tmAO6ijc2zAHdRRubZgDuoo3Np+OkzBIKNbEfxRTS0TsbrU/gjaQFy68d0kKe9UmNG5tmAO6ijc2y/1aH4xScF5gU6JIgQoaCDrGnMqAAAP7/xEQ1/v1k9OP5PH+JliCzyQtN7tW92re7Vvdq3u1b3at7tW92re7VvbklF6l/mUCOc/MzItOjFCLIHTLoSaOn/+0EfD8cB1W6aQJzooZ6TXZ/9lUCXfeqOsR4KZJmai9GlvPU4Wo+LTFePUJMVCyBzdvxXeEPqMhhxG/jrEIDZxgyDi+HpYNKUHUV59181UDaAVw7Co28nU8vi6p+Y/psQcC7drmh23UORbH5EgV99r1n5BiPJspn0Vwvx2UljghWfwQBPL5EBvrw1kcRTMlme/jmAsDz6cWfHJqPAwLiYrwe4aC+6RFr9nQZbErYOE1KSmcZg4epkEraI/k5lNURVkA0bEuFRx9N8gpld0uOZEqP5ezCzu/K6wc+Q5Me3cF08vJ0yKXcHpDclCHpB+FXknWIwJ7eSCKanlwZt5SCRbmpfA6FE41jd2syGG1oZHRuRQHuMoGrtrAR3XfXlFNctMGMddIGLyd0PAoy4oH6Vb4ZOvVOpXAvLTIxTRggV7UGF4KtXOFU4z+RlLAQ5KPkv49qNmUN40PEv45SK+ZjRjkkItMEGua32HbmGR0Y8XAHWlYBjI4MtM9laT+QehOIwVXTadcQb3K69jnHnM4orf+mPL410HBVDwom2vDp/52u1GAgmyWTT/i+bozo3lwxXEQvEKWMj1X9m3N+SJTVsocQSVDWxErS3SfSnXCUENmUfTnOcr2iKJsrt02lpSnuWkdKxJ+nKZIvso3ECCFIPYwp6kyAYLNX9vYF/WZNtcS9awJHs9KcwSFQ5gYc/yi5PA3tBPXIWmZGxvgJPHG1/FKlBtLluOTfckVvY5JKviUBjYOCt9iQTNeJ0cvWUOBG0n6u8Iyw7AIq9edQVOT2Ewfll2SvF2DcdByauiOKf+czWGQPfI74Jo9BlaydrnTJycnHl5a/zP6b3f9THAPskImR3W5xQao3hj52x4WROeew4hb6dZnBTUTbK0HnLBSUGUo44v1iMJwmMzhfquEVrdopEjg5nhXDXN4OH3UH8zCGzYVj3co8AmXX/LnX+QZuEr5QDxgzuhwG1CjXod3XRsB9WAWY1QOt+brfyR0DGS0lHjePyig9Pc0s5IRHm/kRrkf/PEz9CQm6Pukl4Lr5ld5s5UG6Kfebi5b4senEYlI2P3MeJuT4mPBJ3V4VH9ZjGe64MKdukfjqKuuIXdQHAc2+BO2P3mMqgBL1hI+yCxh2LaAWxEI2n+PaunRf3Z0xc4r5YTU+y5N3cBH3E/sLujViRru4KB3SZQ1QdyL3KWTbCQYrz++/BAPjxN0z7e8L1qPXKmlR9fFMmXv2voKZlxdP8luTHtjdV2xMLz6P/qkkCswe7aUyVPNxz8+45zDoVqTtixnmRTCbnWLTeigzEV2qJwf9diLdDybNDLTmFgIm48c+PSod8TBBhwBrbje0Af/QZnASC7VJz+gV3tkhdyzqYG+gLHjqIWhPLzWLHvKraNvmRY677pUy2Tr2rYQEA6mYmPmcM1fWNDP6oimGY1Hn1pspe/YKsrFSJxx27A9MpmM1Qkd16ODu5yaZNNs4zK3HWtmQPFkuaO7T/0WyyuXQ615JS+XyUozpQk2WK9bckx8KFSoQYXGvjy3qo7rA6p6dP5IAph42atFL04wOFW12+RhCkEq/P9OpobkZ5EPgR4eD6Bl+5tyXgN1X41Pt5tRfKeJLKm4hJKj0LW3DC89bwdXwjlkJPoW9dslU+QalT6ORBW74gou2VhQIi2lVuxOXrItiLLSsCoYm8tgfOT8mTJFrVDXAWQF3zTQOFZccRcrjy2SGXTgV1dbtmiBrWrKn7SvVFyrFONbFy44G7j0qrW9DuY3ZJbpRYaqYY9LXyjiKKzPsQz1qium1SK0qteqw6C73mSGcM5Fs8oVt8Hys+vDQqJ8j2wR5uzGBo/1sE6zp5hra7vvKGzy8+PTuMbVxttVZ1B5gGNaJaGPh7sxD34lWKg2V3LYDc1igqVY85w/jzFjnn1ERGiWK5dFWXiIibzkpSFv3eSddnrWYXPjftpdwhi3ipD12TXi+HyZPt4mdwABEcm/bW4EmE/72sXgWfGJ1MKYaKFWJlIQfQroHZRxHof4OBXx/PcwwKrb6Y5Dlu5WL1FHgNAWYY5rKC4BmfVsxFzxEBROXdC5OaDeUd7Dv79SXSmcr9gg1HMeKlNpzA8m5catDr5lydA/q66jLWn/zRZ5wg0DWADmQEs4WgAl5rBvnFiwOfd92eIriUjn3kMyl6SNtJcVA5nYJuR/Y6BURyD6HEZtE9NOZmW0pUgvnp0LEJSu+xCUHH7eGuup23IHMQmMzaBgJjUOMuPiAQzF6lsrqlLzOb9+l0kbvsoU7Qf9Gq27FYHwKwLLgU70ALnXOnCxUFS8lJnx52HDFFHdFj3yEEvSVjEf+vT5jLeuQ1NlpAWbn2bMLhZm+pFShcipCuxFICQJmBYX//rG3AM3BeAACrIALdfHN0/1Gd0y4XRJvgo6S0CJxPVBJszXwoNf/1yO4Gka2UlZ/+pIswdI2IAPdUjSkY8Cnv0p0isPTGahSuSwksBI/ptCTQAJup94HKO40rVsMFTKC7ZdI5vPbFOJgtDHbCbKU+mo4M8BEYKZobY0nR5Y2caNr5Fv6cQWWVG/FVt6iJyM/CNk7ROs2qlE5U+tFLadkxrGrYAcMzr/cj7/eZxFCvBUxXZlF/cNK3KNQM/cY+JgjS4kSJqJrt2aCk0GDgfwgOjcvp/xM5FefsaF90x583nlzu/bFPDrYp5O81btt5X4GBLAHCJI4x49g87uUZokhTwm+rDxMuacqrH9xFQgiqnzu/MGpo2Sht+7zb5Bk5RAzX0kwBB73A+bj0PlxxhsPVQd4m54Ji+dmbYB7zYpkS6iHhjfW4uO5pXUy0YmyMqBV0J4XQAvYf4AAAAIND9xzrpmz9zBDZr2f+l8rhzhLhX/n4HbpFSMXNVxVA/D71XxZSTnzrR39pya1jJNj3o697JKV3JX/XetmEnh1PHbgnZ8SW394Y3ne+RXncflatX2yyi5+N0/j/T8jOAkN1tyPjQOInwbWhZn1vDtMr5/e42pRK1fBEl2OMCKwO73I0WT/0KOH0jgRy/3q9rQN/3std7gV11K9Ffrqyl+11QbO/Pc16shndFhllzlzdzWRcFKB453GyABeOjqon8F/cjAcoH1DUqxnXD4gtGT8QquQG9dJhsIWVinDyF8XN63cxrw6Jbd9g0o8O4HFsDgyiNx9M9M+2Ge64G8M/bitj7hKb7CigdNlz3ZmnstBQARKcHyOp/SvtaOlcjl9zHQ3HAC0o4Hi7LyaKCJhbrLQm1ackWpiT2/rt0eezGkBL5dJNP1FOOkvFjHn0h+YnSZq/KFQn1flTAbOu7josmaiMaUbhkFrgmvUi/8DpvlG1lIu6YwM6Ayb+aSNwqPPPj5f2SJBiGsQUavHD2vw/L8JD8TIprNL4NC7SC31BUAAAAAAsTJuFuTK5GyQ39ns4qkmnfJyJb4Jsat2fFIv5KImK6xSD0O/AphHWd+ykrN5Vhf7jwQDb9osKuPVG8HwOM7oUlsErjdXWW4TIRtIddgtz3YaZUVZPUjrEnPR/XIW4c23c+kAHL7NhKPDLXH9fw24tg3Ot5yKP1w2E3x8x8xnBdZ4O+im+JXvCZk5dGBkAAgQSXGzCRRwZGtbFnNIvzA4AGmJsb4aSvBSHP+JuuJHLcADnme9ym5rWeQwlxSHHrlT/9dW8N7kvYBrdFODe7IJDmHdT9eRz8I2k9iVcvdS997/OR1NeluDlrQODW030EeH3oSrW0jfZkkxruuq7HTYvpa4yMaAGYduKMqAOxmbpCEHOJAp6Bb6v8Ii2MQZNB2KBOsltMORM6jC6x8L4DschV7cAlujyT61WXrmHcVPLszTqMfYUF/a1KXi9zuXvjotQ+kegfggCnpfGp6ablVty0Ny/TPzMTINfUmQe/MqNWhjWpi6IwpQFOqlJPRxEZExzulzsAAAAAA=",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:es,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，只有 aaa 的路由，中间件生效了。"}),"\n",(0,r.jsx)(n.p,{children:"这就是全局中间件和路由中间件的区别。"}),"\n",(0,r.jsxs)(n.h3,{id:"guard",children:["Guard",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#guard",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Guard 是路由守卫的意思，可以用于在调用某个 Controller 之前判断权限，返回 true 或者 false 来决定是否放行："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ei,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们创建个 Guard："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g guard login --no-spec --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:er,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"生成的 Guard 代码是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ec,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"Guard 要实现 CanActivate 接口，实现 canActivate 方法，可以从 context 拿到请求的信息，然后做一些权限验证等处理之后返回 true 或者 false。"}),"\n",(0,r.jsx)(n.p,{children:"我们加个打印语句，然后返回 false："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\nimport { Observable } from 'rxjs';\n\n@Injectable()\nexport class LoginGuard implements CanActivate {\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    console.log('login check')\n    return false;\n  }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"之后在 AppController 里启用："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:en,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后再访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ee,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"aaa 没有权限，返回了 403。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:$,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"Controller 本身不需要做啥修改，却透明的加上了权限判断的逻辑，这就是 AOP 架构的好处。"}),"\n",(0,r.jsx)(n.p,{children:"而且，就像 Middleware 支持全局级别和路由级别一样，Guard 也可以全局启用："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:_,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样每个路由都会应用这个 Guard："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"还有一种全局启用的方式，是在 AppModule 里这样声明："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:q,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_GUARD,\n  useClass: LoginGuard\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"把 main.ts 里的 useGlobalGuards 注释掉："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:R,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:J,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，Guard 依然是生效的。"}),"\n",(0,r.jsx)(n.p,{children:"那为什么都是声明全局 Guard，需要有两种方式呢？"}),"\n",(0,r.jsx)(n.p,{children:"因为之前这种方式是手动 new 的 Guard 实例，不在 IoC 容器里："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"而用 provider 的方式声明的 Guard 是在 IoC 容器里的，可以注入别的 provider："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:W,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们注入下 AppService 试试："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:V,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject(AppService)\nprivate appService: AppService;\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，注入的 AppService 生效了。"}),"\n",(0,r.jsx)(n.p,{children:"所以，当需要注入别的 provider 的时候，就要用第二种全局 Guard 的声明方式。"}),"\n",(0,r.jsxs)(n.h3,{id:"interceptor",children:["Interceptor",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#interceptor",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Interceptor 是拦截器的意思，可以在目标 Controller 方法前后加入一些逻辑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:T,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"创建个 interceptor："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g interceptor time --no-spec --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"生成的 interceptor 是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"Interceptor 要实现 NestInterceptor 接口，实现 intercept 方法，调用 next.handle() 就会调用目标 Controller，可以在之前和之后加入一些处理逻辑。"}),"\n",(0,r.jsx)(n.p,{children:"Controller 之前之后的处理逻辑可能是异步的。Nest 里通过 rxjs 来组织它们，所以可以使用 rxjs 的各种 operator。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common';\nimport { Observable, tap } from 'rxjs';\n\n@Injectable()\nexport class TimeInterceptor implements NestInterceptor {\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n\n    const startTime = Date.now();\n\n    return next.handle().pipe(\n      tap(() => {\n        console.log('time: ', Date.now() - startTime)\n      })\n    );\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"把之前那个 LoginGuard 注掉："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后启用这个 interceptor："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:U,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"跑一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，interceptor 生效了。"}),"\n",(0,r.jsx)(n.p,{children:"有的同学可能会觉得 Interceptor 和 Middleware 差不多，其实是有区别的，主要在于参数的不同。"}),"\n",(0,r.jsx)(n.p,{children:"interceptor 可以拿到调用的 controller 和 handler："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:N,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"后面我们会在 controller 和 handler 上加一些 metadata，这种就只有 interceptor或者 guard 里可以取出来，middleware 不行。"}),"\n",(0,r.jsx)(n.p,{children:"Interceptor 支持每个路由单独启用，只作用于某个 handler："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"也可以在 controller 级别启动，作用于下面的全部 handler："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"也同样支持全局启用，作用于全部 controller："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:K,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"两种全局启用方式的区别和 guard 的一样，就不测试了。"}),"\n",(0,r.jsx)(n.p,{children:"除了路由的权限控制、目标 Controller 之前之后的处理这些都是通用逻辑外，对参数的处理也是一个通用的逻辑，所以 Nest 也抽出了对应的切面，也就是 Pipe："}),"\n",(0,r.jsxs)(n.h3,{id:"pipe",children:["Pipe",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#pipe",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Pipe 是管道的意思，用来对参数做一些检验和转换："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:X,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"用 nest cli 创建个 pipe："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g pipe validate --no-spec --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:H,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"生成的代码是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"Pipe 要实现 PipeTransform 接口，实现 transform 方法，里面可以对传入的参数值 value 做参数验证，比如格式、类型是否正确，不正确就抛出异常。也可以做转换，返回转换后的值。"}),"\n",(0,r.jsx)(n.p,{children:"我们实现下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentMetadata, BadRequestException, Injectable, PipeTransform } from '@nestjs/common';\n\n@Injectable()\nexport class ValidatePipe implements PipeTransform {\n  transform(value: any, metadata: ArgumentMetadata) {\n\n    if(Number.isNaN(parseInt(value))) {\n      throw new BadRequestException(`参数${metadata.data}错误`)\n    }\n\n    return typeof value === 'number' ? value * 10 : parseInt(value) * 10;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里的 value 就是传入的参数，如果不能转成数字，就返回参数错误，否则乘 10 再传入 handler："}),"\n",(0,r.jsx)(n.p,{children:"在 AppController 添加一个 handler，然后应用这个 pipe："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('ccc')\nccc(@Query('num', ValidatePipe) num: number) {\n    return num + 1;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，参数错误的时候返回了 400 响应，参数正确的时候也乘 10 传入了 handler。"}),"\n",(0,r.jsx)(n.p,{children:"这就是 Pipe 的作用。"}),"\n",(0,r.jsx)(n.p,{children:"Nest 内置了一些 Pipe，从名字就能看出它们的意思："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"ValidationPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseIntPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseBoolPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseArrayPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseUUIDPipe"}),"\n",(0,r.jsx)(n.li,{children:"DefaultValuePipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseEnumPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseFloatPipe"}),"\n",(0,r.jsx)(n.li,{children:"ParseFilePipe"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"同样，Pipe 可以只对某个参数生效，或者整个 Controller 都生效："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:O,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"或者全局生效："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"不管是 Pipe、Guard、Interceptor 还是最终调用的 Controller，过程中都可以抛出一些异常，如何对某种异常做出某种响应呢？"}),"\n",(0,r.jsx)(n.p,{children:"这种异常到响应的映射也是一种通用逻辑，Nest 提供了 ExceptionFilter 来支持："}),"\n",(0,r.jsxs)(n.h3,{id:"exceptionfilter",children:["ExceptionFilter",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#exceptionfilter",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"ExceptionFilter 可以对抛出的异常做处理，返回对应的响应："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"其实我们刚刚在 pipe 里抛的这个错误，能够返回 400 的响应，就是 Exception Filter 做的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"创建一个 filter："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g filter test --no-spec --flat\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"生成的代码是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"改一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, BadRequestException, Catch, ExceptionFilter } from '@nestjs/common';\nimport { Response } from 'express';\n\n@Catch(BadRequestException)\nexport class TestFilter implements ExceptionFilter {\n  catch(exception: BadRequestException, host: ArgumentsHost) {\n\n    const response: Response = host.switchToHttp().getResponse();\n\n    response.status(400).json({\n      statusCode: 400,\n      message: 'test: ' + exception.message\n    })\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"实现 ExceptionFilter 接口，实现 catch 方法，就可以拦截异常了。"}),"\n",(0,r.jsx)(n.p,{children:"拦截什么异常用 @Catch 装饰器来声明，然后在 catch 方法返回对应的响应，给用户更友好的提示。"}),"\n",(0,r.jsx)(n.p,{children:"用一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再次访问，异常返回的响应就变了："}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)("img",{src:m,alt:""}),"\nNest 内置了很多 http 相关的异常，都是 HttpException 的子类："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"BadRequestException"}),"\n",(0,r.jsx)(n.li,{children:"UnauthorizedException"}),"\n",(0,r.jsx)(n.li,{children:"NotFoundException"}),"\n",(0,r.jsx)(n.li,{children:"ForbiddenException"}),"\n",(0,r.jsx)(n.li,{children:"NotAcceptableException"}),"\n",(0,r.jsx)(n.li,{children:"RequestTimeoutException"}),"\n",(0,r.jsx)(n.li,{children:"ConflictException"}),"\n",(0,r.jsx)(n.li,{children:"GoneException"}),"\n",(0,r.jsx)(n.li,{children:"PayloadTooLargeException"}),"\n",(0,r.jsx)(n.li,{children:"UnsupportedMediaTypeException"}),"\n",(0,r.jsx)(n.li,{children:"UnprocessableException"}),"\n",(0,r.jsx)(n.li,{children:"InternalServerErrorException"}),"\n",(0,r.jsx)(n.li,{children:"NotImplementedException"}),"\n",(0,r.jsx)(n.li,{children:"BadGatewayException"}),"\n",(0,r.jsx)(n.li,{children:"ServiceUnavailableException"}),"\n",(0,r.jsx)(n.li,{children:"GatewayTimeoutException"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"当然，也可以自己扩展："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Nest 通过这样的方式实现了异常到响应的对应关系，代码里只要抛出不同的异常，就会返回对应的响应，很方便。"})}),"\n",(0,r.jsx)(n.p,{children:"同样，ExceptionFilter 也可以选择全局生效或者某个路由生效："}),"\n",(0,r.jsxs)(n.p,{children:["某个 handler：\n",(0,r.jsx)("img",{src:b,alt:""})]}),"\n",(0,r.jsx)(n.p,{children:"某个 controller："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["全局：\n",(0,r.jsx)("img",{src:o,alt:""})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)("img",{src:x,alt:""}),"\n我们了解了 Nest 提供的 AOP 的机制，但它们的顺序关系是怎样的呢？"]}),"\n",(0,r.jsxs)(n.h3,{id:"几种-aop-机制的顺序",children:["几种 AOP 机制的顺序",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#几种-aop-机制的顺序",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Middleware、Guard、Pipe、Interceptor、ExceptionFilter 都可以透明的添加某种处理逻辑到某个路由或者全部路由，这就是 AOP 的好处。"}),"\n",(0,r.jsx)(n.p,{children:"但是它们之间的顺序关系是什么呢？"}),"\n",(0,r.jsx)(n.p,{children:"调用关系这个得看源码了。"}),"\n",(0,r.jsx)(n.p,{children:"对应的源码是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"很明显，进入这个路由的时候，会先调用 Guard，判断是否有权限等，如果没有权限，这里就抛异常了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"抛出的 ForbiddenException 会被 ExceptionFilter 处理，返回 403 状态码。"}),"\n",(0,r.jsx)(n.p,{children:"如果有权限，就会调用到拦截器，拦截器组织了一个链条，一个个的调用，最后会调用的 controller 的方法："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"调用 controller 方法之前，会使用 pipe 对参数做处理："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"会对每个参数做转换："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"ExceptionFilter 的调用时机很容易想到，就是在响应之前对异常做一次处理。"}),"\n",(0,r.jsx)(n.p,{children:"而 Middleware 是 express 中的概念，Nest 只是继承了下，那个是在最外层被调用。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:s,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这就是这几种 AOP 机制的调用顺序。把这些理清楚，就知道什么逻辑放在什么切面里了。"}),"\n",(0,r.jsxs)(n.p,{children:["案例代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/aop-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Nest 基于 express 这种 http 平台做了一层封装，应用了 MVC、IOC、AOP 等架构思想。"}),"\n",(0,r.jsx)(n.p,{children:"MVC 就是 Model、View Controller 的划分，请求先经过 Controller，然后调用 Model 层的 Service、Repository 完成业务逻辑，最后返回对应的 View。"}),"\n",(0,r.jsx)(n.p,{children:"IOC 是指 Nest 会自动扫描带有 @Controller、@Injectable 装饰器的类，创建它们的对象，并根据依赖关系自动注入它依赖的对象，免去了手动创建和组装对象的麻烦。"}),"\n",(0,r.jsx)(n.p,{children:"AOP 则是把通用逻辑抽离出来，通过切面的方式添加到某个地方，可以复用和动态增删切面逻辑。"}),"\n",(0,r.jsx)(n.p,{children:"Nest 的 Middleware、Guard、Interceptor、Pipe、ExceptionFilter 都是 AOP 思想的实现，只不过是不同位置的切面，它们都可以灵活的作用在某个路由或者全部路由，这就是 AOP 的优势。"}),"\n",(0,r.jsx)(n.p,{children:"我们通过源码来看了它们的调用顺序，Middleware 是 Express 的概念，在最外层，到了某个路由之后，会先调用 Guard，Guard 用于判断路由有没有权限访问，然后会调用 Interceptor，对 Contoller 前后扩展一些逻辑，在到达目标 Controller 之前，还会调用 Pipe 来对参数做检验和转换。所有的 HttpException 的异常都会被 ExceptionFilter 处理，返回不同的响应。"}),"\n",(0,r.jsx)(n.p,{children:"Nest 就是通过这种 AOP 的架构方式，实现了松耦合、易于维护和扩展的架构。"}),"\n",(0,r.jsx)(n.p,{children:"AOP 架构的好处，你感受到了么？"})]})}function ew(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(eP,{...e})}):eP(e)}let eE=ew;ew.__RSPRESS_PAGE_META={},ew.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F10.%20AOP%20%E6%9E%B6%E6%9E%84%E6%9C%89%E4%BB%80%E4%B9%88%E5%A5%BD%E5%A4%84%EF%BC%9F.md"]={toc:[{text:"中间件 Middleware",id:"中间件-middleware",depth:3},{text:"Guard",id:"guard",depth:3},{text:"Interceptor",id:"interceptor",depth:3},{text:"Pipe",id:"pipe",depth:3},{text:"ExceptionFilter",id:"exceptionfilter",depth:3},{text:"几种 AOP 机制的顺序",id:"几种-aop-机制的顺序",depth:3},{text:"总结",id:"总结",depth:2}],title:"10. AOP 架构有什么好处？",headingTitle:"10. AOP 架构有什么好处？",frontmatter:{}}}}]);