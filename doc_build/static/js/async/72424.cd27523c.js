"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["72424"],{398893:function(e,n,s){s.r(n),s.d(n,{default:()=>A});var a=s(552676),r=s(740453);let t=s.p+"static/image/a738bd6153d5d1be9ca864447d3cd609.438c579a.webp",c=s.p+"static/image/47511e5ea7ec0c0cae7431f0678cac7a.b16e531a.webp",i=s.p+"static/image/1df2cc56cd2365b22e546b523bc46d5d.569eb822.webp",o=s.p+"static/image/8a394c139f4d6fea370e9fd8da1e6f94.0b6512d4.webp",d=s.p+"static/image/a5f04d4d9e4c9f1ada765fabeb35f4ad.5eebc943.gif",p=s.p+"static/image/3776fe61ed814d4e9afaf1570181fe7a.9a810c9c.webp",m=s.p+"static/image/80365cf0c4217230b43f97df3aa70e2f.0d2d2257.webp",l=s.p+"static/image/81168cca56a3b2d2cf280b3b861f3cc9.5278bb4c.webp",h=s.p+"static/image/9d33fd7ac006610f7dac861de50ad308.d5ba5159.webp",g=s.p+"static/image/c11179ec019eb0bfe1197b779a92cf8f.6c443cc4.webp",j=s.p+"static/image/ac47bceb87c0467f5bbbeb2ee09250a5.2629b7fc.webp",x=s.p+"static/image/28523ff5b051cc80bb0813a298de75ba.009825eb.webp",f=s.p+"static/image/5bde1cfc8d2666f6d32d63dd5d00de36.4b76005a.webp",y=s.p+"static/image/77ca5e9f7c4ec1473fc9518e858d34cc.aa4112c4.webp",b=s.p+"static/image/45c3c6ad574abddaf9c411cf2cf17892.08f8251c.gif",u=s.p+"static/image/cf8275c13ef7ad50417a37e2fed24ad3.48f3de52.webp";function S(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,r.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.h1,{id:"187-聊天室聊天功能后端开发",children:["187. 聊天室：聊天功能后端开发",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#187-聊天室聊天功能后端开发",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"写完注册、登录、添加好友、群聊列表等前后端代码后，我们继续来开发聊天的功能。"}),"\n",(0,a.jsx)(n.p,{children:"创建一个 websocket 模块："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"nest g resource chat --no-spec\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:u,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"安装 websocket 的包："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm i --save @nestjs/websockets @nestjs/platform-socket.io socket.io\n"})}),"\n",(0,a.jsx)(n.p,{children:"改下 ChatGateway："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { MessageBody, SubscribeMessage, WebSocketGateway, WebSocketServer } from '@nestjs/websockets';\nimport { ChatService } from './chat.service';\nimport { Server, Socket } from 'socket.io';\n\ninterface JoinRoomPayload {\n  chatroomId: number\n  userId: number\n}\n\ninterface SendMessagePayload {\n  sendUserId: number;\n  chatroomId: number;\n  message: {\n    type: 'text' | 'image',\n    content: string\n  }\n}\n\n@WebSocketGateway({cors: { origin: '*' }})\nexport class ChatGateway {\n  constructor(private readonly chatService: ChatService) {}\n\n  @WebSocketServer() server: Server;\n\n  @SubscribeMessage('joinRoom')\n  joinRoom(client: Socket, payload: JoinRoomPayload): void {\n    const roomName = payload.chatroomId.toString();\n\n    client.join(roomName)\n\n    this.server.to(roomName).emit('message', {\n      type: 'joinRoom',\n      userId: payload.userId\n    });\n  }\n\n  @SubscribeMessage('sendMessage')\n  sendMessage(@MessageBody() payload: SendMessagePayload): void {\n    const roomName = payload.chatroomId.toString();\n\n    this.server.to(roomName).emit('message', { \n      type: 'sendMessage',\n      userId: payload.sendUserId,\n      message: payload.message\n    });\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"监听 joinRoom、sendMessage 消息。"}),"\n",(0,a.jsx)(n.p,{children:"joinRoom 把 client socket 加入房间，房间号为直接用聊天室 id。"}),"\n",(0,a.jsx)(n.p,{children:"sendMessage 接收并广播消息到对应房间。"}),"\n",(0,a.jsx)(n.p,{children:"message 的格式为 type、content，type 可以是 text、image，也就是可以发送文字、图片。"}),"\n",(0,a.jsx)(n.p,{children:"注意，这里要开启 cors 跨域，websocket 也是有跨域问题的。"}),"\n",(0,a.jsx)(n.p,{children:"在前端项目里引入下 socket.io"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm install socket.io-client\n"})}),"\n",(0,a.jsx)(n.p,{children:"然后改下 src/pages/Chat/index.tsx"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Input } from \"antd\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { io, Socket } from \"socket.io-client\";\n\ninterface JoinRoomPayload {\n    chatroomId: number\n    userId: number\n}\n\ninterface SendMessagePayload {\n    sendUserId: number;\n    chatroomId: number;\n    message: Message\n}\n\ninterface Message {\n    type: 'text' | 'image'\n    content: string\n}\n\ntype Reply  = {\n    type: 'sendMessage'\n    userId: number\n    message: Message\n} | {\n    type: 'joinRoom'\n    userId: number\n}\n\nexport function Chat() {\n\n    const [messageList, setMessageList] = useState<Array<Message>>([]);\n    const socketRef = useRef<Socket>();\n\n    useEffect(() => {\n        const socket = socketRef.current = io('http://localhost:3005');\n        socket.on('connect', function() {\n    \n            const payload: JoinRoomPayload = {\n                chatroomId: 1,\n                userId: 1\n            }\n    \n            socket.emit('joinRoom', payload);\n    \n            socket.on('message', (reply: Reply) => {\n                if(reply.type === 'joinRoom') {\n                    setMessageList(messageList => [...messageList, {\n                        type: 'text',\n                        content: '用户 ' + reply.userId + '加入聊天室'\n                    }])\n                } else {\n                    setMessageList(messageList => [...messageList, reply.message])    \n                }\n            });\n    \n        });\n    }, []);\n\n    function sendMessage(value: string) {\n        const payload2: SendMessagePayload = {\n            sendUserId: 1,\n            chatroomId: 1,\n            message: {\n                type: 'text',\n                content: value\n            }\n        }\n\n        socketRef.current?.emit('sendMessage', payload2);\n    }\n\n    return <div>\n        <Input onBlur={(e) => {\n            sendMessage(e.target.value);\n        }}/>\n        <div>\n            {messageList.map(item => {\n                return <div>\n                    {item.type === 'image' ? <img src={item.content}/> : item.content }\n                </div>\n            })}\n        </div>\n    </div>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"连接服务端的 ws 服务，发送 joinRoom 消息。"}),"\n",(0,a.jsx)(n.p,{children:"然后监听服务端的 message。"}),"\n",(0,a.jsx)(n.p,{children:"如果传过来的是 joinRoom 的消息，就添加一条 用户 xxx 加入聊天室的消息到 messageList。"}),"\n",(0,a.jsx)(n.p,{children:"否则就把传过来 message 加到 messageList。"}),"\n",(0,a.jsx)(n.p,{children:"创建一个 Input，当 blur 的时候发送消息到服务端。"}),"\n",(0,a.jsx)(n.p,{children:"测试下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:b,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"现在两个 socket 都在 chatroomId 为 1 的房间里，可以相互发消息。"}),"\n",(0,a.jsx)(n.p,{children:"而用户所在的聊天室会有不同的 chatroomId，不同登录用户会有不同的 userId"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:y,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"把 chatroomId 和 userId 换成真实的，不就能在不同房间聊天了么？"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:f,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:"data:image/webp;base64,UklGRqwOAABXRUJQVlA4IKAOAADwcACdASrYAgIBPp1OpEylpKOiIjV5qLATiWdu4XXk/mEvx3QsXG3J6Lf+TuxOdy00f+PVFj5R/wfbR/i/DPyC+4vbjkOdS+aH0Tfef2/zo/4Pg38f9Qj2V/ot53zv/Q+gj6d/Wv+N4RepH4Q9gD8teN99J9gj9G+i1oG+u/YVFIJJQqYZrHKQklCphmscpCSUKmGaxykJJQqYZrHKQklCphmscpCSUKmGaxykJJQqYZrHKQklCphmscot6BOFQ1ByatcjXoipQFCdBchDkqOMMqYZrHKQklCphmscpCSUD7ZU/uLlgdENJMSUKmGaxuG537SOFpbxNWuRr0RUoCS77DLsrcdkYSvM0V08A680LyzY1AAxRIpge56ubShw4efN6euPNQMkm1JTUL5w5SEj6tBDyXTgrlyYjwdxrsd//jOt//jWa1mS4ycI4C9++AaeFDFeQuVmaMTO1iUJTULhhI3oEv2nGRoljA/FQOdjDY8KKA7CplyZ7m/p3uo7sCaSksfC5eTXcnTc7qI5+1OLQJgopeiUvls/wesH7Hm8JIPMbRldLysLS3iZRLjXoipN4pSTGd8xvz3JeuDQC/uzRMQC6MySQMGgFW1vLuz0eH5RZsikxpWWPt72bqS60dMALXNkgdYsyh19tEHUlyuopvbXV/N5yZsdNbmJOGSqR8ciUByvEsLKy/RZksyWZLMlmSAmGaxykn1WFhwqzssqWTF8LCNWwEmzNt9PUFSgSM4SdeiKlAUJ0FzA7e9SVcdllVLC873GQD4oBaE6C5giKlAUJ0FyBD8y4LDaOIaijGynYnsSGX95SWZLMljMsPJKFTDNa2pCSUKmGayBtLzE/oHfP7vZfFlL3W1NWYqTr4hio4nHBOfAJy4Ru2r0Qdral3LIuNdzqBI9ZZVSxykJJQqYZrHKQkklOzQD+JTLrE5Sk8PH47HecSwN8NvcxQIRAnFV0Rj855K3klCphmscpCSUKmGaxyjF74zNa7G6oEj1llVLHKQklCphmscpCSSO9QpKEUJ0FzBEVKAoToLkMjbmEKQklCphmscpCSUKmGaxykJLkxncsbJ4+K2SYZY7U+JzdoLqfQmssqpY5SEkoVMM1jlISShUvlCa2yUcbsPuhgoALpFWIWVzuoOoyBOQC2H6B+XM46DZb4LmsaajZITmSZ9pmSLNLHKQklCphmscpCSUKmGaxykJQCZeUQAA/v9umAAAAAAADSO1e7ggSQwxAmydXievmtQYt6Y14loqZam0JVw53YYYcA2pbgN6sZN6cN0A/ThxzLfaFbd5AACNi/CFHnciSk7Nqte/N3k+M1nb7PKOaeWzoIp2YN/ym/ZLCPhwsHDaaecyqoOaxgZ7HUXw2D99kxVUq+miQ+jR80sX35mXf5/Fef+XOYLa0P90b30vYdKH4dn6vfpGuCluXeXlPxFgt1HhvVeAfFRDelInE0SGT9T3wf7lWE5fYc9ue0YcqbHhy3QYaSkme3tT89ARdNw5TM+I8HpqGI2wJEl2M4zxOvIGDK9FYnCwtpv2UYBOwLInoX/eSXsEtiRVjxH8MyJIBvYYSD06rJz5X7yWH1snaQ5LVTcJQ6rmRwXrL25HVCJaNtixHQ7fN0snRH57c/w4lcJWF2qL8fJfFJgPlme1WzG9jH/S4VhenIy6XGpBbr26iRHjdLhW1NzieV+GGJFkYsP0zbCMPVeXchZHYsH+iVFGveJGqhQ08fvieGbpzZB4SCme92rL5OTIF8fLRfUp3wlud8Pd+jE2vC51+X/F66je3/WS2Vj97DsvO5P9Pnt7hbf+Pfpi6k4OK3FQrgqYy1RwPtJfQQ0DKFtl+LDF4W2L4djnWCnjGKi3fvFFczmedpqZG9OhXogrDcU3p0S9I1UX3/g7h6icbyWe2J2ZXfmSmd1dcky3ape01MxrEKJeJ5tawEVViBqyWmrr9rAmtbGxF+M4tX8rvap3eVx4+j/Cy4QP4JoDaWtb4OJarP8sDKzMArwAYxsaiROc3Mou1L0MUK368B+dDXk4OPZbbPdqwAlqsNfdJFLb7HIHtXZKCmDGEgoDnoBGdF45ebJIsWwNThQqIdIJKvFwgrloODAWzscPItt68EcqeaCbr/YOJR8CJPK2zT0WcfOT+xdf0I6MPmVJkEQyG8h5I3QqB5fXexC0hMTb2bPC0tBgNQQKZGidrFghrzpf5AvIYFzM7r9AlCcPGaqsYnudoHy+0eDKHVb6Udo3bO/OzpOxIxxU206yPlaUu9U+5GhopM75R88s9c7DdujTd8ocs2v8IsXMebPNQgqosPl19eh7EoW42xfDWxgv5GWiE7VV1mH+vU+KUuONYeC7ZbmcA3JpeH520yKGnjeeOifwpGlH2O0PmsUO8UvRLPOwL/giVl6oe6gaUfaOxFeY6pJnYb+dd5YdocVlQLZ5s3oSg//jW8IzR3Hqfg9il8kKt0/lVEMVMHLHzb+Rf2XpJXPTmJ2ziVhDbHS7h0zo6td6rCJYcALENKTCALNHf5xbJAarzvb8kGzt5Hp2LvYk7rMTKcE9K8GOj4l9fqqf0y1ascCucXQrmDNtZQKNCBqqXUGkocadON+Fk+DgYyDG2F9t0fPkJnIma6S3vJpeHZToiUZ4eV2ccIWeuT3xfTGsZYkwK8kKKyxHSH5DpK7N/tXMKUo2bMN0Rj64DK6QfCUU+exQp43m4ZSDUjgV6cSSHtDWL/wAAxU6/+cYC9IUEBEt3tiBs/AYXKfoOo2S+P99AgqtWIjASJ3LmDijZM1FFac74zBg2fq2IsmNIV2K1KAteBQgZGMjtGLXy3pqydH2nYKcjhKxj6MXm7MOCZH6keRHwOCk/Unji73NyDfOWTsQ9Wf8Pg9ypYzaIZzZbqIvk2qZEr10KLJzrGtxQra0wjMcppKuok+piMXFK4i9olHL2FGeZVRpC0PkD3M9foKgpgXjcXcWHiGIRWxVKiugDdjNbahHYWdTFr9MyhFXSu5QmT0EYohgQCW649opwc+hwx+Av6koa4DR2DuXU1pKVD2iMfjdiwfTaYz5Y4NzglLSwDUiOVIOdKRKm9SUNcBo7B3O0AWGkCwCJx+N2LBY9wxizOUTVHq3jzFG6eGRT6qLlZWW5YFlOLcdOk7QMPHFdUQxG6HhbvUqNI29l2DoeEtWAokrfCQo4LZVsmZDaKGQFhe6vY6+KEwXAyfzs6T2nUMIDW3zUPM5SnjeJ1iUuAtIhvSMcKzQl1uFUigSRJRWpeEFKEDoumeigIyBz/eG0Hj8nG9hB/FEB9paxcm8EsqYbrlzPLzmoe7r1Nw3efPuYuwfw6R7w7Ogfw9p2P3dviPD5QAC1diFiKp9CK7urZAVJ9LiwEBLTOfUZH9TSUkjOtqFZQcZHlfrAYcB0l3+g4OGCpFVkpLFYNYnLpw0E9kGFbmzpgNwbEDmtWj3epGzl6rn/VQrmy9d1UK6pcb2a3aBCiS6ywGnty9aQR69Jk2ZBEig2YuT4Sx4kanefVGswUu6NJ0+q/H6eIaMBeuXOgRr1LbEpwN2C1IkHm0D2ei2w21YXhrGMLaG1P4Cw8dXAXaNx38XHDtBKSRKP6U+DrKgLF0OdFbQLCHbl8hkGNlLR7CV2Nv82AAh0SWWwh3c2eZBzNn8wXVW0hJR5NWRXyfeKGBXPoEdfZDbQ5/1yEt5fUqc7JxY+q3DgY7PJwonyxl3njhT63UQB4VjK2qZB0xJJaxw4AHLDQKUJVaaeeVIabdAFgP1unQODAvE0zpD1RLcoO7zJNrQTXQ5Sbr9G8gbJic0c8ddDPoj9iQZzS7O23bxznvgb3WrMxAHwaOJeLJCr7MTDM3XjNLM3dg9PCqkfqVbtkKTe8YL0u6h6we33nrZAV6203m9UF/4BJ+sVqp3Mpyx72WCuvlOO5/0x1CSoBCaKxuPKgGfiUmO50wUeTB60NLTf96IRVp1z+qF+hSiozugrlFuemE/qqoR0e9kTg8mOqYVZhYNAxz9/0HMM1Edy9qPHLP559lRAA6nLkPeuzZaABjthGVjDsAyZd2lBrM1M8ik8xvVR9sfQnsvqgvsux1R76ywxhGu7lF65SFtz/1ucsL4P3N7d7MOMNcKJ9P0ViuYjA6JQeYoupkVyr5ZgbKKVwr0OfKQaSldhkv+Dh1kF0DGbLSguWmc5kaEPBwQ4yn0Wo/9sHdIXi0B5beT6L5P0TwqM63a9wDRT9/cxfU3uFHdlHlTVuDL69rfN0O2G3nwBlC2SgqCV3elBFz0VyQFRZYZUmnJ1fkw9nUFpgTv/IyZ7XRTDPGbGzmdIt9elAMt3asaTF2AYICZsdv4kaN1pevLpk/fCHIEgmzcNSUfK/WZxBBnRGVfrM4ggzojL5avUY+PIb8AAdAMZMohur//AwbDotmHs9HtYwA039p6qgDFGYlQDI7izzjt8lR3RoQ9pTNmVORW+EfpUiRVwxgaOYbxsjfFVAv/Xg+XKCD9DTYYmbYk3O3TxX2rb9o98T910QHhp9e90bc5i5NkrWDotrl1JgALvWKgYdSAVcVeXjzpk9ECVRxmEVU+GB5kMUATbstv8CyU/CcRWNjUd4ke4AZIcm1rzjaR2/ATFvmshf6Z8UgdqSj9QsRQAr9WmUc8Wfhhcp+6XekoxRTw9buHRYhUILCTYorE9vHFazrJXedv7RJRffASog4Rbmb2+mDtzHhbLTF4AILwFPWyCYY5CyeU+0ZHoniF9DCJNnMrsiNuo9ZGlN22sDi6WppG6EWHBoswh/M8cilH7RbYnEWY2lp7XCUVWqUtIt/QfUppTbhRv4MY52M4ewPUT6NvFlQIwNR4FAfVfTP/3tbTvvToRoIboqikpA+TI82DvHBOoSZgsT3VFYaTnaU3AGf5bpXtGQfILWUaKBAg+exF5pDHBUp8yp+dBKqiBQpCPup5pmXA1e0MUc2oyUNeC9IeGS27+F2E68o6lu8J9NG6hYvssjRYXvXI0BgiNmRLVIGQAAAAAAA=",alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这部分是前端逻辑，我们下节再写。"}),"\n",(0,a.jsx)(n.p,{children:"接下来我们实现下聊天记录的保存，也就是把聊天室里的消息存到数据库表里。"}),"\n",(0,a.jsx)(n.p,{children:"在 prisma 的 schema 添加这个 model"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"model ChatHistory {\n  id Int @id @default(autoincrement())\n  content String @db.VarChar(500)\n  //聊天记录类型 text:0、image:1、file:2\n  type Int\n  chatroomId Int\n  senderId Int\n  createTime DateTime @default(now())\n  updateTime DateTime @updatedAt\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"执行 migrate dev 生成迁移 sql 并更新 client 代码："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npx prisma migrate dev --name chat-history\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:x,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:j,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:g,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,a.jsx)(n.p,{children:"然后创建 chat-history 模块："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"nest g resource chat-history --no-spec\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"先改下 ChatHistoryService，实现 list、add 方法："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { ChatHistory } from '@prisma/client';\nimport { PrismaService } from 'src/prisma/prisma.service';\n\nexport type HistoryDto = Pick<ChatHistory, 'chatroomId' | 'senderId' | 'type' | 'content'>;\n\n@Injectable()\nexport class ChatHistoryService {\n    @Inject(PrismaService)\n    private prismaService: PrismaService;\n\n    async list(chatroomId: number) {\n        return this.prismaService.chatHistory.findMany({\n            where: {\n                chatroomId\n            }\n        });\n    }\n\n    async add(chatroomId: number, history: HistoryDto) {\n        return this.prismaService.chatHistory.create({\n            data: history\n        });\n    }\n\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"我们把 ChatHistoryService 暴露出去，让别的模块可以调用："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"在 ChatModule 引入下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:m,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"发消息的时候就可以保存聊天记录了："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:p,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"@Inject(ChatHistoryService)\nprivate chatHistoryService: ChatHistoryService\n\n@SubscribeMessage('sendMessage')\nasync sendMessage(@MessageBody() payload: SendMessagePayload) {\n  const roomName = payload.chatroomId.toString();\n\n  await this.chatHistoryService.add(payload.chatroomId, {\n    content: payload.message.content,\n    type: payload.message.type === 'image' ? 1 : 0,\n    chatroomId: payload.chatroomId,\n    senderId: payload.sendUserId\n  });\n\n  this.server.to(roomName).emit('message', { \n    type: 'sendMessage',\n    userId: payload.sendUserId,\n    message: payload.message\n  });\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"再聊会天："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:d,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这时候聊天内容就保存到了数据库里："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:o,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"我们还要加一个查询聊天记录的接口："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Controller, Get, Query } from '@nestjs/common';\nimport { ChatHistoryService } from './chat-history.service';\n\n@Controller('chat-history')\nexport class ChatHistoryController {\n  constructor(private readonly chatHistoryService: ChatHistoryService) {}\n\n  @Get('list')\n  async list(@Query('chatroomId') chatroomId: string) {\n    return this.chatHistoryService.list(+chatroomId);\n  }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"postman 里调用下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:i,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"我们顺带把 user 信息查出来返回："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"async list(chatroomId: number) {\n    const history = await this.prismaService.chatHistory.findMany({\n        where: {\n            chatroomId\n        }\n    });\n\n    const res = [];\n    for(let i = 0; i < history.length; i++) {\n        const user = await this.prismaService.user.findUnique({\n            where: {\n                id: history[i].senderId\n            },\n            select: {\n                id: true,\n                username: true,\n                nickName: true,\n                email: true,\n                createTime: true,\n                headPic: true\n            }\n        });\n        res.push({\n            ...history[i],\n            sender: user\n        });\n    }\n    return res;\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"测试下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这样，点击切换不同聊天室的时候，就可以把聊天历史记录查出来展示了："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:t,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-frontend",target:"_blank",rel:"noopener noreferrer",children:"前端代码"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-backend",target:"_blank",rel:"noopener noreferrer",children:"后端代码"})}),"\n",(0,a.jsxs)(n.h2,{id:"总结",children:["总结",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"这节我们基于 socket.io 实现了 websocket 服务的前后端。"}),"\n",(0,a.jsx)(n.p,{children:"发送 joinRoom 消息的时候把 client socket 加入房间，房间名为 chatroomId"}),"\n",(0,a.jsx)(n.p,{children:"发送 sendMessage 消息的时候把 message 发送给房间的所有用户。"}),"\n",(0,a.jsx)(n.p,{children:"前端通过 socket.io-client 来实现。"}),"\n",(0,a.jsx)(n.p,{children:"我们还做了聊天记录的保存，每个房间聊天的时候都会把聊天内容存到数据库里。"}),"\n",(0,a.jsx)(n.p,{children:"这样，聊天功能的后端部分就完成了。"})]})}function I(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(S,{...e})}):S(e)}let A=I;I.__RSPRESS_PAGE_META={},I.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F187.%20%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%9A%E8%81%8A%E5%A4%A9%E5%8A%9F%E8%83%BD%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"187. 聊天室：聊天功能后端开发",headingTitle:"187. 聊天室：聊天功能后端开发",frontmatter:{}}}}]);