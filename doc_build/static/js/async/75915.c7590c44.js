"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["75915"],{838101:function(e,n,i){e.exports=i.p+"static/image/30abbb63229ec443eeaaddb1222bc698.50c8ff22.webp"},980985:function(e,n,i){i.r(n),i.d(n,{default:()=>X});var d=i(552676),c=i(740453),s=i(838101);let r=i.p+"static/image/77b91af1fdce83de530a06e3a62cc0fc.c0831a46.webp",p=i.p+"static/image/e86bfea0d25cdfde3aae4d13540b4e6c.bd8ded19.webp",a=i.p+"static/image/50256e7426934f4db4ca12012afc47b4.91486c1f.webp",l=i.p+"static/image/dede415e0c8dc52e8b2f0a82dc7a7733.33705974.webp",t=i.p+"static/image/b7afbfc52b2dc7d9937343cb8756b9d3.3d7cc1e7.webp",o=i.p+"static/image/ba615888231802534c505f831a7c5df5.2bde3897.webp",x=i.p+"static/image/def76de7dc35c710000b118efd707d11.f3e34c49.webp",j=i.p+"static/image/01bcfc61f2ae45848a38fba74a3619fa.4e0e40b4.webp",h=i.p+"static/image/d1c48fb028746533b61925e714d087a5.c93008df.webp",m=i.p+"static/image/6ed85e0e9f39a48254cdad7237e7102a.b8e64aa4.webp",g=i.p+"static/image/078ea434d956721d91601794a8209d22.395adbda.webp",b=i.p+"static/image/4cfc9c5cfc86c4c82cb969d7c3ef0ab3.be35c768.webp",A=i.p+"static/image/7a7ed00af46d8c9c5a87b9c30bd5cc17.20bb045a.webp",f=i.p+"static/image/5187f08570dbb79183d6600d3c5a6649.90d37d9a.webp",k=i.p+"static/image/1407c12d1770f26d3e8cc0b7e28b9d47.bae80ad4.webp",u=i.p+"static/image/e60d50b77792da6bf4878f213458d27f.37a29e13.webp",y=i.p+"static/image/b86845fce26e79c2ba594299a0b85ed3.770b6ffa.webp",S=i.p+"static/image/b924920162614a615561b47548ac7767.a7ab5a06.webp",M=i.p+"static/image/8e9dbcc4cf1e1ebf8140dc3cef6042f6.c5f5224e.webp";function P(e){let n=Object.assign({p:"p",img:"img",pre:"pre",code:"code",strong:"strong",a:"a",h2:"h2"},(0,c.ah)(),e.components);return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.p,{children:"首先思考一个问题："}),"\n",(0,d.jsx)(n.p,{children:"dockerfile 是在哪里 build 的，在命令行工具里，还是在 docker 守护进程呢？"}),"\n",(0,d.jsx)(n.p,{children:"答案是在守护进程 docker daemon。"}),"\n",(0,d.jsx)(n.p,{children:"我没启动 docker daemon 的时候是不能 build 的，启动之后才可以："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:M,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"命令行工具会和 docker daemon 交互来实现各种功能。"}),"\n",(0,d.jsx)(n.p,{children:"比如 docker build 的时候，会把 dockerfile 和它的构建上下文（也就是所在目录）打包发送给 docker daemon 来构建镜像。"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:S,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"比如我们会执行这样的命令："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-shell",children:"docker build -t name:tag -f filename .\n"})}),"\n",(0,d.jsx)(n.p,{children:"这个 . 就是构建上下文的目录，你也可以指定别的路径。"}),"\n",(0,d.jsx)(n.p,{children:"而镜像自然是越小性能越好，所以 docker 支持你通过 .dockerignore 声明哪些不需要发送给 docker daemon。"}),"\n",(0,d.jsx)(n.p,{children:".dockerignore 是这样写的："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"*.md\n!README.md\nnode_modules/\n[a-c].txt\n.git/\n.DS_Store\n.vscode/\n.dockerignore\n.eslintignore\n.eslintrc\n.prettierrc\n.prettierignore\n"})}),"\n",(0,d.jsx)(n.p,{children:"*.md 就是忽略所有 md 结尾的文件，然后 !README.md 就是其中不包括 README.md"}),"\n",(0,d.jsx)(n.p,{children:"node_modules/ 就是忽略 node_modules 下 的所有文件"}),"\n",(0,d.jsx)(n.p,{children:"[a-c].txt 是忽略 a.txt、b.txt、c.txt 这三个文件"}),"\n",(0,d.jsx)(n.p,{children:".DS_Store 是 mac 的用于指定目录的图标、背景、字体大小的配置文件，这个一般都要忽略"}),"\n",(0,d.jsx)(n.p,{children:"eslint、prettier 的配置文件在构建镜像的时候也用不到"}),"\n",(0,d.jsx)(n.p,{children:"此外，还有注释的语法："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:y,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"这就是 dockerfile 的全部语法，没多少东西。"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.strong,{children:"docker build 时，会先解析 .dockerignore，把该忽略的文件忽略掉，然后把剩余文件打包发送给 docker daemon 作为上下文来构建产生镜像。"})}),"\n",(0,d.jsx)(n.p,{children:"这就像你在 git add 的时候，.gitignore 下配置的文件也会被忽略一样。"}),"\n",(0,d.jsx)(n.p,{children:"忽略这些用不到的文件，是为了让构建更快、镜像体积更小。"}),"\n",(0,d.jsx)(n.p,{children:"此外，还有一种减小镜像体积的手段：多阶段构建。"}),"\n",(0,d.jsx)(n.p,{children:"我们会先把源码目录发送到 docker daemon 中执行 npm run build 来构建产物，之后再 node ./dist/main.js 把服务跑起来。"}),"\n",(0,d.jsx)(n.p,{children:"也就是这样："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:u,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"新建个项目："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-shell",children:"nest new dockerfile-test -p npm\n"})}),"\n",(0,d.jsx)(n.p,{children:"编写 .dockerignore："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-.ignore",children:"*.md\nnode_modules/\n.git/\n.DS_Store\n.vscode/\n.dockerignore\n"})}),"\n",(0,d.jsx)(n.p,{children:"编写 Dockerfile："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-docker",children:'FROM node:18\n\nWORKDIR /app\n\nCOPY package.json .\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install\n\nCOPY . .\n\nRUN npm run build\n\nEXPOSE 3000\n\nCMD [ "node", "./dist/main.js" ]\n'})}),"\n",(0,d.jsx)(n.p,{children:"基于 node 18 的镜像。"}),"\n",(0,d.jsx)(n.p,{children:"指定当前目录为容器内的 /app。"}),"\n",(0,d.jsx)(n.p,{children:"把 package.json 复制到容器里，设置淘宝的 npm registry，执行 npm install。"}),"\n",(0,d.jsx)(n.p,{children:"之后把其余的文件复制过去，执行 npm run build。"}),"\n",(0,d.jsx)(n.p,{children:"指定暴露的端口为 3000，容器跑起来以后执行 node ./dist/main.js 命令。"}),"\n",(0,d.jsx)(n.p,{children:"然后执行 docker build："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"docker build -t nest:first .\n"})}),"\n",(0,d.jsx)(n.p,{children:"镜像名为 nest、标签为 first，构建上下文是当前目录"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:k,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"然后就可以在 docker desktop 里看到你构建出来的镜像了："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:f,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"如果你 build 的时候报这个错误："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:A,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"那需要加一行："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"RUN ln -s /sbin/runc /usr/bin/runc\n"})}),"\n",(0,d.jsx)(n.p,{children:"原因如下："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:b,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"点击 run 把它跑起来："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:g,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"容器跑成功了："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:m,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"浏览器访问下也没啥问题："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,d.jsx)(n.p,{children:"这样我们就用 docker 把我们的 nest 应用跑起来了！"}),"\n",(0,d.jsx)(n.p,{children:"但现在 docker 镜像还是不完美的。"}),"\n",(0,d.jsx)(n.p,{children:"这样构建出来的镜像有什么问题呢？"}),"\n",(0,d.jsx)(n.p,{children:"明显，src 等目录就不再需要了，构建的时候需要这些，但运行的时候只需要 dist 目录就可以了。"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:h,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"把这些文件包含在内，会让镜像体积变大。"}),"\n",(0,d.jsx)(n.p,{children:"那怎么办呢？"}),"\n",(0,d.jsx)(n.p,{children:"构建两次么？第一次构建出 dist 目录，第二次再构建出跑 dist/main.js 的镜像。那不是要两个 dockerfile？"}),"\n",(0,d.jsx)(n.p,{children:"确实需要构建两次，但只需要一个 dockerfile 就可以搞定。"}),"\n",(0,d.jsx)(n.p,{children:"这需要用到 dockerfile 的多阶段构建的语法。"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-docker",children:'# 41. Nest 项目如何编写 Dockerfile\nFROM node:18 as build-stage\n\nWORKDIR /app\n\nCOPY package.json .\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install\n\nCOPY . .\n\nRUN npm run build\n\n# production stage\nFROM node:18 as production-stage\n\nCOPY --from=build-stage /app/dist /app\nCOPY --from=build-stage /app/package.json /app/package.json\n\nWORKDIR /app\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install --production\n\nEXPOSE 3000\n\nCMD ["node", "/app/main.js"]\n'})}),"\n",(0,d.jsx)(n.p,{children:"通过 FROM 继承镜像的时候，给当前镜像指定一个名字，比如 build-stage。"}),"\n",(0,d.jsx)(n.p,{children:"然后第一个镜像执行 build。"}),"\n",(0,d.jsx)(n.p,{children:"之后再通过 FROM 继承 node 镜像创建一个新镜像。"}),"\n",(0,d.jsx)(n.p,{children:"通过 COPY --from-build-stage 从那个镜像内复制 /app/dist 的文件到当前镜像的 /app 下。"}),"\n",(0,d.jsx)(n.p,{children:"还要把 package.json 也复制过来，然后切到 /app 目录执行 npm install --production 只安装 dependencies 依赖"}),"\n",(0,d.jsx)(n.p,{children:"这个生产阶段的镜像就指定容器跑起来执行 node /app/main.js 就好了。"}),"\n",(0,d.jsx)(n.p,{children:"执行 docker build，打上 second 标签："}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"docker build -t nest:second .\n"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:j,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"把之前的容器停掉，把这个跑起来："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:x,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"这次用 3003 端口来跑："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:o,alt:""})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:t,alt:""})}),"\n",(0,d.jsxs)(n.p,{children:["浏览器访问下：\n",(0,d.jsx)("img",{src:"data:image/webp;base64,UklGRuIOAABXRUJQVlA4INYOAADQXgCdASp4At4APp1Mok0lpCMiIfII2LATiWlu/HyZqVBGeUf692y/5r+u+QfjU9myZvbP70zTfeP9L5md6PyX1BfyD+j/6Pegdh8wLvv362qV4F9gD9YvST/KeDD94/6XsBfzP/Fehn/4+Wv639hT9ft9tDX6zcJ3bU2ptTam1NqbU2ptTam1NqbU2ptTam1Nqa7z3YGcu/NWfFqYg+wLaBXV0tVLVS1UtVLVS1UpwU8t2wTEzByullmFBHvgTs5RdtF32EWD/Q5kQfIDuKY7+PShnqtcO2ovdeByEHMH93fFd548ysF4BMT8r0HtpxDSNYb31sMVl9jd9oVJaFUcSko0bo83l42m2MrA87wy9ybKkvxy2LhsoYQ8u52+KwyATQ4D2w0Kh37XqsM/2BludUAYQ/BMMBdamhB6bFVhmLIdAO8lHwmaBn+TgrtVYfVs8N8ByFO7Ks4Hpj1ZOrhkQy7UbAFnvac9NiZwwru0kprxfEC2py6D88kt3DI/g/SlBQ1SSF2QDJuy/WYW1GLHAvU2dZ498nAnIZ+T8vMoeL5Pm5oFQvLHlxrGKxupYrGKxjKlqpapacYSF1/df3X91/i0FWfFqvSlHQ6TcQ9mEcu/NWfFqiuHTkM/J+T8n5Pyfk/J+T8n5PhOfqBjvxKtCM3ximybrdxpkqRc7Fag6S1Ab72pM4eGox8834/WYFTwFs+bseZ4CfRc5ww2nwq2uyt6ClXfJROqCpza7eT8n5Pyfk+DcIFAW1te7LMF+m5q23z/FfGJZqYYV4jrhkvM6IKYfpc3RI1K21bnF27BsABwMlAaCpBGiBMzDc1aT/J+T8n5Pyfk/J+T8vfF8vMoeL5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/J+T8n5Pyfk/ELwNNqpKaPEb11eFcwdxEdrtQA2R15FLWZqVETE4gqc2u3k/J+T8n5PyfkwYHQW6jRcTIhRbTvcUQ8G+1ai4AD+nNH2o/MnhkjSg9KD0oPSg9KD0oPSg9KD0oPSg9KD0oPSg9KD0oPSg9KD0oPTBfdIe9QGjDoT1Xgmk9QM5tYoD4Kfewyg20LRXo519sCmQUtEbe9BaOAbJECKogqj/X0wX5F5/wUsPSpk+CNo7w36fyn1tJkoPEW+yVJqtvQ6z+uifySJVyJpiLjpzGwGLMNWlR0D8MUuMYv54Dr5olWa9k7W0YQnpflRBxnCxvwYSUVkeGe26B2Uo/6/qWhtcUsUPmwiOw/6xFYiP/zMUgv+fumnunEZTaSiJuvTlh+ECdsnRAKPzQt2Nbtl7knze5Bk2ZCokWG0cAfujYc5BQVhA+sSAaGvgea7TWsfcz1hdMt0JbvbstkRqLLtd96bgNp/qB7K7Oohz9eQL1PMj7f+AzJzXCIHxBZH7c76hDW3ZrIfc24Utrre9IVOluSh9VX24XC9d468PXy+EwMNc8f/ZePA7v+WK/pZ+Y76rqRhG9+UOxclRHQH6TguyxxspvebimI6VQOxiOb4DegOF6W3Rb65eNfWbzc5kHxxVaXimvq8XuOrm/kmc7f9xQDzaTmixtgtlRnLtv+HXTM5ozWhXIkacKfqjmUfXhnr//LGKGU8ay9kO0ZCv6f0mubNdKbBLHJwGF4bG7Qy+BM5y/V2VumOAdbF70VGcoqG80M9plmEA4kUEfaSA8+M5g3ZwlO8+IhLlhFj7bbqO0EHgLf0lRk8/sUiR0/AQI55xjBdkF6hpYi9wpOLKhYr6tgnlw7m6p/ch1kIETeOUJE4pw3p+Pi3zAznJGX7iNNFOpoSumSDN7s8UGprGC3FEw5NB7YVTlqU+no19Z88b0C2X44Q4t0HDKf4q9m0le2yGH8pEy3ZhpNH/1dBNHlZMmxBEeF6s/uNuV7Q6thdI6Z3fyH5pWsH3iBgCSDS9S7qU+/L/T3xiB1NXqAeYU59s4g6e9mi0ckH2uzUYJsVlB2Px8XUyAGbx8uQveEEDYCgL02NvpQVi6QMqyvy3dDZErncvVlqghAtv+y6ed7NSOK20GzkMem/ZYQhM3JCAckqjn2SibI4qqxmO7NjM1bF8V6WSkE/4POsSiapRI0FM82KNwkbtd+7AnOqdQu7x06eWJCqZVAvwSjZhziRl0tmE97zkbkUYXAC/OHThfhSOaEDp/jfM/Kzx/WkBB2qJulX7L64ZNzRJYddsKEPYTCu9GKSakjeE6Nmn7+6xt2Bl3sIvU1tUTTQgOO1KMZyNSsHvtdWwzH47pstfAViU+ACqBMJivLokPCsPgFG5tFl+8f+i65fzqRbdV/BvGxUthIvAk+RUBliBw0J6xyrdIn5v8eg9TC6xGZoEbBx0B1cSEBrvo2YBWhro5NvZ1WHHZ58cerqvoDKrL7g5pwidH2vqdrr+qgX5kOOcUOym5MUJsaYYX/voo8lr/bXnXhgQOZhXa2s4Ep55OcvLKBZOnhk8t0D4s42MqpsAqzVU4pSC8grjfVq7Bw4fM1p7xCghpN9/K1lpBYdpFOuASi67l3/r7+I6raTHJFVj1mFXr/sdXXMGYHUsFTTNDA4PPiH3DuQkZPozyLbHmX15++ka+xlEP5+tuhKudVLPeEM/WAiXlRobdBrn0qwGRhxOLpJan4S9xTYpvOS8Pw9lYmyLMaHniqG5xg+qscM/Z3EFeNtDMLqPSOaSirlV0SQhbi1ICwDZq27krKfCQ0EDgRkG43cMXLspNN2cukHzC6jPPyFIG0C8X8yPkyNbfzNQHaFE6C/EBahcbJznM6UsqSQZQe2B8xJVrhLKL5SFHFlwrYSlcNgRVKI9XQoesFHB/6xLWQ8MOOWuEcipMagfzQ6eW4qeKy3wiMMbuPVizShp7ycUvdopyvl8xnxsSMtpX25eec2YKQ//xRob6h+Ak2ze+A87iExvKcY03Lf9LudVdUNY8DDa+muDrDNBr3MomUtJOkFV8n4TdC+Gnj4eVzVQfVEr4lSakIz4WoAAOKNiMnRvkgvo4AEeKAGIIbSX7pAOOFPKFq4JU3bDw9GZS+E91LJ/SgYrizxJQRtK03R7XSYPgZj0QEEMs9/ci0oH4i4MHvQkpsAL8S+5gH3QDNiT9G5kmAJptcQ0OhpQdeq5/X/ghjvj/iS2cKb7zsYi/B+LkCuHKzxh/0kqiSxYqqNPRDUtRcLqhK+l/KgAfuet14FiCbTbX9usa/8y1KOqCtQ3i8cnTo8xRhZ4HM30lTRvIWeS/Y3PEBxZKicRs4ruYfxyDSrYltyWj1aD0DWU7RO4fZvv2WArzASyGRN7FpLxIAVuumYfzcRbleB7eRS83M+bM/6VmZJTXiPZm8CmEaXPMIY4T+snXcNYEG8/T4ZjHLKNQ81I0QkhTyMSUQFsScgNkwM7Qf8Xivn4VpDF4/rwK5uGRN+A6ErzRH9AMtstovzw3ly94VK6l6yAP59evkpzzZ1QTjovOjge8jVaH2cFprHZ865NyFJxn7mgU15Y7MQHxyepWd+gAPMdrseN6DIsrkOcFCeX+0HC7mD4wT/aYD0ClbbXM25CkS50C+1Tg25lxPq2K+QCJUV8LPl1HJC6MLLueDQzq64NLYDqAtu735P+rEjPs8+lC4CmLy66AoiknO9nSKdLYAPWPEGHuoulpl2AW65HnKS0mPpwta8pU12KP3mcl7nGsnVF1B+O25Pd9WO/vLUm28eXxSrtAQL1X++I51YR18/PhJJCLHnvEX2jGVxH8sOMAzrKr/WXHoAVeF0/ffk4hIZoI/j1whfuiUwZenRPN3rs5tTQgznNuICXFtd4xmAKO8txczaViKJR/taiBsLFaVzF7Xcer1TKZySwE+6keMq2MH9RGs/z3YT5oLVYH1nzhz/1aFApbgfP1CMshMeeWwPrRsUJxg1aHkiJvf8E0y2ieyVMw2e97QIkt9jmWB3eDbqd/vo7/tE82MQIEtr1DSCwc1Ow50LusQVfJaOYanhe1egneYUTcOxTFxAlmaygpyR0rZ0ZUFrIRqJxb98iJNptaAPryS1Ru+8B8mOssYhjEReMOaP2IQRkZin5e2TQWVLLsriULYzZt3Jc3jTzilfhd1afD5XeEfCRmuT96ncrlDkuuBSA4U8Vyxl8C6pt4Hot7XwlwG0okccDVPpqOqdFAnOsrQc3fzyjb0eY34foAyatsG6zmNynX/KECgnI3Q7+DoyfAP64pJZZsFxwxkgcN/Y4QWOhH4rCYhxKX1qPFyB0T95BlCDmPOsKJZVzd6w+HynyfnCN8gxfiuF1DbDMhJIW23zAyujztkzX85AG0MVJUwRRZ6JnES+O+Wfc0Hc/6JPujsXrgtpf9Wxefu9jnX4J/r3lkvo/Y9A/dcfprjaGQWSbTycF8QZwXqiV+t5fviaTFOr6wcPxiDXdRnoD4h87RISGBiQ8iUpXtK3OiNDJSbGfY/oNGAhqzwEVv4J3vLPkXWF25Wf+swgAAAAAAAACCmBAnXbtwZ7w9a7aB4IqxNES69SBxF0tJ7Xyz1r+5Jpo/yCZvA0lGw44rMm3E5vRObGogcsZOe1b7Dg3M8GqpIi7o+tlj9LA5KLFUG7X29N86JCWGfADr8jzQSyS6Y0dusgTvRrtBWoLWb1WgfNQJMdS6U9jW5OpNlttj+M5okgPYXdRjzqpec1DLCNGx/ImTlFCbpHPiRneTgBeUkHRinV+p2ky108ww3bAfd5Ma6w6huyLKSNmiJVPbgb/GXLdUtRPvAJjW4ua6hHGVfZtE383X+DzcBi687KaBvuT8v+yt57M952xwBiECT6xCdaKRd7/KFEtug+g5o0EcKlpMhM5pKeD9zYCFgTmLEAJSCBJ5lDJbLW0mFLziiTbzz7pK/w2FavowrOlmXaFYf6KwL7kwvLWoRXcOZ4U58g+dS4oc6CHzU2648hAZAY6ES6iuLwHRziWkkbO7y6DwEhK5XlEZXWZQ1FFgjPbVyJfVXQDMiBkhyRhZ8ETET8xR7sD+hmaZHlW1+x22VXKQ/e3ZpJb7TzFT8K3kS4MQrcn2eFp6K4rEM5Nng7VK4AAAA=",alt:""})]}),"\n",(0,d.jsx)(n.p,{children:"nest 服务跑成功了。"}),"\n",(0,d.jsx)(n.p,{children:"这时候 app 下就是有 dist 的文件、生产阶段的 node_modules、package.json 这些文件："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:l,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"对比下镜像体积，明显看出有减小，少的就是 src、test、构建阶段的 node_modules 这些文件："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:a,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"这就是多阶段构建（multi-stage build）的魅力。"}),"\n",(0,d.jsx)(n.p,{children:"有同学说，但现在镜像依然很大呀，那是因为我们用的基础的 linux 镜像比较大，可以换成 alpine 的，这是一个 linux 发行版，主打的就是一个体积小。"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-docker",children:'FROM node:18.0-alpine3.14 as build-stage\n\nWORKDIR /app\n\nCOPY package.json .\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install\n\nCOPY . .\n\nRUN npm run build\n\n# production stage\nFROM node:18.0-alpine3.14 as production-stage\n\nCOPY --from=build-stage /app/dist /app\nCOPY --from=build-stage /app/package.json /app/package.json\n\nWORKDIR /app\n\nRUN npm config set registry https://registry.npmmirror.com/\n\nRUN npm install --production\n\nEXPOSE 3000\n\nCMD ["node", "/app/main.js"]\n'})}),"\n",(0,d.jsx)(n.p,{children:"node:18-alpine3.14 就是用 alpine 的 linux 的 3.14 版本，用 node 的 18.0 版本。"}),"\n",(0,d.jsx)(n.p,{children:"然后再 docker build 一下。"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"docker build -t nest:ccc .\n"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:p,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"可以看到现在镜像体积只有 277M 了："}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:r,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"一般情况下，我们都会用多阶段构建 + alpine 基础镜像。"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)("img",{src:s,alt:""})}),"\n",(0,d.jsx)(n.p,{children:"alpine 是一种高山植物，就是很少的养分就能存活，很贴合体积小的含义。"}),"\n",(0,d.jsxs)(n.p,{children:["案例代码在",(0,d.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-dockerfile",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,d.jsxs)(n.h2,{id:"总结",children:["总结",(0,d.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,d.jsx)(n.p,{children:"docker build 的时候会把构建上下文的所有文件打包发送给 docker daemon 来构建镜像。"}),"\n",(0,d.jsx)(n.p,{children:"可以通过 .dockerignore 指定哪些文件不发送，这样能加快构建时间，减小镜像体积。"}),"\n",(0,d.jsx)(n.p,{children:"此外，多阶段构建也能减小镜像体积，也就是 build 一个镜像、production 一个镜像，最终保留下 production 的镜像。"}),"\n",(0,d.jsx)(n.p,{children:"而且我们一般使用 alpine 的基础镜像，类似 node:18.10-alpine3.14，这样构建出来镜像体积会小很多。"}),"\n",(0,d.jsx)(n.p,{children:"这就是用 Nest 项目构建 Docker 镜像的方式。"})]})}function O(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(P,{...e})}):P(e)}let X=O;O.__RSPRESS_PAGE_META={},O.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F41.%20Nest%20%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%20Dockerfile.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);