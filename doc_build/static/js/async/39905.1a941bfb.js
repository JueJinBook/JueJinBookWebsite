"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["39905"],{697519:function(e,n,r){r.r(n),r.d(n,{default:()=>H});var c=r(552676),s=r(740453);let i=r.p+"static/image/92d45404e64c2869629340870b625cc8.5c52d853.webp",l=r.p+"static/image/8794138ee4aa8d65ded44eaa4978b830.39084a39.webp",d=r.p+"static/image/ccb93bf125c74b3407b16c5a394eace8.3218c4a0.webp",a=r.p+"static/image/d7ec4193c57da75ff4b96db0095365f0.dd95771c.webp",t=r.p+"static/image/a5e16e3fe7f62d615100bb4114f275da.df712139.webp",h=r.p+"static/image/cb213e7e3e91a24d63cb2f5c683b1d77.577c8d74.webp",x=r.p+"static/image/06eadf41f1f25c7a76bd7160c22303cb.6ced3f10.webp",p=r.p+"static/image/01eff846245a537c43bf5ed2b8dec3c0.d0abfcf5.webp",j=r.p+"static/image/6d4097b8649fc765c8f0d97db15f8277.4160a15f.webp",o=r.p+"static/image/9da56686ad54cd9fcd49c0ed083e61d5.33a0027e.webp",g=r.p+"static/image/2a4289505dc93ed8128ec097bfae847f.2eeff9ac.webp",m=r.p+"static/image/aa10d7af504a56b7171bbe6dda8ee5fe.6bf4822a.webp",b=r.p+"static/image/d6466704797ce6a1aa32df897cbd71a6.9f834c32.webp",f=r.p+"static/image/54a119d07338776fe6a5ba875dca9acf.d8d28a80.webp",u=r.p+"static/image/c3001eb091b665d4000dcf664e6e3423.50ea0e72.webp",v=r.p+"static/image/d09934a9bd20b9124805fe6b9f862d46.defee0ef.webp",V=r.p+"static/image/c908f51ed2f1b24c8c5603c4c0e12bc6.91f7c2e1.webp",w=r.p+"static/image/b35705d535839f803ef32ab4823a5fb8.c5a593ea.webp",N=r.p+"static/image/9077bc84c87dd0600217ddee9b652911.32f86abb.webp",_=r.p+"static/image/0c9c63f283f004ecf76b66e15e2c2ff2.eb9ce1d3.webp",k=r.p+"static/image/9040ae845be1e09d4e42ef83a0cc0b53.eb85146c.webp",y=r.p+"static/image/1eb38e05e0d28137c5e85d8033d14d58.d8c87088.webp",R=r.p+"static/image/0c7b2700bf59ed28f506b64c256974fc.a308f0f3.webp",S=r.p+"static/image/86a5e99ddb2aae382aaf8e73b242a732.0f1ff0a3.webp",P=r.p+"static/image/77d750653329ff0f0eeefb57510e6001.1352ee75.webp",E=r.p+"static/image/4600f9de02b0f0b30bde8135e8b2f79e.8dba218d.webp",A=r.p+"static/image/ad4049186bacf6b6564ee9743c17fcf3.fe028bb7.webp",C=r.p+"static/image/bab0d0f0c8b48f9e510fdba6c2222bb7.60c9be74.webp",L=r.p+"static/image/d0b3c7087845d7b4eb62ba74b1fcd397.bbee6029.webp",q=r.p+"static/image/af3b7add7b421f7af7b95404cfad74e2.b7b68314.webp",G=r.p+"static/image/36ec02710a866bc34e6b0221846069ed.a992ba84.webp",I=r.p+"static/image/307bf99c96d5b90a0241d3939ee60ce3.462de3a5.webp",M=r.p+"static/image/c07f41dcd9d932fc3db61a402ef2d19e.9efb5ca3.webp",T=r.p+"static/image/177f174e2df6ceb202fe4b4d8f028262.c89baf5e.webp",D=r.p+"static/image/3d36c84f91fc49d4d1c2ab31046b90b4.c9216e67.webp";function Q(e){let n=Object.assign({h2:"h2",a:"a",p:"p",ul:"ul",li:"li",blockquote:"blockquote",strong:"strong",ol:"ol",h3:"h3",h4:"h4",img:"img",code:"code",pre:"pre"},(0,s.ah)(),e.components);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.h2,{id:"前言",children:["前言",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#前言",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"本篇我们讲解如何用 Vercel 部署我们的 Next.js 项目。"}),"\n",(0,c.jsxs)(n.h2,{id:"vercel-公司",children:["Vercel 公司",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#vercel-公司",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"Vercel 既是一个产品也是一家公司。我们就先说说 Vercel 这家公司的故事。"}),"\n",(0,c.jsx)(n.p,{children:"Vercel 是由 Guillermo Rauch 创立的云服务公司，它的前身是 2015 年 Guillermo 创立的 Zeit，2020 年才更名为 Vercel。"}),"\n",(0,c.jsx)(n.p,{children:"Zeit 于 2016 年推出了核心产品 now，用于帮助开发者快速将应用部署到云端。因为在那个时候，云部署还并未像现在这样便利，now 将域名解析、证书、缓存等服务都做到产品内部，让用户能够一键部署，节省时间精力。"}),"\n",(0,c.jsx)(n.p,{children:"2016 年也正是前后端分离架构开始流行的时候，虽然前后端分离带来了前端的“繁荣”，但也带来了诸如 SEO 等问题。于是很多开发者开始设计 SSR 框架，Guillermo 也看到了这一问题（以及问题背后的机遇），创建了 Next.js，一个基于 React （当时正火）的 SSR 框架。在之后的这些年里，Next.js 持续深耕运营，如大家所见，Next.js 目前已成为 React 领域里的明星项目。"}),"\n",(0,c.jsx)(n.p,{children:"Next.js 的成功也带动了 Vercel 的发展，Vercel 也深度集成了 Next.js，这使得 Next.js 项目的开发者会更倾向于使用 Vercel 进行部署。2021 年，Vercel 完成了 1.5 亿美元的 D 轮融资。目前估值已经达到了 25 亿美金。"}),"\n",(0,c.jsx)(n.p,{children:"除此之外，Vercel 被人津津乐道的是它挖了不少业界大佬，如："}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Sebastian Markbage：原 React 团队 Tech Lead"}),"\n",(0,c.jsx)(n.li,{children:"Rich Harries：sveltejs 作者 & rollup 核心贡献者"}),"\n",(0,c.jsx)(n.li,{children:"Donny：swc 作者"}),"\n",(0,c.jsx)(n.li,{children:"Tobias Koppers：webpack 作者"}),"\n",(0,c.jsx)(n.li,{children:"Alexander Akait：webpack 核心贡献者 & prettier 贡献者"}),"\n",(0,c.jsx)(n.li,{children:"Jared Palme：Turborepo 创始人"}),"\n",(0,c.jsx)(n.li,{children:"……"}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"目前 Next.js 依然由 Vercel 来维护，再加上全明星的开发团队，未来可期。"}),"\n",(0,c.jsxs)(n.h2,{id:"vercel-产品",children:["Vercel 产品",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#vercel-产品",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["接下来我们说说 Vercel 这个产品，根据",(0,c.jsx)(n.a,{href:"https://vercel.com/",target:"_blank",rel:"noopener noreferrer",children:"官网"}),"的介绍："]}),"\n",(0,c.jsxs)(n.blockquote,{children:["\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Vercel is the Frontend Cloud"}),". Build, scale, and secure a faster, personalized web."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"简单来说，Vercel 是一个网站托管平台，部署体验好。"}),"\n",(0,c.jsx)(n.p,{children:"具体来说，有以下这些功能特点："}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"部署方便"}),"：一键部署，可以快速将前端应用程序、静态网站、API 等部署到 CDN 上，支持自定义域名、HTTPS、数据监控等，与 Git 集成，支持自动化部署，当提交了新的代码时会自动构建并部署"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"性能与拓展性"}),"：支持多个框架的部署，并利用缓存、路由、边缘网络提供最佳性能和高流量处理能力"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Serverless 函数"}),"：可以轻松构建和部署无服务器函数和 API，无需关心服务器的维护和扩展"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"团队协作"}),"：支持团队协作功能，并与 GitHub、Gitlab 等平台无缝集成"]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"不过国内因为一些原因，Vercel 部署的网站无法直接访问，使用 Vercel 部署的项目更适合用于出海。"}),"\n",(0,c.jsxs)(n.h2,{id:"使用-vercel",children:["使用 Vercel",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#使用-vercel",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["使用 Vercel 部署自然需要一个账号，注册地址：",(0,c.jsx)(n.a,{href:"https://vercel.com/signup",target:"_blank",rel:"noopener noreferrer",children:"https://vercel.com/signup"}),"，建议使用 GitHub 账号登陆，这样可以方便部署自己在 GitHub 上的项目。"]}),"\n",(0,c.jsxs)(n.h3,{id:"部署纯前端项目",children:["部署纯前端项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#部署纯前端项目",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"现在让我们部署一个纯前端项目来熟悉下基本流程吧！"}),"\n",(0,c.jsxs)(n.h4,{id:"导入项目",children:["导入项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#导入项目",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["Vercel 支持导入 Git 项目或者使用 Vercel 提供的",(0,c.jsx)(n.a,{href:"https://vercel.com/templates/next.js",target:"_blank",rel:"noopener noreferrer",children:"现成模板"}),"："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:D,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["点击上图左侧的 ",(0,c.jsx)(n.code,{children:"Install"})," 按钮，会授权 Vercel 读取和写入 GitHub 的仓库和 Git 信息，可用于自动化部署。"]}),"\n",(0,c.jsxs)(n.p,{children:["这里我选择了自己账号下的 ",(0,c.jsx)(n.a,{href:"https://github.com/mqyqingfeng/next-app-demo/tree/Intercepting-Routes",target:"_blank",rel:"noopener noreferrer",children:"next-app-demo"})," 项目，这是我们小册基础篇的 Demo："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:T,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["如果你也想试着部署这个项目，可以选择 ",(0,c.jsx)(n.code,{children:"Import Third-Party Git Repository"}),"，然后输入地址："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"https://github.com/mqyqingfeng/next-app-demo/tree/Intercepting-Routes\n"})}),"\n",(0,c.jsx)(n.p,{children:"Vercel 会让你在 Git 平台创建一个对应仓库方便后续修改和部署，按照 Vercel 指示操作即可。"}),"\n",(0,c.jsxs)(n.h4,{id:"部署项目",children:["部署项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#部署项目",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["进入部署页面后，因为我们的代码比较简单，不需要额外的填写，直接点击 ",(0,c.jsx)(n.code,{children:"Deploy"}),"即可："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:M,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["当部署完成后会进入以下页面：\n",(0,c.jsx)("img",{src:I,alt:"image.png"})]}),"\n",(0,c.jsxs)(n.p,{children:["在 ",(0,c.jsx)(n.code,{children:"Dashboard"})," 页面点击 ",(0,c.jsx)(n.code,{children:"Visit"})," 按钮即可访问部署后的效果："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:G,alt:"截屏2024-02-22 14.51.58.png"})}),"\n",(0,c.jsxs)(n.p,{children:["像我这次的部署地址为：",(0,c.jsx)(n.a,{href:"https://next-app-demo-ebon.vercel.app/",target:"_blank",rel:"noopener noreferrer",children:"https://next-app-demo-ebon.vercel.app/"}),"，效果如下："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:q,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["此外，当你推送代码到这个分支的时候，Vercel 会自动进行部署。如果出现错误，你也可以选择右上角的 ",(0,c.jsx)(n.code,{children:"Instant Rollback"})," 进行回滚。"]}),"\n",(0,c.jsxs)(n.h4,{id:"自定义域名",children:["自定义域名",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#自定义域名",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["如果我们想要使用自定义的域名呢？首先你要有一个自己的域名，域名购买和备案可以参考",(0,c.jsx)(n.a,{href:"https://juejin.cn/post/7052257775270756366",target:"_blank",rel:"noopener noreferrer",children:"《一篇域名从购买到备案到解析的详细教程》"}),"。"]}),"\n",(0,c.jsxs)(n.p,{children:["假设你已经有了域名，比如我有了 ",(0,c.jsx)(n.code,{children:"yayujs.com"})," 这个域名，我希望将 ",(0,c.jsx)(n.code,{children:"nextdemo.yayujs.com"}),"这个域名解析到 Vercel 部署的地址。打开",(0,c.jsx)(n.a,{href:"https://dc.console.aliyun.com/next/index?#/domain-list/all",target:"_blank",rel:"noopener noreferrer",children:"域名控制台"}),"（我是在万网买的域名，所以这里链接的地址是阿里云域名控制台），选择对应的域名，点击“解析”。"]}),"\n",(0,c.jsxs)(n.p,{children:["根据 ",(0,c.jsx)(n.a,{href:"https://vercel.com/docs/getting-started-with-vercel/use-existing",target:"_blank",rel:"noopener noreferrer",children:"Vercel 官方文档域名添加"}),"的介绍："]}),"\n",(0,c.jsxs)(n.blockquote,{children:["\n",(0,c.jsx)(n.p,{children:"If the domain is in use by another Vercel account, you will need to verify access to the domain, with a TXT record"}),"\n",(0,c.jsx)(n.p,{children:"If you're using an Apex domain (e.g. example.com), you will need to configure it with an A record"}),"\n",(0,c.jsx)(n.p,{children:"If you're using a Subdomain (e.g. docs.example.com), you will need to configure it with a CNAME record"}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["也就是说，如果是根域，就配置 A 记录，如果是子域，就配置 CNAME 记录。这里因为配置的是子域，所以选择的 ",(0,c.jsx)(n.code,{children:"CNAME"}),"，配置如下："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:L,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"其中记录值填写我们项目部署的域名。"}),"\n",(0,c.jsx)(n.p,{children:"最后在 Vercel 的设置中添加设置的域名："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:C,alt:"截屏2024-02-22 15.58.59.png"})}),"\n",(0,c.jsx)(n.p,{children:"效果如下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:A,alt:"image.png"})}),"\n",(0,c.jsxs)(n.h4,{id:"国内访问",children:["国内访问",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#国内访问",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["Vercel 直接部署的域名是无法访问的，我们可以通过 ",(0,c.jsx)(n.a,{href:"https://tool.chinaz.com/dnsce",target:"_blank",rel:"noopener noreferrer",children:"https://tool.chinaz.com/dnsce"})," 检测我们的域名："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:E,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"如何让国内用户也可以访问呢？可以修改我们的域名解析："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:P,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["如果用的 A 记录，记录值为 ",(0,c.jsx)(n.code,{children:"76.223.126.88"})]}),"\n",(0,c.jsxs)(n.p,{children:["如果用的 CNAME，记录值为 ",(0,c.jsx)(n.code,{children:"cname-china.vercel-dns.com"})]}),"\n",(0,c.jsx)(n.p,{children:"过一小段时间后，再次检测："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:S,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"注：不过有的时候还是会无法访问，国内还是建议用自己的服务器"}),"\n",(0,c.jsxs)(n.h3,{id:"部署-nextjs--redis-项目",children:["部署 Next.js + Redis 项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#部署-nextjs--redis-项目",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"我们以 React Notes 的 day1 项目为例，此时我们代码中使用了 Next.js 和 Redis，我们看下如何部署。"}),"\n",(0,c.jsxs)(n.h4,{id:"下载项目",children:["下载项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#下载项目",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"下载我们的 day1 分支代码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"git clone -b day1 git@github.com:mqyqingfeng/next-react-notes-demo.git\n"})}),"\n",(0,c.jsx)(n.p,{children:"大家还记得 day1 实现的效果吗？我们本地运行以下代码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"cd next-react-notes-demo && npm i && npm run dev\n"})}),"\n",(0,c.jsx)(n.p,{children:"因为 day1 代码需要开启 redis 服务，所以另起一个命令行运行："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"redis-server\n"})}),"\n",(0,c.jsxs)(n.p,{children:["等 Redis 服务成功开启，此时打开 ",(0,c.jsx)(n.a,{href:"http://localhost:3000/",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000/"}),"，页面正常访问："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:R,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"左侧笔记列表的标题和时间取自于 Redis 数据库，说明代码运行正常。"}),"\n",(0,c.jsxs)(n.h4,{id:"vercel-cli",children:["Vercel Cli",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#vercel-cli",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["Vercel 提供了 ",(0,c.jsx)(n.a,{href:"https://vercel.com/docs/cli",target:"_blank",rel:"noopener noreferrer",children:"Vercel Cli"})," 用于命令行部署 Next.js 项目，全局安装 ",(0,c.jsx)(n.code,{children:"vercel"})," 命令："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"npm i -g vercel\n"})}),"\n",(0,c.jsx)(n.p,{children:"安装完成后，运行以下命令，检查是否成功安装："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"vercel --version\n"})}),"\n",(0,c.jsx)(n.p,{children:"效果如下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:y,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"进入我们的项目根目录，目前在 day1 分支，因为 day1 分支的代码不准备再改动，所以我们切换出一个新的分支用于部署："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"git checkout -b vercel-redis\n"})}),"\n",(0,c.jsx)(n.p,{children:"项目根目录运行："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"vercel\n"})}),"\n",(0,c.jsxs)(n.p,{children:["首次在项目中运行 ",(0,c.jsx)(n.code,{children:"vercel"})," 时，Vercel CLI 需要知道要将项目部署到哪里。所以会有一系列的操作提示，这些操作会让你验证身份、在 Vercel 上创建项目，进行构建部署等等。交互效果如下："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:k,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["此步会在项目构建部署的时候出错，因为我们的项目中用了 Redis，但此时并没有开启 Redis，所以运行 ",(0,c.jsx)(n.code,{children:"npm run build"})," 会失败。"]}),"\n",(0,c.jsxs)(n.p,{children:["既然会失败，其实也没有必要部署这一次。如果你只是希望在 Vercel 上创建一个项目并进行关联，那就运行 ",(0,c.jsx)(n.code,{children:"vercel git connect"}),"，等需要部署的时候再运行 ",(0,c.jsx)(n.code,{children:"vercel deploy"}),"。交互效果如下："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:_,alt:"image.png"})}),"\n",(0,c.jsxs)(n.h4,{id:"创建数据库",children:["创建数据库",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#创建数据库",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["通过刚才的步骤建立一个项目后，在 Vercel 平台进入创建的项目，选择 ",(0,c.jsx)(n.code,{children:"Storage"})," 选项，这里展示了 Vercel 目前支持的四种数据库："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:N,alt:"截屏2024-02-22 21.06.15.png"})}),"\n",(0,c.jsx)(n.p,{children:"分别是："}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Vercel KV：基于 Redis 的解决方案，适用于 Key/Value 和 JSON 数据，由 Upstash 提供支持"}),"\n",(0,c.jsx)(n.li,{children:"Vercel Postgres：基于 PostgreSQL 的解决方案，轻量关系型数据库，由 Neon 提供支持"}),"\n",(0,c.jsx)(n.li,{children:"Vercel Blob：提供文件存储解决方案，由 Cloudflare R2 提供支持"}),"\n",(0,c.jsx)(n.li,{children:"Edge Config：全局数据存储，能在 Edge Server 读取，适用于频繁读取但少有改动的配置"}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["这里我们选择 ",(0,c.jsx)(n.code,{children:"KV"}),"，点击 ",(0,c.jsx)(n.code,{children:"Create"}),"，地区选择默认的即可（选择其他的还会提示你跟项目部署的地区不一致）："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:w,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"继续点击 Connect："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:V,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"现在可以看到我们创建的 Redis 数据库的地址，Vercel 也贴心的提供了接下来要做的事情："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:v,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"我们解释下这些要做的事情："}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"Connect to a project：将已有的 Vercel 项目与该数据库进行关联，刚才已经点击了 Connect ，所以不需要再点了。Connect 后，Vercel 会为项目自动添加数据库相关的环境变量："}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:u,alt:"截屏2024-02-22 21.46.30.png"})}),"\n",(0,c.jsxs)(n.ol,{start:"2",children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Pull your latest environment variables：Vercel 提示让你在本地运行 ",(0,c.jsx)(n.code,{children:"vercel env pull .env.development.local"}),"，它的作用是在本地创建一个名为 ",(0,c.jsx)(n.code,{children:".env.development.local"}),"的文件，自动写入上图中的这些环境变量的值，方便你在本地直接使用"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Install our package：为方便用户操作数据库，Vercel 提供了自己的库 ",(0,c.jsx)(n.code,{children:"@vercel/kv"}),"，具体 API 参考 ",(0,c.jsx)(n.a,{href:"https://vercel.com/docs/storage/vercel-kv/kv-reference",target:"_blank",rel:"noopener noreferrer",children:"https://vercel.com/docs/storage/vercel-kv/kv-reference"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["如果一开始就确定用 Vercel 部署，那最好使用 ",(0,c.jsx)(n.code,{children:"@vercel-kv"}),"，不过我们用到的 redis API 也比较简单，使用 ",(0,c.jsx)(n.code,{children:"ioredis"})," 也是可以的。现在已经有了 redis 数据库的地址，我们修改下 ",(0,c.jsx)(n.code,{children:"/lib/redis.js"}),"："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const redis = new Redis(process.env.REDIS_URL)\n"})}),"\n",(0,c.jsxs)(n.p,{children:["修改 ",(0,c.jsx)(n.code,{children:".env.development.local"}),"，添加如下代码："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'REDIS_URL="rediss://default:xxxxxxxxxxxxxx@xxxxxxxxxxx:33605"\n'})}),"\n",(0,c.jsxs)(n.p,{children:["我们做的修改就是复制原本的 ",(0,c.jsx)(n.code,{children:"KV_URL"})," 将 ",(0,c.jsx)(n.code,{children:"redis://xxxx"}),"改为 ",(0,c.jsx)(n.code,{children:"rediss://xxxx"}),"，加个 ",(0,c.jsx)(n.code,{children:"s"})," 表示建立 SSL 连接。"]}),"\n",(0,c.jsx)(n.p,{children:"此时本地已经可以成功运行："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:f,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["现在我们将代码进行提交（注意 ",(0,c.jsx)(n.code,{children:".env.development.local"})," 顾名思义，不用提交）："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'git status\ngit add .\ngit commit -m "update redis.js"\ngit push origin vercel-redis\n'})}),"\n",(0,c.jsx)(n.p,{children:"提交到 GitHub 后，Vercel 会自动进行部署。但此时部署会失败："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:b,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["因为服务端的环境变量还没有建立，我们在该 Vercel 项目上添加一个新的环境变量 ",(0,c.jsx)(n.code,{children:"REDIS_URL"}),"："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:m,alt:"截屏2024-02-23 16.50.54.png"})}),"\n",(0,c.jsx)(n.p,{children:"然后重新部署，点击 Redeploy："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:g,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"此次应该会成功部署："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:o,alt:"image.png"})}),"\n",(0,c.jsxs)(n.h4,{id:"preview-与-production",children:["Preview 与 Production",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#preview-与-production",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"此时我们已经成功的部署了一个 Next.js + Redis 的项目。在后续的发布中，有一点要注意，那就是 Preview 与 Production 环境的区别。"}),"\n",(0,c.jsxs)(n.p,{children:["现在我们用的是 ",(0,c.jsx)(n.code,{children:"vercel-redis"})," 分支，当第一次推送的时候，Vercel 会将其内容部署到生产环境，但是比如你修改了一些内容，然后再次推送到 ",(0,c.jsx)(n.code,{children:"vercel-redis"})," 分支，Vercel 会进行自动化部署，但会放在 Preview 环境中："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:j,alt:"截屏2024-02-23 17.11.29.png"})}),"\n",(0,c.jsxs)(n.p,{children:["这是因为 Vercel 默认将 main / master 分支用于生产环境，只有当你推送代码到 main/master 分支的时候，才会进行生产部署，推送到其他分支就是 Preview 环境。这很好，可以进行多个版本的开发预览。但如果你就是想要指定如 ",(0,c.jsx)(n.code,{children:"vercel-redis"})," 分支作为生产环境部署，可以在 Settings 中修改："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:p,alt:"截屏2024-02-23 17.16.03.png"})}),"\n",(0,c.jsxs)(n.p,{children:["此时再推送到 ",(0,c.jsx)(n.code,{children:"vercel-redis"})," 分支就会进行生产部署。"]}),"\n",(0,c.jsxs)(n.h3,{id:"部署-nextjs--关系型数据库--prisma-项目",children:["部署 Next.js + 关系型数据库 + Prisma 项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#部署-nextjs--关系型数据库--prisma-项目",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"通过前面的示例，想必你已经对 Vercel 平台的使用有所了解，那就来正式部署我们的项目吧。"}),"\n",(0,c.jsxs)(n.h4,{id:"下载项目-1",children:["下载项目",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#下载项目-1",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"依然选用我们的 day11 分支代码。此时我们的技术选型是 Next.js + MySQL + Prisma。"}),"\n",(0,c.jsx)(n.p,{children:"下载我们的 day11 分支代码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"git clone -b day11 git@github.com:mqyqingfeng/next-react-notes-demo.git\n"})}),"\n",(0,c.jsx)(n.p,{children:"老规矩，先本地运行一下，验证代码无问题："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# 50.实战篇 _ React Notes _ Vercel 部署\nnpm i && npm run dev\n"})}),"\n",(0,c.jsxs)(n.p,{children:["正如大家在上节看到，Vercel 是没有提供 MySQL 数据库的，关系型数据库只有 Vercel Postgres。如果确定用 MySQL 数据库，那可以使用搭配使用 ",(0,c.jsx)(n.a,{href:"https://planetscale.com/",target:"_blank",rel:"noopener noreferrer",children:"PlanetScale"}),"，它是一个 MySQL 云数据库。如果用 Mongodb，则通常会搭配 ",(0,c.jsx)(n.a,{href:"https://www.mongodb.com/zh-cn/cloud/atlas/lp/try4",target:"_blank",rel:"noopener noreferrer",children:"MongoDB Atlas"})," 云数据库。所以对于我们的项目，部署有两种选择："]}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"改用 Vercel 提供的 Vercel Postgres，也就是改用 PostgreSQL 数据库"}),"\n",(0,c.jsx)(n.li,{children:"使用 PlanetScale 云 MySQL 数据库"}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"从技术选型的角度来讲，如果我知道最终用 Vercel 进行部署，我可能一开始就会选择用 PostgreSQL 数据库。"}),"\n",(0,c.jsx)(n.p,{children:"从钱的角度来讲，Vercel 的免费版只支持一个 PostgreSQL 数据库，且有 256MB 和每月 60h 计算时间的限制。PlanetScale 的免费版则是 5 GB 存储空间，10 亿行读取次数每月，1000 万行写入每月。更推荐用 PlanetScale。"}),"\n",(0,c.jsx)(n.p,{children:"从学习的角度来讲，就让我们顺便学习一下 Prisma 和 PostgreSQL 如何搭配使用吧！"}),"\n",(0,c.jsx)(n.p,{children:"所以我们改用 PostgreSQL 数据库（其实两种方式操作差不多）。所幸我们的项目用了 Prisma，切换的成本并不高。让我们看看如何实现吧！"}),"\n",(0,c.jsxs)(n.h4,{id:"切换数据库",children:["切换数据库",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#切换数据库",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["进入项目目录，运行 ",(0,c.jsx)(n.code,{children:"vercel git connect"}),"在 Vercel 平台上建立关联项目："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:x,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["建立项目后，选择 ",(0,c.jsx)(n.code,{children:"Storage"}),"选项，建立一个 Vercel Postgres 数据库，最终获得该数据库地址为："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:h,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["拷贝上图 ",(0,c.jsx)(n.code,{children:".env.local"})," 选项中的环境变量，将其写入 ",(0,c.jsx)(n.code,{children:".env"}),"文件："]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)("img",{src:t,alt:"截屏2024-02-26 17.50.19.png"}),"\n注：为什么不运行 ",(0,c.jsx)(n.code,{children:"vercel env pull .env"}),"呢？因为这会强行覆盖 ",(0,c.jsx)(n.code,{children:".env"})," 文件。为什么不写入其他文件如 ",(0,c.jsx)(n.code,{children:".env.local"}),"呢？因为 prisma 默认读取的是 ",(0,c.jsx)(n.code,{children:".env"})," 文件中的环境变量。为了简单起见选择手动拷贝的方式。"]}),"\n",(0,c.jsxs)(n.p,{children:["修改 ",(0,c.jsx)(n.code,{children:"prisma/schema.prisma"}),"文件："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:'datasource db {\n  provider = "postgresql"\n  url = env("POSTGRES_PRISMA_URL")\n}\n'})}),"\n",(0,c.jsxs)(n.p,{children:["运行 ",(0,c.jsx)(n.code,{children:"npx prisma db push"}),"，将数据模型同步数据库。"]}),"\n",(0,c.jsxs)(n.p,{children:["现在，让我们在本地再次运行 ",(0,c.jsx)(n.code,{children:"npm run dev"}),"校验数据库切换是否有问题："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:a,alt:"image.png"})}),"\n",(0,c.jsxs)(n.h4,{id:"部署线上",children:["部署线上",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#部署线上",children:"#"})]}),"\n",(0,c.jsxs)(n.p,{children:["修改 ",(0,c.jsx)(n.code,{children:"package.json"}),"，代码如下："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:'{\n  "scripts": {\n    "dev": "npx prisma generate && next dev",\n    "build": "npx prisma generate && npx prisma db push && next build"\n  }\n}\n\n'})}),"\n",(0,c.jsxs)(n.p,{children:["修改 ",(0,c.jsx)(n.code,{children:".env.production"}),"："]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"# 注释掉 AUTH_URL，v5 之后默认不需要了，但比如用了代理的时候依然需要\n# AUTH_URL=https://notes.yayujs.com\n"})}),"\n",(0,c.jsxs)(n.p,{children:["因为使用了 next-auth，在 Vercel 项目的环境变量中需要添加 ",(0,c.jsx)(n.code,{children:"AUTH_SECRET"}),"："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:d,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["目前我们还在 day11 分支，切换为新的 ",(0,c.jsx)(n.code,{children:"vercel-postgres"}),"分支，然后将代码提交到远程的 ",(0,c.jsx)(n.code,{children:"vercel-postgres"}),"分支，因为是首次部署，所以会部署到生产版本，交互效果如下："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:l,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:"Vercel 自动部署后，效果如下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:i,alt:"image.png"})}),"\n",(0,c.jsxs)(n.p,{children:["部署后的项目源码：",(0,c.jsx)(n.a,{href:"https://github.com/mqyqingfeng/next-react-notes-demo/tree/vercel-postgres",target:"_blank",rel:"noopener noreferrer",children:"https://github.com/mqyqingfeng/next-react-notes-demo/tree/vercel-postgres"})]}),"\n",(0,c.jsxs)(n.h2,{id:"参考链接",children:["参考链接",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#参考链接",children:"#"})]}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://juejin.cn/post/7057333396359348255",target:"_blank",rel:"noopener noreferrer",children:"https://juejin.cn/post/7057333396359348255"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://www.zhihu.com/question/506210785/answer/2347889174",target:"_blank",rel:"noopener noreferrer",children:"https://www.zhihu.com/question/506210785/answer/2347889174"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://vercel.com/",target:"_blank",rel:"noopener noreferrer",children:"https://vercel.com/"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://lastrev.com/blog/introduction-to-vercel-a-beginners-guide",target:"_blank",rel:"noopener noreferrer",children:"https://lastrev.com/blog/introduction-to-vercel-a-beginners-guide"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://github.com/vercel/examples/tree/main/storage/postgres-prisma",target:"_blank",rel:"noopener noreferrer",children:"https://github.com/vercel/examples/tree/main/storage/postgres-prisma"})}),"\n"]}),"\n",(0,c.jsx)(n.blockquote,{children:"\n"})]})}function U(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(Q,{...e})}):Q(e)}let H=U;U.__RSPRESS_PAGE_META={},U.__RSPRESS_PAGE_META["Next.js%20%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97%2F50.%E5%AE%9E%E6%88%98%E7%AF%87%20_%20React%20Notes%20_%20Vercel%20%E9%83%A8%E7%BD%B2.md"]={toc:[{text:"前言",id:"前言",depth:2},{text:"Vercel 公司",id:"vercel-公司",depth:2},{text:"Vercel 产品",id:"vercel-产品",depth:2},{text:"使用 Vercel",id:"使用-vercel",depth:2},{text:"部署纯前端项目",id:"部署纯前端项目",depth:3},{text:"导入项目",id:"导入项目",depth:4},{text:"部署项目",id:"部署项目",depth:4},{text:"自定义域名",id:"自定义域名",depth:4},{text:"国内访问",id:"国内访问",depth:4},{text:"部署 Next.js + Redis 项目",id:"部署-nextjs--redis-项目",depth:3},{text:"下载项目",id:"下载项目",depth:4},{text:"Vercel Cli",id:"vercel-cli",depth:4},{text:"创建数据库",id:"创建数据库",depth:4},{text:"Preview 与 Production",id:"preview-与-production",depth:4},{text:"部署 Next.js + 关系型数据库 + Prisma 项目",id:"部署-nextjs--关系型数据库--prisma-项目",depth:3},{text:"下载项目",id:"下载项目-1",depth:4},{text:"切换数据库",id:"切换数据库",depth:4},{text:"部署线上",id:"部署线上",depth:4},{text:"参考链接",id:"参考链接",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);