"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["30480"],{704174:function(e,n,s){e.exports=s.p+"static/image/05fe13cd2d8464a8b668cd26d9b0840a.b5119a48.webp"},490462:function(e,n,s){s.r(n),s.d(n,{default:()=>ee});var i=s(552676),a=s(740453);let r=s.p+"static/image/dd0cacab402e664bda038ce7df0e2537.e17ddee4.webp",c=s.p+"static/image/dd650dea1897091c8cdc48130f9f79c4.1aed3c14.webp",t=s.p+"static/image/7d7417b420ec6c2697e084ee49d373cf.8af16b93.webp",d=s.p+"static/image/b7c59b94b94e1a414af69299b854dd3a.64bf7544.webp",l=s.p+"static/image/1240fb1fb40ffc7101f154785be0a1a2.ee805580.webp",p=s.p+"static/image/13b4b6178b8a4c765ec3b0c126ce5004.a5ffc6f6.webp",o=s.p+"static/image/c935c473864962ea4f8433feaafcd3a7.ada8551e.webp",h=s.p+"static/image/c15df5306af7c501cc1d6b6e788cd785.35e2d7d4.webp",m=s.p+"static/image/73d554b58e8f73dde39cd43e9f9252f6.18529363.webp",j=s.p+"static/image/e65e68efac61f2fb1d2f3e2eaae7f6b0.c27dce2f.webp",x=s.p+"static/image/9f6f9a4a28b3eb5a126c957b8e693d4c.55a6c28b.webp",g=s.p+"static/image/cc17a38d35538a000405c2322ef0b5e5.fde6fc7f.webp",b=s.p+"static/image/7c515cdc64d6d1b56415db01102b5d0d.5f862e5c.webp",f=s.p+"static/image/828d8a238d9938297e4b9616a59c6dc7.ce5903ad.webp",u=s.p+"static/image/909303f8aad5e83adb82799e886e95fd.9c6e08a1.webp",v=s.p+"static/image/300d9e15725742e681cdf93dba3c2ae4.3a543f78.webp",A=s.p+"static/image/b0e7553cc73db61c5054b24219c30b47.af81a5bc.webp",w=s.p+"static/image/d1be2d76260c832fe1cb6db0fb161a69.86676bf0.webp",k=s.p+"static/image/d5c99b963a38cd8336307cfa55066a97.48da4984.webp",y=s.p+"static/image/23f35f41abc88b7547465ab8729b6019.6ce42e32.webp",E=s.p+"static/image/eea9c568ad02986f4966e9f7f250b066.9e30d44f.webp",S=s.p+"static/image/1a15e521a74c7e95dc1c9a1176701e92.0841808b.webp",N=s.p+"static/image/3e465aeac7ee0cc81157aad13e5b1315.a13cb0c9.webp",R=s.p+"static/image/104381f5069630e35cbee19ac265affb.130ea8d7.webp",C=s.p+"static/image/1c46bc9edd068b71fef961665123a086.f18be629.webp",P=s.p+"static/image/3814d7bb1da6b43aea2806b29d1730d2.19e541a8.webp",M=s.p+"static/image/2f9a5f447e89f86bcc74b1ddaca596e9.d026a6a4.webp",z=s.p+"static/image/8b5a4447d3d7e97acda59c6a71fdec8a.12400663.webp",B=s.p+"static/image/5ce80b5a4bbf62ae9c4186ac3f29551d.dd59b619.webp",L=s.p+"static/image/ca854b51a797ba397a1f9e5ba4b339f4.9e3138bc.webp",T=s.p+"static/image/3b7a4014332687e453d605fdb6568a56.c2dc7694.webp",J=s.p+"static/image/8ed861881caea52088dc610136e47657.89bc04e6.webp";var H=s(704174);let I=s.p+"static/image/c369a8dd9e87c6e489ec05f6d03bda34.fb1566b0.webp",O=s.p+"static/image/9f08f3cd654db88cbf0d8e1d090a7a9a.2af63283.webp",G=s.p+"static/image/4455d8e967c6a70f2028756949b3424b.38e68a92.webp",U=s.p+"static/image/d7dd6f75aef1870acde4f40c1f9f1354.51f0a0a2.webp",Y=s.p+"static/image/4edd1698252fd77ac6a36d6fc85fa7ee.14dcca93.gif",Q=s.p+"static/image/1b381426bbf7989a8562244748dfe739.81e446d7.webp",Z=s.p+"static/image/75fac6ddc28140255b622dd0ea0f627a.5c57ca4e.webp",F=s.p+"static/image/fda12c5841cf74749af5b051c7e30d7e.f658aa2c.webp",D=s.p+"static/image/42bd02c489ea5fd24c77d09f3b02204c.8e373cf0.webp",X=s.p+"static/image/f85e5aec8ff84573b73acd7d5cde0dbe.4395a8da.webp",W=s.p+"static/image/11ed8f7ebb5f309a247452d019eb1652.908f6f25.webp",q=s.p+"static/image/ff1339623d6c5eb4bf1d491341087dab.70426659.webp",V=s.p+"static/image/390aa87c341b52c895f3185818ead822.40620c3c.webp",K=s.p+"static/image/34de9b48e6484d3bcd82aae1e56e190e.9c75575c.webp";function _(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",ul:"ul",li:"li",strong:"strong",pre:"pre",code:"code",h2:"h2"},(0,a.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"82-redis--高德地图实现附近的充电宝",children:["82. Redis + 高德地图，实现附近的充电宝",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#82-redis--高德地图实现附近的充电宝",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"想必大家都打过车，打车软件可以根据你的当前位置搜索附近的车辆："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:K,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这两天国庆节，大家出去玩可能会借用共享充电宝。它也是基于你的位置来搜索附近充电宝："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:V,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"再就是大家搜索附近的酒店、餐厅等，也是基于位置的搜索。"}),"\n",(0,i.jsx)(n.p,{children:"那么问题来了：这种附近的人、附近的酒店、附近的充电宝的功能是怎么实现的呢？"}),"\n",(0,i.jsx)(n.p,{children:"答案是用 Redis 实现的。"}),"\n",(0,i.jsx)(n.p,{children:"很多人对 Redis 的认识停留在它能做缓存，也就是从数据库中查询出来的数据，放到 redis 里，下次直接拿 redis 的数据返回："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"确实，缓存是 redis 的常见应用。"}),"\n",(0,i.jsx)(n.p,{children:"但它并不只是可以做缓存，很多临时的数据，比如验证码、token 等，都可以放到 redis 里。"}),"\n",(0,i.jsx)(n.p,{children:"redis 是 key-value 的数据库，value 有很多种类型："}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"string"}),"： 可以存数字、字符串，比如存验证码就是这种类型"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"hash"}),"：存一个 map 的结构，比如文章的点赞数、收藏数、阅读量，就可以用 hash 存"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"set"}),"：存去重后的集合数据，支持交集、并集等计算，常用来实现关注关系，比如可以用交集取出互相关注的用户"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"zset"}),"：排序的集合，可以指定一个分数，按照分数排序。我们每天看的文章热榜、微博热榜等各种排行榜，都是 zset 做的"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"list"}),"：存列表数据"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"geo"}),"：存地理位置，支持地理位置之间的距离计算、按照半径搜索附近的位置"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"其中，geo 的数据结构，就可以用来实现附近的人等功能。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"比如大众点评、美团外卖这种，就是用 redis 实现的基于地理位置的功能。"}),"\n",(0,i.jsx)(n.p,{children:"今天我们就来实现一下："}),"\n",(0,i.jsx)(n.p,{children:"在 RedisInsight 里输入命令，点击执行："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-redis",children:'geoadd loc 13.361389 38.115556 "guangguang" 15.087269 37.502669 "dongdong" \n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:X,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们用 geoadd 命令添加了两个位置。"}),"\n",(0,i.jsx)(n.p,{children:"guangguang 的位置是经度 13.361389，纬度 38.11556"}),"\n",(0,i.jsx)(n.p,{children:"dongdong 的位置是经度 15.08729 ，纬度 37.502669"}),"\n",(0,i.jsx)(n.p,{children:"点击刷新，就可以看到 loc 的 key："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:D,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后可以用 geodist 计算两个位置之间的距离："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"geodist loc guangguang dongdong\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到相距差不多 166 km"}),"\n",(0,i.jsx)(n.p,{children:"然后用 georadius 分别查找经度 15、纬度 37 位置的附近 100km 半径和 200km 半径的点："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"georadius loc 15 37 100 km\ngeoradius loc 15 37 200 km\n"})}),"\n",(0,i.jsx)(n.p,{children:"结果如下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Z,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"因为两个点相距 166km，所以搜索 100km 以内的点，只能搜到一个。而 200km 的内的点，能搜到两个。"}),"\n",(0,i.jsx)(n.p,{children:"这样，我们就可以实现搜索附近 1km 的充电宝的功能。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"服务端提供一个接口，让充电宝机器上传位置信息，然后把它存到 redis 里。"}),"\n",(0,i.jsx)(n.p,{children:"再提供个搜索的接口，基于传入的位置用 georadius 来搜索附近的充电宝机器，返回客户端。"}),"\n",(0,i.jsx)(n.p,{children:"客户端可以在地图上把这些点画出来。"}),"\n",(0,i.jsx)(n.p,{children:"这里用高德地图或者百度地图都行，他们都支持在地图上绘制 marker 标记的功能："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"比如上面我们分别在地图上绘制了 marker 和 circle："}),"\n",(0,i.jsx)(n.p,{children:"这是添加 Marker 的代码："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"指定 marker 的经纬度和图片就行。"}),"\n",(0,i.jsx)(n.p,{children:"这是添加 Circle 的代码："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"指定圆心经纬度和半径就行。"}),"\n",(0,i.jsx)(n.p,{children:"都挺简单的。"}),"\n",(0,i.jsx)(n.p,{children:"这样，后端和前端分别怎么实现，我们就都理清了。"}),"\n",(0,i.jsx)(n.p,{children:"接下来用代码实现下。"}),"\n",(0,i.jsx)(n.p,{children:"创建个 nest 项目："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install g @nestjs/cli\n\nnest new nearby-search\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:O,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"进入项目目录，把它跑起来："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["浏览器访问 ",(0,i.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 可以看到 hello world，就代表 nest 服务跑起来了："]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,UklGRo4NAABXRUJQVlA4IIINAADQVgCdASo0AsoAPp1MoU0lpCMiIlNpILATiWlu4XPxFzOr8O/0j8bvCr/L+G/ix+AZ+OUfrc1Kfln2w/R+Y/ezwAvyn+lf5LedwB/ov9l78rUg8L+ir+tf7LytPBvoBfpn1af8Hx6fW3/w/0/wG/z3/DBxwBZgvkOGv+23eO3VmclNSrg57uljiLsoDKdkZtXPooUXN7I37JnHujZEuL2F8fYNsPaZ7TPaZ7S1n9vw9g0d066PTQq70r8oSdVtERkjN/j3i/DjmdZ0Z/mjMWcj5XiBuFgLec3fGbsft4vlbxW7BObqVCYc7AOIX8Do8+MTZMD1CV1zCML6qL6FkpJkpfl1BTGCy4ZfOn0Cym4sGxbAK+u7ITeRJ660C1iB0Z6xYuIM/3H7v9gPfLIFWamw9qVNYmzoVMRPkFahHTAg8dDxBe8DV6aSmWquFO9JBWZNHxsYOKXPcwQ6msjg9gYCxDT088H+ctpFaynPBTHzyADPq9MfsFECv0rjGuO50ATCFEvzLE8NMBn3Gb8EPBCj5H9hGJ/IJkknLcdJX67mlsZD6v4SEVYR+nYOBJhWhwcYSGhJfIcNf9tq0lXooNJWoKeGk6LXhpOi14OBxJWbMl22GdMH0BTX4WgjYNTdiOaJJH7SPkbYe0z2me0z2me0zaNL4BUnAm9PGwNLWrhFRFlBui/Mm+DWSk/WOm4gwqOxbF8lS5AzjApQpgUhgtaTLWaMquUI7wwL12IeGQBMbYe0z2me0z2mbaZFsy51Mz6O/FhF/fV/Ml288P9hGJ/IJjbD2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2me0z2meiqh0QeqxTrEWO5gcTbo5jXPaZ7TPaZ7TPaZ7TPZwShXdErBHUK8kawuD/xZll5oFOnCe1O+n6n/4AP4OfokXScp6rP/DWycnhRLhiscVjiscVjisca+mdPU66SPNYktzYHCHYErCYPvWVvSvJIBGNOfYtHKv4dkAP8+ezSgU/fvjnb/0UijTM2v9GuEBgZAABfN6wyPczQVLAMTajk6b4pumblAtJuRAYE5oegiomAPQv5hg9KMLv5s+eoDug/0JdyZgxD/ogfEyEZpzfEJI9+G83j1tS5835mrR5MjJRrEuEvj+3KnaBcahqxVtpSJ48XsJpCAeUKXwVmIH8Hnr6dIHhambgL4CXRvLYjkbN+Nn6/PRUU3lTzaWh8O5GW4omaBlM+gc0cMZJOjf466J9Me+k9TYu+gDUARBifbD8chyZUVOiP7AhQ3EXsoJSeeMiJUwqm0I4vYGECwGvUe8cHxafR+7uMztEfCYU7JK9lKwHtOPFJRj3Xp1me/RcgFMKY2pzWKCrTR6Gu8f/rKkMKcRiEn3KfP73JwaT/pzK+0DwSuYTb4iQUDeFIyhJnmpxaQ8ZgeTAW3B5SC3rGtTR4VDZLN/hy0LUsGhRdowUD4zVfi0eWc077jZZGrJYFi2tA2zFUvaB2pF7FQN16XKrI5HFwg29Q59xP9c8GHs1dR69/KHIMv7B7ZTzCPQKvX2xb1h7nuLH1dQu1TIOpol7L4Jpy4etb1jvFs6Wf7bYa7HrhEqoQeqIJVcHO5NeWh8xjy9W5KPk4K7f3AOWuFF5tusiTSOUfmQnvRWHDnD146m4mq6o/BU2WHb86B5FkA6t3SD8m2BXx6fszX0q4WUr+gOa4nQGM6fAHv3jFgdgipR4FbAIpi3ytPC5ryezGjOs+w5g2oRXpwlin3Nc1x7bHyqG1N1HId6+KJZvQk/3U520rtSyA1ax9ztARwsSw4biWFugv30BHDDNrv62hzlav+4Qa0gCGW5LzCMCgAmB36UBgZ6om7vDJvm/EGFzdu/D2rxP1CEgIPL3CZ59M9DhSLJ8fN7Qv7NBWQCXvytzK26AgUW8sIcLZRYB/D+dOn2l83p1naPtUfn/Hw34XvymvM0Lhzb/I9DtYK5zTEIeCh2nMNNoh0eSrj6czS+gvs/bqiEkIzIAr2wVNQQXUMmbS+lApFvsiHUYVtPyMsxodjRZkN9LxOH+MUJ5eswHuuIODmEukXyWVcOG7nHcp/LiIN1Lnn/0uf7PHA5PQ74YrYDDzN1OzaLe8Xn/0HBvQJdJVMhRNZJz27y7ISEbofA3w3th6NRp1EnaqoXYC5suPObR9puBLX5J5vNxIVZUJYNrVhIDNhHVyEvD1IxkFtYoaEw3Eyntlys8MrvBQTEORRJiydDTe7a0H1OCXrwNTReIv/y3dXT/EzyCeiCpjgtmVvHRMzEduJidA9Ljws4rTI+CSThyOJZ1JdvF7G6xvt4EY5iMEc2WelRK+xsUByokgWFOArrj4raEND2VYVFPOWyCVcL4qWotwUt3KCnkx594xHQgRNxMesO9Jg6RLqKWZGD+SSS+335lIEcHmHzIiffr1623R7LFxOfXP/9G4fjqeiVfTs+Iy54EaFuz27ecm7bfLyagu9B5ejhM/0H4CUaaX9cvWZVxO/eaOjELGsxtQmmK3yb2CRGTbjOk6BYdfrefDRASo7jSshdTJPnHs8jzPFvo7UGRfqZnES71Gm9tsOSa3jMRPQPKlOx15D9KiQR3/uvdLc040+xuG2HiBvqrXnx1vSVMCR0z5NsAl60RfOJVL0Y7JoWs06lWTYpbk/eVT0Rr4UM7QRCsupsizHpbRu0dLPAmJEbpfef4aYTNSzqmw6+De6ObTkRvQ5zUUGJ2ZR/lXYS28sP4RYlWyVTn/nojI52m3GbI85668X3yiMCH9mgmsotx1ZtyIWP01H2yfpuANSZ3mjhsHJwOF4CM3OkIvO+YbbKvQ/2w+EhpxYzrpUheBJ2ez6+QuuTxX5zPhjogXXdsRkcXd18A62lUYV9xbzO8cKk9QF69jP2MtdOOTmnuaD3evB82BRXJVeB/+XVezO3hRc1GJHku662mmGRDlMspbRImWB7bZ6Oi3IL5B8//0VIwAPuFdhH+yvr3Wc5juKc9lyPrrdZCyLG7ghVAGlGFa3PNA+gc4a3rDt3Is9/vpa7tcPnomyZyudjEoiqgcKtUu643hoxNnDSX/Yy5sKaJqY0TDONJkAsABz5ITvs3Uy3s6udvS7K80V1ko4agaCAAABUmxeM9A8afB2amNRVtqpfJin1x3xQotkHOQpWSjtcvWowUzy6uz91voHkRkvykF4459UjIcCQQzhqffLZgx21xw6ZbNpukQ4Wd932o5KyX4YeljLaKqMeDhPpS9wmlQbr43uw48clAilrdITXgYum99EaW+Cq1Ut9US+eYpULEks5izgwDWoiMGFUQ1Q59jffvUfJJc037fpCfOh0esXaiIVZh1tULZpzUuxfyhcyaMDMLqdWzcSyArmo6UHS83bnrpboiN75YmYLnh6HmdehUAUjIEHJZBk1Oh+ujn393N6yMnVFE5IsvH1G8aKDfNWIBjD4NWr2EEtZZ8Y1OspRuvFjajbU/K/xDgrYp1x3hwaJOvUzfL3H91U1CPfv1pX/S3Qfv/LsuQFTHgPbOfHrqHX3c4LWxLyRbkPlTlAUnfMIWT54uXWflsrEoPtuRoUfx78/HNxM7bvHsldb6aJxCFI/J2ntOXzHhnA4MRyOR/sxPN36Wt1m7OodXUV73JuMiwmcKyjIzQHx8NiCXbCV3o8OS4lnaeDxbushFdJ/fSRV/pr8BCn8b1YYGqs4dnw+oYALOO4Z+daJ0nHYIeVDtqjA5Hf5R0uo5f8NDbpZjI8Y5d1tjm71y8zSwSqjafgizlopE3GflwSs4+Dop8TPG2+0N+H2Sv66ZcnGUpHNN/i4RdEUq/xmOY3IZAduO2QnbWMPZW/zXbhzo30LX3a//h0sqQxNy+gzaYtYgp1a1OENA5Y0mGmOm8+NYC5lQOOzbSZ0TzBZOaT+8djs7zttdy+XuKkkVerle4IueUK4BK3hLIBGrF/HErsMdZ57z15kGUGb3gHrAocELhvtQMjwal2Q2w44YYgZFf1A8u7nIif5/Y1UGlCQwr5rL370mY9AgHiCzSNKmuIRjxUErfn+Pan7N7//HYGaJQ7l1wPc4UvqpUcf6MePfEUgCHcWEqPZP1i15SSawy4q9h65sqDXxHCtDAFNQyL4ZUn7jogq1fCThPf0WCbcNG1qLbgB03UHbhv9wALr20Px/YAnqkK0twoZ+xoAAAAAAVYDBejgkna9S57poZZ0yluF3SCLdP1FWKH/W4O6ti7J9KBoHWq2a/nDs8pasNDacUcM+iKeYZKm4wfX3Zvche9bNyXFsN0KSe3yyP/2C7H6dtQau1DBWwxtVkTPlcCclpNsjC2fWNMYc2yP3thfzGRfex3LUGBNEu1b5a8SB4xOdb2XC54dPshirGYaW9sgIHv0/vRkoBq0EhgU+Xl5E0EGrJx63xmJ0S8+pQpuSsyr3ooPJICyDZkSwgPIBWATNfgzcFmZCguVNIOT+XNDtl1ChND4z+V3GzuyfLamA0sSVCoWfspPygAdM9Lxjn9J0RCVPJvf22+jvLM5G/UzEjVgOjuJB92SekqVDKyxtiBIQ+YsBUoC4gw098ETtM5qe9JuSWO/69hkEYZCl3I0bJYLc0iXiAAAAA==",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后我们安装连接 redis 的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save redis\n"})}),"\n",(0,i.jsx)(n.p,{children:"创建个 redis 模块和 service："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g module redis\nnest g service redis\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:H,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"在 RedisModule 创建连接 redis 的 provider，导出 RedisService："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { createClient } from 'redis';\nimport { RedisService } from './redis.service';\n\n@Module({\n  providers: [\n    RedisService,\n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后在 RedisService 里注入 REDIS_CLIENT，并封装一些操作 redis 的方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType;\n\n    async geoAdd(key: string, posName: string, posLoc: [number, number]) {\n        return await this.redisClient.geoAdd(key, {\n            longitude: posLoc[0],\n            latitude: posLoc[1],\n            member: posName\n        })\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们先添加了一个 geoAdd 的方法，传入 key 和位置信息，底层调用 redis 的 geoadd 来添加数据。"}),"\n",(0,i.jsx)(n.p,{children:"在 AppController 里注入 RedisService，然后添加一个路由："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:J,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"添加 addPos 的 get 请求的路由，传入 name、longitude、latitude，调用 redisService添加位置信息。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { BadRequestException, Controller, Get, Inject, Query } from '@nestjs/common';\nimport { AppService } from './app.service';\nimport { RedisService } from './redis/redis.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Inject(RedisService)\n  private redisService: RedisService;\n\n  @Get('addPos')\n  async addPos(\n    @Query('name') posName: string,\n    @Query('longitude') longitude: number,\n    @Query('latitude') latitude: number\n  ) {\n    if(!posName || !longitude || !latitude) {\n      throw new BadRequestException('位置信息不全');\n    }\n    try {\n      await this.redisService.geoAdd('positions', posName, [longitude, latitude]);\n    } catch(e) {\n      throw new BadRequestException(e.message);\n    }\n    return {\n      message: '添加成功',\n      statusCode: 200\n    }\n  }\n\n  @Get()\n  getHello(): string {\n    return this.appService.getHello();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=guang"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=guang&longitude=15&latitude=35"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:L,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=dong&longitude=15&latitude=85"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后去 RedisInsight 里看下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:z,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"点击刷新，可以看到确实有了 positions 的数据。"}),"\n",(0,i.jsx)(n.p,{children:"然后我们再添加个查询位置列表的接口："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:M,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async geoPos(key: string, posName: string) {\n    const res = await this.redisClient.geoPos(key, posName);\n\n    return {\n        name: posName,\n        longitude: res[0].longitude,\n        latitude: res[0].latitude\n    }\n}\n\nasync geoList(key: string) {\n    const positions = await this.redisClient.zRange(key, 0, -1);\n\n    const list = [];\n    for(let i = 0; i < positions.length; i++) {\n        const pos = positions[i];\n        const res = await this.geoPos(key, pos);\n        list.push(res);\n    }\n    return list;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"因为 geo 信息底层使用 zset 存储的，所以查询所有的 key 使用 zrange。"}),"\n",(0,i.jsx)(n.p,{children:"zset 是有序列表，列表项会有一个分数，zrange 是返回某个分数段的 key，传入 0、-1 就是返回所有的。"}),"\n",(0,i.jsx)(n.p,{children:"然后再用 geoPos 拿到它对应的位置信息。"}),"\n",(0,i.jsx)(n.p,{children:"我们先在 RedisInsight 测试下这两个命令："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,i.jsx)(n.p,{children:"在 AppController 添加两个路由："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('allPos')\nasync allPos() {\n    return this.redisService.geoList('positions');\n}\n\n@Get('pos')\nasync pos(@Query('name') name: string) {\n    return this.redisService.geoPos('positions', name);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"访问下试试："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"最后，还要提供一个搜索附近的点的接口："}),"\n",(0,i.jsx)(n.p,{children:"在 RedisService 添加 geoSearch 方法，传入 key，经纬度、搜索半径，返回附近的点："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这里单位用的 km。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async geoSearch(key: string, pos: [number, number], radius: number) {\n    const positions = await this.redisClient.geoRadius(key, {\n        longitude: pos[0],\n        latitude: pos[1]\n    }, radius, 'km');\n\n    const list = [];\n    for(let i = 0; i < positions.length; i++) {\n        const pos = positions[i];\n        const res = await this.geoPos(key, pos);\n        list.push(res);\n    }\n    return list;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"先用 geoRadius 搜索半径内的点，然后再用 geoPos 拿到点的经纬度返回。"}),"\n",(0,i.jsx)(n.p,{children:"在 AppController 添加 nearbySearch 接口："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get('nearbySearch')\nasync nearbySearch(\n    @Query('longitude') longitude: number,\n    @Query('latitude') latitude: number,\n    @Query('radius') radius: number\n) {\n    if(!longitude || !latitude) {\n      throw new BadRequestException('缺少位置信息');\n    }\n    if(!radius) {\n      throw new BadRequestException('缺少搜索半径');\n    }\n\n    return this.redisService.geoSearch('positions', [longitude, latitude], radius);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"首先我们在 RedisInsight 里算下两点的距离："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"大概 5561 km"}),"\n",(0,i.jsx)(n.p,{children:"在 guang 附近搜索半径 5000km 内的位置："}),"\n",(0,i.jsx)(n.p,{children:"/nearbySearch?longitude=15&latitude=35&radius=5000"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"找到了一个点。"}),"\n",(0,i.jsx)(n.p,{children:"然后搜索半径 6000km 内的位置："}),"\n",(0,i.jsx)(n.p,{children:"/nearbySearch?longitude=15&latitude=35&radius=6000"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"不过现在的经纬度我们是随便给的。"}),"\n",(0,i.jsx)(n.p,{children:"可以用高德地图的坐标拾取工具来取几个位置："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"天安门： 116.397444,39.909183"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"文化宫科技馆：116.3993,39.908578"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"售票处：116.397283,39.90943"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"故宫彩扩部：116.398002,39.909175"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"把这样 4 个位置添加到系统中："}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=天安门&longitude=116.397444&latitude=39.909183"}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=文化宫科技馆&longitude=116.3993&latitude=39.908578"}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=售票处&longitude=116.397283&latitude=39.90943"}),"\n",(0,i.jsx)(n.p,{children:"/addPos?name=故宫彩扩部&longitude=116.398002&latitude=39.909175"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"先计算下天安门到故宫彩扩部的距离："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GEODIST positions 天安门 故宫彩扩部 km\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"是 0.0476km"}),"\n",(0,i.jsx)(n.p,{children:"那么我们在天安门的位置搜索 0.04km 内的点，应该搜不到它。"}),"\n",(0,i.jsx)(n.p,{children:"搜索 0.05 km 的点的时候，才能搜到。"}),"\n",(0,i.jsx)(n.p,{children:"试一下："}),"\n",(0,i.jsx)(n.p,{children:"/nearbySearch?longitude=116.397444&latitude=39.909183&radius=0.04"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"/nearbySearch?longitude=116.397444&latitude=39.909183&radius=0.05"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"没啥问题，这样我们搜索附近的充电宝的后端功能就完成了。"}),"\n",(0,i.jsx)(n.p,{children:"然后写下前端页面。"}),"\n",(0,i.jsx)(n.p,{children:"在 main.ts 指定 public 目录为静态文件的目录："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { NestExpressApplication } from '@nestjs/platform-express';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestExpressApplication>(AppModule);\n\n  app.useStaticAssets('public');\n\n  await app.listen(3000);\n}\nbootstrap();\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后创建 public/index.html"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    光光光\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(n.p,{children:"访问下看看："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"接下来要接入高德地图。"}),"\n",(0,i.jsxs)(n.p,{children:["先按照",(0,i.jsx)(n.a,{href:"https://lbs.amap.com/api/javascript-api-v2/getting-started",target:"_blank",rel:"noopener noreferrer",children:"文档"}),"的步骤获取 key"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这个很简单，填一下信息就好。"}),"\n",(0,i.jsxs)(n.p,{children:["点击",(0,i.jsx)(n.a,{href:"https://console.amap.com/dev/key/app",target:"_blank",rel:"noopener noreferrer",children:"创建新应用"}),"，选择 web 应用，就可以生成 key 了"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["然后把文档的 ",(0,i.jsx)(n.a,{href:"https://lbs.amap.com/demo/javascript-api-v2/example/map-componets/map-overlays",target:"_blank",rel:"noopener noreferrer",children:"demo 代码"}),"复制过来："]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"改成这样："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<!doctype html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">\n    <title>附近的充电宝</title>\n  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />\n    <script src="https://cache.amap.com/lbs/static/es5.min.js"><\/script>\n    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"><\/script>\n    <style>\n        html,\n        body,\n        #container {\n          width: 100%;\n          height: 100%;\n        }\n    </style>\n</head>\n<body>\n<div id="container"></div>\n<script src="https://webapi.amap.com/maps?v=2.0&key=f96fa52474cedb7477302d4163b3aa09"><\/script>\n<script>\nvar map = new AMap.Map(\'container\', {\n    resizeEnable: true,\n    zoom: 6,\n    center: [116.397444, 39.909183]\n});\n\nvar marker = new AMap.Marker({\n    icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",\n    position: [116.399327,39.908562],\n    anchor:\'bottom-center\'\n});\n\nvar circle = new AMap.Circle({\n    center: new AMap.LngLat(116.397444, 39.909183), // 圆心位置\n    radius: 50,\n    strokeColor: "#F33",  //线颜色\n    strokeOpacity: 1,  //线透明度\n    strokeWeight: 3,  //线粗细度\n    fillColor: "#ee2200",  //填充颜色\n    fillOpacity: 0.35 //填充透明度\n});\n\nmap.add(marker);\nmap.add(circle);\n\nmap.setFitView();\n\n<\/script>\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(n.p,{children:"在天安门画了一个 circle，然后在文化宫科技馆画了一个 marker："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"接下来引入 axios，来调用服务端接口："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<!doctype html>\n<html>\n<head>\n    <meta charset="utf-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">\n    <title>附近的充电宝</title>\n  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />\n    <script src="https://cache.amap.com/lbs/static/es5.min.js"><\/script>\n    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"><\/script>\n    <style>\n        html,\n        body,\n        #container {\n          width: 100%;\n          height: 100%;\n        }\n        \n        label {\n            width: 55px;\n            height: 26px;\n            line-height: 26px;\n            margin-bottom: 0;\n        }\n        button.btn {\n            width: 80px;\n        }\n    </style>\n</head>\n<body>\n<div id="container"></div>\n<script src="https://webapi.amap.com/maps?v=2.0&key=f96fa52474cedb7477302d4163b3aa09"><\/script>\n<script src="https://unpkg.com/axios@1.5.1/dist/axios.min.js"><\/script>\n<script>\n\n    const radius = 0.2;\n\n    axios.get(\'/nearbySearch\', {\n        params: {\n            longitude: 116.397444,\n            latitude: 39.909183,\n            radius\n        }\n    }).then(res => {\n        const data = res.data;\n\n        var map = new AMap.Map(\'container\', {\n            resizeEnable: true,\n            zoom: 6,\n            center: [116.397444, 39.909183]\n        });\n\n        data.forEach(item => {\n            var marker = new AMap.Marker({\n                icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",\n                position: [item.longitude, item.latitude],\n                anchor: \'bottom-center\'\n            });\n            map.add(marker);\n        });\n\n\n        var circle = new AMap.Circle({\n            center: new AMap.LngLat(116.397444, 39.909183), // 圆心位置\n            radius: radius * 1000,\n            strokeColor: "#F33",  //线颜色\n            strokeOpacity: 1,  //线透明度\n            strokeWeight: 3,  //线粗细度\n            fillColor: "#ee2200",  //填充颜色\n            fillOpacity: 0.35 //填充透明度\n        });\n\n        map.add(circle);\n        map.setFitView();\n    })\n        \n<\/script>\n</body>\n</html>\n'})}),"\n",(0,i.jsx)(n.p,{children:"效果是这样的："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:c,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后把 radius 改成 0.05，是这样的："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:r,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样就实现了查找附近的充电宝的功能。"}),"\n",(0,i.jsxs)(n.p,{children:["代码上传了",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nearby-search",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"我们经常会使用基于位置的功能，比如附近的充电宝、酒店，打车，附近的人等功能。"}),"\n",(0,i.jsx)(n.p,{children:"这些都是基于 redis 实现的，因为 redis 有 geo 的数据结构，可以方便的计算两点的距离，计算某个半径内的点。"}),"\n",(0,i.jsx)(n.p,{children:"前端部分使用地图的 sdk 分别在搜出的点处绘制 marker 就好了。"}),"\n",(0,i.jsx)(n.p,{children:"geo 的底层数据结构是 zset，所以可以使用 zset 的命令。"}),"\n",(0,i.jsx)(n.p,{children:"我们在 Nest 里封装了 geoadd、geopos、zrange、georadius 等 redis 命令。实现了添加点，搜索附近的点的功能。"}),"\n",(0,i.jsx)(n.p,{children:"以后再用这类附近的 xxx 功能，你是否会想起 redis 呢？"})]})}function $(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(_,{...e})}):_(e)}let ee=$;$.__RSPRESS_PAGE_META={},$.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F82.%20Redis%20%2B%20%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%EF%BC%8C%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E7%9A%84%E5%85%85%E7%94%B5%E5%AE%9D.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"82. Redis + 高德地图，实现附近的充电宝",headingTitle:"82. Redis + 高德地图，实现附近的充电宝",frontmatter:{}}}}]);