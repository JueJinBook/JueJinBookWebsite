"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["19960"],{704174:function(e,n,s){e.exports=s.p+"static/image/05fe13cd2d8464a8b668cd26d9b0840a.b5119a48.webp"},464189:function(e,n,s){s.r(n),s.d(n,{default:()=>ea});var i=s(552676),r=s(740453);let c=s.p+"static/image/9c8d9acdd4d0b1d4820139a0c1402515.07e562f8.webp",a=s.p+"static/image/f58e20ae8ba5e577d761abdaa97c5310.a30bfc93.webp",t=s.p+"static/image/f7e58b38007f658184819ec8b3a130aa.3b1c13ce.webp",d=s.p+"static/image/e8cb5c16210574812a3261e0652af716.9cb2c9d7.webp",l=s.p+"static/image/64e02cd61d696deba2da385e47e3fbc3.5f6095ae.gif",p=s.p+"static/image/82662a39aed836297eb254e8f5e50c54.6a42be43.webp",h=s.p+"static/image/7d126145e7a6cd2845211547454a3f86.c009b8a6.webp",j=s.p+"static/image/90a96bc67ed2e5ac3017540ab5172268.8e5ab23f.webp",o=s.p+"static/image/6c2c950f0cc0668060ffd3b6fb4738ec.571cbf93.webp",x=s.p+"static/image/37e69e7bb967f3badbf71c11b264eb3f.d34da4b5.webp",m=s.p+"static/image/a8dc06b96bf93edf392032b774f8895d.3a7d3fa9.webp",g=s.p+"static/image/7146a60a10f81d3fd44b82e5a733e092.e9cb63dc.gif",b=s.p+"static/image/1bd8599dee50fc244b213a4f785d17e4.f8453f52.webp",u=s.p+"static/image/49fc13127cb07e2baa7758a336163ed8.b34baacb.webp",f=s.p+"static/image/c802afffce83bc8f4a283877965def63.011be4f2.webp",v=s.p+"static/image/ba429bc9ee404791dde6c6147d764387.6b885eb4.webp",w=s.p+"static/image/3b70c76f8084ef1d4b9fcb600e3003dc.855d8bdd.webp",y=s.p+"static/image/9aadc31ab4a7ff3379be15b96708d2c2.84f0e52a.webp",C=s.p+"static/image/6f0dbba9a4ea0097fb57cf6d579b6d7b.95b5f1b8.webp",A=s.p+"static/image/9c29e628e9472dbed5131409e2927d35.f81a0727.webp",E=s.p+"static/image/904925ba13231dc126a321dec4f55567.a18eb3cd.webp",S=s.p+"static/image/4b10865e8f5ac8545ce6ff0d0f7f438b.02927647.webp",T=s.p+"static/image/47be414ac19bdaa4d04b860a9cfbf82c.5c0c3545.webp",k=s.p+"static/image/3c5a074bb8e6729dfdba3c40fe3b32ad.78006186.gif",I=s.p+"static/image/6bc1c747b59728cafeea71e49f092885.78396cd9.webp",P=s.p+"static/image/76ace1f96511eef4ad4427a0755c2535.d869bef4.webp",R=s.p+"static/image/a78b45bcd227c7c69c78b19aeef4befb.bd11e0f3.webp",M=s.p+"static/image/af75c30d95a784a323c83c6de2a5534d.2b985b3f.webp",G=s.p+"static/image/dc6dc5e48aa74b2e58d300a3747418c6.91464bee.webp",N=s.p+"static/image/332154aefc09df76b795f9379750e550.6d23dee0.webp",B=s.p+"static/image/2d36bb21b18975eccd71530a24fa2203.7724654c.webp";var D=s(704174);let L=s.p+"static/image/5415083047d963d43b790cb00d1c0878.452eabb7.webp",Y=s.p+"static/image/3a81d81252aa8c282e9ac680e6fe9545.79de84a6.webp",F=s.p+"static/image/cbe5b756cd74e3409594d092156befff.c11a4372.gif",U=s.p+"static/image/95e80a4babe277574680f287b0723355.43074418.webp",X=s.p+"static/image/7e38f9bde7769cd69ea5562755ba78f8.55b52fc4.webp",O=s.p+"static/image/30aa69d9da7d85d7f772a0b91325daf1.bafd2cb0.webp",K=s.p+"static/image/64d17df8a9a937e795bb5540e8e88135.f0ee9a1c.webp",z=s.p+"static/image/261e4ae875ab9ce826b5f42f6cc5ecc5.3a9eea48.webp",V=s.p+"static/image/857cfe160460ec2e37a696d5a13957bc.62000215.webp",q=s.p+"static/image/b0023b02aa8369f2a1dd53ec4efea7e8.3b845535.webp",J=s.p+"static/image/12c3cce2893d97173fda5b6fa1e24f79.eea57304.webp",Q=s.p+"static/image/1d3ee01f08642bfd0ab9a55f7433c75e.e28d4698.webp",H=s.p+"static/image/b087e8eea6530ba29fda04a55f2d9aa4.b8f0b1c7.webp",W=s.p+"static/image/e26fb6bccc7e81f7761c1b50bdae9668.5f2d5bcf.webp",Z=s.p+"static/image/d536d1a915fd11d1d4fb812093c90433.833e96e8.webp",_=s.p+"static/image/26a831a5fbb9cab61303d51eed9beece.9ccb77cf.webp",$=s.p+"static/image/b896357b4343d6c784749a078808bcaa.192f4b71.webp",ee=s.p+"static/image/3bb3af1b00bc4f251d8d0b623873e367.2a2ff5d5.webp",en=s.p+"static/image/890ce6b8c86291de9bef8bbd40ccb8f2.5d12fb50.webp",es=s.p+"static/image/694d7739dbc6365f0c5971a2f6e9267a.51c7479c.webp",ei=s.p+"static/image/0af49b5100ce4d219ed493d2916cf8ee.a6155183.webp";function er(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",ul:"ul",li:"li",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"91-定时任务--redis-实现阅读量计数",children:["91. 定时任务 + Redis 实现阅读量计数",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#91-定时任务--redis-实现阅读量计数",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"文章都会有个阅读量，那这个阅读量是怎么计数的呢？"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ei,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"有同学说，很简单啊，这不就是文章表里加个 views 的字段，然后每次刷新页面都加一么？"}),"\n",(0,i.jsx)(n.p,{children:"这样是可以，但有两个问题："}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"每次刷新阅读量都加一，其实还是同一个人看的这篇文章，这样统计出来的阅读量是不准的，我们想要的阅读量是有多少人看过这篇文章"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"阅读是个很高频的操作，直接存到数据库，数据库压力会太大"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"这两个问题分别都怎么解决呢？"}),"\n",(0,i.jsx)(n.p,{children:"其实我们学完 Redis 就应该能想到解决方案了："}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"在 redis 中存储 user 和 article 的关系，比如 user_111_article_222 为 key，10 分钟后删除，如果存在这个 key，就说明该用户看过这篇文章，就不更新阅读量，否则才更新"}),"\n",(0,i.jsx)(n.p,{children:"10 分钟后，这个人再看这篇文章，就可以算是新的一次阅读量了。"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"访问文章时把阅读量加载到 redis，之后的阅读量计数只更新 redis，不更新数据库，等业务低峰期再把最新的阅读量写入数据库"}),"\n",(0,i.jsx)(n.p,{children:"这里在业务低峰期，比如凌晨 4 点的时候写入数据库，可以用定时任务来做。"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"思路理清了，我们来实现一下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest new article-views -p npm\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:es,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"创建个 nest 项目。"}),"\n",(0,i.jsx)(n.p,{children:"安装 typeorm 相关的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 AppModule 引入 TypeOrmModule："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\n\n@Module({\n  imports: [ \n    TypeOrmModule.forRoot({\n      type: \"mysql\",\n      host: \"localhost\",\n      port: 3306,\n      username: \"root\",\n      password: \"guang\",\n      database: \"article_views\",\n      synchronize: true,\n      logging: true,\n      entities: [],\n      poolSize: 10,\n      connectorPackage: 'mysql2',\n      extra: {\n          authPlugin: 'sha256_password',\n      }\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 mysql workbench 里创建这个 database"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"CREATE DATABASE article_views DEFAULT CHARACTER SET utf8mb4;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:en,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"刷新可以看到这个 database"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:ee,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后建个文章和用户的模块："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"nest g resource user --no-spec\nnest g resource article --no-spec\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:$,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"添加 user 和 article 的 entity"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Column, PrimaryGeneratedColumn, Entity } from \"typeorm\";\n\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        comment: '用户名'\n    })\n    username: string;\n\n    @Column({\n        comment: '密码'\n    })\n    password: string;\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Column, Entity, PrimaryGeneratedColumn } from \"typeorm\";\n\n@Entity()\nexport class Article {\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        comment: '文章名字',\n        length: 50\n    })\n    title: string;\n\n    @Column({\n        comment: '内容',\n        type: 'text'\n    })\n    content: string;\n\n    @Column({\n        comment: '阅读量',\n        default: 0\n    })\n    viewCount: number;\n\n    @Column({\n        comment: '点赞量',\n        default: 0\n    })\n    likeCount: number;\n\n    @Column({\n        comment: '收藏量',\n        default: 0\n    })\n    collectCount: number;\n}\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 entities 引入："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:_,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到 typeorm 自动创建了这两个表："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Z,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后插入一些数据："}),"\n",(0,i.jsx)(n.p,{children:"在 AppController 创建 init-data 的路由，然后注入 EntityManager："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\n  private entityManager: EntityManager;\n\n  @Get('init-data')\n  async initData() {\n    await this.entityManager.save(User, {\n      username: 'dong',\n      password: '111111'\n    });\n    await this.entityManager.save(User, {\n      username: 'guang',\n      password: '222222'\n    });\n\n    await this.entityManager.save(Article, {\n      title: '基于 Axios 封装一个完美的双 token 无感刷新',\n      content: `用户登录之后，会返回一个用户的标识，之后带上这个标识请求别的接口，就能识别出该用户。\n\n      标识登录状态的方案有两种： session 和 jwt。\n      `\n    });\n\n    await this.entityManager.save(Article, {\n      title: 'Three.js 手写跳一跳小游戏',\n      content: `前几年，跳一跳小游戏火过一段时间。\n\n      玩家从一个方块跳到下一个方块，如果没跳过去就算失败，跳过去了就会再出现下一个方块。`\n    });\n    return 'done';\n  }\n"})}),"\n",(0,i.jsx)(n.p,{children:"两个 entity 分别插入 2 条数据。"}),"\n",(0,i.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到 4 条 insert 语句："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:H,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"在 mysql workbench 里也可以看到两个表都插入了数据："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:J,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后先实现登录："}),"\n",(0,i.jsx)(n.p,{children:"这次用 session 的方案："}),"\n",(0,i.jsx)(n.p,{children:"安装相关的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install express-session @types/express-session\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 main.ts 里启用："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport * as session from 'express-session';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n\n  app.use(session({\n    secret: 'guang',\n    resave: false,\n    saveUninitialized: false\n  }));\n\n  await app.listen(3000);\n}\nbootstrap();\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后实现下登录："}),"\n",(0,i.jsx)(n.p,{children:"在 UserController 添加 login 的路由："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync login(@Body() loginUserDto: LoginUserDto) {\n    console.log(loginUserDto);\n    return 'success';\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"新建 src/user/dto/login-user.dto.ts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"export class LoginUserDto {\n    username: string;\n\n    password: string;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:V,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:z,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在 UserService 实现登录逻辑："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\nprivate entityManager: EntityManager;\n\nasync login(loginUser: LoginUserDto) {\n    const user = await this.entityManager.findOne(User, {\n      where: {\n        username: loginUser.username\n      }\n    });\n\n    if(!user) {\n      throw new BadRequestException('用户不存在');\n    }\n\n    if(user.password !== loginUser.password) {\n      throw new BadRequestException('密码错误');\n    }\n\n    return user;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 UserController 调用下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync login(@Body() loginUserDto: LoginUserDto, @Session() session) {\n    const user = await this.userService.login(loginUserDto);\n\n    session.user = {\n        id: user.id,\n        username: user.username\n    }\n\n    return 'success';\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"调用 userService 的 login 方法，实现登录验证，然后把用户信息存入 session。"}),"\n",(0,i.jsx)(n.p,{children:"当用户不存在时："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:K,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"当密码错误时："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:O,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"登录成功时："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:X,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在 ArticleController 添加一个查询文章的接口："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get(':id')\nasync findOne(@Param('id') id: string) {\n    return await this.articleService.findOne(+id);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"实现 articleService.findOne 方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\nprivate entityManager: EntityManager;\n\nasync findOne(id: number) {\n    return await this.entityManager.findOneBy(Article, {\n      id\n    });\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后我们在 ArticleController 加一个阅读的接口："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get(':id/view')\nasync view(@Param('id') id: string) {\n    return await this.articleService.view(+id);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后在 ArticleService 里实现具体的逻辑："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async view(id: number) {\n    const article = await this.findOne(id);\n\n    article.viewCount ++;\n\n    await this.entityManager.save(article);\n\n    return article.viewCount;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"数据库里阅读量确实更新了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:Y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"再次查询出来的就是新的阅读量："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:L,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样是能实现功能，但有前面我们讲到的两个问题："}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"每次刷新阅读量都加一，其实还是同一个人看的这篇文章，这样统计出来的阅读量是不准的，我们想要的阅读量是有多少人看过这篇文章"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"阅读是个很高频的操作，直接存到数据库，数据库压力会太大"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"所以，我们要引入 redis。"}),"\n",(0,i.jsx)(n.p,{children:"安装 redis 的包："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save redis\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后创建个 redis 模块："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g module redis\nnest g service redis\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:D,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"在 RedisModule 创建连接 redis 的 provider，导出 RedisService，并把这个模块标记为 @Global 模块"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Global, Module } from '@nestjs/common';\nimport { createClient } from 'redis';\nimport { RedisService } from './redis.service';\n\n@Global()\n@Module({\n  providers: [\n    RedisService,\n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后在 RedisService 里注入 REDIS_CLIENT，并封装一些方法："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType;\n\n    async get(key: string) {\n        return await this.redisClient.get(key);\n    }\n\n    async set(key: string, value: string | number, ttl?: number) {\n        await this.redisClient.set(key, value);\n\n        if(ttl) {\n            await this.redisClient.expire(key, ttl);\n        }\n    }\n\n    async hashGet(key: string) {\n        return await this.redisClient.hGetAll(key);\n    }\n\n    async hashSet(key: string, obj: Record<string, any>, ttl?: number) {\n        for(let name in obj) {\n            await this.redisClient.hSet(key, name, obj[name]);\n        }\n\n        if(ttl) {\n            await this.redisClient.expire(key, ttl);\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们封装了 get、set、hashGet、hashSet 方法，分别是对 redis 的 string、hash 数据结构的读取。"}),"\n",(0,i.jsx)(n.p,{children:"然后在 view 方法里引入 redis："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Inject(RedisService)\nprivate redisService: RedisService;\n\nasync view(id: number) {\n    const res = await this.redisService.hashGet(`article_${id}`);\n\n    if(res.viewCount === undefined) {\n      const article = await this.findOne(id);\n\n      article.viewCount ++;\n\n      await this.entityManager.save(article);\n\n      await this.redisService.hashSet(`article_${id}`, {\n        viewCount: article.viewCount,\n        likeCount: article.likeCount,\n        collectCount: article.collectCount\n      });\n\n      return article.viewCount;\n\n    } else {\n      await this.redisService.hashSet(`article_${id}`, {\n        ...res,\n        viewCount: +res.viewCount + 1\n      });\n      return +res.viewCount + 1;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"先查询 redis，如果没查到就从数据库里查出来返回，并存到 redis 里。"}),"\n",(0,i.jsx)(n.p,{children:"查到了就更新 redis 的 viewCount，直接返回 viewCount + 1"}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"服务端打印了 3 条 sql："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"redis 里也有了这个 hash 的结构："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"为什么是 3 条呢？"}),"\n",(0,i.jsx)(n.p,{children:"因为 findOne 发一条 select，save 会先发一条 select，再发一条 update。"}),"\n",(0,i.jsx)(n.p,{children:"我们可以优化一下，把 save 换成 update："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:M,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"await this.entityManager.update(Article, {  id }, {\n    viewCount: article.viewCount\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后把 redis 那条数据删掉："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"重新跑一下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"现在就只有一条 select、一条 update 了。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后多刷新几次："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"没发送 sql，还是之前那两条："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"因为这时候查的是 redis。"}),"\n",(0,i.jsx)(n.p,{children:"redis 里数据更新了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"但是数据库里的 viewCount 还是 8"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样一重启 redis 数据就没了。"}),"\n",(0,i.jsx)(n.p,{children:"所以还要同步到数据库。"}),"\n",(0,i.jsx)(n.p,{children:"同步倒是不用很频繁，可以放在凌晨 4 点，访问量少的时候通过定时任务同步数据库。"}),"\n",(0,i.jsx)(n.p,{children:"我们需要引入定时任务包 @nestjs/schedule"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install --save @nestjs/schedule\n"})}),"\n",(0,i.jsx)(n.p,{children:"在 AppModule 引入下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后创建一个 service："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nest g module task\nnest g service task\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"定义个方法，通过 @Cron 声明每 10s 执行一次："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Injectable, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\n\n@Injectable()\nexport class TasksService {\n\n  @Cron(CronExpression.EVERY_10_SECONDS)\n  handleCron() {\n    console.log('task execute')\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后就可以看到控制台会每 10s 打印一次"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们在 TaskModule 引入 ArticleModule："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { TaskService } from './task.service';\nimport { ArticleModule } from 'src/article/article.module';\n\n@Module({\n  imports: [\n    ArticleModule\n  ],\n  providers: [TaskService]\n})\nexport class TaskModule {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"并且在 ArticleModule 导出 ArticleService"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在 TaskService 里注入 articleService"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\nimport { ArticleService } from 'src/article/article.service';\n\n@Injectable()\nexport class TaskService {\n\n  @Inject(ArticleService)\n  private articleService: ArticleService;\n\n  @Cron(CronExpression.EVERY_MINUTE)\n  async handleCron() {\n    await this.articleService.flushRedisToDB();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"每分钟执行一次，调用 articleService 的 flushRedisToDB 方法。"}),"\n",(0,i.jsx)(n.p,{children:"然后我们实现这个方法："}),"\n",(0,i.jsx)(n.p,{children:"先在 RedisService 添加一个 keys 方法，用来查询 key："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async keys(pattern: string) {\n    return await this.redisClient.keys(pattern);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"然后在 ArticleService 里实现同步数据库的逻辑："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async flushRedisToDB() {\n    const keys = await this.redisService.keys(`article_*`);\n    console.log(keys);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"我们先打印下 keys。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"现在只有一个 key，我们再访问下另一篇文章"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"现在就有 2 个 key 了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们把所有的 key 对应的值存入数据库："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"async flushRedisToDB() {\n    const keys = await this.redisService.keys(`article_*`);\n\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i];\n\n      const res = await this.redisService.hashGet(key);\n\n      const [, id] = key.split('_');\n\n      await this.entityManager.update(Article, {\n        id: +id\n      }, {\n        viewCount: +res.viewCount,        \n      });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"查询出 key 对应的值，更新到数据库。"}),"\n",(0,i.jsx)(n.p,{children:"测试下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"刷新几次 view 接口，redis 里阅读量增加了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"但是数据库里没变："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"过了一会，控制台打印了 2 条 update 语句："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"数据库里的数据就更新了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"接下来只要把定时任务的执行时间改为 4 点就好了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Cron(CronExpression.EVERY_DAY_AT_4AM)\n"})}),"\n",(0,i.jsx)(n.p,{children:"这样，基于 redis 的阅读量缓存，以及定时任务更新数据库就完成了。"}),"\n",(0,i.jsx)(n.p,{children:"还有剩下的一个问题："}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"每次刷新阅读量都加一，其实还是同一个人看的这篇文章，这样统计出来的阅读量是不准的，我们想要的阅读量是有多少人看过这篇文章"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"我们可以在用户访问文章的时候在 redis 存一个 10 分钟过期的标记，有这个标记的时候阅读量不增加。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"await this.redisService.set(`user_${userId}_article_${id}`, 1, 3);\n"})}),"\n",(0,i.jsx)(n.p,{children:"为了测试方便，我们先设置 3s 过期。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const flag = this.redisService.get(`user_${userId}_article_${id}`);\n\nif(flag) {\n    return res.viewCount;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"这里需要传入 userId。"}),"\n",(0,i.jsx)(n.p,{children:"我们在 ArticleController 的 view 方法里传入下："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@Get(':id/view')\nasync view(@Param('id') id: string, @Session() session, @Req() req) {\n    return await this.articleService.view(+id, session?.user?.id || req.ip);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"试试看："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，现在就不是每次刷新都增加阅读量了，而是 3s 之后再刷新才增加。"}),"\n",(0,i.jsx)(n.p,{children:"在 redis 里可以看到这个 key："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"只不过现在没登录，用的是 ip，而本地访问的时候获取的 ip 就是 ::1 这样的，线上就能拿到具体的 ip 了。"}),"\n",(0,i.jsx)(n.p,{children:"然后我们登录下再访问："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这时用的就是用户 id 了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:c,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样就实现了真实的阅读量计数。"}),"\n",(0,i.jsxs)(n.p,{children:["案例代码上传了",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/article-views",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"我们通过 redis + 定时任务实现了阅读量计数的功能。"}),"\n",(0,i.jsx)(n.p,{children:"因为阅读是个高频操作，所以我们查出数据后存在 redis里，之后一直访问 redis 的数据，然后通过定时任务在凌晨 4 点把最新数据写入数据库。"}),"\n",(0,i.jsx)(n.p,{children:"并且为了统计真实的用户阅读量，我们在 redis 存储了用户看了哪篇文章的标识，10 分钟后过期。"}),"\n",(0,i.jsx)(n.p,{children:"这就是我们常见的阅读量功能的实现原理。"})]})}function ec(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(er,{...e})}):er(e)}let ea=ec;ec.__RSPRESS_PAGE_META={},ec.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F91.%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%20%2B%20Redis%20%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB%E9%87%8F%E8%AE%A1%E6%95%B0.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"91. 定时任务 + Redis 实现阅读量计数",headingTitle:"91. 定时任务 + Redis 实现阅读量计数",frontmatter:{}}}}]);