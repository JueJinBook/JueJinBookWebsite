"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["95369"],{500873:function(e,n,t){t.r(n),t.d(n,{default:()=>O});var a=t(552676),s=t(740453);let o=t.p+"static/image/79414b12240c39145f4436bb4d78fe20.cfee9d8a.gif",r=t.p+"static/image/a2df91509f23f7d1890eb831bc4d4bbe.a5572955.gif",i=t.p+"static/image/b52997a1c115e1ab41d44d6472d90632.444375db.gif",c=t.p+"static/image/a20f523c889c00ddcb264b38ade498c3.7c57b9eb.gif",d=t.p+"static/image/d63a549d4c6bedbb62e2b7b5d037fb40.4fd68184.webp",m=t.p+"static/image/01d00aa17fa47030ff736889f12df80e.e7fa780b.webp",l=t.p+"static/image/4ec4dede779e9c0892ff2d8869dea904.a95d9f60.webp",p=t.p+"static/image/fa90a86012862287b812b358648060a0.2d89556b.gif",g=t.p+"static/image/dc265d2a7c01212221b34d3481924c4a.c6d66c41.gif",u=t.p+"static/image/37226e0b3df98acb6bdd842f6f2dbf4b.939237cf.webp",f=t.p+"static/image/cda50ef53e494a6cd43ec78241ac57b6.7496f461.webp",h=t.p+"static/image/cb84e87cd3af15472723e8aea7b324c6.c280de58.webp",x=t.p+"static/image/3500a25b0cff60e4f68efdcee4088210.818c742b.webp",j=t.p+"static/image/359b30272aa0a42d9ea0879e3253b556.48ef811e.webp",y=t.p+"static/image/4091ada27143c09a7e369c14cb7dc6fd.30e8a4f9.webp",b=t.p+"static/image/0c2b05f8b2703ea6eba1aef76335dced.90f11d58.gif",I=t.p+"static/image/45b3c154ae1edcb13959feed266882ef.bf884448.webp",v=t.p+"static/image/a03d6bb91ad24742e23e0681c930711d.27796c7b.webp",C=t.p+"static/image/ce68d687503425051550c8c96fa075b5.5345d5f1.webp",k=t.p+"static/image/17dcad3a58a967213540af32ca0233dc.ccd889af.gif",U=t.p+"static/image/77a05263961396fd928044cf1e99abb9.be7dae70.webp",M=t.p+"static/image/78f62643671b2a764fdf0dbdb0ae4036.3ff678b6.webp",N=t.p+"static/image/f160ca8833b1e50959b5080594fcee18.d0382e91.webp",T=t.p+"static/image/8b1acb6d7b1e7a02b34cd4aaeedd5d88.ff387bb6.gif",A=t.p+"static/image/a944e1916538e9898113cf905cfc729b.8e0f1604.webp",E=t.p+"static/image/1b6c9a44084b6d021096fbc834de6937.49c49785.webp",S=t.p+"static/image/176347a50d1875e4624a768fc3e57a31.ea6a4425.gif",P=t.p+"static/image/5dee4dffbfd2293df6442e6b5ebd5b0c.133a8cba.webp";function H(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,s.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.h1,{id:"191-聊天室发送表情图片文件",children:["191. 聊天室：发送表情、图片、文件",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#191-聊天室发送表情图片文件",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"这节来实现下发送表情、图片、文件。"}),"\n",(0,a.jsx)(n.p,{children:"这种 emoji 表情："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,a.jsxs)(n.p,{children:["有现成的库 ",(0,a.jsx)(n.a,{href:"https://www.npmjs.com/package/emoji-mart",target:"_blank",rel:"noopener noreferrer",children:"emoji-mart"}),"："]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:P,alt:""})}),"\n",(0,a.jsxs)(n.p,{children:["可以试试他的 ",(0,a.jsx)(n.a,{href:"https://missiveapp.com/open/emoji-mart",target:"_blank",rel:"noopener noreferrer",children:"demo"}),"："]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:S,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"我们直接用就行："}),"\n",(0,a.jsx)(n.p,{children:"安装下："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm install --save @emoji-mart/data @emoji-mart/react\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:E,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:A,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:'<Popover content={<EmojiPicker data={data} onEmojiSelect={(emoji: any) => {\n    setInputText((inputText) => inputText + emoji.native)\n}} />} title="Title" trigger="click">\n    表情\n</Popover>\n'})}),"\n",(0,a.jsx)(n.p,{children:"这样，就可以发表情了："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:T,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:N,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后来实现发送图片："}),"\n",(0,a.jsx)(n.p,{children:"这个和之前的上传图片没啥大的区别。"}),"\n",(0,a.jsx)(n.p,{children:"加一个 Modal："}),"\n",(0,a.jsx)(n.p,{children:"src/pages/Chat/UploadImageModal.tsx"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Modal } from \"antd\";\nimport { ImageUpload } from \"./ImageUpload\";\nimport { useState } from \"react\";\n\ninterface UploadImageModalProps {\n    isOpen: boolean;\n    handleClose: (imageSrc?: string) => void\n}\n\nexport function UploadImageModal(props: UploadImageModalProps) {\n    const [imgSrc, setImgSrc] = useState<string>('');\n\n    return <Modal \n        title=\"上传图片\"\n        open={props.isOpen}\n        onOk={() => {\n            props.handleClose(imgSrc)\n            setImgSrc('')\n        }}\n        onCancel={() => props.handleClose()}\n        okText={'确认'}\n        cancelText={'取消'}    \n    >\n        <ImageUpload value={imgSrc} onChange={(value: string) => {\n            setImgSrc(value)\n        }}/>\n    </Modal>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Modal 里只包含上传组件，关闭弹窗的时候把 imgSrc 通过参数返回。"}),"\n",(0,a.jsx)(n.p,{children:"这个上传组件和之前的差不多："}),"\n",(0,a.jsx)(n.p,{children:"src/pages/Chat/ImageUpload.tsx"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:'import { InboxOutlined } from "@ant-design/icons";\nimport { message } from "antd";\nimport Dragger, { DraggerProps } from "antd/es/upload/Dragger";\nimport axios from "axios";\nimport { presignedUrl } from "../../interfaces";\n\ninterface ImageUploadProps {\n    value?: string;\n    onChange?: Function\n}\n\nlet onChange: Function;\n\nconst props: DraggerProps = {\n    name: \'file\',\n    action: async (file) => {\n        const res = await presignedUrl(file.name);\n        return res.data;\n    },\n    async customRequest(options) {\n        const { onSuccess, file, action } = options;\n\n        const res = await axios.put(action, file);\n\n        onSuccess!(res.data);\n    },\n    onChange(info) {\n        const { status } = info.file;\n        if (status === \'done\') {\n            onChange(\'http://localhost:9000/chat-room/\' + info.file.name);\n            message.success(`${info.file.name} 文件上传成功`);\n        } else if (status === \'error\') {\n            message.error(`${info.file.name} 文件上传失败`);\n        }\n    }\n};\n\nconst dragger = <Dragger {...props}>\n    <p className="ant-upload-drag-icon">\n        <InboxOutlined />\n    </p>\n    <p className="ant-upload-text">点击或拖拽文件到这个区域来上传</p>\n</Dragger>\n\nexport function ImageUpload(props: ImageUploadProps) {\n\n    onChange = props.onChange!\n\n    return props?.value ? <div>\n        <img src={props.value} alt="图片" width="100" height="100"/>\n        {dragger}\n    </div>: <div>\n        {dragger}\n    </div>\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"和之前上传头像的逻辑一样。"}),"\n",(0,a.jsx)(n.p,{children:"然后在 Chat 组件里用一下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:M,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:U,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const [isUploadImageModalOpen, setUploadImageModalOpen] = useState(false);\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"setUploadImageModalOpen(true);\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"<UploadImageModal isOpen={isUploadImageModalOpen} handleClose={(imgSrc) => {\n    setUploadImageModalOpen(false);\n    console.log(imgSrc);\n}} />\n"})}),"\n",(0,a.jsx)(n.p,{children:"测试下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:k,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"上传成功，点击确认按钮，在控制台打印了图片 url。"}),"\n",(0,a.jsx)(n.p,{children:"我们把这个 url 作为消息发送就好了。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:C,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"首先在 sendMessage 方法加一个 type 参数，可以指定 image、text、file，默认是 text。"}),"\n",(0,a.jsx)(n.p,{children:"然后上传完图片之后，调用 sendMessage 方法，type 为 image："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:v,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"另外，消息展示的时候也要根据类型做下处理："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:I,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Button, Input, message, Popover } from \"antd\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { io, Socket } from \"socket.io-client\";\nimport './index.scss';\nimport { chatHistoryList, chatroomList } from \"../../interfaces\";\nimport { UserInfo } from \"../UpdateInfo\";\nimport TextArea from \"antd/es/input/TextArea\";\nimport { useLocation } from \"react-router-dom\";\nimport EmojiPicker from \"@emoji-mart/react\";\nimport data from '@emoji-mart/data'\nimport { UploadImageModal } from \"./UploadImageModal\";\n\ninterface JoinRoomPayload {\n    chatroomId: number\n    userId: number\n}\n\ninterface SendMessagePayload {\n    sendUserId: number;\n    chatroomId: number;\n    message: Message\n}\n\ntype MessageType = 'image' | 'text' | 'file';\n\ninterface Message {\n    type: MessageType\n    content: string\n}\n\ntype Reply  = {\n    type: 'sendMessage'\n    userId: number\n    message: ChatHistory\n} | {\n    type: 'joinRoom'\n    userId: number\n}\n\n\ninterface Chatroom {\n    id: number;\n    name: string;\n    createTime: Date;\n}\n\ninterface ChatHistory {\n    id: number\n    content: string\n    type: number\n    chatroomId: number\n    senderId: number\n    createTime: Date,\n    sender: UserInfo\n}\n\ninterface User {\n    id: number;\n    email: string;\n    headPic: string;\n    nickName: string;\n    username: string;\n    createTime: Date;\n}\n\nexport function getUserInfo(): User {\n    return JSON.parse(localStorage.getItem('userInfo')!);\n}\n\nexport function Chat() {\n    const socketRef = useRef<Socket>();\n    const [roomId, setChatroomId] = useState<number>();\n    const userInfo = getUserInfo();\n    const [isUploadImageModalOpen, setUploadImageModalOpen] = useState(false);\n\n    useEffect(() => {\n        if(!roomId) {\n            return;\n        }\n        const socket = socketRef.current = io('http://localhost:3005');\n        socket.on('connect', function() {\n    \n            const payload: JoinRoomPayload = {\n                chatroomId: roomId,\n                userId: userInfo.id\n            }\n    \n            socket.emit('joinRoom', payload);\n    \n            socket.on('message', (reply: Reply) => {\n                if(reply.type === 'sendMessage') {\n                    setChatHistory((chatHistory) => {\n                        return chatHistory ? [...chatHistory, reply.message] : [reply.message]\n                    });   \n                    setTimeout(() => {\n                        document.getElementById('bottom-bar')?.scrollIntoView({block: 'end'});\n                    }, 300);\n                }\n            });\n        });\n        return () => {\n            socket.disconnect();\n        }\n    }, [roomId]);\n\n    function sendMessage(value: string, type: MessageType = 'text') {\n        if(!value) {\n            return;\n        }\n        if(!roomId) {\n            return;\n        }\n\n        const payload: SendMessagePayload = {\n            sendUserId: userInfo.id,\n            chatroomId: roomId,\n            message: {\n                type,\n                content: value\n            }\n        }\n\n        socketRef.current?.emit('sendMessage', payload);\n    }\n\n    const [roomList, setRoomList] = useState<Array<Chatroom>>();\n\n    async function queryChatroomList() {\n        try{\n            const res = await chatroomList();\n\n            if(res.status === 201 || res.status === 200) {\n                setRoomList(res.data.map((item: Chatroom) => {\n                    return {\n                        ...item,\n                        key: item.id\n                    }\n                }));\n            }\n        } catch(e: any){\n            console.log(e);\n            message.error(e.response?.data?.message || '系统繁忙，请稍后再试');\n        }\n    }\n\n    useEffect(() => {\n        queryChatroomList();\n    }, []);\n\n    useEffect(() => {\n        setTimeout(() => {\n            document.getElementById('bottom-bar')?.scrollIntoView({block: 'end'});\n        }, 300);\n    }, [roomId])\n\n    const [chatHistory, setChatHistory] = useState<Array<ChatHistory>>();\n\n    async function queryChatHistoryList(chatroomId: number) {\n        try{\n            const res = await chatHistoryList(chatroomId);\n\n            if(res.status === 201 || res.status === 200) {\n                setChatHistory(res.data.map((item: Chatroom) => {\n                    return {\n                        ...item,\n                        key: item.id\n                    }\n                }));\n            }\n        } catch(e: any){\n            message.error(e.response?.data?.message || '系统繁忙，请稍后再试');\n        }\n    }\n    const [inputText, setInputText] = useState('');\n\n    const location = useLocation();\n\n    useEffect(() => {\n        if(location.state?.chatroomId) {\n            setChatroomId(location.state?.chatroomId);\n\n            queryChatHistoryList(location.state?.chatroomId);\n        }\n    }, [location.state?.chatroomId]);\n\n    return <div id=\"chat-container\">\n        <div className=\"chat-room-list\">\n            {\n                roomList?.map(item => {\n                    return <div className={`chat-room-item ${item.id === roomId ? 'selected' : ''}`} key={item.id} data-id={item.id} onClick={() => {\n                        queryChatHistoryList(item.id);\n                        setChatroomId(item.id);\n                    }}>{item.name}</div>\n                })\n            }\n        </div>\n        <div className=\"message-list\">\n            {chatHistory?.map(item => {\n                return <div className={`message-item ${item.senderId === userInfo.id ? 'from-me' : ''}`} key={item.id} data-id={item.id}>\n                    <div className=\"message-sender\">\n                        <img src={item.sender.headPic} />\n                        <span className=\"sender-nickname\">{item.sender.nickName}</span>\n                    </div>\n                    <div className=\"message-content\">\n                        {\n                            item.type === 0 \n                                ? item.content \n                                : item.type === 1\n                                    ? <img src={item.content} style={{maxWidth: 200}}/>\n                                    : item.content\n                        }\n                    </div>\n                </div>\n            })}\n            <div id=\"bottom-bar\" key='bottom-bar'></div>\n        </div>\n        <div className=\"message-input\">\n            <div className=\"message-type\">\n                <div className=\"message-type-item\" key={1}>\n                    <Popover content={<EmojiPicker data={data} onEmojiSelect={(emoji: any) => {\n                        setInputText((inputText) => inputText + emoji.native)\n                    }} />} title=\"Title\" trigger=\"click\">\n                        表情\n                    </Popover>\n                </div>\n                <div className=\"message-type-item\" key={2} onClick={() => {\n                    setUploadImageModalOpen(true);\n                }}>图片</div>\n                <div className=\"message-type-item\" key={3}>文件</div>\n            </div>\n            <div className=\"message-input-area\">\n                <TextArea className=\"message-input-box\" value={inputText} onChange={(e) => {\n                    setInputText(e.target.value)\n                }}/>\n                <Button className=\"message-send-btn\" type=\"primary\" onClick={() => {\n                    sendMessage(inputText)\n                    setInputText('');\n                }}>发送</Button>\n            </div>\n        </div>\n        <UploadImageModal isOpen={isUploadImageModalOpen} handleClose={(imgSrc) => {\n            setUploadImageModalOpen(false);\n\n            if(imgSrc) {\n                sendMessage(imgSrc, 'image')\n            }\n        }} />\n    </div>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"测试下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:b,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这样，发送图片功能就完成了。"}),"\n",(0,a.jsx)(n.p,{children:"发送文件其实和这个差不多，只是展示的方式不同。"}),"\n",(0,a.jsx)(n.p,{children:"可以图片上传的逻辑，稍微改造下："}),"\n",(0,a.jsx)(n.p,{children:"把 ImageUpload 组件改名为 FileUpload 组件，加一个 type 参数："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:y,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"type 为 file 的时候，预览部分直接展示 value："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:j,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:'import { InboxOutlined } from "@ant-design/icons";\nimport { message } from "antd";\nimport Dragger, { DraggerProps } from "antd/es/upload/Dragger";\nimport axios from "axios";\nimport { presignedUrl } from "../../interfaces";\n\ninterface FileUploadProps {\n    value?: string;\n    onChange?: Function\n    type: \'image\' | \'file\'\n}\n\nlet onChange: Function;\n\nconst props: DraggerProps = {\n    name: \'file\',\n    action: async (file) => {\n        const res = await presignedUrl(file.name);\n        return res.data;\n    },\n    async customRequest(options) {\n        const { onSuccess, file, action } = options;\n\n        const res = await axios.put(action, file);\n\n        onSuccess!(res.data);\n    },\n    onChange(info) {\n        const { status } = info.file;\n        if (status === \'done\') {\n            onChange(\'http://localhost:9000/chat-room/\' + info.file.name);\n            message.success(`${info.file.name} 文件上传成功`);\n        } else if (status === \'error\') {\n            message.error(`${info.file.name} 文件上传失败`);\n        }\n    }\n};\n\nconst dragger = <Dragger {...props}>\n    <p className="ant-upload-drag-icon">\n        <InboxOutlined />\n    </p>\n    <p className="ant-upload-text">点击或拖拽文件到这个区域来上传</p>\n</Dragger>\n\nexport function FileUpload(props: FileUploadProps) {\n\n    onChange = props.onChange!\n\n    return props?.value ? <div>\n        {\n            props.type === \'image\'\n                ? <img src={props.value} alt="图片" width="100" height="100"/>\n                : props.value\n        }\n        {dragger}\n    </div>: <div>\n        {dragger}\n    </div>\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"然后 UploadImageModal 改名为 UploadModal"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:x,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"也增加一个 type 参数，展示不同文案。"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Modal } from \"antd\";\nimport { FileUpload } from \"./FileUpload\";\nimport { useState } from \"react\";\n\ninterface UploadModalProps {\n    isOpen: boolean;\n    handleClose: (fileUrl?: string) => void\n    type: 'image' | 'file'\n}\n\nexport function UploadModal(props: UploadModalProps) {\n    const [fileUrl, setFileUrl] = useState<string>('');\n\n    return <Modal \n        title={`上传${props.type === 'image' ? '图片' : '文件'}`}\n        open={props.isOpen}\n        onOk={() => {\n            props.handleClose(fileUrl)\n            setFileUrl('')\n        }}\n        onCancel={() => props.handleClose()}\n        okText={'确认'}\n        cancelText={'取消'}    \n    >\n        <FileUpload value={fileUrl} type={props.type} onChange={(value: string) => {\n            setFileUrl(value)\n        }}/>\n    </Modal>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"最后，在 Chat/index.tsx 里引入修改后的组件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"加一个 uploadType 的参数，点击图片、文件按钮会设置不同的 type。"}),"\n",(0,a.jsx)(n.p,{children:"然后发送消息的时候，根据 type 来发："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:f,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后改下展示的内容："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:u,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"文件就直接展示路径好了。"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { Button, Input, message, Popover } from \"antd\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { io, Socket } from \"socket.io-client\";\nimport './index.scss';\nimport { chatHistoryList, chatroomList } from \"../../interfaces\";\nimport { UserInfo } from \"../UpdateInfo\";\nimport TextArea from \"antd/es/input/TextArea\";\nimport { useLocation } from \"react-router-dom\";\nimport EmojiPicker from \"@emoji-mart/react\";\nimport data from '@emoji-mart/data'\nimport { UploadModal } from \"./UploadModal\";\n\ninterface JoinRoomPayload {\n    chatroomId: number\n    userId: number\n}\n\ninterface SendMessagePayload {\n    sendUserId: number;\n    chatroomId: number;\n    message: Message\n}\n\ntype MessageType = 'image' | 'text' | 'file';\n\ninterface Message {\n    type: MessageType\n    content: string\n}\n\ntype Reply  = {\n    type: 'sendMessage'\n    userId: number\n    message: ChatHistory\n} | {\n    type: 'joinRoom'\n    userId: number\n}\n\n\ninterface Chatroom {\n    id: number;\n    name: string;\n    createTime: Date;\n}\n\ninterface ChatHistory {\n    id: number\n    content: string\n    type: number\n    chatroomId: number\n    senderId: number\n    createTime: Date,\n    sender: UserInfo\n}\n\ninterface User {\n    id: number;\n    email: string;\n    headPic: string;\n    nickName: string;\n    username: string;\n    createTime: Date;\n}\n\nexport function getUserInfo(): User {\n    return JSON.parse(localStorage.getItem('userInfo')!);\n}\n\nexport function Chat() {\n    const socketRef = useRef<Socket>();\n    const [roomId, setChatroomId] = useState<number>();\n    const userInfo = getUserInfo();\n    const [isUploadModalOpen, setUploadModalOpen] = useState(false);\n\n    useEffect(() => {\n        if(!roomId) {\n            return;\n        }\n        const socket = socketRef.current = io('http://localhost:3005');\n        socket.on('connect', function() {\n    \n            const payload: JoinRoomPayload = {\n                chatroomId: roomId,\n                userId: userInfo.id\n            }\n    \n            socket.emit('joinRoom', payload);\n    \n            socket.on('message', (reply: Reply) => {\n                if(reply.type === 'sendMessage') {\n                    setChatHistory((chatHistory) => {\n                        return chatHistory ? [...chatHistory, reply.message] : [reply.message]\n                    });   \n                    setTimeout(() => {\n                        document.getElementById('bottom-bar')?.scrollIntoView({block: 'end'});\n                    }, 300);\n                }\n            });\n        });\n        return () => {\n            socket.disconnect();\n        }\n    }, [roomId]);\n\n    function sendMessage(value: string, type: MessageType = 'text') {\n        if(!value) {\n            return;\n        }\n        if(!roomId) {\n            return;\n        }\n\n        const payload: SendMessagePayload = {\n            sendUserId: userInfo.id,\n            chatroomId: roomId,\n            message: {\n                type,\n                content: value\n            }\n        }\n\n        socketRef.current?.emit('sendMessage', payload);\n    }\n\n    const [roomList, setRoomList] = useState<Array<Chatroom>>();\n\n    async function queryChatroomList() {\n        try{\n            const res = await chatroomList();\n\n            if(res.status === 201 || res.status === 200) {\n                setRoomList(res.data.map((item: Chatroom) => {\n                    return {\n                        ...item,\n                        key: item.id\n                    }\n                }));\n            }\n        } catch(e: any){\n            console.log(e);\n            message.error(e.response?.data?.message || '系统繁忙，请稍后再试');\n        }\n    }\n\n    useEffect(() => {\n        queryChatroomList();\n    }, []);\n\n    useEffect(() => {\n        setTimeout(() => {\n            document.getElementById('bottom-bar')?.scrollIntoView({block: 'end'});\n        }, 300);\n    }, [roomId])\n\n    const [chatHistory, setChatHistory] = useState<Array<ChatHistory>>();\n\n    async function queryChatHistoryList(chatroomId: number) {\n        try{\n            const res = await chatHistoryList(chatroomId);\n\n            if(res.status === 201 || res.status === 200) {\n                setChatHistory(res.data.map((item: Chatroom) => {\n                    return {\n                        ...item,\n                        key: item.id\n                    }\n                }));\n            }\n        } catch(e: any){\n            message.error(e.response?.data?.message || '系统繁忙，请稍后再试');\n        }\n    }\n    const [inputText, setInputText] = useState('');\n\n    const location = useLocation();\n\n    useEffect(() => {\n        if(location.state?.chatroomId) {\n            setChatroomId(location.state?.chatroomId);\n\n            queryChatHistoryList(location.state?.chatroomId);\n        }\n    }, [location.state?.chatroomId]);\n\n    const [uploadType, setUploadType] = useState<'image' | 'file'>('image'); \n\n    return <div id=\"chat-container\">\n        <div className=\"chat-room-list\">\n            {\n                roomList?.map(item => {\n                    return <div className={`chat-room-item ${item.id === roomId ? 'selected' : ''}`} key={item.id} data-id={item.id} onClick={() => {\n                        queryChatHistoryList(item.id);\n                        setChatroomId(item.id);\n                    }}>{item.name}</div>\n                })\n            }\n        </div>\n        <div className=\"message-list\">\n            {chatHistory?.map(item => {\n                return <div className={`message-item ${item.senderId === userInfo.id ? 'from-me' : ''}`} key={item.id} data-id={item.id}>\n                    <div className=\"message-sender\">\n                        <img src={item.sender.headPic} />\n                        <span className=\"sender-nickname\">{item.sender.nickName}</span>\n                    </div>\n                    <div className=\"message-content\">\n                        {\n                            item.type === 0 \n                                ? item.content \n                                : item.type === 1\n                                    ? <img src={item.content} style={{maxWidth: 200}}/>\n                                    : <div>item.content</div>\n                        }\n                    </div>\n                </div>\n            })}\n            <div id=\"bottom-bar\" key='bottom-bar'></div>\n        </div>\n        <div className=\"message-input\">\n            <div className=\"message-type\">\n                <div className=\"message-type-item\" key={1}>\n                    <Popover content={<EmojiPicker data={data} onEmojiSelect={(emoji: any) => {\n                        setInputText((inputText) => inputText + emoji.native)\n                    }} />} title=\"Title\" trigger=\"click\">\n                        表情\n                    </Popover>\n                </div>\n                <div className=\"message-type-item\" key={2} onClick={() => {\n                    setUploadType('image');\n                    setUploadModalOpen(true);\n                }}>图片</div>\n                <div className=\"message-type-item\" key={3}onClick={() => {\n                    setUploadType('file');\n                    setUploadModalOpen(true);\n                }}>文件</div>\n            </div>\n            <div className=\"message-input-area\">\n                <TextArea className=\"message-input-box\" value={inputText} onChange={(e) => {\n                    setInputText(e.target.value)\n                }}/>\n                <Button className=\"message-send-btn\" type=\"primary\" onClick={() => {\n                    sendMessage(inputText)\n                    setInputText('');\n                }}>发送</Button>\n            </div>\n        </div>\n        <UploadModal isOpen={isUploadModalOpen} type={uploadType} handleClose={(fileUrl) => {\n            setUploadModalOpen(false);\n\n            if(fileUrl) {\n                sendMessage(fileUrl, uploadType)\n            }\n        }} />\n    </div>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"试下效果："}),"\n",(0,a.jsx)(n.p,{children:"发送图片："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:g,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"发送文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:p,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"都没问题。"}),"\n",(0,a.jsx)(n.p,{children:"当时我们服务端没支持 file，改一下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:m,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const map = {\n  text: 0,\n  image: 1,\n  file: 2\n}\nconst history = await this.chatHistoryService.add(payload.chatroomId, {\n  content: payload.message.content,\n  type: map[payload.message.type],\n  chatroomId: payload.chatroomId,\n  senderId: payload.sendUserId\n});\n"})}),"\n",(0,a.jsx)(n.p,{children:"然后在前端支持下文件下载："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:d,alt:""})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"<a download href={item.content}>{item.content}</a>\n"})}),"\n",(0,a.jsx)(n.p,{children:"现在，就可以发送和下载文件了："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"整体测试下："}),"\n",(0,a.jsx)(n.p,{children:"发送表情："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:i,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"发送图片："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:r,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"发送文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:o,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"都没问题。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-frontend",target:"_blank",rel:"noopener noreferrer",children:"前端代码"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-backend",target:"_blank",rel:"noopener noreferrer",children:"后端代码"})}),"\n",(0,a.jsxs)(n.h2,{id:"总结",children:["总结",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"这节我们实现了发送表情、图片、文件。"}),"\n",(0,a.jsx)(n.p,{children:"表情用 emoji-mart 这个包实现。"}),"\n",(0,a.jsx)(n.p,{children:"图片就是之前的上传图片，只是上传完把 url 作为消息发过去，设置下 type 为 image。"}),"\n",(0,a.jsx)(n.p,{children:"文件也是一样上传，上传完把 url 作为消息发过去，设置 type 为 file。"}),"\n",(0,a.jsx)(n.p,{children:"然后展示 image 和 file 的时候分别作为图片展示，以及支持下载。"}),"\n",(0,a.jsx)(n.p,{children:"这样，发送表情、图片、文件的功能就完成了。"})]})}function w(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(H,{...e})}):H(e)}let O=w;w.__RSPRESS_PAGE_META={},w.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F191.%20%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%9A%E5%8F%91%E9%80%81%E8%A1%A8%E6%83%85%E3%80%81%E5%9B%BE%E7%89%87%E3%80%81%E6%96%87%E4%BB%B6.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"191. 聊天室：发送表情、图片、文件",headingTitle:"191. 聊天室：发送表情、图片、文件",frontmatter:{}}}}]);