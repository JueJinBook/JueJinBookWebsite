"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["86523"],{509175:function(e,n,s){s.r(n),s.d(n,{default:()=>u});var r=s(552676),c=s(740453);let d=s.p+"static/image/029aba0e76b3ad582d7a336a6fe99c96.f8080f46.webp",a=s.p+"static/image/b5d33b761901b89757f72a728b2b8f84.352111ce.webp",i=s.p+"static/image/f6beb1bf25e5481d4c69ef7bc469a275.2bab6ead.webp",l=s.p+"static/image/7471b4b4ba49ff075e0a6360d0b2ef9a.f5bd79a9.webp",h=s.p+"static/image/5480d06a445bdd288605209d151b236d.dd6809b7.webp",o=s.p+"static/image/a1676115a038196b748e07b5f1503575.0de94668.webp",t=s.p+"static/image/a5b0f5e1af2f031da874b3141507292c.c34d4f33.webp",x=s.p+"static/image/00d055e60e29842b73116a34ed78a478.1777dc2b.webp";function j(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",p:"p",code:"code",pre:"pre",h3:"h3",img:"img",ul:"ul",li:"li",h4:"h4",strong:"strong",ol:"ol"},(0,c.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"33api-篇-_-nextconfigjs上",children:["33.API 篇 _ next.config.js（上）",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#33api-篇-_-nextconfigjs上",children:"#"})]}),"\n",(0,r.jsxs)(n.h2,{id:"前言",children:["前言",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#前言",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["Next.js 可以通过根目录的 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 进行配置："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  /* config options here */\n}\n \nmodule.exports = nextConfig\n"})}),"\n",(0,r.jsxs)(n.p,{children:["正如文件的扩展名是 ",(0,r.jsx)(n.code,{children:".js"}),"，",(0,r.jsx)(n.code,{children:"next.config.js"})," 是一个常规的 Node.js 模块，而不是一个 JSON 文件。它会在 Next.js server 和构建阶段被用到，并且不包含在浏览器构建中（代码不会打包到客户端）。"]}),"\n",(0,r.jsxs)(n.p,{children:["如果你需要 ECMAScript 模块，你可以使用 ",(0,r.jsx)(n.code,{children:"next.config.mjs"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"/**\n * @type {import('next').NextConfig}\n */\nconst nextConfig = {\n  /* config options here */\n}\n \nexport default nextConfig\n"})}),"\n",(0,r.jsx)(n.p,{children:"你也可以使用一个函数："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"export default (phase, { defaultConfig }) => {\n  /**\n   * @type {import('next').NextConfig}\n   */\n  const nextConfig = {\n    /* config options here */\n  }\n  return nextConfig\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"从 Next.js 12.1.0 起，你还可以使用一个异步函数："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"module.exports = async (phase, { defaultConfig }) => {\n  /**\n   * @type {import('next').NextConfig}\n   */\n  const nextConfig = {\n    /* config options here */\n  }\n  return nextConfig\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["其中 ",(0,r.jsx)(n.code,{children:"phase"})," 表示配置加载的当前上下文。通过",(0,r.jsx)(n.a,{href:"https://github.com/vercel/next.js/blob/5e6b008b561caf2710ab7be63320a3d549474a5b/packages/next/shared/lib/constants.ts#L19-L23",target:"_blank",rel:"noopener noreferrer",children:"查看源码"}),"，可以知道 ",(0,r.jsx)(n.code,{children:"phase"})," 的值一共有 5 个："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"export const PHASE_EXPORT = 'phase-export'\nexport const PHASE_PRODUCTION_BUILD = 'phase-production-build'\nexport const PHASE_PRODUCTION_SERVER = 'phase-production-server'\nexport const PHASE_DEVELOPMENT_SERVER = 'phase-development-server'\nexport const PHASE_TEST = 'phase-test'\n"})}),"\n",(0,r.jsxs)(n.p,{children:["可以通过 ",(0,r.jsx)(n.code,{children:"next/constants"})," 导入，根据不同的阶段进行自定义配置："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const { PHASE_DEVELOPMENT_SERVER } = require('next/constants')\n \nmodule.exports = (phase, { defaultConfig }) => {\n  if (phase === PHASE_DEVELOPMENT_SERVER) {\n    return {\n      /* 这里放 development 配置选项 */\n    }\n  }\n \n  return {\n    /* 除了 development 阶段的其他阶段的配置 */\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["在这个例子中，注释行的地方就是你可以放配置的地方，实际上，Next.js 定义的配置非常多，可以查看",(0,r.jsx)(n.a,{href:"https://github.com/vercel/next.js/blob/canary/packages/next/src/server/config-shared.ts",target:"_blank",rel:"noopener noreferrer",children:"源码配置文件"}),"。"]}),"\n",(0,r.jsx)(n.p,{children:"然而，这些配置又都不是必须的，也没有必要清楚的了解每个配置的作用，大致看一下，有个印象即可，需要用到的时候再去细查。"}),"\n",(0,r.jsxs)(n.p,{children:["因为要讲解的配置有 36 个，内容繁琐细节且庞大，所以 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 的配置部分拆分为上下两篇。上篇讲解请求相关的 headers、redirects、rewrites，这是 Next.js 中常用的配置，且内容有很多相似之处，放在一起方便触类旁通。下篇讲解剩余的 33 个配置，每个配置内容都不多，了解即可。"]}),"\n",(0,r.jsx)(n.p,{children:"现在让我们开始学习吧！"}),"\n",(0,r.jsxs)(n.h2,{id:"1-headers",children:["1. headers",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1-headers",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"11-介绍",children:["1.1. 介绍",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#11-介绍",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["Headers 用于设置自定义 HTTP 标头，使用 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 的 ",(0,r.jsx)(n.code,{children:"headers"}),"字段："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"module.exports = {\n  async headers() {\n    return [\n      {\n        source: '/about',\n        headers: [\n          {\n            key: 'x-custom-header',\n            value: 'my custom header value',\n          },\n          {\n            key: 'x-another-custom-header',\n            value: 'my other custom header value',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["此时访问 ",(0,r.jsx)(n.code,{children:"/about"}),"，可以看到："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:"截屏2023-11-09 下午3.40.56.png"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"headers"}),"是一个异步函数，该函数返回一个包含 ",(0,r.jsx)(n.code,{children:"soruce"})," 和 ",(0,r.jsx)(n.code,{children:"headers"})," 属性的对象数组，其中："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"})," 表示传入的请求路径"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"headers"})," 是一个包含 key 和 value 属性的响应标头对象数组"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"除了这两个值外，还可以设置："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"basePath"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"。当值为 ",(0,r.jsx)(n.code,{children:"false"})," ，匹配时不会包含 ",(0,r.jsx)(n.code,{children:"basePath"}),"，只能用于外部重写"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"locale"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，匹配时是否应该包含 locale"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"has"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"missing"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["headers 会在文件系统（包括页面和 ",(0,r.jsx)(n.code,{children:"/public"})," 文件）之前被触发。"]}),"\n",(0,r.jsx)(n.p,{children:"这些字段我们来一一举例介绍。"}),"\n",(0,r.jsxs)(n.h3,{id:"12-source",children:["1.2. source",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#12-source",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"source 表示传入的请求路径，除了可以匹配具体的值，还支持三种匹配模式："}),"\n",(0,r.jsxs)(n.h4,{id:"路径匹配",children:["路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#路径匹配",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["普通的路径匹配，举个例子，",(0,r.jsx)(n.code,{children:"/blog:slug"})," 会匹配 ",(0,r.jsx)(n.code,{children:"/blog/hello-world"}),"（无嵌套路径，也就是说 ",(0,r.jsx)(n.code,{children:"/blog/hello-world/about"}),"不会匹配）"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        source: '/blog/:slug',\n        headers: [\n          {\n            key: 'x-slug',\n            value: ':slug', // 匹配参数可以在 value 中使用\n          },\n          {\n            key: 'x-slug-:slug', // 匹配参数可以在 key 中使用\n            value: 'my other custom header value',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/blog/hello-world"}),"，可以看到："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:"截屏2023-11-09 下午4.00.05.png"})}),"\n",(0,r.jsxs)(n.p,{children:["但访问 ",(0,r.jsx)(n.code,{children:"/blog/hello-world/about"}),"就不会有自定义标头。"]}),"\n",(0,r.jsxs)(n.h4,{id:"通配符路径匹配",children:["通配符路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#通配符路径匹配",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后使用 ",(0,r.jsx)(n.code,{children:"*"})," 实现通配符路径匹配，举个例子：",(0,r.jsx)(n.code,{children:"/blog/:slug*"})," 会匹配 ",(0,r.jsx)(n.code,{children:"/blog/a/b/c/d/hello-world"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        source: '/blog/:slug*',\n        headers: [\n          {\n            key: 'x-slug',\n            value: ':slug*',\n          },\n          {\n            key: 'x-slug-:slug*',\n            value: 'my other custom header value',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/blog/hello-world/about"}),"，可以看到："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:"image.png"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/blog/hello-world"})," 也是有的："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:"image.png"})}),"\n",(0,r.jsxs)(n.h4,{id:"正则表达式路径匹配",children:["正则表达式路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#正则表达式路径匹配",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后用括号将正则表达式括住实现正则表达式匹配，举个例子：",(0,r.jsx)(n.code,{children:"blog/:slug(\\\\d{1,})"})," 匹配 ",(0,r.jsx)(n.code,{children:"/blog/123"})," 而不匹配 ",(0,r.jsx)(n.code,{children:"/blog/abc"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        source: '/blog/:post(\\\\d{1,})',\n        headers: [\n          {\n            key: 'x-post',\n            value: ':post',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/blog/123"}),"，可以看到："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,UklGRrIDAABXRUJQVlA4IKYDAACwFwCdASqSATQAPp1IoE0lo6MiI3XZILATiWlu/HyZNu/bCYdh3enV1tyIiNqbdRORfzj9UeRbSgzrX+f5JS6v4DYFiu2pja+AYyqkr0lSk7S2e5GypY9lOKSnl+PPvH7RC9+C4flwGanTbxONEDBa1BPIz9XIN9rJUcoTcZatM2SDPUF6RV3oogtp4a9q3/XTZn5fTipY9lOKSnw+KnvIuP7wg82lv2sqV9IuYMZJXyNUVQBASGBtHRdrKlj2U4pKhBMgZAAA/t79ujXcciKkaNCGua91WtaNO5uyNg6zM+R+j2y2/XZWaM661PubAEtPP60gwodFZNDTXd6xfYcsyMMiH8eivI6qk5NYuxawEuc3SsgvnTFrSa2Vs2lN5wIY2emCryljeeJY6OUu9Y0LdrBEKCKI1vtuJLLyX1Ai/zcqq5IMzRjjrRmiLLF9mu/eQTKRHL0PsDXKHm59D16JKAEadG6Yclv0kID2wZ5df2ENpG8idoDiwqVB8l3rGbW6S5VO8ds3lRtMFIOX2Z/DZDxpGGyOhiQEf1sWdxvuaE0LfYk8aNauaaXVBAmfFbvOaU7zfG1jqlybr3SWPbRpNOfoezmtzaZAo+zp2UO06LDfTeZeQzvRn1B6LV6/w/p16sBpUEcx1GR0ozeDvdiYw7sx0gIKOekFDl27mXY7sbKnoHa2/HDpOmni206eS01HmFndfJatbkInPtz6GJOgCklmejD7eRV6wT/1ypvDqs1fcXtnt4n+EfqtQOJfQjxdXzCPmw9XRl/vWJn6YVvJ/KhE3Lsr4saH1FSXcDNSwqfz4h3Gd7wl+rbrcgAbfCWfsIXf+pTIez4rv7Mfzxck7wlnfoZhX7aRkq9+yI6ZwgHJV+7D1G8zjJuQfhX4GenOia/3FFgaD3EF8wMvvbxTOGltECoNSgYt7LTES3YtKdf9V7UbXmFOdHzh6fu0YmZJY/mAMF6HV/8T+Tf4fnOymIQ4LBEoHPdf6EOzXii1uH62aJ/kKE/UMCtCcTHWCPqU/JceDqUdTsJ6BzGdQQiJP9r0gpLDewSHA8LN3MAAQwRWmcG6haO5J4ZeVA6mk0wkWj4paUI9Sp9yumqzfGJOkN+/VV/AmeiiN1GMiE3JCZSr/ndoRUqc503wu1z4VsmZ8BWTnR/Bmi+WJcJoBmE6wmWMe+fDVObwbK2PVOM4VXcbfPDs4cL+VdjdjIyQqyTgPLOo/bj2AvfVZ/Va8oBGQz6KAAAA",alt:"image.png"})}),"\n",(0,r.jsxs)(n.p,{children:["注意：这 8 个字符  ",(0,r.jsx)(n.code,{children:"("}),"、",(0,r.jsx)(n.code,{children:")"}),"、 ",(0,r.jsx)(n.code,{children:"{"}),"、 ",(0,r.jsx)(n.code,{children:"}"}),"、 ",(0,r.jsx)(n.code,{children:":"}),"、 ",(0,r.jsx)(n.code,{children:"*"}),"、 ",(0,r.jsx)(n.code,{children:"+"}),"、 ",(0,r.jsx)(n.code,{children:"?"})," 都会用于正则表达式匹配，所以需要用到这些字符本身的时候，使用 ",(0,r.jsx)(n.code,{children:"\\\\"}),"转义"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        // 匹配 `/english(default)/something`\n        source: '/english\\\\(default\\\\)/:slug',\n        headers: [\n          {\n            key: 'x-header',\n            value: 'value',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"13-headers",children:["1.3. headers",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#13-headers",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"headers 无须多说，我们聊聊 headers 的覆盖行为。"}),"\n",(0,r.jsx)(n.p,{children:"如果两个 headers 匹配相同的路径以及设置了相同的 header key，最后一个 header 的 key 会覆盖前一个。举个例子："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        source: '/:path*',\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'there',\n          },\n        ],\n      },\n      {\n        source: '/hello',\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["在这个例子中，当访问 ",(0,r.jsx)(n.code,{children:"/hello"})," 时，既匹配 ",(0,r.jsx)(n.code,{children:"/:path*"}),"，又匹配 ",(0,r.jsx)(n.code,{children:"/hello"}),"，而两个 source 对应设置的 ",(0,r.jsx)(n.code,{children:"x-hello"})," 的 key 值不同，因为",(0,r.jsx)(n.code,{children:"/hello"})," 是最后一个 header，所以最终的值是 ",(0,r.jsx)(n.code,{children:"world"}),"。"]}),"\n",(0,r.jsx)(n.p,{children:"那如果匹配了相同的路径，但设置的  header key 不冲突呢？那就都会添加，举个例子："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"module.exports = {\n  async headers() {\n    return [\n      {\n        source: '/:path*',\n        headers: [\n          {\n            key: 'hello',\n            value: 'hello',\n          },\n          {\n            key: 'hello2',\n            value: 'hello2',\n          }\n        ],\n      },\n      {\n        source: '/hello',\n        headers: [\n          {\n            key: 'hello',\n            value: 'world',\n          },\n          {\n            key: 'hello3',\n            value: 'hello3',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"最终的结果为："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:"image.png"})}),"\n",(0,r.jsxs)(n.h3,{id:"14-basepath",children:["1.4. basePath",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#14-basepath",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"basePath"}),"的值为 ",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"。当值为 ",(0,r.jsx)(n.code,{children:"false"})," ，匹配时不会包含 ",(0,r.jsx)(n.code,{children:"basePath"}),"，举个例子："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  basePath: '/docs',\n \n  async headers() {\n    return [\n      {\n        source: '/with-basePath', // 匹配 /docs/with-basePath\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world',\n          },\n        ],\n      },\n      {\n        source: '/without-basePath', // 匹配 /without-basePath\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world',\n          },\n        ],\n        basePath: false, // 因为设置了 false\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["在这个例子中，设置了 ",(0,r.jsx)(n.code,{children:"basePath"})," 为 ",(0,r.jsx)(n.code,{children:"/docs"}),"，正常 headers 中的 source 会匹配 basePath + source 构成的链接，除非你设置了 ",(0,r.jsx)(n.code,{children:"basePath"})," 为 ",(0,r.jsx)(n.code,{children:"false"}),"。"]}),"\n",(0,r.jsxs)(n.h3,{id:"15-locale",children:["1.5. locale",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#15-locale",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"locale"})," 的值为 ",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，决定匹配时是否应该包含 locale，其实效果跟 basePath 类似."]}),"\n",(0,r.jsxs)(n.p,{children:["考虑到部分同学对 ",(0,r.jsx)(n.code,{children:"locale"})," 不太熟悉，我们先简单的讲下 ",(0,r.jsx)(n.code,{children:"locale"}),"配置项，locale 的作用就是国际化（i18n），",(0,r.jsx)(n.code,{children:"next.config.js"})," 针对 Pages Router 提供了 i18n 配置项，注意是在 Pages Router 下，在 App Router 下 Next.js 已经不再提供直接的支持，具体内容查看小册国际化章节。"]}),"\n",(0,r.jsxs)(n.p,{children:["比如我们在 ",(0,r.jsx)(n.code,{children:"pages"})," 目录下新建一个 ",(0,r.jsx)(n.code,{children:"article.js"})," 文件："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// pages/article.js\nexport default function Home() {\n  return  <h1>Hello Article!</h1>\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["然后 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 修改配置项："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  i18n: {\n    locales: ['en', 'fr', 'de', 'zh'],\n    defaultLocale: 'zh',\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["此时，访问 ",(0,r.jsx)(n.code,{children:"/en/article"}),"、",(0,r.jsx)(n.code,{children:"/fr/article"}),"、",(0,r.jsx)(n.code,{children:"/de/article"})," 都会重写为 ",(0,r.jsx)(n.code,{children:"/article"}),"，注意是重写，就是路由地址不变，但内容是 ",(0,r.jsx)(n.code,{children:"/article"}),"的内容。访问 ",(0,r.jsx)(n.code,{children:"/zh/article"})," 会重定向到 ",(0,r.jsx)(n.code,{children:"/article"}),"。"]}),"\n",(0,r.jsxs)(n.p,{children:["而如果你在 ",(0,r.jsx)(n.code,{children:"app/article"}),"目录下新建一个 ",(0,r.jsx)(n.code,{children:"article.js"})," 文件，文件内容同上。"]}),"\n",(0,r.jsxs)(n.p,{children:["此时，访问 ",(0,r.jsx)(n.code,{children:"/en/article"}),"、",(0,r.jsx)(n.code,{children:"/fr/article"}),"、",(0,r.jsx)(n.code,{children:"/de/article"})," 都会 404 错误。访问 ",(0,r.jsx)(n.code,{children:"/zh/article"})," 会重写为 ",(0,r.jsx)(n.code,{children:"/article"}),"。说明在 App Router 下只有 ",(0,r.jsx)(n.code,{children:"i18n.defaultLocale"})," 是生效的。"]}),"\n",(0,r.jsx)(n.p,{children:"好了，基本介绍完毕，主要是为了让大家了解配置项中的 i18n 的作用。我们再看 headers 中的 locales 设置，举个例子："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"module.exports = {\n  i18n: {\n    locales: ['en', 'fr', 'de'],\n    defaultLocale: 'en',\n  },\n \n  async headers() {\n    return [\n      {\n        // 自动处理所有的 locales\n        // 也就是 `/en/with-locale`、`/fr/with-locale`、`/de/with-locale`、`/with-locale` 都会匹配\n        source: '/with-locale', \n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world1',\n          },\n        ],\n      },\n      {\n        // 因为 locale 设置为 false，所以不会自动处理 locales\n        // 也就是只匹配 `/nl/with-locale-manual`\n        source: '/nl/with-locale-manual',\n        locale: false,\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world2',\n          },\n        ],\n      },\n      {\n        // 匹配 '/' 因为 `en` 是 defaultLocale\n        // 也就是只匹配 `/`、`/en`\n        source: '/en',\n        locale: false,\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world3',\n          },\n        ],\n      },\n      {\n        // 会转换为 /(en|fr|de)/(.*) 所以不会匹配顶层\n        // 也就是 `/` 和 `/fr` 都不会匹配到\n        // 如果要匹配到这两个，可以用 `/:path*`\n        source: '/(.*)',\n        headers: [\n          {\n            key: 'x-hello',\n            value: 'world4',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"注意，虽然 i18n.locales 配置在 App Router 下不生效，但这也只是导致页面出现 404 错误而已，并不会影响处理标头，即便页面 404，你可以正常的查看标头。"}),"\n",(0,r.jsxs)(n.h3,{id:"16-has-和-missing",children:["1.6. has 和 missing",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#16-has-和-missing",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 是用来处理请求中的 header、cookie 和请求参数是否匹配某些字段，或者不匹配某些字段的时候，才应用 header。"]}),"\n",(0,r.jsxs)(n.p,{children:["举个例子，比如请求 ",(0,r.jsx)(n.code,{children:"/article?id=1&author=yayu"}),"，",(0,r.jsx)(n.code,{children:"has"})," 可以要求请求中必须有 id 参数，或者 id 参数等于 xxx 的时候才返回某个标头。",(0,r.jsx)(n.code,{children:"missing"})," 可以要求请求中必须没有 id 参数，或者 id 参数不等于 xxx 的时候才返回某个标头。"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 对象有下面这些字段："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"type"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，值为 ",(0,r.jsx)(n.code,{children:"header"}),"、",(0,r.jsx)(n.code,{children:"cookie"}),"、",(0,r.jsx)(n.code,{children:"host"}),"、",(0,r.jsx)(n.code,{children:"query"})," 之一"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"key"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，所选类型（也就是上面的四种值）中要匹配的 key"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"value"}),"： ",(0,r.jsx)(n.code,{children:"String"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，要检查的值。如果值为 ",(0,r.jsx)(n.code,{children:"undefiend"}),"，任何值都不会匹配。支持使用一个类似正则的字符串捕获值的特殊部分。比如 ",(0,r.jsx)(n.code,{children:"first-(?<paramName>.*)"}),"用于匹配 ",(0,r.jsx)(n.code,{children:"first-second"}),"，然后就可以用 ",(0,r.jsx)(n.code,{children:":paramName"}),"获取 ",(0,r.jsx)(n.code,{children:"second"})," 这个值"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"听起来有些复杂，看个例子其实就懂了："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      // 如果 header 中 `x-add-header` 字段存在\n      // 那就返回 `x-another-header` 标头\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'header',\n            key: 'x-add-header',\n          },\n        ],\n        headers: [\n          {\n            key: 'x-another-header',\n            value: 'hello',\n          },\n        ],\n      },\n      // 如果 header 中 `x-no-header` 字段不存在\n      // 就返回 `x-another-header` 标头\n      {\n        source: '/:path*',\n        missing: [\n          {\n            type: 'header',\n            key: 'x-no-header',\n          },\n        ],\n        headers: [\n          {\n            key: 'x-another-header',\n            value: 'hello',\n          },\n        ],\n      },\n      // 如果 source、query、cookie 都匹配\n      // 就返回 `x-authorized` 标头\n      {\n        source: '/specific/:path*',\n        has: [\n          {\n            type: 'query',\n            key: 'page',\n            value: 'home',\n          },\n          {\n            type: 'cookie',\n            key: 'authorized',\n            value: 'true',\n          },\n        ],\n        headers: [\n          {\n            key: 'x-authorized',\n            value: 'hello',\n          },\n        ],\n      },\n      //如果 header 中 `x-authorized` 存在且等于 yes 或 true\n      // 就返回 `x-another-header` 标头\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'header',\n            key: 'x-authorized',\n            value: '(?<authorized>yes|true)',\n          },\n        ],\n        headers: [\n          {\n            key: 'x-another-header',\n            value: ':authorized',\n          },\n        ],\n      },\n      // 如果 host 是 `example.com`,\n      // 应用 header\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'host',\n            value: 'example.com',\n          },\n        ],\n        headers: [\n          {\n            key: 'x-another-header',\n            value: 'hello',\n          },\n        ],\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"注意，has 和 missing 判断的都是请求头中的值。 type 的四种类型为 header、cookie、host、query，其中下图中的值都是 header："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:"image.png"})}),"\n",(0,r.jsx)(n.p,{children:"cookie 指的是其中的 Cookie 标头，Next.js 已经自动做了解析，所以可以直接判断 Cookie 中的字段值："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:"image (1).png"})}),"\n",(0,r.jsxs)(n.p,{children:["host 就是主机名 + 端口，query 表示参数。以 ",(0,r.jsx)(n.code,{children:"'http://user:pass@host.com:8080/p/a/t/h?query=string#hash'"}),"为例的话，",(0,r.jsx)(n.strong,{children:"host"})," 的值为 ",(0,r.jsx)(n.code,{children:"host.com:8080"}),"。",(0,r.jsx)(n.strong,{children:"query"})," 为 ",(0,r.jsx)(n.code,{children:"query=string"}),"。"]}),"\n",(0,r.jsxs)(n.h3,{id:"17-cache-control",children:["1.7. Cache-Control",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#17-cache-control",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["你不能在 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 中为页面或静态资源设置 ",(0,r.jsx)(n.code,{children:"Cache-Control"}),"标头，因为该标头会在生产中被覆盖，以确保有效缓存响应和静态资源。"]}),"\n",(0,r.jsxs)(n.h3,{id:"18-选项",children:["1.8. 选项",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#18-选项",children:"#"})]}),"\n",(0,r.jsxs)(n.h4,{id:"x-dns-prefetch-control",children:["X-DNS-Prefetch-Control",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#x-dns-prefetch-control",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/X-DNS-Prefetch-Control",target:"_blank",rel:"noopener noreferrer",children:"X-DNS-Prefetch-Control"}),"  头控制着浏览器的 DNS 预读取功能。DNS 预读取是一项使浏览器主动去执行域名解析的功能，其范围包括文档的所有链接，无论是图片的，CSS 的，还是 JavaScript 等其他用户能够点击的 URL。"]}),"\n",(0,r.jsx)(n.p,{children:"因为预读取会在后台执行，所以 DNS 很可能在链接对应的东西出现之前就已经解析完毕。这能够减少用户点击链接时的延迟。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:"{\n  key: 'X-DNS-Prefetch-Control',\n  value: 'on'\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"strict-transport-security",children:["Strict-Transport-Security",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#strict-transport-security",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Strict-Transport-Security",target:"_blank",rel:"noopener noreferrer",children:"Strict-Transport-Security"}),"（通常简称为 HSTS）响应标头用来通知浏览器应该只通过 HTTPS 访问该站点，并且以后使用 HTTP 访问该站点的所有尝试都应自动重定向到 HTTPS。"]}),"\n",(0,r.jsxs)(n.p,{children:["使用下面的配置，所有当前和未来的子域都将使用 ",(0,r.jsx)(n.code,{children:"max-age"})," 为 2 年的 HTTPS："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  key: 'Strict-Transport-Security',\n  value: 'max-age=63072000; includeSubDomains; preload'\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"x-frame-options",children:["X-Frame-Options",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#x-frame-options",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/X-Frame-Options",target:"_blank",rel:"noopener noreferrer",children:"X-Frame-Options"})," HTTP 响应头是用来给浏览器指示允许一个页面可否在 ",(0,r.jsx)(n.code,{children:"<frame>"}),"、",(0,r.jsx)(n.code,{children:"<iframe>"}),"、",(0,r.jsx)(n.code,{children:"<embed>"})," 或者 ",(0,r.jsx)(n.code,{children:"<object>"})," 中展现的标记。站点可以通过确保网站没有被嵌入到别人的站点里面，从而避免点击劫持 (en-US)攻击。"]}),"\n",(0,r.jsxs)(n.p,{children:["此标头已经被 ",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors",target:"_blank",rel:"noopener noreferrer",children:"frame-ancestors"})," 替代，它在现代浏览器中有更好的支持。"]}),"\n",(0,r.jsxs)(n.h4,{id:"permissions-policy",children:["Permissions-Policy",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#permissions-policy",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Permissions-Policy",target:"_blank",rel:"noopener noreferrer",children:"Permissions-Policy"}),"  响应标头提供了一种可以在本页面或包含的 iframe 上启用或禁止浏览器特性的机制，之前叫做 ",(0,r.jsx)(n.code,{children:"Feature-Policy"}),"。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:"{\n  key: 'Permissions-Policy',\n  value: 'camera=(), microphone=(), geolocation=(), browsing-topics=()'\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"x-content-type-options",children:["X-Content-Type-Options",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#x-content-type-options",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["如果 ",(0,r.jsx)(n.code,{children:"Content-Type"})," 标头没有被显示设置，",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/X-Content-Type-Options",target:"_blank",rel:"noopener noreferrer",children:"X-Content-Type-Options"})," 会阻止浏览器尝试猜测内容类型。这可以防止允许用户上传和共享文件的网站受到 XSS 攻击。"]}),"\n",(0,r.jsxs)(n.p,{children:["这个标头只有一个有效值是 ",(0,r.jsx)(n.code,{children:"nosniff"}),"。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:"{\n  key: 'X-Content-Type-Options',\n  value: 'nosniff'\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"referrer-policy",children:["Referrer-Policy",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#referrer-policy",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referrer-Policy",target:"_blank",rel:"noopener noreferrer",children:"Referrer-Policy"})," 控制当从当前网页导航到另一个网页时携带的信息内容："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:"{\n  key: 'Referrer-Policy',\n  value: 'origin-when-cross-origin'\n}\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"2-redirects",children:["2. redirects",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#2-redirects",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"21-介绍",children:["2.1. 介绍",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#21-介绍",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["重定向，顾名思义，将请求路径重定向到其他目标路径。配置重定向，使用 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 的 ",(0,r.jsx)(n.code,{children:"redirects"}),"，示例如下："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"module.exports = {\n  async redirects() {\n    return [\n      {\n        source: '/about',\n        destination: '/',\n        permanent: true,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"redirects"})," 是一个异步函数，该函数返回一个包含 ",(0,r.jsx)(n.code,{children:"source"}),"、",(0,r.jsx)(n.code,{children:"destination"})," 和 ",(0,r.jsx)(n.code,{children:"permanent"})," 属性的对象数组，其中："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"})," 表示传入的请求路径"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"destination"})," 表示你重定向的的目标路径"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"permanent"})," 值为 true 或者  false。如果为 true，使用 308 状态码，表示客户端或搜索引擎永久缓存重定向。如果是 false，使用 307 状态码表示临时未缓存。"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["为什么 Next.js 使用 307 和 308 呢？传统都是使用 302 表示临时重定向，301 表示永久重定向，但是很多浏览器会将重定向的请求方法修改为 GET，而不管原本的方法是什么。举个例子，如果浏览器发送了一个 POST 请求，",(0,r.jsx)(n.code,{children:"/v1/users"})," ，然后返回了 302 状态码，新地址是 ",(0,r.jsx)(n.code,{children:"/v2/users"}),"，则后续的请求会是 GET ",(0,r.jsx)(n.code,{children:"/V2/users"})," 而不是 POST ",(0,r.jsx)(n.code,{children:"/v2/users"}),"，Next.js 用 307 临时重定向和 308 永久重定向状态码就是为了显示保留之前使用的请求方法。"]}),"\n",(0,r.jsx)(n.p,{children:"除了这三个值外，还可以设置："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"basePath"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"。当值为 ",(0,r.jsx)(n.code,{children:"false"})," ，匹配时不会包含 ",(0,r.jsx)(n.code,{children:"basePath"}),"，只能用于外部重写"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"locale"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，匹配时是否应该包含 locale"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"has"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"missing"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["重定向会在文件系统（包括页面和 ",(0,r.jsx)(n.code,{children:"/public"})," 文件）之前被触发。"]}),"\n",(0,r.jsxs)(n.p,{children:["重定向不会应用于客户端路由（",(0,r.jsx)(n.code,{children:"Link"}),"、",(0,r.jsx)(n.code,{children:"router.push"}),"），除非使用了中间件，且有匹配的路径。"]}),"\n",(0,r.jsx)(n.p,{children:"当应用重定向的时候，请求路径的参数也会传递给重定向目标路径。举个例子："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  source: '/old-blog/:path*',\n  destination: '/blog/:path*',\n  permanent: false\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["当请求",(0,r.jsx)(n.code,{children:"/old-blog/post-1?hello=world"}),"时，客户端会重定向到 ",(0,r.jsx)(n.code,{children:"/blog/post-1?hello=world"}),"。"]}),"\n",(0,r.jsxs)(n.h3,{id:"22-source",children:["2.2. source",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#22-source",children:"#"})]}),"\n",(0,r.jsxs)(n.h4,{id:"路径匹配-1",children:["路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#路径匹配-1",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["普通的路径匹配，举个例子，比如 ",(0,r.jsx)(n.code,{children:"/old-blog/:slug"}),"会匹配 ",(0,r.jsx)(n.code,{children:"/old-blog/hello-world"}),"（无嵌套路径，也就是说 ",(0,r.jsx)(n.code,{children:"/old-blog/hello-world/about"}),"不会匹配）"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async redirects() {\n    return [\n      {\n        source: '/old-blog/:slug',\n        destination: '/news/:slug',\n        permanent: true,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"通配符路径匹配-1",children:["通配符路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#通配符路径匹配-1",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后使用 ",(0,r.jsx)(n.code,{children:"*"})," 实现通配符路径匹配，举个例子：",(0,r.jsx)(n.code,{children:"/blog/:slug*"})," 会匹配 ",(0,r.jsx)(n.code,{children:"/blog/a/b/c/d/hello-world"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async redirects() {\n    return [\n      {\n        source: '/blog/:slug*',\n        destination: '/news/:slug*',\n        permanent: true,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"正则表达式路径匹配-1",children:["正则表达式路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#正则表达式路径匹配-1",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后用括号将正则表达式括住实现正则表达式匹配，举个例子：",(0,r.jsx)(n.code,{children:"/post/:slug(\\\\d{1,})"})," 匹配 ",(0,r.jsx)(n.code,{children:"/post/123"})," 而不匹配 ",(0,r.jsx)(n.code,{children:"/post/abc"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async redirects() {\n    return [\n      {\n        source: '/post/:slug(\\\\d{1,})',\n        destination: '/news/:slug',\n        permanent: false,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["注意：这 8 个字符  ",(0,r.jsx)(n.code,{children:"("}),"、",(0,r.jsx)(n.code,{children:")"}),"、 ",(0,r.jsx)(n.code,{children:"{"}),"、 ",(0,r.jsx)(n.code,{children:"}"}),"、 ",(0,r.jsx)(n.code,{children:":"}),"、 ",(0,r.jsx)(n.code,{children:"*"}),"、 ",(0,r.jsx)(n.code,{children:"+"}),"、 ",(0,r.jsx)(n.code,{children:"?"})," 都会用于正则表达式匹配，所以需要用到这些字符本身的时候，使用 ",(0,r.jsx)(n.code,{children:"\\\\"}),"转义"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async redirects() {\n    return [\n      {\n        // 匹配 `/english(default)/something`\n        source: '/english\\\\(default\\\\)/:slug',\n        destination: '/en-us/:slug',\n        permanent: false,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"23-basepath",children:["2.3. basePath",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#23-basepath",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["当使用 ",(0,r.jsx)(n.code,{children:"basePath"})," 的时候，每一个 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 都会自动添加 ",(0,r.jsx)(n.code,{children:"basePath"})," 作为前缀，除非你为重定向设置 ",(0,r.jsx)(n.code,{children:"basePath: false"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  basePath: '/docs',\n \n  async redirects() {\n    return [\n      {\n        source: '/with-basePath', // 自动变成 /docs/with-basePath\n        destination: '/another', // 自动变成 /docs/another\n        permanent: false,\n      },\n      {\n        // does not add /docs since basePath: false is set\n        source: '/without-basePath',\n        destination: 'https://example.com',\n        basePath: false,\n        permanent: false,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"24-locale",children:["2.4. locale",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#24-locale",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["当使用 ",(0,r.jsx)(n.code,{children:"i18n"}),"的时候，每一个 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 都会自动根据 ",(0,r.jsx)(n.code,{children:"locales"}),"添加前缀进行处理，除非你为重定向设置 ",(0,r.jsx)(n.code,{children:"locale: false"}),"。如果设置 ",(0,r.jsx)(n.code,{children:"locale: false"}),"，你必须使用一个 ",(0,r.jsx)(n.code,{children:"locale"})," 作为 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 的前缀才能够正确匹配，让我们看个例子："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  i18n: {\n    locales: ['en', 'fr', 'de'],\n    defaultLocale: 'en',\n  },\n \n  async redirects() {\n    return [\n      {\n        // /with-locale -> /another\n        // /en/with-locale -> /en/another\n        // /fr/with-locale -> /fr/another\n        // /de/with-locale -> /de/another\n        source: '/with-locale',\n        destination: '/another',\n        permanent: false,\n      },\n      {\n        // 因为 locale 设置为 false，所以不会自动处理\n        // /nl/with-locale-manual -> /nl/another\n        source: '/nl/with-locale-manual',\n        destination: '/nl/another',\n        locale: false,\n        permanent: false,\n      },\n      {\n        // 因为 `en` 是 defaultLocale，所以匹配 '/'\n        // /en -> /en/another\n        // / -> /en/another\n        source: '/en',\n        destination: '/en/another',\n        locale: false,\n        permanent: false,\n      },\n      // 尽管 locale 设置为 false，但匹配所有 locale\n      // /page -> /en/newpage\n      // /en/page -> /en/newpage\n      // /fr/page -> /fr/newpage\n      // /de/page -> /de/newpage\n      {\n        source: '/:locale/page',\n        destination: '/en/newpage',\n        permanent: false,\n        locale: false,\n      },\n      {\n        // 转换为 /(en|fr|de)/(.*) 所以不会匹配 `/`\n        // /page -> /another2\n        // /fr/page -> /fr/another2\n        // 匹配 `\\` 或 `/fr` 使用 /:path*\n        source: '/(.*)',\n        destination: '/another2',\n        permanent: false,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"25-has-和-missing",children:["2.5. has 和 missing",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#25-has-和-missing",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 是用来处理请求中的 header、cookie 和请求参数是否匹配某些字段，或者不匹配某些字段的时候，才发生重定向。"]}),"\n",(0,r.jsxs)(n.p,{children:["举个例子，比如请求 ",(0,r.jsx)(n.code,{children:"/article?id=1&author=yayu"}),"，",(0,r.jsx)(n.code,{children:"has"})," 可以要求请求中必须有 id 参数，或者 id 参数等于 xxx 的时候才重定向。",(0,r.jsx)(n.code,{children:"missing"})," 可以要求请求中必须没有 id 参数，或者 id 参数不等于 xxx 的时候才重定向。"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 对象有下面这些字段："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"type"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，值为 ",(0,r.jsx)(n.code,{children:"header"}),"、",(0,r.jsx)(n.code,{children:"cookie"}),"、",(0,r.jsx)(n.code,{children:"host"}),"、",(0,r.jsx)(n.code,{children:"query"})," 之一"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"key"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，所选类型（也就是上面的四种值）中要匹配的 key"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"value"}),"： ",(0,r.jsx)(n.code,{children:"String"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，要检查的值。如果值为 ",(0,r.jsx)(n.code,{children:"undefiend"}),"，任何值都不会匹配。支持使用一个类似正则的字符串捕获值的特殊部分。比如 ",(0,r.jsx)(n.code,{children:"first-(?<paramName>.*)"}),"用于匹配 ",(0,r.jsx)(n.code,{children:"first-second"}),"，然后就可以用 ",(0,r.jsx)(n.code,{children:":paramName"}),"获取 ",(0,r.jsx)(n.code,{children:"second"})," 这个值"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"其实跟 headers 是一样的，只不是过一个是返回标头，一个是发生重定向。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async redirects() {\n    return [\n      // 如果 header `x-redirect-me` 存在,\n      // 才应用重定向\n      {\n        source: '/:path((?!another-page$).*)',\n        has: [\n          {\n            type: 'header',\n            key: 'x-redirect-me',\n          },\n        ],\n        permanent: false,\n        destination: '/another-page',\n      },\n      // 如果 `x-dont-redirect` 存在,\n      // 不会应用重定向\n      {\n        source: '/:path((?!another-page$).*)',\n        missing: [\n          {\n            type: 'header',\n            key: 'x-do-not-redirect',\n          },\n        ],\n        permanent: false,\n        destination: '/another-page',\n      },\n      // 如果 source, query, 和 cookie 匹配,\n      // 会应用重定向\n      {\n        source: '/specific/:path*',\n        has: [\n          {\n            type: 'query',\n            key: 'page',\n            value: 'home',\n          },\n          {\n            type: 'cookie',\n            key: 'authorized',\n            value: 'true',\n          },\n        ],\n        permanent: false,\n        destination: '/another/:path*',\n      },\n      // 如果 header `x-authorized` 存在，并且是 yes huozhe true,\n      // 会应用重定向\n      {\n        source: '/',\n        has: [\n          {\n            type: 'header',\n            key: 'x-authorized',\n            value: '(?<authorized>yes|true)',\n          },\n        ],\n        permanent: false,\n        destination: '/home?authorized=:authorized',\n      },\n      // 如果 host 是 `example.com`,\n      // 会应用重定向\n      {\n        source: '/:path((?!another-page$).*)',\n        has: [\n          {\n            type: 'host',\n            value: 'example.com',\n          },\n        ],\n        permanent: false,\n        destination: '/another-page',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"3-rewrites",children:["3. rewrites",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#3-rewrites",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"31-介绍",children:["3.1. 介绍",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#31-介绍",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["重写允许你将传入的请求路径映射到其他目标路径。它与重定向的不同之处在于，重写相当于扮演了 URL 代理的角色，会屏蔽目标路径，地址还是这个地址，但路由逻辑发生了变化。而重定向则是导航至新的页面，浏览器中的 URL 也会发生更改。配置重定向，使用 ",(0,r.jsx)(n.code,{children:"next.config.js"})," 的 ",(0,r.jsx)(n.code,{children:"rewrites"}),"，示例如下："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/about',\n        destination: '/',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["重写会应用于客户端路由，在这个例子中，如果使用",(0,r.jsx)(n.code,{children:'<Link href="/about">'})," 会应用重写。"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"rewrites"})," 是一个异步函数，该函数可以返回一个包含 ",(0,r.jsx)(n.code,{children:"source"}),"、",(0,r.jsx)(n.code,{children:"destination"})," 属性的对象数组，其中："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"})," 表示传入的请求路径"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"destination"})," 表示你重写的的目标路径"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"basePath"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"。当值为 ",(0,r.jsx)(n.code,{children:"false"})," ，匹配时不会包含 ",(0,r.jsx)(n.code,{children:"basePath"}),"，只能用于外部重写"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"locale"}),"：",(0,r.jsx)(n.code,{children:"false"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，匹配时是否应该包含 locale"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"has"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"missing"}),"：一个有 ",(0,r.jsx)(n.code,{children:"type"}),"、",(0,r.jsx)(n.code,{children:"key"}),"、",(0,r.jsx)(n.code,{children:"value"})," 属性的对象数组"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"如果返回的是这种数组，重写会在检查文件系统（页面和 /public 文件）之后和动态路由之前应用。"}),"\n",(0,r.jsx)(n.p,{children:"也可以返回一个具有特定属性的对象，这是为了实现更精细的控制，示例代码如下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return {\n      beforeFiles: [\n        // 在 headers/redirects 之后\n        // 在 _next/public files 文件之前触发\n        {\n          source: '/some-page',\n          destination: '/somewhere-else',\n          has: [{ type: 'query', key: 'overrideMe' }],\n        },\n      ],\n      afterFiles: [\n        // 在 pages/public 之后，在动态路由之前触发\n        {\n          source: '/non-existent',\n          destination: '/somewhere-else',\n        },\n      ],\n      fallback: [\n        // 在 pages/public files 和动态路由之后触发\n        {\n          source: '/:path*',\n          destination: `https://my-old-site.com/:path*`,\n        },\n      ],\n    }\n  },\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"这个时候就要说到 Next.js 的路由的检查顺序是："}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"headers"}),"\n",(0,r.jsx)(n.li,{children:"redirects"}),"\n",(0,r.jsx)(n.li,{children:"beforeFiles 重写"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"public"})," 目录下的静态文件、",(0,r.jsx)(n.code,{children:"_next/static"})," 文件、非动态的页面"]}),"\n",(0,r.jsx)(n.li,{children:"afterFiles 重写，如果每次匹配，"}),"\n",(0,r.jsx)(n.li,{children:"fallback 重写，会在渲染 404 页面之前和动态路由、所有静态资源检查前被引用"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"32-重写参数",children:["3.2. 重写参数",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#32-重写参数",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["如果 ",(0,r.jsx)(n.code,{children:"destination"}),"没有使用参数（例子中的",(0,r.jsx)(n.code,{children:":path*"}),"），那么 ",(0,r.jsx)(n.code,{children:"source"})," 的中的参数会以查询字符串的形式（query）默认传递给 ",(0,r.jsx)(n.code,{children:"destination"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/old-about/:path*',\n        destination: '/about',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["假设 ",(0,r.jsx)(n.code,{children:"app/about/page.js"}),"的代码为："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// app/about/page.js\nexport default function Page(props) {\n  console.dir(props)\n  return  <h1>Hello About!</h1>\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/old-about/article?id=1"}),"，打印的值为："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:"image.png"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"source"})," 中的参数 article 可以在 searchParams 中查到。"]}),"\n",(0,r.jsxs)(n.p,{children:["如果 ",(0,r.jsx)(n.code,{children:"destination"}),"使用了参数，则不会自动传递任何参数："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/docs/:path*',\n        destination: '/:path*',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/docs/about?id=1"}),"，打印的值为："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:"image.png"})}),"\n",(0,r.jsxs)(n.p,{children:["如果 ",(0,r.jsx)(n.code,{children:"destination"}),"使用了参数，你依然可以手动传递参数："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/:first/:second',\n        destination: '/:first?second=:second'\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["在这个例子中，因为 ",(0,r.jsx)(n.code,{children:"destination"})," 使用了 ",(0,r.jsx)(n.code,{children:":first"})," 参数，所以 ",(0,r.jsx)(n.code,{children:":second"})," 参数不会自动被添加到 query 中，但我们可以通过例子中的方式手动添加，使得能够在 query 中获取。"]}),"\n",(0,r.jsxs)(n.p,{children:["访问 ",(0,r.jsx)(n.code,{children:"/about/article?id=1"}),"，打印的值为："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:"image.png"})}),"\n",(0,r.jsxs)(n.h3,{id:"33-source",children:["3.3. source",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#33-source",children:"#"})]}),"\n",(0,r.jsxs)(n.h4,{id:"路径匹配-2",children:["路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#路径匹配-2",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["普通的路径匹配，举个例子，比如 ",(0,r.jsx)(n.code,{children:"/blog/:slug"}),"会匹配 ",(0,r.jsx)(n.code,{children:"/blog/hello-world"}),"（无嵌套路径，也就是说 ",(0,r.jsx)(n.code,{children:"/blog/hello-world/about"}),"不会匹配）"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/blog/:slug',\n        destination: '/news/:slug',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"通配符路径匹配-2",children:["通配符路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#通配符路径匹配-2",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后使用 ",(0,r.jsx)(n.code,{children:"*"})," 实现通配符路径匹配，举个例子：",(0,r.jsx)(n.code,{children:"/blog/:slug*"})," 会匹配 ",(0,r.jsx)(n.code,{children:"/blog/a/b/c/d/hello-world"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/blog/:slug*',\n        destination: '/news/:slug*', // Matched parameters can be used in the destination\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"333-正则表达式路径匹配",children:["3.3.3. 正则表达式路径匹配",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#333-正则表达式路径匹配",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在参数后用括号将正则表达式括住实现正则表达式匹配，举个例子：",(0,r.jsx)(n.code,{children:"/post/:slug(\\\\d{1,})"})," 匹配 ",(0,r.jsx)(n.code,{children:"/post/123"})," 而不匹配 ",(0,r.jsx)(n.code,{children:"/post/abc"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/old-blog/:post(\\\\d{1,})',\n        destination: '/blog/:post',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["注意：这 8 个字符  ",(0,r.jsx)(n.code,{children:"("}),"、",(0,r.jsx)(n.code,{children:")"}),"、 ",(0,r.jsx)(n.code,{children:"{"}),"、 ",(0,r.jsx)(n.code,{children:"}"}),"、 ",(0,r.jsx)(n.code,{children:":"}),"、 ",(0,r.jsx)(n.code,{children:"*"}),"、 ",(0,r.jsx)(n.code,{children:"+"}),"、 ",(0,r.jsx)(n.code,{children:"?"})," 都会用于正则表达式匹配，所以需要用到这些字符本身的时候，使用 ",(0,r.jsx)(n.code,{children:"\\\\"}),"转义"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        // this will match `/english(default)/something` being requested\n        source: '/english\\\\(default\\\\)/:slug',\n        destination: '/en-us/:slug',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"34-basepath",children:["3.4. basePath",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#34-basepath",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["当使用 ",(0,r.jsx)(n.code,{children:"basePath"})," 的时候，每一个 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 都会自动添加 ",(0,r.jsx)(n.code,{children:"basePath"})," 作为前缀，除非你为重写设置 ",(0,r.jsx)(n.code,{children:"basePath: false"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  basePath: '/docs',\n \n  async rewrites() {\n    return [\n      {\n        source: '/with-basePath', // 自动变成 /docs/with-basePath\n        destination: '/another', // 自动变成 /docs/another\n      },\n      {\n        // 不会添加 /docs 到 /without-basePath 因为 basePath 设置为 false \n        source: '/without-basePath',\n        destination: 'https://example.com',\n        basePath: false,\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"35-locale",children:["3.5. locale",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#35-locale",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["当使用 ",(0,r.jsx)(n.code,{children:"i18n"}),"的时候，每一个 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 都会自动根据 ",(0,r.jsx)(n.code,{children:"locales"}),"添加前缀进行处理，除非你为重写设置 ",(0,r.jsx)(n.code,{children:"locale: false"}),"。如果设置 ",(0,r.jsx)(n.code,{children:"locale: false"}),"，你必须使用一个 ",(0,r.jsx)(n.code,{children:"locale"})," 作为 ",(0,r.jsx)(n.code,{children:"source"})," 和 ",(0,r.jsx)(n.code,{children:"destination"})," 的前缀才能够正确匹配，让我们看个例子："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  i18n: {\n    locales: ['en', 'fr', 'de'],\n    defaultLocale: 'en',\n  },\n \n  async rewrites() {\n    return [\n      {\n        // /with-locale -> /another\n        // /en/with-locale -> /en/another\n        // /fr/with-locale -> /fr/another\n        // /de/with-locale -> /de/another\n        source: '/with-locale',\n        destination: '/another',\n      },\n      {\n        // 因为 locale 设置为 false，所以不会自动处理\n        // /nl/with-locale-manual -> /nl/another\n        source: '/nl/with-locale-manual',\n        destination: '/nl/another',\n        locale: false,\n      },\n      {\n        // 因为 `en` 是 defaultLocale，所以匹配 '/'\n        // /en -> /en/another\n        // / -> /en/another\n        source: '/en',\n        destination: '/en/another',\n        locale: false\n      },\n      // 尽管 locale 设置为 false，但匹配所有 locale\n      {\n        source: '/:locale/api-alias/:path*',\n        destination: '/api/:path*',\n        locale: false,\n      },\n      {\n        // 转换为 /(en|fr|de)/(.*) 所以不会匹配 `/`\n        // /page -> /another\n        // /fr/page -> /fr/another\n        // 匹配 `\\` 或 `/fr` 使用 /:path*\n				source: '/(.*)',\n        destination: '/another',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"36-has-和-missing",children:["3.6. has 和 missing",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#36-has-和-missing",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 是用来处理请求中的 header、cookie 和请求参数是否匹配某些字段，或者不匹配某些字段的时候，才发生重写。"]}),"\n",(0,r.jsxs)(n.p,{children:["举个例子，比如请求 ",(0,r.jsx)(n.code,{children:"/article?id=1&author=yayu"}),"，",(0,r.jsx)(n.code,{children:"has"})," 可以要求请求中必须有 id 参数，或者 id 参数等于 xxx 的时候才重写。",(0,r.jsx)(n.code,{children:"missing"})," 可以要求请求中必须没有 id 参数，或者 id 参数不等于 xxx 的时候才重写。"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"has"})," 和 ",(0,r.jsx)(n.code,{children:"missing"})," 对象有下面这些字段："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"type"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，值为 ",(0,r.jsx)(n.code,{children:"header"}),"、",(0,r.jsx)(n.code,{children:"cookie"}),"、",(0,r.jsx)(n.code,{children:"host"}),"、",(0,r.jsx)(n.code,{children:"query"})," 之一"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"key"}),": ",(0,r.jsx)(n.code,{children:"String"}),"类型，所选类型（也就是上面的四种值）中要匹配的 key"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"value"}),"： ",(0,r.jsx)(n.code,{children:"String"})," 或者 ",(0,r.jsx)(n.code,{children:"undefined"}),"，要检查的值。如果值为 ",(0,r.jsx)(n.code,{children:"undefiend"}),"，任何值都不会匹配。支持使用一个类似正则的字符串捕获值的特殊部分。比如 ",(0,r.jsx)(n.code,{children:"first-(?<paramName>.*)"}),"用于匹配 ",(0,r.jsx)(n.code,{children:"first-second"}),"，然后就可以用 ",(0,r.jsx)(n.code,{children:":paramName"}),"获取 ",(0,r.jsx)(n.code,{children:"second"})," 这个值"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"其实跟 redirects 是一样的，只不是过一个是重定向，一个是重写。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      // 如果 header `x-rewrite-me` 存在,\n      // 会应用重写\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'header',\n            key: 'x-rewrite-me',\n          },\n        ],\n        destination: '/another-page',\n      },\n      // 如果 `x-rewrite-me` 不存在\n      // 会应用重写\n      {\n        source: '/:path*',\n        missing: [\n          {\n            type: 'header',\n            key: 'x-rewrite-me',\n          },\n        ],\n        destination: '/another-page',\n      },\n      // 如果 source, query, 和 cookie 匹配,\n      // 会应用重写\n      {\n        source: '/specific/:path*',\n        has: [\n          {\n            type: 'query',\n            key: 'page',\n            value: 'home',\n          },\n          {\n            type: 'cookie',\n            key: 'authorized',\n            value: 'true',\n          },\n        ],\n        destination: '/:path*/home',\n      },\n      // 如果 header `x-authorized` 存在且为 yes 或 true\n      // 会应用重写\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'header',\n            key: 'x-authorized',\n            value: '(?<authorized>yes|true)',\n          },\n        ],\n        destination: '/home?authorized=:authorized',\n      },\n      // 如果 host 是 `example.com`,\n      // 会应用重写\n      {\n        source: '/:path*',\n        has: [\n          {\n            type: 'host',\n            value: 'example.com',\n          },\n        ],\n        destination: '/another-page',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"37-重写到外部-url",children:["3.7. 重写到外部 URL",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#37-重写到外部-url",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["rewrites 可以重写到外部 url，这在增量采用 Next.js 的项目中特别有用，比如这个例子就是将应用中的 ",(0,r.jsx)(n.code,{children:"/blog"})," 路由全部重写到外部网址："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return [\n      {\n        source: '/blog',\n        destination: 'https://example.com/blog',\n      },\n      {\n        source: '/blog/:slug',\n        destination: 'https://example.com/blog/:slug',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["如果设置了 ",(0,r.jsx)(n.code,{children:"trailingSlash:true"}),"，你也需要在 ",(0,r.jsx)(n.code,{children:"source"})," 中插入一个尾部斜杠。如果目标地址也需要尾部斜杠，也应该包含在 ",(0,r.jsx)(n.code,{children:"destination"})," 参数中。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  trailingSlash: true,\n  async rewrites() {\n    return [\n      {\n        source: '/blog/',\n        destination: 'https://example.com/blog/',\n      },\n      {\n        source: '/blog/:path*/',\n        destination: 'https://example.com/blog/:path*/',\n      },\n    ]\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"38-增量采用-nextjs",children:["3.8. 增量采用 Next.js",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#38-增量采用-nextjs",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"可以让 Next.js 在检查所有 Next.js 路由后，如果没有对应的路由，那就代理现有的网站。这样你将更多页面迁移成 Next.js 时，就无需重写配置："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// next.config.js\nmodule.exports = {\n  async rewrites() {\n    return {\n      fallback: [\n        {\n          source: '/:path*',\n          destination: `https://custom-routes-proxying-endpoint.vercel.app/:path*`,\n        },\n      ],\n    }\n  },\n}\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"参考链接",children:["参考链接",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#参考链接",children:"#"})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://nextjs.org/docs/app/api-reference/next-config-js",target:"_blank",rel:"noopener noreferrer",children:"https://nextjs.org/docs/app/api-reference/next-config-js"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://nextjs.org/docs/app/api-reference/next-config-js/headers",target:"_blank",rel:"noopener noreferrer",children:"https://nextjs.org/docs/app/api-reference/next-config-js/headers"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://nextjs.org/docs/app/api-reference/next-config-js/redirects",target:"_blank",rel:"noopener noreferrer",children:"https://nextjs.org/docs/app/api-reference/next-config-js/redirects"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://nextjs.org/docs/app/api-reference/next-config-js/rewrites",target:"_blank",rel:"noopener noreferrer",children:"https://nextjs.org/docs/app/api-reference/next-config-js/rewrites"})}),"\n"]})]})}function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(j,{...e})}):j(e)}let u=p;p.__RSPRESS_PAGE_META={},p.__RSPRESS_PAGE_META["Next.js%20%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97%2F33.API%20%E7%AF%87%20_%20next.config.js%EF%BC%88%E4%B8%8A%EF%BC%89.md"]={toc:[{text:"前言",id:"前言",depth:2},{text:"1. headers",id:"1-headers",depth:2},{text:"1.1. 介绍",id:"11-介绍",depth:3},{text:"1.2. source",id:"12-source",depth:3},{text:"路径匹配",id:"路径匹配",depth:4},{text:"通配符路径匹配",id:"通配符路径匹配",depth:4},{text:"正则表达式路径匹配",id:"正则表达式路径匹配",depth:4},{text:"1.3. headers",id:"13-headers",depth:3},{text:"1.4. basePath",id:"14-basepath",depth:3},{text:"1.5. locale",id:"15-locale",depth:3},{text:"1.6. has 和 missing",id:"16-has-和-missing",depth:3},{text:"1.7. Cache-Control",id:"17-cache-control",depth:3},{text:"1.8. 选项",id:"18-选项",depth:3},{text:"X-DNS-Prefetch-Control",id:"x-dns-prefetch-control",depth:4},{text:"Strict-Transport-Security",id:"strict-transport-security",depth:4},{text:"X-Frame-Options",id:"x-frame-options",depth:4},{text:"Permissions-Policy",id:"permissions-policy",depth:4},{text:"X-Content-Type-Options",id:"x-content-type-options",depth:4},{text:"Referrer-Policy",id:"referrer-policy",depth:4},{text:"2. redirects",id:"2-redirects",depth:2},{text:"2.1. 介绍",id:"21-介绍",depth:3},{text:"2.2. source",id:"22-source",depth:3},{text:"路径匹配",id:"路径匹配-1",depth:4},{text:"通配符路径匹配",id:"通配符路径匹配-1",depth:4},{text:"正则表达式路径匹配",id:"正则表达式路径匹配-1",depth:4},{text:"2.3. basePath",id:"23-basepath",depth:3},{text:"2.4. locale",id:"24-locale",depth:3},{text:"2.5. has 和 missing",id:"25-has-和-missing",depth:3},{text:"3. rewrites",id:"3-rewrites",depth:2},{text:"3.1. 介绍",id:"31-介绍",depth:3},{text:"3.2. 重写参数",id:"32-重写参数",depth:3},{text:"3.3. source",id:"33-source",depth:3},{text:"路径匹配",id:"路径匹配-2",depth:4},{text:"通配符路径匹配",id:"通配符路径匹配-2",depth:4},{text:"3.3.3. 正则表达式路径匹配",id:"333-正则表达式路径匹配",depth:4},{text:"3.4. basePath",id:"34-basepath",depth:3},{text:"3.5. locale",id:"35-locale",depth:3},{text:"3.6. has 和 missing",id:"36-has-和-missing",depth:3},{text:"3.7. 重写到外部 URL",id:"37-重写到外部-url",depth:3},{text:"3.8. 增量采用 Next.js",id:"38-增量采用-nextjs",depth:3},{text:"参考链接",id:"参考链接",depth:2}],title:"33.API 篇 _ next.config.js（上）",headingTitle:"33.API 篇 _ next.config.js（上）",frontmatter:{}}}}]);