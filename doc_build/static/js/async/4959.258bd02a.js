"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["4959"],{235762:function(n,e,a){a.r(e),a.d(e,{default:()=>O});var t=a(552676),c=a(740453);let i=a.p+"static/image/dab15a9f03038f608a1f23a7471b7746.512d5cce.webp",r=a.p+"static/image/0d3f28944ef555c4adb24b08b806d738.f6368d29.webp",s=a.p+"static/image/0e5384be6a8a4c2cd9b275ab16d55a76.89135247.webp",l=a.p+"static/image/e1f0f26712397c3727a2556a79573d35.813bec31.webp",d=a.p+"static/image/2c1d97ca05e1026fc5deca5569eab457.8012628f.webp",p=a.p+"static/image/30fd76071345c12c4d256c2ae0fbad74.88240a77.webp",o=a.p+"static/image/ca68bd3b332e4aa613982f5a2421ba05.d2609d88.webp",g=a.p+"static/image/72da3a2cc7770b15ff0e7dcc27d1f3ee.86ad5d5d.webp",h=a.p+"static/image/bcfc84f26b9c2b31dca163ead5953f17.2b3f7a8d.webp",j=a.p+"static/image/b3fafaff9874a92343827722dd8b02b4.53725003.webp",x=a.p+"static/image/b06f9f82bbe197349d54e4d9f17fc5d4.427883d0.webp",m=a.p+"static/image/e3ff8329b2d96f65bbf9a6be0a39e15a.fee701b4.webp",b=a.p+"static/image/b34e57fdaed637568889cb17f8590f36.2cc4c3cc.webp",f=a.p+"static/image/c17e09a807d6868100ee5fa61c1ad477.2356bcc2.webp",u=a.p+"static/image/6b293d19037767a1980d8702a4c47a57.516b1a57.webp",A=a.p+"static/image/0481dc5abc4ee37fbd4397967c5f843f.043c8fe4.webp",y=a.p+"static/image/507250e0f77b22b35a2f4b822f3d843a.515cf0ab.webp",w=a.p+"static/image/5ed489a97e6868eba3823c3715d31079.dc15c091.webp",M=a.p+"static/image/45de6c596acd79f357ddac122f6fb10f.cddb1c3e.webp",D=a.p+"static/image/9ef4ff7e3a8df92e4b367de5222e6186.c77847c6.webp",S=a.p+"static/image/cf72ed9979aa936d9701c6ff90d0a903.c682f642.webp",E=a.p+"static/image/bcd1060c64c2b545648067c4ecde01d9.2974a234.webp",P=a.p+"static/image/8679bfbc03f35eca58c4828c19b3dd48.48b14adb.webp",v=a.p+"static/image/f2ffdb120987470a9048006ad7c22aa0.3d3420ed.webp",T=a.p+"static/image/4538748b6c3f39c3521e23b93b9a4e9c.3d34c1d5.webp",U=a.p+"static/image/ff5a4545ccc644ec846454b9ceca9476.5ecf8875.webp";function J(n){let e=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,c.ah)(),n.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(e.h1,{id:"57-typeorm-多对多的映射和关联-crud",children:["57. TypeORM 多对多的映射和关联 CRUD",(0,t.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#57-typeorm-多对多的映射和关联-crud",children:"#"})]}),"\n",(0,t.jsx)(e.p,{children:"一对一我们是通过 @OneToOne 和 @JoinColumn 来把 Entity 映射成数据库表："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:U,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"Entity 之间的引用关系，转换为数据库表之间的外键关联的关系。"}),"\n",(0,t.jsx)(e.p,{children:"一对多我们是通过 @OneToMany 和 @ManyToOne 来把 Entity 映射成数据库表："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:T,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"它并不需要 @JoinColumn 来指定外键列，因为外键一定在多的那一边。"}),"\n",(0,t.jsx)(e.p,{children:"那多对多呢？"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:v,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"前面讲过，在数据库里，我们是通过中间表来保存这种多对多的关系的："}),"\n",(0,t.jsx)(e.p,{children:"把多对多拆成了两个一对多："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:P,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"那在 TypeORM 里如何映射这种关系呢？"}),"\n",(0,t.jsx)(e.p,{children:"我们新建个项目试一下："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"npx typeorm@latest init --name typeorm-relation-mapping3 --database mysql\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:E,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"进入项目目录，安装驱动包 mysql2："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"npm install mysql2\n"})}),"\n",(0,t.jsx)(e.p,{children:"然后修改 data-source.ts 的配置："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:'import "reflect-metadata"\nimport { DataSource } from "typeorm"\nimport { User } from "./entity/User"\n\nexport const AppDataSource = new DataSource({\n    type: "mysql",\n    host: "localhost",\n    port: 3306,\n    username: "root",\n    password: "guang",\n    database: "typeorm_test",\n    synchronize: true,\n    logging: true,\n    entities: [User],\n    migrations: [],\n    subscribers: [],\n    poolSize: 10,\n    connectorPackage: \'mysql2\',\n    extra: {\n        authPlugin: \'sha256_password\',\n    }\n})\n'})}),"\n",(0,t.jsx)(e.p,{children:"这次我们创建 Article 和 Tag 两个实体："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"npx typeorm entity:create src/entity/Article\nnpx typeorm entity:create src/entity/Tag\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:S,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"添加一些属性："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"import { Column, Entity, PrimaryGeneratedColumn } from \"typeorm\"\n\n@Entity()\nexport class Article {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 100,\n        comment: '文章标题'\n    })\n    title: string;\n\n    @Column({\n        type: 'text',\n        comment: '文章内容'\n    })\n    content: string;\n}\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:'import { Column, Entity, PrimaryGeneratedColumn } from "typeorm"\n\n@Entity()\nexport class Tag {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 100\n    })\n    name: string;\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"然后在 data-source.ts 里引入这俩 Entity："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:D,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"把 index.ts 的代码去掉："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:M,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"然后 npm run start"}),"\n",(0,t.jsx)(e.p,{children:"可以看到它生成了两个 Entity 的建表 sql："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:w,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"然后把这两个表删掉，我们来添加多对多的关联关系："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:y,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"在 Entity 里通过 @ManyToMany 关联。"}),"\n",(0,t.jsx)(e.p,{children:"比如一篇文章可以有多个标签："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:A,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"然后再 npm run start"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:u,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"你会看到 3 条建表 sql，分别是 article、tag 和中间表 article_tags_tag"}),"\n",(0,t.jsx)(e.p,{children:"并且 article_tags_tag 还有 2 个外键分别引用着两个表。"}),"\n",(0,t.jsx)(e.p,{children:"级联删除和级联更新都是 CASCADE，也就是说这两个表的记录删了，那它在中间表中的记录也会跟着被删。"}),"\n",(0,t.jsx)(e.p,{children:"就这样就映射成功了。"}),"\n",(0,t.jsx)(e.p,{children:"你也可以自己指定中间表的名字："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:f,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"我们插入点数据试试："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"import { AppDataSource } from \"./data-source\"\nimport { Article } from \"./entity/Article\"\nimport { Tag } from \"./entity/Tag\";\n\nAppDataSource.initialize().then(async () => {\n\n    const a1 = new Article();\n    a1.title = 'aaaa';\n    a1.content = 'aaaaaaaaaa';\n\n    const a2 = new Article();\n    a2.title = 'bbbbbb';\n    a2.content = 'bbbbbbbbbb';\n\n    const t1 = new Tag();\n    t1.name = 'ttt1111';\n\n    const t2 = new Tag();\n    t2.name = 'ttt2222';\n\n    const t3 = new Tag();\n    t3.name = 'ttt33333';\n\n    a1.tags = [t1,t2];\n    a2.tags = [t1,t2,t3];\n\n    const entityManager = AppDataSource.manager;\n\n    await entityManager.save(t1);\n    await entityManager.save(t2);\n    await entityManager.save(t3);\n\n    await entityManager.save(a1);\n    await entityManager.save(a2);\n\n}).catch(error => console.log(error))\n"})}),"\n",(0,t.jsx)(e.p,{children:"创建了两篇文章，3 个标签，建立它们的关系之后，先保存所有的 tag，再保存 article。"}),"\n",(0,t.jsx)(e.p,{children:"跑一下："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"可以看到，3 个标签、2 篇文章，还有两者的关系，都插入成功了。"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:m,alt:""})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:j,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"再来查询："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"const article = await entityManager.find(Article, {\n    relations: {\n        tags: true\n    }\n});\n\nconsole.log(article);\nconsole.log(article.map(item=> item.tags))\n"})}),"\n",(0,t.jsx)(e.p,{children:"同样是通过 relations 指定关联查询："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:h,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"也可以手动用 query builder 来 join 查询："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:'const article = await entityManager\n    .createQueryBuilder(Article, "a")\n    .leftJoinAndSelect("a.tags", "t")\n    .getMany()\n    \nconsole.log(article);\nconsole.log(article.map(item=> item.tags))\n'})}),"\n",(0,t.jsx)(e.p,{children:"结果一样："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:g,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"或者先拿到 Article 的 Repository 再创建 query builder 来查询也行："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:'const article = await entityManager\n    .getRepository(Article)\n    .createQueryBuilder( "a")\n    .leftJoinAndSelect("a.tags", "t")\n    .getMany()\n\nconsole.log(article);\nconsole.log(article.map(item=> item.tags))\n'})}),"\n",(0,t.jsx)(e.p,{children:"那如果文章多加了一些标签或者删除了一些标签，怎么修改呢？"}),"\n",(0,t.jsx)(e.p,{children:"比如我把 id 为 2 的文章的标签只保留包含 111 的，并且还改了标题："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"const article = await entityManager.findOne(Article, {\n    where: {\n        id: 2\n    },\n    relations: {\n        tags: true\n    }\n});\n\narticle.title = \"ccccc\";\n\narticle.tags = article.tags.filter(item => item.name.includes('ttt111'));\n\nawait entityManager.save(article);\n"})}),"\n",(0,t.jsx)(e.p,{children:"之前它是有 3 个标签的："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(e.p,{children:"npm run start 跑一下："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:o,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"它会先查出 id 为 2 的 article 有哪些标签，查出了 1、2、3。"}),"\n",(0,t.jsx)(e.p,{children:"然后会把他和 id 为 2 的 article 的关系，(2, 2) (2, 3) 从中间表中删除。"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(e.p,{children:"这样就这个 article 就只有 id 为 1 的 tag 了。"}),"\n",(0,t.jsx)(e.p,{children:"此外，更新 article.title 的是另一个 update 语句："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:p,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"至于删除就简单了，因为中间表的外键设置了 CASCADE 的级联删除，这样只要你删除了 article 或者 tag，它都会跟着删除关联记录。"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"await entityManager.delete(Article, 1);\nawait entityManager.delete(Tag, 1);\n"})}),"\n",(0,t.jsx)(e.p,{children:"如果 tag 里也想有文章的引用呢？"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:d,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"那就加一个 @ManyToMany 的映射属性。"}),"\n",(0,t.jsx)(e.p,{children:"只不过它还需要第二个参数指定外键列在哪里。"}),"\n",(0,t.jsx)(e.p,{children:"而且不止这里要加，article 里也要加："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:l,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"为什么呢？"}),"\n",(0,t.jsx)(e.p,{children:"因为如果当前 Entity 对应的表是包含外键的，那它自然就知道怎么找到关联的 Entity。"}),"\n",(0,t.jsx)(e.p,{children:"但如果当前 Entity 是不包含外键的那一方，怎么找到对方呢？"}),"\n",(0,t.jsx)(e.p,{children:"这时候就需要手动指定通过哪个外键列来找当前 Entity 了。"}),"\n",(0,t.jsx)(e.p,{children:"之前 OneToOne、OnToMany 都是这样："}),"\n",(0,t.jsx)(e.p,{children:"比如一对一的 user 那方，不维护外键，所以需要第二个参数来指定通过哪个外键找到 user。"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:s,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"一对多的 department 那方，不维护外键，所以需要第二个参数来指定通过哪个外键找到 department："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:r,alt:""})}),"\n",(0,t.jsx)(e.p,{children:"而多对多的时候，双方都不维护外键，所以都需要第二个参数来指定外键列在哪里，怎么找到当前 Entity。"}),"\n",(0,t.jsx)(e.p,{children:"然后我们通过 tag 来关联查询下："}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"const tags = await entityManager.find(Tag, {\n    relations: {\n        articles: true\n    }\n});\n\nconsole.log(tags);\n"})}),"\n",(0,t.jsx)(e.p,{children:"也是能成功关联查出来的："}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)("img",{src:i,alt:""})}),"\n",(0,t.jsxs)(e.p,{children:["案例代码在",(0,t.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/typeorm-relation-mapping3",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,t.jsxs)(e.h2,{id:"总结",children:["总结",(0,t.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,t.jsx)(e.p,{children:"这节我们学了多对多关系在 Entity 里怎么映射，是通过 @ManyToMany 和 @JoinTable 来声明的。"}),"\n",(0,t.jsx)(e.p,{children:"但如果双方都保留了对方的引用，需要第二个参数来指定关联的外键列在哪，也就是如何查找当前 entity。"}),"\n",(0,t.jsx)(e.p,{children:"多对多关系的修改只要查出来之后修改下属性，然后 save，TypeORM 会自动去更新中间表。"}),"\n",(0,t.jsx)(e.p,{children:"至此，一对一、一对多、多对多关系的 Entity 如何映射到数据库的 table，如何增删改查，我们就都学会了。"})]})}function N(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,c.ah)(),n.components);return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(J,{...n})}):J(n)}let O=N;N.__RSPRESS_PAGE_META={},N.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F57.%20TypeORM%20%E5%A4%9A%E5%AF%B9%E5%A4%9A%E7%9A%84%E6%98%A0%E5%B0%84%E5%92%8C%E5%85%B3%E8%81%94%20CRUD.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"57. TypeORM 多对多的映射和关联 CRUD",headingTitle:"57. TypeORM 多对多的映射和关联 CRUD",frontmatter:{}}}}]);