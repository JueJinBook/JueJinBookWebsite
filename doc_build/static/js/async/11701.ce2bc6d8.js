"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["11701"],{119236:function(e,s,n){n.r(s),n.d(s,{default:()=>k});var r=n(552676),t=n(740453);let a=n.p+"static/image/d7f997d8ee38089018f1ee16432a11d3.c7aa1aaf.webp",i=n.p+"static/image/dfd7e42371fd06929115e5421c7572f6.c7391969.webp",c=n.p+"static/image/a4417da7b31abfc8f71d2e26a9918101.454bce6e.webp",p=n.p+"static/image/27fa844bef40901e4c30ca71250bcfaf.4d96cc19.webp",l=n.p+"static/image/aca779ac1d57f1189f63337490e895fc.ce72bdba.webp",d=n.p+"static/image/07a8060d309d04bb79ccc71c2b7c653b.dd5970de.webp",h=n.p+"static/image/8b9ad94941e65c0b7b11dba9d8dec9c8.6e788c63.webp",f=n.p+"static/image/5e37682c38f4682433b402bfdc6f6eea.aebaa4d3.webp",j=n.p+"static/image/3681666edb26124736bab60c48a6f68b.e4fcd492.webp",x=n.p+"static/image/a0d0abe1c3860c06043cb83d259d3c77.db2629ce.webp",o=n.p+"static/image/9cc4881727c5dfeed5f295ff90c83c7d.eb923f4a.webp",A=n.p+"static/image/267642f86ae38a5d6dfc2525c7a36bc3.d3d2ff55.webp",b=n.p+"static/image/8bab69b9b7f043c973e817edf62f5ac5.6f6b418c.webp",u=n.p+"static/image/26481fa7b0126a6a7f842df2c287551b.398c2c5e.webp",g=n.p+"static/image/bbd1e85ced8351e8386ecbf49207923e.3ad27656.webp",m=n.p+"static/image/2d9a21fc0567fe7f1a265156c2182567.622a6c7b.webp",v=n.p+"static/image/a64f57f6654661b724767157fce9f439.c8264637.webp";function N(e){let s=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",ul:"ul",li:"li",h2:"h2"},(0,t.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.h1,{id:"17-nest-和-express-的关系如何切到-fastify",children:["17. Nest 和 Express 的关系，如何切到 fastify",(0,r.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#17-nest-和-express-的关系如何切到-fastify",children:"#"})]}),"\n",(0,r.jsx)(s.p,{children:"前面我们用的 Nest 的 request、response 对象都是 Express 的，而且 Nest 也支持 Express 的中间件机制。"}),"\n",(0,r.jsx)(s.p,{children:"那 Nest 和 Express 是什么关系呢？"}),"\n",(0,r.jsx)(s.p,{children:"Express 是一个处理请求、响应的库，它是这样用的："}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-javascript",children:"const express = require('express')\nconst cookieParser = require('cookie-parser')\nconst cookieValidator = require('./cookieValidator')\n\nconst app = express()\n\nasync function validateCookies (req, res, next) {\n  await cookieValidator(req.cookies)\n  next()\n}\n\napp.use(cookieParser())\n\napp.use(validateCookies)\n\napp.use((err, req, res, next) => {\n  res.status(400).send(err.message)\n})\n\napp.listen(3000)\n"})}),"\n",(0,r.jsx)(s.p,{children:"通过 use 一个个中间件来处理请求、返回响应。"}),"\n",(0,r.jsx)(s.p,{children:"这种调用链叫做洋葱模型："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"基于中间件能完成各种功能。"}),"\n",(0,r.jsx)(s.p,{children:"但是 Express 只是一个处理请求的库，并没有提供组织代码的架构能力，代码可能写成各种样子。"}),"\n",(0,r.jsx)(s.p,{children:"所以企业级开发，我们会用对它封装了一层的库，比如 Nest。"}),"\n",(0,r.jsx)(s.p,{children:"Nest 提供了 IOC、AOP 等架构特性，规定了代码组织的形式，而且对 websocket、graphql、orm 等各种方案都提供了开箱即用的支持。"}),"\n",(0,r.jsx)(s.p,{children:"也就是说，用 Node 写一个 http 服务有三个层次："}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"直接使用 http、https 的模块"}),"\n",(0,r.jsx)(s.li,{children:"使用 express、koa 这种库"}),"\n",(0,r.jsx)(s.li,{children:"使用 Nest 这种企业级框架"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"就像写 java 你还会直接处理 http 请求并手动集成各种方案么？"}),"\n",(0,r.jsx)(s.p,{children:"不会，会直接用 Spring 这种一站式企业级开发框架。"}),"\n",(0,r.jsx)(s.p,{children:"同样的道理， Nest 就是 node 生态里的 Spring。"}),"\n",(0,r.jsx)(s.p,{children:"但是 Nest 也没有和 Express 强耦合，它做了一层抽象："}),"\n",(0,r.jsxs)(s.p,{children:["定义了 ",(0,r.jsx)(s.a,{href:"https://github.com/nestjs/nest/blob/d352e6f138bc70ff33cccf830053946d17272b82/packages/common/interfaces/http/http-server.interface.ts#L21C1-L85",target:"_blank",rel:"noopener noreferrer",children:"HttpServer 的 interface"}),"："]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsxs)(s.p,{children:["然后封装了 ",(0,r.jsx)(s.a,{href:"https://github.com/nestjs/nest/blob/d352e6f138bc70ff33cccf830053946d17272b82/packages/core/adapters/http-adapter.ts#L12C1-L131",target:"_blank",rel:"noopener noreferrer",children:"AbstractHttpAdapter 的 abstract class"}),"："]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"之后分别提供了 express 和 fastify 的实现："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"Adapter 是适配器的意思，也就是说 Nest 内部并没有直接依赖任何一个 http 处理的库，只是依赖了抽象的接口，想用什么库需要实现这些接口的适配器。"}),"\n",(0,r.jsx)(s.p,{children:"你可以用 express，也可以灵活的切换成 fastify，对 Nest 没有任何影响。"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"这俩适配器分别在 @nestjs/platform-express 和 @nestjs/platform-fastify 的包里："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(s.p,{children:"默认用的是 platform-express 的包："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"下面我们切换到 fastify 试试看："}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"nest new fastify-test -p npm\n"})}),"\n",(0,r.jsx)(s.p,{children:"同样，先用 @nestjs/cli 创建个 nest 项目"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"然后把它跑起来："}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"nest start --watch\n"})}),"\n",(0,r.jsxs)(s.p,{children:["浏览器访问 ",(0,r.jsx)(s.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 看到 hello world 就是服务跑成功了："]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(s.p,{children:"现在用的是默认的 express，我们切换到 fastify 试试看："}),"\n",(0,r.jsx)(s.p,{children:"安装 fastify 和 @nestjs/platform-fastify："}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"npm install fastify @nestjs/platform-fastify\n"})}),"\n",(0,r.jsx)(s.p,{children:"然后修改下 Nest 创建的方式："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"改成这样："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"这个 FastifyAdapter 前面讲过，传入这个 adapter 之后，就切换到了 fastify 平台。"}),"\n",(0,r.jsx)(s.p,{children:"这里你还可以再传一个类型参数："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"这样返回的 app 就会提示 fastify 平台特有的方法了："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"这也是为什么之前我们要传入 NestExpressApplication 才有 useStaticAssets 方法："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"然后在 controller 里可以注入 fastify 的 request 和 reply 对象："}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-javascript",children:"import { Controller, Get, Request, Response } from '@nestjs/common';\nimport { FastifyReply, FastifyRequest } from 'fastify';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Get()\n  getHello(@Request() request: FastifyRequest, @Response() reply: FastifyReply) {\n    reply.header('url', request.url)\n    reply.send('hello')\n  }\n}\n"})}),"\n",(0,r.jsx)(s.p,{children:"我们注入了 fastify 的 request 和 reply 对象，然后用它来设置 header 发送响应："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"这里要注意的是一旦用 @Response 注入了响应对象，就不能通过 return 的方式来返回响应内容了，需要手动调用 res.send。"}),"\n",(0,r.jsx)(s.p,{children:"这点用 express 时也是一样。"}),"\n",(0,r.jsx)(s.p,{children:"很容易理解，因为你可能在方法里用 resposne 对象发送数据了，那如果 Nest 再把返回值作为响应内容，不就冲突了么？"}),"\n",(0,r.jsx)(s.p,{children:"当然，你也可以这样做："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"传个 passthrough 参数，代表不会在方法里自己发送响应内容。"}),"\n",(0,r.jsx)(s.p,{children:"这样返回值就生效了："}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(s.p,{children:"最后，我们来思考下为什么 Nest 要做能够轻松切换 http 处理库呢？"}),"\n",(0,r.jsx)(s.p,{children:"因为 Nest 的核心还是在于 IOC、AOP 这些架构特性，像 express、fastify 只不过是请求、响应的方法不同而已，区别并不大。"}),"\n",(0,r.jsx)(s.p,{children:"如果强依赖于 express，万一有更好的 http 处理库怎么办？"}),"\n",(0,r.jsx)(s.p,{children:"这种加一层抽象和适配器的方式，能让 Nest 更加通用、灵活，有更强的扩展性。"}),"\n",(0,r.jsxs)(s.p,{children:["案例代码在",(0,r.jsx)(s.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/fastify-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(s.h2,{id:"总结",children:["总结",(0,r.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(s.p,{children:"express 是基于中间件的洋葱模型处理请求、响应的库，它并没有提供组织代码的架构特性，代码可以写的很随意。"}),"\n",(0,r.jsx)(s.p,{children:"而为了更好的可维护性，我们都会用 Nest 这种一站式企业级开发框架。就像 java 里会用 Spring 框架一样。"}),"\n",(0,r.jsx)(s.p,{children:"Nest 底层是 express 但也不完全是，它内部实现是基于 interface 的，而且提供了 @nestjs/platform-express、@nestjs/platform-fastify 这两个 adapter 包。"}),"\n",(0,r.jsx)(s.p,{children:"这样就可以轻松的切换 express、fastify 或者其他的 http 请求处理的库。"}),"\n",(0,r.jsx)(s.p,{children:"这就是适配器模式的魅力。"})]})}function E(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,t.ah)(),e.components);return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(N,{...e})}):N(e)}let k=E;E.__RSPRESS_PAGE_META={},E.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F17.%20Nest%20%E5%92%8C%20Express%20%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%A6%82%E4%BD%95%E5%88%87%E5%88%B0%20fastify.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"17. Nest 和 Express 的关系，如何切到 fastify",headingTitle:"17. Nest 和 Express 的关系，如何切到 fastify",frontmatter:{}}}}]);