"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["28801"],{528662:function(e,r,n){n.r(r),n.d(r,{default:()=>S});var s=n(552676),d=n(740453);let l=n.p+"static/image/e586bf8c4093d99edad3de449c56744b.8deb64c9.webp",i=n.p+"static/image/0eb4b74f17bd8f14878c669b400d0f74.23aa538c.webp",t=n.p+"static/image/782c18dc8eafa61d6509ef889ed7acfa.8c11a271.webp",c=n.p+"static/image/adc294c5063e45aa0258f42dbc756ce2.7cf92ec5.webp",a=n.p+"static/image/e86fb3c4fb053ccb9ec3b66723c114ed.2306318b.webp",p=n.p+"static/image/6754527f78c5a4d810e37ebb56ecce15.e205c019.webp",o=n.p+"static/image/1bda5831fdf1367a28e9c92c490b3be0.65875210.webp",h=n.p+"static/image/27b619f333c6cf55a1ae7f8b31b2f460.b05578e1.webp",x=n.p+"static/image/d269732e0a9a58a3dbfe916134bf533b.e8776802.webp",f=n.p+"static/image/af02c76ec8607a320c4e7dc2d1812a02.1fbd6245.webp",b=n.p+"static/image/e0de5063334b90bc6cc26e0acb993040.98021d18.webp",j=n.p+"static/image/0a18f1c583a141026804473903305c63.8479582f.webp",A=n.p+"static/image/f5e04536ca704a078d442ce45fde24fc.a50d0b6e.webp",u=n.p+"static/image/7effc972de9f0731c83f0ac7e9e39295.66360802.webp",m=n.p+"static/image/88b1f17d52679557e0b49b900645d334.a69cb739.webp",g=n.p+"static/image/345da918a8ef2daf1959790c18468cd4.80d71897.webp",w=n.p+"static/image/488f3b0547788c17d50ad025bcae92da.f91ae3f5.webp",M=n.p+"static/image/f7958c3b93fb2296c1b961b496c2146b.4d646840.webp";function N(e){let r=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,d.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.h1,{id:"18-nest-的-middleware",children:["18. Nest 的 Middleware",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#18-nest-的-middleware",children:"#"})]}),"\n",(0,s.jsx)(r.p,{children:"Nest 里也有中间件 Middleware 的概念，它和 Express 的 Middleware 是一个东西么？"}),"\n",(0,s.jsx)(r.p,{children:"很像，但不一样。"}),"\n",(0,s.jsx)(r.p,{children:"上节讲过，Nest 并不是直接依赖于 Express，可以切换到别的 http 请求处理库，那 Nest 的特性肯定也不直接是 Express 里的。"}),"\n",(0,s.jsx)(r.p,{children:"我们创建个项目，边写边看："}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"nest new middleware-test\n"})}),"\n",(0,s.jsx)(r.p,{children:"进入项目，执行："}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"nest g middleware aaa --no-spec --flat\n"})}),"\n",(0,s.jsx)(r.p,{children:"创建个 middleware："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:M,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"因为这时候并不知道你用的 express 还是 fastify，所以 request、response 是 any，手动标注下类型就好了："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这里是 express 的 request、response。"}),"\n",(0,s.jsx)(r.p,{children:"加一下前后的的逻辑："}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response } from 'express';\n\n@Injectable()\nexport class AaaMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: () => void) {\n    console.log('brefore');\n    next();\n    console.log('after');\n  }\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"然后在 Module 里这样使用："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"import { AaaMiddleware } from './aaa.middleware';\nimport { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\n\n@Module({\n  imports: [],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule implements NestModule{\n\n  configure(consumer: MiddlewareConsumer) {\n    consumer.apply(AaaMiddleware).forRoutes('*');\n  }\n}\n\n"})}),"\n",(0,s.jsx)(r.p,{children:"实现 NestModule 接口的 configure 方法，在里面应用 AaaMiddleware 到所有路由。"}),"\n",(0,s.jsx)(r.p,{children:"然后跑起来试一下："}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"nest start --watch\n"})}),"\n",(0,s.jsxs)(r.p,{children:["浏览器访问 ",(0,s.jsx)(r.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(r.p,{children:"可以看到中间件的逻辑都执行了："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这里也可以指定更精确的路由。"}),"\n",(0,s.jsx)(r.p,{children:"我们添加几个 handler："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"然后重新指定 Middleware 应用的路由："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"import { AaaMiddleware } from './aaa.middleware';\nimport { MiddlewareConsumer, Module, NestModule, RequestMethod } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\n\n@Module({\n  imports: [],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule implements NestModule{\n\n  configure(consumer: MiddlewareConsumer) {\n    consumer.apply(AaaMiddleware).forRoutes({ path: 'hello*', method: RequestMethod.GET });\n    consumer.apply(AaaMiddleware).forRoutes({ path: 'world2', method: RequestMethod.GET });\n  }\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"可以看到，hello、hello2、world2 的路由都调用了这个中间件，而 world1 没有："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这就是 Nest 里 middleware 的用法。"}),"\n",(0,s.jsx)(r.p,{children:"如果只是这样，那和 Express 的 middleware 差别并不大，无非是变成了 class 的方式。"}),"\n",(0,s.jsx)(r.p,{children:"Nest 为什么要把 Middleware 做成 class 呢？"}),"\n",(0,s.jsx)(r.p,{children:"当然是为了依赖注入了！"}),"\n",(0,s.jsx)(r.p,{children:"我们通过 @Inject 注入 AppService 到 middleware 里："}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"import { AppService } from './app.service';\nimport { Inject, Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response } from 'express';\n\n@Injectable()\nexport class AaaMiddleware implements NestMiddleware {\n  @Inject(AppService)\n  private readonly appService: AppService;\n\n  use(req: Request, res: Response, next: () => void) {\n    console.log('brefore');\n    console.log('-------' + this.appService.getHello());\n    next();\n    console.log('after');\n  }\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"当然，这里也可以用构造器注入，这样更简洁一点："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这时在访问这个路由的时候，就可以看到中间件成功调用了 AppService："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这就是 Nest 注入的依赖。"}),"\n",(0,s.jsx)(r.p,{children:"如果不注入依赖，那写函数的方式也是可以的。"}),"\n",(0,s.jsx)(r.p,{children:"看这个 apply 方法的类型声明也可以看出来："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"如果不需要注入依赖，那可以写函数形式的 middleware，这时候和 Express 的 middleware 就没啥区别了。"}),"\n",(0,s.jsx)(r.p,{children:"如果需要注入依赖，那就写 class 形式的 middleware，可以用 Nest 的依赖注入能力。"}),"\n",(0,s.jsx)(r.p,{children:"当然，应用实例对象也可以 use 中间件，这个就和 express 那个一样了："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"不过这种形式不能注入依赖，而且也不能配置应用到什么路由，不建议用。"}),"\n",(0,s.jsx)(r.p,{children:"app.use 等同于在 AppModule 的 configure 方法里的 forRoutes('*')"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"此外，middleware 里有个 next 参数，而 Nest 还有个 @Next 装饰器，这俩的区别是什么呢？"}),"\n",(0,s.jsx)(r.p,{children:"middleware 的 next 参数就是调用下一个 middleware 的，这个很好理解。"}),"\n",(0,s.jsx)(r.p,{children:"而 @Next 装饰器是调用下一个 handler 的："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:a,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"但如果是这样一个 handler，它就不返回值了："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这个和加上 @Response 装饰器的时候的效果一样。"}),"\n",(0,s.jsx)(r.p,{children:"因为 Nest 认为你会自己返回响应或者调用下个 handler，就不会处理返回值了。"}),"\n",(0,s.jsx)(r.p,{children:"如果依然想让 Nest 把函数返回值作为响应，可以这样写："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:c,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"这个上节讲过。"}),"\n",(0,s.jsx)(r.p,{children:"当然，传入 Next 参数的时候，一般是不需要在这里响应的，一般是调用下个 handler 来响应："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(r.p,{children:"不过一般也不需要这样写，直接写在一个 handler 里就行。"}),"\n",(0,s.jsx)(r.p,{children:"有的同学可能会问：Nest 的 middleware 和 interceptor 都是在请求前后加入一些逻辑的，这俩区别是啥呢？"}),"\n",(0,s.jsx)(r.p,{children:"区别有两点："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"interceptor 是能从 ExecutionContext 里拿到目标 class 和 handler，进而通过 reflector 拿到它的 metadata 等信息的，这些 middleware 就不可以。"}),"\n",(0,s.jsx)(r.p,{children:"再就是 interceptor 里是可以用 rxjs 的操作符来组织响应处理流程的："}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(r.p,{children:"middleware 里也不可以。"}),"\n",(0,s.jsx)(r.p,{children:"它们都是 Nest AOP 思想的实现，但是 interceptor 更适合处理与具体业务相关的逻辑，而 middleware 适合更通用的处理逻辑。"}),"\n",(0,s.jsxs)(r.p,{children:["案例代码在",(0,s.jsx)(r.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/midleware-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,s.jsxs)(r.h2,{id:"总结",children:["总结",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(r.p,{children:"Nest 也有 middleware，但是它不是 Express 的 middleware，虽然都有 request、response、next 参数，但是它可以从 Nest 的 IOC 容器注入依赖，还可以指定作用于哪些路由。"}),"\n",(0,s.jsx)(r.p,{children:"用法是 Module 实现 NestModule 的 configure 方法，调用 apply 和 forRoutes 指定什么中间件作用于什么路由。"}),"\n",(0,s.jsx)(r.p,{children:"app.use 也可以应用中间件，但更建议在 AppModule 里的 configure 方法里指定。"}),"\n",(0,s.jsx)(r.p,{children:"Nest 还有个 @Next 装饰器，这个是用于调用下个 handler 处理的，当用了这个装饰器之后，Nest 就不会把 handler 返回值作为响应了。"}),"\n",(0,s.jsx)(r.p,{children:"middleware 和 interceptor 功能类似，但也有不同，interceptor 可以拿到目标 class、handler 等，也可以调用 rxjs 的 operator 来处理响应，更适合处理具体的业务逻辑。"}),"\n",(0,s.jsx)(r.p,{children:"middleware 更适合处理通用的逻辑。"})]})}function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,d.ah)(),e.components);return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(N,{...e})}):N(e)}let S=v;v.__RSPRESS_PAGE_META={},v.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F18.%20Nest%20%E7%9A%84%20Middleware.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"18. Nest 的 Middleware",headingTitle:"18. Nest 的 Middleware",frontmatter:{}}}}]);