"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["62539"],{370385:function(e,n,c){e.exports=c.p+"static/image/3a0c8d6a403cd2da8d37bbcb25921f4e.465555a5.webp"},889487:function(e,n,c){c.r(n),c.d(n,{default:()=>B});var s=c(552676),a=c(740453);let i=c.p+"static/image/e77aaf47a7bb69f6645d8cfc0de7380e.79a52af0.webp",t=c.p+"static/image/ace0b1ff3c26cfde083dd804654d689f.46bef43a.webp",r=c.p+"static/image/9330a17c56ec394f358e23edf63b4ef5.0252d470.webp",l=c.p+"static/image/dfc95af259a08492ab83e69e1bac5ffc.cb09be7f.webp",d=c.p+"static/image/6eb3ae4ca3211bc8acf6b3bffd556060.978c60c2.webp",p=c.p+"static/image/cba3bcdcd2535d7aa744ecc792689bdd.1ef5161d.webp",h=c.p+"static/image/fb176f10d09fb999e8eed9534f9a4002.2e87b587.webp",x=c.p+"static/image/b26d9424cdf2b47ab754833ddd6a723c.21c48846.webp",j=c.p+"static/image/02c10b7fddf0de126e33128fe7ab326b.abd623de.webp",o=c.p+"static/image/60c133f95e5b6e1cade2b6cfb14cbd08.6c0a2da3.webp",g=c.p+"static/image/6ebb3e6f56a4a075e8dabef922e0adc2.4eb917d4.webp",v=c.p+"static/image/3e6da6b4f068609b33a72cfbbe6658ac.0ab12c18.webp",f=c.p+"static/image/e95fa038de457b13dc9c692f349ff419.077b1cd8.webp",b=c.p+"static/image/4889cd731da5260d205aefbf9a369861.e37d42ad.webp",m=c.p+"static/image/a4f93d9acd903baea1474605f34b45b0.b4ffa054.webp",u=c.p+"static/image/678921c9dd0e52775f5ba99bf50baa74.c5fe7399.webp",w=c.p+"static/image/12cb70b3dd9c65815643d63877b3e588.e48dabf7.webp",y=c.p+"static/image/730fee6ac941d5065b343a928d6f9e15.a1a78ba5.webp",k=c.p+"static/image/94bab941384dc53832efb9392cd125c7.0f8b8098.webp",A=c.p+"static/image/0fdf91a94f8bfc9eb87afb473f5d7b29.03fd58a3.webp";var C=c(370385);let E=c.p+"static/image/6bfcdc0d8c1cd14e1f0e59cd5ade784e.22270a00.webp",N=c.p+"static/image/f2182916a0a03c62ec2c0684c34ab884.ce2d454c.webp",V=c.p+"static/image/72338258183c8f9fb5b0c392c108008c.70355250.webp",D=c.p+"static/image/49d526e2186be4eb688aae1125e07550.e3e983ae.webp",S=c.p+"static/image/25838b042c22db2ee648f67389ff82e8.9d100991.webp";function U(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,a.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"142-用-etcd-实现微服务配置中心和注册中心",children:["142. 用 Etcd 实现微服务配置中心和注册中心",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#142-用-etcd-实现微服务配置中心和注册中心",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"微服务架构的系统都会有配置中心和注册中心。"}),"\n",(0,s.jsx)(n.p,{children:"为什么呢？"}),"\n",(0,s.jsx)(n.p,{children:"比如说配置中心："}),"\n",(0,s.jsx)(n.p,{children:"系统中会有很多微服务，它们会有一些配置信息，比如环境变量、数据库连接信息等。"}),"\n",(0,s.jsx)(n.p,{children:"这些配置信息散落在各个服务中，以配置文件的形式存在。"}),"\n",(0,s.jsx)(n.p,{children:"这样你修改同样的配置需要去各个服务下改下配置文件，然后重启服务。"}),"\n",(0,s.jsx)(n.p,{children:"就很麻烦。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"如果有一个服务专门用来集中管理配置信息呢？"}),"\n",(0,s.jsx)(n.p,{children:"这样每个微服务都从这里拿配置，可以统一的修改，并且配置更改后也会通知各个微服务。"}),"\n",(0,s.jsx)(n.p,{children:"这个集中管理配置信息的服务就叫配置中心。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再就是注册中心："}),"\n",(0,s.jsx)(n.p,{children:"微服务之间会相互依赖，共同完成业务逻辑的处理。"}),"\n",(0,s.jsx)(n.p,{children:"如果某个微服务挂掉了，那所有依赖它的服务就都不能工作了。"}),"\n",(0,s.jsx)(n.p,{children:"为了避免这种情况，我们会通过集群部署的方式，每种微服务部署若干个节点，并且还可能动态增加一些节点。"}),"\n",(0,s.jsx)(n.p,{children:"那么问题来了："}),"\n",(0,s.jsx)(n.p,{children:"微服务 A 依赖了微服务 B，写代码的时候 B 只有 3 个节点，但跑起来以后，某个节点挂掉了，并且还新增了几个微服务 B 的节点。"}),"\n",(0,s.jsx)(n.p,{children:"这时候微服务 A 怎么知道微服务 B 有哪些节点可用呢？"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:V,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"答案也是需要一个单独的服务来管理，这个服务就是注册中心："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"微服务在启动的时候，向注册中心注册，销毁的时候向注册中心注销，并且定时发心跳包来汇报自己的状态。"}),"\n",(0,s.jsx)(n.p,{children:"在查找其他微服务的时候，去注册中心查一下这个服务的所有节点信息，然后再选一个来用，这个叫做服务发现。"}),"\n",(0,s.jsx)(n.p,{children:"这样微服务就可以动态的增删节点而不影响其他微服务了。"}),"\n",(0,s.jsx)(n.p,{children:"微服务架构的后端系统中，都会有这两种服务。"}),"\n",(0,s.jsx)(n.p,{children:"下面是我网上找的几张微服务系统的架构图："}),"\n",(0,s.jsxs)(n.p,{children:["这个：\n",(0,s.jsx)("img",{src:E,alt:""})]}),"\n",(0,s.jsxs)(n.p,{children:["这个：\n",(0,s.jsx)("img",{src:C,alt:""})]}),"\n",(0,s.jsxs)(n.p,{children:["或者这个：\n",(0,s.jsx)("img",{src:A,alt:""})]}),"\n",(0,s.jsx)(n.p,{children:"可以看到，配置中心和注册中心是必备组件。"}),"\n",(0,s.jsx)(n.p,{children:"但是，虽然这是两种服务，功能确实很类似，完全可以在一个服务里实现。"}),"\n",(0,s.jsx)(n.p,{children:"可以做配置中心、注册中心的中间件还是挺多的，比如 nacos、apollo、etcd 等。"}),"\n",(0,s.jsx)(n.p,{children:"今天我们来学下 etcd 实现注册中心和配置中心。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"它其实是一个 key-value 的存储服务。"}),"\n",(0,s.jsx)(n.p,{children:"k8s 就是用它来做的注册中心、配置中心："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们通过 docker 把它跑起来。"}),"\n",(0,s.jsx)(n.p,{children:"在 docker desktop 搜索 etcd 的镜像，点击 run:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"输入容器名，映射 2379 端口到容器内的 2379 端口，设置 ETCD_ROOT_PASSWORD 环境变量，也就是指定 root 的密码。"}),"\n",(0,s.jsx)(n.p,{children:"然后就可以看到 etcd server 的 docker 镜像成功跑起来了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"它带了一个 etcdctl 的命令行工具，可以作为客户端和 etcd server 交互。"}),"\n",(0,s.jsx)(n.p,{children:"常用的命令有这么几个："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl put key value\netcdctl get key\netcdctl del key\netcdctl watch key\n"})}),"\n",(0,s.jsx)(n.p,{children:"就是对 key value 的增删改查和 watch 变动，还是比较容易理解的。"}),"\n",(0,s.jsx)(n.p,{children:"但是现在执行命令要加上 --user、--password 的参数才可以："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl get --user=root --password=guang key\n"})}),"\n",(0,s.jsx)(n.p,{children:"如果不想每次都指定用户名密码，可以设置环境变量："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export ETCDCTL_USER=root\nexport ETCDCTL_PASSWORD=guang\n"})}),"\n",(0,s.jsx)(n.p,{children:"这里的 password 就是启动容器的时候指定的那个环境变量："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们设置几个 key："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl put /services/a xxxx\netcdctl put /services/b yyyy\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"之后可以 get 来查询他们的值："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl get /services/a\netcdctl get /services/b\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"也可以通过 --prefix 查询指定前缀的 key 的值："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl get --prefix /services \n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"删除也是可以单个删和指定前缀批量删："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl del /servcies/a\netcdctl del --prefix /services\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样的 key-value 用来存储 服务名-链接信息，那就是注册中心，用来存储配置信息，那就是配置中心。"}),"\n",(0,s.jsx)(n.p,{children:"我们在 node 里面连接下 etcd 服务试试看："}),"\n",(0,s.jsx)(n.p,{children:"创建个项目："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"mkdir etcd-test\ncd etcd-test\nnpm init -y\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"安装 etcd 的包："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm install --save etcd3\n"})}),"\n",(0,s.jsx)(n.p,{children:"创建 index.js"}),"\n",(0,s.jsx)(n.p,{children:"使用 etcd 官方提供的 npm 包 etcd3:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { Etcd3 } = require('etcd3');\nconst client = new Etcd3({\n    hosts: 'http://localhost:2379',\n    auth: {\n        username: 'root',\n        password: 'guang'\n    }\n});\n \n(async () => { \n  const services = await client.get('/services/a').string();\n  console.log('service A:', services);\n\n  const allServices = await client.getAll().prefix('/services').keys();\n  console.log('all services:', allServices);\n \n  const watcher = await client.watch().key('/services/a').create();\n  watcher.on('put', (req) => {\n    console.log('put', req.value.toString())\n  })\n  watcher.on('delete', (req) => {\n    console.log('delete')\n  })\n})();\n"})}),"\n",(0,s.jsx)(n.p,{children:"get、getAll、watch 这些 api 和 ectdctl 命令行差不多，很容易搞懂。"}),"\n",(0,s.jsx)(n.p,{children:"get(xx) 是查询某个 key 的值。"}),"\n",(0,s.jsx)(n.p,{children:"getAll().prefix(xx).keys() 是查询某个字符串开头的 key。"}),"\n",(0,s.jsx)(n.p,{children:"watch().key(xx).create 则是创建某个 key 的监听器，监听他的 put 和 delete 事件。"}),"\n",(0,s.jsx)(n.p,{children:"我们再 put 几个 key："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl put /services/a xxx\n\netcdctl put /services/b yyy\n"})}),"\n",(0,s.jsx)(n.p,{children:"然后执行上面的 node 脚本："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"确实取到了 etcd server 中的值。"}),"\n",(0,s.jsx)(n.p,{children:"然后在 etcdctl 里 put 修改下 /services/a 的值："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl put /services/a zzz\n"})}),"\n",(0,s.jsx)(n.p,{children:"在 node 脚本这里收到了通知："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再 del 试下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl del /services/a\n"})}),"\n",(0,s.jsx)(n.p,{children:"也收到了通知："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样，在 node 里操作 etcd server 就跑通了。"}),"\n",(0,s.jsx)(n.p,{children:"然后我们封装下配置中心和注册中心的工具函数："}),"\n",(0,s.jsx)(n.p,{children:"配置中心的实现比较简单，就是直接 put、get、del 对应的 key："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// 保存配置\nasync function saveConfig(key, value) {\n    await client.put(key).value(value);\n}\n\n// 读取配置\nasync function getConfig(key) {\n    return await client.get(key).string();\n}\n\n// 删除配置\nasync function deleteConfig(key) {\n    await client.delete().key(key);\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"使用起来也很简单；"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"(async function main() {\n    await saveConfig('config-key', 'config-value');\n    const configValue = await getConfig('config-key');\n    console.log('Config value:', configValue);\n})();\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"你可以在这里存各种数据库连接信息、环境变量等各种配置。"}),"\n",(0,s.jsx)(n.p,{children:"然后是注册中心："}),"\n",(0,s.jsx)(n.p,{children:"服务注册："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// 服务注册\nasync function registerService(serviceName, instanceId, metadata) {\n    const key = `/services/${serviceName}/${instanceId}`;\n    const lease = client.lease(10);\n    await lease.put(key).value(JSON.stringify(metadata));\n    lease.on('lost', async () => {\n        console.log('租约过期，重新注册...');\n        await registerService(serviceName, instanceId, metadata);\n    });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"注册的时候我们按照 /services/服务名/实例id 的格式来指定 key。"}),"\n",(0,s.jsx)(n.p,{children:"也就是一个微服务可以有多个实例。"}),"\n",(0,s.jsx)(n.p,{children:"设置了租约 10s，这个就是过期时间的意思，然后过期会自动删除。"}),"\n",(0,s.jsx)(n.p,{children:"我们可以监听 lost 事件，在过期后自动续租。"}),"\n",(0,s.jsx)(n.p,{children:"当不再续租的时候，就代表这个服务挂掉了。"}),"\n",(0,s.jsx)(n.p,{children:"然后是服务发现："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// 服务发现\nasync function discoverService(serviceName) {\n    const instances = await client.getAll().prefix(`/services/${serviceName}`).strings();\n    return Object.entries(instances).map(([key, value]) => JSON.parse(value));\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"服务发现就是查询 /services/服务名 下的所有实例，返回它的信息。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// 监听服务变更\nasync function watchService(serviceName, callback) {\n    const watcher = await client.watch().prefix(`/services/${serviceName}`).create();\n    watcher .on('put', async event => {\n        console.log('新的服务节点添加:', event.key.toString());\n        callback(await discoverService(serviceName));\n    }).on('delete', async event => {\n        console.log('服务节点删除:', event.key.toString());\n        callback(await discoverService(serviceName));\n    });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"通过 watch 监听 /services/服务名下所有实例的变动，包括添加节点、删除节点等，返回现在的可用节点。"}),"\n",(0,s.jsx)(n.p,{children:"我们来测试下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"(async function main() {\n    const serviceName = 'my_service';\n    \n    await registerService(serviceName, 'instance_1', { host: 'localhost', port:3000 });\n    await registerService(serviceName, 'instance_2', { host: 'localhost', port:3002 });\n\n    const instances = await discoverService(serviceName);\n    console.log('所有服务节点:', instances);\n\n    watchService(serviceName, updatedInstances => {\n        console.log('服务节点有变动:', updatedInstances);\n    });\n})();\n"})}),"\n",(0,s.jsx)(n.p,{children:"跑起来确实能获得服务的所有节点信息："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"当在 etcdctl 里 del 一个服务节点的时候，这里也能收到通知："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"etcdctl del /services/my_service/instance_2\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样，我们就实现了服务注册、服务发现功能。"}),"\n",(0,s.jsx)(n.p,{children:"有的同学可能问了：redis 不也是 key-value 存储的么？为什么不用 redis 做配置中心和注册中心？"}),"\n",(0,s.jsx)(n.p,{children:"因为 redis 没法监听不存在的 key 的变化，而 etcd 可以，而配置信息很多都是动态添加的。"}),"\n",(0,s.jsx)(n.p,{children:"当然，还有很多别的原因，毕竟 redis 只是为了缓存设计的，不是专门的配置中心、注册中心的中间件。"}),"\n",(0,s.jsx)(n.p,{children:"专业的事情还是交给专业的中间件来干。"}),"\n",(0,s.jsxs)(n.p,{children:["案例代码在",(0,s.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/etcd-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,s.jsx)(n.p,{children:"也在这里贴一份："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { Etcd3 } = require('etcd3');\nconst client = new Etcd3({\n    hosts: 'http://localhost:2379',\n    auth: {\n        username: 'root',\n        password: 'guang'\n    }\n});\n\n// 保存配置\nasync function saveConfig(key, value) {\n    await client.put(key).value(value);\n}\n\n// 读取配置\nasync function getConfig(key) {\n    return await client.get(key).string();\n}\n\n// 删除配置\nasync function deleteConfig(key) {\n    await client.delete().key(key);\n}\n   \n// 服务注册\nasync function registerService(serviceName, instanceId, metadata) {\n    const key = `/services/${serviceName}/${instanceId}`;\n    const lease = client.lease(10);\n    await lease.put(key).value(JSON.stringify(metadata));\n    lease.on('lost', async () => {\n        console.log('租约过期，重新注册...');\n        await registerService(serviceName, instanceId, metadata);\n    });\n}\n\n// 服务发现\nasync function discoverService(serviceName) {\n    const instances = await client.getAll().prefix(`/services/${serviceName}`).strings();\n    return Object.entries(instances).map(([key, value]) => JSON.parse(value));\n}\n\n// 监听服务变更\nasync function watchService(serviceName, callback) {\n    const watcher = await client.watch().prefix(`/services/${serviceName}`).create();\n    watcher.on('put', async event => {\n        console.log('新的服务节点添加:', event.key.toString());\n        callback(await discoverService(serviceName));\n    }).on('delete', async event => {\n        console.log('服务节点删除:', event.key.toString());\n        callback(await discoverService(serviceName));\n    });\n}\n\n// (async function main() {\n//     await saveConfig('config-key', 'config-value');\n//     const configValue = await getConfig('config-key');\n//     console.log('Config value:', configValue);\n// })();\n\n(async function main() {\n    const serviceName = 'my_service';\n    \n    await registerService(serviceName, 'instance_1', { host: 'localhost', port:3000 });\n    await registerService(serviceName, 'instance_2', { host: 'localhost', port:3002 });\n\n    const instances = await discoverService(serviceName);\n    console.log('所有服务节点:', instances);\n\n    watchService(serviceName, updatedInstances => {\n        console.log('服务节点有变动:', updatedInstances);\n    });\n})();\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"微服务架构的系统中少不了配置中心和注册中心。"}),"\n",(0,s.jsx)(n.p,{children:"不同服务的配置需要统一管理，并且在更新后通知所有的服务，所以需要配置中心。"}),"\n",(0,s.jsx)(n.p,{children:"微服务的节点可能动态的增加或者删除，依赖他的服务在调用之前需要知道有哪些实例可用，所以需要注册中心。"}),"\n",(0,s.jsx)(n.p,{children:"服务启动的时候注册到注册中心，并定时续租期，调用别的服务的时候，可以查一下有哪些服务实例可用，也就是服务注册、服务发现功能。"}),"\n",(0,s.jsx)(n.p,{children:"注册中心和配置中心可以用 etcd 来做，它就是一个专业做这件事的中间件，k8s 就是用的它来做的配置和服务注册中心。"}),"\n",(0,s.jsx)(n.p,{children:"我们用 docker 跑了 etcd server，它内置了命令行工具 etcdctl 可以用来和 server 交互。"}),"\n",(0,s.jsx)(n.p,{children:"常用的命令有 put、get、del、watch 等。"}),"\n",(0,s.jsx)(n.p,{children:"在 node 里可以通过 etcd3 这个包来操作 etcd server。"}),"\n",(0,s.jsx)(n.p,{children:"稍微封装一下就可以实现配置管理和服务注册、发现的功能。"}),"\n",(0,s.jsx)(n.p,{children:"在微服务架构的后端系统中，配置中心、注册中心是必不可少的组件，不管是 java、go 还是 Node.js。"})]})}function R(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(U,{...e})}):U(e)}let B=R;R.__RSPRESS_PAGE_META={},R.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F142.%20%E7%94%A8%20Etcd%20%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%92%8C%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"142. 用 Etcd 实现微服务配置中心和注册中心",headingTitle:"142. 用 Etcd 实现微服务配置中心和注册中心",frontmatter:{}}}}]);