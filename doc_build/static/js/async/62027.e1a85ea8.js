"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["62027"],{693875:function(e,n,s){s.r(n),s.d(n,{default:()=>K});var t=s(552676),c=s(740453);let a=s.p+"static/image/f324cd68cc58438c43cae682aa3e79ac.5e5d7d34.webp",i=s.p+"static/image/670671682c78c394abb351f53e1fc917.7f5406ba.webp",r=s.p+"static/image/7b96f4a5e2c8d757498c0aebd250f8e2.34c634e8.webp",p=s.p+"static/image/ad7d490d312a9490ef67eba969874133.5dbaa980.webp",l=s.p+"static/image/de2e05f43867f6496d3d47add3e887d0.28228e91.webp",d=s.p+"static/image/ea493babcb4d3f29d7cae5deccec3175.331f5767.webp",o=s.p+"static/image/ff8f1e3ea0881f60953cb01f5227f497.211a3a21.webp",x=s.p+"static/image/7e6239470fc1a1d67b083556370404ca.4ab813f6.webp",j=s.p+"static/image/c4c0fc4d7347f51014d9f5d9fe685284.b912dfbe.webp",h=s.p+"static/image/77c1c11bb8b6b95300e3aef65faa04fd.ca3a8eba.webp",m=s.p+"static/image/3094b6645d0ba865ad2b10ae53b0972f.68004d82.webp",g=s.p+"static/image/6a02dbae09bfaf1bfd5e860d458e5594.5de3ab08.webp",b=s.p+"static/image/db1d1f3fa578f457da55735b2909746f.05710332.webp",f=s.p+"static/image/698454548c85487a1cfe0a9e8d15e4b1.384c25c5.webp",u=s.p+"static/image/0f53026a6f252c878de3b545d97e8772.60d50432.webp",A=s.p+"static/image/01c4eac93216c7b6d3d97387107bc56e.bceeb313.webp",E=s.p+"static/image/97e1c6db8352a8e88249457a20561d04.c86aec60.webp",w=s.p+"static/image/0646be959887c95d3a5f9c8e5d667aca.a9a546d9.webp",H=s.p+"static/image/36e678a71e5591bb4297e65a06442e14.d5baf480.webp",F=s.p+"static/image/81962f2ca0e56d19375298b3a09aabb2.83d1a087.webp",v=s.p+"static/image/bcfe920c9503684857a227f15afdb072.0da602da.webp",R=s.p+"static/image/717cb838c3e39109f773ae34f66b0af1.7897739f.webp",P=s.p+"static/image/d566ab4241b179d6691994c7adcde389.ed2c6a9d.webp",B=s.p+"static/image/b76a9f534231ce3e381799a64645e894.16517cb4.webp",C=s.p+"static/image/9f9db8b61f52e51325de8dc019f806b6.ca096cae.webp",N=s.p+"static/image/8eb45ce0e1826bbeede10d04502ebe48.a7820e0e.webp",I=s.p+"static/image/68f576cf15c39180b7203da88786156a.13a03a21.webp",S=s.p+"static/image/ac1cebbaea855e6116df2e154c9c0c5c.3eef489d.webp",X=s.p+"static/image/0372bdbeb10e76e5ffca0c580a8d2b9f.b45a68ad.webp",k=s.p+"static/image/3586acf8a8a55e63519b2f2d898dd9e3.ccd2d478.webp",q=s.p+"static/image/953f7a9abf7a72af51d0ac988b9bf89c.2fe70166.webp",L=s.p+"static/image/1da2885ae37e6151250a6f85208d479e.44c68a57.webp",G=s.p+"static/image/00c6ae7fb4177c4c6cc399405cecbde6.0f56ae88.webp",T=s.p+"static/image/84d0869ce980bc207e5f10dfafeb0a5f.1c8ede84.webp",Y=s.p+"static/image/3f787b21e998f027a3e58da6d8cfef39.721e4522.webp",Z=s.p+"static/image/19166597702f79dbd43bead284f4f4b9.1aec39fc.webp",U=s.p+"static/image/7125b79abb821c0e59b16246770a0966.baedb393.webp",V=s.p+"static/image/b7777ece032bd8d474b64cf1a3b82c5f.85b3e795.gif",W=s.p+"static/image/a72aabb86b9d105e984bc57e8ba0b0eb.d3070cdb.webp",Q=s.p+"static/image/c1bd1431ab4006462c7e40bd4feb56ec.99da17eb.webp",M=s.p+"static/image/8e5f9ca3e3965dee7a3006244243f05e.987df315.webp",y=s.p+"static/image/b18a6a1bdfba17a4f0da15665f230eb6.4550c298.webp",D=s.p+"static/image/53741c72ba251a8fadf3baef9b2338c3.c5c83e6f.webp",O=s.p+"static/image/57ba1e7d551b8a861730109a53e36af8.24371357.webp";function z(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,c.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.h1,{id:"22-如何自定义-exception-filter",children:["22. 如何自定义 Exception Filter",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#22-如何自定义-exception-filter",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"Exception Filter 是在 Nest 应用抛异常的时候，捕获它并返回一个对应的响应。"}),"\n",(0,t.jsx)(n.p,{children:"比如路由找不到时返回 404："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:O,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"服务端报错时返回 500："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:D,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"参数的错误返回 400："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:y,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这些都是 Exception Filter 做的事情。"}),"\n",(0,t.jsx)(n.p,{children:"那么，如果我们想自定义异常时返回的响应格式呢？"}),"\n",(0,t.jsx)(n.p,{children:"这种就要自定义 Exception Filter 了。"}),"\n",(0,t.jsx)(n.p,{children:"创建个 nest 项目："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest new exception-filter-test\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:M,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"把它跑起来："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:Q,alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["浏览器访问 ",(0,t.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," 可以看到 hello world，代表服务跑起来了："]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"然后在 controller 里抛个异常："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:W,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"throw new HttpException('xxxx', HttpStatus.BAD_REQUEST)\n"})}),"\n",(0,t.jsx)(n.p,{children:"这个 HttpStatus 就是一些状态码的常量："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:V,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这时候刷新页面，返回的就是 400 对应的响应："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:U,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这个响应的格式是内置的 Exception Filter 生成的。"}),"\n",(0,t.jsx)(n.p,{children:"当然，你也可以直接抛具体的异常："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:Z,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:Y,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"然后我们自己定义个 exception filter："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g filter hello --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:"--flat 是不生成 hello 目录，--no-spec 是不生成测试文件。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:T,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:G,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"@Catch 指定要捕获的异常，这里指定 BadRequestException。"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, BadRequestException, Catch, ExceptionFilter } from '@nestjs/common';\n\n@Catch(BadRequestException)\nexport class HelloFilter implements ExceptionFilter {\n  catch(exception: BadRequestException, host: ArgumentsHost) {\n    debugger;\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"先打个断点。"}),"\n",(0,t.jsx)(n.p,{children:"在 AppModule 里引入："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:L,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"app.useGlobalFilters(new HelloFilter());\n"})}),"\n",(0,t.jsx)(n.p,{children:"如果你想局部启用，可以加在 handler 或者 controller 上："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:q,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:k,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"然后新建个调试配置文件："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:X,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"输入调试配置："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:S,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "type": "node",\n    "request": "launch",\n    "name": "debug nest",\n    "runtimeExecutable": "npm",\n    "args": [\n        "run",\n        "start:dev",\n    ],\n    "skipFiles": [\n        "<node_internals>/**"\n    ],\n    "console": "integratedTerminal",\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"把之前的服务关掉，点击调试启动："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:I,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"刷新页面，代码会在断点处断住："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:N,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们只要根据异常信息返回对应的响应就可以了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:C,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, BadRequestException, Catch, ExceptionFilter, HttpException } from '@nestjs/common';\nimport { Response } from 'express';\n\n@Catch(BadRequestException)\nexport class HelloFilter implements ExceptionFilter {\n  catch(exception: BadRequestException, host: ArgumentsHost) {\n    const http = host.switchToHttp();\n    const response = http.getResponse<Response>();\n\n    const statusCode = exception.getStatus();\n\n    response.status(statusCode).json({\n       code: statusCode,\n       message: exception.message,\n       error: 'Bad Request',\n       xxx: 111\n    })\n  }\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"这样，抛异常时返回的响应就是自定义的了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:B,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"但我们只是 @Catch 了 BadRequestException"}),"\n",(0,t.jsx)(n.p,{children:"如果抛的是其他异常，依然是原来的格式："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:P,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"比如我抛一个 BadGatewayException。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:R,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"依然是默认格式。"}),"\n",(0,t.jsx)(n.p,{children:"那我们只要 @Catch 指定 HttpException 不就行了？"}),"\n",(0,t.jsx)(n.p,{children:"因为 BadRequestExeption、BadGateWayException 等都是它的子类。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:v,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"试一下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:F,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:H,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"确实，现在所有的 HttpException 都会被处理了。"}),"\n",(0,t.jsx)(n.p,{children:"但其实这也有个问题。"}),"\n",(0,t.jsx)(n.p,{children:"就是当我们用了 ValidationPipe 的时候。"}),"\n",(0,t.jsx)(n.p,{children:"比如我们加一个路由："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Post('aaa') \naaa(@Body() aaaDto: AaaDto ){\n    return 'success';\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"然后创建 src/aaa.dto.ts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"export class AaaDto {\n    aaa: string;\n    \n    bbb: number;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm install --save class-validator class-transformer\n"})}),"\n",(0,t.jsx)(n.p,{children:"然后给 AaaDto 添加几个校验规则："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { IsEmail, IsNotEmpty, IsNumber } from \"class-validator\";\n\nexport class AaaDto {\n    @IsNotEmpty({message: 'aaa 不能为空'})\n    @IsEmail({}, {message: 'aaa 不是邮箱格式'})\n    aaa: string;\n    \n    @IsNumber({}, {message: 'bbb 不是数字'})\n    @IsNotEmpty({message: 'bbb 不能为空'})\n    bbb: number;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 main.ts 启用 ValidationPipe："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:w,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"app.useGlobalPipes(new ValidationPipe());\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 postman 里测试下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:E,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"可以看到，提示的错误也不对了。"}),"\n",(0,t.jsx)(n.p,{children:"因为我们自定义的 exception filter 会拦截所有 HttpException，但是没有对这种情况做支持。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:A,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"先不加这个 filter。"}),"\n",(0,t.jsx)(n.p,{children:"这时候响应是这样的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:u,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们对这种情况做下支持："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:f,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"启用自定义的 filter，然后打个断点："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"再次访问会在断点处断住："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:g,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"可以看到 ValidationPipe 的 response 格式是这样的。"}),"\n",(0,t.jsx)(n.p,{children:"所以我们可以这样改："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:m,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, BadRequestException, Catch, ExceptionFilter, HttpException } from '@nestjs/common';\nimport { Response } from 'express';\n\n@Catch(HttpException)\nexport class HelloFilter implements ExceptionFilter {\n  catch(exception: HttpException, host: ArgumentsHost) {\n    const http = host.switchToHttp();\n    const response = http.getResponse<Response>();\n\n    const statusCode = exception.getStatus();\n\n    const res = exception.getResponse() as { message: string[] };\n    \n    response.status(statusCode).json({\n       code: statusCode,\n       message: res?.message?.join ? res?.message?.join(',') : exception.message,\n       error: 'Bad Request',\n       xxx: 111\n    })\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"如果 response.message 是个数组，就返回 join 的结果，否则还是返回 exception.message"}),"\n",(0,t.jsx)(n.p,{children:"再试下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:h,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:j,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"现在，ValidationPipe 的错误和其他的错误就都返回了正确的格式。"}),"\n",(0,t.jsx)(n.p,{children:"那如果我想在 Filter 里注入 AppService 呢？"}),"\n",(0,t.jsx)(n.p,{children:"这就需要改一下注册方式："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"不用 useGlobalFilters 注册了，而是在 AppModule 里注册一个 token 为 APP_FILTER 的 provider："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:o,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_FILTER,\n  useClass: HelloFilter\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Nest 会把所有 token 为 APP_FILTER 的 provider 注册为全局 Exception Filter。"}),"\n",(0,t.jsx)(n.p,{children:"注册多个 Filter 也是这么写。"}),"\n",(0,t.jsx)(n.p,{children:"其余的全局 Guard、Interceptor、Pipe 也是这样注册："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:d,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这样注册的好处就是可以注入其他 provider 了："}),"\n",(0,t.jsx)(n.p,{children:"比如我注入了 AppService，然后调用它的 getHello 方法："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:l,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, BadRequestException, Catch, ExceptionFilter, HttpException, Inject } from '@nestjs/common';\nimport { Response } from 'express';\nimport { AppService } from './app.service';\n\n@Catch(HttpException)\nexport class HelloFilter implements ExceptionFilter {\n\n  @Inject(AppService)\n  private service: AppService;\n\n  catch(exception: HttpException, host: ArgumentsHost) {\n    const http = host.switchToHttp();\n    const response = http.getResponse<Response>();\n\n    const statusCode = exception.getStatus();\n\n    const res = exception.getResponse() as { message: string[] };\n    \n    response.status(statusCode).json({\n       code: statusCode,\n       message: res?.message?.join ? res?.message?.join(',') : exception.message,\n       error: 'Bad Request',\n       xxx: 111,\n       yyy: this.service.getHello()\n    })\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"可以看到，service 方法调用成功了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:p,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"此外，如果你想自定义 Exception 也是可以的。"}),"\n",(0,t.jsx)(n.p,{children:"比如添加一个 src/unlogin.filter.ts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { ArgumentsHost, Catch, ExceptionFilter, HttpStatus } from '@nestjs/common';\nimport { Response } from 'express';\n\nexport class UnLoginException{\n  message: string;\n\n  constructor(message?){\n    this.message = message;\n  }\n}\n\n@Catch(UnLoginException)\nexport class UnloginFilter implements ExceptionFilter {\n  catch(exception: UnLoginException, host: ArgumentsHost) {\n    const response = host.switchToHttp().getResponse<Response>();\n\n    response.status(HttpStatus.UNAUTHORIZED).json({\n      code: HttpStatus.UNAUTHORIZED,\n      message: 'fail',\n      data: exception.message || '用户未登录'\n    }).end();\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"我们创建了一个 UnloginException 的异常。"}),"\n",(0,t.jsx)(n.p,{children:"然后在 ExceptionFilter 里 @Catch 了它。"}),"\n",(0,t.jsx)(n.p,{children:"在 AppModule 里注册这个全局 Filter："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:r,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_FILTER,\n  useClass: UnloginFilter\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"之后在 AppController 里抛出这个异常："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:i,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"浏览器里访问下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:a,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"可以看到，返回的是我们自定义的格式。"}),"\n",(0,t.jsx)(n.p,{children:"也就是说，可以用自定义 Exception Filter 捕获内置的或者自定义的 Exception。"}),"\n",(0,t.jsxs)(n.p,{children:["案例代码在",(0,t.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/exception-filter-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,t.jsxs)(n.h2,{id:"总结",children:["总结",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"这节我们学习了自定义 Exception Filter。"}),"\n",(0,t.jsx)(n.p,{children:"通过 @Catch 指定要捕获的异常，然后在 catch 方法里拿到异常信息，返回对应的响应。"}),"\n",(0,t.jsx)(n.p,{children:"如果捕获的是 HttpException，要注意兼容下 ValidationPipe 的错误格式的处理。"}),"\n",(0,t.jsx)(n.p,{children:"filter 可以通过 @UseFilters 加在 handler 或者 controller 上，也可以在 main.ts 用 app.useGlobalFilters 全局启用。"}),"\n",(0,t.jsx)(n.p,{children:"如果 filter 要注入其他 provider，就要通过 AppModule 里注册一个 token 为 APP_FILTER 的 provider 的方式。"}),"\n",(0,t.jsx)(n.p,{children:"此外，捕获的 Exception 也是可以自定义的。"}),"\n",(0,t.jsx)(n.p,{children:"这样，我们就可以自定义异常和异常返回的响应格式了。"})]})}function J(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(z,{...e})}):z(e)}let K=J;J.__RSPRESS_PAGE_META={},J.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F22.%20%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%20Exception%20Filter.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"22. 如何自定义 Exception Filter",headingTitle:"22. 如何自定义 Exception Filter",frontmatter:{}}}}]);