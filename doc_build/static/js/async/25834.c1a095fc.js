"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["25834"],{108306:function(e,a,t){t.r(a),t.d(a,{default:()=>I});var n=t(552676),c=t(740453);let r=t.p+"static/image/5d681d0d49c4d0df2c4d8b5527419ff6.1a272902.webp",s=t.p+"static/image/d7bad32c2b8d3db9d733222d9e9fd6f2.e9716675.webp",d=t.p+"static/image/b93331574be4c474bc7408b43e04d5bd.e7c7a7ff.webp",i=t.p+"static/image/3d9ab2d4bf6e5ef3b131b05a8be5c1f8.70052640.webp",l=t.p+"static/image/c43de7980cb4b181e1fc8e8fc1a0eed7.c3b65a30.webp",p=t.p+"static/image/d1126d4e84df02001c6bf0996b25fb68.ed7ffea0.webp",j=t.p+"static/image/bd8a1534864bf1b73d62fc8a22cfa956.b9cc82dd.webp",h=t.p+"static/image/062cd6e038644e2e1e5573515d122cdf.b3e0e559.webp",m=t.p+"static/image/5b5bde9fc79119c032251b5ed4028790.46c858cf.webp",x=t.p+"static/image/098523c555365eb7a0ce5e3e71a063e9.87e14f96.webp",f=t.p+"static/image/8779fd083e51089a6337ef4718ce0e9a.f02fd980.webp",o=t.p+"static/image/52c2e44ab45d1f7957eff14961283ea5.d731e3e5.webp",b=t.p+"static/image/9b6bc24bb5d30ecfc82492910909db47.29df34ce.webp",g=t.p+"static/image/9d60a40899099acb568ae8075c18d26c.753f61b0.webp",u=t.p+"static/image/fd981fb3f23f971ab7720e083b1ebcac.4eb03af9.webp",y=t.p+"static/image/bc2b2a06748e77e3f460e5213c9cdf84.7d66112e.webp",w=t.p+"static/image/3699e47dd19f6fb5055e2bcbb9cb0c5f.c8b6c2be.webp",A=t.p+"static/image/5ce5ebf7c3157ea0e2cc5238513540ed.0e07d813.webp",R=t.p+"static/image/d6a63d5bb6be4e5d3b94925f0e01dab5.4c8ada73.webp",k=t.p+"static/image/10cd0ceeb5e0e72a5c1f615cd9e53375.28a3398a.webp",C=t.p+"static/image/ea1b43eafee47189ec11968da815a7ea.4dc5666b.webp",T=t.p+"static/image/e3dfa6b612b35c90de85d5c052cb1bfd.9440a4ae.webp",M=t.p+"static/image/6c507a94c8d8bcc250bd05c9783873ca.46073f65.webp",v=t.p+"static/image/351dd2026e66df37033d6d812f640698.744045e9.webp",S=t.p+"static/image/10b0d465698007fe7e7f6e72f7d4a40e.2de45dfa.webp",F=t.p+"static/image/a66e087b1a1ef226cac1f8406470913c.be6799be.webp",G=t.p+"static/image/ea19e421c7e2a5f74ba8942bd36b51f3.3623d195.webp",K=t.p+"static/image/83b8f73b5e9f8c816ec3c97cee1a1eb5.d98b7f17.webp",N=t.p+"static/image/763eb807799e001d01bd0e0dee97e893.bd802691.webp",V=t.p+"static/image/71a5483f8d74971e11ecd89fbac645b0.8d768025.webp",B=t.p+"static/image/184594c7d821e45e82f068e6d17d05b0.b4503ed8.webp",P=t.p+"static/image/23f3acdd8986c48c2998cf8d16ee1bd9.7f909268.webp",z=t.p+"static/image/8f736cc692883e4e530adf2055609908.3a807722.webp",O=t.p+"static/image/c047597b5471388ac1784baf84472096.1547aad0.webp",U=t.p+"static/image/481b9fd34566cc5ba7440f3584064dad.dcf774ca.webp",Y=t.p+"static/image/8d9a71b8c29c8b5f77a08ebdc50bed8d.91842a5d.webp",q=t.p+"static/image/942a082b5434b509b05fbec5ee9ac7e0.887a5b7f.webp";function E(e){let a=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",strong:"strong",h2:"h2"},(0,c.ah)(),e.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(a.h1,{id:"13-metadata-和-reflector",children:["13. Metadata 和 Reflector",(0,n.jsx)(a.a,{className:"header-anchor","aria-hidden":"true",href:"#13-metadata-和-reflector",children:"#"})]}),"\n",(0,n.jsx)(a.p,{children:"不知道大家有没有感觉很神奇，只是通过装饰器声明了一下，然后启动 Nest 应用，这时候对象就给创建好了，依赖也给注入了。"}),"\n",(0,n.jsx)(a.p,{children:"那它是怎么实现的呢？"}),"\n",(0,n.jsx)(a.p,{children:"大家如果就这样去思考它的实现原理，还真不一定能想出来，因为缺少了一些前置知识。也就是实现 Nest 最核心的一些 api： Reflect 的 metadata 的 api。"}),"\n",(0,n.jsx)(a.p,{children:"有的同学会说，Reflect 的 api 我很熟呀，就是操作对象的属性、方法、构造器的一些 api："}),"\n",(0,n.jsx)(a.p,{children:"比如 Reflect.get 是获取对象属性值"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:q,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.set 是设置对象属性值"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:Y,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.has 是判断对象属性是否存在"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:U,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.apply 是调用某个方法，传入对象和参数"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:O,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.construct 是用构造器创建对象实例，传入构造器参数"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:z,alt:""})}),"\n",(0,n.jsxs)(a.p,{children:["这些 api 在 ",(0,n.jsx)(a.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect",target:"_blank",rel:"noopener noreferrer",children:"MDN 文档"}),"里可以查到，因为它们都已经是 es 标准了，也被很多浏览器实现了。"]}),"\n",(0,n.jsxs)(a.p,{children:["但是实现 Nest 用到的 api 还没有进入标准，还在草案阶段，也就是 ",(0,n.jsx)(a.a,{href:"https://rbuckton.github.io/reflect-metadata/",target:"_blank",rel:"noopener noreferrer",children:"metadata 的 api"}),"："]}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:P,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"它有这些 api："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-typescript",children:"Reflect.defineMetadata(metadataKey, metadataValue, target);\n\nReflect.defineMetadata(metadataKey, metadataValue, target, propertyKey);\n\n\nlet result = Reflect.getMetadata(metadataKey, target);\n\nlet result = Reflect.getMetadata(metadataKey, target, propertyKey);\n"})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.defineMetadata 和 Reflect.getMetadata 分别用于设置和获取某个类的元数据，如果最后传入了属性名，还可以单独为某个属性设置元数据。"}),"\n",(0,n.jsx)(a.p,{children:"那元数据存在哪呢？"}),"\n",(0,n.jsx)(a.p,{children:"存在类或者对象上呀，如果给类或者类的静态属性添加元数据，那就保存在类上，如果给实例属性添加元数据，那就保存在对象上，用类似 [[metadata]] 的 key 来存的。"}),"\n",(0,n.jsx)(a.p,{children:"这有啥用呢？"}),"\n",(0,n.jsx)(a.p,{children:"看上面的 api 确实看不出啥来，但它也支持装饰器的方式使用："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-javascript",children:"@Reflect.metadata(metadataKey, metadataValue)\nclass C {\n\n  @Reflect.metadata(metadataKey, metadataValue)\n  method() {\n  }\n}\n\n"})}),"\n",(0,n.jsx)(a.p,{children:"Reflect.metadata 装饰器当然也可以再封装一层："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-typescript",children:'function Type(type) {\n    return Reflect.metadata("design:type", type);\n}\nfunction ParamTypes(...types) {\n    return Reflect.metadata("design:paramtypes", types);\n}\nfunction ReturnType(type) {\n    return Reflect.metadata("design:returntype", type);\n}\n\n@ParamTypes(String, Number)\nclass Guang {\n  constructor(text, i) {\n  }\n\n  @Type(String)\n  get name() { return "text"; }\n\n  @Type(Function)\n  @ParamTypes(Number, Number)\n  @ReturnType(Number)\n  add(x, y) {\n    return x + y;\n  }\n}\n'})}),"\n",(0,n.jsx)(a.p,{children:"然后我们就可以通过 Reflect metadata 的 api 获取这个类和对象的元数据了："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-typescript",children:'let obj = new Guang("a", 1);\n\nlet paramTypes = Reflect.getMetadata("design:paramtypes", obj, "add"); \n// [Number, Number]\n'})}),"\n",(0,n.jsx)(a.p,{children:"这里我们用 Reflect.getMetadata 的 api 取出了 add 方法的参数的类型。"}),"\n",(0,n.jsx)(a.p,{children:"看到这里，大家是否明白 nest 的原理了呢？"}),"\n",(0,n.jsx)(a.p,{children:"我们再看下 nest 的源码："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:B,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"上面就是 @Module 装饰器的实现，里面就调用了 Reflect.defineMetadata 来给这个类添加了一些元数据。"}),"\n",(0,n.jsx)(a.p,{children:"所以我们这样用的时候："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{children:"import { Module } from '@nestjs/common';\nimport { CatsController } from './cats.controller';\nimport { CatsService } from './cats.service';\n\n@Module({\n  controllers: [CatsController],\n  providers: [CatsService],\n})\nexport class CatsModule {}\n"})}),"\n",(0,n.jsx)(a.p,{children:"其实就是给 CatsModule 添加了 controllers 的元数据和 providers 的元数据。"}),"\n",(0,n.jsx)(a.p,{children:"后面创建 IOC 容器的时候就会取出这些元数据来处理："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:V,alt:""})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:N,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"而且 @Controller 和 @Injectable 的装饰器也是这样实现的："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:K,alt:""})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:G,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Nest 的实现原理就是通过装饰器给 class 或者对象添加元数据，然后初始化的时候取出这些元数据，进行依赖的分析，然后创建对应的实例对象就可以了。"}),"\n",(0,n.jsx)(a.p,{children:"所以说，nest 实现的核心就是 Reflect metadata 的 api。"}),"\n",(0,n.jsx)(a.p,{children:"当然，现在 metadata 的 api 还在草案阶段，需要使用 reflect-metadata 这个 polyfill 包才行。"}),"\n",(0,n.jsx)(a.p,{children:"其实还有一个疑问，依赖的扫描可以通过 metadata 数据，但是创建的对象需要知道构造器的参数，现在并没有添加这部分 metadata 数据呀："}),"\n",(0,n.jsx)(a.p,{children:"比如这个 CatsController 依赖了 CatsService，但是并没有添加 metadata 呀："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-typescript",children:"import { Body, Controller, Get, Param, Post } from '@nestjs/common';\nimport { CatsService } from './cats.service';\nimport { CreateCatDto } from './dto/create-cat.dto';\n\n@Controller('cats')\nexport class CatsController {\n  constructor(private readonly catsService: CatsService) {}\n\n  @Post()\n  async create(@Body() createCatDto: CreateCatDto) {\n    this.catsService.create(createCatDto);\n  }\n\n  @Get()\n  async findAll(): Promise<Cat[]> {\n    return this.catsService.findAll();\n  }\n}\n"})}),"\n",(0,n.jsx)(a.p,{children:"这就不得不提到 TypeScript 的优势了，TypeScript 支持编译时自动添加一些 metadata 数据："}),"\n",(0,n.jsx)(a.p,{children:"比如这段代码："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{children:'import "reflect-metadata";\n \nclass Guang {\n  @Reflect.metadata("名字", "光光")\n  public say(a: number): string {\n    return \'加油鸭\';\n  }\n}\n'})}),"\n",(0,n.jsx)(a.p,{children:"按理说我们只添加了一个元数据，生成的代码也确实是这样的："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:F,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"但是呢，ts 有一个编译选项叫做 emitDecoratorMetadata，开启它就会自动添加一些元数据。"}),"\n",(0,n.jsx)(a.p,{children:"开启之后再试一下："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:S,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"你会看到多了三个元数据："}),"\n",(0,n.jsx)(a.p,{children:"design:type 是 Function，很明显，这个是描述装饰目标的元数据，这里装饰的是函数"}),"\n",(0,n.jsx)(a.p,{children:"design:paramtypes 是 [Number]，很容易理解，就是参数的类型"}),"\n",(0,n.jsx)(a.p,{children:"design:returntype 是 String，也很容易理解，就是返回值的类型"}),"\n",(0,n.jsx)(a.p,{children:"所以说，只要开启了这个编译选项，ts 生成的代码会自动添加一些元数据。"}),"\n",(0,n.jsx)(a.p,{children:"然后创建对象的时候就可以通过 design:paramtypes 来拿到构造器参数的类型了，那不就知道怎么注入依赖了么？"}),"\n",(0,n.jsx)(a.p,{children:"所以，nest 源码里你会看到这样的代码："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:v,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"就是获取构造器的参数类型的。这个常量就是我们上面说的那个："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:M,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"这也是为什么 nest 会用 ts 来写，因为它很依赖这个 emitDecoratorMetadata 的编译选项。"}),"\n",(0,n.jsx)(a.p,{children:"你用 cli 生成的代码模版里也都默认开启了这个编译选项："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:T,alt:""})}),"\n",(0,n.jsxs)(a.p,{children:["这就是 nest 的核心实现原理：",(0,n.jsx)(a.strong,{children:"通过装饰器给 class 或者对象添加 metadata，并且开启 ts 的 emitDecoratorMetadata 来自动添加类型相关的 metadata，然后运行的时候通过这些元数据来实现依赖的扫描，对象的创建等等功能。"})]}),"\n",(0,n.jsx)(a.p,{children:"Nest 的装饰器都是依赖 reflect-metadata 实现的，而且还提供了一个 @SetMetadata 的装饰器让我们可以给 class、method 添加一些 metadata："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:C,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"这个装饰器的底层实现自然是 Reflect.defineMetadata："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:k,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"Nest 为什么暴露这样一个底层的 metadata api 出来呢？"}),"\n",(0,n.jsx)(a.p,{children:"因为这个 metadata 是可以在代码里取出来用的："}),"\n",(0,n.jsx)(a.p,{children:"我们创建新项目来测试下："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{children:"nest new metadata-and-reflector -p npm\n"})}),"\n",(0,n.jsx)(a.p,{children:"创建 guard 和 interceptor："}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{children:"nest g interceptor aaa --flat --no-spec\nnest g guard aaa --flat --no-spec\n"})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:R,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"在路由级别应用："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:A,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"加个打印语句："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:w,alt:""})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:y,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"然后 nest start --watch 把服务跑起来。"}),"\n",(0,n.jsx)(a.p,{children:"浏览器访问："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,n.jsx)(a.p,{children:"可以看到 guard 和 interceptor 成功执行了："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:u,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"然后我们用 @SetMetadata 在 controller 上加个 metadata："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:g,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"在 guard 和 interceptor 就就可以这样取出来："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:b,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"通过 ExecutationContext 取到目标 handler，然后注入 reflector，通过 reflector.get 取出 handler 上的 metadata。"}),"\n",(0,n.jsx)(a.p,{children:"interceptor 里也是这样，这里换种属性注入方式："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:o,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"刷新下页面，就可以看到已经拿到了 metadata："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:f,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"拿到 metadata 有什么用呢？"}),"\n",(0,n.jsx)(a.p,{children:"可以判断权限呀，比如这个路由需要 admin 角色，那可以取出 request 的 user 对象，看看它有没有这个角色，有才放行。"}),"\n",(0,n.jsx)(a.p,{children:"当然这只是一种用途。"}),"\n",(0,n.jsx)(a.p,{children:"除了能拿到 handler 上的装饰器，也可以拿到 class 上的："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:x,alt:""})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:m,alt:""})}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:h,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"reflector 还有 3 个方法："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:j,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"这 4 个方法有啥区别呢？"}),"\n",(0,n.jsxs)(a.p,{children:["看下",(0,n.jsx)(a.a,{href:"https://github.com/nestjs/nest/blob/5bba7e9d264319490f142ca5e8099c559fa7e7e3/packages/core/services/reflector.service.ts#L11-L97",target:"_blank",rel:"noopener noreferrer",children:"它们的源码"}),"就知道了："]}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:p,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"get 的实现就是 Reflect.getMetadata。"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:l,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"getAll 是返回一个 metadata 的数组。"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:i,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"getAllAndMerge，会把它们合并为一个对象或者数组。"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:d,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"getAllAndOverride 会返回第一个非空的 metadata。"}),"\n",(0,n.jsx)(a.p,{children:"我们试一下："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:s,alt:""})}),"\n",(0,n.jsx)(a.p,{children:"可以看到它们结果的区别："}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)("img",{src:r,alt:""})}),"\n",(0,n.jsxs)(a.p,{children:["案例代码在",(0,n.jsx)(a.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/metadata-and-reflector",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,n.jsxs)(a.h2,{id:"总结",children:["总结",(0,n.jsx)(a.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,n.jsx)(a.p,{children:"Nest 的装饰器的实现原理就是 Reflect.getMetadata、Reflect.defineMetadata 这些 api。通过在 class、method 上添加 metadata，然后扫描到它的时候取出 metadata 来做相应的处理来完成各种功能。"}),"\n",(0,n.jsx)(a.p,{children:"Nest 的 Controller、Module、Service 等等所有的装饰器都是通过 Reflect.meatdata 给类或对象添加元数据的，然后初始化的时候取出来做依赖的扫描，实例化后放到 IOC 容器里。"}),"\n",(0,n.jsx)(a.p,{children:"实例化对象还需要构造器参数的类型，这个开启 ts 的 emitDecoratorMetadata 的编译选项之后， ts 就会自动添加一些元数据，也就是 design:type、design:paramtypes、design:returntype 这三个，分别代表被装饰的目标的类型、参数的类型、返回值的类型。"}),"\n",(0,n.jsx)(a.p,{children:"当然，reflect metadata 的 api 还在草案阶段，需要引入 reflect metadata 的包做 polyfill。"}),"\n",(0,n.jsx)(a.p,{children:"Nest 还提供了 @SetMetadata 的装饰器，可以在 controller 的 class 和 method 上添加 metadata，然后在 interceptor 和 guard 里通过 reflector 的 api 取出来。"}),"\n",(0,n.jsx)(a.p,{children:"理解了 metadata，nest 的实现原理就很容易搞懂了。"})]})}function H(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:a}=Object.assign({},(0,c.ah)(),e.components);return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(E,{...e})}):E(e)}let I=H;H.__RSPRESS_PAGE_META={},H.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F13.%20Metadata%20%E5%92%8C%20Reflector.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"13. Metadata 和 Reflector",headingTitle:"13. Metadata 和 Reflector",frontmatter:{}}}}]);