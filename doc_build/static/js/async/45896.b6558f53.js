"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["45896"],{667879:function(e,n,s){s.r(n),s.d(n,{default:()=>el});var r=s(552676),i=s(740453);let c=s.p+"static/image/0cc9d6087c85ecc1b3dfa19327c851e5.dfc6fc82.webp",a=s.p+"static/image/ff8d0680f5e348697bc117c920852f92.9cdcac5a.webp",t=s.p+"static/image/5d61bae81381c682223652ccf5670b8a.9e0b4c13.webp",l=s.p+"static/image/6a201f8b7d4caad9ce1b2777544c69c2.9c8b6840.webp",d=s.p+"static/image/f03283625bb8612f6bc529327570c049.7017df78.webp",p=s.p+"static/image/a90b8ce45ff938061c4794165377d8f9.16eb01e6.webp",o=s.p+"static/image/a39093ee4a9c31e6e9946ea25fee410d.29ee1a68.webp",m=s.p+"static/image/5a74d066a4485f6dca742b764b802c53.a1c49b37.webp",j=s.p+"static/image/becc34c10825591537f191c1be797192.72eb3787.webp",h=s.p+"static/image/45d45de65a92659ef5dc79301b415895.25688c2d.webp",x=s.p+"static/image/5de9a573200c870a80eb27473ce758f5.05951514.webp",g=s.p+"static/image/5f64c8a223d9215b5166558ecf9f137e.43851bd2.webp",f=s.p+"static/image/6c878a494cd6fcc475b21a716ef0b2e7.8af77fae.webp",b=s.p+"static/image/7fcd73cc6db9b6c5f9c0b47852647d72.fad1bd15.webp",u=s.p+"static/image/34639f004604fcb209c62a1b14c17c04.25612e1a.webp",v=s.p+"static/image/188202ceab3c16809780f17a22ac40eb.1f371355.webp",w=s.p+"static/image/4401751dc56bfb4e4eab154985ae1936.4b83c8b7.webp",y=s.p+"static/image/4e38ece0b593e0c084448d592b08d923.7d85a7c6.webp",A=s.p+"static/image/e125e9b0d2adb044697fcc665744f15d.74a31e94.webp",S=s.p+"static/image/4a79ecedd0bf1355c7fdfc686ca7e099.ce2d451a.webp",E=s.p+"static/image/2db93dbdb33111f5e4846c4073931f47.c15c6d4b.webp",R=s.p+"static/image/07155862b8b676d58be2d19af58ffcd5.701b9d60.webp",C=s.p+"static/image/7d84e041aaee399136cf45d648182fcc.3f7eedfe.webp",P=s.p+"static/image/ed22fdb0b27c861b1d75f6a16c477b82.cf111dd8.webp",I=s.p+"static/image/1a79e3bd3f1c6cb4352364d230b36f1c.01e49451.webp",D=s.p+"static/image/284767dc40cef98967324305e5e6bee9.8c6181d3.webp",B=s.p+"static/image/16078ebef565ddbf63192a65fd4e1c6e.5726ad31.webp",k=s.p+"static/image/0a609f87412e1c4b9aedae041a9494a8.af70111e.webp",F=s.p+"static/image/f83cb21068f53a1fe9e8c4ec2c14bd8f.ddb09e7d.webp",G=s.p+"static/image/0c5d0efc9c8b54ded2f8f3c19515d9e7.ad8602d3.webp",L=s.p+"static/image/02d76931bb08a57943428c65bd1b8f4c.17e424a7.webp",N=s.p+"static/image/8c4218255bd69169c1001037d52f52eb.a5626d42.webp",W=s.p+"static/image/acd2b42d62d487b2763525e1d7082bf4.f15b8f5b.webp",q=s.p+"static/image/129a1daf61b611ffd1ad90fd0dfa3d5a.547680ac.webp",M=s.p+"static/image/47c7c966f871b4065071f1c6f821948d.c36e0469.webp",T=s.p+"static/image/9cb338effbfc71bf4ded5fb829ec9b98.b3fe1298.webp",O=s.p+"static/image/3c8165972fd1d6a5cb0d901a6cd3116b.46e961fd.webp",U=s.p+"static/image/0496b10a67e6e6fbe8d236825f432405.57b885ed.webp",Z=s.p+"static/image/07fadabd660b6dd283e18c376bb621c1.28fe1e4c.webp",Q=s.p+"static/image/ba622f29b9acae52df5351f1c0efc98e.c9067576.webp",K=s.p+"static/image/9ea5669d1d271dfa32bf655f9bad7398.4bec8af9.webp",X=s.p+"static/image/aa098776ede7cf15be19f2ca5916953b.85397714.webp",H=s.p+"static/image/4cc52855accd1fe731ff1d5f491c3367.203b1ad4.webp",V=s.p+"static/image/8e716811f45fe8131fa67073256599eb.99f58d8b.webp",J=s.p+"static/image/a99a67e0fc8f637f405f526877ac8b51.dd7c1f3d.webp",z=s.p+"static/image/d7cb7890c0e2ecb6e5e579a38ba201d8.e0426152.webp",Y=s.p+"static/image/83fab932a2825e7fadad15f52d0f5733.4b9201e1.webp",_=s.p+"static/image/0d3785eb95f1f880af2490d812a2dab3.493bb5e8.webp",$=s.p+"static/image/7832fb83d541c39c46a746ccb859abb8.ddeb3199.webp",ee=s.p+"static/image/c85f5ac6744f1ff8bf30ec2d597f2d48.17a08cc8.webp",en=s.p+"static/image/9fc0afe252c13bf9d4270dd045170b20.02b5a29b.webp",es=s.p+"static/image/05ba72f1e077abf0bd207e541a7e387f.31b7bb74.webp",er=s.p+"static/image/ac25255907d3cf896e4ff078a44d3d82.b61f2df6.webp",ei=s.p+"static/image/00bf49cf698886a671732fc55864b696.9694700e.webp",ec=s.p+"static/image/625bd05df63a6b3bcc52290c1fc85498.336cb82d.webp";function ea(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",strong:"strong",h2:"h2"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"90-实现基于邮箱验证码的登录",children:["90. 实现基于邮箱验证码的登录",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#90-实现基于邮箱验证码的登录",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"上节我们学习了用 Node 来收发邮件，其实 Node 发邮件最常见的场景还是邮箱验证码。"}),"\n",(0,r.jsx)(n.p,{children:"比如登录的时候除了可以通过用户名、密码来验证身份，还可以通过邮箱验证码来验证。"}),"\n",(0,r.jsx)(n.p,{children:"这节我们就实现下这个功能。"}),"\n",(0,r.jsx)(n.p,{children:"首先，我们写个简单的登录页面:"}),"\n",(0,r.jsx)(n.p,{children:"通过 create-react-app 创建个项目："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npx create-react-app email-login-frontend\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后进入项目把开发服务跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ec,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ei,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"安装 antd："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install antd --save\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后来写下登录 UI："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import React from 'react';\nimport { Button, Form, Input } from 'antd';\n\nconst login = (values) => {\n  console.log('Success:', values);\n};\n\nconst sendEmailCode = () => {\n  console.log('send email code')\n}\n\nconst App = () => (\n  <div style={{width: '500px', margin: '100px auto'}}>\n    <Form onFinish={login}>\n\n      <Form.Item\n        label=\"邮箱\"\n        name=\"email\"\n        rules={[\n          {\n            required: true,\n            message: '请输入邮箱地址',\n          },\n        ]}\n      >\n        <Input />\n      </Form.Item>\n\n      <Form.Item\n        label=\"验证码\"\n        name=\"code\"\n        rules={[\n          {\n            required: true,\n            message: '请输入验证码',\n          },\n        ]}\n      >\n        <Input/>\n      </Form.Item>\n\n      <Form.Item>\n        <Button onClick={sendEmailCode}>发送验证码</Button>\n      </Form.Item>\n\n      <Form.Item>\n        <Button type=\"primary\" htmlType=\"submit\">登录</Button>\n      </Form.Item>\n\n    </Form>\n  </div>\n);\nexport default App;\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 App.js 输入上面的代码，就可以看到登录页面："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:er,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"比较丑，但功能是没问题的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:es,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们再来写下后端代码。"}),"\n",(0,r.jsx)(n.p,{children:"创建个 nest 项目："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new email-login-backend -p npm\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:en,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 main.ts 启用跨域，并且修改下端口号（因为前端项目开发服务也用这个端口号）："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ee,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问可以看到 hello world 代表 nest 服务跑成功了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在前端项目里访问下。"}),"\n",(0,r.jsx)(n.p,{children:"在前端项目安装 axios："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save axios\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后调用下接口："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import axios from 'axios';\n\nconst login = (values) => {\n  console.log('Success:', values);\n};\n\nconst sendEmailCode = async () => {\n  const res = await axios.get('http://localhost:3001');\n\n  console.log(res);\n  console.log('send email code')\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"试一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:$,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"接口调通了。"}),"\n",(0,r.jsx)(n.p,{children:"然后回到后端项目，我们继续写后端接口："}),"\n",(0,r.jsx)(n.p,{children:"创建 user 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g resource user\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:_,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"安装 typeorm 的依赖："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 引入 TypeOrmModule："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { UserModule } from './user/user.module';\n\n@Module({\n  imports: [\n    UserModule,\n    TypeOrmModule.forRoot({\n      type: \"mysql\",\n      host: \"localhost\",\n      port: 3306,\n      username: \"root\",\n      password: \"guang\",\n      database: \"email_login_test\",\n      synchronize: true,\n      logging: true,\n      entities: [],\n      poolSize: 10,\n      connectorPackage: 'mysql2',\n      extra: {\n          authPlugin: 'sha256_password',\n      }\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后我们在 mysql workbench 创建个新的 database："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"输入 database 或者叫 schema 的名字，指定字符集为 utf8mb4。"}),"\n",(0,r.jsx)(n.p,{children:"点击 apply 可以看到生成的 sql："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"改下 User 的 entity："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Column, Entity, PrimaryGeneratedColumn } from \"typeorm\";\n\n@Entity()\nexport class User {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 50,\n        comment: '用户名'\n    })\n    username: string;\n\n    @Column({\n        length: 50,\n        comment: '密码'\n    })\n    password: string;\n\n    @Column({\n        length: 50,\n        comment: '邮箱地址'\n    }) \n    email: string;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"user 表有 id、username、password、email 这 4 个字段。"}),"\n",(0,r.jsx)(n.p,{children:"在 TypeOrm 的 entities 注册下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:J,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"保存，nest 服务会自动重新跑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:V,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到 user 表被创建了。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:H,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这次我们手动插入下数据："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:X,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"输入内容后，点击 apply，可以看到生成的 sql："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:K,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"你直接执行这个 sql 来插入数据也行："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"INSERT INTO `email_login_test`.`user` \n  (`id`, `username`, `password`, `email`) \n  VALUES ('1', 'aaaa', 'bbbb', 'xxx@xx.com');\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里邮箱要改成你自己的，因为待会要发邮件用。"}),"\n",(0,r.jsx)(n.p,{children:"之后来添加下发邮件的接口。"}),"\n",(0,r.jsx)(n.p,{children:"添加个 email 模块，这次不用生成 crud 代码了："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g resource email\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们安装 nodemailer 包来发邮件："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save nodemailer\n\nnpm install --save-dev @types/nodemailer\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 MailService 里来发邮件："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Injectable } from '@nestjs/common';\nimport { createTransport, Transporter} from 'nodemailer';\n\n@Injectable()\nexport class EmailService {\n\n    transporter: Transporter\n    \n    constructor() {\n        this.transporter = createTransport({\n            host: \"smtp.qq.com\",\n            port: 587,\n            secure: false,\n            auth: {\n                user: 'xx@xx.com',\n                pass: '你的授权码'\n            },\n        });\n    }\n\n    async sendMail({ to, subject, html }) {\n      await this.transporter.sendMail({\n        from: {\n          name: '系统邮件',\n          address: 'xx@xx.com'\n        },\n        to,\n        subject,\n        html\n      });\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"把邮箱和授权码改成你自己的。"}),"\n",(0,r.jsx)(n.p,{children:"然后添加一个 controller 方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Controller, Get, Query } from '@nestjs/common';\nimport { EmailService } from './email.service';\n\n@Controller('email')\nexport class EmailController {\n  constructor(private readonly emailService: EmailService) {}\n\n  @Get('code')\n  async sendEmailCode(@Query(\"address\") address) {\n    await this.emailService.sendMail({\n      to: address,\n      subject: '登录验证码',\n      html: '<p>你的登录验证码是 123456</p>'\n    });\n    return '发送成功';\n  }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们调用下试试："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:U,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"发送成功，邮箱里确实也收到了这封邮件："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:O,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:T,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"回过头来看一下，我们现在是把邮箱相关信息直接写在代码里了。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"实际上这些应该从配置读取。"}),"\n",(0,r.jsx)(n.p,{children:"我们安装下配置模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save @nestjs/config\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 里引入，并且把它声明为全局的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:q,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"ConfigModule.forRoot({\n    isGlobal: true,\n    envFilePath: 'src/.env'\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 src 下添加这个 .env 文件："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 EmailService 里注入 ConfigService，从中读取配置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:W,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Injectable } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { createTransport, Transporter} from 'nodemailer';\n\n@Injectable()\nexport class EmailService {\n\n    transporter: Transporter\n    \n    constructor(private configService: ConfigService) {\n      this.transporter = createTransport({\n          host: \"smtp.qq.com\",\n          port: 587,\n          secure: false,\n          auth: {\n              user: this.configService.get('email_user'),\n              pass: this.configService.get('email_password')\n          },\n      });\n    }\n\n    async sendMail({ to, subject, html }) {\n      await this.transporter.sendMail({\n        from: {\n          name: '系统邮件',\n          address: this.configService.get('email_user')\n        },\n        to,\n        subject,\n        html\n      });\n    }\n\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"再调用下接口，这时依然是正常的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:N,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"说明配置正确读取出来了。"}),"\n",(0,r.jsx)(n.p,{children:"不过用了 .env 配置文件之后有个问题："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"dist 目录下没有这个文件。"}),"\n",(0,r.jsx)(n.p,{children:".env 需要配置下 assets 才会复制过去。"}),"\n",(0,r.jsx)(n.p,{children:"改下 nest-cli.json"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"添加 assets 为 *.env 这样就会在编译的时候把 src 下的 .env 文件复制到 dist 下。"}),"\n",(0,r.jsxs)(n.p,{children:["注意，",(0,r.jsx)(n.strong,{children:"assets 只支持 src 下的文件复制"}),"。如果你是放在根目录，那就要自己复制了。"]}),"\n",(0,r.jsx)(n.p,{children:"改了编译配置需要重新跑服务："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时就可以在 dist 下看到这个文件了。"}),"\n",(0,r.jsx)(n.p,{children:"但现在你改了 src 下的 .env 之后，dist 下的 .env 不会跟着改，需要重新跑服务才可以。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时候可以加一个 watchAssets："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后再重新跑下服务。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时候改了 src 下的 .env 就会立刻复制了。"}),"\n",(0,r.jsxs)(n.p,{children:["也就是说，",(0,r.jsx)(n.strong,{children:"如果你用到了 .env 文件或者 yaml 等文件来配置，需要在 nest-cli.json 里配置下 assets 和 watchAssets。"})]}),"\n",(0,r.jsx)(n.p,{children:"回过头来继续搞验证码的事情。"}),"\n",(0,r.jsx)(n.p,{children:"首先，验证码要随机，我们通过 Math.random 来生成："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const code = Math.random().toString().slice(2,8);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在前端项目里调用下看看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:R,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"通过 useForm 创建 form 实例，然后就可以通过 form.getFieldsValue 拿到表单值了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import React from 'react';\nimport { Button, Form, Input } from 'antd';\nimport axios from 'axios';\n\nconst login = (values) => {\n  console.log('Success:', values);\n};\n\nconst App = () => {\n  const [form] = Form.useForm();\n\n  const sendEmailCode = async () => {\n    const res = await axios.get('http://localhost:3001');\n  \n    console.log(form.getFieldsValue());\n\n    console.log(res);\n    console.log('send email code')\n  }\n  \n\n  return <div style={{width: '500px', margin: '100px auto'}}>\n    <Form form={form} onFinish={login}>\n\n      <Form.Item\n        label=\"邮箱\"\n        name=\"email\"\n        rules={[\n          {\n            required: true,\n            message: '请输入邮箱地址',\n          },\n        ]}\n      >\n        <Input />\n      </Form.Item>\n\n      <Form.Item\n        label=\"验证码\"\n        name=\"code\"\n        rules={[\n          {\n            required: true,\n            message: '请输入验证码',\n          },\n        ]}\n      >\n        <Input/>\n      </Form.Item>\n\n      <Form.Item>\n        <Button onClick={sendEmailCode}>发送验证码</Button>\n      </Form.Item>\n\n      <Form.Item>\n        <Button type=\"primary\" htmlType=\"submit\">登录</Button>\n      </Form.Item>\n\n    </Form>\n  </div>\n};\nexport default App;\n"})}),"\n",(0,r.jsx)(n.p,{children:"在点击发送验证码的时候，验证下邮箱是否为空，不为空就调用后端接口来发送验证码："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { message } from 'antd';\n\nconst App = () => {\n  const [form] = Form.useForm();\n\n  const sendEmailCode = async () => {\n    const email = form.getFieldValue('email');\n    \n    console.log(email)\n    if(!email) {\n      message.error('邮箱不能为空');\n      return;\n    }\n\n    const res = await axios.get('http://localhost:3001/email/code', {\n      params: {\n        address: email\n      }\n    });\n  \n    message.info(res.data);\n  }\n  \n"})}),"\n",(0,r.jsx)(n.p,{children:"我们来试试看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"点击发送验证码，这个邮箱收到了一封验证码的邮件："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们来实现下登录。"}),"\n",(0,r.jsx)(n.p,{children:"登录就是根据用户填的信息去数据库匹配，如果匹配到了就查询出该用户的信息，放入 session 或者 jwt 里。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"验证用户身份的信息，可以是用户名 + 密码，也可以是邮箱 + 验证码。"}),"\n",(0,r.jsx)(n.p,{children:"用邮箱验证码验证用户身份的流程是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"用户填入邮箱地址，点击发送验证码，后端会生成验证码，发送邮件。并且还要把这个验证码存入 redis，以用户邮箱地址为 key。"}),"\n",(0,r.jsx)(n.p,{children:"之后用户输入验证码，点击登录。"}),"\n",(0,r.jsx)(n.p,{children:"后端根据邮箱地址去 redis 中查询下验证码，和用户传过来的验证码比对下，如果一致，就从 mysql 数据库中查询该用户的信息，放入 jwt 中返回。"}),"\n",(0,r.jsx)(n.p,{children:"思路理清了，我们来实现下："}),"\n",(0,r.jsx)(n.p,{children:"创建个 redis 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g resource redis  --no-spec\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"安装 redis 的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install redis --save\n"})}),"\n",(0,r.jsx)(n.p,{children:"把 RedisModule 声明为全局模块，并导出 RedisService。"}),"\n",(0,r.jsx)(n.p,{children:"然后添加一个 provider："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Global, Module } from '@nestjs/common';\nimport { RedisService } from './redis.service';\nimport { RedisController } from './redis.controller';\nimport { createClient } from 'redis';\n\n@Global()\n@Module({\n  controllers: [RedisController],\n  providers: [RedisService, {\n    provide: 'REDIS_CLIENT',\n    async useFactory() {\n      const client = createClient({\n          socket: {\n              host: 'localhost',\n              port: 6379\n          }\n      });\n      await client.connect();\n      return client;\n    }\n  }],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 RedisService 里封装 redis 的 get、set 方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType;\n\n    async get(key: string) {\n        return await this.redisClient.get(key);\n    }\n\n    async set(key: string, value: string | number, ttl?: number) {\n        await this.redisClient.set(key, value);\n\n        if(ttl) {\n            await this.redisClient.expire(key, ttl);\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后修改下发送邮箱验证码的逻辑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"注入 RedisService，并且发送验证码之前把它存入 redis，key 为 captcha_邮箱地址。"}),"\n",(0,r.jsx)(n.p,{children:"这里的 captcha 就是验证码的意思。"}),"\n",(0,r.jsx)(n.p,{children:"过期时间为 5 分钟。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Controller, Get, Inject, Query } from '@nestjs/common';\nimport { RedisService } from 'src/redis/redis.service';\nimport { EmailService } from './email.service';\n\n@Controller('email')\nexport class EmailController {\n  constructor(private readonly emailService: EmailService) {}\n\n  @Inject()\n  private redisService: RedisService;\n\n  @Get('code')\n  async sendEmailCode(@Query(\"address\") address) {\n    const code = Math.random().toString().slice(2,8);\n\n    await this.redisService.set(`captcha_${address}`, code, 5 * 60);\n\n    await this.emailService.sendMail({\n      to: address,\n      subject: '登录验证码',\n      html: `<p>你的登录验证码是 ${code}</p>`\n    });\n    return '发送成功';\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们试试看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"输入邮箱地址，点击发送验证码。"}),"\n",(0,r.jsx)(n.p,{children:"邮箱收到了这个验证码："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"redis 里也保存了一份："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"接下来只要填入这个验证码，点击登录就可以了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们再来实现下登录接口："}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 里添加一个路由："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nlogin(@Body() loginUserDto: LoginUserDto) {\n    console.log(loginUserDto);\n    return 'success';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"定义这个 LoginUserDto："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后需要对它做校验，我们引入 class-validator 和 class-transformer："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save class-validator class-transformer\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 main.ts 里全局启用 ValidationPipe："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后给 LoginUserDto 添加一些约束："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { IsEmail, IsNotEmpty, Length } from "class-validator";\n\nexport class LoginUserDto {\n    @IsNotEmpty()\n    @IsEmail()\n    email: string;\n\n    @IsNotEmpty()\n    @Length(6)\n    code: string;\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"在 postman 里测试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,r.jsx)(n.p,{children:"我们来实现下具体的验证逻辑:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject(RedisService)\nprivate redisService: RedisService;\n\n@Post('login')\nasync login(@Body() loginUserDto: LoginUserDto) {\n\n    const { email, code } = loginUserDto;\n\n    const codeInRedis = await this.redisService.get(`captcha_${email}`);\n\n    if(!codeInRedis) {\n      throw new UnauthorizedException('验证码已失效');\n    }\n    if(code !== codeInRedis) {\n      throw new UnauthorizedException('验证码不正确');\n    }\n\n    const user = await this.userService.findUserByEmail(email);\n\n    console.log(user);\n\n    return 'success';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"从 redis 中查找这个邮箱对应的验证码。"}),"\n",(0,r.jsx)(n.p,{children:"如果没查找，就返回验证码已失效。"}),"\n",(0,r.jsx)(n.p,{children:"查到的话和用户传过来的验证码对比，如果不一致，就返回验证码不正确。"}),"\n",(0,r.jsx)(n.p,{children:"验证码通过之后，从数据库中查询这个用户的信息。"}),"\n",(0,r.jsx)(n.p,{children:"我们在 UserService 里实现下这个方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\nprivate entityManager: EntityManager;\n\nasync findUserByEmail(email: string) {\n    return await this.entityManager.findOneBy(User, {\n      email\n    });\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在前端代码里调用下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const login = async (values) => {\n  const res = await axios.post('http://localhost:3001/user/login', {\n    email: values.email,\n    code: values.code\n  });\n  if(res.data === 'success') {\n    message.success('登录成功');\n  } else {\n    message.error(res.data.message);\n  }\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们整体试一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"输入邮箱，点击发送验证码。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"收到了验证码邮件，并且 redis 里也存了这个 key："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"带上这个验证码请求："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到服务端通过了校验，并且从数据库中查询出了用户信息："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"接下来只要返回对应的 jwt token 就好了。"}),"\n",(0,r.jsx)(n.p,{children:"这部分可以参考前面 jwt 登录章节的内容，就不展开了。"}),"\n",(0,r.jsx)(n.p,{children:"案例代码上传了小册仓库："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/email-login-frontend",target:"_blank",rel:"noopener noreferrer",children:"前端代码"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/email-login-backend",target:"_blank",rel:"noopener noreferrer",children:"后端代码"})}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"这节我们实现了基于邮箱验证码的登录。"}),"\n",(0,r.jsx)(n.p,{children:"流程可以看这张图："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"综合用到了 mysql、redis、typeorm、nodemailer 等技术。"}),"\n",(0,r.jsx)(n.p,{children:"并且使用 @nestjs/config 包的 ConfigModule 来封装配置。"}),"\n",(0,r.jsx)(n.p,{children:"要注意的是，如果用了 .env 文件，需要保证它在 src 下，并且要在 nest-cli.json 里配置 assets 和 watchAssets，不然 build 的时候不会复制到 dist 下。"}),"\n",(0,r.jsx)(n.p,{children:"这节实现的功能，前后端代码都有，算是一个不错的综合练习。"})]})}function et(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(ea,{...e})}):ea(e)}let el=et;et.__RSPRESS_PAGE_META={},et.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F90.%20%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E7%99%BB%E5%BD%95.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"90. 实现基于邮箱验证码的登录",headingTitle:"90. 实现基于邮箱验证码的登录",frontmatter:{}}}}]);