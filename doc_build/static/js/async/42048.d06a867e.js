"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["42048"],{953251:function(e,n,s){s.r(n),s.d(n,{default:()=>X});var r=s(552676),c=s(740453);let t=s.p+"static/image/11b36938ebed132dcec7c9fbc2d1904f.a414e80f.webp",d=s.p+"static/image/14bacf3afbe40bbb7df03f034c61a8b0.f8b58c77.webp",i=s.p+"static/image/c9a9c092303d6fd13633d0bf1e492841.896a24aa.webp",o=s.p+"static/image/5047be4dea11f476c992be6ce42bf281.a9663564.webp",a=s.p+"static/image/29d7b07217b02f9d0c733a5527096eb6.da87c618.webp",l=s.p+"static/image/5d65f9b2d93540ae21065a57a4c06f6f.88260c42.webp",p=s.p+"static/image/6e9cbe291cd272788c2f60866eb76458.cbd655d5.webp",j=s.p+"static/image/922628d7a8a17af6834437f173e7251a.06d7c289.webp",h=s.p+"static/image/a28a41884bf816815d008ae541a8ad28.1d7a4d48.webp",x=s.p+"static/image/72866ca6588982d7b87c0c087dcc1c07.abb6a1c3.webp",g=s.p+"static/image/03a65fad42a79046b16e00fe3ad39c81.dadc45c2.webp",b=s.p+"static/image/0cffee48d01b17aaf79df6b821a3b0f7.da80770e.webp",f=s.p+"static/image/556e3140d57f6121ee7b89fbf6f0be28.71365c5e.webp",m=s.p+"static/image/547d2f5381fc8436802434f78ac75b6e.af40e2e9.webp",u=s.p+"static/image/ba91e1a96c4aa7f8d50f9ae69170a95d.dc732e28.webp",v=s.p+"static/image/b1b99a736cd043941b903c7b95b695bd.3fe753b3.webp";function A(e){let n=Object.assign({blockquote:"blockquote",p:"p",a:"a",h2:"h2",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",pre:"pre",code:"code",img:"img",strong:"strong"},(0,c.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["代码仓库：",(0,r.jsx)(n.a,{href:"https://github.com/czm1290433700/test_demo",target:"_blank",rel:"noopener noreferrer",children:"https://github.com/czm1290433700/test_demo"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"上节课我们学习了怎么覆盖滚动等复杂场景，因为单元测试的能力限制，所以我们没办法通过单元测试来覆盖，端对端测试可以帮我们覆盖这部分测试内容。端对端测试通常由质量保障团队进行整个项目维度的用户视角测试，相比单元测试，更容易还原用户的操作行为，而且不需要知道内部代码的实现即可编写。"}),"\n",(0,r.jsx)(n.p,{children:"现在我们已经学习了很多自动化测试的知识，我们可以快速为一个组件来覆盖自动化测试的用例，但是怎么衡量我们的用例写的好不好，覆盖是否完整呢？这个就需要用到覆盖率的统计了。"}),"\n",(0,r.jsxs)(n.h2,{id:"覆盖率指标",children:["覆盖率指标",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#覆盖率指标",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"什么是测试覆盖率？简单来说，它是我们测试用例覆盖文件的质量指标，可以验证到代码中的每一行是否都被测试用例经过，通常它包含下面的四个指标 ( 不同版本之间名字可能会略微不同，比如复数、缩写等 ）："}),"\n",(0,r.jsxs)(n.table,{children:["\n",(0,r.jsxs)(n.thead,{children:["\n",(0,r.jsxs)(n.tr,{children:["\n",(0,r.jsx)(n.th,{children:"指标名称"}),"\n",(0,r.jsx)(n.th,{children:"指标内容"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.tbody,{children:["\n",(0,r.jsxs)(n.tr,{children:["\n",(0,r.jsx)(n.td,{children:"statement"}),"\n",(0,r.jsx)(n.td,{children:"语句覆盖率，是不是每个语句都执行了"}),"\n"]}),"\n",(0,r.jsxs)(n.tr,{children:["\n",(0,r.jsx)(n.td,{children:"branch"}),"\n",(0,r.jsx)(n.td,{children:"分支覆盖率，是不是每个 if 判断都执行了"}),"\n"]}),"\n",(0,r.jsxs)(n.tr,{children:["\n",(0,r.jsx)(n.td,{children:"function"}),"\n",(0,r.jsx)(n.td,{children:"函数覆盖率，是不是每个函数都执行了"}),"\n"]}),"\n",(0,r.jsxs)(n.tr,{children:["\n",(0,r.jsx)(n.td,{children:"line"}),"\n",(0,r.jsx)(n.td,{children:"行覆盖率，是不是每行都执行了"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"jest-单元测试覆盖率",children:["Jest 单元测试覆盖率",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#jest-单元测试覆盖率",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"现在我们来尝试覆盖 Jest 的那部分单元测试，因为我们是 CRA 项目，所以我们在 package.json 中加入下面的覆盖率相关的配置，如果非 CRA 项目，可以在 jest.config.js 中加入。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// ./package.json\n"scripts": {\n    "test": "react-scripts test",\n    "test:all": "react-scripts test --watchAll",\n    "test:updateSnap": "react-scripts test --updateSnapshot",\n    "test:coverage": "react-scripts test --coverage",\n },\n // other\n "jest": {\n    "transform": {\n      "^.+\\.(t|j)sx?$": "babel-jest"\n    },\n    "transformIgnorePatterns": [\n      "node_modules/(?!axios)"\n    ],\n    "moduleNameMapper": {\n      "\\.(css|scss)$": "<rootDir>/styleMock.js"\n    },\n    // 只统计公共 components 下的非类型文件覆盖率\n    "collectCoverageFrom": [\n      "<rootDir>/src/components/**/*.{js,jsx,tsx,(!d).ts}"\n    ],\n    // 覆盖率卡点\n    "coverageThreshold": {\n      "global": {\n        "branches": 90,\n        "functions": 90,\n        "lines": 90,\n        "statements": 90\n      }\n    }\n },\n'})}),"\n",(0,r.jsx)(n.p,{children:"下面我们来解释一下上面的配置，其中 collectCoverageForm 用于配置我们希望覆盖的文件，其中是一个 glob 表达式的数组，我们这里要求覆盖公共 components 下的所有 js/ts(x) 文件，并且从当中筛掉了纯类型文件 (.d.ts) ，coverageThreshold 配置是覆盖率卡点，这里我们要求覆盖率在 90% 以上，不然就会报错。"}),"\n",(0,r.jsxs)(n.p,{children:["除了上面的两个配置，还有一个常用的配置，coverageDirectory 这个可以配置覆盖率生成的目录，因为这是 CRA 项目， package.json 中并不支持这个属性，如果我们要加的话，只能执行 ",(0,r.jsx)(n.code,{children:"npm run eject"}),"拆开 react-scripts 进而配置，这里并不强要求配置，所以我们这里跳过路径的自定义配置。下面我梳理了一份平时需求中常用的配置，有需求的同学可以参考一下："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"// 需要走babel转译的依赖，有一些依赖基于esm实现，需要转成commonjs\nconst ModuleNeedCompile2Cjs = [\n  'lodash-es',\n].join('|');\n\nmodule.exports = {\n  testEnvironment: 'jsdom', // 运行环境，不需要ui自动化写node\n  transform: {\n    // 转译使用的工具，可以换esbuild, swj\n    '^.+\\.(js|ts|tsx|jsx)$': '<rootDir>/node_modules/babel-jest', \n    // svg 的 mock，不用测\n    '^.+\\.svg$': '<rootDir>/__test__/mocks/svg-transform.js',\n  },\n  // 初始化的配置，引入 testing-library 的额外 expect 类型\n  setupFilesAfterEnv: ['<rootDir>/__test__/setup_test.js'],\n  moduleNameMapper: {\n    // css 的 mock\n    '\\.(css|less|sass|scss)$': 'identity-obj-proxy',\n    // 如果项目中有加 alias 别名可以这样指向一下，jest不走 webpack\n    '^@/(.*)$': '<rootDir>/src/$1',\n  },\n  // 需要转译成 commonjs 的依赖\n  transformIgnorePatterns: [`<rootDir>/node_modules/(?!(${ModuleNeedCompile2Cjs}))`],\n  // 需要收集单测覆盖率的文件，glob表达式，业务项目可以控制在公共components和hooks\n  collectCoverageFrom: [\n    '<rootDir>/src/**/*.{js,jsx,tsx,(!d).ts}',\n  ],\n  // 覆盖率生成的目录\n  coverageDirectory: '<rootDir>/__test__/cov',\n  // 覆盖率值的卡点，推荐业务 50% - 70%，架构 70% - 90%，涉及滚动，跳转等较难覆盖逻辑可以适当下调\n  coverageThreshold: {\n    global: {\n      branches: 90,\n      functions: 90,\n      lines: 90,\n      statements: 90,\n    },\n  },\n};\n"})}),"\n",(0,r.jsxs)(n.p,{children:["好了完成上面的配置后，我们可以尝试执行一下",(0,r.jsx)(n.code,{children:"npm run test:coverage"}),"命令，跑一下我们的覆盖率："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，覆盖得还是很不错的，都覆盖了 100%，不过最后一个组件 ScrollList， 因为我们是通过端对端测试覆盖了，所以这里覆盖率是 0 。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"光凭 Jest 的覆盖率肯定是不符合预期了，不然明明覆盖了的组件却不包括进来，岂不是白干了，下面我们来看看怎么覆盖 cypress 的那部分。"}),"\n",(0,r.jsxs)(n.h2,{id:"cypress-端对端测试覆盖率",children:["Cypress 端对端测试覆盖率",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#cypress-端对端测试覆盖率",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Cypress 本身是没有与 storybook 配套生成覆盖率的能力的，我们需要借助一个依赖的能力，babel-plugin-istanbul，这个插件的功能有点像插桩，它会为我们的每一行代码之间插入计时器，从而达到测试覆盖率的目的。我们可以先来安装一下依赖。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save-dev babel-plugin-istanbul\n"})}),"\n",(0,r.jsx)(n.p,{children:"因为 cypress 直接测试的其实是 storybook 的终端页面，所以我们为 storybook 配置一下 babel-plugin-istanbul 插件，其中 include 是需要插桩的目录，也就是我们希望统计覆盖率的目录。这样我们的 storybook 中就已经隐藏了覆盖率插桩了。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// .storybook/main.js\nmodule.exports = {\n  // ...other\n  babel: (options) => {\n    return {\n      ...options,\n      plugins: [\n        [\n          "babel-plugin-istanbul",\n          {\n            include: "src/components/**/*.{js,jsx,tsx,(!d).ts}",\n          },\n        ],\n      ],\n    };\n  },\n};\n'})}),"\n",(0,r.jsxs)(n.p,{children:["如果这时候我们打开 storybook，在终端中输入 window.",(0,r.jsx)(n.strong,{children:"coverage"})," ，就可以看到对应的覆盖率信息了。"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"不过光 storybook 中有还不行，我们要想办法把这个覆盖率生成到我们的项目文件中，需要安装 @cypress/code-coverage ，这是 coverage 提供的覆盖率支持，它本身并不会生成覆盖率，但它可以从测试页面中的终端中读取到对应的覆盖率配置，并生成我们需要的覆盖率文件。我们先来安装一下依赖。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm i --save-dev @cypress/code-coverage\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后我们在 cypress 的配置文件中加入下面的配置引入插件。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// ./cypress/support/e2e.ts\n// ... other\nimport "@cypress/code-coverage/support";\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// ./cypress.config.ts\nimport { defineConfig } from "cypress";\n\nexport default defineConfig({\n  e2e: {\n    // ...other\n    setupNodeEvents(on, config) {\n      require("@cypress/code-coverage/task")(on, config);\n      return config;\n    },\n    // ..other\n  },\n});\n'})}),"\n",(0,r.jsx)(n.p,{children:"完成这些步骤以后，我们可以尝试执行 cypress GUI 页面，并执行用例看看："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run cypress\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到用例执行的结果中已经有报告生成的记录了，每次生成以后，会把结果同步给 .nyc_output 和 coverage 目录，如下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们查看一下最终的覆盖率结果，还是挺不错的。如果不使用 cypress 手动触发覆盖率生成，我们使用上节课提到的 cypress:run 命令自动生成也是 ok 的。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsxs)(n.h2,{id:"覆盖率合并",children:["覆盖率合并",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#覆盖率合并",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"在合并之前，因为我们没自定义目录， cypress 和 jest 都会使用 coverage 目录，这样会有冲突影响后续覆盖率的合并，所以我们需要更改一下 jest 的覆盖率生成目录。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run eject\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后我们在 package.json 中加入下面的配置："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// package.json\n"coverageDirectory": "<rootDir>/jest/coverage"\n'})}),"\n",(0,r.jsx)(n.p,{children:"再重新生成，jest 的目录就会在 jest/coverage 下了。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们再补充一下 .gitignore，覆盖率可以不用提交上去，避免后续 CI 用了之前的覆盖率："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"// . /.gitignore\n# 15.Coverage：自动化测试覆盖率的统计\n/coverage\n/.nyc_output\n/jest/coverage/\n"})}),"\n",(0,r.jsx)(n.p,{children:"不过需要注意的是，使用 eject 后我们就不再是使用 react-scripts 了，storybook 中对应 react-scripts 的插件也需要去掉："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'// ./.storybook/main.js\naddons: [\n    "@storybook/addon-links",\n    "@storybook/addon-essentials",\n    "@storybook/addon-interactions",\n    "@storybook/preset-create-react-app", // 去掉\n  ],\n'})}),"\n",(0,r.jsx)(n.p,{children:"现在来合并我们的覆盖率，每次分俩报告，这个看起来实在麻烦，不知道大家有没发现，两份报告的 json 在格式上都是相似的，所以我们是可以做到合并的。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"为了实现合并的效果，我们需要借助 istanbul-combine 依赖，这个可以将多个覆盖率的报告合并为一个，可以在下面的终端中执行这个命令。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npx istanbul-combine -d test/merged -p detail -r lcov -r json \njest/coverage/coverage-final.json coverage/coverage-final.json\n"})}),"\n",(0,r.jsx)(n.p,{children:"其中 coverage/coverage-final.json 存放的是 cypress 的覆盖率，jest/coverage/coverage-final.json 存放的是 jest 的覆盖率，我们需要将它俩合并为一个，不过合并的过程中可能会遇到这个问题。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们按 ctrl 切到依赖中的位置，手动加入下面的代码，这个是 istanbul-combine 的一个已知问题，我看已经有 issue 反馈这个问题了，如果过段时间还没有被修复，我就给他们提个 PR 跟进解决一下。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们加上这行以后应该就可以正常运行了，可以看到我们的根目录生成了一个 test/merged 的文件，如下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"点开里面的覆盖率看看，可以看到已经合并了~现在就舒服多了。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"因为后面我们还需要集成到 CI 中，所以在服务器手动改依赖是不现实的，这边提供另一个合并的方案，我们先来安装一下依赖："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm i istanbul-merge --save-dev\n"})}),"\n",(0,r.jsxs)(n.p,{children:["然后我们修改一下 package.json，并且执行一下",(0,r.jsx)(n.code,{children:"npm run coverage:merge"}),"："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'"coverage:merge": "istanbul-merge --out coverage.json jest/coverage/coverage-final.json coverage/coverage-final.json",\n'})}),"\n",(0,r.jsx)(n.p,{children:"不过这个依赖不能生成 html，而且 star 比较少，但是效果的确是可以满足的。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这个合并后的 json 我们同样可以加到 .gitignore 中："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"// .gitignore\ncoverage.json\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"怎么提高测试覆盖率",children:["怎么提高测试覆盖率？",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#怎么提高测试覆盖率",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"那么我们怎么提高覆盖率呢？可以打开我们最终合并的覆盖率文件，右键用默认浏览器打开就可。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"通过点击文件，我们进到对应的文件中："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"如果有没覆盖到的情况，会标红，这里解释一下为什么 branch 覆盖率是 3/5 , 因为我们的插桩抓到了 5次滚动的执行，但是只有 3 次我们会执行 branch 的逻辑，这个是符合我们预期的。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"对于标红的图，大家可以参考 jest 的覆盖率图。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这些都是没有走到的逻辑，我们需要做的就是考虑怎么为它们覆盖到，保证用例能走到这些逻辑就好，这样就可以有效地提升覆盖率。"}),"\n",(0,r.jsxs)(n.h2,{id:"小结",children:["小结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#小结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"这节课我们学习了怎么进行自动化测试覆盖率的统计，因为我们分别使用了 jest 和 cypress 两种方式，所以需要为它们各自覆盖覆盖率，然后再将它们的覆盖率合并起来，通过对覆盖率的统计，我们可以很清晰地知道还有哪些代码没有被测试用例覆盖到，进而帮助我们补充这部分用例，使得我们组件发布的信心更高。"}),"\n",(0,r.jsx)(n.p,{children:"不过现在的测试流程还依赖我们自己执行命令，在多人合作中，我们没办法保证每个合作同学都会按约定去执行覆盖用例，并且保证用例能够正常去执行，所以我们要在 CI 流程中加入对应的测试节点，保证整个流程能够被规范用起来。下节课我们就来学习怎么将自动化测试整合到项目的持续集成当中。"})]})}function k(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(A,{...e})}):A(e)}let X=k;k.__RSPRESS_PAGE_META={},k.__RSPRESS_PAGE_META["%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E7%B2%BE%E8%AE%B2%2F15.Coverage%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87%E7%9A%84%E7%BB%9F%E8%AE%A1.md"]={toc:[{text:"覆盖率指标",id:"覆盖率指标",depth:2},{text:"Jest 单元测试覆盖率",id:"jest-单元测试覆盖率",depth:2},{text:"Cypress 端对端测试覆盖率",id:"cypress-端对端测试覆盖率",depth:2},{text:"覆盖率合并",id:"覆盖率合并",depth:2},{text:"怎么提高测试覆盖率？",id:"怎么提高测试覆盖率",depth:2},{text:"小结",id:"小结",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);