"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["14967"],{265889:function(e,n,c){e.exports=c.p+"static/image/05016f81e9e373009dd20bcaef3bbbe0.615ebf6d.webp"},625502:function(e,n,c){e.exports=c.p+"static/image/92783e045cfdacf79c329bb20a4cef2a.b2f19dc0.webp"},69695:function(e,n,c){e.exports=c.p+"static/image/b84d73a564467d13e1f6c6d2daa43c9b.b64a3405.webp"},679193:function(e,n,c){e.exports=c.p+"static/image/d89807ae6070cec01f8c59ae66e46b54.607e85e7.webp"},1990:function(e,n,c){e.exports=c.p+"static/image/f331d231afc1315df6806f5f96d792cd.6531fa7d.webp"},864471:function(e,n,c){e.exports=c.p+"static/image/f9153b5bdc56644eaa6b7ea13fcb68cd.b22f7f2e.webp"},92747:function(e,n,c){c.r(n),c.d(n,{default:()=>U});var i=c(552676),s=c(740453);let a=c.p+"static/image/7d32e3f3c69d04807938dadc227c2dc2.43aead78.webp",r=c.p+"static/image/b1b75910c73be7f906a082e405f71ed2.0f1e4c53.webp",d=c.p+"static/image/ac0ecc5f0c07bea1b5f6d73707f43874.01ebcef3.webp",t=c.p+"static/image/a0949130b4e6c65a1c8dd817256f6e0c.4edf8b23.webp",p=c.p+"static/image/2d3365ea2eff8e422a11e157df9aa080.b625a60c.webp",l=c.p+"static/image/19a2f116eaa2eb0983652200bc0a910e.95ced044.webp",j=c.p+"static/image/bbbabfc3eec1548443c9a018b265855e.daa4c6cb.webp",x=c.p+"static/image/daa80be45fa8a0b89cb02aff3d25ee52.d4ab0c47.webp",b=c.p+"static/image/6650b2db5b48c1bd13367ddf87356a2c.c4f0b050.webp",h=c.p+"static/image/eed46e1ed25624ce78952c6ef0597c68.858581d2.webp",o=c.p+"static/image/b3ce74c899324a279950eeae90b8ab22.a77aecc5.webp";var m=c(864471),g=c(625502);let f=c.p+"static/image/e725253ec285d2b266e222c60ce01db5.5cbd3538.webp",S=c.p+"static/image/9619f6753416313338503da4d2179da4.c03b8cd9.webp",u=c.p+"static/image/6d7d5726cc7db23a391fb79b366b508c.022ce64b.webp",w=c.p+"static/image/f1a8270d5579d7e96aa03cd1655ee3a4.71875760.webp",O=c.p+"static/image/b932dbbe1bad86c762d8b5b364aa55c1.99790852.webp",k=c.p+"static/image/70114daeaea05333755563df77407764.b2bde33e.webp";var _=c(265889);let E=c.p+"static/image/6795b8b66aab7618d3f31e79fc1dd73c.137676b2.webp",A=c.p+"static/image/9859f8cbde4f6625ddadbecb78a946e4.c7f22ab2.webp";var v=c(69695),y=c(679193),B=c(1990);let K=c.p+"static/image/5d9b151b4d7b305a9327f618b5cc5369.2d98549c.webp",C=c.p+"static/image/5b43267dc4069768ecbbf6bd81b321d0.18b5d50d.webp",N=c.p+"static/image/6d975fc84021ad1bf2ba8a154a1dc5ea.07bb419f.webp",P=c.p+"static/image/8daac0ceb1b5b7d2ab59de35b76ccb4b.c4545429.webp",R=c.p+"static/image/2f027a0aa41d1b7130fa43c33ec79eac.6f36ab3a.webp",I=c.p+"static/image/9f5b16125d1876cac72ba4ab5fea9ede.8b869fe2.webp",M=c.p+"static/image/484cd9edbe869aaff14fa590d6fab7b4.8aac3be6.webp",D=c.p+"static/image/554a2aab438e3fe02c017af7aa0c0b3f.26968c1a.webp",T=c.p+"static/image/69da6d908e787714c3f83b4e80e6b802.91355311.webp",q=c.p+"static/image/b709baa7fcaa58e9f3457f61945ea13e.fba3de5a.webp",G=c.p+"static/image/f0e9e85e6612a19e3ec4266a0874712e.ff6653e5.webp",W=c.p+"static/image/6ba976b5dc38b98525b41cd6adfbf451.5e4df9ac.webp",F=c.p+"static/image/1519a00fd2c43f5c6e0993a8da1c6697.4dccbd21.webp";function L(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,s.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"98-用-minio-自己搭一个-oss-服务",children:["98. 用 minio 自己搭一个 OSS 服务",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#98-用-minio-自己搭一个-oss-服务",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"文件上传是常见需求，一般我们不会直接把文件保存在服务器的某个目录下，因为服务器的存储容量是有限的，这样不好扩展。"}),"\n",(0,i.jsx)(n.p,{children:"我们会用 OSS （Object Storage Service）对象存储服务来存文件，它是支持分布式扩展的，不用担心存储容量问题，而且也好管理。"}),"\n",(0,i.jsx)(n.p,{children:"比如阿里云的 OSS 服务。"}),"\n",(0,i.jsx)(n.p,{children:"但是有一些业务场景下，数据需要保密，要求私有部署，也就是要在自己的机房里部署一套 OSS 服务。"}),"\n",(0,i.jsx)(n.p,{children:"这时候怎么办呢？"}),"\n",(0,i.jsx)(n.p,{children:"这种需求一般我们会用 minio 来做。"}),"\n",(0,i.jsx)(n.p,{children:"它可以实现和阿里云 OSS 一样的功能。"}),"\n",(0,i.jsx)(n.p,{children:"首先，我们用一下阿里云的 OSS 服务。"}),"\n",(0,i.jsx)(n.p,{children:"OSS 里的文件是放在一个个 Bucekt（桶）里的："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"我们创建个 Bucket："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后进入文件列表，就可以上传文件了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"因为创建的 Bucket 设置了公共读，所以可以直接访问："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:q,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"此外，阿里云 OSS 还可以通过 SDK 来上传文件。"}),"\n",(0,i.jsx)(n.p,{children:"创建个项目："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"mkdir minio-test\ncd minio-test\nnpm init -y\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"进入项目，安装 ali-oss："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install ali-oss\n"})}),"\n",(0,i.jsx)(n.p,{children:"创建 index.js"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const OSS = require('ali-oss')\n\nconst client = new OSS({\n    region: 'oss-cn-beijing',\n    bucket: 'guang-666',\n    accessKeyId: '',\n    accessKeySecret: '',\n});\n\nasync function put () {\n  try {\n    const result = await client.put('smile.png', './smile.png');\n    console.log(result);\n  } catch (e) {\n    console.log(e);\n  }\n}\n\nput();\n"})}),"\n",(0,i.jsx)(n.p,{children:"填入 region、bucket 和 accessKeyId、accessKeySecret"}),"\n",(0,i.jsx)(n.p,{children:"这里的 region 可以从概览里看到："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:D,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"acessKey 是在这里看："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:M,alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["具体创建 accessKey 的流程看",(0,i.jsx)(n.a,{href:"https://juejin.cn/book/7226988578700525605/section/7324620995183968293",target:"_blank",rel:"noopener noreferrer",children:"之前 OSS 那节"})]}),"\n",(0,i.jsx)(n.p,{children:"然后跑一下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"上传成功之后就可以通过 OSS 服务访问这个图片了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"也可以通过 sdk 下载图片："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"执行后可以看到，图片被下载下来了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这就是阿里云 OSS 的用法。"}),"\n",(0,i.jsx)(n.p,{children:"那我们用 minio 自己搭呢？"}),"\n",(0,i.jsxs)(n.p,{children:["首先，我们需要安装 ",(0,i.jsx)(n.a,{href:"https://www.docker.com/",target:"_blank",rel:"noopener noreferrer",children:"docker 桌面端"}),"："]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"打开后可以看到本地的所有镜像和容器："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:K,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"搜索下 minio（这步需要科学上网）："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"填入一些信息："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"name 是容器名。"}),"\n",(0,i.jsx)(n.p,{children:"port 是映射本地 9000 和 9001 端口到容器内的端口。"}),"\n",(0,i.jsx)(n.p,{children:"volume 是挂载本地目录到容器内的目录"}),"\n",(0,i.jsx)(n.p,{children:"这里挂载了一个本地一个目录到容器内的数据目录 /bitnami/minio/data，这样容器里的各种数据都保存在本地了。"}),"\n",(0,i.jsx)(n.p,{children:"还要指定两个环境变量，MINIO_ROOT_USER 和 MINIO_ROOT_PASSWORD，是用来登录的。"}),"\n",(0,i.jsx)(n.p,{children:"点击 run，跑起来之后可以看到数据目录被标记为 mounted，端口也映射成功了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["访问下 ",(0,i.jsx)(n.a,{href:"http://localhost:9001",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:9001"})]}),"\n",(0,i.jsx)(n.p,{children:"输入刚才环境变量填的用户名密码："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"进入管理界面："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这个 bucket 就是管理桶的地方，而 object browser 就是管理文件列表的地方。"}),"\n",(0,i.jsx)(n.p,{children:"和阿里云 OSS 用法一样。"}),"\n",(0,i.jsx)(n.p,{children:"我们创建个 bucket："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:_,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"然后在这个 bucket 下上传一个文件："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:O,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"点击 share 就可以看到这个文件的 url："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"现在倒是能在浏览器访问，只不过需要带后面的一长串东西："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"不带的话会提示拒绝访问："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:f,alt:"image.png"})}),"\n",(0,i.jsx)(n.p,{children:"因为现在文件访问权限不是公开的。"}),"\n",(0,i.jsx)(n.p,{children:"我们设置下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"添加一个 / 的匿名的访问规则。"}),"\n",(0,i.jsx)(n.p,{children:"然后就可以直接访问了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"是不是感觉用起来和阿里云的 OSS 差不多？"}),"\n",(0,i.jsx)(n.p,{children:"我们再来试试 sdk 的方式："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"npm install minio\n"})}),"\n",(0,i.jsx)(n.p,{children:"安装 minio 包。"}),"\n",(0,i.jsx)(n.p,{children:"然后创建 index2.js"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"var Minio = require('minio')\n\nvar minioClient = new Minio.Client({\n  endPoint: 'localhost',\n  port: 9000,\n  useSSL: false,\n  accessKey: '',\n  secretKey: '',\n})\n\nfunction put() {\n    minioClient.fPutObject('aaa', 'hello.png', './smile.png', function (err, etag) {\n        if (err) return console.log(err)\n        console.log('上传成功');\n    });\n}\n\nput();\n"})}),"\n",(0,i.jsxs)(n.p,{children:["创建用到的 accessKey：\n",(0,i.jsx)("img",{src:h,alt:""})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"跑一下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"可以看到，文件上传成功了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"同样，也可以下载文件："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const fs = require('fs');\n\nfunction get() {\n    minioClient.getObject('aaa', 'hello.png', (err, stream) => {\n        if (err) return console.log(err)\n        stream.pipe(fs.createWriteStream('./xxx.png'));\n    });\n}\n\nget();\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"用起来和阿里云 OSS 几乎一毛一样。"}),"\n",(0,i.jsxs)(n.p,{children:["更多的 api 用法可以看 ",(0,i.jsx)(n.a,{href:"https://min.io/docs/minio/linux/developers/javascript/minio-javascript.html",target:"_blank",rel:"noopener noreferrer",children:"minio 文档"}),"。"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"最后，还记得我们跑 docker 容器的时候指定了挂载目录么："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:r,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"这样，数据就会保存在本地的那个目录下："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(n.p,{children:"那为什么 OSS 服务都这么相似呢？"}),"\n",(0,i.jsx)(n.p,{children:"因为它们都是遵循 AWS 的 Simple Storage Service（S3）规范的，简称 S3 规范。"}),"\n",(0,i.jsx)(n.p,{children:"所以不管哪家的 OSS，用起来都是差不多的。"}),"\n",(0,i.jsxs)(n.p,{children:["案例代码上传了",(0,i.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/minio-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"总结",children:["总结",(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(n.p,{children:"文件上传一般我们都是用 OSS 服务来存储，比如阿里云的 OSS。"}),"\n",(0,i.jsx)(n.p,{children:"但是 OSS 是收费的，而且有些敏感数据不能传到云上，需要私有部署，这种就可以自己搭一个 OSS 服务。"}),"\n",(0,i.jsx)(n.p,{children:"我们用 docker 跑了一个 minio 的容器，然后分别在管理界面和用 npm 包的方式做了文件上传和下载。"}),"\n",(0,i.jsx)(n.p,{children:"用法和阿里云 OSS 差不多，因为他们都是亚马逊 S3 规范的实现。"}),"\n",(0,i.jsx)(n.p,{children:"你公司内部有没有自己用 minio 搭 OSS 服务呢？"})]})}function Q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(L,{...e})}):L(e)}let U=Q;Q.__RSPRESS_PAGE_META={},Q.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F98.%20%E7%94%A8%20minio%20%E8%87%AA%E5%B7%B1%E6%90%AD%E4%B8%80%E4%B8%AA%20OSS%20%E6%9C%8D%E5%8A%A1.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"98. 用 minio 自己搭一个 OSS 服务",headingTitle:"98. 用 minio 自己搭一个 OSS 服务",frontmatter:{}}}}]);