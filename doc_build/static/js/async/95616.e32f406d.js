"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["95616"],{535586:function(e,n,s){s.r(n),s.d(n,{default:()=>T});var a=s(552676),t=s(740453);let i=s.p+"static/image/e36dd367362c20dfca7def6e929721c9.6b7ac862.webp",c=s.p+"static/image/eaa2471e6f8579156a57960f2d1e695f.d0840120.webp",l=s.p+"static/image/e2d5103b73c38f2524c1bc6bd8442db8.7498be3f.webp",r=s.p+"static/image/e7f6c2d4a95d18b79571c37cae6e606c.43e4257c.webp",d=s.p+"static/image/93036ad8d6896731f077f392096656db.f55942cb.webp",p=s.p+"static/image/1cf483f665671cbcadabd997ef79cebf.dbf0a0a7.webp",o=s.p+"static/image/58142f63c6a935336534afd706055dbd.586c1865.webp",h=s.p+"static/image/3a4cd59eba69decf4c7f6b2cc756b5b0.5e578761.webp",m=s.p+"static/image/19f3f4bc1dfd861191f00c4ed7886153.669bbbfd.webp",x=s.p+"static/image/52d154c01d8ff9aa86c94e7e5d4dbb6a.bbef01ef.webp",f=s.p+"static/image/6bb176aff1be13d861f1afb979810b90.17424a1e.webp",j=s.p+"static/image/4288073a375024dbfd5244c3a947be2c.1d037bed.webp",b=s.p+"static/image/6ec0d5cd828e415cdc40d1bb552dc08f.ded7b3ca.webp",u=s.p+"static/image/f273a64c44445259c26fefbf7694b664.a5cc4f4a.webp",g=s.p+"static/image/6b1ffea96758df1b742839c99ea476cd.92fe42d0.webp",E=s.p+"static/image/006e46d8d7e46253154c27891c3ac8a8.e226c915.webp",w=s.p+"static/image/d0bb6a1a7e3b81baa8039c610d188511.6424510f.webp",y=s.p+"static/image/0bc0fd3abbfa91fd2ff7f91ac3b57061.586c04c5.webp",A=s.p+"static/image/8cba7e87da811630681072fddc12d923.86bd4253.webp",q=s.p+"static/image/d2878cbec3bc84a8212d00b4dd376cb8.7d3e8666.webp",D=s.p+"static/image/24e7068dd339f91dc06698e27d4c8668.a61dac4d.webp",S=s.p+"static/image/cd8434f13053d5bbc37362f4a0a2b03c.b7294315.webp",Z=s.p+"static/image/d6e2de72c9f36da825d105ae0448dbe8.1c72689f.webp";function N(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,t.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.h1,{id:"25-express-如何使用-multer-实现文件上传",children:["25. Express 如何使用 multer 实现文件上传",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#25-express-如何使用-multer-实现文件上传",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"Nest 的文件上传是基于 Express 的中间件 multer 实现的，所以在学习 Nest 文件上传之前，我们先学习下 multer 包的使用。"}),"\n",(0,a.jsx)(n.p,{children:"新建目录，npm init -y 创建 package.json"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:Z,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后安装 express 和 multer 还有 cors 包："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npm install express multer cors\n"})}),"\n",(0,a.jsx)(n.p,{children:"这个 cors 包是处理跨域 header 的。"}),"\n",(0,a.jsx)(n.p,{children:"然后创建 index.js，输入如下内容："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const express = require('express')\nconst multer  = require('multer')\nconst cors = require('cors');\n\nconst app = express()\napp.use(cors());\n\nconst upload = multer({ dest: 'uploads/' })\n\napp.post('/aaa', upload.single('aaa'), function (req, res, next) {\n  console.log('req.file', req.file);\n  console.log('req.body', req.body);\n})\n\napp.listen(3333);\n"})}),"\n",(0,a.jsx)(n.p,{children:"app.use 使用中间件 cors 来处理跨域。"}),"\n",(0,a.jsx)(n.p,{children:"用 multer 处理文件上传，指定保存目录为 uploads/。"}),"\n",(0,a.jsx)(n.p,{children:"然后新建这样一个 index.html："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n    <script src="https://unpkg.com/axios@0.24.0/dist/axios.min.js"><\/script>\n</head>\n<body>\n    <input id="fileInput" type="file"/>\n    <script>\n        const fileInput = document.querySelector(\'#fileInput\');\n\n        async function formData() {\n            const data = new FormData();\n            data.set(\'name\',\'光\');\n            data.set(\'age\', 20);\n            data.set(\'aaa\', fileInput.files[0]);\n\n            const res = await axios.post(\'http://localhost:3333/aaa\', data);\n            console.log(res);\n        }\n\n        fileInput.onchange = formData;\n    <\/script>\n</body>\n</html>\n'})}),"\n",(0,a.jsx)(n.p,{children:"通过 FormData + axios 上传文件，指定内容的传输格式 content-type 为 multipart/form-data。"}),"\n",(0,a.jsx)(n.p,{children:"（这里 axios 会自动根据内容指定 content-type，不需要手动指定）"}),"\n",(0,a.jsx)(n.p,{children:"然后用 node 把 server 跑起来，并且用 http-server 把静态服务跑起来："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:S,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:D,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这时候在 devtools 可以看到 aaa 请求的 body 是多个 boundary 分隔的格式："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:q,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"而分隔符是在 Content-Type 指定的："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:A,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这就是 form-data 的传输格式。"}),"\n",(0,a.jsx)(n.p,{children:"然后去服务端看看："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:y,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"req.file 可以拿到文件字段，其余非文件字段在 req.body。"}),"\n",(0,a.jsx)(n.p,{children:"并且服务端多了 uploads 目录，下面就保存着我们上传的文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:w,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"单文件上传我们会了，那多文件上传呢？"}),"\n",(0,a.jsx)(n.p,{children:"再添加一个路由处理多文件的上传："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:E,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"bbb 路由通过 array 方法来取上传的文件，并且指定最大数量的限制。"}),"\n",(0,a.jsx)(n.p,{children:"上传的文件通过 req.files 来取。"}),"\n",(0,a.jsx)(n.p,{children:"然后前端这样传："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n    <script src="https://unpkg.com/axios@0.24.0/dist/axios.min.js"><\/script>\n</head>\n<body>\n    <input id="fileInput" type="file" multiple/>\n    <script>\n        const fileInput = document.querySelector(\'#fileInput\');\n\n        async function formData2() {\n            const data = new FormData();\n            data.set(\'name\',\'光\');\n            data.set(\'age\', 20);\n            [...fileInput.files].forEach(item => {\n                data.append(\'bbb\', item)\n            })\n\n            const res = await axios.post(\'http://localhost:3333/bbb\', data);\n            console.log(res);\n        }\n\n        fileInput.onchange = formData2;\n    <\/script>\n</body>\n</html>\n'})}),"\n",(0,a.jsx)(n.p,{children:"input 标签添加 multiple 属性允许多选。"}),"\n",(0,a.jsx)(n.p,{children:"onchange 的时候取出每个 file，通过 append 方法添加到 bbb 字段。"}),"\n",(0,a.jsx)(n.p,{children:"（这里fileInput.files 是一个伪数组，要转成数组才能用 forEach 方法）"}),"\n",(0,a.jsx)(n.p,{children:"这样 bbb 实际上就保存着上传的多个文件了。"}),"\n",(0,a.jsx)(n.p,{children:"我们传下试试："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:g,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"node 服务的 req.files 接收到了多个文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:u,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"并且 uploads 目录下也多了俩文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:b,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这就是多文件上传。"}),"\n",(0,a.jsx)(n.p,{children:"那如果传了超过 2 个文件呢？"}),"\n",(0,a.jsx)(n.p,{children:"会报错。"}),"\n",(0,a.jsx)(n.p,{children:"我们添加一个错误处理中间件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:j,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"在 express 里，约定有 4 个参数的中间件为错误处理中间件。"}),"\n",(0,a.jsx)(n.p,{children:"一旦某个中间件出了错，express 就会向后找错误处理中间件来调用，如果没有，那就用默认错误处理中间件，返回 500 响应。"}),"\n",(0,a.jsx)(n.p,{children:"我们多传几个文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:f,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"可以看到服务端打印了报错："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:x,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"这样我们只要返回对应的响应就好了："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"app.post('/bbb', upload.array('bbb', 2), function (req, res, next) {\n    console.log('req.files', req.files);\n    console.log('req.body', req.body);\n}, function(err, req, res, next) {\n    if(err instanceof MulterError && err.code === 'LIMIT_UNEXPECTED_FILE') {\n        res.status(400).end('Too many files uploaded');\n    }\n})\n"})}),"\n",(0,a.jsx)(n.p,{children:"这样再次上传超过 2 个文件，就会收到服务端的 400 的响应，提示文件上传过多："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:m,alt:""})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"更复杂一点的情况，如果多个字段都会上传文件，而且限制也都不同呢？"}),"\n",(0,a.jsx)(n.p,{children:"那可以这样处理："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"app.post('/ccc', upload.fields([\n    { name: 'aaa', maxCount: 3 },\n    { name: 'bbb', maxCount: 2 }\n]), function (req, res, next) {\n    console.log('req.files', req.files);\n    console.log('req.body', req.body);\n})\n"})}),"\n",(0,a.jsx)(n.p,{children:"通过 fields 方法指定每个字段的名字和最大数量，然后接收到请求后通过 req.files['xxx'] 来取对应的文件信息。"}),"\n",(0,a.jsx)(n.p,{children:"其他非文件字段，同样是通过 req.body 来取。"}),"\n",(0,a.jsx)(n.p,{children:"前端写下对应的代码："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"async function formData3() {\n    const data = new FormData();\n    data.set('name','光');\n    data.set('age', 20);\n    data.append('aaa', fileInput.files[0]);\n    data.append('aaa', fileInput.files[1]);\n    data.append('bbb', fileInput.files[2]);\n    data.append('bbb', fileInput.files[3]);\n\n    const res = await axios.post('http://localhost:3333/ccc', data);\n    console.log(res);\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"这里本来要写两个 file input 分别上传 aaa、bbb 的文件，这里为了测试方便简化了下。"}),"\n",(0,a.jsx)(n.p,{children:"浏览器里再次上传："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:o,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"服务端收到了 aaa 和 bbb 的文件："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:p,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"此外，如果我们并不知道有哪些字段是 file 呢？"}),"\n",(0,a.jsx)(n.p,{children:"这时候可以用 any 来接收："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"app.post('/ddd', upload.any(), function(req, res, next) {\n    console.log('req.files', req.files);\n    console.log('req.body', req.body);\n});\n"})}),"\n",(0,a.jsx)(n.p,{children:"改下前端代码，这次设置 aaa、bbb、ccc、ddd 4 个 file 字段："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"async function formData4() {\n    const data = new FormData();\n    data.set('name','光');\n    data.set('age', 20);\n    data.set('aaa', fileInput.files[0]);\n    data.set('bbb', fileInput.files[1]);\n    data.set('ccc', fileInput.files[2]);\n    data.set('ddd', fileInput.files[3]);\n\n    const res = await axios.post('http://localhost:3333/ddd', data);\n    console.log(res);\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"再次上传 4 个文件，可以看到服务端接收到了："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:d,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"只不过这时候不是 key、value 的形式了，需要自己遍历数组来查找。"}),"\n",(0,a.jsx)(n.p,{children:"还有一个问题，如何修改保存的文件名呢？"}),"\n",(0,a.jsx)(n.p,{children:"之前是通过 dest 指定了保存的目录："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,a.jsx)(n.p,{children:"现在这样写："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const fs = require('fs');\nconst path = require('path');\n\nconst storage = multer.diskStorage({\n    destination: function (req, file, cb) {\n        try {\n            fs.mkdirSync(path.join(process.cwd(), 'my-uploads'));\n        }catch(e) {}\n        cb(null, path.join(process.cwd(), 'my-uploads'))\n    },\n    filename: function (req, file, cb) {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9) + '-' + file.originalname\n        cb(null, file.fieldname + '-' + uniqueSuffix)\n    }\n});\n"})}),"\n",(0,a.jsx)(n.p,{children:"自己指定怎么存储，multer.distkStorage 是磁盘存储，通过 destination、filename 的参数分别指定保存的目录和文件名。"}),"\n",(0,a.jsx)(n.p,{children:"这里要先创建下用到的目录，然后再返回它的路径。"}),"\n",(0,a.jsx)(n.p,{children:"file 对象就是之前打印的那种："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:r,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"我们用时间戳 Date.now() 加上Math.random() 乘以 10 的 9 次方，然后取整，之后加上原来的文件名。"}),"\n",(0,a.jsx)(n.p,{children:"测试下："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(n.p,{children:"然后浏览器再次上传："}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsxs)(n.p,{children:["就可以看到目录和文件名都修改了：\n",(0,a.jsx)("img",{src:i,alt:""})]}),"\n",(0,a.jsxs)(n.p,{children:["案例代码在",(0,a.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/multer-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,a.jsxs)(n.h2,{id:"总结",children:["总结",(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,a.jsx)(n.p,{children:"express 的 multer 包是用来处理 multipart/form-data 格式的文件上传请求的。"}),"\n",(0,a.jsx)(n.p,{children:"通过 single 方法处理单个字段的单个文件，array 方法处理单个字段的多个文件，fields 方法处理多个字段的文件，any 处理任意数量字段的文件，分别用 req.file 和 req.files 来取解析出的文件。"}),"\n",(0,a.jsx)(n.p,{children:"其余非文件字段不会处理，还是通过 req.body 来取。"}),"\n",(0,a.jsx)(n.p,{children:"类似文件数量过多等错误，会抛出对应的 error 对象，在错误处理中间件里处理并返回对应的响应就好了。"}),"\n",(0,a.jsx)(n.p,{children:"Nest 的文件上传就是通过 multer 包实现的，下节我们来学下 Nest 里怎么使用 multer。"})]})}function B(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,t.ah)(),e.components);return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(N,{...e})}):N(e)}let T=B;B.__RSPRESS_PAGE_META={},B.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F25.%20Express%20%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20multer%20%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"25. Express 如何使用 multer 实现文件上传",headingTitle:"25. Express 如何使用 multer 实现文件上传",frontmatter:{}}}}]);