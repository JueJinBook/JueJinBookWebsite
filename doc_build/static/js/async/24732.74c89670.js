"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["24732"],{228656:function(e,n,a){a.r(n),a.d(n,{default:()=>X});var s=a(552676),r=a(740453);let i=a.p+"static/image/4f1a7c16ae939c6c1832755e1a8ef029.bd61b1ec.webp",c=a.p+"static/image/e92017bb0f450aa2a15269ecb2fdc45a.77ad2610.webp",t=a.p+"static/image/38bbc127e9f8e63409bd1ad22361e119.ef2da194.webp",d=a.p+"static/image/72b3eb20ff32675aa0ce6e9d8710d6ef.a05504be.webp",l=a.p+"static/image/d64cff166a65255148d9039d312f68d1.4f12686a.webp",p=a.p+"static/image/344da9fb3b6392cd6cf852b5235aa00b.eb484af3.webp",h=a.p+"static/image/09154fa7401978d2822dab7ddedb195a.7ab0d2b2.webp",m=a.p+"static/image/d8f99a1b4d91201d6a1af258a7cbadfd.839b9c58.webp",o=a.p+"static/image/fbffb4108f679c7674e6252f1b436613.d7c5323f.webp",x=a.p+"static/image/263dc77765ff365935fdb59b3aa0de75.fb84dd50.webp",f=a.p+"static/image/256c1ffe963de595c7d99ed6cf91a7a9.9da4cf45.webp",j=a.p+"static/image/978225e8a39d63df13b080e726fdd2e7.16e1b49d.webp",b=a.p+"static/image/cef447c9376169e758d9c02b86217207.067dd410.webp",g=a.p+"static/image/e4c155b5edfd760285dcc8c39b3234d3.c29580f7.webp",u=a.p+"static/image/e53b17202acb51b292108be48fcd42e0.2fdef8af.webp",w=a.p+"static/image/f95206c3e3d4aceee9bc60d95a02d23f.55ab49a2.webp",q=a.p+"static/image/6a4f9dcc0e9d419adeaa948359e472b8.bd7591cf.webp",v=a.p+"static/image/8f6db6b58f2746747bc91bf2dd06878c.9bb84968.webp",A=a.p+"static/image/a59e403f9384ccef9123ad7771077f86.706f8275.webp",V=a.p+"static/image/2efcf32af7902a2a469f0095fa528bc6.c645669b.webp",N=a.p+"static/image/6d0cf2c3b4cdb781afaadd8b77991b46.e2721703.webp",P=a.p+"static/image/a557954f80db4c9f5aadb20308b29507.1625052c.webp",F=a.p+"static/image/1902410b98caea2f44404f46ba272fbf.65c21b0b.webp",S=a.p+"static/image/855407f3500dc310eebcdf41d26a59ab.7588e11d.webp",k=a.p+"static/image/74a500cfba8763d0b7c7f0f0836d149b.dbafd6f8.webp",C=a.p+"static/image/f9fb9c33d7998e1647f802738dc25952.ac6baaec.webp";function E(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",strong:"strong",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"89-node-如何发邮件",children:["89. Node 如何发邮件？",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#89-node-如何发邮件",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"除了微信外，邮件也是我们常用的通讯方式。"}),"\n",(0,s.jsx)(n.p,{children:"那你平时都是怎么收发邮件的呢？"}),"\n",(0,s.jsx)(n.p,{children:"大多数人会回答，就用邮箱客户端啊，比如 qq 邮箱的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:C,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"但是这样体验并不好，比如写邮件的时候："}),"\n",(0,s.jsx)(n.p,{children:"我有个漂亮的 html 页面，想直接把它作为邮件内容。"}),"\n",(0,s.jsx)(n.p,{children:"或者我想用 markdown 来写邮件。"}),"\n",(0,s.jsx)(n.p,{children:"但是它只支持富文本编辑器："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再比如收邮件的时候，我想把一些重要邮件的内容保存下来，附件啥的都下载到本地。"}),"\n",(0,s.jsx)(n.p,{children:"但是邮件多了的话，一个个手动搞太麻烦了。"}),"\n",(0,s.jsx)(n.p,{children:"有没有什么更好的方式呢？"}),"\n",(0,s.jsx)(n.p,{children:"当然是有的，作为一个专业的 Node 程序员，自然要用代码的方式来收发邮件了！"}),"\n",(0,s.jsx)(n.p,{children:"邮件有专门的协议："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"发邮件用 SMTP 协议。"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"收邮件用 POP3 协议、或者 IMAP 协议。"})}),"\n",(0,s.jsx)(n.p,{children:"并且在 node 里也有对应的包，发邮件用 nodemailer 包，收邮件用 imap 包。"}),"\n",(0,s.jsx)(n.p,{children:"我们来试试："}),"\n",(0,s.jsx)(n.p,{children:"首先，要开启 smtp、imap 等服务，这里以 qq 邮箱举例（其他邮箱也类似）："}),"\n",(0,s.jsxs)(n.p,{children:["在邮箱帮助中心 ",(0,s.jsx)(n.a,{href:"https://service.mail.qq.com/",target:"_blank",rel:"noopener noreferrer",children:"https://service.mail.qq.com/"})," 可以搜到如何开启 smtp、imap 等服务："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:F,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"开启后可以在设置里看到："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后在帮助中心页面搜索授权码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"按照指引生成一个授权码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:V,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这个是 qq 邮箱特有的一个第三方登录密码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后就可以开始写代码了："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'const nodemailer = require("nodemailer");\n\nconst transporter = nodemailer.createTransport({\n    host: "smtp.qq.com",\n    port: 587,\n    secure: false,\n    auth: {\n        user: \'xxxxx@qq.com\',\n        pass: \'你的授权码\'\n    },\n});\n\nasync function main() {\n  const info = await transporter.sendMail({\n    from: \'"guang" <xxxx@qq.com>\',\n    to: "xxxx@xx.com",\n    subject: "Hello 111", \n    text: "xxxxx"\n  });\n\n  console.log("邮件发送成功：", info.messageId);\n}\n\nmain().catch(console.error);\n'})}),"\n",(0,s.jsx)(n.p,{children:"安装 nodemailer 包，然后执行上面的代码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到邮件发送成功了。"}),"\n",(0,s.jsx)(n.p,{children:"我们在邮箱里看看："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"确实收到了这个邮件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:q,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样我们就用 node 发送了第一个邮件！"}),"\n",(0,s.jsxs)(n.p,{children:["而且邮件是支持 html + css 的，比如把我之前写的一个 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7167355169934409758",target:"_blank",rel:"noopener noreferrer",children:"3 只小鸟的 button 的 html"})," 拿过来："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"放到一个文件里，然后发邮件的时候读取这个文件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后再跑下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"收到的邮件也渲染出了这个 html，并且 css 动画也是正常的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"那是不是可以加一些 js 呢？"}),"\n",(0,s.jsx)(n.p,{children:"想多了，邮件里可以包含任何 html+ css，但是不支持 js。"}),"\n",(0,s.jsx)(n.p,{children:"不过基于 html + css，我们就已经可以实现各种炫酷的邮件了。"}),"\n",(0,s.jsx)(n.p,{children:"就像前面说的 markdown 格式来写邮件，这个加一个 markdown 转 html 的包，然后作为邮件的 html 内容发送就好了。"}),"\n",(0,s.jsx)(n.p,{children:"也就是说，通过代码的方式，我们可以做出更炫酷的邮件来。"}),"\n",(0,s.jsx)(n.p,{children:"发邮件我们会了，那如何通过 node 来收邮件呢？"}),"\n",(0,s.jsx)(n.p,{children:"收邮件是用 pop3 或者 imap 协议，需要换一个包。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const Imap = require('imap');\n\nconst imap = new Imap({\n    user: 'xxx@qq.com',\n    password: '你的授权码',\n    host: 'imap.qq.com',\n    port: 993,\n    tls: true\n});\n\nimap.once('ready', () => {\n    imap.openBox('INBOX', true, (err) => {\n        imap.search([['SEEN'], ['SINCE', new Date('2023-07-10 19:00:00').toLocaleString()]], (err, results) => {\n            if (!err) {\n                console.log(results);\n            } else {\n                throw err;\n            }\n        });\n    });\n});\n\nimap.connect();\n"})}),"\n",(0,s.jsx)(n.p,{children:"安装 imap 的包，然后填入 qq 邮箱的 imap 服务器的域名、端口，填入用户名和授权码，就可以连接了。"}),"\n",(0,s.jsx)(n.p,{children:"这里的 imap 服务器的信息也是在帮助中心里搜索："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"search 的参数我们写了两个："}),"\n",(0,s.jsx)(n.p,{children:"['SEEN'] 是查询已读的邮件。"}),"\n",(0,s.jsx)(n.p,{children:"['SINCE', '某个日期'] 是查询从这个日期以来的邮件。"}),"\n",(0,s.jsxs)(n.p,{children:["当然，还有更多的搜索条件，可以看 ",(0,s.jsx)(n.a,{href:"https://www.npmjs.com/package/imap",target:"_blank",rel:"noopener noreferrer",children:"imap 包的文档"}),"。"]}),"\n",(0,s.jsx)(n.p,{children:"我们跑下试试："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到打印了搜索出的符合条件的邮件的 id，然后我们来处理下这些 id："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { MailParser } =require('mailparser');\nconst fs = require('fs');\nconst path = require('path');\n\nfunction handleResults(results) {\n    imap.fetch(results, { \n        bodies: '',\n    }).on('message', (msg) => {\n        const mailparser = new MailParser();\n\n        msg.on('body', (stream) => {\n\n            \n\n        });\n    });\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"这里用 imap.fetch 来请求这些 id 的内容，bodies 为 '' 是查询 header + body 的意思："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后处理下 body 的内容，把结果保存到 info 对象里。"}),"\n",(0,s.jsx)(n.p,{children:"这里解析邮件内容要使用 mailparser 这个包："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { MailParser } =require('mailparser');\nconst fs = require('fs');\nconst path = require('path');\nconst Imap = require('imap');\n\n\nfunction handleResults(results) {\n    imap.fetch(results, { \n        bodies: '',\n    }).on('message', (msg) => {\n        const mailparser = new MailParser();\n\n        msg.on('body', (stream) => {\n\n            const info = {};\n            stream.pipe(mailparser);\n\n            mailparser.on(\"headers\", (headers) => {\n                info.theme = headers.get('subject');\n                info.form = headers.get('from').value[0].address;\n                info.mailName = headers.get('from').value[0].name;\n                info.to = headers.get('to').value[0].address;\n                info.datatime = headers.get('date').toLocaleString();\n            });\n\n            mailparser.on(\"data\", (data) => {\n                if (data.type === 'text') {\n                    info.html = data.html;\n                    info.text = data.text;\n                    console.log(info);\n                }\n                if (data.type === 'attachment') {\n                    const filePath = path.join(__dirname, 'files', data.filename);\n                    const ws = fs.createWriteStream(filePath);\n                    data.content.pipe(ws);\n                }\n            });\n        });\n    });\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"这部分还是容易看懂的，就是把 headers 的信息提取出来，把邮件 body 的信息提取出来，放到 info\n对象里，打印。"}),"\n",(0,s.jsx)(n.p,{children:"如果有附件，就写到 files 目录下。"}),"\n",(0,s.jsx)(n.p,{children:"我们在本地创建个 files 目录，然后跑一下。"}),"\n",(0,s.jsx)(n.p,{children:"可以看到，我们前面发的那两个邮件都取到了。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"日期也确实都是 7 月 10 日的。"}),"\n",(0,s.jsx)(n.p,{children:"我邮箱里有这样一个邮件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到，附件也下载到了 files 目录下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们把 html 的内容保存到本地文件里："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const filePath = path.join(__dirname, 'mails', info.theme + '.html');\nfs.writeFileSync(filePath, info.html || info.text)\n"})}),"\n",(0,s.jsx)(n.p,{children:"以邮件主题为文件名。"}),"\n",(0,s.jsx)(n.p,{children:"当然，要现在本地创建 mails 这个目录，然后跑一下："}),"\n",(0,s.jsx)(n.p,{children:"邮件内容和附件内容都保存了下来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在邮箱里可以看到也是这些邮件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们打开这些 html 看看，起一个 http-server："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npx http-server .\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:c,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"和在邮箱里看一模一样。"}),"\n",(0,s.jsx)(n.p,{children:"这样，我们就把邮件内容和附件都保存了下来。"}),"\n",(0,s.jsx)(n.p,{children:"你想保存一些重要邮件的时候，还需要手动一个个复制和下载附件么？"}),"\n",(0,s.jsx)(n.p,{children:"不需要，用 node 写代码保存不更方便么？"}),"\n",(0,s.jsx)(n.p,{children:"收邮件部分的代码如下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { MailParser } =require('mailparser');\nconst fs = require('fs');\nconst path = require('path');\nconst Imap = require('imap');\n\nconst imap = new Imap({\n    user: 'xx@qq.com',\n    password: '你的授权码',\n    host: 'imap.qq.com',\n    port: 993,\n    tls: true\n});\n\nimap.once('ready', () => {\n    imap.openBox('INBOX', true, (err) => {\n        imap.search([['SEEN'], ['SINCE', new Date('2023-07-10 19:00:00').toLocaleString()]], (err, results) => {\n            if (!err) {\n                handleResults(results);\n            } else {\n                throw err;\n            }\n        });\n    });\n});\n\n\nfunction handleResults(results) {\n    imap.fetch(results, { \n        bodies: '',\n    }).on('message', (msg) => {\n        const mailparser = new MailParser();\n\n        msg.on('body', (stream) => {\n\n            const info = {};\n            stream.pipe(mailparser);\n            mailparser.on(\"headers\", (headers) => {\n                info.theme = headers.get('subject');\n                info.form = headers.get('from').value[0].address;\n                info.mailName = headers.get('from').value[0].name;\n                info.to = headers.get('to').value[0].address;\n                info.datatime = headers.get('date').toLocaleString();\n            });\n\n            mailparser.on(\"data\", (data) => {\n                if (data.type === 'text') {\n                    info.html = data.html;\n                    info.text = data.text;\n\n                    const filePath = path.join(__dirname, 'mails', info.theme + '.html');\n                    fs.writeFileSync(filePath, info.html || info.text)\n\n                    console.log(info);\n                }\n                if (data.type === 'attachment') {\n                    const filePath = path.join(__dirname, 'files', data.filename);\n                    const ws = fs.createWriteStream(filePath);\n                    data.content.pipe(ws);\n                }\n            });\n        });\n    });\n}\n\nimap.connect();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["案例代码上传了",(0,s.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/mail-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"邮件是常用的通讯方式，我们一般是通过邮箱客户端来收发邮件。"}),"\n",(0,s.jsx)(n.p,{children:"但是这样不够方便："}),"\n",(0,s.jsx)(n.p,{children:"比如写邮件不能直接贴 html + css，不能写 markdown，收邮件不能按照规则自动下载附件、自动保存邮件内容。"}),"\n",(0,s.jsx)(n.p,{children:"这些需求我们都能通过代码来自己实现。"}),"\n",(0,s.jsx)(n.p,{children:"发邮件是基于 SMTP 协议，收邮件是基于 POP3 或 IMAP 协议。"}),"\n",(0,s.jsx)(n.p,{children:"node 分别有 nodemailer 包和 imap 包用来支持收发邮件的协议。"}),"\n",(0,s.jsx)(n.p,{children:"我们通过 nodemailer 发送了 html 的邮件，可以发送任何 html+css 的内容。"}),"\n",(0,s.jsx)(n.p,{children:"通过 imap 实现了邮件的搜索，然后用 mailparser来做了内容解析，然后把邮件内容和附件做了下载。"}),"\n",(0,s.jsx)(n.p,{children:"能够写代码来收发邮件之后，就可以做很多自动化的事情了："}),"\n",(0,s.jsx)(n.p,{children:"比如定时自动发一些邮件，内容是从数据库查出来的，比如自动拉取邮件，根据一定的规则来保存邮件和附件内容等。"}),"\n",(0,s.jsx)(n.p,{children:"这就是 Node 里收发邮件的方式。"})]})}function B(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(E,{...e})}):E(e)}let X=B;B.__RSPRESS_PAGE_META={},B.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F89.%20Node%20%E5%A6%82%E4%BD%95%E5%8F%91%E9%82%AE%E4%BB%B6%EF%BC%9F.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"89. Node 如何发邮件？",headingTitle:"89. Node 如何发邮件？",frontmatter:{}}}}]);