"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["94105"],{697606:function(e,n,i){i.r(n),i.d(n,{default:()=>B});var c=i(552676),s=i(740453);let a=i.p+"static/image/1b22458ff1ca01089af976924eef4374.592740f3.webp",r=i.p+"static/image/38904c57b4593316f3100780a379f3bc.3f50c71d.webp",t=i.p+"static/image/0003bbce2aace549740ad85420d364ef.a875f72f.webp",d=i.p+"static/image/1d1cecab384830d201129b7678c4a7d1.c5689767.webp",p=i.p+"static/image/7ed2acb157d27e33a291654dff249180.219a494a.webp",l=i.p+"static/image/bf9fe890e9d8051b07d3b4fdf614b5bd.20bcb266.webp",h=i.p+"static/image/77a1866e6587d17272a41a98c31698c5.6f50247d.webp",j=i.p+"static/image/f7d0c3c7cd65af93a2cc9e30b3c234be.e9f14d91.webp",x=i.p+"static/image/06abad084634432d6ea389ef41c21c9d.58352b0d.webp",o=i.p+"static/image/752f8bab99f325a28a78f18cca7a7da0.b03d9c02.webp",b=i.p+"static/image/4df2cafc19d4c7a2f062fccd040c42c2.114a9da8.webp",f=i.p+"static/image/19a328d2e539db466628520d416cc731.268b3df4.webp",m=i.p+"static/image/5ea7a163ec7fb2ab60c8f2ee9186d317.159053ff.webp",g=i.p+"static/image/1c7f1385c3793be4c0dd5c2892bf2ffe.d20830e2.webp",y=i.p+"static/image/d238b3ab90c0bebf855edae32dd1b0a1.db5b8048.webp",w=i.p+"static/image/9bb3de6c3e2fc9e2737c05e4f5b94072.b33e49bf.webp",u=i.p+"static/image/a11b110be3e1feadc7968d9cdf285283.8e97e896.webp",E=i.p+"static/image/32b19d91da6be4e0cf63e7d75c2a639a.fee8142f.webp",v=i.p+"static/image/1feb25cfd56f3db957f353b205635c62.9524fddd.gif",k=i.p+"static/image/b54e436e2c33c70a04b8eee74778cce8.354057b6.webp",A=i.p+"static/image/117a5900b8b178ef0da00814478cedd0.a34edd19.webp",_=i.p+"static/image/64c93e67aa0ef2d4190688b3d5721f3d.54b6034a.webp",S=i.p+"static/image/8b13df4564e836fada66b1c96498c5ea.98403bef.webp";function P(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,s.ah)(),e.components);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.h1,{id:"94-httpmodule--pinyin-实现天气预报查询服务",children:["94. HttpModule + pinyin 实现天气预报查询服务",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#94-httpmodule--pinyin-实现天气预报查询服务",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"今天我们来实现一个查询城市天气预报的服务。"}),"\n",(0,c.jsx)(n.p,{children:"使用的是和风天气的免费 api。"}),"\n",(0,c.jsx)(n.p,{children:"免费的接口一天可以请求 1000 次，自己的项目足够用了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:S,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"最多可以查询未来 7 天的天气预报。"}),"\n",(0,c.jsxs)(n.p,{children:["首先，登录",(0,c.jsx)(n.a,{href:"https://id.qweather.com/#/login",target:"_blank",rel:"noopener noreferrer",children:"和风天气"}),"，"]}),"\n",(0,c.jsx)(n.p,{children:"然后在用户中心绑定邮箱和手机号："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:_,alt:""})}),"\n",(0,c.jsxs)(n.p,{children:["之后进入",(0,c.jsx)(n.a,{href:"https://console.qweather.com/#/console",target:"_blank",rel:"noopener noreferrer",children:"控制台"}),"，点击创建项目："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:A,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这里大家选择免费订阅（我别的项目用了，就没免费名额了），指定 key 的名字："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:k,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后就可以看到你的 key 了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:v,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"如果我们要查询青岛未来 7 天的天气。"}),"\n",(0,c.jsx)(n.p,{children:"需要先查询青岛的 id："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:E,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"location 是城市名字的拼音，然后带上刚刚的 key："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"https://devapi.qweather.com/v7/weather/7d?location=101120606&key=aff40f07926348b9b06f3229d2b52e6a\n"})}),"\n",(0,c.jsx)(n.p,{children:"返回了青岛市和各个区的信息。"}),"\n",(0,c.jsx)(n.p,{children:"有了城市 id 之后就可以查询天气了："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"https://api.qweather.com/v7/weather/7d?location=101120201&key=187d6c3dd15f4d2d99e2a7e0ee08ba04\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:u,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这里返回了从 2024-5-1 到 2024-5-7 的天气。"}),"\n",(0,c.jsxs)(n.p,{children:["具体字段的解释可以看",(0,c.jsx)(n.a,{href:"https://dev.qweather.com/docs/api/weather/weather-daily-forecast/#%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE",target:"_blank",rel:"noopener noreferrer",children:"文档"}),"："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:w,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这样我们就实现了查询某个城市为了 7 天的天气的功能。"}),"\n",(0,c.jsx)(n.p,{children:"还有个问题，现在是先用城市的拼音查的 id，再用 id 查的天气。"}),"\n",(0,c.jsx)(n.p,{children:"那直接让用户输入城市拼音么？"}),"\n",(0,c.jsx)(n.p,{children:"这样也不好，我们可以用 pinyin 这个包："}),"\n",(0,c.jsx)(n.p,{children:"它可以拿到中文的拼音："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:y,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这样，整个流程就串起来了。"}),"\n",(0,c.jsx)(n.p,{children:"当然，如果你想让用户直接选择城市，然后查询城市的天气，这种就要拿到所有城市的信息了。"}),"\n",(0,c.jsxs)(n.p,{children:["网上有挺多这种 ",(0,c.jsx)(n.a,{href:"https://blog.csdn.net/qq_32353771/article/details/82221604",target:"_blank",rel:"noopener noreferrer",children:"JSON 数据"}),"的："]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:g,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"有所有城市名和它的 id。"}),"\n",(0,c.jsx)(n.p,{children:"思路理清了，我们来写下代码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install -g @nestjs/cli\n\nnest new city-weather\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:m,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"安装 pinyin 包和它的类型："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install --save pinyin@alpha\nnpm install --save-dev @types/pinyin\n"})}),"\n",(0,c.jsx)(n.p,{children:"然后我们加个接口测试下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:f,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Get('pinyin')\npinyin(@Query('text') text: string) {\n    return pinyin(text).join('')\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:b,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"访问下试试："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:o,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"可以看到，确实返回了拼音。"}),"\n",(0,c.jsx)(n.p,{children:"但是我们不需要知道是几声。"}),"\n",(0,c.jsx)(n.p,{children:"改下参数："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:x,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这样就好了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:j,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后 nest 服务里怎么访问三方接口呢？"}),"\n",(0,c.jsx)(n.p,{children:"直接用 axios 么？"}),"\n",(0,c.jsx)(n.p,{children:"可以，但是我们希望统一配置 axios，然后各个模块都用同一个 axios 实例。"}),"\n",(0,c.jsx)(n.p,{children:"所以用 @nestjs/axios 这个包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install --save @nestjs/axios axios\n"})}),"\n",(0,c.jsx)(n.p,{children:"在 AppModule 引入下 HttpModule："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:h,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这里可以填入各种请求配置，比如 baseURL 等，其实就是 new 了一个 Axios 实例："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:l,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后在用到的地方注入 httpService："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:p,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Inject(HttpService)\nprivate httpService: HttpService;\n\n@Get('weather/:city')\nasync weather(@Param('city') city: string) {\n  const cityPinyin = pinyin(city, { style: 'normal'}).join('');\n\n  const { data } = await firstValueFrom(\n    this.httpService.get(`https://geoapi.qweather.com/v2/city/lookup?location=${cityPinyin}&key=187d6c3dd15f4d2d99e2a7e0ee08ba04`)\n  )\n\n  return data;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"用 @Param 取路径中的参数。"}),"\n",(0,c.jsx)(n.p,{children:"然后用 pinyin 拿到 city 的拼音，然后调用和风天气的接口。"}),"\n",(0,c.jsx)(n.p,{children:"这里为啥用 firstValueFrom 的 rxjs 操作符呢？"}),"\n",(0,c.jsx)(n.p,{children:"因为 HttpModule 把 axios 的方法返回值封装成了 rxjs 的 Observerable。"}),"\n",(0,c.jsx)(n.p,{children:"好处是你可以用 rxjs 的操作符了。"}),"\n",(0,c.jsx)(n.p,{children:"坏处是转成 promise 还得加一层 firstValueFrom。"}),"\n",(0,c.jsx)(n.p,{children:"它就是用来把 rxjs Observable 转成 promise 的："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:d,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"测试下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:t,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,c.jsx)(n.p,{children:"然后继续调用天气预报接口："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Get('weather/:city')\nasync weather(@Param('city') city: string) {\n    const cityPinyin = pinyin(city, { style: 'normal'}).join('');\n\n    const { data } = await firstValueFrom(\n      this.httpService.get(`https://geoapi.qweather.com/v2/city/lookup?location=${cityPinyin}&key=187d6c3dd15f4d2d99e2a7e0ee08ba04`)\n    )\n\n    const location = data?.['location']?.[0];\n\n    if(!location) {\n      throw new BadRequestException('没有对应的城市信息');\n    }\n\n    const { data: weatherData } = await firstValueFrom(\n      this.httpService.get(`https://api.qweather.com/v7/weather/7d?location=${location.id}&key=187d6c3dd15f4d2d99e2a7e0ee08ba04`)\n    )\n\n    return weatherData;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"如果没查到 location，返回 400 错误。"}),"\n",(0,c.jsx)(n.p,{children:"否则用 location.id 查询该城市天气预报。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:r,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:a,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这样，我们的城市天气预报服务就完成了。"}),"\n",(0,c.jsx)(n.p,{children:"当然，这里最好用 redis 做一层缓存，同一个城市的一天内只查一次，避免接口反复调用。这个大家可以自己去优化。"}),"\n",(0,c.jsxs)(n.p,{children:["案例代码上传了",(0,c.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/city-weather",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,c.jsxs)(n.h2,{id:"总结",children:["总结",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"我们基于和风天气的 api 实现了天气预报查询服务。"}),"\n",(0,c.jsx)(n.p,{children:"主要用到了 pinyin 这个包来完成中文转拼音，然后用 pinyin 去请求和风天气的 api 查询城市 id。"}),"\n",(0,c.jsx)(n.p,{children:"接下来用城市 id 请求天气数据。"}),"\n",(0,c.jsx)(n.p,{children:"和风天气的 api 免费版一天可以调用 1000 次，足够用了。"}),"\n",(0,c.jsx)(n.p,{children:"Nest 里发送 http 请求，我们用的是 @nestjs/axios 包的 HttpModule 来做的。"}),"\n",(0,c.jsx)(n.p,{children:"它可以统一配置，然后注入 HttpService 到用到的地方，并且 httpService 方法的返回值封装成了 rxjs 的 Observerable，可以直接用 rxjs 的操作符。"}),"\n",(0,c.jsx)(n.p,{children:"比如用 fistValueFrom 来把 rxjs 的 Observable 转为 Promise。"}),"\n",(0,c.jsx)(n.p,{children:"这样，你就可以在你的应用中集成天气预报功能了。"})]})}function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(P,{...e})}):P(e)}let B=q;q.__RSPRESS_PAGE_META={},q.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F94.%20HttpModule%20%2B%20pinyin%20%E5%AE%9E%E7%8E%B0%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"94. HttpModule + pinyin 实现天气预报查询服务",headingTitle:"94. HttpModule + pinyin 实现天气预报查询服务",frontmatter:{}}}}]);