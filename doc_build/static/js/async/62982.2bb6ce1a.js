"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["62982"],{856599:function(e,r,n){n.r(r),n.d(r,{default:()=>t});var s=n(552676),i=n(740453);function d(e){let r=Object.assign({h1:"h1",a:"a",h2:"h2",ul:"ul",li:"li",blockquote:"blockquote",p:"p",code:"code",pre:"pre",ol:"ol",strong:"strong"},(0,i.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.h1,{id:"17进阶-4给-api-增加启动脚本",children:["17进阶 4：给 API 增加启动脚本",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#17进阶-4给-api-增加启动脚本",children:"#"})]}),"\n",(0,s.jsxs)(r.h2,{id:"本节核心内容",children:["本节核心内容",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#本节核心内容",children:"#"})]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"如何管理 apiserver 启动命令，包括启动、重启、停止和查看运行状态"}),"\n"]}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsxs)(r.p,{children:["本小节源码下载路径：",(0,s.jsx)(r.a,{href:"https://github.com/lexkong/apiserver_demos/tree/master/demo13",target:"_blank",rel:"noopener noreferrer",children:"demo13"})]}),"\n",(0,s.jsx)(r.p,{children:"可先下载源码到本地，结合源码理解后续内容，边学边练。"}),"\n",(0,s.jsxs)(r.p,{children:["本小节的代码是基于 ",(0,s.jsx)(r.a,{href:"https://github.com/lexkong/apiserver_demos/tree/master/demo12",target:"_blank",rel:"noopener noreferrer",children:"demo12"})," 来开发的。"]}),"\n"]}),"\n",(0,s.jsxs)(r.h2,{id:"为什么要添加启动脚本",children:["为什么要添加启动脚本",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#为什么要添加启动脚本",children:"#"})]}),"\n",(0,s.jsx)(r.p,{children:"通过添加服务器启动脚本可以很方便地启动、重启、停止和查看服务的状态。一些监控系统、发布系统需要有方法告诉它怎么启停和查看服务状态，这时候如果有个服务控制脚本就可以很方便地添加，要不然输入一堆启动参数不仅烦琐还容易出错。"}),"\n",(0,s.jsxs)(r.h2,{id:"添加启动脚本",children:["添加启动脚本",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#添加启动脚本",children:"#"})]}),"\n",(0,s.jsxs)(r.p,{children:["apiserver 是通过 ",(0,s.jsx)(r.code,{children:"admin.sh"})," 脚本来实现服务启动、重启、停止和查看服务状态操作的（详见 ",(0,s.jsx)(r.a,{href:"https://github.com/lexkong/apiserver_demos/blob/master/demo13/admin.sh",target:"_blank",rel:"noopener noreferrer",children:"demo13/admin.sh"}),"），源码为："]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:'#!/bin/bash\r\n\r\nSERVER="apiserver"\r\nBASE_DIR=$PWD\r\nINTERVAL=2\r\n\r\n# 命令行参数，需要手动指定\r\nARGS=""\r\n\r\nfunction start()\r\n{\r\n	if [ "`pgrep $SERVER -u $UID`" != "" ];then\r\n		echo "$SERVER already running"\r\n		exit 1\r\n	fi\r\n\r\n	nohup $BASE_DIR/$SERVER $ARGS  server &>/dev/null &\r\n\r\n	echo "sleeping..." &&  sleep $INTERVAL\r\n\r\n	# check status\r\n	if [ "`pgrep $SERVER -u $UID`" == "" ];then\r\n		echo "$SERVER start failed"\r\n		exit 1\r\n	fi\r\n}\r\n\r\nfunction status() \r\n{\r\n	if [ "`pgrep $SERVER -u $UID`" != "" ];then\r\n		echo $SERVER is running\r\n	else\r\n		echo $SERVER is not running\r\n	fi\r\n}\r\n\r\nfunction stop() \r\n{\r\n	if [ "`pgrep $SERVER -u $UID`" != "" ];then\r\n		kill -9 `pgrep $SERVER -u $UID`\r\n	fi\r\n\r\n	echo "sleeping..." &&  sleep $INTERVAL\r\n\r\n	if [ "`pgrep $SERVER -u $UID`" != "" ];then\r\n		echo "$SERVER stop failed"\r\n		exit 1\r\n	fi\r\n}\r\n\r\ncase "$1" in\r\n	\'start\')\r\n	start\r\n	;;  \r\n	\'stop\')\r\n	stop\r\n	;;  \r\n	\'status\')\r\n	status\r\n	;;  \r\n	\'restart\')\r\n	stop && start\r\n	;;  \r\n	*)  \r\n	echo "usage: $0 {start|stop|restart|status}"\r\n	exit 1\r\n	;;  \r\nesac\r\n\n'})}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"看 shell 源码发现在 start 和 stop 时会 sleep 几秒，这是因为 API 服务器的启动需要时间去做准备工作，停止也需要时间去做清理工作。"}),"\n"]}),"\n",(0,s.jsxs)(r.h2,{id:"编译并测试",children:["编译并测试",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#编译并测试",children:"#"})]}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsx)(r.li,{children:"下载 apiserver_demos 源码包（如前面已经下载过，请忽略此步骤）"}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ git clone https://github.com/lexkong/apiserver_demos\n"})}),"\n",(0,s.jsxs)(r.ol,{start:"2",children:["\n",(0,s.jsxs)(r.li,{children:["将 ",(0,s.jsx)(r.code,{children:"apiserver_demos/demo13"})," 复制为 ",(0,s.jsx)(r.code,{children:"$GOPATH/src/apiserver"})]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ cp -a apiserver_demos/demo13/ $GOPATH/src/apiserver\n"})}),"\n",(0,s.jsxs)(r.ol,{start:"3",children:["\n",(0,s.jsx)(r.li,{children:"在 apiserver 目录下编译源码"}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ cd $GOPATH/src/apiserver\r\n$ make\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["查看 ",(0,s.jsx)(r.code,{children:"admin.sh"})," 用法"]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh -h\r\nusage: ./admin.sh {start|stop|restart|status}\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["查看 ",(0,s.jsx)(r.code,{children:"apiserver"})," 运行状态"]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh status\r\napiserver is not running\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["启动 ",(0,s.jsx)(r.code,{children:"apiserver"})]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh start\r\nsleeping...\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["查看 ",(0,s.jsx)(r.code,{children:"apiserver"})," 状态"]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh status\r\napiserver is running\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["重启 ",(0,s.jsx)(r.code,{children:"apiserver"})]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh restart\r\nsleeping...\r\nsleeping...\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["停止 ",(0,s.jsx)(r.code,{children:"apiserver"})]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$ ./admin.sh stop\r\nsleeping...\n"})}),"\n",(0,s.jsxs)(r.h2,{id:"小结",children:["小结",(0,s.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#小结",children:"#"})]}),"\n",(0,s.jsxs)(r.p,{children:["本小结展示了如何用 ",(0,s.jsx)(r.code,{children:"admin.sh"})," 去管理 API 服务器：启动、重启、停止和查看状态。该 ",(0,s.jsx)(r.code,{children:"admin.sh"})," 命令在进行 start、stop、restart 和 status 操作时做了很多检查工作，以确保运行结果是正确的。"]})]})}function h(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,i.ah)(),e.components);return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}let t=h;h.__RSPRESS_PAGE_META={},h.__RSPRESS_PAGE_META["%E5%9F%BA%E4%BA%8E%20Go%20%E8%AF%AD%E8%A8%80%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9A%84%20RESTful%20API%20%E6%9C%8D%E5%8A%A1%2F17%E8%BF%9B%E9%98%B6%204%EF%BC%9A%E7%BB%99%20API%20%E5%A2%9E%E5%8A%A0%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC.md"]={toc:[{text:"本节核心内容",id:"本节核心内容",depth:2},{text:"为什么要添加启动脚本",id:"为什么要添加启动脚本",depth:2},{text:"添加启动脚本",id:"添加启动脚本",depth:2},{text:"编译并测试",id:"编译并测试",depth:2},{text:"小结",id:"小结",depth:2}],title:"17进阶 4：给 API 增加启动脚本",headingTitle:"17进阶 4：给 API 增加启动脚本",frontmatter:{}}}}]);