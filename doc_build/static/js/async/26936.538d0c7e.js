"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["26936"],{86132:function(e,n,c){e.exports=c.p+"static/image/27cb39b89b01cdbd1184062d08e404cb.0b8691f6.webp"},347381:function(e,n,c){e.exports=c.p+"static/image/371b09ce855ba04b14a16033d40dfa94.bc3f0e6f.webp"},811837:function(e,n,c){e.exports=c.p+"static/image/ce54ef4f30a04c74437866b7237eb5ad.66402c29.webp"},686898:function(e,n,c){c.r(n),c.d(n,{default:()=>ec});var s=c(552676),a=c(740453);let i=c.p+"static/image/dec1b95754313cc173ec2b2ea5697df8.e94fdcbb.webp",d=c.p+"static/image/fbf4591a6a0bcb362ed87d206fa327a1.d7962983.gif",l=c.p+"static/image/15105835f5690d794dfa67c5872ff34b.15591fe3.webp",r=c.p+"static/image/1819cbf5c1b57c974858c6176c23ec26.c45d130a.webp",p=c.p+"static/image/3dc05125a8122e5136a6c429042da5f4.c4f1faac.webp",t=c.p+"static/image/dd81b8ef3a1f94ce11c06d900a3f5845.ecb37a75.webp",x=c.p+"static/image/8227ef0fbd301b941206248428f728de.1289e6cf.webp",j=c.p+"static/image/eb9840eb6943b7ebf04751d87aea91b6.555a4718.webp";var h=c(347381),m=c(811837);let f=c.p+"static/image/6a9dc1adfa1bb2c5aac460cdcbbe1a00.feb30c7c.webp";var b=c(86132);let A=c.p+"static/image/e1f21812a57ef8731a4d25d39d586988.69968b7b.webp",o=c.p+"static/image/e193b1b5e6cee3aaa926a4ce4cdf616e.a6c75e9a.webp",g=c.p+"static/image/f84744c0bef62504304f2b77d7dcd95a.377204ee.webp",S=c.p+"static/image/f655175fe8d4d677a2cfe009558f8d08.d6146256.webp",u=c.p+"static/image/ca7a61dee34fd09ea3e080b1ac74461c.ca391e21.webp",w=c.p+"static/image/9e93a5ca92a3350c16d036ee4bdf2b1d.15c97dc7.webp",q=c.p+"static/image/a76e4f9e7bf48048ac6a2934c8bbd030.8e264f23.webp",E=c.p+"static/image/260e2a70cb47acd4d13e3e8f2b32e351.a75157a6.webp",O=c.p+"static/image/6ff4b795acad3cb28ce1da4d26125a49.837c4151.webp",K=c.p+"static/image/6c2132ebb305d03c34b4db5fbabdf46b.fd7d5443.webp",T=c.p+"static/image/eee99e4148a857afb74b495704a143f5.b85822bd.webp",Q=c.p+"static/image/be106fedd04ed41eb04c608c4f3ad96c.dc6df29b.webp",D=c.p+"static/image/edea4d9392b947b0ce99af2c382b2922.fd5c01fb.webp",y=c.p+"static/image/4f022159b1fed4005af8d8a9fb6a036c.35a053d7.webp",C=c.p+"static/image/dfe8e4beb2ddf307a6eac2b7c5d63398.dae6d85e.webp",X=c.p+"static/image/06c66550456b150ca88b3fe50cdc3790.21dc111f.webp",B=c.p+"static/image/a47d63cc1668ff86b9aa0043a77cee1c.bfd7aa2f.webp",I=c.p+"static/image/ad9cd3815b8f16a65277ad5a440010a2.f30f9998.webp",P=c.p+"static/image/79f7befb7cbc33c9992015c502b246f8.b7e82662.webp",v=c.p+"static/image/aa79253ae7a22c5f4ce4d2f877d658e1.add9e83c.webp",H=c.p+"static/image/c4df63c58b3f01a5383f6583617967be.b270200c.webp",V=c.p+"static/image/ce02ba369fc2a4481f7aaeccb7548fd1.aa0e7aed.webp",L=c.p+"static/image/b218c4185ca674d3fed1d93cb5d6f66e.05dac34e.webp",R=c.p+"static/image/efb7e9e5e979408d920a54b6fede7f84.534d1405.webp",U=c.p+"static/image/42d5a06a5ed7717d90d2fb8fc73e9290.daa8d514.webp",N=c.p+"static/image/66c38c6cb305d753fb62ce088c339394.34f937fd.gif",G=c.p+"static/image/47b2947eab89bb54eb5ddbc2b19e42e7.0e69ce7f.webp",Z=c.p+"static/image/70800c3aa00653bcac1bdc50cebe498d.1e63a968.webp",M=c.p+"static/image/4a6d51a9869e9049927d89b07056ac93.90ba8b30.webp",k=c.p+"static/image/f4cfc806c354ee257035bd6ba090b2f2.dc62d309.webp",Y=c.p+"static/image/2ced5c03788ade365596e545eee9d45e.c4d5f37a.webp",z=c.p+"static/image/83dee0914263fd9053a4d0a591ea8745.bdf45434.webp",W=c.p+"static/image/7699f5c2dcc19e7829c6d61b2d93d5ef.d83cf744.webp",F=c.p+"static/image/3754aa68a75e597e4112d1d3cf75a878.f10b0e39.webp",J=c.p+"static/image/097fa65c9c76734506db68bd5641b4bc.bd206d8a.webp",_=c.p+"static/image/8d083b2c58376237ba07063e0e86384e.40d87a82.webp",$=c.p+"static/image/c528490063eaa2e0186db97cd07ee0f7.35aa41ed.webp";function ee(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,a.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"35-最完美的-oss-上传方案",children:["35. 最完美的 OSS 上传方案",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#35-最完美的-oss-上传方案",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"文件上传是常见需求，一般我们不会把文件直接上传到应用服务器，因为单台服务器存储空间是有限的，不好扩展。"}),"\n",(0,s.jsx)(n.p,{children:"我们会用单独的 OSS （Object Storage Service）对象存储服务来上传下载文件。"}),"\n",(0,s.jsx)(n.p,{children:"比如一般会买阿里云的 OSS 服务。"}),"\n",(0,s.jsx)(n.p,{children:"我们本地文件存储是目录-文件的组织方式："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:$,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"而 OSS 服务的存储结构是这样的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:_,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"一个桶里放一些文件。"}),"\n",(0,s.jsx)(n.p,{children:"阿里云 OSS 的控制台也提到了对象存储没有目录层级结构："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:J,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"但下面明明是支持目录的呀："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:F,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这其实只是模拟实现的。"}),"\n",(0,s.jsx)(n.p,{children:"Object 会存储 id、文件内容、元数据三部分信息："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"阿里云 OSS 只是用元信息部分模拟实现了目录。"}),"\n",(0,s.jsx)(n.p,{children:"就像打了个 tag 一样，并不是说文件存储在这个 tag 下，只是你可以用这个 tag 来检索文件。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:W,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"除了对象存储 OSS，阿里云也提供了文件存储和块存储的方式："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:z,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"块存储就是把整块磁盘给你用，你需要自己格式化，存储容量有限。"}),"\n",(0,s.jsx)(n.p,{children:"文件存储就是有目录层次结构，你可以上传下载文件，存储容量有限。"}),"\n",(0,s.jsx)(n.p,{children:"对象存储就是 key-value 存储，分布式的方式实现的，存储容量无限。"}),"\n",(0,s.jsx)(n.p,{children:"这些简单了解就行，绝大多数情况下，我们都是用 OSS 对象存储。"}),"\n",(0,s.jsxs)(n.p,{children:["我们买个",(0,s.jsx)(n.a,{href:"https://www.aliyun.com/product/oss",target:"_blank",rel:"noopener noreferrer",children:"阿里云的 OSS 服务"}),"来试试看："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我买了 40G 的 OSS 国内通用资源包，花了 5 块钱。"}),"\n",(0,s.jsx)(n.p,{children:"然后我们创建个 Bucket（桶）："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在北京创建了一个 Bucket，文件就会存储在那里的服务器上。"}),"\n",(0,s.jsx)(n.p,{children:"设置公共读，也就是这些文件大家都可以直接访问。"}),"\n",(0,s.jsx)(n.p,{children:"不然私有的方式，你访问每个文件都要带上一些身份信息："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:M,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"有的同学说，不是静态文件要在全国各地都能访问到么？存在北京的服务器会不会访问速度慢？"}),"\n",(0,s.jsx)(n.p,{children:"这是 CDN 的活："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Z,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"接入 CDN 后，访问该域名会走到云服务的 DNS，然后返回一台最近的缓存服务器的地址，这台服务器会从源站拿文件来缓存，之后就不再访问源站。"}),"\n",(0,s.jsx)(n.p,{children:"这里的源站就可以是 OSS 服务。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:G,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"创建 Bucket 之后，我们上传个文件试试："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"上传完之后在文件列表就可以看到这个文件了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:U,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"点开可以看到文件详情，用这个 URL 就可以访问："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"当然，生产环境下我们不会直接用 OSS 的 URL 访问，而是会开启 CDN，用网站域名访问，最终回源到 OSS 服务："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:L,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:V,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在控制台里上传很简单，那如果想在代码里上传呢？"}),"\n",(0,s.jsx)(n.p,{children:"官方文档里有示例代码，我们试试看："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:H,alt:""})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"mkdir oss-test\ncd oss-test\nnpm init -y\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm install ali-oss\n"})}),"\n",(0,s.jsx)(n.p,{children:"写下代码："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const OSS = require('ali-oss')\n\nconst client = new OSS({\n    region: 'oss-cn-beijing',\n    bucket: 'guang-333',\n    accessKeyId: '',\n    accessKeySecret: '',\n});\n\nasync function put () {\n  try {\n    const result = await client.put('cat.png', './mao.png');\n    console.log(result);\n  } catch (e) {\n    console.log(e);\n  }\n}\n\nput();\n"})}),"\n",(0,s.jsx)(n.p,{children:"region 在概览里可以看到："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这里的 accessKeyId 和 acessKeySecret 是什么呢？"}),"\n",(0,s.jsx)(n.p,{children:"本来我们身份认证都是通过用户名密码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"但这样不够安全，所以我们创建了 accessKey 用来代表身份，用它来做身份认证，就算泄漏了，也不影响别的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:I,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们创建个 accesKey："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:X,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"创建完成后，拿到 accesKeyId 和 accessKeySecret 后运行代码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:C,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这里的 mao.png 是这样的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在控制台可以看到上传成功了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这就是 OSS 用 api 上传文件的用法。"}),"\n",(0,s.jsx)(n.p,{children:"只是我们刚刚用的 accessKey 不够安全。"}),"\n",(0,s.jsx)(n.p,{children:"打开 accessKey 管理页面的时候就提示了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:Q,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"让我们不要直接用 accessKey，而是创建一个子用户再创建 accessKey。"}),"\n",(0,s.jsx)(n.p,{children:"那我们就创建个子用户："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:T,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:K,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后用这个 accessKey 的 id 和 secret 就好了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:O,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"但你直接换上它还不行："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"会提示你 403，没有权限。"}),"\n",(0,s.jsx)(n.p,{children:"需要你授权下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:q,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"新增一个授权："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"把 OSS 的管理和读取权限给这个子用户："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后再试下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这时候就上传成功了。"}),"\n",(0,s.jsx)(n.p,{children:"回过头来看下，不得不说阿里云在安全这一块设计的就很巧妙。"}),"\n",(0,s.jsx)(n.p,{children:"如果我们直接用用户名密码验证呢："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"那万一泄漏了不就完蛋了么？"}),"\n",(0,s.jsx)(n.p,{children:"但是如果创建个 accessKey 用它来做身份认证："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"就算泄漏了我也可以禁用啊："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再进一步，直接用这个 accessKey 它是有所有权限的。"}),"\n",(0,s.jsx)(n.p,{children:"我们先创建个 RAM 子用户，再分配给他某些权限，这样就算泄漏了，是不是能做的事情就更少了？"}),"\n",(0,s.jsx)(n.p,{children:"当然就更安全。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"所以说，阿里云这套 accessKey 和 RAM 子用户的身份认证方式，还是很不错的。"}),"\n",(0,s.jsx)(n.p,{children:"再说回 OSS，一般的文件直接上传就行，涉及到大文件就要分片上传了。"}),"\n",(0,s.jsx)(n.p,{children:"分片上传实现原理是前端常见面试题了，大家都能答上来，上节我们刚实现过。"}),"\n",(0,s.jsx)(n.p,{children:"就是把文件用 slice 方法分成一个个小的片，然后全部上传完之后请求一个接口合并分片。"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://help.aliyun.com/zh/oss/user-guide/multipart-upload",target:"_blank",rel:"noopener noreferrer",children:"阿里云的大文件分片上传"}),"也是这样实现的："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"具体怎么用直接看文档就好了，这里我们就不试了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"有了 OSS 服务之后，我们上传文件还需要经过应用服务器么？"}),"\n",(0,s.jsx)(n.p,{children:"可以经过也可以不经过。"}),"\n",(0,s.jsx)(n.p,{children:"如果经过应用服务器，那就要客户端上传文件之后，我们在服务里接受文件，上传 OSS："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样当然是可以的，还能保护 accessKey 不被人窃取。"}),"\n",(0,s.jsx)(n.p,{children:"只是会浪费应用服务器的流量。"}),"\n",(0,s.jsx)(n.p,{children:"那如果不经过呢？"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"在客户端用 accessKey 把文件传到 OSS，之后把 URL 传给应用服务器就好了。"}),"\n",(0,s.jsx)(n.p,{children:"这样减少了应用服务器的流量消耗，但是增加了 accessKey 暴露的风险。"}),"\n",(0,s.jsx)(n.p,{children:"各有各的坏处。"}),"\n",(0,s.jsx)(n.p,{children:"那有没有啥两全其美的办法呢？"}),"\n",(0,s.jsx)(n.p,{children:"有。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:j,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://help.aliyun.com/zh/oss/user-guide/authorized-third-party-upload",target:"_blank",rel:"noopener noreferrer",children:"阿里云的文档"}),"里也提到了这个问题。"]}),"\n",(0,s.jsx)(n.p,{children:"它给出的解决方案就是生成一个临时的签名来用。"}),"\n",(0,s.jsx)(n.p,{children:"代码是这样的："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const OSS = require('ali-oss')\n\nasync function main() {\n\n    const config = {\n        region: 'oss-cn-beijing',\n        bucket: 'guang-333',\n        accessKeyId: 'LTAI5tDemEBPwQkTx65jZCdy',\n        accessKeySecret: 'I0vHYOoqIC78lH7A5c5XB1H7Pev7bp',\n    }\n\n    const client = new OSS(config);\n    \n    const date = new Date();\n    \n    date.setDate(date.getDate() + 1);\n    \n    const res = client.calculatePostSignature({\n        expiration: date.toISOString(),\n        conditions: [\n            [\"content-length-range\", 0, 1048576000], //设置上传文件的大小限制。      \n        ]\n    });\n    \n    console.log(res);\n    \n    const location = await client.getBucketLocation();\n    \n    const host = `http://${config.bucket}.${location.location}.aliyuncs.com`;\n\n    console.log(host);\n}\n\nmain();\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"上传 OSS 的地址，用的临时 signature 和 policy 都有了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这些代码不用记，文档里都有："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样就能在网页里用这些来上传文件到 OSS 了："}),"\n",(0,s.jsx)(n.p,{children:"创建个 index.html"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Document</title>\n    <script src=\"https://unpkg.com/axios@1.6.5/dist/axios.min.js\"><\/script>\n</head>\n<body>\n    <input id=\"fileInput\" type=\"file\"/>\n    \n    <script>\n        const fileInput = document.getElementById('fileInput');\n\n        async function getOSSInfo() {\n            await '请求应用服务器拿到临时凭证';\n            return {\n                OSSAccessKeyId: 'LTAI5tDemEBPwQkTx65jZCdy',\n                Signature: 'NfXgq/qLIR2/v87j/XC9sjrASOA=',\n                policy: 'eyJleHBpcmF0aW9uIjoiMjAyNC0wMS0yMFQwMzoyNjowOC4xMDZaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjAwMF1dfQ==',\n                host: 'http://guang-333.oss-cn-beijing.aliyuncs.com'\n            }\n        }\n\n        fileInput.onchange = async () => {\n            const file = fileInput.files[0];\n\n            const ossInfo = await getOSSInfo();\n\n\n            const formdata = new FormData()\n \n            formdata.append('key', file.name);\n            formdata.append('OSSAccessKeyId', ossInfo.OSSAccessKeyId)\n            formdata.append('policy', ossInfo.policy)\n            formdata.append('signature', ossInfo.Signature)\n            formdata.append('success_action_status', '200')\n            formdata.append('file', file)\n\n            const res = await axios.post(ossInfo.host, formdata);\n            if(res.status === 200) {\n                \n                const img = document.createElement('img');\n                img.src = ossInfo.host + '/' + file.name\n                document.body.append(img);\n\n                alert('上传成功');\n            }\n        }\n    <\/script>\n</body>\n</html>\n"})}),"\n",(0,s.jsx)(n.p,{children:"这里 getOSSInfo 应该是请求服务端的接口，拿到刚才我们控制台输出的那些东西。"}),"\n",(0,s.jsx)(n.p,{children:"这里就简化下，直接写死在代码里了。"}),"\n",(0,s.jsx)(n.p,{children:"引入 axios，用这些信息来上传文件。"}),"\n",(0,s.jsx)(n.p,{children:"跑个静态服务器："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npx http-server .\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这时候你上传文件的时候会提示跨域错误："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们在控制台开启下跨域："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后再试下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"上传成功了！"}),"\n",(0,s.jsx)(n.p,{children:"控制台文件列表也可以看到这个文件："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这就是完美的 OSS 上传方案。"}),"\n",(0,s.jsx)(n.p,{children:"服务端用 RAM 子用户的 accessKey 来生成临时签名，然后返回给客户端，客户端用这个来直传文件到 OSS。"}),"\n",(0,s.jsx)(n.p,{children:"因为临时的签名过期时间很短，我们设置的是一天，所以暴露的风险也不大。"}),"\n",(0,s.jsx)(n.p,{children:"这样服务端就根本没有接受文件的压力，只要等客户端上传完之后，带上 URL 就好了。"}),"\n",(0,s.jsxs)(n.p,{children:["案例代码上传了",(0,s.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/oss-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"上传文件一般不会直接存在服务器目录下，这样不好扩展，一般我们会用阿里云的 OSS，它会自己做弹性扩展，所以存储空间是无限的。"}),"\n",(0,s.jsx)(n.p,{children:"OSS 对象存储是在一个 bucket 桶下，存放多个文件。"}),"\n",(0,s.jsx)(n.p,{children:"它是用 key-value 存储的，没有目录的概念，阿里云 OSS 的目录只是用元信息来模拟实现的。"}),"\n",(0,s.jsx)(n.p,{children:"我们在测试了在控制台的文件上传，也测试过了 node 里用 ali-oss 包来上传、在网页里直传 OSS 这三种上传方式。"}),"\n",(0,s.jsx)(n.p,{children:"不管在哪里上传，都需要 acessKeyId 和 acessKeySecret。"}),"\n",(0,s.jsx)(n.p,{children:"这个是阿里云的安全策略，因为直接用用户名密码，一旦泄漏就很麻烦，而 acessKey 泄漏了也可以禁用。而且建议用 RAM 子用户的方式生成 accessKey，这样可以最小化权限，进一步减少泄漏的风险。"}),"\n",(0,s.jsx)(n.p,{children:"客户端直传 OSS 的方式不需要消耗服务器的资源，但是会有泄漏 acessKey 的风险，所以一般都是用服务端生成临时的签名等信息，然后用这些信息来上传。"}),"\n",(0,s.jsx)(n.p,{children:"这种方案就是最完美的 OSS 上传方案了。"}),"\n",(0,s.jsx)(n.p,{children:"掌握了这些，就完全足够应对工作中的 OSS 使用了。"})]})}function en(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(ee,{...e})}):ee(e)}let ec=en;en.__RSPRESS_PAGE_META={},en.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F35.%20%E6%9C%80%E5%AE%8C%E7%BE%8E%E7%9A%84%20OSS%20%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"35. 最完美的 OSS 上传方案",headingTitle:"35. 最完美的 OSS 上传方案",frontmatter:{}}}}]);