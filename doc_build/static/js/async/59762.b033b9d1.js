"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["59762"],{173564:function(e,n,r){e.exports=r.p+"static/image/1b88313da42af68b4e801026e69da8ba.271b54d3.webp"},56048:function(e,n,r){e.exports=r.p+"static/image/4958ece2e6bc530aa2704e42fb88e7a9.cba871e4.webp"},630193:function(e){e.exports="data:image/webp;base64,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"},718933:function(e,n,r){e.exports=r.p+"static/image/57ce4b7f13efbd0b8cc5d327904b8cce.00a5def0.webp"},203467:function(e,n,r){e.exports=r.p+"static/image/5b6a57681ee9afd16635938dd4e319a2.82328c9a.webp"},251310:function(e,n,r){e.exports=r.p+"static/image/6bdaae3d4b4b6b41fd91efaecb5a80bb.17725e55.webp"},552013:function(e){e.exports="data:image/webp;base64,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"},244786:function(e,n,r){e.exports=r.p+"static/image/9677b87e2c211441d6898214d21dbb28.4c5b9ae5.webp"},278304:function(e,n,r){e.exports=r.p+"static/image/98a28acb87033db90649b8417ad6cf4d.a46ac950.webp"},974693:function(e,n,r){e.exports=r.p+"static/image/b5f8de994372595b9b90fff8d7f41015.6ab2cfed.webp"},271451:function(e,n,r){e.exports=r.p+"static/image/b9257a88e040516d132ea7363f236ca2.28952446.webp"},470559:function(e,n,r){e.exports=r.p+"static/image/bbdc0025c9dcf42b053cdc87708a7dc5.fe69d78c.webp"},453607:function(e){e.exports="data:image/webp;base64,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"},816418:function(e,n,r){e.exports=r.p+"static/image/e3091817945c80839e583fbff66b39a4.e70a890e.webp"},999680:function(e,n,r){r.r(n),r.d(n,{default:()=>B});var t=r(552676),s=r(740453);let a=r.p+"static/image/8624bef1ca0e9b82c1a469d3171c386f.30537175.webp";var i=r(251310),c=r(718933);let o=r.p+"static/image/40c9999f862209b2a758d3157eb7a323.354defd4.webp";var l=r(173564);let d=r.p+"static/image/17f370f2550f9e5fbf64bb0db78d6e66.15de101a.webp";var p=r(453607),u=r(470559),h=r(552013),x=r(630193);let m=r.p+"static/image/39fbe1d641faf74d071e3c9e4c78e12e.0fa21cb7.webp";var j=r(56048);let g=r.p+"static/image/89eae3936962ea0be24ce122a79953bb.5c815fd1.webp",A=r.p+"static/image/44a4bff30d3eab072601fe18ceca0b32.1c0e29c3.webp",b=r.p+"static/image/66c3496a67bfa0e2bdcb22b14741e518.775c1e9f.webp";var f=r(974693),w=r(816418),v=r(278304),q=r(271451),k=r(244786),U=r(203467);function D(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,s.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.h1,{id:"178-聊天室用户登录",children:["178. 聊天室：用户登录",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#178-聊天室用户登录",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"这节我们实现下登录。"}),"\n",(0,t.jsx)(n.p,{children:"在 UserController 添加一个 login 的路由："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    console.log(loginUser);\n    return 'success';\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"创建 src/user/dto/login-user.dto.ts："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { IsNotEmpty } from "class-validator";\n\nexport class LoginUserDto {\n\n    @IsNotEmpty({\n        message: "用户名不能为空"\n    })\n    username: string;\n    \n    @IsNotEmpty({\n        message: \'密码不能为空\'\n    })\n    password: string;    \n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"测试下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:U,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:k,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"服务端打印了接收的参数。"}),"\n",(0,t.jsx)(n.p,{children:"ValidationPipe 开启 transform: true"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:q,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"再次访问："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:v,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这样会把参数转为 dto 的实例。"}),"\n",(0,t.jsx)(n.p,{children:"然后在 UserService 实现 login 方法："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"async login(loginUserDto: LoginUserDto) {\n  const foundUser = await this.prismaService.user.findUnique({\n    where: {\n      username: loginUserDto.username\n    }\n  });\n\n  if(!foundUser) {\n      throw new HttpException('用户不存在', HttpStatus.BAD_REQUEST);\n  }\n\n  if(foundUser.password !== loginUserDto.password) {\n      throw new HttpException('密码错误', HttpStatus.BAD_REQUEST);\n  }\n\n  delete foundUser.password;\n  return foundUser;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"为了开发方便，我们注册的时候没有对密码做加密，登录的时候也就不用加密了。"}),"\n",(0,t.jsx)(n.p,{children:"在 UserController 里调用下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    const user = await this.userService.login(loginUser);\n\n    return user;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"测试下："}),"\n",(0,t.jsx)(n.p,{children:"当用户名不存在时："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:w,alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["当密码错误时：\n",(0,t.jsx)("img",{src:f,alt:""})]}),"\n",(0,t.jsx)(n.p,{children:"登录成功："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:b,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"登录成功之后我们要返回 jwt。"}),"\n",(0,t.jsx)(n.p,{children:"引入下 jwt 的包："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"npm install --save @nestjs/jwt\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 AppModule 里引入："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:A,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"JwtModule.registerAsync({\n  global: true,\n  useFactory() {\n    return {\n      secret: 'guang',\n      signOptions: {\n        expiresIn: '30m' // 默认 30 分钟\n      }\n    }\n  }\n}),\n"})}),"\n",(0,t.jsx)(n.p,{children:"然后登录成功之后返回 token："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Inject(JwtService)\nprivate jwtService: JwtService;\n\n@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    const user = await this.userService.login(loginUser);\n\n    return {\n      user,\n      token: this.jwtService.sign({\n        userId: user.id,\n        username: user.username\n      }, {\n        expiresIn: '7d'\n      })\n    };\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"token 过期时间是 7 天。"}),"\n",(0,t.jsx)(n.p,{children:"测试下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:g,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们这里就不用双 token 的方式来刷新了，而是用单 token 无限续期来做。"}),"\n",(0,t.jsx)(n.p,{children:"也就是当访问接口的时候，就返回一个新的 token。"}),"\n",(0,t.jsx)(n.p,{children:"这样只要它在 token 过期之前，也就是 7 天内访问了一次系统，那就会刷新换成新 token。"}),"\n",(0,t.jsx)(n.p,{children:"超过 7 天没访问，那就需要重新登录了。"}),"\n",(0,t.jsx)(n.p,{children:"然后我们加上 AuthGuard 来做登录鉴权："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"nest g guard auth --flat --no-spec\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:j,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"AuthGuard 的实现代码如下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { JwtService } from '@nestjs/jwt';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\n\ninterface JwtUserData {\n  userId: number;\n  username: string;\n}\n\ndeclare module 'express' {\n  interface Request {\n    user: JwtUserData\n  }\n}\n\n@Injectable()\nexport class AuthGuard implements CanActivate {\n  \n  @Inject()\n  private reflector: Reflector;\n\n  @Inject(JwtService)\n  private jwtService: JwtService;\n  \n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n    \n    const requireLogin = this.reflector.getAllAndOverride('require-login', [\n      context.getClass(),\n      context.getHandler()\n    ]);\n\n    if(!requireLogin) {\n      return true;\n    }\n\n    const authorization = request.headers.authorization;\n\n    if(!authorization) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    try{\n      const token = authorization.split(' ')[1];\n      const data = this.jwtService.verify<JwtUserData>(token);\n\n      request.user = {\n        userId: data.userId,\n        username: data.username,\n      }\n      return true;\n    } catch(e) {\n      throw new UnauthorizedException('token 失效，请重新登录');\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"用 reflector 从目标 controller 和 handler 上拿到 require-login 的 metadata。"}),"\n",(0,t.jsx)(n.p,{children:"如果没有 metadata，就是不需要登录，返回 true 放行。"}),"\n",(0,t.jsx)(n.p,{children:"否则从 authorization 的 header 取出 jwt 来，把用户信息设置到 request，然后放行。"}),"\n",(0,t.jsx)(n.p,{children:"如果 jwt 无效，返回 401 响应，提示 token 失效，请重新登录。"}),"\n",(0,t.jsx)(n.p,{children:"然后全局启用这个 Guard，在 AppModule 里添加这个 provider："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:m,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_GUARD,\n  useClass: AuthGuard\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 AppController 添加 aaa、bbb 两个接口："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\naaa() {\n    return 'aaa';\n}\n\n@Get('bbb')\nbbb() {\n    return 'bbb';\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"访问下："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:x,alt:""})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:h,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"然后在 aaa 加上 require-login 的 matadata"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\n@SetMetadata('require-login', true)\naaa() {\n    return 'aaa';\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"会提示用户未登录："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:u,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"而 bbb 还是可以直接访问的："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:p,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"登录下，拿到 token："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:d,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"添加到 authorization 的 header 里，就可以访问了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:l,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"我们把这个 @SetMetadata 封装成自定义装饰器"}),"\n",(0,t.jsx)(n.p,{children:"新建 src/custom.decorator.ts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { SetMetadata } from \"@nestjs/common\";\n\nexport const  RequireLogin = () => SetMetadata('require-login', true);\n"})}),"\n",(0,t.jsx)(n.p,{children:"然后就可以通过在 controller 或者 handler 上的 @RequiredLogin 来声明接口需要登录了："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:o,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"再实现个自定义参数装饰器来取 request.user"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { SetMetadata } from \"@nestjs/common\";\nimport { createParamDecorator, ExecutionContext } from '@nestjs/common';\nimport { Request } from \"express\";\n\nexport const  RequireLogin = () => SetMetadata('require-login', true);\n\nexport const UserInfo = createParamDecorator(\n  (data: string, ctx: ExecutionContext) => {\n    const request = ctx.switchToHttp().getRequest<Request>();\n\n    if(!request.user) {\n        return null;\n    }\n    return data ? request.user[data] : request.user;\n  },\n)\n"})}),"\n",(0,t.jsx)(n.p,{children:"在 aaa 方法里测试下："}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\n@RequireLogin()\n// @SetMetadata('require-login', true)\naaa(@UserInfo() userInfo, @UserInfo('username') username) {\n    console.log(userInfo, username);\n    return 'aaa';\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:c,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"这样，就完成了登录和鉴权。"}),"\n",(0,t.jsx)(n.p,{children:"还有 token 自动续期没有做，这个就是访问接口之后，在 header 或者 body 里额外返回新 token。"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:i,alt:""})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { JwtService } from '@nestjs/jwt';\nimport { Request, Response } from 'express';\nimport { Observable } from 'rxjs';\n\ninterface JwtUserData {\n  userId: number;\n  username: string;\n}\n\ndeclare module 'express' {\n  interface Request {\n    user: JwtUserData\n  }\n}\n\n@Injectable()\nexport class AuthGuard implements CanActivate {\n  \n  @Inject()\n  private reflector: Reflector;\n\n  @Inject(JwtService)\n  private jwtService: JwtService;\n  \n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n    const response: Response = context.switchToHttp().getResponse();\n\n    const requireLogin = this.reflector.getAllAndOverride('require-login', [\n      context.getClass(),\n      context.getHandler()\n    ]);\n\n    if(!requireLogin) {\n      return true;\n    }\n\n    const authorization = request.headers.authorization;\n\n    if(!authorization) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    try{\n      const token = authorization.split(' ')[1];\n      const data = this.jwtService.verify<JwtUserData>(token);\n\n      request.user = {\n        userId: data.userId,\n        username: data.username,\n      }\n\n      response.header('token', this.jwtService.sign({\n        userId: data.userId,\n        username: data.username\n      }, {\n        expiresIn: '7d'\n      }))\n\n      return true;\n    } catch(e) {\n      console.log(e);\n      throw new UnauthorizedException('token 失效，请重新登录');\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"再访问下 aaa 接口："}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)("img",{src:a,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"可以看到返回了新 token。"}),"\n",(0,t.jsx)(n.p,{children:"这样只要访问需要登录的接口，就会刷新 token。"}),"\n",(0,t.jsx)(n.p,{children:"比双token 的方案简单多了，很多公司就是这样做的。"}),"\n",(0,t.jsxs)(n.p,{children:["代码在",(0,t.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/chat-room-backend",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,t.jsxs)(n.h2,{id:"总结",children:["总结",(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,t.jsx)(n.p,{children:"这节我们实现了登录、鉴权。"}),"\n",(0,t.jsx)(n.p,{children:"添加了 /user/login 接口来实现登录，登录后返回 jwt token。"}),"\n",(0,t.jsx)(n.p,{children:"访问的时候在 Authorization 的 header 带上 jwt 的 token 就能通过 AuthGuard 的鉴权。"}),"\n",(0,t.jsx)(n.p,{children:"我们做了 token 的自动续期，也就是访问接口后在 header 返回新 token，这样比双 token 的方案简单。"}),"\n",(0,t.jsx)(n.p,{children:"然后封装了 @RequireLogin 和 @UserInfo 两个自定义装饰器。"}),"\n",(0,t.jsx)(n.p,{children:"登录之后，就可以访问一些需要 user 信息的接口了。"})]})}function Z(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(D,{...e})}):D(e)}let B=Z;Z.__RSPRESS_PAGE_META={},Z.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F178.%20%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"178. 聊天室：用户登录",headingTitle:"178. 聊天室：用户登录",frontmatter:{}}}}]);