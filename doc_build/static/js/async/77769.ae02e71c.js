"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["77769"],{785965:function(e,n,s){e.exports=s.p+"static/image/525136bc8fb00f0d2e634b1d349094c8.eec423f7.webp"},928889:function(e,n,s){e.exports=s.p+"static/image/83e1341810c7235012cc2063f95da9d9.c61e9b78.webp"},345396:function(e,n,s){e.exports=s.p+"static/image/9281a95f17590da8f9f7711677bdb12c.47a83ba0.webp"},284954:function(e,n,s){e.exports=s.p+"static/image/a084ce06fd2a02cd1913a06e56069c3c.a6e71abb.webp"},979509:function(e,n,s){e.exports=s.p+"static/image/b9d1cc0a9a1f796bc584276e01e8d63e.b46ee461.webp"},166075:function(e,n,s){s.r(n),s.d(n,{default:()=>ee});var c=s(552676),r=s(740453);let i=s.p+"static/image/0394a0cdc6c3ed15314ba0a51cc322ab.86d888fb.webp",a=s.p+"static/image/774d338417fd7c9049c338366f84dcea.f33af078.webp",t=s.p+"static/image/0b7233e0b539a25e571e79e56d4d6cd4.225643da.gif",d=s.p+"static/image/b8ec528147e294b9dd86378b9e16c1f6.5c6f84f1.webp",l=s.p+"static/image/b387ff185524fd3934580c0a19984be3.0c2ee16f.webp",p=s.p+"static/image/0727d128ac332c3195f86cdef35a5c2d.c561e3a3.webp",h=s.p+"static/image/828aaf8d111063c7e782953ef2e0f093.3a7bd694.webp",o=s.p+"static/image/7fea819d2d99daf21029fd71738f944d.3882a60f.webp",j=s.p+"static/image/a9490031c9788be546856fcab23d7bb5.610a71ae.webp",x=s.p+"static/image/16a6bd65a33917172ae77266abff5e57.6875f9c0.webp",m=s.p+"static/image/6fe7fc24299b81f74a5a79b11c4eb7f3.c3e0e71b.webp",g=s.p+"static/image/1f1e4b46c776aee3917a5cfcf3869205.6cfee8a7.webp",b=s.p+"static/image/06e38b5f40d56409c6e2c01817e08191.b0cc1d3d.webp",f=s.p+"static/image/930295a7850a96a1b07c318e71e21fce.c20e83b5.webp",u=s.p+"static/image/c23b53f2a390de73198885ab911cfd24.2f4b5a59.webp",w=s.p+"static/image/471b82be6396f3b61c261982423e8764.54b8623b.webp",A=s.p+"static/image/9b98a62a6bbae96e7cde7852fa5b3358.40b88052.webp",C=s.p+"static/image/0301fc85e6c17fbc19b8e94c568d9530.0d841046.webp",y=s.p+"static/image/6decf1eea0698f92e06181a100b73d0c.59fc1434.webp",v=s.p+"static/image/f492c29191b6cedb498daeb26fd07ebb.bb10e99b.webp",q=s.p+"static/image/92d6f58eb431ad3a552c14207ccb7c3c.34c2741e.webp",P=s.p+"static/image/8056bb5a7f29cd76b652b6ad0aea6a13.93ac7729.webp",S=s.p+"static/image/8471d61b8459ee03fdd9ba49799bef9f.07356a59.webp",O=s.p+"static/image/d51b30a27e0f8d539efea30b47ef11f0.1c63a035.webp",N=s.p+"static/image/2420fa6cadc58997caec9773f7905277.25593411.webp",U=s.p+"static/image/750ff5ee63595ef5c8aa7faafcbeca80.126ac9de.webp",E=s.p+"static/image/926d62ab0291bf74b31a364a9f3eab9f.9e715c2f.webp",M=s.p+"static/image/b82879ccde4fc223b4a6c13c09fd82d1.fc016436.webp";var X=s(284954),R=s(928889),H=s(345396),I=s(979509),Q=s(785965);let B=s.p+"static/image/04d2fb95a434cad8d20b997fa2fcfee0.7bfc3ec4.webp",k=s.p+"static/image/58080ff102b4d93ec0f1795e567f224d.32abb9d4.webp",T=s.p+"static/image/e6ff102fcb8e10e8774dbf94ff0ed3c6.721f50de.webp",D=s.p+"static/image/7f11773984f590b2af26bf0b601b8348.6ae495de.webp",G=s.p+"static/image/0d5a3b4e36edb569d19a8daee03a3483.070fa710.webp",K=s.p+"static/image/48b3bdef10c5d4ed00f1a5ffd85706a1.0374bdd0.webp",L=s.p+"static/image/efcdb0e5a7fda3faebfec842fc7b3d36.9f52ba3e.webp",J=s.p+"static/image/103e17d84759f1d4fa125d86870fde45.5318d5d3.webp",z=s.p+"static/image/d28f9cba6f798310bdb791814e3922c0.49e233f7.webp",Z=s.p+"static/image/e25b92d82957d425a464ab194f58a725.9e309ad8.webp",Y=s.p+"static/image/45b84474741ca29b4922b1d8760d634d.c6e4e694.webp",W=s.p+"static/image/7b717f3cd21c58769be4220686d89e3c.af55891b.gif",V=s.p+"static/image/c16fba00b57eb78fe6fab9626f216a98.dfcd5720.webp",F=s.p+"static/image/25c90949bc300c378d7031bf6a8871a7.372c2135.webp";function _(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",strong:"strong",h2:"h2"},(0,r.ah)(),e.components);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.h1,{id:"96-短链服务自己写一个",children:["96. 短链服务？自己写一个",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#96-短链服务自己写一个",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"生活中我们经常遇到需要短链的场景。"}),"\n",(0,c.jsx)(n.p,{children:"比如一段很长的 url："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:F,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"分享出去很不方便。"}),"\n",(0,c.jsx)(n.p,{children:"这时候就可以通过短链服务把它缩短："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:V,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"点击短链会跳转到原链接："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:W,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这种在短信里很常见："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:Y,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"因为短信是按照字数收费的，太长不但阅读体验不好，费用也高。"}),"\n",(0,c.jsx)(n.p,{children:"所以都会生成短链之后再加到短信里。"}),"\n",(0,c.jsx)(n.p,{children:"那短链是怎么实现的呢？"}),"\n",(0,c.jsx)(n.p,{children:"很容易想到的思路是这样的："}),"\n",(0,c.jsx)(n.p,{children:"用 0、1、2、3、4、5 的递增 id 标识每个 url，把映射关系存到数据库里。"}),"\n",(0,c.jsx)(n.p,{children:"这样访问短链的时候从数据库中查出对应的长链接，返回 302 重定向即可。"}),"\n",(0,c.jsx)(n.p,{children:"比如刚才的短链服务就是通过 302 把短链重定向到长链："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:Z,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这里也可以用 301。"}),"\n",(0,c.jsx)(n.p,{children:"301 是永久重定向，就是重定向一次之后，下次浏览器就不会再访问短链，会直接访问长链接。"}),"\n",(0,c.jsx)(n.p,{children:"302 是临时重定向，下次访问短链依然会先访问短链服务，返回 302 后再重定向到长链。"}),"\n",(0,c.jsx)(n.p,{children:"这两种都可以，301 的话，短链服务压力小，不过 302 每次都会先访问短链服务，这样可以记录链接的访问次数等数据。"}),"\n",(0,c.jsx)(n.p,{children:"比如刚才我们用的短链服务，就会记录这个链接的访问记录："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:z,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"还可以做一些分析："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:J,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"所以访问记录也挺有价值的。"}),"\n",(0,c.jsx)(n.p,{children:"一般短链服务都是用 302 来重定向。"}),"\n",(0,c.jsx)(n.p,{children:"每个 url 的 id 我们会用 Base64 或者 Base62 编码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const data = '123456';\nconst buff = Buffer.from(data);\nconst base64data = buff.toString('base64');\n\nconsole.log(base64data);\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:L,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"base64 就是 26 个大写字母、26 个小写字母、10 个数字、2 个特殊字符，一共 64 个字符。"}),"\n",(0,c.jsx)(n.p,{children:"而 base62 则是去掉了两个特殊字符，一共 62 个字符。"}),"\n",(0,c.jsx)(n.p,{children:"做短链的话，我们用 base62 比较多。"}),"\n",(0,c.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install base62\n"})}),"\n",(0,c.jsx)(n.p,{children:"测试下："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:'const base62 = require("base62/lib/ascii");\n \nconst res = base62.encode(123456);\n\nconsole.log(res);\n'})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:K,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"按照这个思路，我们就能实现一个短链服务。"}),"\n",(0,c.jsx)(n.p,{children:"在 mysql 里创建压缩码和长链接的对应关系的表，用 mysql 的自增 id 然后进行 base62 之后作为压缩码。"}),"\n",(0,c.jsx)(n.p,{children:"访问短链的时候，根据压缩码查询这个表，找到长链接，通过 302 重定向到这个链接，并且记录短链访问记录。"}),"\n",(0,c.jsx)(n.p,{children:"这样是可以的，但有个问题："}),"\n",(0,c.jsx)(n.p,{children:"用自增 id 作为压缩码，那别人很容易拿到上一个、下一个压缩码，从而拿到别的短链，万一这个短链是用来兑奖之类的呢？"}),"\n",(0,c.jsx)(n.p,{children:"这样就会有安全问题。"}),"\n",(0,c.jsx)(n.p,{children:"所以自增 id 的方案不太好。"}),"\n",(0,c.jsx)(n.p,{children:"那如果我们对 url 做 hash 呢？"}),"\n",(0,c.jsx)(n.p,{children:"也就是这样："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const crypto = require('crypto');\n\nfunction md5(str) {\n  const hash = crypto.createHash('md5');\n  hash.update(str);\n  return hash.digest('hex');\n}\n\nconsole.log(md5('111222'))\n"})}),"\n",(0,c.jsx)(n.p,{children:"这样太长了，有 32 位呢："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:G,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"倒是可以每 4 位取一个数字，然后组成一个 8 位的压缩码。"}),"\n",(0,c.jsx)(n.p,{children:"但是，这样是有碰撞的可能的。"}),"\n",(0,c.jsx)(n.p,{children:"也就是两个不同的 url 生成的压缩码一样。"}),"\n",(0,c.jsx)(n.p,{children:"所以，hash 的方案也不行。"}),"\n",(0,c.jsx)(n.p,{children:"还有一种方案，就是通过随机数的方式生成压缩码。"}),"\n",(0,c.jsx)(n.p,{children:"比如这样："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"const base62 = require(\"base62/lib/ascii\");\n\nfunction generateRandomStr(len) {\n    let str = '';\n    for(let i = 0; i < len; i++) {\n        const num = Math.floor(Math.random() * 62);\n        str += base62.encode(num);\n    }\n    return str;\n}\n\nconsole.log(generateRandomStr(6));\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:D,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"随机生成 0-61 的数字，然后转成字符。"}),"\n",(0,c.jsx)(n.p,{children:"62 的 6 次方，范围有 580 亿，足够用了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,c.jsx)(n.p,{children:"当然，随机数也是有碰撞的可能的，这个可以在生成之后查下表，看下是否有重复的，有的话就再重新生成。"}),"\n",(0,c.jsx)(n.p,{children:"不过每次生成都查表的话性能会不好，那有啥优化的方案呢？"}),"\n",(0,c.jsx)(n.p,{children:"我们可以提前生成一批压缩码，用的时候直接取！"}),"\n",(0,c.jsx)(n.p,{children:"可以用个定时任务来跑，每天凌晨 4 点生成一批。"}),"\n",(0,c.jsx)(n.p,{children:"这样，生成压缩码的方案就完美了。"}),"\n",(0,c.jsx)(n.p,{children:"小结下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"用递增 id + base62 作为压缩码，可以保证唯一，但是容易被人拿到其它短码，不安全。"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"用 url 做 hash 之后取一部分然后 base62 做为压缩码，有碰撞的可能，不唯一。"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"随机生成字符串再查表检测是否重复，可以保证唯一且不连续，但是性能不好。用提前批量生成的方式可以解决。"})}),"\n",(0,c.jsx)(n.p,{children:"有的同学可能提到 uuid、雪花 id 之类的，那些都太长了，不适合用来做压缩码："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:T,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"思路理清了，我们来写下代码。"}),"\n",(0,c.jsx)(n.p,{children:"创建个 nest 项目："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install -g @nestjs/cli\n\nnest new short-url\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:k,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"先进入项目，把它跑起来："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:B,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"浏览器看到 hello world，代表 nest 服务跑成功了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:"data:image/webp;base64,UklGRpQNAABXRUJQVlA4IIgNAAAQUwCdASoeAsAAPp1OoU0lpCMiIhKZYLATiWlu4XKRFzOZ8Tf1/to/xniP49/P8nSxR97PzHmZ/u/BP1TeoR+Ofzb/L/bDxA4Av0D+9f677gOc37EewB/Nf69/yPXD/P+DD5r7Av8//zPqzf3P/p8uP1R/7PcP/Xvrr/t57UQpaLydF5Oi1hF1Sv/ic7oTuhO6E7oTuhO4kI1kxqvOdO681kj2MoD+WvpqtAEsnTKMDHPNsFJf5uQkYrnifAapCdDXA8O0PtH31KZThRrQzFZJmBuAtI1IbZcfQpaDv9/jeK/JNNahWjnKoI+mpOBqPOHLSAbt1e4E0WUAAWTTeRpl1YEpNBje0cXFAxMnS7fKPwo9PvXofix3AJWyTfZBLWcAJXhfVusiJZRFpKoR36lbGNjCtYNv04Co2a4SGDFUsa1j5jBuXDj6NHO7BP4BPirGUE61cjlNeDiFl4Xna+xmr3n7lH9iTupW2lKtpjPDn2EJJYPchTnh7WTQmiyJDZiz+NUOCq4CprHASVl0LL1VtCl5UtF5Oi9wuE40zIjbvqgVK/O9JAeHSXLd8HQ0LUJ18XcSVHDfw+g44LotNMrBRdFsxlYKLorpwIV0MqC31sjxCHGwh+uvxCZp877CSxu9Y3esbvU9JtAUwJQ4FDMZwjPPZnMnC7jNdYkC7wZm4JGvQalcdmk6RG1/lvRkDcSqC2grEk4aSSi3xbrV4ejonk6LydF5Oi8nReLDyAs0dV5rbHCS+nsjAIRghPV2XItV/bcRKrLdyDBtn1Bz6g59Qc+oOgSC1LvsnuEljd6xu9Y3esbvWN3rG71jd6xu9Y3esbsQJNcJLG71jd6xu9Y3epxE9u1gKjwKKJK5rnepmWcYRBBAOwuti4fhNKk8wWEAAP7/BBGvTPRHX5oYMTxRrwaCpr4qKNeDQVNfFRRrwaCogKb6Ojgf4TuMoWiJrizb+IJUsFNW2SxIoFrhprp6O59tP/MAYehcYhqW5ILV7VEwmAur4SavgxaN00eVdhgsOoUXadYTy2g0DPnkAGxRj/mngAJyk7xfLkQe3cR3dt11Pf/c6kyPbEwg5Lmoi18hqw/dDUFWo7rWZhsbshBj5ys3NNcyu+pBwKiR7tov4qymDS9do6hmhpr9bM315M4tyb8OqD2gJFB2gzDuyFkFTgr5FC2IE/mlC8B3DEVTVeeay40QBZhLjtxPF01I7RQcgh3sZxmY0p+cYaum+qSF37tMlU1SQcdKNYXq8zXEwXQszggXeC/5rPHWNIW2VtgeceQRzZl0Z3JsXuoHYpBqdiSIQh2QAyDCyEiuYPlXV6j2r0DymXbEOwtrXzeGcTrOnoz1UU3X7lx2A64uIl6bZckw925RMB9YPAbPuPmlxqfcCUt2mKLr6giLTsOQrtW1/uliKG8c+JR1RG17BcrVK9+nx0v+50GCbxa97ZR5vdRkdY8jdZGgTMj39tFdjiaybWWMGNhfq0HKjiP/ioxfmzHP4ZZaejM4fAa1LZJuhf4yfuBFEehvhsPjuZh4H10nAXPTALIf3yC/FJGOWkh4Bs7zRnIHVFq/uwvrXuDqbZPSvhRQ+lK6G+xZSvChKwhHhsMkUvTh/0BV7J8QG66EdSrM8Z6SAc3yb3NAbZ5W19rQeCbGRyA7w8e8LsnbxChTSct8iYJueTJtczAhuh0mphzy5BvO4Tbd6Pey+pzmvR84FT7sOlGcUeEOsPYtJH3yhSgqmIjqWdpcC0Vssn33CgdnIewK8C8qxDXcYpE/+TA+qqyfsdPHZayzftup3ueuWPegfwtUpTeET67Q1Kib3nwL3CLZpbfwgfCQ7VA75p1XxZtL3lU1TxfbhNJqS3bW0nXdVm3XMp1Jf8dp9uij28Jx8Sdli+GTe88HAkwM2wgigNeSWIefjX3+mHMov3Ik8NunaxPi89Cq9QRUCsxDEzZa67ovNd3dbb1dHHRO5yr1VXFqDO3eSpRy43aBuWnpJB99IUtmwnwFuBx8Q5jf1pbPyO7quVGLqAY+0HailLb0bSGSWgPg3limcREsxGS6lYbXhd0LZg9XsUQlPEBul1iEd1s5y9obQYucn+t6zcDiO7CdkzFvEIdoauNusemGyHCywoXFsGJqwakVudZ23FFt8mzgKFzlv4/aBcF+6bEuthjblbjSjcg8/5JI+SWH2m1et9y2cgLFn75WPnelQVZw2Y8oV4KHY0T3euxAQK6tJ0havwtaw9/3uVaVRpaNPIxYbuq1HuVdX9bnw21RuJJUt+tAfTZnTbrx7EkJbgChKvcR95P50WvkIFueC5GbzBi3s4ZmSgVH67SrgiVXDKOE2g7NOLVSHY2aY9hBtufpgxNawLT/lEKInmB+G1LOmTGr4banE8VjKQaAUHTr2OYmX6TltQzknrqeJMwp9OqXdR9xZ+YahEO6QJidkaWKio9/qYwXgJi8tG5HHGGnmHhOqNetekRcH8UnvtdKO8agwRslZnROgP/NAZ1zfelV3DgphUhFCO7lmOu7wlQRiTuDYEDFxO+vWB+ZzDirZQFzRdGmMSIUKdCkKXjO5DTn+IuSPTiIb2T8WAkjVLByuhuQ+Z8AydY0nj5mcUA3gjn9BS1Cbj1KR+J1cZ2wMTooCZDVeOf1MvIkTAOZNoBVbMn57Xk1qQtpInHkm0e6Z3INtsIZ2pFddELfR8MDwy5rOv9AJNh+BEy0EDS6/1H3oZ4c5tka2w/IqM1j8StmF9ccGvMHqfOT8u9Nm2eMfj5ZXYsXJ5+t5QkhffKLci62+vnNfmE7DPx7vLW8BE6ywcAUppHuhFhzWKlDg+qHxAUuIWAS5BNBdVXJP0R0dj+ERUvo33fJvRU3SpKoPn8r65yITciF/ndgo6icmuieqZKhAzR1fe9FQ8gMuA4whZtTTb3rHIejN8qUXEjBthohcwz6/gFYEMuW4X+abJQAEEcrwCJiMDLITUpZ8AACesQBDR7sbeU0ezB6Cfs/2fs3aUwfgpoHhlJ2T9V3XDy5+yl+4Ufm0SuHshtLpglrhGbNlC0NuNh9liQ3Lc7odZGVEGpL5WPc0Oq6twr22yZkc2KmJxJ98ZK4/lJN9BeEc2487nKwzPNFEYqgtsZ/ql7GnDdcnDG+mF34n/j6cR6N6n7LYN7c8mxcIkzRqFoRsC4ZaEsRANl1u+rjtp1ZZAUTsRUhxvVJuTz2p2l+bReoXUmdMEqIW671PpYkEhqV4pjbP93GO7fEyIEZbi2G4KrdP0bqV1a68qgGbv9N6mA3DWe/cpdCbnke0XK3acSn251UTCKF/ZkkVJczGV+aT6MhtxZjjHKj6Q5wlkFXsP0kMMipzkQyRX2KJS3/fMY84i3P/TIbIV+xiVk7l16HiFvXY4nD+RX5msqyMv5cHAu4pRAH98uyLWQVEHIvaAdo5vcPm5ma3jR/MbD94mmBIwf3RopEHKYig/PtV/aTOzKdDVzhGv/vlCfCHyFCZU97Xlu+HkGw5O90wGWz5k6ecOnzCN+LiMkYfNhMHhYl6KOM02C3wwHPxzbVQ9hvpA96gEVP8Xbnr2eva8V9X8QG1htpVSvX96Fv+QwkhCkKQzN063Z/8GphJ/U7vLW99Jr52qphXXS4qc0GYdsHIw3P7Yv4b0vs267s/8//BcBNNSjdW7/uOsh1cgrS01bS7No8NgW80vrc2cq1f0bGU6HKmHERIKL4Ag8OARIzryTbTfgFVVIhxlO7ThyStKIm83Ys9NH/VK4f1UmGM0TeaTKOrnDlOwCHhHChCf+T5xsseo+6PUV0cBRPQnJ6NPYVmWO0ql+P7bYJ90f4xZCyoOMfHu7E59cMs/kDvt2UC97Bi+pDwj5EHCoxsO90EUcfvwBB5iXIimQIddnm1N4OrupyCjf62IX1y7NKt5UMkfMgqQy50PjXtE1H53Qu7fPfTcfO4BNAQRiLOAOWu3U6xr19fG1GzAkZOTXxn8mriwZ0q2iynnnLktL9PY5e+dA4eQ5yIBYgTmfNwOMbICpDMzyX1cx3r2R/dQX8VmfvrdbFJd39f3lD/fp68Z9dc6A1NrPJzQrOFkQmWt+71SJMmNOClTqDz5mCqaeJzsPU106RPWItu7xOza7C6Ey6Kv0Z2mUelDZU9YOQLRlo+QFVH0UTaL6j21MpCFp6siym48pVj19DWqQPa6QUkychZvbxWTR8qAEjU82zXToQnICtBYyKz7yM4oXls1SaM2/0we5mzIj7uqm60InRM8NAkAAAATJzuQgIkXSIbXN/KX+TrsdACM7WHecZwcBNdo5ysGgRcB4l6IlsYm7VuEWkmnLT8F/HBVCbjck004g0FXY0Ow+HrAGvhSnHh3bQXSU8tznYwcWuzF02Tvn3/+PwTNWPtow5ARO7QA09gLt7Aziyu1YpaD709kwp8QAJPbzs84NkApSttL1H060GpY1hciD2YZy3TdqPqd1/xwnsvtcuYGS1TE8fOOexTeCvp9XemVsf9Xz4CBjKF89qjNMb/+RCYNhIFWWY911gx6ISqeiPRBVBkn+yjybVsRmQynDtKXc3Q25LLKpLcKdcCFhxVHQrGHZNI+2HK/6FtwItqJKX3JpKVXDKPsW53aFkANcoPsvB0ikc1yI7+jdEiAAAAA==",alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后我们用 docker 把 mysql 跑起来："}),"\n",(0,c.jsx)(n.p,{children:"从 docker 官网下载 docker desktop，这个是 docker 的桌面端："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:Q,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"跑起来后，搜索 mysql 镜像（这步需要科学上网），点击 run："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:I,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"输入容器名、端口映射、以及挂载的数据卷，还要指定一个环境变量："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:H,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"端口映射就是把宿主机的 3306 端口映射到容器里的 3306 端口，这样就可以在宿主机访问了。"}),"\n",(0,c.jsx)(n.p,{children:"数据卷挂载就是把宿主机的某个目录映射到容器里的 /var/lib/mysql 目录，这样数据是保存在本地的，不会丢失。"}),"\n",(0,c.jsx)(n.p,{children:"而 MYSQL_ROOT_PASSWORD 的密码则是 mysql 连接时候的密码。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:R,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"跑起来后，我们用 GUI 客户端连上，这里我们用的是 mysql workbench，这是 mysql 官方提供的免费客户端："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:X,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"连接上之后，点击创建 database："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:M,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"指定名字、字符集为 utf8mb4，然后点击右下角的 apply。"}),"\n",(0,c.jsx)(n.p,{children:"创建成功之后在左侧就可以看到这个 database 了："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:E,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"当然，现在还没有表。"}),"\n",(0,c.jsx)(n.p,{children:"我们在 Nest 里用 TypeORM 连接 mysql。"}),"\n",(0,c.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,c.jsx)(n.p,{children:"mysql2 是数据库驱动，typeorm 是我们用的 orm 框架，而 @nestjs/tyeporm 是 nest 集成 typeorm 用的。"}),"\n",(0,c.jsx)(n.p,{children:"在 AppModule 里引入 TypeORM，指定数据库连接配置："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:U,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:'TypeOrmModule.forRoot({\n  type: "mysql",\n  host: "localhost",\n  port: 3306,\n  username: "root",\n  password: "guang",\n  database: "short-url",\n  synchronize: true,\n  logging: true,\n  entities: [],\n  poolSize: 10,\n  connectorPackage: \'mysql2\',\n  extra: {\n      authPlugin: \'sha256_password\',\n  }\n}),\n'})}),"\n",(0,c.jsx)(n.p,{children:"然后创建个 entity："}),"\n",(0,c.jsx)(n.p,{children:"src/entities/UniqueCode.ts"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import { Column, Entity, PrimaryGeneratedColumn } from \"typeorm\";\n\n@Entity()\nexport class UniqueCode {\n    \n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 10,\n        comment: '压缩码'\n    })\n    code: string;\n\n    @Column({\n        comment: '状态, 0 未使用、1 已使用'\n    })\n    status: number;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"在 AppModule 引入："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:N,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"保存之后，TypeORM会自动建表:"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:O,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:S,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"表创建好了，接下来插入一些数据："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"nest g service unique-code --flat --no-spec\n"})}),"\n",(0,c.jsx)(n.p,{children:"生成 service 类，--flat 是不生成目录 --no-spec 是不生成测试代码："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:P,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:q,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后创建 src/utils.ts 来放生成随机压缩码的代码："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import * as  base62 from \"base62/lib/ascii\";\n\nexport function generateRandomStr(len: number) {\n    let str = '';\n    for(let i = 0; i < len; i++) {\n        const num = Math.floor(Math.random() * 62);\n        str += base62.encode(num);\n    }\n    return str;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install base62\n"})}),"\n",(0,c.jsx)(n.p,{children:"然后在 UniqueCodeService 添加下插入压缩码的方法："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import { Injectable } from '@nestjs/common';\nimport { InjectEntityManager } from '@nestjs/typeorm';\nimport { EntityManager } from 'typeorm';\nimport { generateRandomStr } from './utils';\nimport { UniqueCode } from './entities/UniqueCode';\n\n@Injectable()\nexport class UniqueCodeService {\n\n    @InjectEntityManager()\n    private entityManager: EntityManager;\n \n    async generateCode() {\n        let str = generateRandomStr(6);\n\n        const uniqueCode = await this.entityManager.findOneBy(UniqueCode, {\n            code: str\n        });\n\n        if(!uniqueCode) {\n            const code = new UniqueCode();\n            code.code = str;\n            code.status = 0;\n\n            return await this.entityManager.insert(UniqueCode, code);\n        } else {\n            return this.generateCode();\n        }\n    }\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"就是生成随机的长度为 6 的字符串，查下数据库，如果没查到，就插入数据，否则重新生成。"}),"\n",(0,c.jsx)(n.p,{children:"我们用定时任务的方式来跑："}),"\n",(0,c.jsx)(n.p,{children:"安装用到的包："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"npm install --save @nestjs/schedule\n"})}),"\n",(0,c.jsx)(n.p,{children:"在 AppModule 注册下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:v,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"然后在 service 方法上声明，每 5s 执行一次："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:y,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Cron(CronExpression.EVERY_5_SECONDS)\n"})}),"\n",(0,c.jsx)(n.p,{children:"然后就可以看到一直在打印 insert 语句："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:C,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"数据库中也可以看到插入的未使用的压缩码："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:A,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"当然，一个个这么插入可太费劲了。"}),"\n",(0,c.jsx)(n.p,{children:"我们一般是在凌晨 4 点左右批量插入一堆，比如一次性插入 10000 个。"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:w,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Cron(CronExpression.EVERY_DAY_AT_4AM)\nasync batchGenerateCode() {\n    for(let i = 0; i< 10000; i++) {\n        this.generateCode();\n    }\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"这里我们是每次 insert 一个，你也可以每次 insert 10 个 20 个这种。"}),"\n",(0,c.jsx)(n.p,{children:"批量插入性能会好，因为执行的 sql 语句少。这里我们就先不优化了。"}),"\n",(0,c.jsx)(n.p,{children:"压缩码有了，接下来生成 url 和压缩码的对应关系就好了。"}),"\n",(0,c.jsx)(n.p,{children:"同样需要创建 entity："}),"\n",(0,c.jsx)(n.p,{children:"src/entities/ShortLongMap.ts"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn } from \"typeorm\";\n\n@Entity()\nexport class ShortLongMap {\n    \n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 10,\n        comment: '压缩码'\n    })\n    shortUrl: string;\n\n    @Column({\n        length: 200,\n        comment: '原始 url'\n    })\n    longUrl: string;\n\n    @CreateDateColumn()\n    createTime: Date;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"在 entities 引入："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:u,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"同样会自动建表："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:f,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:b,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"生成短链就是往这个表里添加记录。"}),"\n",(0,c.jsx)(n.p,{children:"我们加一个生成短链的 service："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"nest g service short-long-map --flat --no-spec\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:g,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"实现生成短链的方法："}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import { UniqueCodeService } from './unique-code.service';\nimport { Inject, Injectable } from '@nestjs/common';\nimport { InjectEntityManager } from '@nestjs/typeorm';\nimport { EntityManager } from 'typeorm';\nimport { ShortLongMap } from './entities/ShortLongMap';\nimport { UniqueCode } from './entities/UniqueCode';\n\n@Injectable()\nexport class ShortLongMapService {\n\n    @InjectEntityManager()\n    private entityManager: EntityManager;\n\n    @Inject(UniqueCodeService)\n    private uniqueCodeService: UniqueCodeService;\n\n    async generate(longUrl: string) {\n        let uniqueCode = await this.entityManager.findOneBy(UniqueCode, {\n            status: 0\n        })\n\n        if(!uniqueCode) {\n            uniqueCode = await this.uniqueCodeService.generateCode();\n        }\n        const map = new ShortLongMap();\n        map.shortUrl = uniqueCode.code;\n        map.longUrl = longUrl;\n  \n        await this.entityManager.insert(ShortLongMap, map);\n        await this.entityManager.update(UniqueCode, {\n            id: uniqueCode.id\n        }, {\n            status: 1\n        });\n        return uniqueCode.code;\n    }\n\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"这里就是先从 unique-code 表里取一个压缩码来用，如果没有可用压缩码，那就生成一个。"}),"\n",(0,c.jsx)(n.p,{children:"然后在 short-long-map 表里插入这条新的短链映射，并且把用到的压缩码状态改为 1。"}),"\n",(0,c.jsx)(n.p,{children:"我们在 AppController 里添加一个接口："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:m,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"import { ShortLongMapService } from './short-long-map.service';\nimport { Controller, Get, Inject, Query } from '@nestjs/common';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Inject(ShortLongMapService)\n  private shortLongMapService: ShortLongMapService;\n\n  @Get()\n  getHello(): string {\n    return this.appService.getHello();\n  }\n\n  @Get('short-url')\n  async generateShortUrl(@Query('url') longUrl) {\n    return this.shortLongMapService.generate(longUrl);\n  }\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"在浏览器里测试下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:x,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"可以看到，打印了 4 条 sql："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:j,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"首先 select 查出一个压缩码来，然后 insert 插入压缩码和 url 的映射，之后再把它 select 出来返回。"}),"\n",(0,c.jsx)(n.p,{children:"最后 update 更新压缩码状态。"}),"\n",(0,c.jsx)(n.p,{children:"看 sql 来说，是符合我们的预期的。"}),"\n",(0,c.jsx)(n.p,{children:"然后看下数据："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:o,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:h,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"也是对的。"}),"\n",(0,c.jsx)(n.p,{children:"那剩下的事情就很简单了，只要加一个重定向就好："}),"\n",(0,c.jsx)(n.p,{children:"首先在 service 里添加根据压缩码查询 longUrl 的方法："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:p,alt:""})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"async getLongUrl(code: string) {\n    const map = await this.entityManager.findOneBy(ShortLongMap, {\n        shortUrl: code\n    });\n    if(!map) {\n        return null;\n    }\n    return map.longUrl;\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"然后在 AppController 里添加一个重定向的接口："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:l,alt:"image.png"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-javascript",children:"@Get(':code')\n@Redirect()\nasync jump(@Param('code') code) {\n    const longUrl = await this.shortLongMapService.getLongUrl(code);\n    if(!longUrl) {\n      throw new BadRequestException('短链不存在');\n    }\n    return {\n      url: longUrl,\n      statusCode: 302\n    }  \n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"测试下："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:d,alt:"image.png"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:t,alt:"2023-12-01 14.32.03.gif"})}),"\n",(0,c.jsx)(n.p,{children:"这样，我们的短链服务就完成了。"}),"\n",(0,c.jsx)(n.p,{children:"其他的非核心功能，比如记录每次访问记录，做一些分析："}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:a,alt:""})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)("img",{src:i,alt:""})}),"\n",(0,c.jsx)(n.p,{children:"这些比较简单，就不实现了。"}),"\n",(0,c.jsxs)(n.p,{children:["案例代码上传了 github： ",(0,c.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/short-url",target:"_blank",rel:"noopener noreferrer",children:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/short-url"})]}),"\n",(0,c.jsxs)(n.h2,{id:"总结",children:["总结",(0,c.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,c.jsx)(n.p,{children:"我们经常用短链服务把长的 url 缩短，在短信里的链接一般都是这种。"}),"\n",(0,c.jsx)(n.p,{children:"我们用 Nest 自己实现了一个。"}),"\n",(0,c.jsx)(n.p,{children:"核心是压缩码的生成，我们分析了自增 id + base62，这样容易被人拿到其它短链，不安全。hash + base62 会有冲突的可能，所以最终用的是自己生成随机数 + base62 的方案。"}),"\n",(0,c.jsx)(n.p,{children:"当然，这个随机字符串最好是提前生成，比如用定时任务在低峰期批量生成一堆，之后直接用就好了。"}),"\n",(0,c.jsx)(n.p,{children:"短链的重定向使用 302 临时重定向，这样可以记录短链访问记录，做一些分析。"}),"\n",(0,c.jsx)(n.p,{children:"市面上的短链服务，基本都是这样实现的。"})]})}function $(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(_,{...e})}):_(e)}let ee=$;$.__RSPRESS_PAGE_META={},$.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F96.%20%E7%9F%AD%E9%93%BE%E6%9C%8D%E5%8A%A1%EF%BC%9F%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AA.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"96. 短链服务？自己写一个",headingTitle:"96. 短链服务？自己写一个",frontmatter:{}}}}]);