"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["66967"],{167109:function(n,e,s){s.r(e),s.d(e,{default:()=>O});var r=s(552676),t=s(740453);let o=s.p+"static/image/2385700100ee98ea7e5e4d78140732b9.2409afcd.webp",i=s.p+"static/image/6f77c78fedf29e712689f8e2b5eaf17c.aeaf4388.webp",c=s.p+"static/image/696420f52387b06db3d1e81f8b9eae3c.f4bf2cb7.webp",a=s.p+"static/image/327eef4f2e9623f6dd33b31989a217db.f7f1f055.webp",l=s.p+"static/image/8d71ab8b2541f2f37c4afe11db3cfc04.e7c0f308.webp",g=s.p+"static/image/14a53cf6f2e93ae495882198910dfda1.c42f548a.webp",p=s.p+"static/image/d420e59d5ea3c6bc16c068ba8b8ffe5e.e82ed40e.webp",d=s.p+"static/image/f436c1b6757f36a0e1d6736729e76940.249eb4ad.webp",m=s.p+"static/image/b35f7fe57aa551db97d60f7f1aa99cc2.fcd18291.webp",j=s.p+"static/image/a418a60f3e2b8621da272c8994c290c4.1a59c3d9.webp",x=s.p+"static/image/3b073a4c814194e39837056693e482e6.264f2f3b.webp",f=s.p+"static/image/8fe644e67b34f3e4a2413f930fd66930.b7f47d15.webp",h=s.p+"static/image/35c41d24403c1ad56352531c2da53bd1.d5ac8957.webp",b=s.p+"static/image/b55bd88139d386721d513c5867b7068f.c76e1a0a.webp",u=s.p+"static/image/eb7535729d4dd8f562c52e2dda9073e1.3dfb2132.webp",w=s.p+"static/image/ee909af1bed403d5d98950ed43589e00.3452e465.webp",L=s.p+"static/image/62b2429cb228d7eeb037fac24f5aee62.1b79a9a0.webp";function v(n){let e=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,t.ah)(),n.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(e.h1,{id:"38-nest-集成日志框架-winston",children:["38. Nest 集成日志框架 Winston",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#38-nest-集成日志框架-winston",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"我们学习了 Nest 如何自定义 logger，也学习了 Winston 的使用。"}),"\n",(0,r.jsx)(e.p,{children:"那如何在 Nest 里集成 Winston 呢？"}),"\n",(0,r.jsx)(e.p,{children:"这节我们来实现下。"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"nest new nest-winston-test\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"创建个 nest 项目。"}),"\n",(0,r.jsx)(e.p,{children:"在 src 添加一个 MyLogger.ts"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { LoggerService, LogLevel } from '@nestjs/common';\n\nexport class MyLogger implements LoggerService {\n    log(message: string, context: string) {\n        console.log(`---log---[${context}]---`, message)\n    }\n\n    error(message: string, context: string) {\n        console.log(`---error---[${context}]---`, message)\n    }\n\n    warn(message: string, context: string) {\n        console.log(`---warn---[${context}]---`, message)\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后在 main.ts 里引入："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"app.useLogger(new MyLogger());\n"})}),"\n",(0,r.jsx)(e.p,{children:"把服务跑起来："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"现在的 logger 就换成我们自己的了。"}),"\n",(0,r.jsx)(e.p,{children:"然后在 AppController 里添加 logger："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,UklGRj4PAABXRUJQVlA4IDIPAAAwYQCdASpuAtAAPp1Oo00lpKMiIXOpILATiWlu4XVBxt/VP+mdq/+g8P/HT5P/XP3J/tvL76k8VX28/Bfmj6//7vwd+RfkB8AX5T/Jv9H4ie11AB9b/+T/evFw1F/CX+x9wP+Y/1n/mcbR959QL+ef4H/sf4T2GP/L/aefr6z9g39fPTZ9p3pXB/lcTSrjrNmxeFWcIvg5DOak5JVelrPzl4R7MRFwOkEoFO6jTwb3TGPhGOqP2wuP30jYVaTucAbfadUVwF0kCG6FOILELBqwp3KCgi2I1qTVLgQjiyXfzsmw0mCNIEBuSYdmqBXxWY+jdrnYlMm6SEL1OUZN6MslN2fo9tyV6x3HGxYYXOXoXbud1Sk+dtSIClHuIPwk0ZS3e+6FDWfzrfQlPPbigVdmj3SaKytAX/EaGDJ5F1SHzEkKFLAKPFcwEi43oqldkJDrJ6nnXdZAE71iF+Au1EtjjrNo2lALdCktIDpYM7ihDgk6E8SkNNV3dP6vRCz0zQSFNcJ4fmtLQcGc3YlBRhvypf9OgqrlaKITPaIM/irQFXQ8wSjleb3uCO7OC8ywnR+/RFl7iPXbO2AdTaxqbmgIY+faH3n2h95+GkFu0za7sfPhdF8LNBaMQ4YRFXK1NBVelrPzcaw8rUbYRTW6CP0t+8iq+H53BtBY7V7LPjV4R3+rc8sXf4/S5HWu/x+lyO2PzuDQK3PKa4nT1MZWWmtHfBmK9fgFvDPKOtq1MEILZLbfgZixj7T6emnU5eNc1GS38xkW2VJYXUMZfkO8+0PvPtD7z7Q+kJPaSPh2iZXpXaj2Za3Juex/TrmZ17GOn1RHIg0Cb824xr0DovfSD085kdUOFqNXyEBO8tjhXnU5LJccvMndXti/tD7z7Q+8+0PvPtD72VofeztYd59ofefaH3n2h959ofefaH3n2h959ofefaH3n2h959ofefaH3n2h959ofebgdCt0nh57oaZZ0oTtD7z7Q+8+0PvPtD7z7CqYQwMYBLu0LFROsmUtPx+Z2lxFDCJbqeZMDgtaPYbkX4AA/v91AJvZBH8NS+T++24pU2XNQQiEQiEQiEQiEQguKGMN99OrRxjyH2teZA2ERVE+nQwV3o9wzqfDURcdTVcB5oHTDe6o7kIb80UbNFgQ7Hyxw3kYGV2mF+5QafdW1LxDiVmZFUYzn58Ke8chr1EExgtuK0ZPpqNWeHTNcCHID8OP2WWdUrpoXIDDCDq9L5FD1kFDjWHMTTBi/pbqVnCOY8vKetXAeznDt+7HD2nZ2nh+55i18iSgyS4+lje0ZvUWo87i5XrddWfq6KuXXxGmu8GHS223ErEMoTWJYd3ddF9tm+bmzWDqobEyLJw66vZEFhUBePeoIOGmaJm0nLVIvisTJCfHVQyxX/919LOSbPr55C815BjkJOR+7GJ34oKw7FyGkgnfEFrVjujD/+tUbXuJfBOTFUcMP5jMNO6VxQb5OtdlWLiEv1Ilu80bO6EtlQYSxKGS8sEJfmV6oPmp88qAumFf/Jg1J7fjhC+JKlvSbEgnqMZtEUleM0g65WFcL0+dZybGw5CGzB6qrOSqQKfDZvuwCP+4ddR9yuEzrSS1XSDCWIY5LoRtEeY+NkT6RThWcaoDkkIiWVhTbyURtOvxnqu2053Afxv8htazSJxA003nl3OHbygDCkl811EjtFqQQsQ0W5bidDMQ8ocGHRUUIlP7jWY8XPYVNB2jyEkbFdOkpdrEwTdnFcHf8bgZ45aHV2KJXLwTa2Qhg49b1t6el8lGC3x8BMJi6QMnn6AHB1AUKmjK/IA7FG28Y4xV0/A606pWtBEQ5h+2pY6J/avobR9ylY02RH349gQKDClByOBZIEWRB+Cw4h1KYfEGxC6czMFWifPveWGKWSF1r1yLlvHRaGIG65eqAOVvsOjrEMeXJ8sox1nklgtoeZOk438yD7o6GGRMpEnK0uOjzwyqgLU+7II9KJfuBgoY2s8ds5DxK7Kp2tCg7ZigeJ4wX1BYdKjxuCexaPIwcxV2tPqeQ/5b9gcjstN1vfyW77q3BP2T0eib9b1tjweUsMjsUOIAjwAMoM7sp69c/dwneiI2lpePLGBnaPbUeZDHSItZYF+0cHuKAmmLIboq5+mxz5/GOdPCiOATZ1rSwhfmYarWdM++FnWpOzY/158S8MnUZLvHdus3cBLJcQ6uAWNxSGICPbZtBGmRCmvp7iKu2+ePMmPe2zKH/ddA2MpAORwaiwKMiDlq+CKTnyQgn0l14El53n6eHaBViK1De1/r7gpCzNStayhOsypmHu/UfzjyWc5Ov18qHcof7tg13I0NyckP3rFGyfmYzoc3Bd99D4EIvh37g5n/D/6MZbPj+/7+X3nQWOmTfEr8p89G0fEr98ujyiWaD4oc9PWNNJRuqshvClqndpGPwkmuwAkfmITLf3o0m9JzJaHs1XQm4LUHfqtyExkjVuvxZIHpbGm/vS5TyO17PAJKHqW4h5F+oyk9LeSePwPnQphUNUy1eib+IUy7KELf+CCai16rZvCA+2DmC72HZ1mDEgTZLACrZNSIXUDRBBQvzglx5PV4iqFasupR6je/hu+uU13PlJlpYu/lkKrF2Pjq8wxwRm7QTAZRSTXJYduzWqG7T/eQsas86aaefrLZWSyirJrd8IMnPb8fbrvj1kV4D8ux5oHn57uq5snkekU60cwKJCgLQKU3p5Os+0W28SviLqxpG8TzUMEJ6RlcTa01omuopoFB5JSiAy8dziEcqP37ZRhRvXba2l8CPXbIc0EZ4PAHKAg9lQ3p3yNpBhoBT5wsB0Y3xwhlkrAFcxVDnL/fVFeSCcNQ2KFfVgPevXzzenJiUa1h+5CbCNR1zXvCp/6B43xR9KKi5ZeK/eygljCl7Zmn7/8WNxU1WHhtpUaWDz3/QjYNe/v0s2nVZQPA1pBAez8GKPB2p3SaBCf0/ttAFdbc0giqEmJep2EYL2ik8y0FGLMtrL3c9clhECLT5KOsmZPHF+t3W3VfTN7MVVRktrrMJopEnhxdMq/IbcNWJPAxQu/fhY2uafNcpQapUFNUAwBP+uu25hvk69+7/AfUDfOURvHnNjpRijlpUHfvLLvoRUg8htgCvg2BoLQySvAI5RgT9a8T5g9U8C3rcLFSR0/GlKSDybktymO3x0Pp4kLYbZAexarE30swrB2lMSppCLdaAzf50kTTq5XrilambsjyhoUswWbnNd0zl6RDjlrecYwovIcsdMq1zoQkpG8XKRn4qQSfCVops3cAFzcN1Q5RNcS4E5LLhj3l3ZHJqtZm50/qTgZMDJf5DHHMFAAOwigMj9RfmtZxJppzTTmmnWzgBj9ofQcGgzzRJJHuT6PsOD8PHlj1LvFtYHBy+ymJwdMyop5NscnZaNTOiLta7MkuI2KwV1nAzjVXkgC/Dlxd3pguVl7KueTXcpqvX72TsjQNo8PFUzRSv4nLVv/tUnQUo/Cj57n/DsF6OzUbf2YO7XRL77Wrand0Q1MUnLHqr0i7Ce7onQKvqBNWC8202Pj3PicLMd+xZzJuoIeHNRniRLMiwdOGTfbj4e6zQ67vlYXAxNCfj/uzuf+DWdgLWIQxL7vTP0MiJy94k7Iem2okvnYH1+p+clHmkFzXmi+5oxDTF47gwtN4Ijh9dU8uLk91yihKhIJ1Pib3lbWwBuXligMElY+AboxcE993/qmdl47rfvHgrq1TwgN52ZYxW4wBdujHfVvOl/+BmgvuOutDhRNqj2+ww8P6ACX1jp5LGdBYxrsRg70VDczzcHr+TRfZtxocBSxgpfv76ZcgX5DUhxFLzkaUqolmHUGoqmJ670cPp3nT+hEmCg9ygxJCEU6jPuE7FJ4cuPLx4/tp99RSj18MLwghFNRU/1T3BGcpUo9wBmJPXigzeEmC7YD17sly/CnW0qkIGEvpHTKkjAIekOay+bl8YiHPfNqPklLQBR9qIgLnWGy4b4sfLXLHL7Bc9orB3qyoi3hrbjnmzjHEBVP+/IDXn9YqhF+C24k1ZcX+xE21osLXPpAPYzNrssy41Ws1l5bSkhYQqBDnPjadX3ZSA8rgYC8Ylhq+yaQhLEafRfe8wF4ctBe0V2RDX8jCW/WKO3qxDegyVRMwTyx4t0TGXTuI27EOR/Y8fsrPLODakb5zhs2le2cgWcjjqeQL2+zPNUFPhF308IMOnNPnFsPxz4CF9itUDIiFhB21aLDkCf3DG/rysLoXvaTCv+zcISyK8qhlFblomBBtHO33BXv7azc49rcwQaoLW2CrNyyLU36Vukik+W8qosFDUGaMsVDZmLYIiCV7DRRSS2+J8NazUXdevSK294gubQKlDtt//iO+xSMZOzUHtz9FpYzRc3dN5h8x2aWZPMKt6YFLUUgyeIKZD6uwUrlRlHMuAng+30ggeu0rBBtqV23FP3sF/sNg3ApBBBXA24sCegTBic1gMi8G08eb1eaZ5CACIOOoHdnHrzMLAX5VOISsV0QiU9eJZL4gOQ/kzIYu9PkLrfyVeJ53l/i6ydfrJmv01U9pPyAw9O3kq6PX9UfofxW/pots0OtFmqUuyMmX2luJ096uNH/N+RA9mhJSICxDp9Hq/SsoRgMh/tOift5kfbBz3OrqM4KhnEpGDTmvO9ofMAAAAAAAAFDsUG5W9TPYKP+NXa9sfx6KsCV9TH9+NsjL+7EveKGCWziPEcJs5x6a2RCIMxNHLbPeNhOm9HU7XXxoudSs8fenOrF1ZFrXSbKJzd1e9VDTt4tl4AajCbSzcFAAHDgsOPQR7NNF/kzxw8jGObUUBQ1PMjY/2H9Ct6GOJT34VB3ThRGHu0TfXSiZlGvKomy6jx2Bco9H+ERZRpOWMF9/RLZlLqvm+uNOwtOVeNBONcJnsQD7EeQ7lNrdx/IPm3tDGnVSnfOXfaTd42ul5b+KkUcbkOI4bYe2w7S5c1IIW13xVoC9/Iyj8876CGbaU6aGqBIAz30DDA34nG4kwCt0GEvFjGMf3gvcPQ3HiIW1fSUQp6sFDSSXwLrOZAXACo/bhbOfaZtZeOnqKc43U3g6qAMsTJAjzwl9muTXabf6xBZAg/EO46WVr+i9uokhqD8KCo+HtokudZMEbXEegNas4pk6c6UNSNQeKehe/O4JviCO3EMXhcSOfM31sLRHsVKCpMvP4PvewNk8/XoAAA==",alt:""})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这样就完成了 logger 的自定义。"}),"\n",(0,r.jsx)(e.p,{children:"接下来只要换成 winston 的 logger 就好了。"}),"\n",(0,r.jsx)(e.p,{children:"安装 winston："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install --save  winston\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后改下 MyLogger："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { ConsoleLogger, LoggerService, LogLevel } from '@nestjs/common';\nimport { createLogger, format, Logger, transports } from 'winston';\n\nexport class MyLogger implements LoggerService {\n\n    private logger: Logger;\n\n    constructor() {    \n        this.logger = createLogger({\n            level: 'debug',\n            format: format.combine(\n                format.colorize(),\n                format.simple()\n            ),\n            transports: [\n                new transports.Console()\n            ]\n        });\n    }\n\n    log(message: string, context: string) {\n        this.logger.log('info', `[${context}] ${message}`);\n    }\n\n    error(message: string, context: string) {\n        this.logger.log('error', `[${context}] ${message}`);\n    }\n\n    warn(message: string, context: string) {\n        this.logger.log('warn', `[${context}] ${message}`);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"把 console.log 换成 winston 的 logger。"}),"\n",(0,r.jsx)(e.p,{children:"再跑下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"现在的日志就是 winston 的了。"}),"\n",(0,r.jsx)(e.p,{children:"只不过和 nest 原本的日志格式不大一样。"}),"\n",(0,r.jsx)(e.p,{children:"这个简单，我们自己写一下这种格式就好了。"}),"\n",(0,r.jsx)(e.p,{children:"安装 dayjs 格式化日期："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install --save dayjs\n"})}),"\n",(0,r.jsx)(e.p,{children:"安装 chalk 来打印颜色："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"npm install --save chalk@4\n"})}),"\n",(0,r.jsx)(e.p,{children:"注意：这里用的是 chalk 4.x 的版本。"}),"\n",(0,r.jsx)(e.p,{children:"然后来实现下 nest 日志的格式："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { ConsoleLogger, LoggerService, LogLevel } from '@nestjs/common';\nimport * as chalk from 'chalk';\nimport * as dayjs from 'dayjs';\nimport { createLogger, format, Logger, transports } from 'winston';\n\nexport class MyLogger implements LoggerService {\n\n    private logger: Logger;\n\n    constructor() {\n        super();\n    \n        this.logger = createLogger({\n            level: 'debug',\n            transports: [\n                new transports.Console({\n                    format: format.combine(\n                        format.colorize(),\n                        format.printf(({context, level, message, time}) => {\n                            const appStr = chalk.green(`[NEST]`);\n                            const contextStr = chalk.yellow(`[${context}]`);\n        \n                            return `${appStr} ${time} ${level} ${contextStr} ${message} `;\n                        })\n                    ),\n                })\n            ]\n        });\n    }\n\n    log(message: string, context: string) {\n        const time = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss');\n\n        this.logger.log('info', message, { context, time });\n    }\n\n    error(message: string, context: string) {\n        const time = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss');\n\n        this.logger.log('info', message, { context, time });\n    }\n\n    warn(message: string, context: string) {\n        const time = dayjs(Date.now()).format('YYYY-MM-DD HH:mm:ss');\n\n        this.logger.log('info', message, { context, time });\n    }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"这里用到了 printf 的 format 函数，它可以自定义打印的日志格式。"}),"\n",(0,r.jsx)(e.p,{children:"我们用 chalk 加上了颜色，并且打印了 dayjs 格式化的时间。"}),"\n",(0,r.jsx)(e.p,{children:"效果是这样的："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"是不是和 nest 原本的日志很像了？"}),"\n",(0,r.jsx)(e.p,{children:"然后我们再加一个 File 的 transport。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"指定为 json 格式，加上时间戳："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"new transports.File({\n    format: format.combine(\n        format.timestamp(),\n        format.json()\n    ),\n    filename: '111.log',\n    dirname: 'log'\n})\n"})}),"\n",(0,r.jsx)(e.p,{children:"console 的日志是这样的："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"file 的日志是这样的："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"这样，我们就完成了 nest 和 winston 的集成。"}),"\n",(0,r.jsx)(e.p,{children:"我们还可以进一步把它封装成一个动态模块。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { DynamicModule, Global, Module } from '@nestjs/common';\nimport { LoggerOptions, createLogger } from 'winston';\nimport { MyLogger } from './MyLogger';\n\nexport const WINSTON_LOGGER_TOKEN = 'WINSTON_LOGGER';\n\n@Global()\n@Module({})\nexport class WinstonModule {\n\n    public static forRoot(options: LoggerOptions): DynamicModule {    \n        return {\n            module: WinstonModule,\n            providers: [\n                {\n                    provide: WINSTON_LOGGER_TOKEN,\n                    useValue: new MyLogger(options)\n                }\n            ],\n            exports: [\n                WINSTON_LOGGER_TOKEN\n            ]\n        };\n      }\n}\n\n"})}),"\n",(0,r.jsx)(e.p,{children:"添加 forRoot 方法，接收 winston 的 createLogger 方法的参数，返回动态模块的 providers、exports。"}),"\n",(0,r.jsx)(e.p,{children:"用 useValue 创建 logger 对象作为 provider。"}),"\n",(0,r.jsx)(e.p,{children:"这里的 MyLogger 是之前那个复制过来的，但需要改一下 constructor："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"constructor(options) {    \n    this.logger = createLogger(options)\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"然后在 AppModule 引入下："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { WinstonModule } from './winston/winston.module';\nimport { transports, format } from 'winston';\nimport * as chalk from 'chalk';\n\n@Module({\n  imports: [WinstonModule.forRoot({\n      level: 'debug',\n      transports: [\n          new transports.Console({\n              format: format.combine(\n                  format.colorize(),\n                  format.printf(({context, level, message, time}) => {\n                      const appStr = chalk.green(`[NEST]`);\n                      const contextStr = chalk.yellow(`[${context}]`);\n  \n                      return `${appStr} ${time} ${level} ${contextStr} ${message} `;\n                  })\n              ),\n\n          }),\n          new transports.File({\n              format: format.combine(\n                  format.timestamp(),\n                  format.json()\n              ),\n              filename: '111.log',\n              dirname: 'log'\n          })\n      ]\n  })],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n\n"})}),"\n",(0,r.jsx)(e.p,{children:"之后改一下 main.ts 里用的 logger："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"app.useLogger(app.get(WINSTON_LOGGER_TOKEN));\n"})}),"\n",(0,r.jsx)(e.p,{children:"功能正常："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"只不过现在就没必要每次都 new 了："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"改成 inject 的方式，始终使用同一个实例，性能更好："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"@Inject(WINSTON_LOGGER_TOKEN)\nprivate logger;\n"})}),"\n",(0,r.jsxs)(e.p,{children:["当然，其实这个模块没必要自己封装，社区有已经封装好的可以直接用：",(0,r.jsx)(e.a,{href:"https://www.npmjs.com/package/nest-winston",target:"_blank",rel:"noopener noreferrer",children:"nest-winston"})]}),"\n",(0,r.jsx)(e.p,{children:"36w 的周下载量："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(e.p,{children:"用法也和我们实现的差不多。"}),"\n",(0,r.jsxs)(e.p,{children:["案例代码在",(0,r.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-winston-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(e.h2,{id:"总结",children:["总结",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"这节我们集成了 nest 和 winston。"}),"\n",(0,r.jsx)(e.p,{children:"前面我们学过了如何自定义 Nest 的 logger，现在只要在 Logger 的实现里改成 winston 的 logger 就好了。"}),"\n",(0,r.jsx)(e.p,{children:"只是想要保持 nest 原本日志的格式，需要用 printf 自定义。我们使用 dayjs + chalk 自定义了 winston 的日志格式。"}),"\n",(0,r.jsx)(e.p,{children:"当然，打印到 File 的日志，依然是 json 的。"}),"\n",(0,r.jsx)(e.p,{children:"之后封装了个动态模块，在 forRoot 方法里传入 options，模块内创建 winston 的 logger 实例。并且这个模块声明为全局模块。"}),"\n",(0,r.jsx)(e.p,{children:"这样，在应用的各处都可以注入我们自定义的基于 winston 的 logger 了。"}),"\n",(0,r.jsx)(e.p,{children:"不过项目里没必要自己写，用 nest-winston 就好了。"})]})}function P(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,t.ah)(),n.components);return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(v,{...n})}):v(n)}let O=P;P.__RSPRESS_PAGE_META={},P.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F38.%20Nest%20%E9%9B%86%E6%88%90%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6%20Winston.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"38. Nest 集成日志框架 Winston",headingTitle:"38. Nest 集成日志框架 Winston",frontmatter:{}}}}]);