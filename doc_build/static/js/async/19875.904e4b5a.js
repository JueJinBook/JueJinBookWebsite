"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["19875"],{354392:function(e,n,c){e.exports=c.p+"static/image/07dd83853ff4b57e074152e59a9f1af4.a4857cda.webp"},524801:function(e,n,c){e.exports=c.p+"static/image/0da9e5ddd2a2a5eaa6a9c8e04080b355.39494ab4.webp"},905019:function(e,n,c){e.exports=c.p+"static/image/be260a43b94975315c29851bcf342513.a5572207.webp"},983328:function(e,n,c){c.r(n),c.d(n,{default:()=>W});var s=c(552676),a=c(740453);let i=c.p+"static/image/50a4561eec42d0b22287fe2111d6646e.2953f42f.webp",r=c.p+"static/image/8f23b8094c9e88a0b04b8877bfc09c7e.be1b5f05.webp",d=c.p+"static/image/a125a667d41e4817a4f463c62d341a31.6c98df59.webp",p=c.p+"static/image/a2f89faf56cf7ca8b9c76334fe12c83a.58a431b1.webp",l=c.p+"static/image/b048226a8c7222e137173ad0dd36464b.af4a1b96.webp",t=c.p+"static/image/26fddba6efbd00791ee8651f32eb1905.f02aab1b.webp",j=c.p+"static/image/80aa88bff48559241601b58da857ba27.32536701.webp",x=c.p+"static/image/4a6b567d13c1f38dee49c6c8446540a2.10a296f8.webp",h=c.p+"static/image/0f59868f1853a6ce141f75e7752db98e.04dc18b2.webp",b=c.p+"static/image/5876a3fb28c755baa131c918b7971dcd.045c54de.webp",g=c.p+"static/image/bbaba5d0246286b830e53108fa1b52a5.7e00cca1.webp",f=c.p+"static/image/141b1861733c7beea97c328c3d973362.db1e91d5.webp",m=c.p+"static/image/33a6dc4037c0e57ae5d31eeedf25991a.05c930e0.webp",o=c.p+"static/image/ad445581741b64c931587991c0d750e1.5198bfd2.webp",u=c.p+"static/image/25a96684096d27ed168570417bd96cc1.14869e8b.webp",w=c.p+"static/image/86b81f1d9a134a9592b98f749eda1c43.b25aa404.webp",E=c.p+"static/image/c4eb2a5e96a92428b2472079291da1ef.893d46a7.webp",B=c.p+"static/image/5ff348e2989d8f8bdeae273a745d364b.f0c5a99c.webp",A=c.p+"static/image/8e242c8ef155db5035ceccdbc985f4bd.ee25e411.webp",S=c.p+"static/image/b27678b5519c4f1bdd1a6abd085c7b33.40c96dc9.webp",_=c.p+"static/image/3a3b4f68575eb378ea77c22da015f7f4.3dc4adf1.webp",C=c.p+"static/image/bab32498b4ad60bd8c4d896bd591816b.483ffc5f.webp",k=c.p+"static/image/a140767f0e466be4dd4c5b4d8c6a5889.a8853a36.webp",R=c.p+"static/image/fd92f56f39b01093d06ff993a0d5721e.18c5b3e2.webp",F=c.p+"static/image/318a85de7baf2fe648ecb73b433c2b54.d639787c.webp",P=c.p+"static/image/34412a594efd56a4c7dc0afab3779463.acef7dfb.webp",T=c.p+"static/image/fc85b6f4c44a76213e1c43ae0582344b.585b529e.webp";var v=c(354392),M=c(524801),y=c(905019);let D=c.p+"static/image/d72c0a0894aebbbdb888dd18df0c785c.7b5a7aad.webp",N=c.p+"static/image/18bc6e6c6f2fc9d736ea76119f2320a3.91e2ecf1.webp",G=c.p+"static/image/b66b83b96d8687f356fe077b826c1b4d.e02371c5.webp",O=c.p+"static/image/eba101d46a25bfeb5b50f010a1270463.149152d2.webp",z=c.p+"static/image/786f44a788a2133f03808da750a6bd68.b9c97c19.webp",H=c.p+"static/image/fa9ac9ac90b27f3b47ffe6f3fb9b9a7c.2b770e97.webp";function I(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",ul:"ul",li:"li",strong:"strong",h2:"h2"},(0,a.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"36通过调试技术理清-b-站视频播放速度很快的原因",children:["36.通过调试技术，理清 b 站视频播放速度很快的原因",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#36通过调试技术理清-b-站视频播放速度很快的原因",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"b 站视频播放的是很快的，基本是点哪就播放到哪。"}),"\n",(0,s.jsx)(n.p,{children:"而且如果你上次看到某个位置，下次会从那个位置继续播放。"}),"\n",(0,s.jsx)(n.p,{children:"那么问题来了：如果一个很大的视频，下载下来需要很久，怎么做到点哪个位置快速播放那个位置的视频呢？"}),"\n",(0,s.jsx)(n.p,{children:"前面写过一篇 range 请求的文章，也就是不下载资源的全部内容，只下载 range 对应的范围的部分。"}),"\n",(0,s.jsx)(n.p,{children:"那视频的快速播放，是不是也是基于 range 来实现的呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们先复习下 range 请求："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:H,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"请求的时候带上 range："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:z,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"服务端会返回 206 状态码，还有 Content-Range 的 header 代表当前下载的是整个资源的哪一部分："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:O,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这里的 Content-Length 是当前内容的长度，而 Content-Range 里是资源总长度和当前资源的范围。"}),"\n",(0,s.jsxs)(n.p,{children:["更多关于 Range 的介绍可以看这篇文章：",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7219140831365857317",target:"_blank",rel:"noopener noreferrer",children:"基于 HTTP Range 实现文件分片并发下载！"})]}),"\n",(0,s.jsx)(n.p,{children:"那 b 站视频是不是用 Range 来实现的快速播放呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们先在知乎的视频试一下："}),"\n",(0,s.jsx)(n.p,{children:"随便打开一个视频页面，比如这个："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:G,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"然后打开 devtools，刷新页面，拖动下进度条，可以看到确实有 206 的状态码："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:N,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们可以在搜索框输入 status-code:206 把它过滤出来："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:D,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这是一种叫过滤器的技巧："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:y,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以根据 method、domain、mime-type 等过滤。"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"has-response-header：过滤响应包含某个 header 的请求"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"method：根据 GET、POST 等请求方式过滤请求"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"domain: 根据域名过滤"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"status-code：过滤响应码是 xxx 的请求，比如 404、500 等"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"larger-than：过滤大小超过多少的请求，比如 100k，1M"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"mime-type：过滤某种 mime 类型的请求，比如 png、mp4、json、html 等"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"resource-type：根据请求分类来过滤，比如 document 文档请求，stylesheet 样式请求、fetch 请求，xhr 请求，preflight 预检请求"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"cookie-name：过滤带有某个名字的 cookie 的请求"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"当然，这些不需要记，输入一个 - 就会提示所有的过滤器："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:M,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"但是这个减号之后要去掉，它是非的意思："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:v,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"和右边的 invert 选项功能一样。"}),"\n",(0,s.jsx)(n.p,{children:"然后点开状态码为 206 的请求看一下："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:T,alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:P,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"确实，这是标准的 range 请求。"}),"\n",(0,s.jsx)(n.p,{children:"我点击进度条到后面的位置，可以看到发出了新的 range 请求："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:F,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"那这些 range 请求有什么关系呢？"}),"\n",(0,s.jsx)(n.p,{children:"我们需要分析下 Content-Range，但是一个个点开看不直观。"}),"\n",(0,s.jsx)(n.p,{children:"这时候可以自定义显示的列："}),"\n",(0,s.jsx)(n.p,{children:"右键单击列名，可以勾选展示的 header，不过这里面没有我们想要的 header，需要自定义："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:R,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"点击 Manage Header Columns"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:k,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"添加自定义的 header，输入 Content-Range:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:C,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这时候就可以直观的看出这些 range 请求的范围之间的关系："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:_,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"点击 Content-Range 这一列，升序排列。"}),"\n",(0,s.jsx)(n.p,{children:"我们刷新下页面，从头来试一下："}),"\n",(0,s.jsx)(n.p,{children:"随着视频的播放，你会看到一个个 range 请求发出："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:S,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这些 range 请求是能连起来的，也就是说边播边下载后面的部分。"}),"\n",(0,s.jsx)(n.p,{children:"视频进度条这里的灰条也在更新："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:A,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"当你直接点击后面的进度条："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:B,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"观察下 range，是不是新下载的片段和前面不连续了？"}),"\n",(0,s.jsx)(n.p,{children:"也就是说会根据进度来计算出 range，再去请求。"}),"\n",(0,s.jsx)(n.p,{children:"那这个 range 是完全随意的么？"}),"\n",(0,s.jsx)(n.p,{children:"并不是。"}),"\n",(0,s.jsx)(n.p,{children:"我们当前点击的是 15:22 的位置："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:E,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我刷新下页面，点击 15:31 的位置："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:w,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"如果是任意的 range，下载的部分应该和之前的不同吧。"}),"\n",(0,s.jsx)(n.p,{children:"但是你观察下两次的 range，都是 2097152-3145727"}),"\n",(0,s.jsx)(n.p,{children:"也就是说，视频分成多少段是提前就确定的，你点击进度条的时候，会计算出在哪个 range，然后下载对应 range 的视频片段来播放。"}),"\n",(0,s.jsx)(n.p,{children:"那有了这些视频片段，怎么播放呢？"}),"\n",(0,s.jsxs)(n.p,{children:["浏览器有一个 SourceBuffer 的 api，我们在 ",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/SourceBuffer",target:"_blank",rel:"noopener noreferrer",children:"MDN"})," 看一下："]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:u,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"大概是这样用的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:o,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"也就是说，可以一部分一部分的下载视频片段，然后 append 上去。"}),"\n",(0,s.jsx)(n.p,{children:"拖动进度条的时候，可以把之前的部分删掉，再 append 新的："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:m,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"我们验证下，搜索下代码里是否有 SourceBuffer："}),"\n",(0,s.jsx)(n.p,{children:"按住 command + f 可以搜索请求内容："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:f,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到搜索出 3 个结果。"}),"\n",(0,s.jsx)(n.p,{children:"在其中搜索下 SourceBuffer："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:g,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"可以看到很多用到 SourceBuffer 的方法，基本可以确认就是基于 SourceBuffer 实现的。"}),"\n",(0,s.jsxs)(n.p,{children:["也就是说，",(0,s.jsx)(n.strong,{children:"知乎视频是通过 range 来请求部分视频片段，通过 SourceBuffer 动态播放这个片段，来实现的快速播放的目的。具体的分段是提前确定好的，会根据进度条来计算出下载哪个 range 的视频。"})]}),"\n",(0,s.jsx)(n.p,{children:"那服务端是不是也要分段存储这些视频呢？"}),"\n",(0,s.jsx)(n.p,{children:"确实，有这样一种叫做 m3u8 的视频格式，它的存储就是一个个片段 ts 文件来存储的，这样就可以一部分一部分下载。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:b,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"不过知乎没用这种格式，还是 mp4 存储的，这种就需要根据 range 来读取部分文件内容来返回了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:h,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"再来看看 b 站，它也是用的 range 请求的方式来下载视频片段："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:x,alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["大概 600k 一个片段：\n",(0,s.jsx)("img",{src:j,alt:""})]}),"\n",(0,s.jsx)(n.p,{children:"下载 600k 在现在的网速下需要多久？这样播放能不快么？"}),"\n",(0,s.jsx)(n.p,{children:"相比之下，知乎大概是 1M 一个片段："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:t,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"网速不快的时候，体验肯定是不如 b 站的。"}),"\n",(0,s.jsx)(n.p,{children:"而且 b 站用的是一种叫做 m4s 的视频格式："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:l,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"它和 m3u8 类似，也是分段存储的，这样提前分成不同的小文件，然后 range 请求不同的片段文件，速度自然会很快。"}),"\n",(0,s.jsx)(n.p,{children:"然后再 command + f 搜索下代码，同样是用的 SourceBuffer："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:p,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这样，我们就知道了为什么 b 站视频播放的那么快了："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"m4s 分段存储视频，通过 range 请求动态下载某个视频片段，然后通过 SourceBuffer 来动态播放这个片段。"})}),"\n",(0,s.jsxs)(n.h2,{id:"总结",children:["总结",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"我们分析了 b 站、知乎视频播放速度很快的原因。"}),"\n",(0,s.jsxs)(n.p,{children:["结论是",(0,s.jsx)(n.strong,{children:"通过 range 动态请求视频的某个片段，然后通过 SourceBuffer 来动态播放这个片段。"})]}),"\n",(0,s.jsx)(n.p,{children:"这个 range 是提前确定好的，会根据进度条来计算下载哪个 range 的视频。"}),"\n",(0,s.jsx)(n.p,{children:"播放的时候，会边播边下载后面的 range，而调整进度的时候，也会从对应的 range 开始下载。"}),"\n",(0,s.jsx)(n.p,{children:"服务端存储这些视频片段的方式，b 站使用的 m4s，当然也可以用 m3u8，或者像知乎那样，动态读取 mp4 文件的部分内容返回。"}),"\n",(0,s.jsx)(n.p,{children:"除了结论之外，调试过程也是很重要的："}),"\n",(0,s.jsx)(n.p,{children:"我们通过 status-code 的过滤器来过滤出了 206 状态码的请求。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:d,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"通过自定义列在列表中直接显示了 Content-Range："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:r,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"通过 command + f 搜索了响应的内容："}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)("img",{src:i,alt:""})}),"\n",(0,s.jsx)(n.p,{children:"这篇文章就是对这些调试技巧的综合运用。"}),"\n",(0,s.jsx)(n.p,{children:"以后再看 b 站和知乎视频的时候，你会不会想起它是基于 range 来实现的分段下载和播放呢？"})]})}function L(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(I,{...e})}):I(e)}let W=L;L.__RSPRESS_PAGE_META={},L.__RSPRESS_PAGE_META["%E5%89%8D%E7%AB%AF%E8%B0%83%E8%AF%95%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%2F36.%E9%80%9A%E8%BF%87%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF%EF%BC%8C%E7%90%86%E6%B8%85%20b%20%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%80%9F%E5%BA%A6%E5%BE%88%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"36.通过调试技术，理清 b 站视频播放速度很快的原因",headingTitle:"36.通过调试技术，理清 b 站视频播放速度很快的原因",frontmatter:{}}}}]);