"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["69730"],{931192:function(e,n,s){s.r(n),s.d(n,{default:()=>u});var r=s(552676),i=s(740453);let c=s.p+"static/image/dff73be5058e2bf640d8824e9fcaffd1.69ffc39f.webp",t=s.p+"static/image/15b3dcaa0bc2ecee8f9271b07834e1c8.f130fb95.webp",d=s.p+"static/image/a196891c8e931f54882a923425b8f8f7.531cf654.webp",a=s.p+"static/image/a3bb89ba0d89de4c82da1fd194b24cac.cd559ef9.webp",l=s.p+"static/image/b96d7d0cf6a0dd09155e33e72ce85b54.c769e010.webp",p=s.p+"static/image/824e0e5043e3b296f873f35eff27a31c.6cd268b1.webp",o=s.p+"static/image/7053fa452d1dbdd3c1ffc9b669768ba9.e6e4b7a1.webp",h=s.p+"static/image/b45ba637d5afae34520dc9b9818d08e0.b1d604d7.webp",j=s.p+"static/image/4a91b6d5bd1f1274f74c8bfd76cbdf15.349a6f16.webp",x=s.p+"static/image/e361b6b310de8294992ebd17ea9d1831.45567ff3.webp",m=s.p+"static/image/624a89fc1a2bc831aab6044422ac3bc9.acae44b0.webp",f=s.p+"static/image/11f159b3e29af43f9e6d2fab82d32fb9.4613fd91.webp";function g(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",pre:"pre",code:"code",h2:"h2"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"64-在-nest-里操作-redis",children:["64. 在 Nest 里操作 Redis",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#64-在-nest-里操作-redis",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"我们通过 redis-cli 命令行和 RedisInsight 的 GUI 工具入门了 redis。"}),"\n",(0,r.jsx)(n.p,{children:"那在 Node 里怎么操作 redis 呢？"}),"\n",(0,r.jsx)(n.p,{children:"这就需要用 redis 的 node 的客户端了。"}),"\n",(0,r.jsxs)(n.p,{children:["redis 有很多的 ",(0,r.jsx)(n.a,{href:"https://redis.io/resources/clients/#nodejs",target:"_blank",rel:"noopener noreferrer",children:"node 客户端的包"}),"："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"最流行的就是 redis 和 ioredis 这两个。"}),"\n",(0,r.jsx)(n.p,{children:"我们创建个项目来试一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们先试一下 redis，它是官方提供的 npm 包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install redis\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在代码里连接 redis 服务，并执行命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { createClient } from 'redis';\n\nconst client = createClient({\n    socket: {\n        host: 'localhost',\n        port: 6379\n    }\n});\n\nclient.on('error', err => console.log('Redis Client Error', err));\n\nawait client.connect();\n\nconst value = await client.keys('*');\n\nconsole.log(value);\n\nawait client.disconnect();\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里执行 keys 命令，获取所有的 key。"}),"\n",(0,r.jsx)(n.p,{children:"因为用到了 es module、顶层 await，这些的启用需要在 package.json 里添加 type: module"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后 node 执行下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,UklGRlwMAABXRUJQVlA4IFAMAADQPQCdASrOAVAAPp1KoEwlpCMiJPOqILATiWNu3V+rKsKq+E4g7MvxLmTxgeoD8p+wB+kfSA8wH7D/sz7HP7Ae5T9dfYA/rP9J6wz0Bv109WP/l/t58GP7d/u18Bn7Vf//WV/EH8x7Tf9D4O+SH2b7hcljzHuW/df955Xf5vw5+Nv9/6EP833TvWPMC9g/snfHf5PoL9iPYA8tO8ioAfqH1Xv8r9o/Q3+d/8L2FFI+lHwAkfSj4ASPjwTuR88eDAxY6j1JxS0oBUY06hvzht1V33AEDHySM4hyQhWdV1oRzbEOWOjvXaxKi6gy4U+Pmct6kHqsEPQmHKFlAP+04tlGXC1SHVRnG/o6y7v9qoGm8EuME5Wb85mvv4Gct89wkuUk7Y1hAkaWTECPFLH/ryEesjNfOVtCwHazmvYGyTO2chZI+lHwAkHBj34fPV1lT6/RODwxhWGCjYTItSuctGDC0W+NGV/2135mAgHP2gckafnQnqsVaSGdGrbT1+xrbm3QcZakKzUxEkTP8sjV5G6qw4fFgMgvfBKDLDnbptJPTw/KKImxrBXlww+coC5R6XL46KXSGEwbTPfvIgzpWvIprTHcAWzYMMzjo68lcOxtQkMYTa8fDTWsaMZxYGLuiMDafKG69f/zc6A8z9f/smpf57oXP7xdAAD++eSAAB9S5h/WH/Cqug9li3svtkAVpWsZ07DfFkb/qmEtM7f8Sq8NoE3XJRENW5//6iRWhZ6mWziCgel3s8Gudt/k6KBXB1Io1bscCiKexopaMrLwACOdjT3E0bHwbBQvUtheaL+fswPEFY+aL2iTCHrL24umDiomAxUiIbREjEQif/8fhnOrDeOmW0yLtcQvKI5NNNJMS4uV8/KFYSFEo3MH4mP9tz1VfCAXLLnp+WXhbDZr0kPPCG5HksTmh4IM8jcheI+oc2CtN36LWU7AnM7rSNqdFY5nt1rMsNXI6kBA7hsblf+ErqhZAm6i93BqeYwguNYNh1Z6oFSErqU9qCq6RcTZpbZhh8eu6x/JNg6Ue8KXASZn4ZIyplfIJ5lVPLEDrsELSqrqwGLJZ7h6pFqmbQzFlRRArdJ8FEUILEMj26qh1LHW97R2RrBiiwtt6N1GISxknKjEGRtK9xJRklxD6ED17/WtKSQw4tmB0vLrzSAq3MYjsA2IeU0gGBrt3WGd2BGoqTVwBmLNa7oktwjZSqvDsAif38FvnYjscXo71NErkaR0XQqpWZswpioG6+DnDvOhGUcNl2neikMdC8L8sMRgtcnt9vM8Oc1UHu+dDKuoqAnwJAFUVb0tBb15EUSgTHj+SnQRTpRfzN8Kf6DyMsCLToogg+ShimRJiNOZdg3PKgue5UtylvJv4h14mF7RqJuJcoSmRFhTvAMw300IsquyW5eGNzOYHgqg+5FicAZ0m0uRFFEAld3RDZHtxlxR32zT3J0H+ZF9BorYfnZn79cZY2DU6TiJzwzBcpE6QrRzBoJA5CJRyvQkU1HrrxtuKYKV0uFiqd6VS18pdGR+UAsGfNeY2Kzt8PZn90e+znKnGFEegLBINm7wugbsNRowWcsAI2IpgIdZ4TmMwmpIMV+y2l7lq7eTorgbJcuc2sf1znK8V2jrNqu52/4+dYf6rhgFr55NdDLcsyZ6Kj/Jusup6EF9DvZC2uOQZ99aqAIogI+3CoSyT6+BIAq0c3fijUwO9V2qwBLK7NX0ak3tbU4jhZ9qjAibnQys7M3+GL/hpWc2Csr3ilgcwQ1ETIl3QqtyIQOic37TVgaht9PjEgi7ekZsMaa4Is6tQ7OCkF6i6PgMnF/fYUft2420VfbuO3lRT/dEn8Rh/kM1PWZteBqpgQAYBflkxp6YJEuE2u8XIvgtwiAvF51ZOv52t71nlPghTh8LNWt06HLZxdOkYHYetZEmlvSpvvz9Bbn8Ek7M7AQ5drDaDvpwwekNZE9otvLwYuog5vqCoFwzfy/4xqzymgpFOKU/FluK3egcqOZbI4A8sdeW4aRU5AVmxCUDh7WfnXxHhfxkMkL1z//VzKzVCZcaVwP+mqwbTPpykuEj9eSs/Rh7LA21cwU9vobn//96M/ZQRyEAanWnj/5+qQT9H+YFyq9bOiXDxGO0YvET5Rj9xsjSIK6R1KZiUfA6sDBQdT15vZBDYJE71PserqDLBuwmYaFriEjxwJCvSltJ4+IQ9KlbSWB0LmAFd6vZ1AFC45E2dCrNrBTcCloMDQjHEV/11CTCPqyXjaX6RSuPQ3GcNzcQzOGcMvOapQy8knufnbMGz1a+tjOE6v5+MeQL9EN6OCM5hs6I6p7/2m9S43slYAw/cHcsu8n17Vz7h0sI+tkbUnMqtjmbEhFm7elQcovyyjo80OdwBeDPVBvw2MMbRw8oUJgc7H3Pm9fdTiD+Bbrhbvx6OASQ4yN7nFp09RBbSFzJ1oaywp4UkQZ9gzhs6I6p7/2mwG6epfvKUEnM0Pvj42rED5iMKuG+OfYEj7VVbx+NphyGX2y6BMrBTOEvMjp8H6u43N5PWzv6UXivWUvWnUu/ZmZTb54dncgJTjjmSorOjleuYsRYpgniUVP5TNXPp+nmOerso5qwhqQEMn3qO8NLp3dwuQXxDnT/krejE+pf27JWsjrhJ/UKgSlBJXMbh9swiCvMURuswJZIv2EnpH7piuWP56gwOcSQv+SKp0MRMwLa5VF57FclF1bIDeGyavKyYlu/6J+Zx/EOdXdgq5c1tp19Jy9N1/ocZwbUgIZPvsEAH+/t/UysFM4TCxdKrjGQxQL5i6RJ51xcK8ZvTDllYy2injCmtbNQNmTrj+14kUhEtkR+3SnFETKjFpL/bYa94TUNn3OKPEVHEP4C9Lfy2ESOxr8K5foTfG4QFC+hfTI/4rJhHZXJKaAFIVdsUkjfIuY9T8R1sfPBeuF75dtuUeFGkMBMZw3glHTTrEgsDQeVix8Ikn9pgo/GOMwX+P8K8QPMykgESzAj5mJZ2Fo7wxarWRuzefTRfP2K/TPG5mYLFoKxn5RabHe0EJZVBjOtu4W7j5SeBdJullMZjvaUs4tYFByvxqj+tv+6GGw40/JIF/n/ZAS3R7a5mtnzFIrSN5dU/0gm5IEcXLUrcxRncm8mdIhSWc5q1I8Vue8WRGqXka3V9fWGNqEioEQhgoHGmyPYpAyUNROR8ppuWCh1jDQeexffaIdtyEaep3OPgMESYtH0WEO+LwcHwGVH+Ir0K4tML4mG0jwDcWTZtPlhWHT8F5uvhXdcPspa2+ULy6V5/61LMoOobviNbucnlSexpyn77vVida+5R1vrUbTqJ5Zjwh9rOVkBPALeY+vUcYWZTYvDAH/ct35+aWV2HG2fmAJBj+/eQxeqA+bFFhZ2j+ryNoM2AWOrsMgjWBvZN5iRgQ/Y657xZEapefsKGMjmFMz5KiNa6aKquIRCCg+M6i3FU+eVtBshSFl/VdlQQAd4P9X5VJ7OfgnW3McC+5lkQPtXAV6upt0xQeo6j5qO4mb5RJU1nQdPBSHezrx9e9mhJ93+HJMFFNbWp+eITWQpOaubCH+izRnMZ9MDQmUrdIwBWmKUsHDqjw+p4g6yLjQ/HUYnpS9HTwJXjL2ceUa/a9ce2yBW0xwwKQr7zJUlpaHuHNO6D+e+4HlFEZlWBEoQeg6q4U7h96MXbhFFdCgrqK5UoIpXE+J/ViPBRB90bfSbYL/i03uHLQ3aMh1Z+NJUvOvlHaB0KGy3u4SG/Mvb86/NGoXO2uCbHIcr8slSYK8u7IlUGfZ7zre/9V927OhyKdnYm52rdXPcHJyuvAOYzEzERR6H4TSYcLGlP9532v9AKWcOF5911/celCVDSmnAUEkNZLaQR8s9StsgJWFaPGafysX7IX4F5XL7a28GtxCZuZr0buHoKaJylKavK8l732//InxZSrEoDaEsHcpU9d6dsUhLuumTmUZqcQWF5qjAq2XhKY9VXeY6XC5H3DwmF4bc4AxfEUPAGBgfrlE/FZXymci1KKQUJ00SoD7/wF4KCjugFYM2OcMOH8nlZbhQmFFbRarS65K+5EyjqTdltBdT5BGDX1DZypDeS0REiYnogGxtEmEkBx07dpahqjVfX/EgzocYAu41KEDNskLwn8MbPEJtHhSLAglcPaRCQTqpKEaxR2a3t4vX30It71hNRUxY6SV8w3RNZv0Xza6lOb26tAGm3YAAAA==",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"用 RedisInsight 看下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"确实现在是有这些 key。"}),"\n",(0,r.jsx)(n.p,{children:"我们再执行其他命令试试，比如 hset 创建一个 hash 表："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"await client.hSet('guangguang1', '111', 'value111');\nawait client.hSet('guangguang1', '222', 'value222');\nawait client.hSet('guangguang1', '333', 'value333');\n"})}),"\n",(0,r.jsx)(n.p,{children:"执行以后是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"所有的 redis 命令都有对应的方法："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"和我们在命令行客户端里操作一样。"}),"\n",(0,r.jsx)(n.p,{children:"这样我们就完成了 node 里操作 redis 的功能。"}),"\n",(0,r.jsx)(n.p,{children:"再来试下 ioredis："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install ioredis\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后连接 redis server 并执行 keys 命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import Redis from \"ioredis\";\n\nconst redis = new Redis();\n\nconst res = await redis.keys('*');\n\nconsole.log(res);\n"})}),"\n",(0,r.jsx)(n.p,{children:"结果如下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"其他命令也是这样执行："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这些 node 包用起来还是很简单的，没啥学习成本。"}),"\n",(0,r.jsx)(n.p,{children:"那 nest 里怎么操作 redis 呢？"}),"\n",(0,r.jsx)(n.p,{children:"其实也是一样的："}),"\n",(0,r.jsx)(n.p,{children:"执行 nest new nest-redis 创建一个 nest 项目："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new nest-redis -p npm\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"当然，要先安装用到的 redis 的包。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install redis \n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 AppModule 添加一个自定义的 provider："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { createClient } from 'redis';\n\n@Module({\n  imports: [],\n  controllers: [AppController],\n  providers: [\n    AppService,\n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.p,{children:"通过 useFactory 的方式动态创建 provider，token 为 REDIS_CLIENT。"}),"\n",(0,r.jsx)(n.p,{children:"然后注入到 service 里用就好了："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class AppService {\n\n  @Inject('REDIS_CLIENT')\n  private redisClient: RedisClientType;\n\n  async getHello() {\n    const value = await this.redisClient.keys('*');\n    console.log(value);\n\n    return 'Hello World!';\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"因为 service 里加了 async、await，那 controller 里也得加一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样就能在 nest 里操作 redis 了。"}),"\n",(0,r.jsx)(n.p,{children:"我们把它跑起来，浏览器访问下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest start --watch\n"})}),"\n",(0,r.jsx)(n.p,{children:"可以看到控制台打印了 redis 命令的执行结果："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这就是在 Nest 里操作 redis 的方式。"}),"\n",(0,r.jsx)(n.p,{children:"案例代码在小册仓库："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/redis-node-test",target:"_blank",rel:"noopener noreferrer",children:"node 操作 redis"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-redis",target:"_blank",rel:"noopener noreferrer",children:"nest 操作 redis"})}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"通过 redis 的 npm 包（redis、ioredis 等）可以连接 redis server 并执行命令。"}),"\n",(0,r.jsx)(n.p,{children:"如果在 nest 里，可以通过 useFactory 动态创建一个 provider，在里面使用 redis 的 npm 包创建连接。"}),"\n",(0,r.jsx)(n.p,{children:"redis 是必备的中间件，后面的项目实战会大量用到。"})]})}function b(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(g,{...e})}):g(e)}let u=b;b.__RSPRESS_PAGE_META={},b.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F64.%20%E5%9C%A8%20Nest%20%E9%87%8C%E6%93%8D%E4%BD%9C%20Redis.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"64. 在 Nest 里操作 Redis",headingTitle:"64. 在 Nest 里操作 Redis",frontmatter:{}}}}]);