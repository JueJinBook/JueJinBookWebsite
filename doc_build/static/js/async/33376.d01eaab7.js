"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["33376"],{173564:function(e,n,s){e.exports=s.p+"static/image/1b88313da42af68b4e801026e69da8ba.271b54d3.webp"},630193:function(e){e.exports="data:image/webp;base64,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"},552013:function(e){e.exports="data:image/webp;base64,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"},470559:function(e,n,s){e.exports=s.p+"static/image/bbdc0025c9dcf42b053cdc87708a7dc5.fe69d78c.webp"},453607:function(e){e.exports="data:image/webp;base64,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"},809861:function(e,n,s){e.exports=s.p+"static/image/fdc230dd73faf06fd6dc50e23cb87f36.bfd02db3.webp"},537671:function(e,n,s){s.r(n),s.d(n,{default:()=>eu});var r=s(552676),i=s(740453);let c=s.p+"static/image/cc54939cea6521742e0d65fa12ce8bd6.26464f1d.webp",a=s.p+"static/image/aa7ae7631b518242c2cf0f4637902846.fe0d0977.webp",t=s.p+"static/image/894437613a8b94a96e3ec1caf54bf030.3f98c128.webp",o=s.p+"static/image/ae3ddf9c83447111bac9ecd61c6daf89.e9901d6f.webp",d=s.p+"static/image/e83f065b92e30dffe4dc6f02cdf2a48b.d35abd5f.webp",l=s.p+"static/image/9276095bb4cb31e79a507793e78e0199.b416ba83.webp",p=s.p+"static/image/e0a18f9b69ed66af57298c5be936eea8.8a630ca3.webp",m=s.p+"static/image/4fb746d3a846acaa9aee530c08845866.5a10ffab.webp",h=s.p+"static/image/20434cf4770d80993bbcf5a272a50327.b64c4ca7.webp",j=s.p+"static/image/cca0161f2d802d120a1b9e3030affc61.df543fd9.webp",u=s.p+"static/image/f43150568c521740f2603d3248f42151.a1217f32.webp";var g=s(173564);let x=s.p+"static/image/efce1b830b0a1b85b923d130e45ec78d.e3d9dd11.webp";var f=s(453607),b=s(470559),A=s(552013),v=s(630193);let w=s.p+"static/image/84815f23c421a32eae4f768358145ded.f706efbe.webp",S=s.p+"static/image/9ef557a5b6f59fbd9a526f82e1b20c29.ea46b011.webp";var y=s(809861);let G=s.p+"static/image/f49554226bb0b872af7475c3c407ba30.15b823c9.webp",q=s.p+"static/image/5f7f9d83202e33440e72d88ddea6389e.69a02a1a.webp",k=s.p+"static/image/2e83fa9dfabb6bca121df3061200d74e.923c375b.webp",E=s.p+"static/image/f5471ac49cc4931cb067370f82bdebd8.6045f2b1.webp",z=s.p+"static/image/cb937bc10f8e71d5d9c659f96fd3fed3.9f33dde4.webp",U=s.p+"static/image/adb08a762f6feb1a94cc07e6779feb72.4e303838.webp",C=s.p+"static/image/a8efe06ac2d79bfaae7a633d7c044fba.1a47f41b.webp",P=s.p+"static/image/0735b65830fab0f527f707264df4809b.f4ef093a.webp",B=s.p+"static/image/a4313b9bbc37b82d85b223c807b7cb82.07b0f5f8.webp",D=s.p+"static/image/1008d831cdd7cba8f53d5d52c610f099.fcedfb59.webp",M=s.p+"static/image/072785d5ae7f77c08abbefe193872095.e2e31428.webp",L=s.p+"static/image/e84b10aa04b773d6cae827811b849984.7c0c36a5.webp",N=s.p+"static/image/edf70dc6655856ed5478722afc50d566.56a4eeda.webp",I=s.p+"static/image/4b48a02b281f03e2d346b5b5828e2425.f8b7ee24.webp",Z=s.p+"static/image/54d89b9a2a8f552ae51ee973643a4db2.f1ed1b6b.webp",R=s.p+"static/image/c7f903dc979a2e4153d39f73e59a647e.39a51800.webp",O=s.p+"static/image/872be6d9d88f3856c5375390c822010d.d686697f.webp",F=s.p+"static/image/b82e79eb9c45c038888ea7f6e8b35e8f.ee2f759c.webp",H=s.p+"static/image/9a5aab0851a19eda0f16e57ee51746e1.9ba9d9fe.webp",V=s.p+"static/image/cff7d52a069264756d60badb18b5d3d8.5f7312fe.webp",X=s.p+"static/image/7fe5cde90c046c40f9af092421c8b531.27bdbbba.webp",T=s.p+"static/image/60cbbfcc417cde3c7a73548e70a87b3d.b8451290.webp",Q=s.p+"static/image/8af3ae5bc224b0212ffb69161a8f019e.f1e83661.webp",Y=s.p+"static/image/d2dcc698094b037d9bddad62cd969f5e.110b01d8.webp",K=s.p+"static/image/e5029d90a0befc21137ac1281a92c2d4.6921b1c3.webp",J=s.p+"static/image/99f2b437872d6efb76b2daeed322ab60.0061bd70.webp",W=s.p+"static/image/736c2c4e614a7bb9cafcdc5a8c4c98ea.41ab9493.webp",_=s.p+"static/image/2b2e10637281f98c9db6e75412324a6e.0bbc47d6.webp",$=s.p+"static/image/5e09129408ee20f81dd8943610880e6a.d6d4c990.webp",ee=s.p+"static/image/f754343ced19121bf5c61f9dd731073e.23a8480b.webp",en=s.p+"static/image/8d33777169ea04a978e73c7a58281806.427da380.webp",es=s.p+"static/image/cfa19f60d0c889ede3a38672168a4acf.021d0377.webp",er=s.p+"static/image/b1a419ce9bbd458d20906c82ad65556d.b02086bb.webp",ei=s.p+"static/image/feee48c3c8a4e711dc18621479d41647.9825581b.webp",ec=s.p+"static/image/26275776bacbb7caf92a08648f45afdf.92adbb35.webp",ea=s.p+"static/image/cc7d61e8bed3d727f571ef3c07da22a4.aceec953.webp",et=s.p+"static/image/9993385e953b78b48a4f289871863b87.8f5c7958.webp",eo=s.p+"static/image/524f3dff7dd4ff9737c36c9279b84d53.4baab671.webp",ed=s.p+"static/image/8d2957b16ccd681dd413ddb4b5a4555e.ec8f65df.webp",el=s.p+"static/image/5caa861303361cef00e34bf69cf6f856.58a71701.webp",ep=s.p+"static/image/2a3904023a36a8b26fcfe2777bcaddaa.a9c3a943.webp",em=s.p+"static/image/16e09e978404b8ccdf59dcec42b29f44.08a9d4f1.webp";function eh(e){let n=Object.assign({p:"p",pre:"pre",code:"code",img:"img",a:"a",h2:"h2"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"上节我们实现了用户注册的功能，这节继续实现登录认证鉴权。"}),"\n",(0,r.jsx)(n.p,{children:"在那之前，我们把配置抽离一下，现在的 mysql、redis、nodemailer 等配置都直接写在代码里，不好维护。"}),"\n",(0,r.jsx)(n.p,{children:"安装 config 的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save @nestjs/config\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 引入下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:em,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"ConfigModule.forRoot({\n  isGlobal: true,\n  envFilePath: 'src/.env'\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"设置为全局模块，指定 env 文件的位置。"}),"\n",(0,r.jsx)(n.p,{children:"然后在 src 下添加一个 .env 文件："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ep,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"redis_server_host=localhost\nredis_server_port=3306\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 RedisModule 里注入 ConfigService 来读取配置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:el,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"跑一下试试："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ed,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"正确读取到了 .env 的配置。"}),"\n",(0,r.jsx)(n.p,{children:"有的同学会问为什么 .env 不放在根目录呢？"}),"\n",(0,r.jsx)(n.p,{children:"因为根目录下的配置文件不会自动复制到 dist 目录。"}),"\n",(0,r.jsx)(n.p,{children:"我们在 nest-cli.json 里加一下 assets 的配置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:eo,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"asssets 是指定 build 时复制的文件，watchAssets 是在 assets 变动之后自动重新复制。"}),"\n",(0,r.jsx)(n.p,{children:"把 dist 删掉，跑下 npm run build。"}),"\n",(0,r.jsx)(n.p,{children:"你会发现 .env 确实复制过去了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:et,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们把 .env 移动到根目录，再删掉 dist，重新跑 npm run build。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ea,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"并没有自动复制 .env 过去。"}),"\n",(0,r.jsx)(n.p,{children:"如果你就是想把 .env 放在根目录，那可以手动加一下复制逻辑："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ec,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样再跑 npm run build，就会把 .env 复制过去了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ei,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"为了用到 nest cli 的复制 assets 的功能，我们还是把它放在 src 下。"}),"\n",(0,r.jsx)(n.p,{children:"在 .env 里添加 redis、mysql、nodemailer 和 nest 服务的配置："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# 112. 会议室预订系统：用户管理模块--配置抽离、登录认证鉴权\nredis_server_host=localhost\nredis_server_port=6379\nredis_server_db=1\n\n# nodemailer 相关配置\nnodemailer_host=smtp.qq.com\nnodemailer_port=587\nnodemailer_auth_user=你的邮箱\nnodemailer_auth_pass=你的授权码\n\n# mysql 相关配置\nmysql_server_host=localhost\nmysql_server_port=3306\nmysql_server_username=root\nmysql_server_password=guang\nmysql_server_database=meeting_room_booking_system\n\n# nest 服务配置\nnest_server_port=3000\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后把代码里的这些地方都改成读配置的方式："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:er,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const configService = app.get(ConfigService);\nawait app.listen(configService.get('nest_server_port'));\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:es,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"constructor(private configService: ConfigService) {\n  this.transporter = createTransport({\n      host: this.configService.get('nodemailer_host'),\n      port: this.configService.get('nodemailer_port'),\n      secure: false,\n      auth: {\n          user: this.configService.get('nodemailer_auth_user'),\n          pass: this.configService.get('nodemailer_auth_pass')\n      },\n  });\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:en,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: 'REDIS_CLIENT',\n  async useFactory(configService: ConfigService) {\n    const client = createClient({\n        socket: {\n            host: configService.get('redis_server_host'),\n            port: configService.get('redis_server_port')\n        },\n        database: configService.get('redis_server_db')\n    });\n    await client.connect();\n    return client;\n  },\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:ee,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"TypeOrmModule.forRootAsync({\n  useFactory(configService: ConfigService) {\n    return {\n      type: \"mysql\",\n      host: configService.get('mysql_server_host'),\n      port: configService.get('mysql_server_port'),\n      username: configService.get('mysql_server_username'),\n      password: configService.get('mysql_server_password'),\n      database: configService.get('mysql_server_database'),\n      synchronize: true,\n      logging: true,\n      entities: [\n        User, Role, Permission\n      ],\n      poolSize: 10,\n      connectorPackage: 'mysql2',\n      extra: {\n          authPlugin: 'sha256_password',\n      }\n    }\n  },\n  inject: [ConfigService]\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后测试下现在的功能是否正常："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:$,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:_,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:W,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:J,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:K,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,r.jsx)(n.p,{children:"这样我们配置抽取就成功了。"}),"\n",(0,r.jsx)(n.p,{children:"接下来继续实现登录功能。"}),"\n",(0,r.jsx)(n.p,{children:"我们先初始化用户、角色、权限的数据。"}),"\n",(0,r.jsx)(n.p,{children:"在 UserService 注入 Role 和 Permission 的 Repository："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"写个初始化数据的方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async initData() {\n    const user1 = new User();\n    user1.username = \"zhangsan\";\n    user1.password = md5(\"111111\");\n    user1.email = \"xxx@xx.com\";\n    user1.isAdmin = true;\n    user1.nickName = '张三';\n    user1.phoneNumber = '13233323333';\n\n    const user2 = new User();\n    user2.username = 'lisi';\n    user2.password = md5(\"222222\");\n    user2.email = \"yy@yy.com\";\n    user2.nickName = '李四';\n\n    const role1 = new Role();\n    role1.name = '管理员';\n\n    const role2 = new Role();\n    role2.name = '普通用户';\n\n    const permission1 = new Permission();\n    permission1.code = 'ccc';\n    permission1.description = '访问 ccc 接口';\n\n    const permission2 = new Permission();\n    permission2.code = 'ddd';\n    permission2.description = '访问 ddd 接口';\n\n    user1.roles = [role1];\n    user2.roles = [role2];\n\n    role1.permissions = [permission1, permission2];\n    role2.permissions = [permission1];\n\n    await this.permissionRepository.save([permission1, permission2]);\n    await this.roleRepository.save([role1, role2]);\n    await this.userRepository.save([user1, user2]);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"张三是管理员，有 ccc 和 ddd 接口访问权限。"}),"\n",(0,r.jsx)(n.p,{children:"李四是普通用户，只有 ccc 接口的访问权限。"}),"\n",(0,r.jsx)(n.p,{children:"然后在 UserController 添加个 handler："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get(\"init-data\") \nasync initData() {\n    await this.userService.initData();\n    return 'done';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"服务端打印了包裹在事务里的 insert 语句："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:T,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里看下："}),"\n",(0,r.jsx)(n.p,{children:"users 表："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:X,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["roles 表：\n",(0,r.jsx)("img",{src:V,alt:""})]}),"\n",(0,r.jsxs)(n.p,{children:["permissions 表：\n",(0,r.jsx)("img",{src:H,alt:""})]}),"\n",(0,r.jsxs)(n.p,{children:["user_roles 表：\n",(0,r.jsx)("img",{src:F,alt:""})]}),"\n",(0,r.jsxs)(n.p,{children:["role_permissions 表：\n",(0,r.jsx)("img",{src:O,alt:""})]}),"\n",(0,r.jsx)(n.p,{children:"都插入成功了。"}),"\n",(0,r.jsx)(n.p,{children:"有的同学问，在生产环境也这么初始化数据么？"}),"\n",(0,r.jsx)(n.p,{children:"那肯定不会啊，开发环境可以用代码来初始化数据，然后把数据导出为 sql，生产环境可以用这个 sql 文件来初始化。"}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里这样导出数据："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:R,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"你可以修改生成的 sql 文件位置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们来实现登录："}),"\n",(0,r.jsx)(n.p,{children:"后台管理的登录和用户端的登录是分开的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:N,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"但实现起来差别不大，我们一起来实现下。"}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 添加两个接口："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    console.log(loginUser);\n    return 'success';\n}\n\n@Post('admin/login')\nasync adminLogin(@Body() loginUser: LoginUserDto) {\n    console.log(loginUser);\n    return 'success';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"添加 src/user/dto/login-user.dto.ts："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { IsNotEmpty } from "class-validator";\n\nexport class LoginUserDto {\n\n    @IsNotEmpty({\n        message: "用户名不能为空"\n    })\n    username: string;\n    \n    @IsNotEmpty({\n        message: \'密码不能为空\'\n    })\n    password: string;    \n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"测试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 UserService 实现 login 方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async login(loginUserDto: LoginUserDto, isAdmin: boolean) {\n    const user = await this.userRepository.findOne({\n        where: {\n            username: loginUserDto.username,\n            isAdmin\n        },\n        relations: [ 'roles', 'roles.permissions']\n    });\n\n    if(!user) {\n        throw new HttpException('用户不存在', HttpStatus.BAD_REQUEST);\n    }\n\n    if(user.password !== md5(loginUserDto.password)) {\n        throw new HttpException('密码错误', HttpStatus.BAD_REQUEST);\n    }\n\n    return user;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"根据 username 和 isAdmin 查询数据库，设置级联查询 roles 和 roles.permissions。"}),"\n",(0,r.jsx)(n.p,{children:"如果没有找到用户，返回 400 响应提示用户不存在。"}),"\n",(0,r.jsx)(n.p,{children:"如果密码不对，返回 400 响应，提示密码错误。"}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 里调用下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    const user = await this.userService.login(loginUser, false);\n\n    return 'success';\n}\n\n@Post('admin/login')\nasync adminLogin(@Body() loginUser: LoginUserDto) {\n    const user = await this.userService.login(loginUser, true);\n\n    return 'success';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们创建个 vo （view object）对象来封装返回的数据。"}),"\n",(0,r.jsx)(n.p,{children:"dto 是接收参数的，vo 是封装返回的数据的，entity 是和数据库表对应的。"}),"\n",(0,r.jsx)(n.p,{children:"创建  src/user/vo/login-user.vo.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface UserInfo {\n    id: number;\n\n    username: string;\n\n    nickName: string;\n\n    email: string;\n\n    headPic: string;\n\n    phoneNumber: string;\n\n    isFrozen: boolean;\n\n    isAdmin: boolean;\n\n    createTime: number;\n\n    roles: string[];\n\n    permissions: string[]\n}\nexport class LoginUserVo {\n\n    userInfo: UserInfo;\n\n    accessToken: string;\n\n    refreshToken: string;\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"返回用户信息和两个 token。"}),"\n",(0,r.jsx)(n.p,{children:"在 UserService 的 login 方法里封装返回的数据："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"permissions 是所有 roles 的 permissions 的合并，要去下重。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"const vo = new LoginUserVo();\nvo.userInfo = {\n    id: user.id,\n    username: user.username,\n    nickName: user.nickName,\n    email: user.email,\n    phoneNumber: user.phoneNumber,\n    headPic: user.headPic,\n    createTime: user.createTime.getTime(),\n    isFrozen: user.isFrozen,\n    isAdmin: user.isAdmin,\n    roles: user.roles.map(item => item.name),\n    permissions: user.roles.reduce((arr, item) => {\n        item.permissions.forEach(permission => {\n            if(arr.indexOf(permission) === -1) {\n                arr.push(permission);\n            }\n        })\n        return arr;\n    }, [])\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 里返回 vo："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    const vo = await this.userService.login(loginUser, false);\n\n    return vo;\n}\n\n@Post('admin/login')\nasync adminLogin(@Body() loginUser: LoginUserDto) {\n    const vo = await this.userService.login(loginUser, true);\n\n    return vo;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"测试下:"}),"\n",(0,r.jsx)(n.p,{children:"/user/login"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"/user/admin/login"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后引入 jwt 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save @nestjs/jwt\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 里引入："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:U,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"JwtModule.registerAsync({\n  global: true,\n  useFactory(configService: ConfigService) {\n    return {\n      secret: configService.get('jwt_secret'),\n      signOptions: {\n        expiresIn: '30m' // 默认 30 分钟\n      }\n    }\n  },\n  inject: [ConfigService]\n}),\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里的密钥放到 .env 里配置："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:z,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# jwt 配置\njwt_secret=guang\njwt_access_token_expires_time=30m\njwt_refresh_token_expres_time=7d\n"})}),"\n",(0,r.jsxs)(n.p,{children:["这里 jwt 过期时间的语法可以看",(0,r.jsx)(n.a,{href:"https://github.com/vercel/ms#examples",target:"_blank",rel:"noopener noreferrer",children:"这个文档"}),"。"]}),"\n",(0,r.jsx)(n.p,{children:"然后登录认证通过之后返回 access_token 和 refresh_token："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject(JwtService)\nprivate jwtService: JwtService;\n\n@Inject(ConfigService)\nprivate configService: ConfigService;\n\n@Post('login')\nasync userLogin(@Body() loginUser: LoginUserDto) {\n    const vo = await this.userService.login(loginUser, false);\n\n    vo.accessToken = this.jwtService.sign({\n      userId: vo.userInfo.id,\n      username: vo.userInfo.username,\n      roles: vo.userInfo.roles,\n      permissions: vo.userInfo.permissions\n    }, {\n      expiresIn: this.configService.get('jwt_access_token_expires_time') || '30m'\n    });\n\n    vo.refreshToken = this.jwtService.sign({\n      userId: vo.userInfo.id\n    }, {\n      expiresIn: this.configService.get('jwt_refresh_token_expres_time') || '7d'\n    });\n\n    return vo;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"另一个接口同样的处理。"}),"\n",(0,r.jsx)(n.p,{children:"然后再增加一个 refresh_token 的接口用来刷新 token："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('refresh')\nasync refresh(@Query('refreshToken') refreshToken: string) {\n    try {\n      const data = this.jwtService.verify(refreshToken);\n\n      const user = await this.userService.findUserById(data.userId, false);\n\n      const access_token = this.jwtService.sign({\n        userId: user.id,\n        username: user.username,\n        roles: user.roles,\n        permissions: user.permissions\n      }, {\n        expiresIn: this.configService.get('jwt_access_token_expires_time') || '30m'\n      });\n\n      const refresh_token = this.jwtService.sign({\n        userId: user.id\n      }, {\n        expiresIn: this.configService.get('jwt_refresh_token_expres_time') || '7d'\n      });\n\n      return {\n        access_token,\n        refresh_token\n      }\n    } catch(e) {\n      throw new UnauthorizedException('token 已失效，请重新登录');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 UserService 实现这个 findUserById 方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async findUserById(userId: number, isAdmin: boolean) {\n    const user =  await this.userRepository.findOne({\n        where: {\n            id: userId,\n            isAdmin\n        },\n        relations: [ 'roles', 'roles.permissions']\n    });\n\n    return {\n        id: user.id,\n        username: user.username,\n        isAdmin: user.isAdmin,\n        roles: user.roles.map(item => item.name),\n        permissions: user.roles.reduce((arr, item) => {\n            item.permissions.forEach(permission => {\n                if(arr.indexOf(permission) === -1) {\n                    arr.push(permission);\n                }\n            })\n            return arr;\n        }, [])\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"同样的方式再实现一个后台管理的 refresh 接口："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('admin/refresh')\nasync adminRefresh(@Query('refreshToken') refreshToken: string) {\n    try {\n      const data = this.jwtService.verify(refreshToken);\n\n      const user = await this.userService.findUserById(data.userId, true);\n\n      const access_token = this.jwtService.sign({\n        userId: user.id,\n        username: user.username,\n        roles: user.roles,\n        permissions: user.permissions\n      }, {\n        expiresIn: this.configService.get('jwt_access_token_expires_time') || '30m'\n      });\n\n      const refresh_token = this.jwtService.sign({\n        userId: user.id\n      }, {\n        expiresIn: this.configService.get('jwt_refresh_token_expres_time') || '7d'\n      });\n\n      return {\n        access_token,\n        refresh_token\n      }\n    } catch(e) {\n      throw new UnauthorizedException('token 已失效，请重新登录');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"整体测试下："}),"\n",(0,r.jsx)(n.p,{children:"POST /user/login"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"GET /user/refresh"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"POST /user/admin/login"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"GET /user/admin/refresh"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"都没啥问题。"}),"\n",(0,r.jsx)(n.p,{children:"其实现在 controller 里有很多重复代码，比如多次生成 jwt 的代码，这个大家可以自己重构下，抽一个方法出来。"}),"\n",(0,r.jsx)(n.p,{children:"然后我们加上 LoginGuard 和 PermissionGuard 来做鉴权："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g guard login --flat --no-spec\nnest g guard permission --flat --no-spec\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"LoginGuard 的实现代码如下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { JwtService } from '@nestjs/jwt';\nimport { Request } from 'express';\nimport { Observable } from 'rxjs';\nimport { Permission } from './user/entities/permission.entity';\n\ninterface JwtUserData {\n  userId: number;\n  username: string;\n  roles: string[];\n  permissions: Permission[]\n}\n\ndeclare module 'express' {\n  interface Request {\n    user: JwtUserData\n  }\n}\n\n@Injectable()\nexport class LoginGuard implements CanActivate {\n  \n  @Inject()\n  private reflector: Reflector;\n\n  @Inject(JwtService)\n  private jwtService: JwtService;\n  \n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n    \n    const requireLogin = this.reflector.getAllAndOverride('require-login', [\n      context.getClass(),\n      context.getHandler()\n    ]);\n\n\n    if(!requireLogin) {\n      return true;\n    }\n    \n    const authorization = request.headers.authorization;\n\n    if(!authorization) {\n      throw new UnauthorizedException('用户未登录');\n    }\n\n    try{\n      const token = authorization.split(' ')[1];\n      const data = this.jwtService.verify<JwtUserData>(token);\n\n      request.user = {\n        userId: data.userId,\n        username: data.username,\n        roles: data.roles,\n        permissions: data.permissions\n      }\n      return true;\n    } catch(e) {\n      throw new UnauthorizedException('token 失效，请重新登录');\n    }\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"用 reflector 从目标 controller 和 handler 上拿到 require-login 的 metadata。"}),"\n",(0,r.jsx)(n.p,{children:"如果没有 metadata，就是不需要登录，返回 true 放行。"}),"\n",(0,r.jsx)(n.p,{children:"否则从 authorization 的 header 取出 jwt 来，把用户信息设置到 request，然后放行。"}),"\n",(0,r.jsx)(n.p,{children:"如果 jwt 无效，返回 401 响应，提示 token 失效，请重新登录。"}),"\n",(0,r.jsx)(n.p,{children:"（这段代码看不懂的话，回头去看下 RBAC 权限控制那节）"}),"\n",(0,r.jsx)(n.p,{children:"然后全局启用这个 Guard，在 AppModule 里添加这个 provider："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_GUARD,\n  useClass: LoginGuard\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 AppController 添加 aaa、bbb 两个接口："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\naaaa() {\n    return 'aaa';\n}\n\n@Get('bbb')\nbbb() {\n    return 'bbb';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 aaa 加上 require-login 的 matadata"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\n@SetMetadata('require-login', true)\naaaa() {\n    return 'aaa';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"会提示用户未登录："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"而 bbb 还是可以直接访问的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 postman 里登录下，拿到 access_token："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"添加到 authorization 的 header 里，就可以访问了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们继续实现 PermissionGuard："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { CanActivate, ExecutionContext, Inject, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Request } from 'express';\n\n@Injectable()\nexport class PermissionGuard implements CanActivate {\n\n  @Inject(Reflector)\n  private reflector: Reflector;\n\n  async canActivate(\n    context: ExecutionContext,\n  ): Promise<boolean> {\n    const request: Request = context.switchToHttp().getRequest();\n\n    if(!request.user) {\n      return true;\n    }\n\n    const permissions = request.user.permissions;\n\n    const requiredPermissions = this.reflector.getAllAndOverride<string[]>('require-permission', [\n      context.getClass(),\n      context.getHandler()\n    ])\n    \n    if(!requiredPermissions) {\n      return true;\n    }\n    \n    for(let i = 0; i < requiredPermissions.length; i++) {\n      const curPermission = requiredPermissions[i];\n      const found = permissions.find(item => item.code === curPermission);\n      if(!found) {\n        throw new UnauthorizedException('您没有访问该接口的权限');\n      }\n    }\n\n    return true;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"同样是用 reflector 取出 handler 或者 controller 上的 require-permission 的 metadata。"}),"\n",(0,r.jsx)(n.p,{children:"如果没有，就是不需要权限，直接放行，返回 true。"}),"\n",(0,r.jsx)(n.p,{children:"对于需要的每个权限，检查下用户是否拥有，没有的话就返回 401，提示没权限。"}),"\n",(0,r.jsx)(n.p,{children:"否则就放行，返回 true。"}),"\n",(0,r.jsx)(n.p,{children:"同样是全局启用这个 PermissionGuard"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: APP_GUARD,\n  useClass: PermissionGuard\n}  \n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 aaa 方法上声明需要的权限："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('aaa')\n@SetMetadata('require-login', true)\n@SetMetadata('require-permission', ['ddd'])\naaaa() {\n    return 'aaa';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"测试下："}),"\n",(0,r.jsx)(n.p,{children:"访问 /user/admin/login 登录 zhangsan 账号，拿到 accessToken"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"带上 accessToken，是可以访问 aaa 接口的，因为 zhangsan 有这个权限"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"访问 /user/login 登录 lisi 账号，拿到 accessToken"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"带上 accessToken，就不能访问 aaa 接口的，因为 lisi 没有这个权限"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样，接口鉴权就完成了。"}),"\n",(0,r.jsx)(n.p,{children:"最后我们把这两个 @SetMetadata 封装成自定义装饰器"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"新建 src/custom.decorator.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { SetMetadata } from \"@nestjs/common\";\n\nexport const  RequireLogin = () => SetMetadata('require-login', true);\n\nexport const  RequirePermission = (...permissions: string[]) => SetMetadata('require-permission', permissions);\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后给接口添加鉴权就可以这样写了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"此外还可以创建个自定义参数装饰器："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { SetMetadata } from \"@nestjs/common\";\nimport { createParamDecorator, ExecutionContext } from '@nestjs/common';\nimport { Request } from \"express\";\n\nexport const  RequireLogin = () => SetMetadata('require-login', true);\n\nexport const  RequirePermission = (...permissions: string[]) => SetMetadata('require-permission', permissions);\n\nexport const UserInfo = createParamDecorator(\n  (data: string, ctx: ExecutionContext) => {\n    const request = ctx.switchToHttp().getRequest<Request>();\n\n    if(!request.user) {\n        return null;\n    }\n    return data ? request.user[data] : request.user;\n  },\n)\n"})}),"\n",(0,r.jsx)(n.p,{children:"UserInfo 装饰器是用来取 user 信息传入 handler 的。"}),"\n",(0,r.jsx)(n.p,{children:"传入属性名的时候，返回对应的属性值，否则返回全部的 user 信息。"}),"\n",(0,r.jsx)(n.p,{children:"我们在 aaa 方法里测试下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"拿到 zhangsan 的 accessToken 来访问下 aaa 接口："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，服务端从 request 取出了 user 的值传入了 handler："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"而这个 request.user 是在 LoginGuard 里设置的。"}),"\n",(0,r.jsx)(n.p,{children:"这样，就完成了鉴权和拿到用户信息的功能。"}),"\n",(0,r.jsxs)(n.p,{children:["代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/meeting_room_booking_system_backend",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"这节我们实现了配置抽离、基于 jwt 登录、鉴权功能。"}),"\n",(0,r.jsx)(n.p,{children:"配置抽离使用 @nestjs/config 包，把配置放在 src 下的 .env 文件里，然后代码里从 configService 读取配置。"}),"\n",(0,r.jsx)(n.p,{children:"这样可以配置 nest-cli.json 的 assets 和 watchAssets 来自动把 env 文件复制到 dist 目录下。"}),"\n",(0,r.jsx)(n.p,{children:"我们使用代码做的数据初始化，线上要删掉这个接口，用导出的 sql 文件来初始化。"}),"\n",(0,r.jsx)(n.p,{children:"登录成功之后，返回 access_token、refresh_token 还有用户信息、roles、permissions 等。"}),"\n",(0,r.jsx)(n.p,{children:"并支持使用 refreshToken 来刷新 token。"}),"\n",(0,r.jsx)(n.p,{children:"之后使用 LoginGuard、PermissionGuard 来做登录和权限的鉴权，根据 handler 上的 metadata 来确定要不要做鉴权、需要什么权限。"}),"\n",(0,r.jsx)(n.p,{children:"我们还封装了几个自定义装饰器，用于方便的设置 metadata，从 request 取数据注入 handler。"}),"\n",(0,r.jsx)(n.p,{children:"至此，注册、登录、鉴权、配置抽离等功能就完成了。"})]})}function ej(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(eh,{...e})}):eh(e)}let eu=ej;ej.__RSPRESS_PAGE_META={},ej.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F112.%20%E4%BC%9A%E8%AE%AE%E5%AE%A4%E9%A2%84%E8%AE%A2%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97--%E9%85%8D%E7%BD%AE%E6%8A%BD%E7%A6%BB%E3%80%81%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E9%89%B4%E6%9D%83.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);