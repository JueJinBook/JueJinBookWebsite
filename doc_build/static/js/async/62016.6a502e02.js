"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["62016"],{12720:function(e,n,s){e.exports=s.p+"static/image/b39d2c1c360e6a9ec883c01b56c78b49.0bcaaa51.webp"},898667:function(e,n,s){s.r(n),s.d(n,{default:()=>B});var r=s(552676),c=s(740453);let a=s.p+"static/image/9c40823e57ede24bc4bf4b6c965da19b.b48ce963.webp",i=s.p+"static/image/1172a29d70669fe045071ee138298af8.68930e53.webp",p=s.p+"static/image/df881df4edc18a9c05aa7a6c186048fd.740d84d6.webp",d=s.p+"static/image/4edf83958abf3099224c6d3d912eb971.fa5b6782.webp",t=s.p+"static/image/bfe8ceffd5b2854527cf151bf607cb68.948a61f8.webp",l=s.p+"static/image/f2141e2a3b574075949fa35fa7bf7d5f.6280213f.webp",o=s.p+"static/image/69860111a6c1f865815e9c26ace37f5c.74105a85.webp",j=s.p+"static/image/dcb500d34984dc7ba401c94904d7f242.bf77d881.webp",h=s.p+"static/image/b6994ae2684740311c6bf59d56325c53.17e9ff1b.webp",x=s.p+"static/image/9aac5c6a79289af8408cb31617c620b4.9577e184.webp",b=s.p+"static/image/67d7e37ec8804e59975eb6a5443f3fe1.ee594968.webp",g=s.p+"static/image/438f494f0bef3cd8fff3e6e15759f28e.8724443b.webp",m=s.p+"static/image/d0164336de3e9770ab4703b8eb34619d.f2cf9a83.webp",u=s.p+"static/image/30faf34f948fc380990ad0d62666633b.bcd08e9f.webp",f=s.p+"static/image/743499cf91eadf230c3283fe4c610ffb.872dadd3.webp",v=s.p+"static/image/53d8d277ce5ce5edd3aac15675118567.d4a1dd0d.webp",A=s.p+"static/image/d5d70985dc31bcdfd398b77b795a7a98.f3d8b7ac.webp",C=s.p+"static/image/bc6f106579ea67640e4e9188a97a5772.49c25fbe.webp";var S=s(12720);let w=s.p+"static/image/9ce51f0fc3ac648df5b8c8cd4bf9bf6a.2ec9c982.webp",I=s.p+"static/image/c96c7780f0d6f85c4be92b2fc4be886e.068082a4.webp",k=s.p+"static/image/d0647765e866e1e13e0f2bbbaa214677.80279417.webp",F=s.p+"static/image/ea4205dd21a7276a0f921201674d3a14.4bbdf4a5.webp",P=s.p+"static/image/753f554731433fa0329993811c9ae460.c24b661d.webp",y=s.p+"static/image/bedfb6f7b14c68b812563932117e2eca.3e943666.webp",E=s.p+"static/image/5312214238f99d73d2052aac41ebce79.3f7d40b5.webp",D=s.p+"static/image/4a01e33f3722ca111fc858280c09c758.8bf99202.webp";function V(e){let n=Object.assign({h1:"h1",a:"a",p:"p",pre:"pre",code:"code",img:"img",h2:"h2"},(0,c.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"8-使用多种-provider灵活注入对象",children:["8. 使用多种 Provider，灵活注入对象",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#8-使用多种-provider灵活注入对象",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"Nest 实现了 IoC 容器，会从入口模块开始扫描，分析 Module 之间的引用关系，对象之间的依赖关系，自动把 provider 注入到目标对象。"}),"\n",(0,r.jsx)(n.p,{children:"而这个 provider 也有好几种，这节我们就来看一下。"}),"\n",(0,r.jsx)(n.p,{children:"我们创建个 nest 项目："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new custom-provider\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到 AppService 是被 @Injectable 修饰的 class："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 Module 的 providers 里声明："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这就是 provider。"}),"\n",(0,r.jsx)(n.p,{children:"其实这是一种简写，完整的写法是这样的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: AppService,\n  useClass: AppService\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"通过 provide 指定 token，通过 useClass 指定对象的类，Nest 会自动对它做实例化后用来注入。"}),"\n",(0,r.jsx)(n.p,{children:"在 AppController 的构造器里参数里声明了 AppService 的依赖，就会自动注入："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"如果不想用构造器注入，也可以属性注入："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject(AppService)\nprivate readonly appService: AppService;\n"})}),"\n",(0,r.jsx)(n.p,{children:"通过 @Inject 指定注入的 provider 的 token 即可。"}),"\n",(0,r.jsx)(n.p,{children:"有的同学说，在构造器参数里指定 AppService 的依赖的时候也没指定 token 啊？"}),"\n",(0,r.jsx)(n.p,{children:"那是因为 AppService 这个 class 本身就是 token。"}),"\n",(0,r.jsx)(n.p,{children:"当然，这个 token 也可以是字符串："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n    provide: 'app_service',\n    useClass: AppService\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"如果 token 是字符串的话，注入的时候就要用 @Inject 手动指定注入对象的 token 了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject('app_service') private readonly appService: AppService\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们调试下："}),"\n",(0,r.jsx)(n.p,{children:"点击调试面板的 create launch.json file，创建调试配置文件："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"添加这样一个调试配置："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "type": "node",\n    "request": "launch",\n    "name": "debug nest",\n    "runtimeExecutable": "npm",\n    "args": [\n        "run",\n        "start:dev",\n    ],\n    "skipFiles": [\n        "<node_internals>/**"\n    ],\n    "console": "integratedTerminal",\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"在 getHello 方法打个断点，点击调试启动："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["浏览器访问 ",(0,r.jsx)(n.a,{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer",children:"http://localhost:3000"})," ，代码会在断点处断住。"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，这时候 appService 就有值了。"}),"\n",(0,r.jsx)(n.p,{children:"也就是说，用字符串或者 class 做 token 的 provider，都可以正确被注入到目标对象。"}),"\n",(0,r.jsx)(n.p,{children:"相比之下，用 class 做 token 可以省去 @Inject，比较简便。"}),"\n",(0,r.jsx)(n.p,{children:"除了指定 class 外，还可以直接指定一个值，让 IoC 容器来注入。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n    provide: 'person',\n    useValue: {\n        name: 'aaa',\n        age: 20\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"使用 provide 指定 token，使用 useValue 指定值。"}),"\n",(0,r.jsx)(n.p,{children:"然后在对象里注入它："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject('person') private readonly person: {name: string, age: number}\n"})}),"\n",(0,r.jsx)(n.p,{children:"调试一下可以看到，确实是注入了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"provider 的值可能是动态产生的，Nest 也同样支持："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n    provide: 'person2',\n    useFactory() {\n        return {\n            name: 'bbb',\n            desc: 'cccc'\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"我们可以使用 useFactory 来动态创建一个对象。"}),"\n",(0,r.jsx)(n.p,{children:"在对象里注入："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject('person2') private readonly person2: {name: string, desc: string}\n"})}),"\n",(0,r.jsx)(n.p,{children:"类型是 {name: string, age: number} 。"}),"\n",(0,r.jsx)(n.p,{children:"调试下，也是可以拿到创建出的对象的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这个 useFactory 支持通过参数注入别的 provider："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: 'person3',\n  useFactory(person: { name: string }, appService: AppService) {\n    return {\n      name: person.name,\n      desc: appService.getHello()\n    }\n  },\n  inject: ['person', AppService]\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"通过 inject 声明了两个 token，一个是字符串 token 的 person，一个是 class token 的 AppService。"}),"\n",(0,r.jsx)(n.p,{children:"也就是注入这两个 provider："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 return 那里打个断点。"}),"\n",(0,r.jsx)(n.p,{children:"可以看到，在调用 useFactory 方法的时候，Nest 就会注入这两个对象："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"useFactory 支持异步："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: 'person5',\n  async useFactory() {\n    await new Promise((resolve) => {\n      setTimeout(resolve, 3000);\n    });\n    return {\n      name: 'bbb',\n      desc: 'cccc'\n    }\n  },\n},\n"})}),"\n",(0,r.jsx)(n.p,{children:"Nest 会等拿到异步方法的结果之后再注入："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样就可以更灵活的创建注入对象。"}),"\n",(0,r.jsx)(n.p,{children:"此外，provider 还可以通过 useExisting 来指定别名："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  provide: 'person4',\n  useExisting: 'person2'\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"这里就是给 person2 的 token 的 provider 起个新的 token 叫做 person4。"}),"\n",(0,r.jsx)(n.p,{children:"然后就可以用新 token 来注入了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这些自定义 provider 的方式里，最常用的是 useClass，不过我们一般会用简写，也就是直接指定 class。"}),"\n",(0,r.jsx)(n.p,{children:"useClass 的方式由 IoC 容器负责实例化，我们也可以用 useValue、useFactory 直接指定对象。"}),"\n",(0,r.jsx)(n.p,{children:"useExisting 只是用来起别名的，有的场景下会用到。"}),"\n",(0,r.jsx)(n.p,{children:"比如 @nestjs/typeorm 里就用到了 useValue、useFactory、useExisting："}),"\n",(0,r.jsxs)(n.p,{children:["它用 useValue 来",(0,r.jsx)(n.a,{href:"https://github.com/nestjs/typeorm/blob/153da09a384fdbf797b66e4500b69a72a7a47b78/lib/typeorm-core.module.ts#L113-L116",target:"_blank",rel:"noopener noreferrer",children:"注入一段字符串"}),"："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["用 useFactory 根据传入的 options ",(0,r.jsx)(n.a,{href:"https://github.com/nestjs/typeorm/blob/153da09a384fdbf797b66e4500b69a72a7a47b78/lib/typeorm-core.module.ts#L83-L101",target:"_blank",rel:"noopener noreferrer",children:"动态创建数据库连接对象"}),"："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["用 useExisting 给 DataSource 起了一个 Connection 的",(0,r.jsx)(n.a,{href:"https://github.com/nestjs/typeorm/blob/153da09a384fdbf797b66e4500b69a72a7a47b78/lib/typeorm-core.module.ts#L68-L71",target:"_blank",rel:"noopener noreferrer",children:"别名"}),"："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这里是一个版本用了 Connection，一个版本用了 DataSource，通过 useExisting 起别名就可以兼容两者。"}),"\n",(0,r.jsx)(n.p,{children:"此外，如果觉得构造器注入写起来不方便，可以使用属性注入，效果一样："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:i,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["案例代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/custom-provider",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"一般情况下，provider 是通过 @Injectable 声明，然后在 @Module 的 providers 数组里注册的 class。"}),"\n",(0,r.jsx)(n.p,{children:"默认的 token 就是 class，这样不用使用 @Inject 来指定注入的 token。"}),"\n",(0,r.jsx)(n.p,{children:"但也可以用字符串类型的 token，不过注入的时候要用 @Inject 单独指定。"}),"\n",(0,r.jsx)(n.p,{children:"除了可以用 useClass 指定注入的 class，还可以用 useValue 直接指定注入的对象。"}),"\n",(0,r.jsx)(n.p,{children:"如果想动态生成对象，可以使用 useFactory，它的参数也注入 IOC 容器中的对象，然后动态返回 provider 的对象。"}),"\n",(0,r.jsx)(n.p,{children:"如果想起别名，可以用 useExisting 给已有的 token，指定一个新 token。"}),"\n",(0,r.jsx)(n.p,{children:"灵活运用这些 provider 类型，就可以利用 Nest 的 IOC 容器中注入任何对象。"})]})}function O(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(V,{...e})}):V(e)}let B=O;O.__RSPRESS_PAGE_META={},O.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F8.%20%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%A7%8D%20Provider%EF%BC%8C%E7%81%B5%E6%B4%BB%E6%B3%A8%E5%85%A5%E5%AF%B9%E8%B1%A1.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"8. 使用多种 Provider，灵活注入对象",headingTitle:"8. 使用多种 Provider，灵活注入对象",frontmatter:{}}}}]);