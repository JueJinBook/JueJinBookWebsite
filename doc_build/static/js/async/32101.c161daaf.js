"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["32101"],{704174:function(n,e,s){n.exports=s.p+"static/image/05fe13cd2d8464a8b668cd26d9b0840a.b5119a48.webp"},140759:function(n,e,s){n.exports=s.p+"static/image/9b3c777f272dd46fbc978a40be27224b.b847128c.webp"},686967:function(n,e,s){n.exports=s.p+"static/image/f6493db57073d6aabe007d703e3cfaec.d1810660.webp"},423580:function(n,e,s){s.r(e),s.d(e,{default:()=>$});var i=s(552676),r=s(740453);let c=s.p+"static/image/e1257c4402107f53c04199df0e128042.cd9a9f57.webp";var a=s(140759);let d=s.p+"static/image/bcf83b8b9636b7896ad0774fe76ff09a.abadc5bb.webp",t=s.p+"static/image/179dbd00a87d32ebf0764f3bb7f15b80.8ab7773e.webp",l=s.p+"static/image/5e3e2c94b16562624b0fbb69dcf1049c.dabe6925.webp",p=s.p+"static/image/8d7dae27de2a8a7c85c23faf04ef2f44.4216b250.webp",j=s.p+"static/image/b1e5e11a5cd15645eef419679d0b75c8.f3ce0084.webp",h=s.p+"static/image/5727ee3d928182e21fa8f4208ec37e2c.f8c3e352.webp",x=s.p+"static/image/042199f97d8c6094f743a85419d9cb18.0b2ac4ff.webp",g=s.p+"static/image/e760bac3ca23681ec81e8cae3e108e3d.f54332d6.webp",o=s.p+"static/image/c27aba44e01db581d8a6c3e648ca1ad5.d3be1773.webp",m=s.p+"static/image/8425304ff12482d25b5a40567de43c9d.c0f77de0.webp",b=s.p+"static/image/a02e9f35bbee8092a91cb759a7b009a4.6555d40c.webp",f=s.p+"static/image/ca6761a398e39758ddb2a860b0be1d23.6d69925f.webp",A=s.p+"static/image/5b8c81f8f234acec178cfe18bcd23b54.1cf9e9ea.webp",k=s.p+"static/image/245fa060e2344c0ae63b95c356cf8f71.895e5a6a.webp",R=s.p+"static/image/e9b529c9821d78def295e087185c1f00.90c63dbc.webp",Z=s.p+"static/image/ccbfbe6305f52bcd1a27fffbcf273cbc.608ad7bb.webp",w=s.p+"static/image/89afec8d50d01498f67c7060733d8d78.cbf491e2.webp",E=s.p+"static/image/c9dddd41f89940a252df3a75f3ba846d.a00474c2.webp",S=s.p+"static/image/94df7e74de8fac29517bbd7279ca3164.560f9375.webp";var u=s(704174);let v=s.p+"static/image/524c6c072f6a14660f1f9324de70f885.845d541f.webp",y=s.p+"static/image/eb83b350115567d820fb80f1f2c7e9a8.55ccb00f.webp",I=s.p+"static/image/b4f8da354f936bf31c39a050f34fcba7.cbc63f03.webp",N=s.p+"static/image/aae0ade1f392f5276965e2b42007a764.2bd88719.webp",C=s.p+"static/image/00eb6bf4a396fae338393729ca990665.cc0841bb.webp",z=s.p+"static/image/7fbdb3d09ec279dbfedd774cc9216acf.2aaa2cb7.webp",M=s.p+"static/image/1d86867394b14ee54e180efba31e9bee.c7087f87.webp",U=s.p+"static/image/5b20099dd7d5945057276a0ceb70c28c.3dbfec00.webp",T=s.p+"static/image/cde4c3843518fa04967b431a07c2e381.0356ab68.webp",Y=s.p+"static/image/38c353a8bb740ba21bd8cd883ce57da2.e75e9f57.webp",K=s.p+"static/image/8cbb8a0182aafcdfe33ac4704888bc40.b50dcce1.webp",G=s.p+"static/image/ee4b597d276957c95a36d6eb2f7b336a.905f4bcc.webp",B=s.p+"static/image/f29f6f31efdccf95edee800d0ed48cda.46059a36.webp",D=s.p+"static/image/f5a5fb077f75b8189f5139cf024d69c5.40f318fa.webp",O=s.p+"static/image/f7ee37777b73f66a5e1915d4be503c84.421483f0.webp";var H=s(686967);let J=s.p+"static/image/d2dbbb0b1374809e182f24fac6ebe64d.182cbabf.webp",P=s.p+"static/image/bece46396361759d0997adaf815819eb.3185bfb1.webp",F=s.p+"static/image/743eb51f1f063de272e77774155679b7.3bba1f06.webp",V=s.p+"static/image/7c2ec2252d2aebbc0f43da2db980ae4c.4aa68ae4.webp",Q=s.p+"static/image/0a0317bf79818a9f706a96dafdc813da.1ec8e8ae.webp",L=s.p+"static/image/3d034ea0185d2c89161a090545c5e686.b921cc14.webp",X=s.p+"static/image/2f249b11b2fd6528b25674f42be4175a.134b3e44.webp",W=s.p+"static/image/041a9256b4e28bdd9254b6aa1e329a76.8854fb9d.webp";function q(n){let e=Object.assign({h1:"h1",a:"a",p:"p",img:"img",strong:"strong",pre:"pre",code:"code",h2:"h2"},(0,r.ah)(),n.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.h1,{id:"154-基于-redis-实现各种排行榜周榜月榜年榜",children:["154. 基于 Redis 实现各种排行榜（周榜、月榜、年榜）",(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#154-基于-redis-实现各种排行榜周榜月榜年榜",children:"#"})]}),"\n",(0,i.jsx)(e.p,{children:"生活中各种排行榜可太多了。"}),"\n",(0,i.jsx)(e.p,{children:"比如经常有瓜的微博文娱榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:W,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"掘金的文章榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:X,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"作者榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:L,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"微信的步数排行榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Q,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"我最近订的自习室也有学习时长排行榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"排行的依据各有不同，有的是根据学习时长，有的是根据阅读数、点赞数，有的是根据搜索次数等。"}),"\n",(0,i.jsx)(e.p,{children:"那这些排行榜是怎么实现的呢？"}),"\n",(0,i.jsx)(e.p,{children:"有的同学说，在 mysql 里加一个排序的字段，比如热度，然后根据根据这个字段来排序不就行了？"}),"\n",(0,i.jsx)(e.p,{children:"这样是能完成功能，但是效率太低了。"}),"\n",(0,i.jsx)(e.p,{children:"数据库的读写性能比 Redis 低很多，而且可能这个排序的依据只是一个临时数据，不需要存到数据库里。"}),"\n",(0,i.jsx)(e.p,{children:"一般涉及到排行榜，都是用 Redis 来做，因为它有一个专为排行榜准备的数据结构：有序集合 ZSET。"}),"\n",(0,i.jsx)(e.p,{children:"它有这些命令："}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZADD"}),"：往集合中添加成员"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZREM"}),"：从集合中删除成员"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZCARD"}),"：集合中的成员个数"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZSCORE"}),"：某个成员的分数"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZINCRBY"}),"：增加某个成员的分数"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZRANK"}),"：成员在集合中的排名"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZRANGE"}),"：打印某个范围内的成员"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZRANGESTORE"}),"：某个范围内的成员，放入新集合"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZCOUNT"}),"：集合中分数在某个返回的成员个数"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZDIFF"}),"：打印两个集合的差集"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZDIFFSTORE"}),"：两个集合的差集，放入新集合"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZINTER"}),"：打印两个集合的交集"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZINTERSTORE"}),"：两个集合的交集，放入新集合"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZINTERCARD"}),"：两个集合的交集的成员个数"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZUNION"}),"：打印两个集合的并集"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"ZUNIONSTORE"}),"：两个集合的并集，放回新集合"]}),"\n",(0,i.jsx)(e.p,{children:"我们依次来试一下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:V,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-redis",children:"ZADD set1 1 mem1 2 mem2 3 mem3\n"})}),"\n",(0,i.jsx)(e.p,{children:"在 RedisInsight 里输入命令，点击执行。"}),"\n",(0,i.jsx)(e.p,{children:"点击刷新就可以看到这个集合："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:F,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"三个成员，分数分别是 1、2、3"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:P,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"用命令看的话就是 ZRANGE："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:J,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE set1 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:"范围从 0 到 -1 就是返回全部。"}),"\n",(0,i.jsx)(e.p,{children:"默认是分数从小到大排序，也可以从大到小，加个 REV 就行："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:H,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE set1 0 -1 REV\n"})}),"\n",(0,i.jsx)(e.p,{children:"还可以用 ZRANGESTORE 把它存入新集合："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:O,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGESTORE rangeset set1 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:"查看下新集合："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE rangeset 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:D,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"删除个成员试试："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:B,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZREM set1 mem1\n"})}),"\n",(0,i.jsx)(e.p,{children:"再查看下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:G,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE set1 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:"用 ZCARD 查看集合的成员个数："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:K,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZCARD set1\n"})}),"\n",(0,i.jsx)(e.p,{children:"用 ZSCORE 查看某个成员的分数："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Y,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"用 ZRANK 查看成员在集合内的排名："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:T,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANK set1 mem2\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后用 ZINCRBY 给成员增加分数："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:"data:image/webp;base64,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",alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZINCRBY set1 3 mem2\n"})}),"\n",(0,i.jsx)(e.p,{children:"看下新排名："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:U,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE set1 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:"mem2 就到下面去了。"}),"\n",(0,i.jsx)(e.p,{children:"再创建一个集合 set2："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:M,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZADD set2 4 aaa 6 bbb\n"})}),"\n",(0,i.jsx)(e.p,{children:"用 ZUNION 合并下："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZUNION 2 set1 set2\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:z,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"还可以加上分数一起："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZUNION 2 set1 set2 WITHSCORES\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:C,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"或者把合并后放到另一个集合："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:N,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZUNIONSTORE set3 2 set1 set2\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:I,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZRANGE set3 0 -1\n"})}),"\n",(0,i.jsx)(e.p,{children:"交集和差集的命令也差不多，就不一个个试了。"}),"\n",(0,i.jsx)(e.p,{children:"并集合并的时候相同的 key 的 score 会求和。"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"ZADD s1 1 aa 2 bb\n\nZADD s2 1 aa 3 cc\n\nZUNIONSTORE s3 2 s1 s2\n"})}),"\n",(0,i.jsx)(e.p,{children:"在 s1 和 s2 集合中都有 aa，合并到 s3 之后 aa 的分数也合并了："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:y,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"周榜、月榜、年榜就是这么实现的："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"月榜就是对周榜的合并，然后年榜就是月榜的合并，最后就会算出一个新的排行榜。"}),"\n",(0,i.jsx)(e.p,{children:"我们用 Nest 实现下类似的排行榜功能："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"nest new ranking-list-test\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:v,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"安装 redis 的包："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm install --save redis\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后创建个 redis 模块："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"nest g module redis\nnest g service redis\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:u,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"在 RedisModule 创建连接 redis 的 provider，导出 RedisService，并把这个模块标记为 @Global 模块"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { Global, Module } from '@nestjs/common';\nimport { createClient } from 'redis';\nimport { RedisService } from './redis.service';\n\n@Global()\n@Module({\n  providers: [\n    RedisService,\n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后在 RedisService 里注入 REDIS_CLIENT，并封装一些方法："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType;\n\n    async zRankingList(key: string, start: number = 0, end: number = -1) {\n        const keys = await this.redisClient.zRange(key, start, end, {\n            REV: true\n        });\n        const rankingList = {};\n        for(let i = 0; i< keys.length; i++){\n            rankingList[keys[i]] = await this.zScore(key, keys[i]);\n        }\n        return rankingList;\n    }\n\n    async zAdd(key: string, members: Record<string, number>) {\n        const mems = [];\n        for(let key in members) {\n            mems.push({\n                value: key,\n                score: members[key]\n            });        \n        }\n        return  await this.redisClient.zAdd(key, mems);\n    }\n\n    async zScore(key: string, member: string) {\n        return  await this.redisClient.zScore(key, member);\n    }\n\n    async zRank(key: string, member: string) {\n        return  await this.redisClient.zRank(key, member);\n    }\n\n    async zIncr(key: string, member: string, increment: number) {\n        return  await this.redisClient.zIncrBy(key, increment, member)\n    }\n\n    async zUnion(newKey: string, keys: string[]) {\n        if(!keys.length) {\n            return []\n        };\n        if(keys.length === 1) {\n            return this.zRankingList(keys[0]);\n        }\n\n        await this.redisClient.zUnionStore(newKey, keys);\n\n        return this.zRankingList(newKey);\n    }\n\n    async keys(pattern: string) {\n        return this.redisClient.keys(pattern);    \n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"这里我们对 zset 的命令进行了封装，比如 zRange 只会返回成员名，我们顺带把分数也取出来。"}),"\n",(0,i.jsx)(e.p,{children:"暴露 zAdd、zScore、zRank、zIncr 等方法。"}),"\n",(0,i.jsx)(e.p,{children:"zUnion 要做下边界的处理，如果只传了一个 set 的名字，就染回这个 set 的内容，否则才合并。"}),"\n",(0,i.jsx)(e.p,{children:"创建一个 ranking 模块："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"nest g module ranking\nnest g controller ranking --no-spec\nnest g service ranking --no-spec\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:S,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"我们就实现下自习室学习时长的月榜和年榜吧。"}),"\n",(0,i.jsx)(e.p,{children:"实现下 RankingService："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { RedisService } from './../redis/redis.service';\nimport { Inject, Injectable } from '@nestjs/common';\nimport * as dayjs from 'dayjs';\n\n@Injectable()\nexport class RankingService {\n\n    @Inject(RedisService)\n    redisService: RedisService;\n\n    private getMonthKey() {\n        const dateStr = dayjs().format('YYYY-MM');\n        return `learning-ranking-month:${dateStr}`;\n    }\n\n    private getYearKey() {\n        const dateStr = dayjs().format('YYYY');\n        return `learning-ranking-year:${dateStr}`;\n    }\n\n    async join(name: string) {\n        await this.redisService.zAdd(this.getMonthKey(), { [name]: 0 });\n    }\n\n    async addLearnTime(name:string, time: number) {\n        await this.redisService.zIncr(this.getMonthKey(), name, time);\n    }\n\n    async getMonthRanking() {\n        return this.redisService.zRankingList(this.getMonthKey(), 0, 10);\n    }\n\n    async getYearRanking() {\n        const dateStr = dayjs().format('YYYY');\n        const keys = await this.redisService.keys(`learning-ranking-month:${dateStr}-*`);\n\n        return this.redisService.zUnion(this.getYearKey(), keys);\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"这里用到了 dayjs，安装下："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm install --save dayjs\n"})}),"\n",(0,i.jsx)(e.p,{children:"月份的榜单是 learning-ranking-mongth:2024-01、learning-ranking-mongth:2024-02 这样的格式。"}),"\n",(0,i.jsx)(e.p,{children:"年份的榜单是 learning-ranking-mongth:2023、learning-ranking-mongth:2024 这样的格式。"}),"\n",(0,i.jsx)(e.p,{children:"我们用 dayjs 拿到当前的年份和月份，拼接出需要的 key。"}),"\n",(0,i.jsx)(e.p,{children:"年份的榜单就是拿到用 learning-ranking-month:当前年份- 开头的所有 zset，做下合并。"}),"\n",(0,i.jsx)(e.p,{children:"在 RankingController 加一下接口："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"import { Controller, Get, Inject, Query } from '@nestjs/common';\nimport { RankingService } from './ranking.service';\n\n@Controller('ranking')\nexport class RankingController {\n\n    @Inject(RankingService)\n    rankingService: RankingService;\n\n    @Get('join')\n    async join(@Query('name') name: string) {\n        await this.rankingService.join(name);\n        return 'success';\n    }\n\n    @Get('learn')\n    async addLearnTime(@Query('name') name:string, @Query('time') time: string) {\n        await this.rankingService.addLearnTime(name, parseFloat(time));\n        return 'success';\n    }\n\n    @Get('monthRanking')\n    async getMonthRanking() {\n        return this.rankingService.getMonthRanking();\n    }\n\n    @Get('yearRanking')\n    async getYearRanking() {\n        return this.rankingService.getYearRanking();\n    }   \n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"join 是加入自习室，learn 是增加学习时长，monthRanking 和 yearRanking 是拿到月榜和年榜。"}),"\n",(0,i.jsx)(e.p,{children:"把服务跑起来："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"npm run start:dev\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:E,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"在 postman 里调用下："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=guang\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=dong\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=xiaohong\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:w,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"调用 join 接口，加入三个同学。"}),"\n",(0,i.jsx)(e.p,{children:"看下现在的月榜："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/monthRanking\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:Z,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"在 RedisInsight 里看下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:R,alt:""})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:k,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后调用 learn 接口，增加学习时长："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=dong&time=1\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:A,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=guang&time=2\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:f,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=xiaohong&time=5\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:b,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/monthRanking\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:m,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"我们改下本地时间（mac 和 windows 改本地时间的方式不一样）："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:o,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"然后再调用 join 接口："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=guang\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:g,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=dong\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:x,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/join?name=xiaogang\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:h,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"之后增加学习时长："}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=dong&time=2\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:j,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=guang&time=3\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:p,alt:""})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"localhost:3000/ranking/learn?name=xiaogang&time=4\n"})}),"\n",(0,i.jsx)(e.p,{children:"然后看下 3 月份的月榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:l,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"还有年榜："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:t,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"可以看到，年榜是合并了所有月榜的结果。"}),"\n",(0,i.jsx)(e.p,{children:"在 RedisInsight 里看下："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:d,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"每个月榜和年榜都是单独的 zset。"}),"\n",(0,i.jsx)(e.p,{children:"这样我们就实现了学习时长的排行榜。"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:a,alt:""})}),"\n",(0,i.jsx)(e.p,{children:"至于用户自己的排名和时长，就用 zScore、zRank 来实现。"}),"\n",(0,i.jsx)(e.p,{children:"也就是这个我的排名功能："}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)("img",{src:c,alt:""})}),"\n",(0,i.jsxs)(e.p,{children:["案例代码上传了",(0,i.jsx)(e.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/ranking-list-test",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,i.jsxs)(e.h2,{id:"总结",children:["总结",(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,i.jsx)(e.p,{children:"生活中我们经常会见到各种排行榜，以及它们的周榜、月榜、年榜等。"}),"\n",(0,i.jsx)(e.p,{children:"这些排行榜的功能都是用 redis 的 zset 有序集合实现的。"}),"\n",(0,i.jsx)(e.p,{children:"它保存的值都有一个分数，会自动排序。"}),"\n",(0,i.jsx)(e.p,{children:"多个集合之间可以求并集、交集、差集。"}),"\n",(0,i.jsx)(e.p,{children:"通过并集的方式就能实现月榜合并成年榜的功能。"}),"\n",(0,i.jsx)(e.p,{children:"以后见到各种排行榜，你会不会想到 Redis 的 zset 呢？"})]})}function _(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,r.ah)(),n.components);return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(q,{...n})}):q(n)}let $=_;_.__RSPRESS_PAGE_META={},_.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F154.%20%E5%9F%BA%E4%BA%8E%20Redis%20%E5%AE%9E%E7%8E%B0%E5%90%84%E7%A7%8D%E6%8E%92%E8%A1%8C%E6%A6%9C%EF%BC%88%E5%91%A8%E6%A6%9C%E3%80%81%E6%9C%88%E6%A6%9C%E3%80%81%E5%B9%B4%E6%A6%9C%EF%BC%89.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"154. 基于 Redis 实现各种排行榜（周榜、月榜、年榜）",headingTitle:"154. 基于 Redis 实现各种排行榜（周榜、月榜、年榜）",frontmatter:{}}}}]);