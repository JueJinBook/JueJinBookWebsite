"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["93339"],{106516:function(e,n,i){i.r(n),i.d(n,{default:()=>K});var r=i(552676),a=i(740453);let s=i.p+"static/image/3d5a9288b22077d123b7b8e5de16b961.1e6cd56c.webp",c=i.p+"static/image/b96a890d55c2e0721b9e747a0e957c04.d78083f8.webp",t=i.p+"static/image/df9024f0b87dc8e0ecb0351d1688db6f.da0cd8aa.webp",l=i.p+"static/image/3e74ee83b6eeadc1201424bd1f59080a.5ea0a34a.webp",d=i.p+"static/image/428b2ff7eb410afbef78ac73f6318c67.4391e48d.webp",p=i.p+"static/image/fa253be28306f75cda199bc307e7a766.b76e891d.webp",o=i.p+"static/image/a0e3748a1ab53ac55bc097ef73236b30.6487afad.webp",m=i.p+"static/image/f4e54aa6ed3633c1b7923b52c833ffb1.c1fb008c.webp",j=i.p+"static/image/f07ebb54a750d5d2bcde1709cab13b6f.850bb527.webp",x=i.p+"static/image/ed1a503fd4a0574baea774fbd8312a7a.2309097d.webp",h=i.p+"static/image/dd9693a5d864bd23a8fcf70d9b9a32b6.b9305441.webp",g=i.p+"static/image/0f2df5a9d3a83577eccbb85134b813df.b32818bd.webp",b=i.p+"static/image/22bdef9e3c40a28bf7bd9e3e91a8895c.d8e6e86d.webp",f=i.p+"static/image/0150cd951100da26fca9c26e6cef7f96.17bc31b6.webp",u=i.p+"static/image/a0128d0a04fbb289776a06c5b0fd93ad.1bb6373d.webp",y=i.p+"static/image/befe342e59527a9a60f3c9c505014b35.e7fafcc8.webp",w=i.p+"static/image/d0840b43df1f62611062ff359c2509e4.5a55c797.webp",v=i.p+"static/image/a644705d9719a21f94ce3a78a5cda080.08be29b7.webp",_=i.p+"static/image/403fe41ecebbd4be84bbcbe0aad567d4.73d689e6.webp",q=i.p+"static/image/2e7dd6088c14e33f9cb916dda67b3069.089319d1.webp",A=i.p+"static/image/10a8d110f154f2db5f999802c550341f.55cddbf6.webp",E=i.p+"static/image/34846abf1e334199fc359fb672c6b1f5.100ba5ed.webp",N=i.p+"static/image/dd7989f4b871bd6f0d9dfe8b32b63f1d.7729ca72.webp",C=i.p+"static/image/7fb91b204332201b8a79aded1b156b84.1e93085c.webp",D=i.p+"static/image/beb485fe0e3b14138c1d4c9214adbebc.22e18b49.webp",M=i.p+"static/image/1df5591d60ca16d6bc2ec7a2579372fd.6159b9c1.webp",S=i.p+"static/image/429b97aae7f7d5079caa89f7b2f5517f.1064a4b1.webp",z=i.p+"static/image/edab3d0be3691e1459a06896011f44ac.54bb2a3b.webp",P=i.p+"static/image/111519050517db2680dd877a9fbb4831.b280eb1f.webp",k=i.p+"static/image/8bd1822b382dba42ec6f9787eeaca22b.5c2a6785.webp",B=i.p+"static/image/597a871b0d0304a9d0e3e6b09a923a66.089f6f75.webp",R=i.p+"static/image/a67a43b506f1d0a0e92670441a21d3eb.1bef1583.webp",T=i.p+"static/image/cef57907e3b7782ddb5ec41b96db3ead.811fef13.webp",O=i.p+"static/image/422c4d4efd9236404079427bc384c899.c235f5f7.webp",G=i.p+"static/image/380f39f9b9406c7f943555def7c4b9fa.46285cb6.webp",$=i.p+"static/image/16f2537b424bba96a991427dde460d7e.0a458dfd.webp",F=i.p+"static/image/eb3dcbcd5211887a39aec75c187c28d9.50856a6b.webp",I=i.p+"static/image/d8db54110a04f4821ac966365ecefa5a.2e28e055.webp",U=i.p+"static/image/33dd0f0a7158887bc71894eaa812d8b2.cb7b6475.webp",Q=i.p+"static/image/0590e3f962a644a169af722ae384a3e5.17349882.webp",L=i.p+"static/image/0badabfd73fa1a6abd670c1964b0bc07.241703f1.webp",V=i.p+"static/image/c9cbbd945c754e54d612061cc81e1789.a0c887b2.webp";function H(e){let n=Object.assign({p:"p",pre:"pre",code:"code",img:"img",strong:"strong",a:"a",h2:"h2",ul:"ul",li:"li"},(0,a.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"上节我们学了 TypeORM 的 migration。"}),"\n",(0,r.jsx)(n.p,{children:"在开发环境下，我们会开启 syncronize，自动同步 entities 到数据库表。"}),"\n",(0,r.jsx)(n.p,{children:"包括 create table 和后续的 alter table。"}),"\n",(0,r.jsx)(n.p,{children:"但是在生产环境下，我们会把它关闭，用 migration 把表结构的变动、数据初始化管理起来。"}),"\n",(0,r.jsx)(n.p,{children:"通过 migration:run、migration:revert 命令来执行和撤销。"}),"\n",(0,r.jsx)(n.p,{children:"在 Nest 项目里使用 migration 和上节的内容还有点不太一样。"}),"\n",(0,r.jsx)(n.p,{children:"这节我们来试一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest new nest-typeorm-migration\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:V,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"创建个 nest 项目。"}),"\n",(0,r.jsx)(n.p,{children:"安装 typeorm 相关的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 AppModule 引入下下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:L,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'TypeOrmModule.forRoot({\n  type: "mysql",\n  host: "localhost",\n  port: 3306,\n  username: "root",\n  password: "guang",\n  database: "nest-migration-test",\n  synchronize: true,\n  logging: true,\n  entities: [],\n  poolSize: 10,\n  connectorPackage: \'mysql2\',\n  extra: {\n      authPlugin: \'sha256_password\',\n  }\n}),\n'})}),"\n",(0,r.jsx)(n.p,{children:"然后创建个 article 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g resource article\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"改下 article.entity.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from \"typeorm\";\n\n@Entity()\nexport class Article {\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column({\n        length: 30\n    })\n    title: string;\n\n    @Column({\n        type: 'text'\n    })\n    content: string;\n\n    @CreateDateColumn()\n    createTime: Date;\n\n    @UpdateDateColumn()\n    updateTime: Date;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"引入下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:U,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在 mysql workbench 创建这个 database："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:F,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"把服务跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run dev\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:$,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，自动创建了 ariticle 的表。"}),"\n",(0,r.jsx)(n.p,{children:"这就是 syncronize 设为 true 的效果。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们添加一些数据："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:O,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'@InjectEntityManager()\nentityManager: EntityManager;\n\nasync initData() {\n    const a1 = new Article();\n    a1.title = "夏日经济“热力”十足 “点燃”文旅消费新活力";\n    a1.content = "人民网北京6月17日电 （高清扬）高考结束、暑期将至，各地文旅市场持续火热，暑期出游迎来热潮。热气腾腾的“夏日经济”成为消费活力升级的缩影，展示出我国文旅产业的持续发展势头。";\n\n    const a2 = new Article();\n    a2.title = "科学把握全面深化改革的方法要求";\n    a2.content = "科学的方法是做好一切工作的重要保证。全面深化改革是一场复杂而深刻的社会变革，必须运用科学方法才能取得成功。";\n\n    await this.entityManager.save(Article, a1);\n    await this.entityManager.save(Article, a2);\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"在 ArticleService 添加 initData 方法，然后在 ArticleController 里调用下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:T,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('init-data')\nasync initData() {\n    await this.articleService.initData();\n    return 'done';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:R,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，数据插入成功了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后在查询接口里查一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async findAll() {\n    return  this.entityManager.find(Article);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"没啥问题。"}),"\n",(0,r.jsx)(n.p,{children:"如果这个 article 的数据是要在生产环境里用的。"}),"\n",(0,r.jsx)(n.p,{children:"而生产环境会关掉 syncronize，那怎么创建表和插入初始化数据呢？"}),"\n",(0,r.jsx)(n.p,{children:"前面讲过，用 migration。"}),"\n",(0,r.jsx)(n.p,{children:"首先需要创建 src/data-source.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { DataSource } from "typeorm";\nimport { Article } from "./article/entities/article.entity";\n\nexport default new DataSource({\n    type: "mysql",\n    host: "localhost",\n    port: 3306,\n    username: "root",\n    password: "guang",\n    database: "nest-migration-test",\n    synchronize: false,\n    logging: true,\n    entities: [Article],\n    poolSize: 10,\n    migrations: [\'src/migrations/**.ts\'],\n    connectorPackage: \'mysql2\',\n    extra: {\n        authPlugin: \'sha256_password\',\n    }\n});\n'})}),"\n",(0,r.jsx)(n.p,{children:"注意，这里 synchronize 是 false，顺便也把 AppModule 里的那个 synchronize 也改为 false。"}),"\n",(0,r.jsx)(n.p,{children:"然后添加几个 npm scripts："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'"typeorm": "ts-node ./node_modules/typeorm/cli",\n"migration:create": "npm run typeorm -- migration:create",\n"migration:generate": "npm run typeorm -- migration:generate -d ./src/data-source.ts",\n"migration:run": "npm run typeorm -- migration:run -d ./src/data-source.ts",\n"migration:revert": "npm run typeorm -- migration:revert -d ./src/data-source.ts"\n'})}),"\n",(0,r.jsx)(n.p,{children:"我们先在数据库里导出现有数据："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"第一个选项是每个表一个 sql 文件，你也可以选择第二个选项，全部导出一个 sql 文件里："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"打开看下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:N,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"包含了 create table 和 insert 语句。"}),"\n",(0,r.jsx)(n.p,{children:"生产环境关掉 synchronize 后，只要执行这个 sql 就行。"}),"\n",(0,r.jsx)(n.p,{children:"但我们要通过 migration 的方式来执行 sql。"}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里删掉这两张表："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后执行 migration:generate 命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migration:generate src/migrations/init\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"它会对比 entity 和数据表的差异，生成迁移 sql："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:q,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，生成的 migration 类里包含了 create table 的 sql。"}),"\n",(0,r.jsx)(n.p,{children:"跑下试试："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migration:run\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:_,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，执行了两条 create table 语句。"}),"\n",(0,r.jsx)(n.p,{children:"在数据库里看下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"migrations 表里记录了执行过的 migration，已经执行过的不会再执行。"}),"\n",(0,r.jsx)(n.p,{children:"article 表就是我们需要在生产环境创建的表："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后我们再创建个 migration 来初始化数据："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migration:create src/migrations/data\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"migration:generate 只会根据表结构变动生成迁移 sql，而数据的插入的 sql 需要我们自己添加。"})}),"\n",(0,r.jsx)(n.p,{children:"严格来说数据初始化不能叫 migration，而应该叫 seed，也就是种子数据。"}),"\n",(0,r.jsx)(n.p,{children:"不过我们都是通过 migration 来管理。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在生成的迁移 class 里填入 insert into 的 sql 即可。"}),"\n",(0,r.jsx)(n.p,{children:"把刚才导出的那个 sql 里的 insert into 语句复制过来。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"public async up(queryRunner: QueryRunner): Promise<void> {\n    await queryRunner.query(\"INSERT INTO `article` VALUES (1,'夏日经济“热力”十足 “点燃”文旅消费新活力','人民网北京6月17日电 （高清扬）高考结束、暑期将至，各地文旅市场持续火热，暑期出游迎来热潮。热气腾腾的“夏日经济”成为消费活力升级的缩影，展示出我国文旅产业的持续发展势头。','2024-06-18 08:56:21.306445','2024-06-18 08:56:21.306445'),(2,'科学把握全面深化改革的方法要求','科学的方法是做好一切工作的重要保证。全面深化改革是一场复杂而深刻的社会变革，必须运用科学方法才能取得成功。','2024-06-18 08:56:21.325168','2024-06-18 08:56:21.325168');\")\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"如果你要支持 revert，那 down 方法里应该补上 delete 语句，这里我们就不写了。"}),"\n",(0,r.jsx)(n.p,{children:"然后跑一下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，在 article 表插入了两条记录。"}),"\n",(0,r.jsx)(n.p,{children:"然后在 migrations 表里插入了一条记录。"}),"\n",(0,r.jsx)(n.p,{children:"为啥上次的 migration 就没执行了呢？"}),"\n",(0,r.jsx)(n.p,{children:"因为 migrations 表里记录过了呀，记录过的就不会再执行。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样怎么在生产环境 create table、insert into 数据我们就都知道了。"}),"\n",(0,r.jsx)(n.p,{children:"然后再来试下后续表结构的修改。"}),"\n",(0,r.jsx)(n.p,{children:"因为生产环境关掉了 syncronize，那 entity 变了之后如何修改表结构呢？"}),"\n",(0,r.jsx)(n.p,{children:"自然也是 migration。"}),"\n",(0,r.jsx)(n.p,{children:"Article 实体加一个 tags字段："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Column({\n    length: 30\n})\ntags: string;\n"})}),"\n",(0,r.jsx)(n.p,{children:"执行 migration:generate 命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migration:generate src/migrations/add-tag-column\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"生成了 alter table 的 sql："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后执行下这个 migration："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migraion:run\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"一条 alter table 的 sql，一条 insert 的 sql。"}),"\n",(0,r.jsx)(n.p,{children:"可以看到，article 表多了 tags 列，migrations 表也插入了一条执行记录："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样，如何在生产环境通过 migration 创建表、修改表、初始化数据我们就都清楚了。"}),"\n",(0,r.jsx)(n.p,{children:"此外，有同学可能会说，我们的数据库连接配置都是放在 config 文件里的，现在两个地方都要用，那如何两个地方都读取配置文件呢？"}),"\n",(0,r.jsx)(n.p,{children:"我们在 src 下创建 .env"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"# 61. Nest 项目里如何使用 TypeORM 迁移\nmysql_server_host=localhost\nmysql_server_port=3306\nmysql_server_username=root\nmysql_server_password=guang\nmysql_server_database=nest-migration-test\n"})}),"\n",(0,r.jsx)(n.p,{children:"首先，AppModule 里的这些数据库配置都可以从 .env 里读取："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"用到 ConfigModule，这个是下节的内容，这里就不展开了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们来看下在 data-source.ts 里怎么读取 .env 文件："}),"\n",(0,r.jsx)(n.p,{children:"我们需要安装 dotenv 这个包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save-dev dotenv\n"})}),"\n",(0,r.jsx)(n.p,{children:"用 dotenv 来读取 .env 配置文件："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { DataSource } from \"typeorm\";\nimport { Article } from \"./article/entities/article.entity\";\nimport { config } from 'dotenv';\n\nconfig({ path: 'src/.env' });\n\nconsole.log(process.env);\n\nexport default new DataSource({\n    type: \"mysql\",\n    host: `${process.env.mysql_server_host}`,\n    port: +`${process.env.mysql_server_port}`,\n    username: `${process.env.mysql_server_username}`,\n    password: `${process.env.mysql_server_password}`,\n    database: `${process.env.mysql_server_database}`,\n    synchronize: false,\n    logging: true,\n    entities: [Article],\n    poolSize: 10,\n    migrations: ['src/migrations/**.ts'],\n    connectorPackage: 'mysql2',\n    extra: {\n        authPlugin: 'sha256_password',\n    }\n});\n"})}),"\n",(0,r.jsx)(n.p,{children:"跑一下："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run migration:run\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:s,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，.env 的配置读取成功了。"}),"\n",(0,r.jsx)(n.p,{children:"这样，AppModule 和迁移用的 data-source.ts 里就都可以读取同一份配置。"}),"\n",(0,r.jsxs)(n.p,{children:["案例代码在",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-typeorm-migration",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"}),"。"]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"生产环境是通过 migration 来创建表、更新表结构、初始化数据的。"}),"\n",(0,r.jsx)(n.p,{children:"这节我们在 nest 项目里实现了下迁移。"}),"\n",(0,r.jsx)(n.p,{children:"大概有这几步："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"创建 data-source.ts 供 migration 用"}),"\n",(0,r.jsx)(n.li,{children:"把 synchronize 关掉"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:generate 生成创建表的 migration"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:run 执行"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:create 创建 migration，然后填入数据库导出的 sql 里的 insert into 语句"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:run 执行"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:generate 生成修改表的 migration"}),"\n",(0,r.jsx)(n.li,{children:"用 migration:run 执行"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"在生产环境下，我们就是这样创建表、更新表、初始化数据的。"})]})}function J(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(H,{...e})}):H(e)}let K=J;J.__RSPRESS_PAGE_META={},J.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F61.%20Nest%20%E9%A1%B9%E7%9B%AE%E9%87%8C%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20TypeORM%20%E8%BF%81%E7%A7%BB.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"",headingTitle:"",frontmatter:{}}}}]);