"use strict";(self.webpackChunkjue_jin_book_press=self.webpackChunkjue_jin_book_press||[]).push([["58529"],{704174:function(e,n,s){e.exports=s.p+"static/image/05fe13cd2d8464a8b668cd26d9b0840a.b5119a48.webp"},141050:function(e,n,s){s.r(n),s.d(n,{default:()=>q});var r=s(552676),i=s(740453);let l=s.p+"static/image/5749612ef3a233b74ac8fd3260ee9d9b.a5d4bfa8.webp",c=s.p+"static/image/cc2b43130621d0fb955b93924aa1cdc4.6b3f40e2.webp",t="data:image/webp;base64,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",a=s.p+"static/image/9b51143375e1765ccdc32d650360e8dd.5729e298.webp",d=s.p+"static/image/cb6522177d9b2507366686e947fa9c6f.1974280b.webp",o=s.p+"static/image/b03ad5ccdd7b834bb3e97d8b952daf9f.717cff9f.webp",h=s.p+"static/image/23e8d4624e6b43366c5ccc87128b645e.f8fcddba.webp",p=s.p+"static/image/d60ee64d482a2f16bb9f100ddc0c852f.e0ab60e7.webp",j=s.p+"static/image/97c3bf429d848b870f8d94c9b3df2989.28ece1e8.webp",x=s.p+"static/image/da5c1100922421182e7353483fe7605b.99323202.webp",g=s.p+"static/image/675d20e0723a7208eae78d9b2b585e4f.426622dc.webp",f=s.p+"static/image/2cdf2e00556ad46049487c0cbd9127a2.03dcf49f.webp",u=s.p+"static/image/d68f136510af81876570624eb601a3aa.bdc3d364.webp",w=s.p+"static/image/0ada52569bda2298f8fd0a1310a8c60d.6adb4810.webp",m=s.p+"static/image/c3ef63ba00a2420d0353ce214f90603b.b8b09d94.webp",b=s.p+"static/image/4ef489e12f85091657449132065049c8.a1c9ee57.webp",I=s.p+"static/image/9fc2efe55b5063f9046daccd159c5406.ea34bee3.webp",y=s.p+"static/image/cd4fabfd61f2c6e497cd4990f64398af.444da201.webp",S=s.p+"static/image/6d7925b24dda71e911a5fcda72e716a7.2bd659b3.webp",v=s.p+"static/image/b3d2650e3e95e9ade1acb6f1c5cce885.e24506a4.webp",R=s.p+"static/image/05af2381295e5498b70c83a7bfa3a7ae.8337d4aa.webp";var E=s(704174);let M=s.p+"static/image/f0f00ae730e2aceb3448b81cf01f2446.d41a1b4b.webp",A=s.p+"static/image/2491c81448351a4532b4f0a296fa596f.3e65904c.webp",C=s.p+"static/image/48135e35fe5c961db5b62d4ffeacd2a3.7c6a55ae.webp",T=s.p+"static/image/db415acd2c723b7f4e6eca0c2bc2f058.2b3a05b3.webp",O=s.p+"static/image/5cd19923bb1f8e9d054b54b553843c27.047fdef8.webp",U=s.p+"static/image/0075569dba8204ecc57db640e0b62b15.f8f14ecb.webp",B=s.p+"static/image/25c6859705980d188ac9a580c6d4ede5.5a129f48.webp",V=s.p+"static/image/01223950d50986df568eafe09655ef22.8da9e0ce.webp",G=s.p+"static/image/7d792d97d7af27e6112993dd259ca330.6083227b.webp",P=s.p+"static/image/b9098c3d70cfa83a48cdc7028d2e4d2d.939dea41.webp",k=s.p+"static/image/34f75f73b73185cec37fb51ec3b6ea08.f18ce31f.webp",D=s.p+"static/image/80476f33d0c127cb7a9ee4febdc74f28.09443e55.webp",Y=s.p+"static/image/2fd96634c26660b446e1bb57139d6556.8db466ec.webp",J=s.p+"static/image/e783c1e5a6e0f1d05f0c859cf2a08d42.a144faad.webp",Z=s.p+"static/image/7d22b6b6ddb18b6e52cd05311c1a7609.d335c19d.webp";function N(e){let n=Object.assign({h1:"h1",a:"a",p:"p",img:"img",strong:"strong",pre:"pre",code:"code",h2:"h2"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"153-基于-redis-实现关注关系",children:["153. 基于 Redis 实现关注关系",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#153-基于-redis-实现关注关系",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"在掘金、知乎、抖音等平台，我们可以关注其他用户，其他用户也可以关注我们，而且如果彼此关注，会标出共同关注："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Z,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这种关注、被关注，相互关注，我们每天都能见到。"}),"\n",(0,r.jsx)(n.p,{children:"那它是怎么实现的呢？"}),"\n",(0,r.jsx)(n.p,{children:"一般是用 redis 的 Set 实现的。"}),"\n",(0,r.jsx)(n.p,{children:"Set 是集合，有很多命令："}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SADD"}),"：添加元素"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SMEMBERS"}),"：查看所有元素"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SISMEMBER"}),"：某个 key 是否在集合中"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SCARD"}),"：集合中某个 key 的元素数量"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SMOVE"}),"：移动元素从一个集合到另一个集合"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SDIFF"}),"：两个集合的差集"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SINTER"}),"：两个集合的交集"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SUNION"}),"：两个集合的并集"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SINTERSTORE"}),"：两个集合的交集，存入新集合"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SUNIONSTORE"}),"：两个集合的并集，存入新集合"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"SDIFFSTORE"}),"：两个集合的差集，存入新集合"]}),"\n",(0,r.jsxs)(n.p,{children:["更多命令可以在 ",(0,r.jsx)(n.a,{href:"https://redis.io/commands/sismember/",target:"_blank",rel:"noopener noreferrer",children:"redis 文档"}),"中搜索以 S 开头的："]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:J,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"关注关系用 redis 来实现就是这样的："}),"\n",(0,r.jsx)(n.p,{children:"比如张三 的 userId 是 1"}),"\n",(0,r.jsx)(n.p,{children:"那我们用一个 set 来存储它的关注者 followers:1"}),"\n",(0,r.jsx)(n.p,{children:"比如其中有 2、3、4 三个用户"}),"\n",(0,r.jsx)(n.p,{children:"然后用一个集合来存储他关注的人 following:1"}),"\n",(0,r.jsx)(n.p,{children:"其中有 2、5、6 三个用户"}),"\n",(0,r.jsx)(n.p,{children:"那相互关注的人就是 followers:1 和 following:1 的交集 SINTERSTORE 的结果，存入新集合，比如叫 follow-each-other:1"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:Y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"然后返回关注者或者关注的人的时候，用 SISMEMBER 判断下用户是否在 follow-each-other:1 这个集合中，是的话就可以标记出互相关注。"}),"\n",(0,r.jsx)(n.p,{children:"思路理清了，我们来写下代码。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:D,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"安装 TypeORM 的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install --save @nestjs/typeorm typeorm mysql2\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 app.module.ts 引入下 TypeOrmModule："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: \"mysql\",\n      host: \"localhost\",\n      port: 3306,\n      username: \"root\",\n      password: \"guang\",\n      database: \"following_test\",\n      synchronize: true,\n      logging: true,\n      entities: [],\n      poolSize: 10,\n      connectorPackage: 'mysql2',\n      extra: {\n          authPlugin: 'sha256_password',\n      }\n    })\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里创建 following_test 数据库："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:k,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"新建一个 user 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g resource user --no-spec\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:P,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"改下 user.entity.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { Column, Entity, JoinTable, ManyToMany, PrimaryGeneratedColumn } from "typeorm";\n\n@Entity()\nexport class User {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column()\n    name: string;\n\n    @ManyToMany(() => User, user => user.following)\n    @JoinTable()\n    followers: User[];\n\n    @ManyToMany(() => User, user => user.followers)\n    following: User[];\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"这里用户和用户是多对多的关系，因为用户可以关注多个用户，用户也可以被多个用户关注。"}),"\n",(0,r.jsx)(n.p,{children:"所以用 @ManyToMany 还有 @JoinTable 来声明。"}),"\n",(0,r.jsx)(n.p,{children:"在 entities 引入这个 User："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:G,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"把开发服务跑起来："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm run start:dev\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:V,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里可以看到 user 表和 user_followers_user 中间表"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:B,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:U,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"我们在 UserService 添加一个初始化数据的方法："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:O,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@InjectEntityManager()\nentityManager: EntityManager;\n\nasync initData() {    \n    const user2 = new User();\n    user2.name = '李四';\n\n    const user3 = new User();\n    user3.name = '王五';\n\n    const user4 = new User();\n    user4.name = '赵六';\n\n    const user5 = new User();\n    user5.name = '刘七';\n\n    await this.entityManager.save(user2);\n    await this.entityManager.save(user3);\n    await this.entityManager.save(user4);\n    await this.entityManager.save(user5);\n\n    const user1 = new User();\n    user1.name = '张三';\n\n    user1.followers = [user2, user3, user4];\n\n    user1.following = [user2, user5];\n\n    await this.entityManager.save(user1);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 里添加一个路由："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('init')\nasync init() {\n    await this.userService.initData();\n    return 'done'\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:T,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"打印了 6 条 sql 语句："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:C,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 mysql workbench 里看下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:A,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:M,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"张三的 id 是 5，他的三个关注者李四、王五、赵六，他关注的人李四、刘七。"}),"\n",(0,r.jsx)(n.p,{children:"关系都保存下来了。"}),"\n",(0,r.jsx)(n.p,{children:"接下来实现相互关注功能，我们要引入 redis。"}),"\n",(0,r.jsx)(n.p,{children:"安装 redis 的包："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm install --save redis\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后创建个 redis 模块："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nest g module redis\nnest g service redis\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:E,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 RedisModule 创建连接 redis 的 provider，导出 RedisService，并把这个模块标记为 @Global 模块"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Global, Module } from '@nestjs/common';\nimport { createClient } from 'redis';\nimport { RedisService } from './redis.service';\n\n@Global()\n@Module({\n  providers: [\n    RedisService,\n    {\n      provide: 'REDIS_CLIENT',\n      async useFactory() {\n        const client = createClient({\n            socket: {\n                host: 'localhost',\n                port: 6379\n            }\n        });\n        await client.connect();\n        return client;\n      }\n    }\n  ],\n  exports: [RedisService]\n})\nexport class RedisModule {}\n"})}),"\n",(0,r.jsx)(n.p,{children:"然后在 RedisService 里注入 REDIS_CLIENT，并封装一些方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { Inject, Injectable } from '@nestjs/common';\nimport { RedisClientType } from 'redis';\n\n@Injectable()\nexport class RedisService {\n\n    @Inject('REDIS_CLIENT') \n    private redisClient: RedisClientType;\n\n    async sAdd(key: string, ...members: string[]) {\n        return this.redisClient.sAdd(key, members);\n    }\n\n    async sInterStore(newSetKey: string, set1: string, set2: string) {\n        return this.redisClient.sInterStore(newSetKey, [set1, set2]);\n    }\n\n    async sIsMember(key: string, member: string) {\n        return this.redisClient.sIsMember(key, member);\n    }\n    \n    async sMember(key: string) {\n        return this.redisClient.sMembers(key);\n    }\n    \n    async exists(key: string) {\n        const result =  await this.redisClient.exists(key);\n        return result > 0\n    } \n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"封装 SADD、SINTERSTORE、SISMEMBER、SMEMBER 命令，分别用来往集合中添加元素，求两个集合的交集创建新集合，判断元素是否在某个集合中、返回集合中的所有元素。"}),"\n",(0,r.jsx)(n.p,{children:"还有 EXISTS 用来判断某个 key 是否存在，返回 1 代表存在，返回 0 代表不存在。"}),"\n",(0,r.jsx)(n.p,{children:"然后在 UserService 添加一个方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Inject(RedisService)\nredisService: RedisService;\n\nasync findUserByIds(userIds: string[] | number[]) {\n  let users = [];\n\n  for(let i = 0; i< userIds.length; i ++) {\n    const user = await this.entityManager.findOne(User, {\n      where: {\n        id: +userIds[i]\n      }\n    });\n    users.push(user);\n  }\n\n  return users;\n}\n\nasync getFollowRelationship(userId: number) {\n  const exists = await this.redisService.exists('followers:' + userId);\n  if(!exists) {\n    const user = await this.entityManager.findOne(User, {\n      where: {\n        id: userId\n      },\n      relations: ['followers', 'following']\n    });\n\n    if(!user.followers.length || !user.following.length) {\n      return {\n        followers: user.followers,\n        following: user.following,\n        followEachOther: []\n      }\n    }\n\n    await this.redisService.sAdd('followers:' + userId, ...user.followers.map(item => item.id.toString()));\n\n    await this.redisService.sAdd('following:' + userId, ...user.following.map(item => item.id.toString()))\n\n    await this.redisService.sInterStore('follow-each-other:' + userId, 'followers:' + userId, 'following:' + userId);\n\n    const followEachOtherIds = await this.redisService.sMember('follow-each-other:' + userId);\n    \n    const followEachOtherUsers = await this.findUserByIds(followEachOtherIds);\n\n    return {\n      followers: user.followers,\n      following: user.following,\n      followEachOther: followEachOtherUsers\n    }\n  } else {\n\n    const followerIds = await this.redisService.sMember('followers:' + userId);\n    \n    const followUsers = await this.findUserByIds(followerIds);\n    \n    const followingIds = await this.redisService.sMember('following:' + userId);\n    \n    const followingUsers = await this.findUserByIds(followingIds);\n\n    const followEachOtherIds = await this.redisService.sMember('follow-each-other:' + userId);\n    \n    const followEachOtherUsers =await this.findUserByIds(followEachOtherIds);\n\n    return {\n      followers: followUsers,\n      following: followingUsers,\n      followEachOtherUsers: followEachOtherUsers\n    }\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"代码比较多，我们一部分一部分的看："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:R,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"传入 userIds，查询对应的 User 信息返回。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:v,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"根据 id 查询用户的信息，关联查出 followers 和 following。"}),"\n",(0,r.jsx)(n.p,{children:"如果 follwers 或者 following 为空，那就没有互相关注，可以直接返回。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:S,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"否则就分别把 follwers 和 follwing 的 id 用 SADD 添加到两个集合中。"}),"\n",(0,r.jsx)(n.p,{children:"之后求两个集合的交集，存入 follow-each-other:userId 的集合。"}),"\n",(0,r.jsx)(n.p,{children:"最后把 followers、following 还有求出来的相互关注的关系返回。"}),"\n",(0,r.jsx)(n.p,{children:"如果 exits 判断 followers 集合存在，就是处理过了，那就直接取 redis 里的这三个集合。"}),"\n",(0,r.jsx)(n.p,{children:"根据集合的 id 求出用户信息返回："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:y,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"在 UserController 添加一个路由："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('follow-relationship')\nasync followRelationShip(@Query('id') id: string) {\n    if(!id) {\n      throw new BadRequestException('userId 不能为空');\n    }\n    return this.userService.getFollowRelationship(+id);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:I,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"结果是正确的。"}),"\n",(0,r.jsx)(n.p,{children:"在 RedisInsight 里可以看到这三个 set："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:b,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"逻辑比较复杂，我们调试下。"}),"\n",(0,r.jsx)(n.p,{children:"点击 debug 面板的 create a launch.json file"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:m,alt:""})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "version": "0.2.0",\n    "configurations": [\n        {\n            "name": "debug nest",\n            "request": "launch",\n            "runtimeArgs": [\n                "run",\n                "start:dev"\n            ],\n            "runtimeExecutable": "npm",\n            "console": "integratedTerminal",\n            "skipFiles": [\n                "<node_internals>/**"\n            ],\n            "type": "node"\n        }\n    ]\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"在代码里打两个断点："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:w,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"点击 debug 启动："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:u,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:f,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，它走到了 else 部分。"}),"\n",(0,r.jsx)(n.p,{children:"在 RedisInsight 里把这三个集合删掉："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:g,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再次访问："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:x,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时候走的就是另一个分支了。"}),"\n",(0,r.jsx)(n.p,{children:"那如果有新的关注者呢？"}),"\n",(0,r.jsx)(n.p,{children:"比如张三又关注了 id 为 3 的赵六："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:j,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这时要更新下数据库，并且更新 redis 里的 follwing 和 follow-each-other 集合。"}),"\n",(0,r.jsx)(n.p,{children:"在 UserService 添加 follow 方法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async follow(userId: number, userId2: number){\n  const user = await this.entityManager.findOne(User, {\n    where: {\n      id: userId\n    },\n    relations: ['followers', 'following']\n  });\n\n  const user2 = await this.entityManager.findOne(User, {\n    where: {\n      id: userId2\n    }\n  });\n\n  user.followers.push(user2);\n\n  await this.entityManager.save(User, user);\n\n  const exists = await this.redisService.exists('followers:' + userId);\n\n  if(exists) {\n    await this.redisService.sAdd('followers:' + userId, userId2.toString());\n    await this.redisService.sInterStore('follow-each-other:' + userId, 'followers:' + userId, 'following:' + userId);\n  }\n  \n const exists2 = await this.redisService.exists('following:' + userId2);\n\n if(exists2) {\n    await this.redisService.sAdd('following:' + userId2, userId.toString());\n    await this.redisService.sInterStore('follow-each-other:' + userId2, 'followers:' + userId2, 'following:' + userId2);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"先查询出 user 的数据，在 followers 添加 user2，然后 save 保存到数据库。"}),"\n",(0,r.jsx)(n.p,{children:"之后查询下 redis，如果有 followers:userId 的 key，就更新下 followers 和 follow-each-other 集合。"}),"\n",(0,r.jsx)(n.p,{children:"这里 user1 和 user2 的集合都要查询并更新下。"}),"\n",(0,r.jsx)(n.p,{children:"然后在 UserController 里添加下路由："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"@Get('follow')\nasync follow(@Query('id1') userId1: string, @Query('id2') userId2: string) {\n    await this.userService.follow(+userId1, +userId2);\n    return 'done';\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"浏览器访问下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:p,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"可以看到，数据库和 redis 都更新了："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:h,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:o,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:d,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"再次查询下："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:a,alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这样，相互关注的功能就实现了。"}),"\n",(0,r.jsx)(n.p,{children:"知乎、掘金这种关注关系都是这样实现的："}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:t,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:c,alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)("img",{src:l,alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["案例代码上传了",(0,r.jsx)(n.a,{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/following",target:"_blank",rel:"noopener noreferrer",children:"小册仓库"})]}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:["总结",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"这节我们实现了下关注、被关注、互相关注。"}),"\n",(0,r.jsx)(n.p,{children:"在 mysql 里用中间表来存储 user 和 user 的关系，在 TypeORM 里用 @ManyToMany 映射。"}),"\n",(0,r.jsx)(n.p,{children:"互相关注用 redis 的 Set 来实现，先把 user 的 followers 和 following 存储到集合中。"}),"\n",(0,r.jsx)(n.p,{children:"然后把两个集合的交集求出来放入一个新的集合。"}),"\n",(0,r.jsx)(n.p,{children:"这样就能求出互相关注的关系。"}),"\n",(0,r.jsx)(n.p,{children:"当有新的关注或者取消关注时，除了要更新数据库外，也要顺便更新下 redis。"}),"\n",(0,r.jsx)(n.p,{children:"这样，查询互相关注关系的功能就完成了。"})]})}function z(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(N,{...e})}):N(e)}let q=z;z.__RSPRESS_PAGE_META={},z.__RSPRESS_PAGE_META["Nest%20%E9%80%9A%E5%85%B3%E7%A7%98%E7%B1%8D%20%20%E6%9C%80%E6%96%B0200%E7%AB%A0%2F153.%20%E5%9F%BA%E4%BA%8E%20Redis%20%E5%AE%9E%E7%8E%B0%E5%85%B3%E6%B3%A8%E5%85%B3%E7%B3%BB.md"]={toc:[{text:"总结",id:"总结",depth:2}],title:"153. 基于 Redis 实现关注关系",headingTitle:"153. 基于 Redis 实现关注关系",frontmatter:{}}}}]);